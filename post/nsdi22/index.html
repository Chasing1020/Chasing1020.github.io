<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='简介 采用 eBPF 基于 Memcached 的性能优化。 使用基于 DPDK 的解决方案绕过 Linux 网络堆栈，但此类方法需要完全重新设计软件堆栈，并且即使在客户端负载较低时也会导致 CPU 利用'><title>[NSDI22] BMC: Accelerating Memcached Using Safe in Kernel Caching and Pre Stack Processing</title>
<link rel=canonical href=https://chasing1020.github.io/post/nsdi22/><link rel=stylesheet href=/scss/style.min.d474cae5c45bbcf637797ca9373a85f97ea6d56997986627823ed313a3434305.css><meta property='og:title' content='[NSDI22] BMC: Accelerating Memcached Using Safe in Kernel Caching and Pre Stack Processing'><meta property='og:description' content='简介 采用 eBPF 基于 Memcached 的性能优化。 使用基于 DPDK 的解决方案绕过 Linux 网络堆栈，但此类方法需要完全重新设计软件堆栈，并且即使在客户端负载较低时也会导致 CPU 利用'><meta property='og:url' content='https://chasing1020.github.io/post/nsdi22/'><meta property='og:site_name' content='Chasing1020'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2024-04-24T18:52:23+08:00'><meta property='article:modified_time' content='2024-04-24T18:52:23+08:00'><meta name=twitter:site content="@Chasing1020"><meta name=twitter:creator content="@Chasing1020"><meta name=twitter:title content="[NSDI22] BMC: Accelerating Memcached Using Safe in Kernel Caching and Pre Stack Processing"><meta name=twitter:description content="简介 采用 eBPF 基于 Memcached 的性能优化。 使用基于 DPDK 的解决方案绕过 Linux 网络堆栈，但此类方法需要完全重新设计软件堆栈，并且即使在客户端负载较低时也会导致 CPU 利用"><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu95eb581bc5d2486d92921983fc6c7583_36979_300x0_resize_q75_box.jpg width=300 height=299 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🖥️</span></figure><div class=site-meta><h1 class=site-name><a href=/>Chasing1020</a></h1><h2 class=site-description><a href="https://www.youtube.com/watch?v=_ILsdcs__ME" target=_blank>Why there is a universe?</a></h2></div></header><ol class=social-menu><li><a href=https://github.com/Chasing1020 target=_blank title=GitHub rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com/Chasing1020 target=_blank title=Twitter rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li><li><a href=https://t.me/Chasing1020 target=_blank title=Telegram rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4 6 6 4-16-18 7 4 2 2 6 3-4"/></svg></a></li><li><a href=mailto:chasing1020@gmail.com target=_blank title=Email rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="3" y="5" width="18" height="14" rx="2"/><polyline points="3 7 12 13 21 7"/></svg></a></li><li><a href=/index.xml target=_blank title=RSS rel=me><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/friends/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Friends</span></a></li><li><a href=/about/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><div class=menu-bottom-section><li id=i18n-switch style=display:none><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://chasing1020.github.io/ selected></option></select></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></div></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ul><li><a href=#简介>简介</a></li><li><a href=#系统结构>系统结构</a><ul><li><a href=#bmc-缓存设计>BMC 缓存设计</a></li><li><a href=#实现流程>实现流程</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/post/nsdi22/>[NSDI22] BMC: Accelerating Memcached Using Safe in Kernel Caching and Pre Stack Processing</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Apr 24, 2024</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>5 minute read</time></div></footer></div></header><section class=article-content><h1 id=简介>简介</h1><p>采用 eBPF 基于 Memcached 的性能优化。
使用基于 DPDK 的解决方案绕过 Linux 网络堆栈，但此类方法需要完全重新设计软件堆栈，并且即使在客户端负载较低时也会导致 CPU 利用率较高。作为 Memcached 的内核缓存，可在标准网络堆栈执行之前为请求提供服务。对 BMC 缓存的请求被视为 NIC 中断的一部分，这允许性能随着服务于 NIC 队列的核心数量而扩展。为了保证安全，BMC 采用 eBPF 来实现。尽管 eBPF 存在安全限制，但我们证明了实现复杂的缓存服务是可能的。
由于 BMC 运行在商用硬件上，不需要修改 Linux 内核和 Memcached 应用程序，因此可以广泛部署在现有系统上。</p><h1 id=系统结构>系统结构</h1><p><img src=https://s2.loli.net/2024/04/24/qKEHXe7lrJ3atSO.png loading=lazy alt="BMC: Accelerating Memcached using Safe In-kernel Caching and Pre-stack Processing-2024-04-24-19-41-17"></p><p>当处理 GET 请求 (4a) 时，BMC 检查其内核缓存，如果找到请求的数据，则发回相应的回复。在这种情况下，包含请求的网络数据包永远不会由标准网络堆栈或应用程序处理，从而释放 CPU 时间。</p><p>SET 请求由 BMC 处理以使相应的缓存条目无效，然后传递给应用程序 (4b)。缓存条目失效后，针对相同数据的后续 GET 请求将不会由 BMC 提供服务，而是由 Memcached 应用程序提供服务。 BMC 总是让 SET 请求通过标准网络堆栈，原因有两个。首先，它允许重用操作系统 TCP 协议实现，包括发送确认和重新传输段。其次，它确保 SET 请求始终由 Memcached 应用程序处理，并且应用程序的数据保持最新。我们选择不使用 BMC 拦截的 SET 请求来更新内核缓存，因为 TCP 的拥塞控制可能会在执行后拒绝新的段。而且，使用 SET 请求更新内核缓存需要 BMC 和 Memcached 都以相同的顺序处理 SET 请求，以保持 BMC 缓存的一致性，如果没有过于昂贵的同步机制，这是很难保证的。</p><p>当 BMC 缓存发生未命中时，GET 请求将传递到网络堆栈。然后，如果 Memcached 中发生命中，BMC 会拦截传出的 GET 回复以更新其缓存 (4c)。</p><p>BMC 可以受益于现代 NIC 功能（例如多队列和 RSS），以便在多个 CPU 内核之间分配处理。同时支持安排到特定 CPU 核心</p><h2 id=bmc-缓存设计>BMC 缓存设计</h2><p>BMC 缓存被设计为由 Memcached 键索引的哈希表。它是一种直接映射缓存，这意味着哈希表中的每个桶一次只能存储一个条目。 BMC 使用 32 位 FNV-1a 哈希函数来计算哈希值。由于这是一次对单个字节进行操作的滚动哈希函数，因此它允许 BMC 在解析 Memcached 请求时计算密钥的哈希值。使用取模运算符将哈希值简化为缓存表中的索引。每个缓存条目包含一个有效位、一个哈希值、一个自旋锁、实际存储的数据以及数据的大小。这种缓存设计为查找、插入和删除操作提供了恒定的时间复杂度。为了验证缓存命中，BMC 检查缓存条目的有效位是否已设置以及存储的密钥是 ​​ 否与处理的请求的密钥相同。</p><p>为了避免 eBPF 的极限，BMC 功能逻辑被分为多个小的 eBPF 程序。同时限制了最大的长度 250B。</p><h2 id=实现流程>实现流程</h2><p><img src=https://s2.loli.net/2024/04/24/vM1idjZnIeNzSDX.png loading=lazy alt="BMC: Accelerating Memcached using Safe In-kernel Caching and Pre-stack Processing-2024-04-24-20-11-02"></p><p>rx_ﬁlter. 第一个 eBPF 程序的目标是使用两条规则过滤与 Memcached 流量相对应的数据包。第一条规则匹配 UDP 数据包，其目标端口对应于 Memcached 且其负载包含 GET 请求。第二条规则匹配目标端口也与 Memcached 对应的 TCP 流量。传入链根据规则匹配进行分支。如果两个规则均不匹配，则网络堆栈将照常处理该数据包。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=nf>SEC</span><span class=p>(</span><span class=s>&#34;bmc_rx_filter&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>bmc_rx_filter_main</span><span class=p>(</span><span class=k>struct</span> <span class=n>xdp_md</span> <span class=o>*</span><span class=n>ctx</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>data_end</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>data_end</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>data</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=kt>long</span><span class=p>)</span><span class=n>ctx</span><span class=o>-&gt;</span><span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>ethhdr</span> <span class=o>*</span><span class=n>eth</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>iphdr</span> <span class=o>*</span><span class=n>ip</span> <span class=o>=</span> <span class=n>data</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>eth</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=kt>void</span> <span class=o>*</span><span class=n>transp</span> <span class=o>=</span> <span class=n>data</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>eth</span><span class=p>)</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>ip</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>udphdr</span> <span class=o>*</span><span class=n>udp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>struct</span> <span class=n>tcphdr</span> <span class=o>*</span><span class=n>tcp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>payload</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=n>__be16</span> <span class=n>dport</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>ip</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>switch</span> <span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>protocol</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nl>IPPROTO_UDP</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>udp</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>udphdr</span> <span class=o>*</span><span class=p>)</span> <span class=n>transp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>udp</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>dport</span> <span class=o>=</span> <span class=n>udp</span><span class=o>-&gt;</span><span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>payload</span> <span class=o>=</span> <span class=n>transp</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>udp</span><span class=p>)</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>memcached_udp_header</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nl>IPPROTO_TCP</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=n>tcp</span> <span class=o>=</span> <span class=p>(</span><span class=k>struct</span> <span class=n>tcphdr</span> <span class=o>*</span><span class=p>)</span> <span class=n>transp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=n>tcp</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&gt;</span> <span class=n>data_end</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>dport</span> <span class=o>=</span> <span class=n>tcp</span><span class=o>-&gt;</span><span class=n>dest</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>payload</span> <span class=o>=</span> <span class=n>transp</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>tcp</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>		<span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>dport</span> <span class=o>==</span> <span class=nf>htons</span><span class=p>(</span><span class=mi>11211</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=o>+</span><span class=mi>4</span> <span class=o>&lt;=</span> <span class=n>data_end</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_UDP</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;g&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;e&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39;t&#39;</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39; &#39;</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// is this a GET request
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>zero</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=k>struct</span> <span class=n>bmc_stats</span> <span class=o>*</span><span class=n>stats</span> <span class=o>=</span> <span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>map_stats</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>zero</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>stats</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>stats</span><span class=o>-&gt;</span><span class=n>get_recv_count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=k>struct</span> <span class=n>parsing_context</span> <span class=o>*</span><span class=n>pctx</span> <span class=o>=</span> <span class=nf>bpf_map_lookup_elem</span><span class=p>(</span><span class=o>&amp;</span><span class=n>map_parsing_context</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>zero</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>pctx</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=n>pctx</span><span class=o>-&gt;</span><span class=n>key_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>pctx</span><span class=o>-&gt;</span><span class=n>current_key</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=n>pctx</span><span class=o>-&gt;</span><span class=n>write_pkt_offset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>			<span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>off</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=cp>#pragma clang loop unroll(disable)
</span></span></span><span class=line><span class=cl><span class=cp></span>			<span class=k>for</span> <span class=p>(</span><span class=n>off</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span> <span class=n>off</span> <span class=o>&lt;</span> <span class=n>BMC_MAX_PACKET_LENGTH</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=o>+</span><span class=n>off</span><span class=o>+</span><span class=mi>1</span> <span class=o>&lt;=</span> <span class=n>data_end</span> <span class=o>&amp;&amp;</span> <span class=n>payload</span><span class=p>[</span><span class=n>off</span><span class=p>]</span> <span class=o>==</span> <span class=sc>&#39; &#39;</span><span class=p>;</span> <span class=n>off</span><span class=o>++</span><span class=p>)</span> <span class=p>{}</span> <span class=c1>// move offset to the start of the first key
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=p>(</span><span class=n>off</span> <span class=o>&lt;</span> <span class=n>BMC_MAX_PACKET_LENGTH</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=n>pctx</span><span class=o>-&gt;</span><span class=n>read_pkt_offset</span> <span class=o>=</span> <span class=n>off</span><span class=p>;</span> <span class=c1>// save offset
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=p>(</span><span class=nf>bpf_xdp_adjust_head</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)(</span><span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>eth</span><span class=p>)</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>ip</span><span class=p>)</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=o>*</span><span class=n>udp</span><span class=p>)</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span> <span class=n>memcached_udp_header</span><span class=p>)</span> <span class=o>+</span> <span class=n>off</span><span class=p>)))</span> <span class=p>{</span> <span class=c1>// push headers + &#39;get &#39; keyword
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nf>bpf_tail_call</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>map_progs_xdp</span><span class=p>,</span> <span class=n>BMC_PROG_XDP_HASH_KEYS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>ip</span><span class=o>-&gt;</span><span class=n>protocol</span> <span class=o>==</span> <span class=n>IPPROTO_TCP</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nf>bpf_tail_call</span><span class=p>(</span><span class=n>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>map_progs_xdp</span><span class=p>,</span> <span class=n>BMC_PROG_XDP_INVALIDATE_CACHE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>XDP_PASS</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>hash_keys 该程序计算数据包中包含的每个 Memcached GET 密钥的哈希值。然后，它检查相应的缓存条目是否有任何缓存命中或哈希冲突，并将已命中的密钥哈希保存在每 CPU 数组中，该数组用于存储链执行的上下文数据。</p><p>prepare_packet 该 eBPF 程序增加接收数据包的大小并修改其协议标头以准备响应数据包，交换源和目标以太网地址、IP 地址和 UDP 端口。然后它调用该链分支的最后一个 eBPF 程序。BMC 可以添加到数据包的最大字节数受到网络驱动程序实现的限制。在我们当前的 BMC 实现中，根据 BMC 附加的不同网络驱动程序，该值设置为 128 字节，并且可以增加到更高的值以匹配其他网络驱动程序实现。</p><p>write_reply 该 eBPF 程序检索保存在每个 CPU 数组中的密钥哈希，以将相应的缓存条目复制到数据包的有效负载中。如果表包含多个键散列，则此 eBPF 程序可以调用自身来复制响应数据包中尽可能多的项目。最后，传入链的该分支通过将数据包发送回网络而结束。</p><p>invalidate_cache 传入链的第二个分支处理 Memcached TCP 流量并包含单个 eBPF 程序。该程序在数据包的有效负载中查找 SET 请求，并在发现使相应缓存条目无效时计算密钥哈希值。传入链的该分支处理的数据包始终传输到网络堆栈，以便 Memcached 可以接收 SET 请求并相应地更新自己的数据。</p><h1 id=总结>总结</h1><p>整个BMC的代码工作量不算大，约1000LoC的C程序，优点是可以不需要修改源程序，直接通过到来的请求判断memcached的target port和payload来进行处理，可以直接部署在现有系统上。</p><p>缺点：暂时只支持有限长度的Key/Value。</p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span><a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ml target=_blank rel=noopener>Licensed under CC BY-NC-SA 4.0</a></span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css integrity="sha256-J+iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s=" crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js integrity="sha256-InsNdER1b2xUewP+pKCUJpkhiqwHgqiPXDlIk7GzBu4=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI=" crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.querySelector(`.article-content`),{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script></article><script src=https://giscus.app/client.js data-repo=Chasing1020/Chasing1020.github.io data-repo-id=R_kgDOGR5Ifw data-category=General data-category-id=DIC_kwDOGR5If84CURCm data-mapping=url data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark")}})()</script><footer class=site-footer><section class=copyright>&copy;
2019 -
2024 Chasing1020</section><section class=powerby>I just want a peaceful life without troubles<br>Built with <b><a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a></b><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-CDYPFNXQDZ"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CDYPFNXQDZ")</script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css?family=JetBrains+Mono",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>