<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹'>
<meta name="keywords" content="Runtime"><title>Go(4) Runtime</title>

<link rel='canonical' href='https://chasing1020.github.io/post/go4-runtime/'>

<link rel="stylesheet" href="/scss/style.min.137532ecdb47b4e19cc5bd7eb181a2fac19327074071417b23a61ca467af44c5.css"><meta property='og:title' content='Go(4) Runtime'>
<meta property='og:description' content='Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹'>
<meta property='og:url' content='https://chasing1020.github.io/post/go4-runtime/'>
<meta property='og:site_name' content='Chasing&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Go' /><meta property='article:published_time' content='2021-09-28T19:31:04&#43;08:00'/><meta property='article:modified_time' content='2021-09-28T19:31:04&#43;08:00'/><meta property='og:image' content='https://chasing1020.github.io/post/go4-runtime/go-model-sheet.webp' />
<meta name="twitter:site" content="@Chasing1020">
    <meta name="twitter:creator" content="@Chasing1020"><meta name="twitter:title" content="Go(4) Runtime">
<meta name="twitter:description" content="Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://chasing1020.github.io/post/go4-runtime/go-model-sheet.webp' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu95eb581bc5d2486d92921983fc6c7583_36979_300x0_resize_q75_box.jpg" width="300"
                            height="299" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ–¥ï¸</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Chasing&#39;s blog</a></h1>
            <h2 class="site-description">Why there is a universe?</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/Chasing1020'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/Chasing1020'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/Chasing1020'
                        target="_blank"
                        title="Telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:chasing1020@gmail.com'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
      
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#part4-runtime">Part4. Runtime</a>
      <ul>
        <li><a href="#1-gmp">1. GMP</a>
          <ul>
            <li><a href="#11-implement">1.1. Implement</a></li>
            <li><a href="#12-create-goroutine">1.2. Create Goroutine</a></li>
            <li><a href="#13-schedule">1.3. Schedule</a></li>
            <li><a href="#14-trigger-scheduling">1.4. Trigger Scheduling</a></li>
            <li><a href="#15-thread-control">1.5. Thread Control</a></li>
          </ul>
        </li>
        <li><a href="#2-system-monitor">2. System Monitor</a></li>
        <li><a href="#3-stack-and-heap">3. Stack And Heap</a>
          <ul>
            <li><a href="#31-traditional-language">3.1. Traditional Language</a></li>
            <li><a href="#32-implement">3.2. Implement</a></li>
            <li><a href="#33-allocation">3.3. Allocation</a></li>
            <li><a href="#34-escape">3.4. Escape</a></li>
          </ul>
        </li>
        <li><a href="#4-garbage-collection">4. Garbage Collection</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/go4-runtime/">
                <img src="/post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_800x0_resize_q75_h2_box_2.webp"
                        srcset="/post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_800x0_resize_q75_h2_box_2.webp 800w, /post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_1600x0_resize_q75_h2_box_2.webp 1600w"
                        width="800" 
                        height="449" 
                        loading="lazy"
                        alt="Featured image of post Go(4) Runtime" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/go4-runtime/">Go(4) Runtime</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 28, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    36 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="part4-runtime">Part4. Runtime</h1>
<h2 id="1-gmp">1. GMP</h2>
<h3 id="11-implement">1.1. Implement</h3>
<h4 id="111-data-structure">1.1.1. Data Structure</h4>
<p>åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚
M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒM åˆ›å»ºäº† Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡Œ Gï¼Œéœ€è¦æŠŠ Gâ€™äº¤ç»™ Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸º Gâ€™å’Œ G æ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨ M ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»– Mâ€™ã€‚
ç³»ç»Ÿè°ƒç”¨ (CPU åœ¨ M ä¹‹é—´çš„åˆ‡æ¢) å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚</p>
<p>å…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚
P çš„æœ¬åœ°é˜Ÿåˆ—ï¼šä¸è¶…è¿‡ 256 ä¸ªã€‚æ–°å»º Gâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚
P åˆ—è¡¨ï¼šæ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCS(å¯é…ç½®) ä¸ªã€‚
Mï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼ŒP é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹ G æ”¾åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·± P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚M è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼ŒM ä¼šä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚</p>
<h5 id="1111-g">1.1.1.1. G</h5>
<p>Gï¼šä½œä¸ºæœ€å°çš„è¿è¡Œçš„è°ƒåº¦å•å…ƒ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stack describes a Go execution stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The bounds of the stack are exactly [lo, hi),
</span></span></span><span class="line"><span class="cl"><span class="c1">// with no implicit data structures on either side.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">stack</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lo</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hi</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">g</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Stack parameters.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack describes the actual stack memory: [stack.lo, stack.hi).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackguard0 is the stack pointer compared in the Go stack growth prologue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackguard1 is the stack pointer compared in the C stack growth prologue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is stack.lo+StackGuard on g0 and gsignal stacks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stack</span>       <span class="nx">stack</span>   <span class="c1">// offset known to runtime/cgo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackguard0</span> <span class="kt">uintptr</span> <span class="c1">// offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackguard1</span> <span class="kt">uintptr</span> <span class="c1">// offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_panic</span>       <span class="o">*</span><span class="nx">_panic</span> <span class="c1">// innermost panic - offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_defer</span>       <span class="o">*</span><span class="nx">_defer</span> <span class="c1">// innermost defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span>            <span class="o">*</span><span class="nx">m</span>      <span class="c1">// current m; offset known to arm liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span>        <span class="nx">gobuf</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscallsp</span>    <span class="kt">uintptr</span>        <span class="c1">// if status==Gsyscall, syscallsp = sched.sp to use during gc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">syscallpc</span>    <span class="kt">uintptr</span>        <span class="c1">// if status==Gsyscall, syscallpc = sched.pc to use during gc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stktopsp</span>     <span class="kt">uintptr</span>        <span class="c1">// expected sp at top of stack, to check in traceback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">param</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// passed parameter on wakeup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomicstatus</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stackLock</span>    <span class="kt">uint32</span> <span class="c1">// sigprof/scang lock; TODO: fold in to atomicstatus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goid</span>         <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schedlink</span>    <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waitsince</span>    <span class="kt">int64</span>      <span class="c1">// approx time when the g become blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitreason</span>   <span class="nx">waitReason</span> <span class="c1">// if status==Gwaiting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">preempt</span>       <span class="kt">bool</span> <span class="c1">// preemption signal, duplicates stackguard0 = stackpreempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptStop</span>   <span class="kt">bool</span> <span class="c1">// transition to _Gpreempted on preemption; otherwise, just deschedule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptShrink</span> <span class="kt">bool</span> <span class="c1">// shrink stack at synchronous safe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// asyncSafePoint is set if g is stopped at an asynchronous
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe point. This means there are frames on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// without precise pointer information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">asyncSafePoint</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">paniconfault</span> <span class="kt">bool</span> <span class="c1">// panic (instead of crash) on unexpected fault address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcscandone</span>   <span class="kt">bool</span> <span class="c1">// g has scanned stack; protected by _Gscan bit in status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">throwsplit</span>   <span class="kt">bool</span> <span class="c1">// must not split stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// activeStackChans indicates that there are unlocked channels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pointing into this goroutine&#39;s stack. If true, stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// copying needs to acquire channel locks to protect these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// areas of the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">activeStackChans</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// parkingOnChan indicates that the goroutine is about to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// park on a chansend or chanrecv. Used to signal an unsafe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for stack shrinking. It&#39;s a boolean value, but is updated atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">parkingOnChan</span> <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">raceignore</span>     <span class="kt">int8</span>     <span class="c1">// ignore race detection events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysblocktraced</span> <span class="kt">bool</span>     <span class="c1">// StartTrace has emitted EvGoInSyscall about this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysexitticks</span>   <span class="kt">int64</span>    <span class="c1">// cputicks when syscall has returned (for tracing)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceseq</span>       <span class="kt">uint64</span>   <span class="c1">// trace event sequencer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tracelastp</span>     <span class="nx">puintptr</span> <span class="c1">// last P emitted an event for this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedm</span>        <span class="nx">muintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sig</span>            <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writebuf</span>       <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigcode0</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigcode1</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigpc</span>          <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gopc</span>           <span class="kt">uintptr</span>         <span class="c1">// pc of go statement that created this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ancestors</span>      <span class="o">*</span><span class="p">[]</span><span class="nx">ancestorInfo</span> <span class="c1">// ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">startpc</span>        <span class="kt">uintptr</span>         <span class="c1">// pc of goroutine function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">racectx</span>        <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waiting</span>        <span class="o">*</span><span class="nx">sudog</span>         <span class="c1">// sudog structures this g is waiting on (that have a valid elem ptr); in lock order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCtxt</span>        <span class="p">[]</span><span class="kt">uintptr</span>      <span class="c1">// cgo traceback context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">labels</span>         <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// profiler labels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timer</span>          <span class="o">*</span><span class="nx">timer</span>         <span class="c1">// cached timer for time.Sleep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selectDone</span>     <span class="kt">uint32</span>         <span class="c1">// are we participating in a select and did someone win the race?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Per-G GC state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcAssistBytes is this G&#39;s GC assist credit in terms of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bytes allocated. If this is positive, then the G has credit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to allocate gcAssistBytes bytes without assisting. If this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is negative, then the G must correct this by performing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scan work. We track this in bytes to make it fast to update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and check for debt in the malloc hot path. The assist ratio
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// determines how this corresponds to scan work debt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcAssistBytes</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œgçš„<code>stack</code>ä¿å­˜äº†å½“å‰çš„æ ˆèŒƒå›´ï¼Œåˆ†åˆ«å­˜å‚¨ <code>defer</code> å’Œ <code>panic</code> å¯¹åº”ç»“æ„ä½“çš„é“¾è¡¨ï¼Œ
<code>m</code> â€” å½“å‰ Goroutine å ç”¨çš„çº¿ç¨‹ï¼Œå¯èƒ½ä¸ºç©ºï¼› <code>atomicstatus</code> â€” Goroutine çš„çŠ¶æ€ï¼›
<code>sched</code> â€” å­˜å‚¨ Goroutine çš„è°ƒåº¦ç›¸å…³çš„æ•°æ®ï¼› <code>goid</code> â€” Goroutine çš„ IDï¼Œè¯¥å­—æ®µå¯¹å¼€å‘è€…ä¸å¯è§ï¼ŒGo å›¢é˜Ÿè®¤ä¸ºå¼•å…¥ ID ä¼šè®©éƒ¨åˆ† Goroutine å˜å¾—æ›´ç‰¹æ®Šï¼Œä»è€Œé™åˆ¶è¯­è¨€çš„å¹¶å‘èƒ½åŠ›ã€‚</p>
<p>å…¶ä¸­gè¿˜å†…åµŒäº†ä¸€ä¸ªç»“æ„ä½“gobufï¼Œç”¨äºè°ƒåº¦å™¨ä¿å­˜ä»¥åŠæ¢å¤ä¸Šä¸‹æ–‡ä¸­ç”¨åˆ°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">gobuf</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The offsets of sp, pc, and g are known to (hard-coded in) libmach.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ctxt is unusual with respect to GC: it may be a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// heap-allocated funcval, so GC needs to track it, but it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// needs to be set and cleared from assembly, where it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// difficult to have write barriers. However, ctxt is really a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// saved, live register, and we only ever exchange it between
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the real register and the gobuf. Hence, we treat it as a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// root during stack scanning, which means assembly that saves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and restores it doesn&#39;t need write barriers. It&#39;s still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// typed as a pointer so that any other writes from Go get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span>    <span class="nx">guintptr</span>  <span class="c1">// æŒæœ‰è¯¥gobufçš„goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctxt</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span>  <span class="kt">uintptr</span>   <span class="c1">// ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lr</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bp</span>   <span class="kt">uintptr</span> <span class="c1">// for framepointer-enabled architectures
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–atomicstatusè¿˜è®°å½•äº†goroutineå½“å‰çš„çŠ¶æ€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// G status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Beyond indicating the general state of a G, the G status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// acts like a lock on the goroutine&#39;s stack (and hence its
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ability to execute user code).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gidle means this goroutine was just allocated and has not yet been initialized.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gidle</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunnable means this goroutine is on a run queue. It isnot currently executing user code. The stack is not owned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Grunnable</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunning means this goroutine may execute user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M and a P (g.m and g.m.p are valid).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Grunning</span> <span class="c1">// 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gsyscall means this goroutine is executing a system call. It is not executing user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gsyscall</span> <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gwaiting means this goroutine is blocked in the runtime.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is not executing user code. It is not on a run queue,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// but should be recorded somewhere (e.g., a channel wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// queue) so it can be ready()d when necessary. The stack is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not owned *except* that a channel operation may read or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// write parts of the stack under the appropriate channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// lock. Otherwise, it is not safe to access the stack after a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine enters _Gwaiting (e.g., it may get moved).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gwaiting</span> <span class="c1">// 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gmoribund_unused is currently unused, but hardcoded in gdb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scripts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gmoribund_unused</span> <span class="c1">// 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gdead means this goroutine is currently unused. It may be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// just exited, on a free list, or just being initialized. It
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is not executing user code. It may or may not have a stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// allocated. The G and its stack (if any) are owned by the M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that is exiting the G or that obtained the G from the free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gdead</span> <span class="c1">// 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Genqueue_unused is currently unused.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Genqueue_unused</span> <span class="c1">// 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gcopystack means this goroutine&#39;s stack is being moved. It
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is not executing user code and is not on a run queue. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack is owned by the goroutine that put it in _Gcopystack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gcopystack</span> <span class="c1">// 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gpreempted means this goroutine stopped itself for a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// suspendG preemption. It is like _Gwaiting, but nothing is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// yet responsible for ready()ing it. Some suspendG must CAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the status to _Gwaiting to take responsibility for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ready()ing this G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gpreempted</span> <span class="c1">// 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gscan combined with one of the above states other than
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunning indicates that GC is scanning the stack. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine is not executing user code and the stack is owned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by the goroutine that set the _Gscan bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gscanrunning is different: it is used to briefly block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// state transitions while GC signals the G to scan its own
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack. This is otherwise like _Grunning.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// atomicstatus&amp;~Gscan gives the state the goroutine will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return to when the scan completes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscan</span>          <span class="p">=</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_Gscanrunnable</span>  <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Grunnable</span>  <span class="c1">// 0x1001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanrunning</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Grunning</span>   <span class="c1">// 0x1002
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscansyscall</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gsyscall</span>   <span class="c1">// 0x1003
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanwaiting</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gwaiting</span>   <span class="c1">// 0x1004
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanpreempted</span> <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gpreempted</span> <span class="c1">// 0x1009
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»è¦çŠ¶æ€å¦‚ä¸‹ï¼š</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>çŠ¶æ€</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_Gidle</code></td>
<td>åˆšåˆšè¢«åˆ†é…å¹¶ä¸”è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ç»“æŸåå˜ä¸º_Gdead</td>
</tr>
<tr>
<td><code>_Grunnable</code></td>
<td>æ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œæ²¡æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œå­˜å‚¨åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­</td>
</tr>
<tr>
<td><code>_Grunning</code></td>
<td>å¯ä»¥æ‰§è¡Œä»£ç ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M å’Œå¤„ç†å™¨ P</td>
</tr>
<tr>
<td><code>_Gsyscall</code></td>
<td>æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M ä½†æ˜¯ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š</td>
</tr>
<tr>
<td><code>_Gwaiting</code></td>
<td>ç”±äºè¿è¡Œæ—¶è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨äº Channel çš„ç­‰å¾…é˜Ÿåˆ—ä¸Š</td>
</tr>
<tr>
<td><code>_Gdead</code></td>
<td>å¯ä»¥æ˜¯è¢«é”€æ¯çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆšåˆ›å»ºçš„ã€‚æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯èƒ½æœ‰åˆ†é…çš„æ ˆ</td>
</tr>
<tr>
<td><code>_Gcopystack</code></td>
<td>æ ˆæ­£åœ¨è¢«æ‹·è´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š</td>
</tr>
<tr>
<td><code>_Gpreempted</code></td>
<td>ç”±äºæŠ¢å è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œç­‰å¾…å”¤é†’</td>
</tr>
<tr>
<td><code>_Gscan</code></td>
<td>GC æ­£åœ¨æ‰«ææ ˆç©ºé—´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯ä»¥ä¸å…¶ä»–çŠ¶æ€åŒæ—¶å­˜åœ¨</td>
</tr>
</tbody>
</table></div>
<p>å…¶ä¸­g0ä½œä¸ºç‰¹æ®Šçš„è°ƒåº¦åç¨‹ï¼šæ‰§è¡Œå‡½æ•°çš„æµç¨‹ç›¸å¯¹å›ºå®šï¼Œåˆ‡ä¸ºäº†é¿å…æ ˆæº¢å‡ºï¼Œg0çš„æ ˆä¼šå¤ç”¨</p>
<h5 id="1112-m">1.1.1.2. M</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">m</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g0</span>      <span class="o">*</span><span class="nx">g</span>     <span class="c1">// goroutine with scheduling stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">morebuf</span> <span class="nx">gobuf</span>  <span class="c1">// gobuf arg to morestack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">divmod</span>  <span class="kt">uint32</span> <span class="c1">// div/mod denominator for arm - known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fields not known to debuggers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">procid</span>        <span class="kt">uint64</span>            <span class="c1">// for debuggers, but offset not hard-coded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gsignal</span>       <span class="o">*</span><span class="nx">g</span>                <span class="c1">// signal-handling g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goSigStack</span>    <span class="nx">gsignalStack</span>      <span class="c1">// Go-allocated signal handling stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sigmask</span>       <span class="nx">sigset</span>            <span class="c1">// storage for saved signal mask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tls</span>           <span class="p">[</span><span class="nx">tlsSlots</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// thread-local storage (for x86 extern register)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mstartfn</span>      <span class="kd">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curg</span>          <span class="o">*</span><span class="nx">g</span>       <span class="c1">// current running goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caughtsig</span>     <span class="nx">guintptr</span> <span class="c1">// goroutine running during fatal signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">p</span>             <span class="nx">puintptr</span> <span class="c1">// attached p for executing go code (nil if not executing go code)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nextp</span>         <span class="nx">puintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oldp</span>          <span class="nx">puintptr</span> <span class="c1">// the p that was attached before executing a syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">id</span>            <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mallocing</span>     <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">throwing</span>      <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">preemptoff</span>    <span class="kt">string</span> <span class="c1">// if != &#34;&#34;, keep curg running on this m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">locks</span>         <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dying</span>         <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">profilehz</span>     <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spinning</span>      <span class="kt">bool</span> <span class="c1">// m is out of work and is actively looking for work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">blocked</span>       <span class="kt">bool</span> <span class="c1">// m is blocked on a note
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newSigstack</span>   <span class="kt">bool</span> <span class="c1">// minit on C thread called sigaltstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">printlock</span>     <span class="kt">int8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">incgo</span>         <span class="kt">bool</span>   <span class="c1">// m is executing a cgo call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">freeWait</span>      <span class="kt">uint32</span> <span class="c1">// if == 0, safe to free g0 and delete m (atomic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fastrand</span>      <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">needextram</span>    <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">traceback</span>     <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ncgocall</span>      <span class="kt">uint64</span>      <span class="c1">// number of cgo calls in total
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ncgo</span>          <span class="kt">int32</span>       <span class="c1">// number of cgo calls currently in progress
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCallersUse</span> <span class="kt">uint32</span>      <span class="c1">// if non-zero, cgoCallers in use temporarily
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCallers</span>    <span class="o">*</span><span class="nx">cgoCallers</span> <span class="c1">// cgo traceback if crashing in cgo call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">doesPark</span>      <span class="kt">bool</span>        <span class="c1">// non-P running threads: sysmon and newmHandoff never use .park
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">park</span>          <span class="nx">note</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alllink</span>       <span class="o">*</span><span class="nx">m</span> <span class="c1">// on allm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">schedlink</span>     <span class="nx">muintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lockedg</span>       <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createstack</span>   <span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// stack that created this thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedExt</span>     <span class="kt">uint32</span>      <span class="c1">// tracking for external LockOSThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedInt</span>     <span class="kt">uint32</span>      <span class="c1">// tracking for internal lockOSThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nextwaitm</span>     <span class="nx">muintptr</span>    <span class="c1">// next m waiting for lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitunlockf</span>   <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waitlock</span>      <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waittraceev</span>   <span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waittraceskip</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">startingtrace</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscalltick</span>   <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">freelink</span>      <span class="o">*</span><span class="nx">m</span> <span class="c1">// on sched.freem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// mFixup is used to synchronize OS related m state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (credentials etc) use mutex to access. To avoid deadlocks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// an atomic.Load() of used being zero in mDoFixupFn()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// guarantees fn is nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mFixup</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">        <span class="nx">used</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fn</span>   <span class="kd">func</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// these are here because they are too large to be on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// of low-level NOSPLIT functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">libcall</span>   <span class="nx">libcall</span>
</span></span><span class="line"><span class="cl">    <span class="nx">libcallpc</span> <span class="kt">uintptr</span> <span class="c1">// for cpu profiler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">libcallsp</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">libcallg</span>  <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscall</span>   <span class="nx">libcall</span> <span class="c1">// stores syscall parameters on windows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">vdsoSP</span> <span class="kt">uintptr</span> <span class="c1">// SP for traceback while in VDSO call (0 if not in call)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">vdsoPC</span> <span class="kt">uintptr</span> <span class="c1">// PC for traceback while in VDSO call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// preemptGen counts the number of completed preemption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// signals. This is used to detect when a preemption is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// requested, but fails. Accessed atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptGen</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Whether this is a pending preemption signal on this M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Accessed atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">signalPending</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dlogPerM</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mOS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Up to 10 locks held by this m, maintained by the lock ranking code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">locksHeldLen</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">locksHeld</span>    <span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="nx">heldLockInfo</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ g0 æ˜¯æŒæœ‰è°ƒåº¦æ ˆçš„ Goroutineï¼Œ<code>curg</code> æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸Šè¿è¡Œçš„ç”¨æˆ· Goroutineï¼Œè¿™ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçº¿ç¨‹å”¯ä¸€å…³å¿ƒçš„ä¸¤ä¸ª Goroutineã€‚</p>
<h5 id="1113-p">1.1.1.3. P</h5>
<p>è°ƒåº¦å™¨ä¸­çš„å¤„ç†å™¨ P æ˜¯çº¿ç¨‹å’Œ Goroutine çš„ä¸­é—´å±‚ï¼Œå®ƒèƒ½æä¾›çº¿ç¨‹éœ€è¦çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿä¼šè´Ÿè´£è°ƒåº¦çº¿ç¨‹ä¸Šçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡å¤„ç†å™¨ P çš„è°ƒåº¦ï¼Œæ¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹éƒ½èƒ½å¤Ÿæ‰§è¡Œå¤šä¸ª Goroutineï¼Œå®ƒèƒ½åœ¨ Goroutine è¿›è¡Œä¸€äº› I/O æ“ä½œæ—¶åŠæ—¶è®©å‡ºè®¡ç®—èµ„æºï¼Œæé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚</p>
<p>å› ä¸ºè°ƒåº¦å™¨åœ¨å¯åŠ¨æ—¶å°±ä¼šåˆ›å»º <code>GOMAXPROCS</code> ä¸ªå¤„ç†å™¨ï¼Œæ‰€ä»¥ Go è¯­è¨€ç¨‹åºçš„å¤„ç†å™¨æ•°é‡ä¸€å®šä¼šç­‰äº <code>GOMAXPROCS</code>ï¼Œè¿™äº›å¤„ç†å™¨ä¼šç»‘å®šåˆ°ä¸åŒçš„å†…æ ¸çº¿ç¨‹ä¸Šã€‚</p>
<p><code>runtime.p</code> æ˜¯å¤„ç†å™¨çš„è¿è¡Œæ—¶è¡¨ç¤ºï¼Œä½œä¸ºè°ƒåº¦å™¨çš„å†…éƒ¨å®ç°ï¼Œå®ƒåŒ…å«çš„å­—æ®µä¹Ÿéå¸¸å¤šï¼Œå…¶ä¸­åŒ…æ‹¬ä¸æ€§èƒ½è¿½è¸ªã€åƒåœ¾å›æ”¶å’Œè®¡æ—¶å™¨ç›¸å…³çš„å­—æ®µï¼Œè¿™äº›å­—æ®µä¹Ÿéå¸¸é‡è¦ï¼Œä½†æ˜¯åœ¨è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¤„ç†å™¨ä¸­çš„çº¿ç¨‹å’Œè¿è¡Œé˜Ÿåˆ—ï¼š</p>
<p>Pï¼šä½œä¸ºä¸­é—´å±‚ï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">p</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span>          <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span>      <span class="kt">uint32</span> <span class="c1">// one of pidle/prunning/...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">link</span>        <span class="nx">puintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schedtick</span>   <span class="kt">uint32</span>     <span class="c1">// incremented on every scheduler call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">syscalltick</span> <span class="kt">uint32</span>     <span class="c1">// incremented on every system call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysmontick</span>  <span class="nx">sysmontick</span> <span class="c1">// last tick observed by sysmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span>           <span class="nx">muintptr</span>   <span class="c1">// back-link to associated m (nil if idle)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mcache</span>      <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pcache</span>      <span class="nx">pageCache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">raceprocctx</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">deferpool</span>    <span class="p">[</span><span class="mi">5</span><span class="p">][]</span><span class="o">*</span><span class="nx">_defer</span> <span class="c1">// pool of available defer structs of different sizes (see panic.go)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deferpoolbuf</span> <span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span><span class="o">*</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cache of goroutine ids, amortizes accesses to runtimeÂ·sched.goidgen.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goidcache</span>    <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">goidcacheend</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Queue of runnable goroutines. Accessed without lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">runqhead</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runqtail</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runq</span>     <span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// runnext, if non-nil, is a runnable G that was ready&#39;d by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the current G and should be run next instead of what&#39;s in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// runq if there&#39;s time remaining in the running G&#39;s time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// slice. It will inherit the time left in the current time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// slice. If a set of goroutines is locked in a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// communicate-and-wait pattern, this schedules that set as a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unit and eliminates the (potentially large) scheduling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// latency that otherwise arises from adding the ready&#39;d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutines to the end of the run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Note that while other P&#39;s may atomically CAS this to zero,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// only the owner P can CAS it to a valid G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">runnext</span> <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Available G&#39;s (status == Gdead)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gFree</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sudogcache</span> <span class="p">[]</span><span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sudogbuf</span>   <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cache of mspan objects from the heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mspancache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We need an explicit length here because this field is used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// in allocation codepaths where write barriers are not allowed,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and eliminating the write barrier/keeping it eliminated from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// slice updates is tricky, moreso than just managing the length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ourselves.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">len</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buf</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tracebuf</span> <span class="nx">traceBufPtr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// traceSweep indicates the sweep events should be traced.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is used to defer the sweep start event until a span
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// has actually been swept.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceSweep</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// traceSwept and traceReclaimed track the number of bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// swept and reclaimed by sweeping in the current sweep loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceSwept</span><span class="p">,</span> <span class="nx">traceReclaimed</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">palloc</span> <span class="nx">persistentAlloc</span> <span class="c1">// per-P to avoid mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="kt">uint32</span> <span class="c1">// Alignment for atomic fields below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The when field of the first entry on the timer heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is updated using atomic functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is 0 if the timer heap is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timer0When</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The earliest known nextwhen field of a timer with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// timerModifiedEarlier status. Because the timer may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// modified again, there need not be any timer with this value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is updated using atomic functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is 0 if there are no timerModifiedEarlier timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timerModifiedEarliest</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Per-P GC state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcAssistTime</span>         <span class="kt">int64</span> <span class="c1">// Nanoseconds in assistAlloc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcFractionalMarkTime</span> <span class="kt">int64</span> <span class="c1">// Nanoseconds in fractional mark worker (atomic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcMarkWorkerMode is the mode for the next mark worker to run in.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// That is, this is used to communicate with the worker goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// selected for immediate execution by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gcController.findRunnableGCWorker. When scheduling other goroutines,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this field must be set to gcMarkWorkerNotWorker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcMarkWorkerMode</span> <span class="nx">gcMarkWorkerMode</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcMarkWorkerStartTime is the nanotime() at which the most recent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mark worker started.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcMarkWorkerStartTime</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// gcw is this P&#39;s GC work buffer cache. The work buffer is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// filled by write barriers, drained by mutator assists, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// disposed on certain GC state transitions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcw</span> <span class="nx">gcWork</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// wbBuf is this P&#39;s GC write barrier buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: Consider caching this in the running G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wbBuf</span> <span class="nx">wbBuf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">runSafePointFn</span> <span class="kt">uint32</span> <span class="c1">// if 1, run sched.safePointFn at next safe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// statsSeq is a counter indicating whether this P is currently
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// writing any stats. Its value is even when not, odd when it is.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">statsSeq</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Lock for timers. We normally access the timers while running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on this P, but the scheduler can also do it from a different P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timersLock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Actions to take at some time. This is used to implement the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// standard library&#39;s time package.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Must hold timersLock to access.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">timer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Number of timers in P&#39;s heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Modified using atomic instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">numTimers</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Number of timerDeleted timers in P&#39;s heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Modified using atomic instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deletedTimers</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Race context used while executing timer functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timerRaceCtx</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// preempt is set to indicate that this P should be enter the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scheduler ASAP (regardless of what G is running on it).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preempt</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Padding is no longer needed. False sharing is now not a worry because p is large enough
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that its size class is an integer multiple of the cache line size (for any of our architectures).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ P ä¹Ÿå®šä¹‰äº†çŠ¶æ€å­—æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// P status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pidle means a P is not being used to run user code or the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// scheduler. Typically, it&#39;s on the idle P list and available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// to the scheduler, but it may just be transitioning between
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// other states.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// The P is owned by the idle list or by whatever is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// transitioning its state. Its run queue is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pidle</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Prunning means a P is owned by an M and is being used to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// run user code or the scheduler. Only the M that owns this P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// is allowed to change the P&#39;s status from _Prunning. The M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// may transition the P to _Pidle (if it has no more work to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// do), _Psyscall (when entering a syscall), or _Pgcstop (to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// halt for the GC). The M may also hand ownership of the P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// off directly to another M (e.g., to schedule a locked G).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Psyscall means a P is not running user code. It has
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// affinity to an M in a syscall but is not owned by it and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// may be stolen by another M. This is similar to _Pidle but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// uses lightweight transitions and maintains M affinity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Leaving _Psyscall must be done with a CAS, either to steal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// or retake the P. Note that there&#39;s an ABA hazard: even if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// an M successfully CASes its original P back to _Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// after a syscall, it must understand the P may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// used by another M in the interim.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Psyscall</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pgcstop means a P is halted for STW and owned by the M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// that stopped the world. The M that stopped the world
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// continues to use its P, even in _Pgcstop. Transitioning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// from _Prunning to _Pgcstop causes an M to release its P and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// park.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// The P retains its run queue and startTheWorld will restart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// the scheduler on Ps with non-empty run queues.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pgcstop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pdead means a P is no longer used (GOMAXPROCS shrank). We
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// reuse Ps if GOMAXPROCS increases. A dead P is mostly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// stripped of its resources, though a few things remain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// (e.g., trace buffers).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pdead</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="table-wrapper"><table>
<thead>
<tr>
<th>çŠ¶æ€</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_Pidle</code></td>
<td>å¤„ç†å™¨æ²¡æœ‰è¿è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨ï¼Œè¢«ç©ºé—²é˜Ÿåˆ—æˆ–è€…æ”¹å˜å…¶çŠ¶æ€çš„ç»“æ„æŒæœ‰ï¼Œè¿è¡Œé˜Ÿåˆ—ä¸ºç©º</td>
</tr>
<tr>
<td><code>_Prunning</code></td>
<td>è¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå¹¶ä¸”æ­£åœ¨æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨</td>
</tr>
<tr>
<td><code>_Psyscall</code></td>
<td>æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå½“å‰çº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨</td>
</tr>
<tr>
<td><code>_Pgcstop</code></td>
<td>è¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå½“å‰å¤„ç†å™¨ç”±äºåƒåœ¾å›æ”¶è¢«åœæ­¢</td>
</tr>
<tr>
<td><code>_Pdead</code></td>
<td>å½“å‰å¤„ç†å™¨å·²ç»ä¸è¢«ä½¿ç”¨</td>
</tr>
</tbody>
</table></div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nx">P</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32</span>    <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">P</span><span class="o">*</span>    <span class="nx">link</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32</span>    <span class="nx">tick</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">M</span><span class="o">*</span>    <span class="nx">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">MCache</span><span class="o">*</span>    <span class="nx">mcache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">G</span><span class="o">**</span>    <span class="nx">runq</span><span class="p">;</span> <span class="c1">// goroutineç»„æˆçš„ç¯å½¢æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int32</span>    <span class="nx">runqhead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">runqtail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">runqsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">G</span><span class="o">*</span>    <span class="nx">gfree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">gfreecnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Gçš„çŠ¶æ€</li>
</ol>
<ul>
<li>ç©ºé—²ä¸­(_Gidle): è¡¨ç¤ºGåˆšåˆšæ–°å»º, ä»æœªåˆå§‹åŒ–</li>
<li>å¾…è¿è¡Œ(_Grunnable): è¡¨ç¤ºGåœ¨è¿è¡Œé˜Ÿåˆ—ä¸­, ç­‰å¾…Må–å‡ºå¹¶è¿è¡Œ</li>
<li>è¿è¡Œä¸­(_Grunning): è¡¨ç¤ºMæ­£åœ¨è¿è¡Œè¿™ä¸ªG, è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP</li>
<li>ç³»ç»Ÿè°ƒç”¨ä¸­(_Gsyscall): è¡¨ç¤ºMæ­£åœ¨è¿è¡Œè¿™ä¸ªGå‘èµ·çš„ç³»ç»Ÿè°ƒç”¨, è¿™æ—¶å€™Må¹¶ä¸æ‹¥æœ‰P</li>
<li>ç­‰å¾…ä¸­(_Gwaiting): è¡¨ç¤ºGåœ¨ç­‰å¾…æŸäº›æ¡ä»¶å®Œæˆ, è¿™æ—¶å€™Gä¸åœ¨è¿è¡Œä¹Ÿä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­(å¯èƒ½åœ¨channelçš„ç­‰å¾…é˜Ÿåˆ—ä¸­)</li>
<li>å·²ä¸­æ­¢(_Gdead): è¡¨ç¤ºGæœªè¢«ä½¿ç”¨, å¯èƒ½å·²æ‰§è¡Œå®Œæ¯•(å¹¶åœ¨freelistä¸­ç­‰å¾…ä¸‹æ¬¡å¤ç”¨)</li>
<li>æ ˆå¤åˆ¶ä¸­(_Gcopystack): è¡¨ç¤ºGæ­£åœ¨è·å–ä¸€ä¸ªæ–°çš„æ ˆç©ºé—´å¹¶æŠŠåŸæ¥çš„å†…å®¹å¤åˆ¶è¿‡å»(ç”¨äºé˜²æ­¢GCæ‰«æ)</li>
</ul>
<ol start="2">
<li>Mçš„çŠ¶æ€</li>
</ol>
<p>Må¹¶æ²¡æœ‰åƒGå’ŒPä¸€æ ·çš„çŠ¶æ€æ ‡è®°, ä½†å¯ä»¥è®¤ä¸ºä¸€ä¸ªMæœ‰ä»¥ä¸‹çš„çŠ¶æ€:</p>
<ul>
<li>è‡ªæ—‹ä¸­(spinning): Mæ­£åœ¨ä»è¿è¡Œé˜Ÿåˆ—è·å–G, è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP</li>
<li>æ‰§è¡Œgoä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡Œgoä»£ç , è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP</li>
<li>æ‰§è¡ŒåŸç”Ÿä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡ŒåŸç”Ÿä»£ç æˆ–è€…é˜»å¡çš„syscall, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰P</li>
<li>ä¼‘çœ ä¸­: Må‘ç°æ— å¾…è¿è¡Œçš„Gæ—¶ä¼šè¿›å…¥ä¼‘çœ , å¹¶æ·»åŠ åˆ°ç©ºé—²Mé“¾è¡¨ä¸­, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰P</li>
</ul>
<p>è‡ªæ—‹ä¸­(spinning)è¿™ä¸ªçŠ¶æ€éå¸¸é‡è¦, æ˜¯å¦éœ€è¦å”¤é†’æˆ–è€…åˆ›å»ºæ–°çš„Må–å†³äºå½“å‰è‡ªæ—‹ä¸­çš„Mçš„æ•°é‡.</p>
<ol start="3">
<li>Pçš„çŠ¶æ€</li>
</ol>
<ul>
<li>ç©ºé—²ä¸­(_Pidle): å½“Må‘ç°æ— å¾…è¿è¡Œçš„Gæ—¶ä¼šè¿›å…¥ä¼‘çœ , è¿™æ—¶Mæ‹¥æœ‰çš„Pä¼šå˜ä¸ºç©ºé—²å¹¶åŠ åˆ°ç©ºé—²Pé“¾è¡¨ä¸­</li>
<li>è¿è¡Œä¸­(_Prunning): å½“Mæ‹¥æœ‰äº†ä¸€ä¸ªPå, è¿™ä¸ªPçš„çŠ¶æ€å°±ä¼šå˜ä¸ºè¿è¡Œä¸­, Mè¿è¡ŒGä¼šä½¿ç”¨è¿™ä¸ªPä¸­çš„èµ„æº</li>
<li>ç³»ç»Ÿè°ƒç”¨ä¸­(_Psyscall): å½“goè°ƒç”¨åŸç”Ÿä»£ç , åŸç”Ÿä»£ç åˆåè¿‡æ¥è°ƒç”¨goä»£ç æ—¶, ä½¿ç”¨çš„Pä¼šå˜ä¸ºæ­¤çŠ¶æ€</li>
<li>GCåœæ­¢ä¸­(_Pgcstop): å½“gcåœæ­¢äº†æ•´ä¸ªä¸–ç•Œ(STW)æ—¶, Pä¼šå˜ä¸ºæ­¤çŠ¶æ€</li>
<li>å·²ä¸­æ­¢(_Pdead): å½“Pçš„æ•°é‡åœ¨è¿è¡Œæ—¶æ”¹å˜, ä¸”æ•°é‡å‡å°‘æ—¶å¤šä½™çš„Pä¼šå˜ä¸ºæ­¤çŠ¶æ€</li>
</ul>
<p>Pçš„æ•°é‡ï¼šè®¾ç½®ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• GOMAXPROCS() å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ $GOMAXPROCS ä¸ª goroutine åœ¨åŒæ—¶è¿è¡Œã€‚</p>
<p>M çš„æ•°é‡ï¼šgo è¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgo ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 10000. ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚runtime/debug ä¸­çš„ SetMaxThreads å‡½æ•°ï¼Œè®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚ä¸€ä¸ª M é˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„ Mã€‚</p>
<p>åœ¨goä¸­æœ‰å¤šä¸ªè¿è¡Œé˜Ÿåˆ—å¯ä»¥ä¿å­˜å¾…è¿è¡Œ(_Grunnable)çš„G, å®ƒä»¬åˆ†åˆ«æ˜¯å„ä¸ªPä¸­çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å’Œå…¨å±€è¿è¡Œé˜Ÿåˆ—.
å…¥é˜Ÿå¾…è¿è¡Œçš„Gæ—¶ä¼šä¼˜å…ˆåŠ åˆ°å½“å‰Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—, Mè·å–å¾…è¿è¡Œçš„Gæ—¶ä¹Ÿä¼šä¼˜å…ˆä»æ‹¥æœ‰çš„Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è·å–,
æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å…¥é˜Ÿå’Œå‡ºé˜Ÿä¸éœ€è¦ä½¿ç”¨çº¿ç¨‹é”.</p>
<p>æœ¬åœ°è¿è¡Œé˜Ÿåˆ—æœ‰æ•°é‡é™åˆ¶, å½“æ•°é‡è¾¾åˆ°256ä¸ªæ—¶ä¼šå…¥é˜Ÿåˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—.
æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯<a class="link" href="https://link.segmentfault.com/?enc=3K7smhVfN1rsbyq%2FSwlKxg%3D%3D.65MePZBQYDpl%2FjSZBC976W%2Blp8dmXiT1ISfuJPU9TLbK7knyfQavGJ%2BADWaPh5uR"  target="_blank" rel="noopener"
    >ç¯å½¢é˜Ÿåˆ—</a>, ç”±ä¸€ä¸ª256é•¿åº¦çš„æ•°ç»„å’Œä¸¤ä¸ªåºå·(head, tail)ç»„æˆ.</p>
<p>å½“Mä»Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è·å–Gæ—¶, å¦‚æœå‘ç°æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºä¼šå°è¯•ä»å…¶ä»–Pç›—å–ä¸€åŠçš„Gè¿‡æ¥,
è¿™ä¸ªæœºåˆ¶å«åš<a class="link" href="https://link.segmentfault.com/?enc=dFHWCcy9uuQg8AreOB4osg%3D%3D.d3lAx7XwHsabU%2FP1I8q5qlEqbus5KYD7pQ8L%2Fu6cvm%2Fy78iwj%2FOPweDd%2Fy2%2FeecH"  target="_blank" rel="noopener"
    >Work Stealing</a>, è¯¦è§åé¢çš„ä»£ç åˆ†æ.</p>
<p>å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¿å­˜åœ¨å…¨å±€å˜é‡<code>sched</code>ä¸­, å…¨å±€è¿è¡Œé˜Ÿåˆ—å…¥é˜Ÿå’Œå‡ºé˜Ÿéœ€è¦ä½¿ç”¨çº¿ç¨‹é”.
å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯é“¾è¡¨, ç”±ä¸¤ä¸ªæŒ‡é’ˆ(head, tail)ç»„æˆ.</p>
<h4 id="112-start">1.1.2. Start</h4>
<p>åœ¨è°ƒåº¦å™¨åˆå§‹å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå°† <code>maxmcount</code> è®¾ç½®æˆ 10000ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸€ä¸ª Go è¯­è¨€ç¨‹åºèƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œè™½ç„¶æœ€å¤šå¯ä»¥åˆ›å»º 10000 ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹è¿˜æ˜¯ç”± <code>GOMAXPROCS</code> å˜é‡æ§åˆ¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">nanotime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">procs</span> <span class="o">:=</span> <span class="nx">ncpu</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi32</span><span class="p">(</span><span class="nf">gogetenv</span><span class="p">(</span><span class="s">&#34;GOMAXPROCS&#34;</span><span class="p">));</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">procs</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">procs</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unknown runnable goroutine during bootstrap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“procresizeå¯åŠ¨åï¼Œå¼€å§‹ç­‰å¾…ç”¨æˆ·åˆ›å»ºè¿è¡Œæ–°çš„ Goroutine å¹¶ä¸º Goroutine è°ƒåº¦å¤„ç†å™¨èµ„æº</p>
<h3 id="12-create-goroutine">1.2. Create Goroutine</h3>
<p>å½“è°ƒç”¨go func()æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨callæ–¹æ³•ï¼Œç„¶åå†è½¬æ¢æˆnewprocçš„è°ƒç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">state</span><span class="p">)</span> <span class="nf">call</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">k</span> <span class="nx">callKind</span><span class="p">)</span> <span class="o">*</span><span class="nx">ssa</span><span class="p">.</span><span class="nx">Value</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">k</span> <span class="o">==</span> <span class="nx">callDeferStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">k</span> <span class="o">==</span> <span class="nx">callGo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">call</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">newValue1A</span><span class="p">(</span><span class="nx">ssa</span><span class="p">.</span><span class="nx">OpStaticCall</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">TypeMem</span><span class="p">,</span> <span class="nx">newproc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">mem</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>runtime.newproc</code>çš„å…¥å‚æ˜¯å‚æ•°å¤§å°å’Œè¡¨ç¤ºå‡½æ•°çš„æŒ‡é’ˆ <code>funcval</code>ï¼Œå®ƒä¼šè·å– Goroutine ä»¥åŠè°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œç„¶åè°ƒç”¨ <code>runtime.newproc1</code>å‡½æ•°è·å–æ–°çš„ Goroutine ç»“æ„ä½“ã€å°†å…¶åŠ å…¥å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—å¹¶åœ¨æ»¡è¶³æ¡ä»¶æ—¶è°ƒç”¨ <code>runtime.wakep</code> å”¤é†’æ–°çš„å¤„ç†æ‰§è¡Œ Goroutineï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newproc</span><span class="p">(</span><span class="nx">siz</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">argp</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fn</span><span class="p">),</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">argp</span><span class="p">,</span> <span class="nx">siz</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">newg</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">mainStarted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">wakep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­newproc1è°ƒç”¨å¦‚ä¸‹ï¼Œå…¶è°ƒç”¨å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰æ­¥ï¼š</p>
<ol>
<li>è·å–æˆ–è€…åˆ›å»ºæ–°çš„ Goroutine ç»“æ„ä½“</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">,</span> <span class="nx">argp</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">narg</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">callergp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">callerpc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">siz</span> <span class="o">:=</span> <span class="nx">narg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">siz</span> <span class="p">=</span> <span class="p">(</span><span class="nx">siz</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;^</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>  <span class="c1">// è·å–æ–°çš„g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">newg</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">_StackMin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gidle</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">allgadd</span><span class="p">(</span><span class="nx">newg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>æŠŠå‚æ•°æ”¾å…¥æ ˆåŒºï¼š</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ <code>runtime.memmove</code> å°† <code>fn</code> å‡½æ•°çš„æ‰€æœ‰å‚æ•°æ‹·è´åˆ°æ ˆä¸Šï¼Œ<code>argp</code> å’Œ <code>narg</code> åˆ†åˆ«æ˜¯å‚æ•°çš„å†…å­˜ç©ºé—´å’Œå¤§å°ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ä¼šå°†å‚æ•°å¯¹åº”çš„å†…å­˜ç©ºé—´æ•´å—æ‹·è´åˆ°æ ˆä¸Š</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">totalSize</span> <span class="o">:=</span> <span class="mi">4</span><span class="o">*</span><span class="nx">sys</span><span class="p">.</span><span class="nx">RegSize</span> <span class="o">+</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">siz</span><span class="p">)</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">MinFrameSize</span>
</span></span><span class="line"><span class="cl">    <span class="nx">totalSize</span> <span class="o">+=</span> <span class="o">-</span><span class="nx">totalSize</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">sys</span><span class="p">.</span><span class="nx">SpAlign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">totalSize</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spArg</span> <span class="o">:=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">narg</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memmove</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">spArg</span><span class="p">),</span> <span class="nx">argp</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">narg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>æ›´æ–° Goroutine è°ƒåº¦ç›¸å…³çš„å±æ€§ï¼›</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">stktopsp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nf">funcPC</span><span class="p">(</span><span class="nx">goexit</span><span class="p">)</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PCQuantum</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gostartcallfn</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">gopc</span> <span class="p">=</span> <span class="nx">callerpc</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">startpc</span> <span class="p">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">fn</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">goid</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­gfgetæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä» Goroutine æ‰€åœ¨å¤„ç†å™¨çš„ <code>gFree</code> åˆ—è¡¨æˆ–è€…è°ƒåº¦å™¨çš„ <code>sched.gFree</code> åˆ—è¡¨ä¸­è·å– <code>runtime.g</code>ï¼›</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Available G&#39;s (status == Gdead)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">gFree</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// A gList is a list of Gs linked through g.schedlink. A G can only be
</span></span></span><span class="line"><span class="cl"><span class="c1">// on one gQueue or gList at a time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">gList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">head</span> <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>è°ƒç”¨ <code>runtime.malg</code>ç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>runtime.g</code> å¹¶å°†ç»“æ„ä½“è¿½åŠ åˆ°å…¨å±€çš„ Goroutine åˆ—è¡¨ <code>allgs</code> ä¸­ã€‚</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">||</span> <span class="p">!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">gp</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>å½“å¤„ç†å™¨çš„ Goroutine åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œä¼šå°†è°ƒåº¦å™¨æŒæœ‰çš„ç©ºé—² Goroutine è½¬ç§»åˆ°å½“å‰å¤„ç†å™¨ä¸Šï¼Œç›´åˆ° <code>gFree</code> åˆ—è¡¨ä¸­çš„ Goroutine æ•°é‡è¾¾åˆ° 32ï¼›</li>
<li>å½“å¤„ç†å™¨çš„ Goroutine æ•°é‡å……è¶³æ—¶ï¼Œä¼šä»åˆ—è¡¨å¤´éƒ¨è¿”å›ä¸€ä¸ªæ–°çš„ Goroutineï¼›</li>
</ol>
<p>å½“è°ƒåº¦å™¨çš„ <code>gFree</code> å’Œå¤„ç†å™¨çš„ <code>gFree</code> åˆ—è¡¨éƒ½ä¸å­˜åœ¨ç»“æ„ä½“æ—¶ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ <code>runtime.malg</code>åˆå§‹åŒ–æ–°çš„ <code>runtime.g</code>ç»“æ„ï¼Œå¦‚æœç”³è¯·çš„å †æ ˆå¤§å°å¤§äº 0ï¼Œè¿™é‡Œä¼šé€šè¿‡ <code>runtime.stackalloc</code> åˆ†é… 2KB çš„æ ˆç©ºé—´ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">stacksize</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">stacksize</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stacksize</span> <span class="p">=</span> <span class="nf">round2</span><span class="p">(</span><span class="nx">_StackSystem</span> <span class="o">+</span> <span class="nx">stacksize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nf">stackalloc</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">stacksize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¹‹åä¼šè°ƒç”¨<code>runtime.runqput</code>ä¼šå°† Goroutine æ”¾åˆ°è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œè¿™æ—¢å¯èƒ½æ˜¯å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">retryNext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldnext</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">oldnext</span><span class="p">,</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">retryNext</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">oldnext</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="p">=</span> <span class="nx">oldnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">t</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>å½“ <code>next</code> ä¸º <code>true</code> æ—¶ï¼Œå°† Goroutine è®¾ç½®åˆ°å¤„ç†å™¨çš„ <code>runnext</code> ä½œä¸ºä¸‹ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œçš„ä»»åŠ¡ï¼›</li>
<li>å½“ <code>next</code> ä¸º <code>false</code> å¹¶ä¸”æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è¿˜æœ‰å‰©ä½™ç©ºé—´æ—¶ï¼Œå°† Goroutine åŠ å…¥å¤„ç†å™¨æŒæœ‰çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼›</li>
<li>å½“å¤„ç†å™¨çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²ç»æ²¡æœ‰å‰©ä½™ç©ºé—´æ—¶å°±ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­çš„ä¸€éƒ¨åˆ† Goroutine å’Œå¾…åŠ å…¥çš„ Goroutine é€šè¿‡ <code>runtime.runqputslow</code>æ·»åŠ åˆ°è°ƒåº¦å™¨æŒæœ‰çš„å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸Šï¼›</li>
</ol>
<p>è¿™é‡Œå–å…¨å±€é˜Ÿåˆ—çš„Goroutineæ•°ç›®åˆšå¥½ä¸ºn = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2))</p>
<h3 id="13-schedule">1.3. Schedule</h3>
<h4 id="131-m0-g0">1.3.1. M0, G0</h4>
<p>goè¯­è¨€çš„å¯åŠ¨æµç¨‹ç®€å•ç¤ºæ„è§ä¸‹æ³¨é‡Š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The bootstrap sequence is:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// call osinit
</span></span></span><span class="line"><span class="cl"><span class="c1">// call schedinit
</span></span></span><span class="line"><span class="cl"><span class="c1">// make &amp; queue new G
</span></span></span><span class="line"><span class="cl"><span class="c1">// call runtimeÂ·mstart
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The new G calls runtimeÂ·main.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤å¤–ï¼Œruntime/procä¸‹ä¹Ÿå®šä¹‰äº†åˆå§‹çŠ¶æ€</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m0</span>           <span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g0</span>           <span class="nx">g</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mcache0</span>      <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">raceprocctx0</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¨‹åºå¼€å§‹æ—¶ï¼Œä¼šå…ˆæ‰§è¡Œschedinitåˆ›å»ºç¬¬ä¸€ä¸ªGï¼Œmstartå‡½æ•°åˆ›å»ºç¬¬ä¸€ä¸ªM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">ts</span> <span class="nx">cgothreadstart</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_cgo_thread_start</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_thread_start missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">tls</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mp</span><span class="p">.</span><span class="nx">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanwrite</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">asmcgocall</span><span class="p">(</span><span class="nx">_cgo_thread_start</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mstart</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// è¿™é‡Œåˆ›å»ºçš„æ˜¯g0ï¼Œåˆ†é…åœ¨ç³»ç»Ÿå †æ ˆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="nx">osStack</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">osStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Initialize stack bounds from system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">size</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">size</span> <span class="p">=</span> <span class="mi">8192</span> <span class="o">*</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">StackGuardMultiplier</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Initialize stack guard so that we can start calling regular
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Go code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// This is the g0, so we can also call go:systemstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// functions, which check stackguard1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mstart1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Exit this thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nf">mStackIsSystemAllocated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">osStack</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mexit</span><span class="p">(</span><span class="nx">osStack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»¥ä¸Šå‡½æ•°å‡½æ•°ä¼šè°ƒç”¨mstart1æ¥å°†g0ç»‘å®šåˆ°m0ä¸Šï¼Œå¹¶å¼€å§‹æ‰§è¡Œscheduleè°ƒåº¦</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mstart1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">_g_</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad runtimeÂ·mstart&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Record the caller for use as the top of stack in mcall and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// for terminating the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// so other calls can reuse the current frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">save</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nf">getcallersp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nf">asminit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">minit</span><span class="p">()</span>  <span class="c1">// å°†Mè¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®çº¿ç¨‹çš„å¤‡ç”¨ä¿¡å·å †æ ˆå’Œä¿¡å·æ©ç 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Install signal handlers; after minit so that minit can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// prepare the thread to be able to handle the signals.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">mstartm0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mstartfn</span><span class="p">;</span> <span class="nx">fn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// mstartm0 implements part of mstart1 that only runs on the m0.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Write barriers are allowed here because we know the GC can&#39;t be
</span></span></span><span class="line"><span class="cl"><span class="c1">// running yet, so they&#39;ll be no-ops.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstartm0</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create an extra M for callbacks on threads not created by Go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// An extra M is also needed on Windows for callbacks created by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// syscall.NewCallback. See issue #6751 for details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">iscgo</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cgoHasExtraM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cgoHasExtraM</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="nf">newextram</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initsig</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>mstart1() åœ¨ç»“æŸé˜¶æ®µï¼Œä¼šè°ƒç”¨scheduleï¼Œè€Œscheduleåœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­ç¬¬ä¸€æ¬¡ä¼šæ‰¾åˆ°main goroutineï¼Œè€Œç¬¬ä¸€ä¸ªgoroutineç»‘å®šçš„æ–¹æ³•å°±æ˜¯mainï¼Œè€Œmainæ–¹æ³•å®Œæˆä»¥ä¸‹æ“ä½œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The main goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">g</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// It must not be used for anything else.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">g</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">racectx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Using decimal instead of binary GB and MB because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// they look nicer in the stack overflow failure message.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxstacksize</span> <span class="p">=</span> <span class="mi">1000000000</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxstacksize</span> <span class="p">=</span> <span class="mi">250000000</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// An upper limit for max stack size. Used to avoid random crashes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// after calling SetMaxStack and trying to allocate a stack that is too big,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// since stackalloc works with 32-bit sizes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">maxstackceiling</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">maxstacksize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Allow newproc to start new Ms.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">mainStarted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">!=</span> <span class="s">&#34;wasm&#34;</span> <span class="p">{</span> <span class="c1">// no threads on wasm yet, so no sysmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// For runtime_syscall_doAllThreadsSyscall, we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// register sysmon is not ready for the world to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonStarting</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">newm</span><span class="p">(</span><span class="nx">sysmon</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Lock the main goroutine onto this, the main OS thread,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// during initialization. Most programs won&#39;t care, but a few
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// do require certain calls to be made by the main thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Those can arrange for main.main to run in the main thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// by calling runtime.LockOSThread during initialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// to preserve the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">lockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">g</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime.main not on m0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">m0</span><span class="p">.</span><span class="nx">doesPark</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Record when the world started.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Must be before doInit for tracing init.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">runtimeInitTime</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">runtimeInitTime</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;nanotime returning zero&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">inittrace</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inittrace</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">goid</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inittrace</span><span class="p">.</span><span class="nx">active</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">doInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runtime_inittask</span><span class="p">)</span> <span class="c1">// Must be before defer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Defer unlock so that runtime.Goexit during init does the unlock too.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">needUnlock</span> <span class="o">:=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">needUnlock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">unlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">gcenable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">main_init_done</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">_cgo_thread_start</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_thread_start missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;windows&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">_cgo_setenv</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_setenv missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">_cgo_unsetenv</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_unsetenv missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">_cgo_notify_runtime_init_done</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_notify_runtime_init_done missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Start the template thread in case we enter Go from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// a C-created thread and need to create a new thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">startTemplateThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nf">cgocall</span><span class="p">(</span><span class="nx">_cgo_notify_runtime_init_done</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">doInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">main_inittask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Disable init tracing after main init done to avoid overhead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// of collecting statistics in malloc and newproc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">inittrace</span><span class="p">.</span><span class="nx">active</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nb">close</span><span class="p">(</span><span class="nx">main_init_done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">needUnlock</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">   <span class="nf">unlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">isarchive</span> <span class="o">||</span> <span class="nx">islibrary</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// A program compiled with -buildmode=c-archive or c-shared
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// has a main, but it is not executed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">main_main</span> <span class="c1">// make an indirect call, as the linker doesn&#39;t know the address of the main package when laying down the runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">racefini</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Make racy client program work: if panicking on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// another goroutine at the same time as main returns,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// let the other goroutine finish printing the panic trace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Once it does, it will exit. See issues 3934 and 20018.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Running deferred functions should not take long.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">c</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">c</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nf">Gosched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">panicking</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">gopark</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonPanicWait</span><span class="p">,</span> <span class="nx">traceEvGoStop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">x</span> <span class="o">*</span><span class="kt">int32</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="nx">x</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç»¼ä¸Šæ‰€è¿°ï¼šGoè¯­è¨€å¯åŠ¨æµç¨‹å¯ä»¥ç®€åŒ–å¦‚ä¸‹</p>
<p>ç¡®å®šå½“å‰ç³»ç»Ÿçš„å¹³å°ï¼ŒOSinit</p>
<p>schedinitï¼šåšå¥½åˆå§‹åŒ–ä¸€äº›é”ï¼Œcpuï¼Œgcç­‰ï¼Œä¹‹åè°ƒç”¨procresize</p>
<p>procresizeï¼šå°†å½“å‰çš„m0å’Œallp[0]è¿›è¡Œç»‘å®šï¼Œå†è°ƒç”¨</p>
<p>mstartï¼šåˆ†é…goçš„å †æ ˆï¼Œå°†m0å’Œg0ç»‘å®š</p>
<p>scheduleï¼šè°ƒåº¦å¼€å§‹ï¼Œé¦–å…ˆæ‰§è¡Œm0çš„g0ï¼Œç»‘å®šçš„å‡½æ•°å³ä¸ºmain</p>
<p>main goroutineï¼šå¼€å§‹å‡½æ•°çš„æ‰§è¡Œæµ</p>
<h4 id="132-schedinit">1.3.2. Schedinit</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">nanotime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">procs</span> <span class="o">:=</span> <span class="nx">ncpu</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi32</span><span class="p">(</span><span class="nf">gogetenv</span><span class="p">(</span><span class="s">&#34;GOMAXPROCS&#34;</span><span class="p">));</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">procs</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">procs</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unknown runnable goroutine during bootstrap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>å¦‚æœå…¨å±€å˜é‡ <code>allp</code> åˆ‡ç‰‡ä¸­çš„å¤„ç†å™¨æ•°é‡å°‘äºæœŸæœ›æ•°é‡ï¼Œä¼šå¯¹åˆ‡ç‰‡è¿›è¡Œæ‰©å®¹ï¼›</li>
<li>ä½¿ç”¨ <code>new</code> åˆ›å»ºæ–°çš„å¤„ç†å™¨ç»“æ„ä½“å¹¶è°ƒç”¨ <a class="link" href="https://draveness.me/golang/tree/runtime.p.init"  target="_blank" rel="noopener"
    ><code>runtime.p.init</code></a> åˆå§‹åŒ–åˆšåˆšæ‰©å®¹çš„å¤„ç†å™¨ï¼›</li>
<li>é€šè¿‡æŒ‡é’ˆå°†çº¿ç¨‹ m0 å’Œå¤„ç†å™¨ <code>allp[0]</code> ç»‘å®šåˆ°ä¸€èµ·ï¼›</li>
<li>è°ƒç”¨ <a class="link" href="https://draveness.me/golang/tree/runtime.p.destroy"  target="_blank" rel="noopener"
    ><code>runtime.p.destroy</code></a> é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¤„ç†å™¨ç»“æ„ï¼›</li>
<li>é€šè¿‡æˆªæ–­æ”¹å˜å…¨å±€å˜é‡ <code>allp</code> çš„é•¿åº¦ä¿è¯ä¸æœŸæœ›å¤„ç†å™¨æ•°é‡ç›¸ç­‰ï¼›</li>
<li>å°†é™¤ <code>allp[0]</code> ä¹‹å¤–çš„å¤„ç†å™¨ P å…¨éƒ¨è®¾ç½®æˆ <code>_Pidle</code> å¹¶åŠ å…¥åˆ°å…¨å±€çš„ç©ºé—²é˜Ÿåˆ—ä¸­ï¼›</li>
</ol>
<h4 id="133-schedule-loop">1.3.3. Schedule Loop</h4>
<p>å½“ç¨‹åºçš„è°ƒåº¦å™¨å¯åŠ¨ä¹‹åï¼Œä¼šæ‰§è¡Œschedule()å‡½æ•°æŸ¥æ‰¾goroutine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedule</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">top</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">inheritTime</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå‘ç”Ÿäº†61æ¬¡è°ƒåº¦ï¼Œä¸”å…¨å±€é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å»å…¨å±€é˜Ÿåˆ—ä¸­æ‰¾goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedtick</span><span class="o">%</span><span class="mi">61</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span> <span class="p">=</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="p">=</span> <span class="nf">runqget</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="p">=</span> <span class="nf">findrunnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Hands off own p to the locked m,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// then blocks waiting for a new p.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startlockedm</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>ä¸ºäº†ä¿è¯å…¬å¹³ï¼Œå½“å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æœ‰å¾…æ‰§è¡Œçš„ Goroutine æ—¶ï¼Œé€šè¿‡ <code>schedtick</code> ä¿è¯æœ‰ä¸€å®šå‡ ç‡ä¼šä»å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¯¹åº”çš„ Goroutineï¼›</li>
<li>ä»å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ Goroutineï¼›</li>
<li>å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰æ‰¾åˆ° Goroutineï¼Œä¼šé€šè¿‡ <code>runtime.findrunnable</code>è¿›è¡Œé˜»å¡åœ°æŸ¥æ‰¾ Goroutineï¼›</li>
</ol>
<p>findrunnableå‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>ä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾ï¼›</li>
<li>ä»ç½‘ç»œè½®è¯¢å™¨ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ Goroutine ç­‰å¾…è¿è¡Œï¼›</li>
<li>é€šè¿‡ <code>runtime.runqsteal</code>å°è¯•ä»å…¶ä»–éšæœºçš„å¤„ç†å™¨ä¸­çªƒå–å¾…è¿è¡Œçš„ Goroutineï¼Œè¯¥å‡½æ•°è¿˜å¯èƒ½çªƒå–å¤„ç†å™¨çš„è®¡æ—¶å™¨ï¼›</li>
</ol>
<p>åœ¨è·å–åˆ°Goroutineä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨executeå‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="p">=</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitsince</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">inheritTime</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedtick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡gogoå‡½æ•°ï¼Œå°†è¿™ä¸ªGoroutineè°ƒåº¦åˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œgogoå‡½æ•°ä¼šä» <code>runtime.gobuf</code> ä¸­å–å‡ºäº† <code>runtime.goexit</code>çš„ç¨‹åºè®¡æ•°å™¨å’Œå¾…æ‰§è¡Œå‡½æ•°çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li><code>runtime.goexit</code> çš„ç¨‹åºè®¡æ•°å™¨è¢«æ”¾åˆ°äº†æ ˆ SP ä¸Šï¼›</li>
<li>å¾…æ‰§è¡Œå‡½æ•°çš„ç¨‹åºè®¡æ•°å™¨è¢«æ”¾åˆ°äº†å¯„å­˜å™¨ BX ä¸Šï¼›</li>
</ul>
<p>å½“è¿™ä¸ªGoroutineç»“æŸçš„æ—¶å€™ï¼Œä¼šruntimeÂ·goexit(SB)ï¼Œå†ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„å‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆåœ¨å½“å‰çº¿ç¨‹çš„ g0 çš„æ ˆä¸Šè°ƒç”¨ <code>runtime.goexit0</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°† Goroutine è½¬æ¢ä¼š <code>_Gdead</code> çŠ¶æ€ã€æ¸…ç†å…¶ä¸­çš„å­—æ®µã€ç§»é™¤ Goroutine å’Œçº¿ç¨‹çš„å…³è”å¹¶è°ƒç”¨ <code>runtime.gfput</code>é‡æ–°åŠ å…¥å¤„ç†å™¨çš„ Goroutine ç©ºé—²åˆ—è¡¨ <code>gFree</code>ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goexit0</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">labels</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">timer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gfput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨goexit0è°ƒç”¨ç»“æŸåï¼Œä¼šå†æ¬¡å‡ºå‘schedule()é‡æ–°è¿›è¡Œä¸€è½®è°ƒåº¦ã€‚</p>
<h3 id="14-trigger-scheduling">1.4. Trigger Scheduling</h3>
<h4 id="140-create">1.4.0. Create</h4>
<p>è¯¦æƒ…è§1.2ï¼Œåœ¨çº¿ç¨‹å¯åŠ¨ <code>runtime.mstart</code>å’Œ Goroutine æ‰§è¡Œç»“æŸ <code>runtime.goexit0</code>è§¦å‘è°ƒåº¦ä¹‹å¤–ã€‚è¿˜æœ‰ä»¥ä¸‹æ–¹æ³•ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒåº¦ç­–ç•¥ã€‚</p>
<h4 id="141-park">1.4.1. Park</h4>
<p>ä¸»åŠ¨æŒ‚èµ·æ˜¯è§¦å‘è°ƒåº¦æœ€å¸¸è§çš„æ–¹æ³•ï¼Œè¯¥å‡½æ•°ä¼šå°†å½“å‰ Goroutine æš‚åœï¼Œè¢«æš‚åœçš„ä»»åŠ¡ä¸ä¼šæ”¾å›è¿è¡Œé˜Ÿåˆ—</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gopark</span><span class="p">(</span><span class="nx">unlockf</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">lock</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">reason</span> <span class="nx">waitReason</span><span class="p">,</span> <span class="nx">traceEv</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">curg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitlock</span> <span class="p">=</span> <span class="nx">lock</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitunlockf</span> <span class="p">=</span> <span class="nx">unlockf</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitreason</span> <span class="p">=</span> <span class="nx">reason</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceev</span> <span class="p">=</span> <span class="nx">traceEv</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceskip</span> <span class="p">=</span> <span class="nx">traceskip</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mcall</span><span class="p">(</span><span class="nx">park_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­park_mè¿˜ä¼šå°†çŠ¶æ€ç”±_Grunningåˆ‡æ¢ä¸º_Gwaitingï¼Œå¹¶ä¸”ä½¿ç”¨dropgç§»é™¤å½“å‰çº¿ç¨‹å’Œè¿™ä¸ªGoroutineçš„å…³è”ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">park_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†éœ€è¦é‡æ–°å”¤é†’çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå”¤é†’ï¼Œå°†çŠ¶æ€åˆ‡æ¢å›_Grunnable å¹¶å°†å…¶åŠ å…¥å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">runqput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wakep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="142-system-call">1.4.2. System call</h4>
<p>Go è¯­è¨€é€šè¿‡ <code>syscall.Syscall</code>å’Œ <code>syscall.RawSyscall</code>ç­‰ä½¿ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„æ–¹æ³•å°è£…æ“ä½œç³»ç»Ÿæä¾›çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#define INVOKE_SYSCALL    INT    $0x80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TEXT Â·Syscall(SB),NOSPLIT,$0-28
</span></span><span class="line"><span class="cl">    CALL    runtimeÂ·entersyscall(SB)
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    INVOKE_SYSCALL
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    CALL    runtimeÂ·exitsyscall(SB)
</span></span><span class="line"><span class="cl">    RET
</span></span><span class="line"><span class="cl">ok:
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    CALL    runtimeÂ·exitsyscall(SB)
</span></span><span class="line"><span class="cl">    RET
</span></span></code></pre></td></tr></table>
</div>
</div><p>Goä½¿ç”¨äº†entrysyscallå’Œexitsyscallå®Œæˆç³»ç»Ÿè°ƒç”¨æ—¶çš„å‡†å¤‡ä¸æ¸…ç†å·¥ä½œï¼Œå¯¹äºä¸éœ€è¦è¿è¡Œæ—¶å‚ä¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚SYS_TIMEï¼ŒSYS_EPOLL_WAITï¼ŒGoå°è£…äº†ä¸€å±‚RawSyscallæ¥è°ƒç”¨ã€‚</p>
<p>åœ¨è°ƒç”¨entrysyscallä¼šè°ƒç”¨reentersyscallå‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname entersyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">entersyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">reentersyscall</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nf">getcallersp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">reentersyscall</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallpc</span> <span class="p">=</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mcache</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">entersyscall_gcwait</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>ç¦æ­¢çº¿ç¨‹ä¸Šå‘ç”Ÿçš„æŠ¢å ï¼Œé˜²æ­¢å‡ºç°å†…å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼›</li>
<li>ä¿è¯å½“å‰å‡½æ•°ä¸ä¼šè§¦å‘æ ˆåˆ†è£‚æˆ–è€…å¢é•¿ï¼›</li>
<li>ä¿å­˜å½“å‰çš„ç¨‹åºè®¡æ•°å™¨ PC å’Œæ ˆæŒ‡é’ˆ SP ä¸­çš„å†…å®¹ï¼›</li>
<li>å°† Goroutine çš„çŠ¶æ€æ›´æ–°è‡³ <code>_Gsyscall</code>ï¼›</li>
<li>å°† Goroutine çš„å¤„ç†å™¨å’Œçº¿ç¨‹æš‚æ—¶åˆ†ç¦»å¹¶æ›´æ–°å¤„ç†å™¨çš„çŠ¶æ€åˆ° <code>_Psyscall</code>ï¼›</li>
<li>é‡Šæ”¾å½“å‰çº¿ç¨‹ä¸Šçš„é”ï¼›</li>
</ol>
<p>å½“å‰çº¿ç¨‹ä¼šé™·å…¥ç³»ç»Ÿè°ƒç”¨ç­‰å¾…è¿”å›ï¼Œåœ¨é”è¢«é‡Šæ”¾åï¼Œä¼šæœ‰å…¶ä»– Goroutine æŠ¢å å¤„ç†å™¨èµ„æºã€‚</p>
<p>å½“ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼Œä¼šå†æ¬¡è¿”å›</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">exitsyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">oldp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">exitsyscallfast</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">mcall</span><span class="p">(</span><span class="nx">exitsyscall0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­exitsyscallfastä¼šæœ‰ä¸¤ç§ä¸åŒçš„åˆ†æ”¯ï¼š</p>
<ol>
<li>å¦‚æœ Goroutine çš„åŸå¤„ç†å™¨å¤„äº <code>_Psyscall</code> çŠ¶æ€ï¼Œä¼šç›´æ¥è°ƒç”¨ <code>wirep</code> å°† Goroutine ä¸å¤„ç†å™¨è¿›è¡Œå…³è”ï¼›</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// Try to re-acquire the last P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">_Psyscall</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">,</span> <span class="nx">_Pidle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There&#39;s a cpu for us, so we can run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">wirep</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exitsyscallfast_reacquired</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>å¦‚æœè°ƒåº¦å™¨ä¸­å­˜åœ¨é—²ç½®çš„å¤„ç†å™¨ï¼Œä¼šè°ƒç”¨ <code>acquirep</code>ä½¿ç”¨é—²ç½®çš„å¤„ç†å™¨å¤„ç†å½“å‰ Goroutineï¼›</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">exitsyscallfast_pidle</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">pidleget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// wirep is the first step of acquirep, which actually associates the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current M to _p_. This is broken out so we can disallow write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers for this part, since we don&#39;t yet have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: already in go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Pidle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wirep: p-&gt;m=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;) p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¦ä¸€ä¸ªç›¸å¯¹è¾ƒæ…¢çš„è·¯å¾„ <a class="link" href="https://draveness.me/golang/tree/runtime.exitsyscall0"  target="_blank" rel="noopener"
    ><code>runtime.exitsyscall0</code></a> ä¼šå°†å½“å‰ Goroutine åˆ‡æ¢è‡³ <code>_Grunnable</code> çŠ¶æ€ï¼Œå¹¶ç§»é™¤çº¿ç¨‹ M å’Œå½“å‰ Goroutine çš„å…³è”ï¼š</p>
<ol>
<li>å½“æˆ‘ä»¬é€šè¿‡ <a class="link" href="https://draveness.me/golang/tree/runtime.pidleget"  target="_blank" rel="noopener"
    ><code>runtime.pidleget</code></a> è·å–åˆ°é—²ç½®çš„å¤„ç†å™¨æ—¶å°±ä¼šåœ¨è¯¥å¤„ç†å™¨ä¸Šæ‰§è¡Œ Goroutineï¼›</li>
<li>åœ¨å…¶å®ƒæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°†å½“å‰ Goroutine æ”¾åˆ°å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ï¼›</li>
</ol>
<p>æ— è®ºå“ªç§æƒ…å†µï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªå‡½æ•°ä¸­éƒ½ä¼šè°ƒç”¨ <a class="link" href="https://draveness.me/golang/tree/runtime.schedule"  target="_blank" rel="noopener"
    ><code>runtime.schedule</code></a> è§¦å‘è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p>
<h4 id="143-cooperative">1.4.3. Cooperative</h4>
<p>è¯¥æ–¹æ³•ä¸ä¼šæŒ‚èµ·Goroutineï¼Œè€Œæ˜¯å°†å½“å‰çš„Goroutineè°ƒåº¦åˆ°å…¶ä»–çº¿ç¨‹ä¸Š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Gosched yields the processor, allowing other goroutines to run. It does not
</span></span></span><span class="line"><span class="cl"><span class="c1">// suspend the current goroutine, so execution resumes automatically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Gosched</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nf">checkTimeouts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mcall</span><span class="p">(</span><span class="nx">gosched_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gosched continuation on g0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gosched_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoSched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">status</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">!=</span> <span class="nx">_Grunning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">dumpgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">globrunqput</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œæ—¶ä¼šæ›´æ–° Goroutine çš„çŠ¶æ€åˆ° <code>_Grunnable</code>ï¼Œè®©å‡ºå½“å‰çš„å¤„ç†å™¨å¹¶å°† Goroutine é‡æ–°æ”¾å›å…¨å±€é˜Ÿåˆ—ï¼Œåœ¨æœ€åï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ <code>runtime.schedule</code> è§¦å‘è°ƒåº¦ã€‚</p>
<h3 id="15-thread-control">1.5. Thread Control</h3>
<p>Goroutine åº”è¯¥åœ¨è°ƒç”¨æ“ä½œç³»ç»ŸæœåŠ¡æˆ–è€…ä¾èµ–çº¿ç¨‹çŠ¶æ€çš„é Go è¯­è¨€åº“æ—¶è°ƒç”¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockOSThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">haveTemplateThread</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startTemplateThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedExt</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dolockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">dolockOSThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedg</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">lockedm</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¼šåˆ†åˆ«è®¾ç½®çº¿ç¨‹çš„ <code>lockedg</code> å­—æ®µå’Œ Goroutine çš„ <code>lockedm</code> å­—æ®µï¼Œè¿™ä¸¤è¡Œä»£ç ä¼šç»‘å®šçº¿ç¨‹å’Œ Goroutineã€‚</p>
<p>å½“Goroutineå®Œæˆæ“ä½œä¹‹åï¼Œä¼šä½¿ç”¨å¦‚ä¸‹æ–¹æ³•åˆ†ç¦»Goroutineå’Œçº¿ç¨‹ã€‚</p>
<p>Go è¯­è¨€çš„è¿è¡Œæ—¶ä¼šé€šè¿‡ <a class="link" href="https://draveness.me/golang/tree/runtime.startm"  target="_blank" rel="noopener"
    ><code>runtime.startm</code></a> å¯åŠ¨çº¿ç¨‹æ¥æ‰§è¡Œå¤„ç†å™¨ Pï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­æ²¡èƒ½ä»é—²ç½®åˆ—è¡¨ä¸­è·å–åˆ°çº¿ç¨‹ M å°±ä¼šè°ƒç”¨ <a class="link" href="https://draveness.me/golang/tree/runtime.newm"  target="_blank" rel="noopener"
    ><code>runtime.newm</code></a> åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¯¥å‡½æ•°åœ¨ Linux å¹³å°ä¸Šä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>clone</code> åˆ›å»ºæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå®ƒä¹Ÿæ˜¯åˆ›å»ºçº¿ç¨‹é“¾è·¯ä¸Šè·ç¦»æ“ä½œç³»ç»Ÿæœ€è¿‘çš„ Go è¯­è¨€å‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stk</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">clone</span><span class="p">(</span><span class="nx">cloneFlags</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-system-monitor">2. System Monitor</h2>
<p>åœ¨ç¨‹åºå¯åŠ¨å‰ï¼Œä¼šé¦–å…ˆè°ƒç”¨runtime.mainå‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†sysmonçš„åˆ›å»º</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">!=</span> <span class="s">&#34;wasm&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">newm</span><span class="p">(</span><span class="nx">sysmon</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>newm1ä¼šè°ƒç”¨ç‰¹å®šå¹³å°çš„ <a class="link" href="https://draveness.me/golang/tree/runtime.newosproc"  target="_blank" rel="noopener"
    ><code>runtime.newosproc</code></a> é€šè¿‡ç³»ç»Ÿè°ƒç”¨ <code>clone</code> åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œ <a class="link" href="https://draveness.me/golang/tree/runtime.mstart"  target="_blank" rel="noopener"
    ><code>runtime.mstart</code></a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stk</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">oset</span> <span class="nx">sigset</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sigset_all</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">clone</span><span class="p">(</span><span class="nx">cloneFlags</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨æ–°å»ºçº¿ç¨‹æ—¶ï¼Œä¼šæ‰§è¡Œruntime.mä¸­çš„sysmonå¯åŠ¨ç›‘æ§</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sysmon</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">nmsys</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">checkdead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">lasttrace</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">idle</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">delay</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">idle</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="p">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">idle</span> <span class="p">&gt;</span> <span class="mi">50</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="o">*=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">delay</span> <span class="p">&gt;</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">usleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“è¿è¡Œæ—¶åˆšåˆšè°ƒç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œä¼šå…ˆé€šè¿‡ <a class="link" href="https://draveness.me/golang/tree/runtime.checkdead"  target="_blank" rel="noopener"
    ><code>runtime.checkdead</code></a> æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ­»é”ï¼Œç„¶åè¿›å…¥æ ¸å¿ƒçš„ç›‘æ§å¾ªç¯ï¼›ç³»ç»Ÿç›‘æ§åœ¨æ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶éƒ½ä¼šé€šè¿‡ <code>usleep</code> æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æ˜¯å¾®ç§’ï¼Œè¿è¡Œæ—¶ä¼šéµå¾ªä»¥ä¸‹çš„è§„åˆ™å†³å®šä¼‘çœ æ—¶é—´ï¼š</p>
<ul>
<li>åˆå§‹çš„ä¼‘çœ æ—¶é—´æ˜¯ 20Î¼sï¼›</li>
<li>æœ€é•¿çš„ä¼‘çœ æ—¶é—´æ˜¯ 10msï¼›</li>
<li>å½“ç³»ç»Ÿç›‘æ§åœ¨ 50 ä¸ªå¾ªç¯ä¸­éƒ½æ²¡æœ‰å”¤é†’ Goroutine æ—¶ï¼Œä¼‘çœ æ—¶é—´åœ¨æ¯ä¸ªå¾ªç¯éƒ½ä¼šå€å¢ï¼›</li>
</ul>
<p>å½“ç¨‹åºè¶‹äºç¨³å®šä¹‹åï¼Œç³»ç»Ÿç›‘æ§çš„è§¦å‘æ—¶é—´å°±ä¼šç¨³å®šåœ¨ 10msã€‚å®ƒé™¤äº†ä¼šæ£€æŸ¥æ­»é”ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å¾ªç¯ä¸­å®Œæˆä»¥ä¸‹çš„å·¥ä½œï¼š</p>
<ul>
<li>è¿è¡Œè®¡æ—¶å™¨ â€” è·å–ä¸‹ä¸€ä¸ªéœ€è¦è¢«è§¦å‘çš„è®¡æ—¶å™¨ï¼›</li>
<li>è½®è¯¢ç½‘ç»œ â€” è·å–éœ€è¦å¤„ç†çš„åˆ°æœŸæ–‡ä»¶æè¿°ç¬¦ï¼›</li>
<li>æŠ¢å å¤„ç†å™¨ â€” æŠ¢å è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æˆ–è€…å¤„äºç³»ç»Ÿè°ƒç”¨çš„ Goroutineï¼›</li>
<li>åƒåœ¾å›æ”¶ â€” åœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘åƒåœ¾æ”¶é›†å›æ”¶å†…å­˜ï¼›</li>
</ul>
<h2 id="3-stack-and-heap">3. Stack And Heap</h2>
<h3 id="31-traditional-language">3.1. Traditional Language</h3>
<ol>
<li>
<p>æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿæ¥åˆ†é…å’Œé‡Šæ”¾ï¼Œå †ç”±ç¨‹åºå‘˜é€šè¿‡ç¼–ç¨‹è¯­è¨€æ¥ç”³è¯·åˆ›å»ºä¸é‡Šæ”¾ã€‚</p>
</li>
<li>
<p>æ ˆç”¨æ¥å­˜æ”¾å‡½æ•°çš„å‚æ•°ã€è¿”å›å€¼ã€å±€éƒ¨å˜é‡ã€å‡½æ•°è°ƒç”¨æ—¶çš„ä¸´æ—¶ä¸Šä¸‹æ–‡ç­‰ï¼Œå †ç”¨æ¥å­˜æ”¾å…¨å±€å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£æ•°æ®å­˜æ”¾çš„è§„åˆ™ï¼šåªè¦æ˜¯å±€éƒ¨çš„ã€å ç”¨ç©ºé—´ç¡®å®šçš„æ•°æ®ï¼Œä¸€èˆ¬éƒ½å­˜æ”¾åœ¨stack é‡Œé¢ï¼Œå¦åˆ™å°±æ”¾åœ¨ heap é‡Œé¢ã€‚</p>
</li>
<li>
<p>æ ˆçš„è®¿é—®é€Ÿåº¦ç›¸å¯¹æ¯”å †å¿«ã€‚</p>
</li>
<li>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªstackï¼Œæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªheapï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œstack æ˜¯çº¿ç¨‹ç‹¬å çš„ï¼Œheap æ˜¯çº¿ç¨‹å…±ç”¨çš„ã€‚</p>
</li>
<li>
<p>stack åˆ›å»ºçš„æ—¶å€™ï¼Œå¤§å°æ˜¯ç¡®å®šçš„ï¼Œæ•°æ®è¶…è¿‡è¿™ä¸ªå¤§å°ï¼Œå°±å‘ç”Ÿstack overflow é”™è¯¯ï¼Œè€Œheapçš„å¤§å°æ˜¯ä¸ç¡®å®šçš„ï¼Œéœ€è¦çš„è¯å¯ä»¥ä¸æ–­å¢åŠ ã€‚</p>
</li>
<li>
<p>æ ˆæ˜¯ç”±é«˜åœ°å€å‘ä½åœ°å€å¢é•¿çš„ï¼Œè€Œå †æ˜¯ç”±ä½åœ°å€å‘é«˜åœ°å€å¢é•¿çš„ã€‚</p>
<p>åœ¨Goè¯­è¨€ä¸­ï¼Œå®˜æ–¹å¯¹å †æ ˆç®¡ç†åšäº†å¦‚ä¸‹çš„è§£é‡Š
åªè¦æœ‰å¯¹å˜é‡çš„å¼•ç”¨ï¼Œå˜é‡å°±ä¼šå­˜åœ¨ï¼Œè€Œå®ƒå­˜å‚¨çš„ä½ç½®ä¸è¯­è¨€çš„è¯­ä¹‰æ— å…³ã€‚å¦‚æœå¯èƒ½ï¼Œå˜é‡ä¼šè¢«åˆ†é…åˆ°å…¶å‡½æ•°çš„æ ˆï¼Œä½†å¦‚æœç¼–è¯‘å™¨æ— æ³•è¯æ˜å‡½æ•°è¿”å›ä¹‹åå˜é‡æ˜¯å¦ä»ç„¶è¢«å¼•ç”¨ï¼Œå°±å¿…é¡»åœ¨å †ä¸Šåˆ†é…è¯¥å˜é‡ï¼Œé‡‡ç”¨åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œ    ç®¡ç†ï¼Œä»è€Œé¿å…æŒ‡é’ˆæ‚¬ç©ºã€‚æ­¤å¤–ï¼Œå±€éƒ¨å˜é‡å¦‚æœéå¸¸å¤§ï¼Œä¹Ÿä¼šå­˜åœ¨å †ä¸Šã€‚</p>
</li>
</ol>
<p>åœ¨ç¼–è¯‘å™¨ä¸­ï¼Œå¦‚æœå˜é‡å…·æœ‰åœ°å€ï¼Œå°±ä½œä¸ºå †åˆ†é…çš„å€™é€‰ï¼Œä½†å¦‚æœé€ƒé€¸åˆ†æå¯ä»¥ç¡®å®šå…¶ç”Ÿå­˜å‘¨æœŸä¸ä¼šè¶…è¿‡å‡½æ•°è¿”å›ï¼Œå°±ä¼šåˆ†é…åœ¨æ ˆä¸Šã€‚</p>
<h3 id="32-implement">3.2. Implement</h3>
<p>Go çš„å†…å­˜åˆ†é…å™¨åŸºäº Thread-Cache Malloc (tcmalloc) ï¼Œtcmalloc ä¸ºæ¯ä¸ªçº¿ç¨‹å®ç°äº†ä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼Œ åŒºåˆ†äº†å°å¯¹è±¡ï¼ˆå°äº 32kbï¼‰å’Œå¤§å¯¹è±¡åˆ†é…ä¸¤ç§åˆ†é…ç±»å‹ï¼Œå…¶ç®¡ç†çš„å†…å­˜å•å…ƒç§°ä¸º spanã€‚</p>
<ul>
<li>heapArena: ä¿ç•™æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A heapArena stores metadata for a heap arena. heapArenas are stored
</span></span></span><span class="line"><span class="cl"><span class="c1">// outside of the Go heap and accessed via the mheap_.arenas index.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">heapArena</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bitmap</span>     <span class="p">[</span><span class="nx">heapArenaBitmapBytes</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spans</span>      <span class="p">[</span><span class="nx">pagesPerArena</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span>  <span class="c1">// spans maps from virtual address page ID within this arena to *mspan.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pageInUse</span>  <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pageMarks</span>  <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pageSpecials</span> <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">checkmarks</span> <span class="o">*</span><span class="nx">checkmarksMap</span>
</span></span><span class="line"><span class="cl">    <span class="nx">zeroedBase</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//arenaHint is a hint for where to grow the heap arenas. See
</span></span></span><span class="line"><span class="cl"><span class="c1">// mheap_.arenaHints.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">arenaHint</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">down</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">next</span> <span class="o">*</span><span class="nx">arenaHint</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>mheapï¼šåˆ†é…çš„å †ï¼Œåœ¨é¡µå¤§å°ä¸º 8KB çš„ç²’åº¦ä¸Šè¿›è¡Œç®¡ç†</p>
<p>ç„¶è€Œç®¡ç† arena å¦‚æ­¤ç²’åº¦çš„å†…å­˜å¹¶ä¸ç¬¦åˆå®è·µï¼Œç›¸åï¼Œæ‰€æœ‰çš„å †å¯¹è±¡éƒ½é€šè¿‡ span æŒ‰ç…§é¢„å…ˆè®¾å®šå¥½çš„ å¤§å°ç­‰çº§åˆ†åˆ«åˆ†é…ï¼Œå°äº 32KB çš„å°å¯¹è±¡åˆ™åˆ†é…åœ¨å›ºå®šå¤§å°ç­‰çº§çš„ span ä¸Šï¼Œå¦åˆ™ç›´æ¥ä» mheap ä¸Šè¿›è¡Œåˆ†é…ã€‚</p>
</li>
<li>
<p>mspanï¼šæ˜¯ mheap ä¸Šç®¡ç†çš„ä¸€è¿ä¸²çš„é¡µ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mspan</span> <span class="kd">struct</span> <span class="p">{</span> <span class="c1">// åŒå‘é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next</span> <span class="o">*</span><span class="nx">mspan</span>     <span class="c1">// é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª spanï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸º nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prev</span> <span class="o">*</span><span class="nx">mspan</span>     <span class="c1">// é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ª spanï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸º nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">startAddr</span>      <span class="kt">uintptr</span> <span class="c1">// span çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œå³ s.base()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">npages</span>         <span class="kt">uintptr</span> <span class="c1">// ä¸€ä¸ª span ä¸­çš„ page æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">manualFreeList</span> <span class="nx">gclinkptr</span> <span class="c1">// mSpanManual span çš„é‡Šæ”¾å¯¹è±¡é“¾è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">freeindex</span>  <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nelems</span>     <span class="kt">uintptr</span> <span class="c1">// span ä¸­å¯¹è±¡çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allocCache</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allocBits</span>  <span class="o">*</span><span class="nx">gcBits</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allocCount</span>  <span class="kt">uint16</span>     <span class="c1">// åˆ†é…å¯¹è±¡çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">spanclass</span>   <span class="nx">spanClass</span>  <span class="c1">// å¤§å°ç­‰çº§ä¸ noscan (uint8)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">incache</span>     <span class="kt">bool</span>       <span class="c1">// æ˜¯å¦è¢« mcache ä½¿ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">state</span>       <span class="nx">mSpanState</span> <span class="c1">// mspaninuse ç­‰å¾…ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcentralï¼šæ”¶é›†äº†ç»™å®šå¤§å°ç­‰çº§çš„æ‰€æœ‰ spanã€‚å½“ mcentral ä¸­ nonempty åˆ—è¡¨ä¸­ä¹Ÿæ²¡æœ‰å¯åˆ†é…çš„ span æ—¶ï¼Œåˆ™ä¼šå‘ mheap æå‡ºè¯·æ±‚ï¼Œä»è€Œè·å¾—æ–°çš„ spanï¼Œå¹¶è¿›è€Œäº¤ç»™ mcacheã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcentral</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lock</span>      <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spanclass</span> <span class="nx">spanClass</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nonempty</span>  <span class="nx">mSpanList</span> <span class="c1">// å¸¦æœ‰è‡ªç”±å¯¹è±¡çš„ span åˆ—è¡¨ï¼Œå³éç©ºé—²åˆ—è¡¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">empty</span>     <span class="nx">mSpanList</span> <span class="c1">// æ²¡æœ‰è‡ªç”±å¯¹è±¡çš„ span åˆ—è¡¨ï¼ˆæˆ–ç¼“å­˜åœ¨ mcache ä¸­ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcacheï¼šä¸º per-P çš„ç¼“å­˜ã€‚</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tiny</span>             <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tinyoffset</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local_tinyallocs</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alloc</span>            <span class="p">[</span><span class="nx">numSpanClasses</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span> <span class="c1">// ç”¨æ¥åˆ†é…çš„ spansï¼Œç”± spanClass ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackcache</span>       <span class="p">[</span><span class="nx">_NumStackOrders</span><span class="p">]</span><span class="nx">stackfreelist</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>mcacheè´Ÿè´£å°å¯¹è±¡å’Œå¾®å¯¹è±¡çš„åˆ†é…ï¼Œå…¶æŒæœ‰mspan</p>
<h3 id="33-allocation">3.3. Allocation</h3>
<p>å¸¸è§çš„å†…å­˜ç®¡ç†æ¨¡å—åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§fixallocã€linearAllocã€mcache</p>
<p>fixalloc æ˜¯ä¸€ä¸ªåŸºäºè‡ªç”±åˆ—è¡¨çš„å›ºå®šå¤§å°çš„åˆ†é…å™¨ã€‚å…¶æ ¸å¿ƒåŸç†æ˜¯å°†è‹¥å¹²æœªåˆ†é…çš„å†…å­˜å—è¿æ¥èµ·æ¥ï¼Œ å°†æœªåˆ†é…çš„åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­—ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªæœªåˆ†é…åŒºåŸŸçš„æŒ‡é’ˆä½¿ç”¨ã€‚Go çš„ä¸»åˆ†é…å †ä¸­ mallocï¼ˆspanã€cacheã€treapã€finalizerã€profileã€arena hint ç­‰ï¼‰ å‡ å›´ç»•å®ƒä¸ºå®ä½“è¿›è¡Œå›ºå®šåˆ†é…å’Œå›æ”¶ã€‚</p>
<p>fixalloc ä½œä¸ºæŠ½è±¡ï¼Œéå¸¸ç®€æ´ï¼ŒåªåŒ…å«ä¸‰ä¸ªåŸºæœ¬æ“ä½œï¼šåˆå§‹åŒ–ã€åˆ†é…ã€å›æ”¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// fixalloc æ˜¯ä¸€ä¸ªç®€å•çš„å›ºå®šå¤§å°å¯¹è±¡çš„è‡ªç”±è¡¨å†…å­˜åˆ†é…å™¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// Malloc ä½¿ç”¨å›´ç»• sysAlloc çš„ fixalloc æ¥ç®¡ç†å…¶ MCache å’Œ MSpan å¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// fixalloc.alloc è¿”å›çš„å†…å­˜é»˜è®¤ä¸ºé›¶ï¼Œä½†è°ƒç”¨è€…å¯ä»¥é€šè¿‡å°† zero æ ‡å¿—è®¾ç½®ä¸º false
</span></span></span><span class="line"><span class="cl"><span class="c1">// æ¥è‡ªè¡Œè´Ÿè´£å°†åˆ†é…å½’é›¶ã€‚å¦‚æœè¿™éƒ¨åˆ†å†…å­˜æ°¸è¿œä¸åŒ…å«å †æŒ‡é’ˆï¼Œåˆ™è¿™æ ·çš„æ“ä½œæ˜¯å®‰å…¨çš„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// è°ƒç”¨æ–¹è´Ÿè´£é”å®š fixalloc è°ƒç”¨ã€‚è°ƒç”¨æ–¹å¯ä»¥åœ¨å¯¹è±¡ä¸­ä¿æŒçŠ¶æ€ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ä½†å½“é‡Šæ”¾å’Œé‡æ–°åˆ†é…æ—¶ç¬¬ä¸€ä¸ªå­—ä¼šè¢«ç ´åã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// è€ƒè™‘ä½¿ fixalloc çš„ç±»å‹å˜ä¸º go:notinheap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">fixalloc</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">first</span>  <span class="kd">func</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="c1">// é¦–æ¬¡è°ƒç”¨æ—¶è¿”å› p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arg</span>    <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">list</span>   <span class="o">*</span><span class="nx">mlink</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunk</span>  <span class="kt">uintptr</span> <span class="c1">// ä½¿ç”¨ uintptr è€Œé unsafe.Pointer æ¥é¿å… write barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nchunk</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inuse</span>  <span class="kt">uintptr</span> <span class="c1">// æ­£åœ¨ä½¿ç”¨çš„å­—èŠ‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stat</span>   <span class="o">*</span><span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">zero</span>   <span class="kt">bool</span> <span class="c1">// å½’é›¶çš„åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go è¯­è¨€å¯¹äºé›¶å€¼æœ‰è‡ªå·±çš„è§„å®šï¼Œè‡ªç„¶ä¹Ÿå°±ä½“ç°åœ¨å†…å­˜åˆ†é…å™¨ä¸Šã€‚è€Œ fixalloc ä½œä¸ºå†…å­˜åˆ†é…å™¨å†…éƒ¨ç»„ä»¶çš„æ¥æºäº æ“ä½œç³»ç»Ÿçš„å†…å­˜ï¼Œè‡ªç„¶éœ€è¦è‡ªè¡Œåˆå§‹åŒ–ï¼Œå› æ­¤ï¼Œfixalloc çš„åˆå§‹åŒ–ä¹Ÿå°±ä¸å¯é¿å…çš„éœ€è¦å°†è‡ªèº«çš„å„ä¸ªå­—æ®µå½’é›¶ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">fixalloc</span><span class="p">)</span> <span class="nf">init</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">first</span> <span class="kd">func</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">),</span> <span class="nx">arg</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">stat</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="nx">size</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="nx">first</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">arg</span> <span class="p">=</span> <span class="nx">arg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">list</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">chunk</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">nchunk</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">inuse</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">stat</span> <span class="p">=</span> <span class="nx">stat</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">zero</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>fixalloc åŸºäºè‡ªç”±è¡¨ç­–ç•¥è¿›è¡Œå®ç°ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ol>
<li>
<p>å­˜åœ¨è¢«é‡Šæ”¾ã€å¯å¤ç”¨çš„å†…å­˜</p>
</li>
<li>
<p>ä¸å­˜åœ¨å¯å¤ç”¨çš„å†…å­˜</p>
</li>
</ol>
<p>å¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œæ—¶å†…å­˜è¢«é‡Šæ”¾ï¼Œä½†è¿™éƒ¨åˆ†å†…å­˜å¹¶ä¸ä¼šè¢«ç«‹å³å›æ”¶ç»™æ“ä½œç³»ç»Ÿï¼Œ æˆ‘ä»¬ç›´æ¥ä»è‡ªç”±è¡¨ä¸­è·å¾—å³å¯ï¼Œä½†éœ€è¦æ³¨æ„æŒ‰éœ€å°†è¿™éƒ¨åˆ†å†…å­˜è¿›è¡Œæ¸…é›¶æ“ä½œã€‚</p>
<p>å¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å›ºå®šå¤§å°çš„å†…å­˜ï¼Œç„¶åæ‰£é™¤åˆ†é…çš„å¤§å°å³å¯ã€‚
å›æ”¶é˜¶æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">fixalloc</span><span class="p">)</span> <span class="nf">free</span><span class="p">(</span><span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡å°‘ä½¿ç”¨çš„å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f</span><span class="p">.</span><span class="nx">inuse</span> <span class="o">-=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">size</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å°†è¦é‡Šæ”¾çš„å†…å­˜åœ°å€ä½œä¸º mlink æŒ‡é’ˆæ’å…¥åˆ° f.list å†…ï¼Œå®Œæˆå›æ”¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">mlink</span><span class="p">)(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">list</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">list</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>linearAlloc</code> æ˜¯ä¸€ä¸ªåŸºäºçº¿æ€§åˆ†é…ç­–ç•¥çš„åˆ†é…å™¨ï¼Œä½†ç”±äºå®ƒåªä½œä¸º <code>mheap_.heapArenaAlloc</code> å’Œ <code>mheap_.arena</code> åœ¨ 32 ä½ç³»ç»Ÿä¸Šä½¿ç”¨ï¼Œè¿™é‡Œä¸åšè¯¦ç»†åˆ†æã€‚</p>
<p>æ­¤å¤–ï¼Œå¯¹äºæ¯ä¸€ä¸ªPï¼Œéƒ½æœ‰mcacheåšç¼“å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æŒæœ‰ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œä¹Ÿä¸ç”¨ä¸Šé”</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸‹é¢çš„æˆå‘˜åœ¨æ¯æ¬¡ malloc æ—¶éƒ½ä¼šè¢«è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// å› æ­¤å°†å®ƒä»¬æ”¾åˆ°ä¸€èµ·æ¥åˆ©ç”¨ç¼“å­˜çš„å±€éƒ¨æ€§åŸç†
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next_sample</span> <span class="kt">uintptr</span>    <span class="c1">// åˆ†é…è¿™ä¹ˆå¤šå­—èŠ‚åè§¦å‘å †æ ·æœ¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_scan</span>  <span class="kt">uintptr</span> <span class="c1">// åˆ†é…çš„å¯æ‰«æå †çš„å­—èŠ‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ²¡æœ‰æŒ‡é’ˆçš„å¾®å°å¯¹è±¡çš„åˆ†é…å™¨ç¼“å­˜ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¯·å‚è€ƒ malloc.go ä¸­çš„ &#34;å°å‹åˆ†é…å™¨&#34; æ³¨é‡Šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tiny æŒ‡å‘å½“å‰ tiny å—çš„èµ·å§‹ä½ç½®ï¼Œæˆ–å½“æ²¡æœ‰ tiny å—æ—¶å€™ä¸º nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tiny æ˜¯ä¸€ä¸ªå †æŒ‡é’ˆã€‚ç”±äº mcache åœ¨é GC å†…å­˜ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mark termination æœŸé—´åœ¨ releaseAll ä¸­æ¸…é™¤å®ƒæ¥å¤„ç†å®ƒã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tiny</span>             <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tinyoffset</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local_tinyallocs</span> <span class="kt">uintptr</span> <span class="c1">// ä¸è®¡å…¥å…¶ä»–ç»Ÿè®¡çš„æå°åˆ†é…çš„æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¸‹é¢çš„ä¸åœ¨æ¯ä¸ª malloc æ—¶è¢«è®¿é—®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">alloc</span> <span class="p">[</span><span class="nx">numSpanClasses</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span> <span class="c1">// ç”¨æ¥åˆ†é…çš„ spansï¼Œç”± spanClass ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">stackcache</span> <span class="p">[</span><span class="nx">_NumStackOrders</span><span class="p">]</span><span class="nx">stackfreelist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æœ¬åœ°åˆ†é…å™¨ç»Ÿè®¡ï¼Œåœ¨ GC æœŸé—´è¢«åˆ·æ–°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_largefree</span>  <span class="kt">uintptr</span>                  <span class="c1">// bytes freed for large objects (&gt;maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_nlargefree</span> <span class="kt">uintptr</span>                  <span class="c1">// number of frees for large objects (&gt;maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_nsmallfree</span> <span class="p">[</span><span class="nx">_NumSizeClasses</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// number of frees for small objects (&lt;=maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// flushGen indicates the sweepgen during which this mcache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// was last flushed. If flushGen != mheap_.sweepgen, the spans
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in this mcache are stale and need to the flushed so they
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can be swept. This is done in acquirep.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flushGen</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¿è¡Œæ—¶çš„ <code>runtime.allocmcache</code> ä» <code>mheap</code> ä¸Šåˆ†é…ä¸€ä¸ª <code>mcache</code>ã€‚ ç”±äº <code>mheap</code> æ˜¯å…¨å±€çš„ï¼Œå› æ­¤åœ¨åˆ†é…æœŸå¿…é¡»å¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œè€Œåˆ†é…é€šè¿‡ fixAlloc ç»„ä»¶å®Œæˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// è™šæ‹Ÿçš„MSpanï¼Œä¸åŒ…å«ä»»ä½•å¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">emptymspan</span> <span class="nx">mspan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">allocmcache</span><span class="p">()</span> <span class="o">*</span><span class="nx">mcache</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">mcache</span><span class="p">)(</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">cachealloc</span><span class="p">.</span><span class="nf">alloc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">flushGen</span> <span class="p">=</span> <span class="nx">mheap_</span><span class="p">.</span><span class="nx">sweepgen</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span> <span class="c1">// æš‚æ—¶æŒ‡å‘è™šæ‹Ÿçš„ mspan ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è¿”å›ä¸‹ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œæ˜¯æœä»æ³Šæ¾è¿‡ç¨‹çš„éšæœºæ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">next_sample</span> <span class="p">=</span> <span class="nf">nextSample</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“éœ€è¦é‡Šæ”¾æ—¶è°ƒç”¨freemcacheå‡½æ•°</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">freemcache</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½’è¿˜ span
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nf">releaseAll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// é‡Šæ”¾ stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">stackcache_clear</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è®°å½•å±€éƒ¨ç»Ÿè®¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">purgecachedstats</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°† mcache é‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mheap_</span><span class="p">.</span><span class="nx">cachealloc</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span><span class="p">)</span> <span class="nf">releaseAll</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">s</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°† span å½’è¿˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">mheap_</span><span class="p">.</span><span class="nx">central</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mcentral</span><span class="p">.</span><span class="nf">uncacheSpan</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// æ¸…ç©º tinyalloc æ± .
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">tiny</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">tinyoffset</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcache ä¼šè¢« P æŒæœ‰ï¼Œå½“ M å’Œ P ç»‘å®šæ—¶ï¼ŒM åŒæ ·ä¼šä¿ç•™ mcache çš„æŒ‡é’ˆ</li>
<li>mcache ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä¸”å¸¸é©»è¿è¡Œæ—¶</li>
<li>P é€šè¿‡ make å‘½ä»¤è¿›è¡Œåˆ†é…ï¼Œä¼šåˆ†é…åœ¨ Go å †ä¸Š</li>
</ul>
<h3 id="34-escape">3.4. Escape</h3>
<p>Go ç¨‹åºçš„æ‰§è¡Œæ˜¯åŸºäº goroutine çš„ï¼Œgoroutine å’Œä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ç¨‹åºä¸€æ ·ï¼Œä¹Ÿæœ‰æ ˆå’Œå †çš„æ¦‚å¿µã€‚åªä¸è¿‡ Go çš„è¿è¡Œæ—¶å¸®æˆ‘ä»¬å±è”½æ‰äº†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œåªåœ¨è¿è¡Œæ—¶å†…éƒ¨åŒºåˆ†å¹¶åˆ†åˆ«å¯¹åº”ï¼šgoroutine æ‰§è¡Œæ ˆä»¥åŠ Go å †ã€‚</p>
<p>goroutine çš„æ‰§è¡Œæ ˆä¸ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ ˆä¸€æ ·ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œåœ¨æ ˆä¸Šå°±ä¼šè¢«å›æ”¶ï¼Œæ ˆä¸­çš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ï¼Œä»è€Œ æ— éœ€ GC çš„æ ‡è®°ï¼›è€Œå †åˆ™éº»çƒ¦ä¸€äº›ï¼Œç”±äº Go æ”¯æŒåƒåœ¾å›æ”¶ï¼Œåªè¦å¯¹è±¡ç”Ÿå­˜åœ¨å †ä¸Šï¼ŒGo çš„è¿è¡Œæ—¶ GC å°±ä¼šåœ¨ åå°å°†å¯¹åº”çš„å†…å­˜è¿›è¡Œæ ‡è®°ä»è€Œèƒ½å¤Ÿåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™å°†å¯¹åº”çš„å†…å­˜å›æ”¶ï¼Œè¿›è€Œå¢åŠ äº†å¼€é”€ã€‚</p>
<p>ä»¥ä¸‹å®šä¹‰äº†4ç§æƒ…å†µï¼Œä½¿ç”¨ <code>-gcflags &quot;-N -l -m&quot;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">smallobj</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">arr</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">]</span><span class="kt">byte</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">largeobj</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">arr</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">]</span><span class="kt">byte</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f1</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span>  <span class="c1">// ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰é€ƒé€¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f2</span><span class="p">()</span> <span class="o">*</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">y</span> <span class="c1">// å‘ç”Ÿé€ƒé€¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f3</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">large</span> <span class="o">:=</span> <span class="nx">largeobj</span><span class="p">{}</span> <span class="c1">// large æ— æ³•è¢«ä¸€ä¸ªæ‰§è¡Œæ ˆè£…ä¸‹ï¼Œä¹Ÿä¼šé€ƒé€¸
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">large</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f4</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">small</span> <span class="o">:=</span> <span class="nx">smallobj</span><span class="p">{}</span> <span class="c1">// small å¯¹è±¡èƒ½å¤Ÿè¢«ä¸€ä¸ªæ‰§è¡Œæ ˆè£…ä¸‹ï¼Œå˜é‡æ²¡æœ‰è¿”å›åˆ°æ ˆå¤–ï¼Œè¿›è€Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">print</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">small</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="nf">f1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span> <span class="o">:=</span> <span class="nf">f2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f4</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Goè¯­è¨€ä¸­çš„å¼•ç”¨ç±»å‹æœ‰funcï¼ˆå‡½æ•°ç±»å‹ï¼‰ï¼Œinterfaceï¼ˆæ¥å£ç±»å‹ï¼‰ï¼Œsliceï¼ˆåˆ‡ç‰‡ç±»å‹ï¼‰ï¼Œmapï¼ˆå­—å…¸ç±»å‹ï¼‰ï¼Œchannelï¼ˆç®¡é“ç±»å‹ï¼‰ï¼Œ*ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰ã€‚</p>
<p>åœ¨ç¼–è¯‘é˜¶æ®µï¼Œå¯ä»¥ä½¿ç”¨<code>go tool compile</code>å‘½ä»¤ï¼ŒæŸ¥çœ‹ï¼Œå¦‚æœæœ‰runtime.newobjectï¼Œåˆ™è¯´æ˜åœ¨å †ä¸Šï¼Œåä¹‹åˆ™åœ¨æ ˆä¸Šã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">typ</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">// true å†…å­˜æ¸…é›¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">,</span> <span class="nx">needzero</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºå¤§å°ä¸ºé›¶çš„å¯¹è±¡ï¼Œä¾‹å¦‚ç©ºç»“æ„ä½“
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zerobase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">mallocing</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰ g æ‰€åœ¨ M æ‰€ç»‘å®š P çš„ mcache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nf">gomcache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">x</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">noscan</span> <span class="o">:=</span> <span class="nx">typ</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">typ</span><span class="p">.</span><span class="nx">kind</span><span class="o">&amp;</span><span class="nx">kindNoPointers</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">size</span> <span class="o">&lt;=</span> <span class="nx">maxSmallSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">noscan</span> <span class="o">&amp;&amp;</span> <span class="nx">size</span> <span class="p">&lt;</span> <span class="nx">maxTinySize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¾®å¯¹è±¡åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å°å¯¹è±¡åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¤§å¯¹è±¡åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">mallocing</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>å°å¯¹è±¡åˆ†é…</li>
</ol>
<p>å½“å¯¹ä¸€ä¸ªå°å¯¹è±¡ï¼ˆ&lt;32KBï¼‰åˆ†é…å†…å­˜æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡æ‰€éœ€çš„å†…å­˜å¤§å°è°ƒæ•´åˆ°æŸä¸ªèƒ½å¤Ÿå®¹çº³è¯¥å¯¹è±¡çš„å¤§å°ç­‰çº§ï¼ˆsize classï¼‰ï¼Œ å¹¶æŸ¥çœ‹ mcache ä¸­å¯¹åº”ç­‰çº§çš„ mspanï¼Œé€šè¿‡æ‰«æ mspan çš„ <code>freeindex</code> æ¥ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè¿›è¡Œåˆ†é…ã€‚</p>
<p>å½“æ²¡æœ‰å¯åˆ†é…çš„ mspan æ—¶ï¼Œä¼šä» mcentral ä¸­è·å–ä¸€ä¸ªæ‰€éœ€å¤§å°ç©ºé—´çš„æ–°çš„ mspanï¼Œä» mcentral ä¸­åˆ†é…ä¼šå¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œ ä½†ä¸€æ¬¡æ€§è·å–æ•´ä¸ª span çš„è¿‡ç¨‹å‡æ‘Šäº†å¯¹ mcentral åŠ é”çš„æˆæœ¬ã€‚</p>
<p>å¦‚æœ mcentral çš„ mspan ä¹Ÿä¸ºç©ºæ—¶ï¼Œåˆ™å®ƒä¹Ÿä¼šå‘ç”Ÿå¢é•¿ï¼Œä»è€Œä» mheap ä¸­è·å–ä¸€è¿ä¸²çš„é¡µï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„ mspan è¿›è¡Œæä¾›ã€‚ è€Œå¦‚æœ mheap ä»ç„¶ä¸ºç©ºï¼Œæˆ–è€…æ²¡æœ‰è¶³å¤Ÿå¤§çš„å¯¹è±¡æ¥è¿›è¡Œåˆ†é…æ—¶ï¼Œåˆ™ä¼šä»æ“ä½œç³»ç»Ÿä¸­åˆ†é…ä¸€ç»„æ–°çš„é¡µï¼ˆè‡³å°‘ 1MBï¼‰ï¼Œ ä»è€Œå‡æ‘Šä¸æ“ä½œç³»ç»Ÿæ²Ÿé€šçš„æˆæœ¬ã€‚</p>
<ol start="2">
<li>å¾®å¯¹è±¡åˆ†é…</li>
</ol>
<p>å¯¹äºè¿‡å°çš„å¾®å¯¹è±¡ï¼ˆ&lt;16Bï¼‰ï¼Œå®ƒä»¬çš„åˆ†é…è¿‡ç¨‹ä¸å°å¯¹è±¡çš„åˆ†é…è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯ç›´æ¥å­˜å‚¨åœ¨ mcache ä¸Šï¼Œå¹¶ç”±å…¶ä»¥ 16B çš„å—å¤§å°ç›´æ¥è¿›è¡Œç®¡ç†å’Œé‡Šæ”¾ã€‚</p>
<ol start="3">
<li>å¤§å¯¹è±¡åˆ†é…</li>
</ol>
<p>å¤§å¯¹è±¡åˆ†é…éå¸¸ç²—æš´ï¼Œä¸ä¸ mcache å’Œ mcentral æ²Ÿé€šï¼Œç›´æ¥ç»•è¿‡å¹¶é€šè¿‡ mheap è¿›è¡Œåˆ†é…ã€‚</p>
<h2 id="4-garbage-collection">4. Garbage Collection</h2>
<ol>
<li>æ¸…ç†ç»ˆæ­¢é˜¶æ®µï¼›
<ol>
<li><strong>æš‚åœç¨‹åº</strong>ï¼Œæ‰€æœ‰çš„å¤„ç†å™¨åœ¨è¿™æ—¶ä¼šè¿›å…¥å®‰å…¨ç‚¹ï¼ˆSafe pointï¼‰ï¼›</li>
<li>å¦‚æœå½“å‰åƒåœ¾æ”¶é›†å¾ªç¯æ˜¯å¼ºåˆ¶è§¦å‘çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†è¿˜æœªè¢«æ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒï¼›</li>
</ol>
</li>
<li>æ ‡è®°é˜¶æ®µï¼›
<ol>
<li>å°†çŠ¶æ€åˆ‡æ¢è‡³ <code>_GCmark</code>ã€å¼€å¯å†™å±éšœã€ç”¨æˆ·ç¨‹åºååŠ©ï¼ˆMutator Assistsï¼‰å¹¶å°†æ ¹å¯¹è±¡å…¥é˜Ÿï¼›</li>
<li>æ¢å¤æ‰§è¡Œç¨‹åºï¼Œæ ‡è®°è¿›ç¨‹å’Œç”¨äºååŠ©çš„ç”¨æˆ·ç¨‹åºä¼šå¼€å§‹å¹¶å‘æ ‡è®°å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œå†™å±éšœä¼šå°†è¢«è¦†ç›–çš„æŒ‡é’ˆå’Œæ–°æŒ‡é’ˆéƒ½æ ‡è®°æˆç°è‰²ï¼Œè€Œæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šè¢«ç›´æ¥æ ‡è®°æˆé»‘è‰²ï¼›</li>
<li>å¼€å§‹æ‰«ææ ¹å¯¹è±¡ï¼ŒåŒ…æ‹¬æ‰€æœ‰ Goroutine çš„æ ˆã€å…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œæ‰«æ Goroutine æ ˆæœŸé—´ä¼šæš‚åœå½“å‰å¤„ç†å™¨ï¼›</li>
<li>ä¾æ¬¡å¤„ç†ç°è‰²é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œå°†å¯¹è±¡æ ‡è®°æˆé»‘è‰²å¹¶å°†å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡æ ‡è®°æˆç°è‰²ï¼›</li>
<li>ä½¿ç”¨åˆ†å¸ƒå¼çš„ç»ˆæ­¢ç®—æ³•æ£€æŸ¥å‰©ä½™çš„å·¥ä½œï¼Œå‘ç°æ ‡è®°é˜¶æ®µå®Œæˆåè¿›å…¥æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼›</li>
</ol>
</li>
<li>æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼›
<ol>
<li><strong>æš‚åœç¨‹åº</strong>ã€å°†çŠ¶æ€åˆ‡æ¢è‡³ <code>_GCmarktermination</code> ï¼Œç¡®è®¤æ ‡è®°å·¥ä½œå·²ç»å®Œæˆï¼Œå¹¶å…³é—­è¾…åŠ©æ ‡è®°çš„ç”¨æˆ·ç¨‹åºï¼›</li>
<li>æ¸…ç†å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹ç¼“å­˜ï¼›</li>
</ol>
</li>
<li>æ¸…ç†é˜¶æ®µï¼›
<ol>
<li>å°†çŠ¶æ€åˆ‡æ¢è‡³ <code>_GCoff</code> å¼€å§‹æ¸…ç†é˜¶æ®µï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæ–°å»ºçš„å¯¹è±¡æ˜¯é»‘è‰²ï¼Œåˆ‡æ¢åçš„å¯¹è±¡æ˜¯ç™½è‰²ï¼Œåˆå§‹åŒ–æ¸…ç†çŠ¶æ€å¹¶å…³é—­å†™å±éšœï¼›</li>
<li>åå°å¹¶å‘æ¸…ç†æ‰€æœ‰çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå½“ Goroutine ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒæ—¶å°±ä¼šè§¦å‘æ¸…ç†ï¼›</li>
</ol>
</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/go/">Go</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span><a class="link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ml"  target="_blank" rel="noopener"
    >Licensed under CC BY-NC-SA 4.0</a></span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/go6-network/">
        
        
            <div class="article-image">
                <img src="/post/go6-network/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(6) Network"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(6) Network</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go5-concurrency/">
        
        
            <div class="article-image">
                <img src="/post/go5-concurrency/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(5) Concurrency"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(5) Concurrency</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go3-common-keywords/">
        
        
            <div class="article-image">
                <img src="/post/go3-common-keywords/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(3) Common Keywords"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(3) Common Keywords</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go2-language-basic/">
        
        
            <div class="article-image">
                <img src="/post/go2-language-basic/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(2) Language Basic"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(2) Language Basic</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go1-builtin-data-structure/">
        
        
            <div class="article-image">
                <img src="/post/go1-builtin-data-structure/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(1) Builtin Data Structure"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(1) Builtin Data Structure</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="Chasing1020/Chasing1020.github.io"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2019 - 
        
        2023 Chasing&#39;s blog
    </section>
    
    <section class="powerby">
        
            I just want a peaceful life without troubles <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CDYPFNXQDZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CDYPFNXQDZ');
</script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


    </body>
</html>
