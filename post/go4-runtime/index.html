<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure ÂàõÂª∫„ÄÅÈîÄÊØÅ„ÄÅË∞ÉÂ∫¶ G ÈÉΩÈúÄË¶ÅÊØè‰∏™ M Ëé∑ÂèñÈîÅÔºåËøôÂ∞±ÂΩ¢Êàê‰∫ÜÊøÄÁÉàÁöÑÈîÅÁ´û‰∫â„ÄÇ M ËΩ¨Áßª G ‰ºöÈÄ†ÊàêÂª∂ËøüÂíåÈ¢ùÂ§ñÁöÑÁ≥ªÁªüË¥üËΩΩ„ÄÇÊØîÂ¶ÇÂΩì G ‰∏≠ÂåÖÂê´ÂàõÂª∫Êñ∞ÂçèÁ®ã'>
<meta name="keywords" content="Runtime"><title>Go(4) Runtime</title>

<link rel='canonical' href='https://chasing1020.github.io/post/go4-runtime/'>

<link rel="stylesheet" href="/scss/style.min.137532ecdb47b4e19cc5bd7eb181a2fac19327074071417b23a61ca467af44c5.css"><meta property='og:title' content='Go(4) Runtime'>
<meta property='og:description' content='Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure ÂàõÂª∫„ÄÅÈîÄÊØÅ„ÄÅË∞ÉÂ∫¶ G ÈÉΩÈúÄË¶ÅÊØè‰∏™ M Ëé∑ÂèñÈîÅÔºåËøôÂ∞±ÂΩ¢Êàê‰∫ÜÊøÄÁÉàÁöÑÈîÅÁ´û‰∫â„ÄÇ M ËΩ¨Áßª G ‰ºöÈÄ†ÊàêÂª∂ËøüÂíåÈ¢ùÂ§ñÁöÑÁ≥ªÁªüË¥üËΩΩ„ÄÇÊØîÂ¶ÇÂΩì G ‰∏≠ÂåÖÂê´ÂàõÂª∫Êñ∞ÂçèÁ®ã'>
<meta property='og:url' content='https://chasing1020.github.io/post/go4-runtime/'>
<meta property='og:site_name' content='Chasing&#39;s blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='Go' /><meta property='article:published_time' content='2021-09-28T19:31:04&#43;08:00'/><meta property='article:modified_time' content='2021-09-28T19:31:04&#43;08:00'/><meta property='og:image' content='https://chasing1020.github.io/post/go4-runtime/go-model-sheet.webp' />
<meta name="twitter:site" content="@Chasing1020">
    <meta name="twitter:creator" content="@Chasing1020"><meta name="twitter:title" content="Go(4) Runtime">
<meta name="twitter:description" content="Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure ÂàõÂª∫„ÄÅÈîÄÊØÅ„ÄÅË∞ÉÂ∫¶ G ÈÉΩÈúÄË¶ÅÊØè‰∏™ M Ëé∑ÂèñÈîÅÔºåËøôÂ∞±ÂΩ¢Êàê‰∫ÜÊøÄÁÉàÁöÑÈîÅÁ´û‰∫â„ÄÇ M ËΩ¨Áßª G ‰ºöÈÄ†ÊàêÂª∂ËøüÂíåÈ¢ùÂ§ñÁöÑÁ≥ªÁªüË¥üËΩΩ„ÄÇÊØîÂ¶ÇÂΩì G ‰∏≠ÂåÖÂê´ÂàõÂª∫Êñ∞ÂçèÁ®ã"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://chasing1020.github.io/post/go4-runtime/go-model-sheet.webp' />
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu95eb581bc5d2486d92921983fc6c7583_36979_300x0_resize_q75_box.jpg" width="300"
                            height="299" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üñ•Ô∏è</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Chasing&#39;s blog</a></h1>
            <h2 class="site-description">Why there is a universe?</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/Chasing1020'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/Chasing1020'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/Chasing1020'
                        target="_blank"
                        title="Telegram"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-telegram" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='mailto:chasing1020@gmail.com'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-mail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <rect x="3" y="5" width="18" height="14" rx="2" />
  <polyline points="3 7 12 13 21 7" />
</svg>

                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='/index.xml'
                        target="_blank"
                        title="RSS"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="5" cy="19" r="1" />
  <path d="M4 4a16 16 0 0 1 16 16" />
  <path d="M4 11a9 9 0 0 1 9 9" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Friends</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
      
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#part4-runtime">Part4. Runtime</a>
      <ul>
        <li><a href="#1-gmp">1. GMP</a>
          <ul>
            <li><a href="#11-implement">1.1. Implement</a></li>
            <li><a href="#12-create-goroutine">1.2. Create Goroutine</a></li>
            <li><a href="#13-schedule">1.3. Schedule</a></li>
            <li><a href="#14-trigger-scheduling">1.4. Trigger Scheduling</a></li>
            <li><a href="#15-thread-control">1.5. Thread Control</a></li>
          </ul>
        </li>
        <li><a href="#2-system-monitor">2. System Monitor</a></li>
        <li><a href="#3-stack-and-heap">3. Stack And Heap</a>
          <ul>
            <li><a href="#31-traditional-language">3.1. Traditional Language</a></li>
            <li><a href="#32-implement">3.2. Implement</a></li>
            <li><a href="#33-allocation">3.3. Allocation</a></li>
            <li><a href="#34-escape">3.4. Escape</a></li>
          </ul>
        </li>
        <li><a href="#4-garbage-collection">4. Garbage Collection</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/post/go4-runtime/">
                <img src="/post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_800x0_resize_q75_h2_box_2.webp"
                        srcset="/post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_800x0_resize_q75_h2_box_2.webp 800w, /post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_1600x0_resize_q75_h2_box_2.webp 1600w"
                        width="800" 
                        height="449" 
                        loading="lazy"
                        alt="Featured image of post Go(4) Runtime" />
                
            </a>
        </div>
    

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/go4-runtime/">Go(4) Runtime</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Sep 28, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    36 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="part4-runtime">Part4. Runtime</h1>
<h2 id="1-gmp">1. GMP</h2>
<h3 id="11-implement">1.1. Implement</h3>
<h4 id="111-data-structure">1.1.1. Data Structure</h4>
<p>ÂàõÂª∫„ÄÅÈîÄÊØÅ„ÄÅË∞ÉÂ∫¶ G ÈÉΩÈúÄË¶ÅÊØè‰∏™ M Ëé∑ÂèñÈîÅÔºåËøôÂ∞±ÂΩ¢Êàê‰∫ÜÊøÄÁÉàÁöÑÈîÅÁ´û‰∫â„ÄÇ
M ËΩ¨Áßª G ‰ºöÈÄ†ÊàêÂª∂ËøüÂíåÈ¢ùÂ§ñÁöÑÁ≥ªÁªüË¥üËΩΩ„ÄÇÊØîÂ¶ÇÂΩì G ‰∏≠ÂåÖÂê´ÂàõÂª∫Êñ∞ÂçèÁ®ãÁöÑÊó∂ÂÄôÔºåM ÂàõÂª∫‰∫Ü G‚ÄôÔºå‰∏∫‰∫ÜÁªßÁª≠ÊâßË°å GÔºåÈúÄË¶ÅÊää G‚Äô‰∫§Áªô M‚ÄôÊâßË°åÔºå‰πüÈÄ†Êàê‰∫ÜÂæàÂ∑ÆÁöÑÂ±ÄÈÉ®ÊÄßÔºåÂõ†‰∏∫ G‚ÄôÂíå G ÊòØÁõ∏ÂÖ≥ÁöÑÔºåÊúÄÂ•ΩÊîæÂú® M ‰∏äÊâßË°åÔºåËÄå‰∏çÊòØÂÖ∂‰ªñ M‚Äô„ÄÇ
Á≥ªÁªüË∞ÉÁî® (CPU Âú® M ‰πãÈó¥ÁöÑÂàáÊç¢) ÂØºËá¥È¢ëÁπÅÁöÑÁ∫øÁ®ãÈòªÂ°ûÂíåÂèñÊ∂àÈòªÂ°ûÊìç‰ΩúÂ¢ûÂä†‰∫ÜÁ≥ªÁªüÂºÄÈîÄ„ÄÇ</p>
<p>ÂÖ®Â±ÄÈòüÂàóÔºàGlobal QueueÔºâÔºöÂ≠òÊîæÁ≠âÂæÖËøêË°åÁöÑ G„ÄÇ
P ÁöÑÊú¨Âú∞ÈòüÂàóÔºö‰∏çË∂ÖËøá 256 ‰∏™„ÄÇÊñ∞Âª∫ G‚ÄôÊó∂ÔºåG‚Äô‰ºòÂÖàÂä†ÂÖ•Âà∞ P ÁöÑÊú¨Âú∞ÈòüÂàóÔºåÂ¶ÇÊûúÈòüÂàóÊª°‰∫ÜÔºåÂàô‰ºöÊääÊú¨Âú∞ÈòüÂàó‰∏≠‰∏ÄÂçäÁöÑ G ÁßªÂä®Âà∞ÂÖ®Â±ÄÈòüÂàó„ÄÇ
P ÂàóË°®ÔºöÊâÄÊúâÁöÑ P ÈÉΩÂú®Á®ãÂ∫èÂêØÂä®Êó∂ÂàõÂª∫ÔºåÂπ∂‰øùÂ≠òÂú®Êï∞ÁªÑ‰∏≠ÔºåÊúÄÂ§öÊúâ GOMAXPROCS(ÂèØÈÖçÁΩÆ) ‰∏™„ÄÇ
MÔºöÁ∫øÁ®ãÊÉ≥ËøêË°å‰ªªÂä°Â∞±ÂæóËé∑Âèñ PÔºå‰ªé P ÁöÑÊú¨Âú∞ÈòüÂàóËé∑Âèñ GÔºåP ÈòüÂàó‰∏∫Á©∫Êó∂ÔºåM ‰πü‰ºöÂ∞ùËØï‰ªéÂÖ®Â±ÄÈòüÂàóÊãø‰∏ÄÊâπ G ÊîæÂà∞ P ÁöÑÊú¨Âú∞ÈòüÂàóÔºåÊàñ‰ªéÂÖ∂‰ªñ P ÁöÑÊú¨Âú∞ÈòüÂàóÂÅ∑‰∏ÄÂçäÊîæÂà∞Ëá™Â∑± P ÁöÑÊú¨Âú∞ÈòüÂàó„ÄÇM ËøêË°å GÔºåG ÊâßË°å‰πãÂêéÔºåM ‰ºö‰ªé P Ëé∑Âèñ‰∏ã‰∏Ä‰∏™ GÔºå‰∏çÊñ≠ÈáçÂ§ç‰∏ãÂéª„ÄÇ</p>
<h5 id="1111-g">1.1.1.1. G</h5>
<p>GÔºö‰Ωú‰∏∫ÊúÄÂ∞èÁöÑËøêË°åÁöÑË∞ÉÂ∫¶ÂçïÂÖÉ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Stack describes a Go execution stack.
</span></span></span><span class="line"><span class="cl"><span class="c1">// The bounds of the stack are exactly [lo, hi),
</span></span></span><span class="line"><span class="cl"><span class="c1">// with no implicit data structures on either side.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">stack</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lo</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">hi</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">g</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Stack parameters.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack describes the actual stack memory: [stack.lo, stack.hi).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackguard0 is the stack pointer compared in the Go stack growth prologue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stackguard1 is the stack pointer compared in the C stack growth prologue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is stack.lo+StackGuard on g0 and gsignal stacks.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stack</span>       <span class="nx">stack</span>   <span class="c1">// offset known to runtime/cgo
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackguard0</span> <span class="kt">uintptr</span> <span class="c1">// offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackguard1</span> <span class="kt">uintptr</span> <span class="c1">// offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_panic</span>       <span class="o">*</span><span class="nx">_panic</span> <span class="c1">// innermost panic - offset known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_defer</span>       <span class="o">*</span><span class="nx">_defer</span> <span class="c1">// innermost defer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span>            <span class="o">*</span><span class="nx">m</span>      <span class="c1">// current m; offset known to arm liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sched</span>        <span class="nx">gobuf</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscallsp</span>    <span class="kt">uintptr</span>        <span class="c1">// if status==Gsyscall, syscallsp = sched.sp to use during gc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">syscallpc</span>    <span class="kt">uintptr</span>        <span class="c1">// if status==Gsyscall, syscallpc = sched.pc to use during gc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stktopsp</span>     <span class="kt">uintptr</span>        <span class="c1">// expected sp at top of stack, to check in traceback
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">param</span>        <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// passed parameter on wakeup
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">atomicstatus</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stackLock</span>    <span class="kt">uint32</span> <span class="c1">// sigprof/scang lock; TODO: fold in to atomicstatus
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goid</span>         <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schedlink</span>    <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waitsince</span>    <span class="kt">int64</span>      <span class="c1">// approx time when the g become blocked
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitreason</span>   <span class="nx">waitReason</span> <span class="c1">// if status==Gwaiting
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">preempt</span>       <span class="kt">bool</span> <span class="c1">// preemption signal, duplicates stackguard0 = stackpreempt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptStop</span>   <span class="kt">bool</span> <span class="c1">// transition to _Gpreempted on preemption; otherwise, just deschedule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptShrink</span> <span class="kt">bool</span> <span class="c1">// shrink stack at synchronous safe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// asyncSafePoint is set if g is stopped at an asynchronous
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// safe point. This means there are frames on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// without precise pointer information.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">asyncSafePoint</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">paniconfault</span> <span class="kt">bool</span> <span class="c1">// panic (instead of crash) on unexpected fault address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcscandone</span>   <span class="kt">bool</span> <span class="c1">// g has scanned stack; protected by _Gscan bit in status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">throwsplit</span>   <span class="kt">bool</span> <span class="c1">// must not split stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// activeStackChans indicates that there are unlocked channels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// pointing into this goroutine&#39;s stack. If true, stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// copying needs to acquire channel locks to protect these
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// areas of the stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">activeStackChans</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// parkingOnChan indicates that the goroutine is about to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// park on a chansend or chanrecv. Used to signal an unsafe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// for stack shrinking. It&#39;s a boolean value, but is updated atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">parkingOnChan</span> <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">raceignore</span>     <span class="kt">int8</span>     <span class="c1">// ignore race detection events
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysblocktraced</span> <span class="kt">bool</span>     <span class="c1">// StartTrace has emitted EvGoInSyscall about this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysexitticks</span>   <span class="kt">int64</span>    <span class="c1">// cputicks when syscall has returned (for tracing)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceseq</span>       <span class="kt">uint64</span>   <span class="c1">// trace event sequencer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tracelastp</span>     <span class="nx">puintptr</span> <span class="c1">// last P emitted an event for this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedm</span>        <span class="nx">muintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sig</span>            <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">writebuf</span>       <span class="p">[]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigcode0</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigcode1</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sigpc</span>          <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gopc</span>           <span class="kt">uintptr</span>         <span class="c1">// pc of go statement that created this goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ancestors</span>      <span class="o">*</span><span class="p">[]</span><span class="nx">ancestorInfo</span> <span class="c1">// ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">startpc</span>        <span class="kt">uintptr</span>         <span class="c1">// pc of goroutine function
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">racectx</span>        <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waiting</span>        <span class="o">*</span><span class="nx">sudog</span>         <span class="c1">// sudog structures this g is waiting on (that have a valid elem ptr); in lock order
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCtxt</span>        <span class="p">[]</span><span class="kt">uintptr</span>      <span class="c1">// cgo traceback context
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">labels</span>         <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// profiler labels
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timer</span>          <span class="o">*</span><span class="nx">timer</span>         <span class="c1">// cached timer for time.Sleep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">selectDone</span>     <span class="kt">uint32</span>         <span class="c1">// are we participating in a select and did someone win the race?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Per-G GC state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcAssistBytes is this G&#39;s GC assist credit in terms of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// bytes allocated. If this is positive, then the G has credit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// to allocate gcAssistBytes bytes without assisting. If this
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is negative, then the G must correct this by performing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scan work. We track this in bytes to make it fast to update
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and check for debt in the malloc hot path. The assist ratio
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// determines how this corresponds to scan work debt.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcAssistBytes</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•ÁúãÂà∞ÔºågÁöÑ<code>stack</code>‰øùÂ≠ò‰∫ÜÂΩìÂâçÁöÑÊ†àËåÉÂõ¥ÔºåÂàÜÂà´Â≠òÂÇ® <code>defer</code> Âíå <code>panic</code> ÂØπÂ∫îÁªìÊûÑ‰ΩìÁöÑÈìæË°®Ôºå
<code>m</code> ‚Äî ÂΩìÂâç Goroutine Âç†Áî®ÁöÑÁ∫øÁ®ãÔºåÂèØËÉΩ‰∏∫Á©∫Ôºõ <code>atomicstatus</code> ‚Äî Goroutine ÁöÑÁä∂ÊÄÅÔºõ
<code>sched</code> ‚Äî Â≠òÂÇ® Goroutine ÁöÑË∞ÉÂ∫¶Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÔºõ <code>goid</code> ‚Äî Goroutine ÁöÑ IDÔºåËØ•Â≠óÊÆµÂØπÂºÄÂèëËÄÖ‰∏çÂèØËßÅÔºåGo Âõ¢ÈòüËÆ§‰∏∫ÂºïÂÖ• ID ‰ºöËÆ©ÈÉ®ÂàÜ Goroutine ÂèòÂæóÊõ¥ÁâπÊÆäÔºå‰ªéËÄåÈôêÂà∂ËØ≠Ë®ÄÁöÑÂπ∂ÂèëËÉΩÂäõ„ÄÇ</p>
<p>ÂÖ∂‰∏≠gËøòÂÜÖÂµå‰∫Ü‰∏Ä‰∏™ÁªìÊûÑ‰ΩìgobufÔºåÁî®‰∫éË∞ÉÂ∫¶Âô®‰øùÂ≠ò‰ª•ÂèäÊÅ¢Â§ç‰∏ä‰∏ãÊñá‰∏≠Áî®Âà∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">gobuf</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The offsets of sp, pc, and g are known to (hard-coded in) libmach.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ctxt is unusual with respect to GC: it may be a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// heap-allocated funcval, so GC needs to track it, but it
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// needs to be set and cleared from assembly, where it&#39;s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// difficult to have write barriers. However, ctxt is really a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// saved, live register, and we only ever exchange it between
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the real register and the gobuf. Hence, we treat it as a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// root during stack scanning, which means assembly that saves
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// and restores it doesn&#39;t need write barriers. It&#39;s still
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// typed as a pointer so that any other writes from Go get
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sp</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g</span>    <span class="nx">guintptr</span>  <span class="c1">// ÊåÅÊúâËØ•gobufÁöÑgoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ctxt</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span>  <span class="kt">uintptr</span>   <span class="c1">// Á≥ªÁªüË∞ÉÁî®ÁöÑËøîÂõûÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lr</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bp</span>   <span class="kt">uintptr</span> <span class="c1">// for framepointer-enabled architectures
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≠§Â§ñatomicstatusËøòËÆ∞ÂΩï‰∫ÜgoroutineÂΩìÂâçÁöÑÁä∂ÊÄÅ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// G status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Beyond indicating the general state of a G, the G status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// acts like a lock on the goroutine&#39;s stack (and hence its
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ability to execute user code).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gidle means this goroutine was just allocated and has not yet been initialized.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gidle</span> <span class="p">=</span> <span class="kc">iota</span> <span class="c1">// 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunnable means this goroutine is on a run queue. It isnot currently executing user code. The stack is not owned.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Grunnable</span> <span class="c1">// 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunning means this goroutine may execute user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M and a P (g.m and g.m.p are valid).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Grunning</span> <span class="c1">// 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gsyscall means this goroutine is executing a system call. It is not executing user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gsyscall</span> <span class="c1">// 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gwaiting means this goroutine is blocked in the runtime.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// It is not executing user code. It is not on a run queue,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// but should be recorded somewhere (e.g., a channel wait
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// queue) so it can be ready()d when necessary. The stack is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// not owned *except* that a channel operation may read or
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// write parts of the stack under the appropriate channel
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// lock. Otherwise, it is not safe to access the stack after a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine enters _Gwaiting (e.g., it may get moved).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gwaiting</span> <span class="c1">// 4
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gmoribund_unused is currently unused, but hardcoded in gdb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scripts.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gmoribund_unused</span> <span class="c1">// 5
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gdead means this goroutine is currently unused. It may be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// just exited, on a free list, or just being initialized. It
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is not executing user code. It may or may not have a stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// allocated. The G and its stack (if any) are owned by the M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that is exiting the G or that obtained the G from the free
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// list.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gdead</span> <span class="c1">// 6
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Genqueue_unused is currently unused.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Genqueue_unused</span> <span class="c1">// 7
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gcopystack means this goroutine&#39;s stack is being moved. It
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// is not executing user code and is not on a run queue. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack is owned by the goroutine that put it in _Gcopystack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gcopystack</span> <span class="c1">// 8
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gpreempted means this goroutine stopped itself for a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// suspendG preemption. It is like _Gwaiting, but nothing is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// yet responsible for ready()ing it. Some suspendG must CAS
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the status to _Gwaiting to take responsibility for
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ready()ing this G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gpreempted</span> <span class="c1">// 9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// _Gscan combined with one of the above states other than
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Grunning indicates that GC is scanning the stack. The
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutine is not executing user code and the stack is owned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by the goroutine that set the _Gscan bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// _Gscanrunning is different: it is used to briefly block
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// state transitions while GC signals the G to scan its own
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// stack. This is otherwise like _Grunning.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// atomicstatus&amp;~Gscan gives the state the goroutine will
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// return to when the scan completes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscan</span>          <span class="p">=</span> <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_Gscanrunnable</span>  <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Grunnable</span>  <span class="c1">// 0x1001
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanrunning</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Grunning</span>   <span class="c1">// 0x1002
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscansyscall</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gsyscall</span>   <span class="c1">// 0x1003
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanwaiting</span>   <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gwaiting</span>   <span class="c1">// 0x1004
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_Gscanpreempted</span> <span class="p">=</span> <span class="nx">_Gscan</span> <span class="o">+</span> <span class="nx">_Gpreempted</span> <span class="c1">// 0x1009
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏ªË¶ÅÁä∂ÊÄÅÂ¶Ç‰∏ãÔºö</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>Áä∂ÊÄÅ</th>
<th>ÊèèËø∞</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_Gidle</code></td>
<td>ÂàöÂàöË¢´ÂàÜÈÖçÂπ∂‰∏îËøòÊ≤°ÊúâË¢´ÂàùÂßãÂåñÔºåÂàùÂßãÂåñÁªìÊùüÂêéÂèò‰∏∫_Gdead</td>
</tr>
<tr>
<td><code>_Grunnable</code></td>
<td>Ê≤°ÊúâÊâßË°å‰ª£Á†ÅÔºåÊ≤°ÊúâÊ†àÁöÑÊâÄÊúâÊùÉÔºåÂ≠òÂÇ®Âú®ËøêË°åÈòüÂàó‰∏≠</td>
</tr>
<tr>
<td><code>_Grunning</code></td>
<td>ÂèØ‰ª•ÊâßË°å‰ª£Á†ÅÔºåÊã•ÊúâÊ†àÁöÑÊâÄÊúâÊùÉÔºåË¢´Ëµã‰∫à‰∫ÜÂÜÖÊ†∏Á∫øÁ®ã M ÂíåÂ§ÑÁêÜÂô® P</td>
</tr>
<tr>
<td><code>_Gsyscall</code></td>
<td>Ê≠£Âú®ÊâßË°åÁ≥ªÁªüË∞ÉÁî®ÔºåÊã•ÊúâÊ†àÁöÑÊâÄÊúâÊùÉÔºåÊ≤°ÊúâÊâßË°åÁî®Êà∑‰ª£Á†ÅÔºåË¢´Ëµã‰∫à‰∫ÜÂÜÖÊ†∏Á∫øÁ®ã M ‰ΩÜÊòØ‰∏çÂú®ËøêË°åÈòüÂàó‰∏ä</td>
</tr>
<tr>
<td><code>_Gwaiting</code></td>
<td>Áî±‰∫éËøêË°åÊó∂ËÄåË¢´ÈòªÂ°ûÔºåÊ≤°ÊúâÊâßË°åÁî®Êà∑‰ª£Á†ÅÂπ∂‰∏î‰∏çÂú®ËøêË°åÈòüÂàó‰∏äÔºå‰ΩÜÊòØÂèØËÉΩÂ≠òÂú®‰∫é Channel ÁöÑÁ≠âÂæÖÈòüÂàó‰∏ä</td>
</tr>
<tr>
<td><code>_Gdead</code></td>
<td>ÂèØ‰ª•ÊòØË¢´ÈîÄÊØÅÁöÑÔºå‰πüÂèØ‰ª•ÊòØÂàöÂàõÂª∫ÁöÑ„ÄÇÊ≤°ÊúâË¢´‰ΩøÁî®ÔºåÊ≤°ÊúâÊâßË°å‰ª£Á†ÅÔºåÂèØËÉΩÊúâÂàÜÈÖçÁöÑÊ†à</td>
</tr>
<tr>
<td><code>_Gcopystack</code></td>
<td>Ê†àÊ≠£Âú®Ë¢´Êã∑Ë¥ùÔºåÊ≤°ÊúâÊâßË°å‰ª£Á†ÅÔºå‰∏çÂú®ËøêË°åÈòüÂàó‰∏ä</td>
</tr>
<tr>
<td><code>_Gpreempted</code></td>
<td>Áî±‰∫éÊä¢Âç†ËÄåË¢´ÈòªÂ°ûÔºåÊ≤°ÊúâÊâßË°åÁî®Êà∑‰ª£Á†ÅÂπ∂‰∏î‰∏çÂú®ËøêË°åÈòüÂàó‰∏äÔºåÁ≠âÂæÖÂî§ÈÜí</td>
</tr>
<tr>
<td><code>_Gscan</code></td>
<td>GC Ê≠£Âú®Êâ´ÊèèÊ†àÁ©∫Èó¥ÔºåÊ≤°ÊúâÊâßË°å‰ª£Á†ÅÔºåÂèØ‰ª•‰∏éÂÖ∂‰ªñÁä∂ÊÄÅÂêåÊó∂Â≠òÂú®</td>
</tr>
</tbody>
</table></div>
<p>ÂÖ∂‰∏≠g0‰Ωú‰∏∫ÁâπÊÆäÁöÑË∞ÉÂ∫¶ÂçèÁ®ãÔºöÊâßË°åÂáΩÊï∞ÁöÑÊµÅÁ®ãÁõ∏ÂØπÂõ∫ÂÆöÔºåÂàá‰∏∫‰∫ÜÈÅøÂÖçÊ†àÊ∫¢Âá∫Ôºåg0ÁöÑÊ†à‰ºöÂ§çÁî®</p>
<h5 id="1112-m">1.1.1.2. M</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">m</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g0</span>      <span class="o">*</span><span class="nx">g</span>     <span class="c1">// goroutine with scheduling stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">morebuf</span> <span class="nx">gobuf</span>  <span class="c1">// gobuf arg to morestack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">divmod</span>  <span class="kt">uint32</span> <span class="c1">// div/mod denominator for arm - known to liblink
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Fields not known to debuggers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">procid</span>        <span class="kt">uint64</span>            <span class="c1">// for debuggers, but offset not hard-coded
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gsignal</span>       <span class="o">*</span><span class="nx">g</span>                <span class="c1">// signal-handling g
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goSigStack</span>    <span class="nx">gsignalStack</span>      <span class="c1">// Go-allocated signal handling stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sigmask</span>       <span class="nx">sigset</span>            <span class="c1">// storage for saved signal mask
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tls</span>           <span class="p">[</span><span class="nx">tlsSlots</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// thread-local storage (for x86 extern register)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mstartfn</span>      <span class="kd">func</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">curg</span>          <span class="o">*</span><span class="nx">g</span>       <span class="c1">// current running goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">caughtsig</span>     <span class="nx">guintptr</span> <span class="c1">// goroutine running during fatal signal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">p</span>             <span class="nx">puintptr</span> <span class="c1">// attached p for executing go code (nil if not executing go code)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nextp</span>         <span class="nx">puintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">oldp</span>          <span class="nx">puintptr</span> <span class="c1">// the p that was attached before executing a syscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">id</span>            <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mallocing</span>     <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">throwing</span>      <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">preemptoff</span>    <span class="kt">string</span> <span class="c1">// if != &#34;&#34;, keep curg running on this m
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">locks</span>         <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dying</span>         <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">profilehz</span>     <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spinning</span>      <span class="kt">bool</span> <span class="c1">// m is out of work and is actively looking for work
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">blocked</span>       <span class="kt">bool</span> <span class="c1">// m is blocked on a note
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">newSigstack</span>   <span class="kt">bool</span> <span class="c1">// minit on C thread called sigaltstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">printlock</span>     <span class="kt">int8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">incgo</span>         <span class="kt">bool</span>   <span class="c1">// m is executing a cgo call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">freeWait</span>      <span class="kt">uint32</span> <span class="c1">// if == 0, safe to free g0 and delete m (atomic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fastrand</span>      <span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">needextram</span>    <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">traceback</span>     <span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ncgocall</span>      <span class="kt">uint64</span>      <span class="c1">// number of cgo calls in total
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">ncgo</span>          <span class="kt">int32</span>       <span class="c1">// number of cgo calls currently in progress
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCallersUse</span> <span class="kt">uint32</span>      <span class="c1">// if non-zero, cgoCallers in use temporarily
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">cgoCallers</span>    <span class="o">*</span><span class="nx">cgoCallers</span> <span class="c1">// cgo traceback if crashing in cgo call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">doesPark</span>      <span class="kt">bool</span>        <span class="c1">// non-P running threads: sysmon and newmHandoff never use .park
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">park</span>          <span class="nx">note</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alllink</span>       <span class="o">*</span><span class="nx">m</span> <span class="c1">// on allm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">schedlink</span>     <span class="nx">muintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lockedg</span>       <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">createstack</span>   <span class="p">[</span><span class="mi">32</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// stack that created this thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedExt</span>     <span class="kt">uint32</span>      <span class="c1">// tracking for external LockOSThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">lockedInt</span>     <span class="kt">uint32</span>      <span class="c1">// tracking for internal lockOSThread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nextwaitm</span>     <span class="nx">muintptr</span>    <span class="c1">// next m waiting for lock
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">waitunlockf</span>   <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waitlock</span>      <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waittraceev</span>   <span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">waittraceskip</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">startingtrace</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscalltick</span>   <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">freelink</span>      <span class="o">*</span><span class="nx">m</span> <span class="c1">// on sched.freem
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// mFixup is used to synchronize OS related m state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// (credentials etc) use mutex to access. To avoid deadlocks
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// an atomic.Load() of used being zero in mDoFixupFn()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// guarantees fn is nil.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mFixup</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">lock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">        <span class="nx">used</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">        <span class="nx">fn</span>   <span class="kd">func</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// these are here because they are too large to be on the stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// of low-level NOSPLIT functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">libcall</span>   <span class="nx">libcall</span>
</span></span><span class="line"><span class="cl">    <span class="nx">libcallpc</span> <span class="kt">uintptr</span> <span class="c1">// for cpu profiler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">libcallsp</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">libcallg</span>  <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">syscall</span>   <span class="nx">libcall</span> <span class="c1">// stores syscall parameters on windows
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">vdsoSP</span> <span class="kt">uintptr</span> <span class="c1">// SP for traceback while in VDSO call (0 if not in call)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">vdsoPC</span> <span class="kt">uintptr</span> <span class="c1">// PC for traceback while in VDSO call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// preemptGen counts the number of completed preemption
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// signals. This is used to detect when a preemption is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// requested, but fails. Accessed atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preemptGen</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Whether this is a pending preemption signal on this M.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Accessed atomically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">signalPending</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">dlogPerM</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">mOS</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Up to 10 locks held by this m, maintained by the lock ranking code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">locksHeldLen</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">    <span class="nx">locksHeld</span>    <span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="nx">heldLockInfo</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠ g0 ÊòØÊåÅÊúâË∞ÉÂ∫¶Ê†àÁöÑ GoroutineÔºå<code>curg</code> ÊòØÂú®ÂΩìÂâçÁ∫øÁ®ã‰∏äËøêË°åÁöÑÁî®Êà∑ GoroutineÔºåËøô‰πüÊòØÊìç‰ΩúÁ≥ªÁªüÁ∫øÁ®ãÂîØ‰∏ÄÂÖ≥ÂøÉÁöÑ‰∏§‰∏™ Goroutine„ÄÇ</p>
<h5 id="1113-p">1.1.1.3. P</h5>
<p>Ë∞ÉÂ∫¶Âô®‰∏≠ÁöÑÂ§ÑÁêÜÂô® P ÊòØÁ∫øÁ®ãÂíå Goroutine ÁöÑ‰∏≠Èó¥Â±ÇÔºåÂÆÉËÉΩÊèê‰æõÁ∫øÁ®ãÈúÄË¶ÅÁöÑ‰∏ä‰∏ãÊñáÁéØÂ¢ÉÔºå‰πü‰ºöË¥üË¥£Ë∞ÉÂ∫¶Á∫øÁ®ã‰∏äÁöÑÁ≠âÂæÖÈòüÂàóÔºåÈÄöËøáÂ§ÑÁêÜÂô® P ÁöÑË∞ÉÂ∫¶ÔºåÊØè‰∏Ä‰∏™ÂÜÖÊ†∏Á∫øÁ®ãÈÉΩËÉΩÂ§üÊâßË°åÂ§ö‰∏™ GoroutineÔºåÂÆÉËÉΩÂú® Goroutine ËøõË°å‰∏Ä‰∫õ I/O Êìç‰ΩúÊó∂ÂèäÊó∂ËÆ©Âá∫ËÆ°ÁÆóËµÑÊ∫êÔºåÊèêÈ´òÁ∫øÁ®ãÁöÑÂà©Áî®Áéá„ÄÇ</p>
<p>Âõ†‰∏∫Ë∞ÉÂ∫¶Âô®Âú®ÂêØÂä®Êó∂Â∞±‰ºöÂàõÂª∫ <code>GOMAXPROCS</code> ‰∏™Â§ÑÁêÜÂô®ÔºåÊâÄ‰ª• Go ËØ≠Ë®ÄÁ®ãÂ∫èÁöÑÂ§ÑÁêÜÂô®Êï∞Èáè‰∏ÄÂÆö‰ºöÁ≠â‰∫é <code>GOMAXPROCS</code>ÔºåËøô‰∫õÂ§ÑÁêÜÂô®‰ºöÁªëÂÆöÂà∞‰∏çÂêåÁöÑÂÜÖÊ†∏Á∫øÁ®ã‰∏ä„ÄÇ</p>
<p><code>runtime.p</code> ÊòØÂ§ÑÁêÜÂô®ÁöÑËøêË°åÊó∂Ë°®Á§∫Ôºå‰Ωú‰∏∫Ë∞ÉÂ∫¶Âô®ÁöÑÂÜÖÈÉ®ÂÆûÁé∞ÔºåÂÆÉÂåÖÂê´ÁöÑÂ≠óÊÆµ‰πüÈùûÂ∏∏Â§öÔºåÂÖ∂‰∏≠ÂåÖÊã¨‰∏éÊÄßËÉΩËøΩË∏™„ÄÅÂûÉÂúæÂõûÊî∂ÂíåËÆ°Êó∂Âô®Áõ∏ÂÖ≥ÁöÑÂ≠óÊÆµÔºåËøô‰∫õÂ≠óÊÆµ‰πüÈùûÂ∏∏ÈáçË¶ÅÔºå‰ΩÜÊòØÂú®ËøôÈáåÂ∞±‰∏çÂ±ïÁ§∫‰∫ÜÔºåÊàë‰ª¨‰∏ªË¶ÅÂÖ≥Ê≥®Â§ÑÁêÜÂô®‰∏≠ÁöÑÁ∫øÁ®ãÂíåËøêË°åÈòüÂàóÔºö</p>
<p>PÔºö‰Ωú‰∏∫‰∏≠Èó¥Â±ÇÔºå</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">p</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">id</span>          <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span>      <span class="kt">uint32</span> <span class="c1">// one of pidle/prunning/...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">link</span>        <span class="nx">puintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">schedtick</span>   <span class="kt">uint32</span>     <span class="c1">// incremented on every scheduler call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">syscalltick</span> <span class="kt">uint32</span>     <span class="c1">// incremented on every system call
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">sysmontick</span>  <span class="nx">sysmontick</span> <span class="c1">// last tick observed by sysmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">m</span>           <span class="nx">muintptr</span>   <span class="c1">// back-link to associated m (nil if idle)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mcache</span>      <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pcache</span>      <span class="nx">pageCache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">raceprocctx</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">deferpool</span>    <span class="p">[</span><span class="mi">5</span><span class="p">][]</span><span class="o">*</span><span class="nx">_defer</span> <span class="c1">// pool of available defer structs of different sizes (see panic.go)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deferpoolbuf</span> <span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span><span class="o">*</span><span class="nx">_defer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cache of goroutine ids, amortizes accesses to runtime¬∑sched.goidgen.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">goidcache</span>    <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">goidcacheend</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Queue of runnable goroutines. Accessed without lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">runqhead</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runqtail</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">runq</span>     <span class="p">[</span><span class="mi">256</span><span class="p">]</span><span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// runnext, if non-nil, is a runnable G that was ready&#39;d by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// the current G and should be run next instead of what&#39;s in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// runq if there&#39;s time remaining in the running G&#39;s time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// slice. It will inherit the time left in the current time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// slice. If a set of goroutines is locked in a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// communicate-and-wait pattern, this schedules that set as a
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// unit and eliminates the (potentially large) scheduling
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// latency that otherwise arises from adding the ready&#39;d
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// goroutines to the end of the run queue.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Note that while other P&#39;s may atomically CAS this to zero,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// only the owner P can CAS it to a valid G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">runnext</span> <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Available G&#39;s (status == Gdead)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gFree</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">        <span class="nx">n</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sudogcache</span> <span class="p">[]</span><span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sudogbuf</span>   <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="o">*</span><span class="nx">sudog</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Cache of mspan objects from the heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">mspancache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// We need an explicit length here because this field is used
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// in allocation codepaths where write barriers are not allowed,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// and eliminating the write barrier/keeping it eliminated from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// slice updates is tricky, moreso than just managing the length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// ourselves.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">len</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">        <span class="nx">buf</span> <span class="p">[</span><span class="mi">128</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tracebuf</span> <span class="nx">traceBufPtr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// traceSweep indicates the sweep events should be traced.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is used to defer the sweep start event until a span
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// has actually been swept.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceSweep</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// traceSwept and traceReclaimed track the number of bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// swept and reclaimed by sweeping in the current sweep loop.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">traceSwept</span><span class="p">,</span> <span class="nx">traceReclaimed</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">palloc</span> <span class="nx">persistentAlloc</span> <span class="c1">// per-P to avoid mutex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">_</span> <span class="kt">uint32</span> <span class="c1">// Alignment for atomic fields below
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// The when field of the first entry on the timer heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is updated using atomic functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is 0 if the timer heap is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timer0When</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// The earliest known nextwhen field of a timer with
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// timerModifiedEarlier status. Because the timer may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// modified again, there need not be any timer with this value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is updated using atomic functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// This is 0 if there are no timerModifiedEarlier timers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timerModifiedEarliest</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Per-P GC state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcAssistTime</span>         <span class="kt">int64</span> <span class="c1">// Nanoseconds in assistAlloc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcFractionalMarkTime</span> <span class="kt">int64</span> <span class="c1">// Nanoseconds in fractional mark worker (atomic)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcMarkWorkerMode is the mode for the next mark worker to run in.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// That is, this is used to communicate with the worker goroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// selected for immediate execution by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// gcController.findRunnableGCWorker. When scheduling other goroutines,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// this field must be set to gcMarkWorkerNotWorker.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcMarkWorkerMode</span> <span class="nx">gcMarkWorkerMode</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// gcMarkWorkerStartTime is the nanotime() at which the most recent
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mark worker started.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcMarkWorkerStartTime</span> <span class="kt">int64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// gcw is this P&#39;s GC work buffer cache. The work buffer is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// filled by write barriers, drained by mutator assists, and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// disposed on certain GC state transitions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">gcw</span> <span class="nx">gcWork</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// wbBuf is this P&#39;s GC write barrier buffer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// TODO: Consider caching this in the running G.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">wbBuf</span> <span class="nx">wbBuf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">runSafePointFn</span> <span class="kt">uint32</span> <span class="c1">// if 1, run sched.safePointFn at next safe point
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// statsSeq is a counter indicating whether this P is currently
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// writing any stats. Its value is even when not, odd when it is.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">statsSeq</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Lock for timers. We normally access the timers while running
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// on this P, but the scheduler can also do it from a different P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timersLock</span> <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Actions to take at some time. This is used to implement the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// standard library&#39;s time package.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Must hold timersLock to access.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">timer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Number of timers in P&#39;s heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Modified using atomic instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">numTimers</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Number of timerDeleted timers in P&#39;s heap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Modified using atomic instructions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">deletedTimers</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Race context used while executing timer functions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">timerRaceCtx</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// preempt is set to indicate that this P should be enter the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// scheduler ASAP (regardless of what G is running on it).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">preempt</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Padding is no longer needed. False sharing is now not a worry because p is large enough
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// that its size class is an integer multiple of the cache line size (for any of our architectures).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠ P ‰πüÂÆö‰πâ‰∫ÜÁä∂ÊÄÅÂ≠óÊÆµ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">const</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// P status
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pidle means a P is not being used to run user code or the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// scheduler. Typically, it&#39;s on the idle P list and available
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// to the scheduler, but it may just be transitioning between
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// other states.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// The P is owned by the idle list or by whatever is
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// transitioning its state. Its run queue is empty.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pidle</span> <span class="p">=</span> <span class="kc">iota</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Prunning means a P is owned by an M and is being used to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// run user code or the scheduler. Only the M that owns this P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// is allowed to change the P&#39;s status from _Prunning. The M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// may transition the P to _Pidle (if it has no more work to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// do), _Psyscall (when entering a syscall), or _Pgcstop (to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// halt for the GC). The M may also hand ownership of the P
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// off directly to another M (e.g., to schedule a locked G).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Psyscall means a P is not running user code. It has
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// affinity to an M in a syscall but is not owned by it and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// may be stolen by another M. This is similar to _Pidle but
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// uses lightweight transitions and maintains M affinity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Leaving _Psyscall must be done with a CAS, either to steal
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// or retake the P. Note that there&#39;s an ABA hazard: even if
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// an M successfully CASes its original P back to _Prunning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// after a syscall, it must understand the P may have been
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// used by another M in the interim.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Psyscall</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pgcstop means a P is halted for STW and owned by the M
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// that stopped the world. The M that stopped the world
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// continues to use its P, even in _Pgcstop. Transitioning
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// from _Prunning to _Pgcstop causes an M to release its P and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// park.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// The P retains its run queue and startTheWorld will restart
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// the scheduler on Ps with non-empty run queues.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pgcstop</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// _Pdead means a P is no longer used (GOMAXPROCS shrank). We
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// reuse Ps if GOMAXPROCS increases. A dead P is mostly
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// stripped of its resources, though a few things remain
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// (e.g., trace buffers).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_Pdead</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="table-wrapper"><table>
<thead>
<tr>
<th>Áä∂ÊÄÅ</th>
<th>ÊèèËø∞</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>_Pidle</code></td>
<td>Â§ÑÁêÜÂô®Ê≤°ÊúâËøêË°åÁî®Êà∑‰ª£Á†ÅÊàñËÄÖË∞ÉÂ∫¶Âô®ÔºåË¢´Á©∫Èó≤ÈòüÂàóÊàñËÄÖÊîπÂèòÂÖ∂Áä∂ÊÄÅÁöÑÁªìÊûÑÊåÅÊúâÔºåËøêË°åÈòüÂàó‰∏∫Á©∫</td>
</tr>
<tr>
<td><code>_Prunning</code></td>
<td>Ë¢´Á∫øÁ®ã M ÊåÅÊúâÔºåÂπ∂‰∏îÊ≠£Âú®ÊâßË°åÁî®Êà∑‰ª£Á†ÅÊàñËÄÖË∞ÉÂ∫¶Âô®</td>
</tr>
<tr>
<td><code>_Psyscall</code></td>
<td>Ê≤°ÊúâÊâßË°åÁî®Êà∑‰ª£Á†ÅÔºåÂΩìÂâçÁ∫øÁ®ãÈô∑ÂÖ•Á≥ªÁªüË∞ÉÁî®</td>
</tr>
<tr>
<td><code>_Pgcstop</code></td>
<td>Ë¢´Á∫øÁ®ã M ÊåÅÊúâÔºåÂΩìÂâçÂ§ÑÁêÜÂô®Áî±‰∫éÂûÉÂúæÂõûÊî∂Ë¢´ÂÅúÊ≠¢</td>
</tr>
<tr>
<td><code>_Pdead</code></td>
<td>ÂΩìÂâçÂ§ÑÁêÜÂô®Â∑≤Áªè‰∏çË¢´‰ΩøÁî®</td>
</tr>
</tbody>
</table></div>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">struct</span> <span class="nx">P</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Lock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">uint32</span>    <span class="nx">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">P</span><span class="o">*</span>    <span class="nx">link</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32</span>    <span class="nx">tick</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">M</span><span class="o">*</span>    <span class="nx">m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">MCache</span><span class="o">*</span>    <span class="nx">mcache</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">G</span><span class="o">**</span>    <span class="nx">runq</span><span class="p">;</span> <span class="c1">// goroutineÁªÑÊàêÁöÑÁéØÂΩ¢Êï∞ÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">int32</span>    <span class="nx">runqhead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">runqtail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">runqsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">G</span><span class="o">*</span>    <span class="nx">gfree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int32</span>    <span class="nx">gfreecnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>GÁöÑÁä∂ÊÄÅ</li>
</ol>
<ul>
<li>Á©∫Èó≤‰∏≠(_Gidle): Ë°®Á§∫GÂàöÂàöÊñ∞Âª∫, ‰ªçÊú™ÂàùÂßãÂåñ</li>
<li>ÂæÖËøêË°å(_Grunnable): Ë°®Á§∫GÂú®ËøêË°åÈòüÂàó‰∏≠, Á≠âÂæÖMÂèñÂá∫Âπ∂ËøêË°å</li>
<li>ËøêË°å‰∏≠(_Grunning): Ë°®Á§∫MÊ≠£Âú®ËøêË°åËøô‰∏™G, ËøôÊó∂ÂÄôM‰ºöÊã•Êúâ‰∏Ä‰∏™P</li>
<li>Á≥ªÁªüË∞ÉÁî®‰∏≠(_Gsyscall): Ë°®Á§∫MÊ≠£Âú®ËøêË°åËøô‰∏™GÂèëËµ∑ÁöÑÁ≥ªÁªüË∞ÉÁî®, ËøôÊó∂ÂÄôMÂπ∂‰∏çÊã•ÊúâP</li>
<li>Á≠âÂæÖ‰∏≠(_Gwaiting): Ë°®Á§∫GÂú®Á≠âÂæÖÊüê‰∫õÊù°‰ª∂ÂÆåÊàê, ËøôÊó∂ÂÄôG‰∏çÂú®ËøêË°å‰πü‰∏çÂú®ËøêË°åÈòüÂàó‰∏≠(ÂèØËÉΩÂú®channelÁöÑÁ≠âÂæÖÈòüÂàó‰∏≠)</li>
<li>Â∑≤‰∏≠Ê≠¢(_Gdead): Ë°®Á§∫GÊú™Ë¢´‰ΩøÁî®, ÂèØËÉΩÂ∑≤ÊâßË°åÂÆåÊØï(Âπ∂Âú®freelist‰∏≠Á≠âÂæÖ‰∏ãÊ¨°Â§çÁî®)</li>
<li>Ê†àÂ§çÂà∂‰∏≠(_Gcopystack): Ë°®Á§∫GÊ≠£Âú®Ëé∑Âèñ‰∏Ä‰∏™Êñ∞ÁöÑÊ†àÁ©∫Èó¥Âπ∂ÊääÂéüÊù•ÁöÑÂÜÖÂÆπÂ§çÂà∂ËøáÂéª(Áî®‰∫éÈò≤Ê≠¢GCÊâ´Êèè)</li>
</ul>
<ol start="2">
<li>MÁöÑÁä∂ÊÄÅ</li>
</ol>
<p>MÂπ∂Ê≤°ÊúâÂÉèGÂíåP‰∏ÄÊ†∑ÁöÑÁä∂ÊÄÅÊ†áËÆ∞, ‰ΩÜÂèØ‰ª•ËÆ§‰∏∫‰∏Ä‰∏™MÊúâ‰ª•‰∏ãÁöÑÁä∂ÊÄÅ:</p>
<ul>
<li>Ëá™Êóã‰∏≠(spinning): MÊ≠£Âú®‰ªéËøêË°åÈòüÂàóËé∑ÂèñG, ËøôÊó∂ÂÄôM‰ºöÊã•Êúâ‰∏Ä‰∏™P</li>
<li>ÊâßË°ågo‰ª£Á†Å‰∏≠: MÊ≠£Âú®ÊâßË°ågo‰ª£Á†Å, ËøôÊó∂ÂÄôM‰ºöÊã•Êúâ‰∏Ä‰∏™P</li>
<li>ÊâßË°åÂéüÁîü‰ª£Á†Å‰∏≠: MÊ≠£Âú®ÊâßË°åÂéüÁîü‰ª£Á†ÅÊàñËÄÖÈòªÂ°ûÁöÑsyscall, ËøôÊó∂MÂπ∂‰∏çÊã•ÊúâP</li>
<li>‰ºëÁú†‰∏≠: MÂèëÁé∞Êó†ÂæÖËøêË°åÁöÑGÊó∂‰ºöËøõÂÖ•‰ºëÁú†, Âπ∂Ê∑ªÂä†Âà∞Á©∫Èó≤MÈìæË°®‰∏≠, ËøôÊó∂MÂπ∂‰∏çÊã•ÊúâP</li>
</ul>
<p>Ëá™Êóã‰∏≠(spinning)Ëøô‰∏™Áä∂ÊÄÅÈùûÂ∏∏ÈáçË¶Å, ÊòØÂê¶ÈúÄË¶ÅÂî§ÈÜíÊàñËÄÖÂàõÂª∫Êñ∞ÁöÑMÂèñÂÜ≥‰∫éÂΩìÂâçËá™Êóã‰∏≠ÁöÑMÁöÑÊï∞Èáè.</p>
<ol start="3">
<li>PÁöÑÁä∂ÊÄÅ</li>
</ol>
<ul>
<li>Á©∫Èó≤‰∏≠(_Pidle): ÂΩìMÂèëÁé∞Êó†ÂæÖËøêË°åÁöÑGÊó∂‰ºöËøõÂÖ•‰ºëÁú†, ËøôÊó∂MÊã•ÊúâÁöÑP‰ºöÂèò‰∏∫Á©∫Èó≤Âπ∂Âä†Âà∞Á©∫Èó≤PÈìæË°®‰∏≠</li>
<li>ËøêË°å‰∏≠(_Prunning): ÂΩìMÊã•Êúâ‰∫Ü‰∏Ä‰∏™PÂêé, Ëøô‰∏™PÁöÑÁä∂ÊÄÅÂ∞±‰ºöÂèò‰∏∫ËøêË°å‰∏≠, MËøêË°åG‰ºö‰ΩøÁî®Ëøô‰∏™P‰∏≠ÁöÑËµÑÊ∫ê</li>
<li>Á≥ªÁªüË∞ÉÁî®‰∏≠(_Psyscall): ÂΩìgoË∞ÉÁî®ÂéüÁîü‰ª£Á†Å, ÂéüÁîü‰ª£Á†ÅÂèàÂèçËøáÊù•Ë∞ÉÁî®go‰ª£Á†ÅÊó∂, ‰ΩøÁî®ÁöÑP‰ºöÂèò‰∏∫Ê≠§Áä∂ÊÄÅ</li>
<li>GCÂÅúÊ≠¢‰∏≠(_Pgcstop): ÂΩìgcÂÅúÊ≠¢‰∫ÜÊï¥‰∏™‰∏ñÁïå(STW)Êó∂, P‰ºöÂèò‰∏∫Ê≠§Áä∂ÊÄÅ</li>
<li>Â∑≤‰∏≠Ê≠¢(_Pdead): ÂΩìPÁöÑÊï∞ÈáèÂú®ËøêË°åÊó∂ÊîπÂèò, ‰∏îÊï∞ÈáèÂáèÂ∞ëÊó∂Â§ö‰ΩôÁöÑP‰ºöÂèò‰∏∫Ê≠§Áä∂ÊÄÅ</li>
</ul>
<p>PÁöÑÊï∞ÈáèÔºöËÆæÁΩÆÁî±ÂêØÂä®Êó∂ÁéØÂ¢ÉÂèòÈáè $GOMAXPROCS ÊàñËÄÖÊòØÁî± runtime ÁöÑÊñπÊ≥ï GOMAXPROCS() ÂÜ≥ÂÆö„ÄÇËøôÊÑèÂë≥ÁùÄÂú®Á®ãÂ∫èÊâßË°åÁöÑ‰ªªÊÑèÊó∂ÂàªÈÉΩÂè™Êúâ $GOMAXPROCS ‰∏™ goroutine Âú®ÂêåÊó∂ËøêË°å„ÄÇ</p>
<p>M ÁöÑÊï∞ÈáèÔºögo ËØ≠Ë®ÄÊú¨Ë∫´ÁöÑÈôêÂà∂Ôºögo Á®ãÂ∫èÂêØÂä®Êó∂Ôºå‰ºöËÆæÁΩÆ M ÁöÑÊúÄÂ§ßÊï∞ÈáèÔºåÈªòËÆ§ 10000. ‰ΩÜÊòØÂÜÖÊ†∏ÂæàÈöæÊîØÊåÅËøô‰πàÂ§öÁöÑÁ∫øÁ®ãÊï∞ÔºåÊâÄ‰ª•Ëøô‰∏™ÈôêÂà∂ÂèØ‰ª•ÂøΩÁï•„ÄÇruntime/debug ‰∏≠ÁöÑ SetMaxThreads ÂáΩÊï∞ÔºåËÆæÁΩÆ M ÁöÑÊúÄÂ§ßÊï∞Èáè„ÄÇ‰∏Ä‰∏™ M ÈòªÂ°û‰∫ÜÔºå‰ºöÂàõÂª∫Êñ∞ÁöÑ M„ÄÇ</p>
<p>Âú®go‰∏≠ÊúâÂ§ö‰∏™ËøêË°åÈòüÂàóÂèØ‰ª•‰øùÂ≠òÂæÖËøêË°å(_Grunnable)ÁöÑG, ÂÆÉ‰ª¨ÂàÜÂà´ÊòØÂêÑ‰∏™P‰∏≠ÁöÑÊú¨Âú∞ËøêË°åÈòüÂàóÂíåÂÖ®Â±ÄËøêË°åÈòüÂàó.
ÂÖ•ÈòüÂæÖËøêË°åÁöÑGÊó∂‰ºö‰ºòÂÖàÂä†Âà∞ÂΩìÂâçPÁöÑÊú¨Âú∞ËøêË°åÈòüÂàó, MËé∑ÂèñÂæÖËøêË°åÁöÑGÊó∂‰πü‰ºö‰ºòÂÖà‰ªéÊã•ÊúâÁöÑPÁöÑÊú¨Âú∞ËøêË°åÈòüÂàóËé∑Âèñ,
Êú¨Âú∞ËøêË°åÈòüÂàóÂÖ•ÈòüÂíåÂá∫Èòü‰∏çÈúÄË¶Å‰ΩøÁî®Á∫øÁ®ãÈîÅ.</p>
<p>Êú¨Âú∞ËøêË°åÈòüÂàóÊúâÊï∞ÈáèÈôêÂà∂, ÂΩìÊï∞ÈáèËææÂà∞256‰∏™Êó∂‰ºöÂÖ•ÈòüÂà∞ÂÖ®Â±ÄËøêË°åÈòüÂàó.
Êú¨Âú∞ËøêË°åÈòüÂàóÁöÑÊï∞ÊçÆÁªìÊûÑÊòØ<a class="link" href="https://link.segmentfault.com/?enc=3K7smhVfN1rsbyq%2FSwlKxg%3D%3D.65MePZBQYDpl%2FjSZBC976W%2Blp8dmXiT1ISfuJPU9TLbK7knyfQavGJ%2BADWaPh5uR"  target="_blank" rel="noopener"
    >ÁéØÂΩ¢ÈòüÂàó</a>, Áî±‰∏Ä‰∏™256ÈïøÂ∫¶ÁöÑÊï∞ÁªÑÂíå‰∏§‰∏™Â∫èÂè∑(head, tail)ÁªÑÊàê.</p>
<p>ÂΩìM‰ªéPÁöÑÊú¨Âú∞ËøêË°åÈòüÂàóËé∑ÂèñGÊó∂, Â¶ÇÊûúÂèëÁé∞Êú¨Âú∞ÈòüÂàó‰∏∫Á©∫‰ºöÂ∞ùËØï‰ªéÂÖ∂‰ªñPÁõóÂèñ‰∏ÄÂçäÁöÑGËøáÊù•,
Ëøô‰∏™Êú∫Âà∂Âè´ÂÅö<a class="link" href="https://link.segmentfault.com/?enc=dFHWCcy9uuQg8AreOB4osg%3D%3D.d3lAx7XwHsabU%2FP1I8q5qlEqbus5KYD7pQ8L%2Fu6cvm%2Fy78iwj%2FOPweDd%2Fy2%2FeecH"  target="_blank" rel="noopener"
    >Work Stealing</a>, ËØ¶ËßÅÂêéÈù¢ÁöÑ‰ª£Á†ÅÂàÜÊûê.</p>
<p>ÂÖ®Â±ÄËøêË°åÈòüÂàó‰øùÂ≠òÂú®ÂÖ®Â±ÄÂèòÈáè<code>sched</code>‰∏≠, ÂÖ®Â±ÄËøêË°åÈòüÂàóÂÖ•ÈòüÂíåÂá∫ÈòüÈúÄË¶Å‰ΩøÁî®Á∫øÁ®ãÈîÅ.
ÂÖ®Â±ÄËøêË°åÈòüÂàóÁöÑÊï∞ÊçÆÁªìÊûÑÊòØÈìæË°®, Áî±‰∏§‰∏™ÊåáÈíà(head, tail)ÁªÑÊàê.</p>
<h4 id="112-start">1.1.2. Start</h4>
<p>Âú®Ë∞ÉÂ∫¶Âô®ÂàùÂßãÂáΩÊï∞ÊâßË°åÁöÑËøáÁ®ã‰∏≠‰ºöÂ∞Ü <code>maxmcount</code> ËÆæÁΩÆÊàê 10000ÔºåËøô‰πüÂ∞±ÊòØ‰∏Ä‰∏™ Go ËØ≠Ë®ÄÁ®ãÂ∫èËÉΩÂ§üÂàõÂª∫ÁöÑÊúÄÂ§ßÁ∫øÁ®ãÊï∞ÔºåËôΩÁÑ∂ÊúÄÂ§öÂèØ‰ª•ÂàõÂª∫ 10000 ‰∏™Á∫øÁ®ãÔºå‰ΩÜÊòØÂèØ‰ª•ÂêåÊó∂ËøêË°åÁöÑÁ∫øÁ®ãËøòÊòØÁî± <code>GOMAXPROCS</code> ÂèòÈáèÊéßÂà∂„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">nanotime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">procs</span> <span class="o">:=</span> <span class="nx">ncpu</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi32</span><span class="p">(</span><span class="nf">gogetenv</span><span class="p">(</span><span class="s">&#34;GOMAXPROCS&#34;</span><span class="p">));</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">procs</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">procs</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unknown runnable goroutine during bootstrap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂΩìprocresizeÂêØÂä®ÂêéÔºåÂºÄÂßãÁ≠âÂæÖÁî®Êà∑ÂàõÂª∫ËøêË°åÊñ∞ÁöÑ Goroutine Âπ∂‰∏∫ Goroutine Ë∞ÉÂ∫¶Â§ÑÁêÜÂô®ËµÑÊ∫ê</p>
<h3 id="12-create-goroutine">1.2. Create Goroutine</h3>
<p>ÂΩìË∞ÉÁî®go func()Êó∂ÔºåÁºñËØëÂô®Ë∞ÉÁî®callÊñπÊ≥ïÔºåÁÑ∂ÂêéÂÜçËΩ¨Êç¢ÊàênewprocÁöÑË∞ÉÁî®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">state</span><span class="p">)</span> <span class="nf">call</span><span class="p">(</span><span class="nx">n</span> <span class="o">*</span><span class="nx">Node</span><span class="p">,</span> <span class="nx">k</span> <span class="nx">callKind</span><span class="p">)</span> <span class="o">*</span><span class="nx">ssa</span><span class="p">.</span><span class="nx">Value</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">k</span> <span class="o">==</span> <span class="nx">callDeferStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">switch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">k</span> <span class="o">==</span> <span class="nx">callGo</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nx">call</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">newValue1A</span><span class="p">(</span><span class="nx">ssa</span><span class="p">.</span><span class="nx">OpStaticCall</span><span class="p">,</span> <span class="nx">types</span><span class="p">.</span><span class="nx">TypeMem</span><span class="p">,</span> <span class="nx">newproc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">mem</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>runtime.newproc</code>ÁöÑÂÖ•ÂèÇÊòØÂèÇÊï∞Â§ßÂ∞èÂíåË°®Á§∫ÂáΩÊï∞ÁöÑÊåáÈíà <code>funcval</code>ÔºåÂÆÉ‰ºöËé∑Âèñ Goroutine ‰ª•ÂèäË∞ÉÁî®ÊñπÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®ÔºåÁÑ∂ÂêéË∞ÉÁî® <code>runtime.newproc1</code>ÂáΩÊï∞Ëé∑ÂèñÊñ∞ÁöÑ Goroutine ÁªìÊûÑ‰Ωì„ÄÅÂ∞ÜÂÖ∂Âä†ÂÖ•Â§ÑÁêÜÂô®ÁöÑËøêË°åÈòüÂàóÂπ∂Âú®Êª°Ë∂≥Êù°‰ª∂Êó∂Ë∞ÉÁî® <code>runtime.wakep</code> Âî§ÈÜíÊñ∞ÁöÑÂ§ÑÁêÜÊâßË°å GoroutineÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newproc</span><span class="p">(</span><span class="nx">siz</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">argp</span> <span class="o">:=</span> <span class="nf">add</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">fn</span><span class="p">),</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PtrSize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pc</span> <span class="o">:=</span> <span class="nf">getcallerpc</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">argp</span><span class="p">,</span> <span class="nx">siz</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">pc</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">newg</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">mainStarted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">wakep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠newproc1Ë∞ÉÁî®Â¶Ç‰∏ãÔºåÂÖ∂Ë∞ÉÁî®ÂèØ‰ª•ÂàÜ‰∏∫Â¶Ç‰∏ã‰∏âÊ≠•Ôºö</p>
<ol>
<li>Ëé∑ÂèñÊàñËÄÖÂàõÂª∫Êñ∞ÁöÑ Goroutine ÁªìÊûÑ‰Ωì</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newproc1</span><span class="p">(</span><span class="nx">fn</span> <span class="o">*</span><span class="nx">funcval</span><span class="p">,</span> <span class="nx">argp</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">narg</span> <span class="kt">int32</span><span class="p">,</span> <span class="nx">callergp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">callerpc</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">siz</span> <span class="o">:=</span> <span class="nx">narg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">siz</span> <span class="p">=</span> <span class="p">(</span><span class="nx">siz</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;^</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span> <span class="o">:=</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>  <span class="c1">// Ëé∑ÂèñÊñ∞ÁöÑg
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">newg</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span> <span class="p">=</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">_StackMin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gidle</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">allgadd</span><span class="p">(</span><span class="nx">newg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>
<p>ÊääÂèÇÊï∞ÊîæÂÖ•Ê†àÂå∫Ôºö</p>
<p>Êé•‰∏ãÊù•ÔºåÊàë‰ª¨‰ºöË∞ÉÁî® <code>runtime.memmove</code> Â∞Ü <code>fn</code> ÂáΩÊï∞ÁöÑÊâÄÊúâÂèÇÊï∞Êã∑Ë¥ùÂà∞Ê†à‰∏äÔºå<code>argp</code> Âíå <code>narg</code> ÂàÜÂà´ÊòØÂèÇÊï∞ÁöÑÂÜÖÂ≠òÁ©∫Èó¥ÂíåÂ§ßÂ∞èÔºåÊàë‰ª¨Âú®ËØ•ÊñπÊ≥ï‰∏≠‰ºöÂ∞ÜÂèÇÊï∞ÂØπÂ∫îÁöÑÂÜÖÂ≠òÁ©∫Èó¥Êï¥ÂùóÊã∑Ë¥ùÂà∞Ê†à‰∏ä</p>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">totalSize</span> <span class="o">:=</span> <span class="mi">4</span><span class="o">*</span><span class="nx">sys</span><span class="p">.</span><span class="nx">RegSize</span> <span class="o">+</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">siz</span><span class="p">)</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">MinFrameSize</span>
</span></span><span class="line"><span class="cl">    <span class="nx">totalSize</span> <span class="o">+=</span> <span class="o">-</span><span class="nx">totalSize</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nx">sys</span><span class="p">.</span><span class="nx">SpAlign</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sp</span> <span class="o">:=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">totalSize</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spArg</span> <span class="o">:=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">narg</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memmove</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">spArg</span><span class="p">),</span> <span class="nx">argp</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">narg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//...
</span></span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>Êõ¥Êñ∞ Goroutine Ë∞ÉÂ∫¶Áõ∏ÂÖ≥ÁöÑÂ±ûÊÄßÔºõ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">memclrNoHeapPointers</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">stktopsp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">pc</span> <span class="p">=</span> <span class="nf">funcPC</span><span class="p">(</span><span class="nx">goexit</span><span class="p">)</span> <span class="o">+</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PCQuantum</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">.</span><span class="nx">g</span> <span class="p">=</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">newg</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gostartcallfn</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newg</span><span class="p">.</span><span class="nx">sched</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">gopc</span> <span class="p">=</span> <span class="nx">callerpc</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">startpc</span> <span class="p">=</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">fn</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">newg</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span><span class="p">.</span><span class="nx">goid</span> <span class="p">=</span> <span class="nb">int64</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">goidcache</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠gfgetÊñπÊ≥ïÂ¶Ç‰∏ãÔºö</p>
<ol>
<li>‰ªé Goroutine ÊâÄÂú®Â§ÑÁêÜÂô®ÁöÑ <code>gFree</code> ÂàóË°®ÊàñËÄÖË∞ÉÂ∫¶Âô®ÁöÑ <code>sched.gFree</code> ÂàóË°®‰∏≠Ëé∑Âèñ <code>runtime.g</code>Ôºõ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Available G&#39;s (status == Gdead)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">gFree</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gList</span>
</span></span><span class="line"><span class="cl">    <span class="nx">n</span> <span class="kt">int32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// A gList is a list of Gs linked through g.schedlink. A G can only be
</span></span></span><span class="line"><span class="cl"><span class="c1">// on one gQueue or gList at a time.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">gList</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">head</span> <span class="nx">guintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Ë∞ÉÁî® <code>runtime.malg</code>ÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑ <code>runtime.g</code> Âπ∂Â∞ÜÁªìÊûÑ‰ΩìËøΩÂä†Âà∞ÂÖ®Â±ÄÁöÑ Goroutine ÂàóË°® <code>allgs</code> ‰∏≠„ÄÇ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gfget</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">empty</span><span class="p">()</span> <span class="o">||</span> <span class="p">!</span><span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">n</span> <span class="p">&lt;</span> <span class="mi">32</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">gp</span> <span class="p">=</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nx">noStack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">gFree</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>ÂΩìÂ§ÑÁêÜÂô®ÁöÑ Goroutine ÂàóË°®‰∏∫Á©∫Êó∂Ôºå‰ºöÂ∞ÜË∞ÉÂ∫¶Âô®ÊåÅÊúâÁöÑÁ©∫Èó≤ Goroutine ËΩ¨ÁßªÂà∞ÂΩìÂâçÂ§ÑÁêÜÂô®‰∏äÔºåÁõ¥Âà∞ <code>gFree</code> ÂàóË°®‰∏≠ÁöÑ Goroutine Êï∞ÈáèËææÂà∞ 32Ôºõ</li>
<li>ÂΩìÂ§ÑÁêÜÂô®ÁöÑ Goroutine Êï∞ÈáèÂÖÖË∂≥Êó∂Ôºå‰ºö‰ªéÂàóË°®Â§¥ÈÉ®ËøîÂõû‰∏Ä‰∏™Êñ∞ÁöÑ GoroutineÔºõ</li>
</ol>
<p>ÂΩìË∞ÉÂ∫¶Âô®ÁöÑ <code>gFree</code> ÂíåÂ§ÑÁêÜÂô®ÁöÑ <code>gFree</code> ÂàóË°®ÈÉΩ‰∏çÂ≠òÂú®ÁªìÊûÑ‰ΩìÊó∂ÔºåËøêË°åÊó∂‰ºöË∞ÉÁî® <code>runtime.malg</code>ÂàùÂßãÂåñÊñ∞ÁöÑ <code>runtime.g</code>ÁªìÊûÑÔºåÂ¶ÇÊûúÁî≥ËØ∑ÁöÑÂ†ÜÊ†àÂ§ßÂ∞èÂ§ß‰∫é 0ÔºåËøôÈáå‰ºöÈÄöËøá <code>runtime.stackalloc</code> ÂàÜÈÖç 2KB ÁöÑÊ†àÁ©∫Èó¥Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">malg</span><span class="p">(</span><span class="nx">stacksize</span> <span class="kt">int32</span><span class="p">)</span> <span class="o">*</span><span class="nx">g</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">newg</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">stacksize</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">stacksize</span> <span class="p">=</span> <span class="nf">round2</span><span class="p">(</span><span class="nx">_StackSystem</span> <span class="o">+</span> <span class="nx">stacksize</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span> <span class="p">=</span> <span class="nf">stackalloc</span><span class="p">(</span><span class="nb">uint32</span><span class="p">(</span><span class="nx">stacksize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">newg</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">        <span class="nx">newg</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="p">^</span><span class="nb">uintptr</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">newg</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰πãÂêé‰ºöË∞ÉÁî®<code>runtime.runqput</code>‰ºöÂ∞Ü Goroutine ÊîæÂà∞ËøêË°åÈòüÂàó‰∏äÔºåËøôÊó¢ÂèØËÉΩÊòØÂÖ®Â±ÄÁöÑËøêË°åÈòüÂàóÔºå‰πüÂèØËÉΩÊòØÂ§ÑÁêÜÂô®Êú¨Âú∞ÁöÑËøêË°åÈòüÂàóÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">runqput</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">next</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">retryNext</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nx">oldnext</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">!</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runnext</span><span class="p">.</span><span class="nf">cas</span><span class="p">(</span><span class="nx">oldnext</span><span class="p">,</span> <span class="nf">guintptr</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">gp</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="nx">retryNext</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">oldnext</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span> <span class="p">=</span> <span class="nx">oldnext</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">retry</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">LoadAcq</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqhead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">t</span> <span class="o">:=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">t</span><span class="o">-</span><span class="nx">h</span> <span class="p">&lt;</span> <span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">[</span><span class="nx">t</span><span class="o">%</span><span class="nb">uint32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runq</span><span class="p">))].</span><span class="nf">set</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">StoreRel</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">_p_</span><span class="p">.</span><span class="nx">runqtail</span><span class="p">,</span> <span class="nx">t</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">runqputslow</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">goto</span> <span class="nx">retry</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>ÂΩì <code>next</code> ‰∏∫ <code>true</code> Êó∂ÔºåÂ∞Ü Goroutine ËÆæÁΩÆÂà∞Â§ÑÁêÜÂô®ÁöÑ <code>runnext</code> ‰Ωú‰∏∫‰∏ã‰∏Ä‰∏™Â§ÑÁêÜÂô®ÊâßË°åÁöÑ‰ªªÂä°Ôºõ</li>
<li>ÂΩì <code>next</code> ‰∏∫ <code>false</code> Âπ∂‰∏îÊú¨Âú∞ËøêË°åÈòüÂàóËøòÊúâÂâ©‰ΩôÁ©∫Èó¥Êó∂ÔºåÂ∞Ü Goroutine Âä†ÂÖ•Â§ÑÁêÜÂô®ÊåÅÊúâÁöÑÊú¨Âú∞ËøêË°åÈòüÂàóÔºõ</li>
<li>ÂΩìÂ§ÑÁêÜÂô®ÁöÑÊú¨Âú∞ËøêË°åÈòüÂàóÂ∑≤ÁªèÊ≤°ÊúâÂâ©‰ΩôÁ©∫Èó¥Êó∂Â∞±‰ºöÊääÊú¨Âú∞ÈòüÂàó‰∏≠ÁöÑ‰∏ÄÈÉ®ÂàÜ Goroutine ÂíåÂæÖÂä†ÂÖ•ÁöÑ Goroutine ÈÄöËøá <code>runtime.runqputslow</code>Ê∑ªÂä†Âà∞Ë∞ÉÂ∫¶Âô®ÊåÅÊúâÁöÑÂÖ®Â±ÄËøêË°åÈòüÂàó‰∏äÔºõ</li>
</ol>
<p>ËøôÈáåÂèñÂÖ®Â±ÄÈòüÂàóÁöÑGoroutineÊï∞ÁõÆÂàöÂ•Ω‰∏∫n = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2))</p>
<h3 id="13-schedule">1.3. Schedule</h3>
<h4 id="131-m0-g0">1.3.1. M0, G0</h4>
<p>goËØ≠Ë®ÄÁöÑÂêØÂä®ÊµÅÁ®ãÁÆÄÂçïÁ§∫ÊÑèËßÅ‰∏ãÊ≥®Èáä</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The bootstrap sequence is:
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// call osinit
</span></span></span><span class="line"><span class="cl"><span class="c1">// call schedinit
</span></span></span><span class="line"><span class="cl"><span class="c1">// make &amp; queue new G
</span></span></span><span class="line"><span class="cl"><span class="c1">// call runtime¬∑mstart
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// The new G calls runtime¬∑main.
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Ê≠§Â§ñÔºåruntime/proc‰∏ã‰πüÂÆö‰πâ‰∫ÜÂàùÂßãÁä∂ÊÄÅ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">m0</span>           <span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nx">g0</span>           <span class="nx">g</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mcache0</span>      <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nx">raceprocctx0</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Á®ãÂ∫èÂºÄÂßãÊó∂Ôºå‰ºöÂÖàÊâßË°åschedinitÂàõÂª∫Á¨¨‰∏Ä‰∏™GÔºåmstartÂáΩÊï∞ÂàõÂª∫Á¨¨‰∏Ä‰∏™M</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">ts</span> <span class="nx">cgothreadstart</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_cgo_thread_start</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_thread_start missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">g</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">tls</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="kt">uint64</span><span class="p">)(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mp</span><span class="p">.</span><span class="nx">tls</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">ts</span><span class="p">.</span><span class="nx">fn</span> <span class="p">=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">msanenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">msanwrite</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">asmcgocall</span><span class="p">(</span><span class="nx">_cgo_thread_start</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">ts</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">rlock</span><span class="p">()</span> <span class="c1">// Prevent process clone.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">execLock</span><span class="p">.</span><span class="nf">runlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mstart</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span> <span class="c1">// ËøôÈáåÂàõÂª∫ÁöÑÊòØg0ÔºåÂàÜÈÖçÂú®Á≥ªÁªüÂ†ÜÊ†à
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="nx">osStack</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">==</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">osStack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Initialize stack bounds from system stack.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">size</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">size</span> <span class="p">=</span> <span class="mi">8192</span> <span class="o">*</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">StackGuardMultiplier</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="p">=</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nf">noescape</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">size</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span> <span class="o">-</span> <span class="nx">size</span> <span class="o">+</span> <span class="mi">1024</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Initialize stack guard so that we can start calling regular
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Go code.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// This is the g0, so we can also call go:systemstack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// functions, which check stackguard1.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard1</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mstart1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Exit this thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nf">mStackIsSystemAllocated</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">osStack</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mexit</span><span class="p">(</span><span class="nx">osStack</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ª•‰∏äÂáΩÊï∞ÂáΩÊï∞‰ºöË∞ÉÁî®mstart1Êù•Â∞Üg0ÁªëÂÆöÂà∞m0‰∏äÔºåÂπ∂ÂºÄÂßãÊâßË°åscheduleË∞ÉÂ∫¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mstart1</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">_g_</span> <span class="o">!=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad runtime¬∑mstart&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Record the caller for use as the top of stack in mcall and
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// for terminating the thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// We&#39;re never coming back to mstart1 after we call schedule,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// so other calls can reuse the current frame.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">save</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nf">getcallersp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nf">asminit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">minit</span><span class="p">()</span>  <span class="c1">// Â∞ÜMËøõË°åÂàùÂßãÂåñÔºåËÆæÁΩÆÁ∫øÁ®ãÁöÑÂ§áÁî®‰ø°Âè∑Â†ÜÊ†àÂíå‰ø°Âè∑Êé©Á†Å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Install signal handlers; after minit so that minit can
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// prepare the thread to be able to handle the signals.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">==</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">mstartm0</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mstartfn</span><span class="p">;</span> <span class="nx">fn</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">      <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">nextp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// mstartm0 implements part of mstart1 that only runs on the m0.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Write barriers are allowed here because we know the GC can&#39;t be
</span></span></span><span class="line"><span class="cl"><span class="c1">// running yet, so they&#39;ll be no-ops.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">mstartm0</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create an extra M for callbacks on threads not created by Go.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// An extra M is also needed on Windows for callbacks created by
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// syscall.NewCallback. See issue #6751 for details.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">iscgo</span> <span class="o">||</span> <span class="nx">GOOS</span> <span class="o">==</span> <span class="s">&#34;windows&#34;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">cgoHasExtraM</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">cgoHasExtraM</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">        <span class="nf">newextram</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initsig</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>mstart1() Âú®ÁªìÊùüÈò∂ÊÆµÔºå‰ºöË∞ÉÁî®scheduleÔºåËÄåscheduleÂú®Êú¨Âú∞ÈòüÂàó‰∏≠Á¨¨‰∏ÄÊ¨°‰ºöÊâæÂà∞main goroutineÔºåËÄåÁ¨¨‰∏Ä‰∏™goroutineÁªëÂÆöÁöÑÊñπÊ≥ïÂ∞±ÊòØmainÔºåËÄåmainÊñπÊ≥ïÂÆåÊàê‰ª•‰∏ãÊìç‰ΩúÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// The main goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">g</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Racectx of m0-&gt;g0 is used only as the parent of the main goroutine.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// It must not be used for anything else.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">g</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">racectx</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Using decimal instead of binary GB and MB because
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// they look nicer in the stack overflow failure message.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">PtrSize</span> <span class="o">==</span> <span class="mi">8</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxstacksize</span> <span class="p">=</span> <span class="mi">1000000000</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">maxstacksize</span> <span class="p">=</span> <span class="mi">250000000</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// An upper limit for max stack size. Used to avoid random crashes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// after calling SetMaxStack and trying to allocate a stack that is too big,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// since stackalloc works with 32-bit sizes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">maxstackceiling</span> <span class="p">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">maxstacksize</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Allow newproc to start new Ms.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">mainStarted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">!=</span> <span class="s">&#34;wasm&#34;</span> <span class="p">{</span> <span class="c1">// no threads on wasm yet, so no sysmon
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// For runtime_syscall_doAllThreadsSyscall, we
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// register sysmon is not ready for the world to be
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// stopped.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonStarting</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">newm</span><span class="p">(</span><span class="nx">sysmon</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Lock the main goroutine onto this, the main OS thread,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// during initialization. Most programs won&#39;t care, but a few
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// do require certain calls to be made by the main thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Those can arrange for main.main to run in the main thread
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// by calling runtime.LockOSThread during initialization
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// to preserve the lock.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">lockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">g</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">m0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;runtime.main not on m0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">m0</span><span class="p">.</span><span class="nx">doesPark</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Record when the world started.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Must be before doInit for tracing init.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">runtimeInitTime</span> <span class="p">=</span> <span class="nf">nanotime</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">runtimeInitTime</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;nanotime returning zero&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">debug</span><span class="p">.</span><span class="nx">inittrace</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inittrace</span><span class="p">.</span><span class="nx">id</span> <span class="p">=</span> <span class="nf">getg</span><span class="p">().</span><span class="nx">goid</span>
</span></span><span class="line"><span class="cl">      <span class="nx">inittrace</span><span class="p">.</span><span class="nx">active</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">doInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runtime_inittask</span><span class="p">)</span> <span class="c1">// Must be before defer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Defer unlock so that runtime.Goexit during init does the unlock too.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">needUnlock</span> <span class="o">:=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">needUnlock</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">unlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">gcenable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">main_init_done</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">_cgo_thread_start</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_thread_start missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;windows&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">_cgo_setenv</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_setenv missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">_cgo_unsetenv</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_unsetenv missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">_cgo_notify_runtime_init_done</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;_cgo_notify_runtime_init_done missing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Start the template thread in case we enter Go from
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// a C-created thread and need to create a new thread.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nf">startTemplateThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nf">cgocall</span><span class="p">(</span><span class="nx">_cgo_notify_runtime_init_done</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">doInit</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">main_inittask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Disable init tracing after main init done to avoid overhead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// of collecting statistics in malloc and newproc
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">inittrace</span><span class="p">.</span><span class="nx">active</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nb">close</span><span class="p">(</span><span class="nx">main_init_done</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nx">needUnlock</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">   <span class="nf">unlockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">isarchive</span> <span class="o">||</span> <span class="nx">islibrary</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// A program compiled with -buildmode=c-archive or c-shared
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// has a main, but it is not executed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">fn</span> <span class="o">:=</span> <span class="nx">main_main</span> <span class="c1">// make an indirect call, as the linker doesn&#39;t know the address of the main package when laying down the runtime
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">fn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">raceenabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">racefini</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Make racy client program work: if panicking on
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// another goroutine at the same time as main returns,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// let the other goroutine finish printing the panic trace.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Once it does, it will exit. See issues 3934 and 20018.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Running deferred functions should not take long.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">c</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">c</span> <span class="p">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">c</span><span class="o">++</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">runningPanicDefers</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nf">Gosched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">panicking</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">gopark</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">waitReasonPanicWait</span><span class="p">,</span> <span class="nx">traceEvGoStop</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">x</span> <span class="o">*</span><span class="kt">int32</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="nx">x</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Áªº‰∏äÊâÄËø∞ÔºöGoËØ≠Ë®ÄÂêØÂä®ÊµÅÁ®ãÂèØ‰ª•ÁÆÄÂåñÂ¶Ç‰∏ã</p>
<p>Á°ÆÂÆöÂΩìÂâçÁ≥ªÁªüÁöÑÂπ≥Âè∞ÔºåOSinit</p>
<p>schedinitÔºöÂÅöÂ•ΩÂàùÂßãÂåñ‰∏Ä‰∫õÈîÅÔºåcpuÔºågcÁ≠âÔºå‰πãÂêéË∞ÉÁî®procresize</p>
<p>procresizeÔºöÂ∞ÜÂΩìÂâçÁöÑm0Âíåallp[0]ËøõË°åÁªëÂÆöÔºåÂÜçË∞ÉÁî®</p>
<p>mstartÔºöÂàÜÈÖçgoÁöÑÂ†ÜÊ†àÔºåÂ∞Üm0Âíåg0ÁªëÂÆö</p>
<p>scheduleÔºöË∞ÉÂ∫¶ÂºÄÂßãÔºåÈ¶ñÂÖàÊâßË°åm0ÁöÑg0ÔºåÁªëÂÆöÁöÑÂáΩÊï∞Âç≥‰∏∫main</p>
<p>main goroutineÔºöÂºÄÂßãÂáΩÊï∞ÁöÑÊâßË°åÊµÅ</p>
<h4 id="132-schedinit">1.3.2. Schedinit</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-GO" data-lang="GO"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedinit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">maxmcount</span> <span class="p">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">lastpoll</span> <span class="p">=</span> <span class="nb">uint64</span><span class="p">(</span><span class="nf">nanotime</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="nx">procs</span> <span class="o">:=</span> <span class="nx">ncpu</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nf">atoi32</span><span class="p">(</span><span class="nf">gogetenv</span><span class="p">(</span><span class="s">&#34;GOMAXPROCS&#34;</span><span class="p">));</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">procs</span> <span class="p">=</span> <span class="nx">n</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">procresize</span><span class="p">(</span><span class="nx">procs</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;unknown runnable goroutine during bootstrap&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Â¶ÇÊûúÂÖ®Â±ÄÂèòÈáè <code>allp</code> ÂàáÁâá‰∏≠ÁöÑÂ§ÑÁêÜÂô®Êï∞ÈáèÂ∞ë‰∫éÊúüÊúõÊï∞ÈáèÔºå‰ºöÂØπÂàáÁâáËøõË°åÊâ©ÂÆπÔºõ</li>
<li>‰ΩøÁî® <code>new</code> ÂàõÂª∫Êñ∞ÁöÑÂ§ÑÁêÜÂô®ÁªìÊûÑ‰ΩìÂπ∂Ë∞ÉÁî® <a class="link" href="https://draveness.me/golang/tree/runtime.p.init"  target="_blank" rel="noopener"
    ><code>runtime.p.init</code></a> ÂàùÂßãÂåñÂàöÂàöÊâ©ÂÆπÁöÑÂ§ÑÁêÜÂô®Ôºõ</li>
<li>ÈÄöËøáÊåáÈíàÂ∞ÜÁ∫øÁ®ã m0 ÂíåÂ§ÑÁêÜÂô® <code>allp[0]</code> ÁªëÂÆöÂà∞‰∏ÄËµ∑Ôºõ</li>
<li>Ë∞ÉÁî® <a class="link" href="https://draveness.me/golang/tree/runtime.p.destroy"  target="_blank" rel="noopener"
    ><code>runtime.p.destroy</code></a> ÈáäÊîæ‰∏çÂÜç‰ΩøÁî®ÁöÑÂ§ÑÁêÜÂô®ÁªìÊûÑÔºõ</li>
<li>ÈÄöËøáÊà™Êñ≠ÊîπÂèòÂÖ®Â±ÄÂèòÈáè <code>allp</code> ÁöÑÈïøÂ∫¶‰øùËØÅ‰∏éÊúüÊúõÂ§ÑÁêÜÂô®Êï∞ÈáèÁõ∏Á≠âÔºõ</li>
<li>Â∞ÜÈô§ <code>allp[0]</code> ‰πãÂ§ñÁöÑÂ§ÑÁêÜÂô® P ÂÖ®ÈÉ®ËÆæÁΩÆÊàê <code>_Pidle</code> Âπ∂Âä†ÂÖ•Âà∞ÂÖ®Â±ÄÁöÑÁ©∫Èó≤ÈòüÂàó‰∏≠Ôºõ</li>
</ol>
<h4 id="133-schedule-loop">1.3.3. Schedule Loop</h4>
<p>ÂΩìÁ®ãÂ∫èÁöÑË∞ÉÂ∫¶Âô®ÂêØÂä®‰πãÂêéÔºå‰ºöÊâßË°åschedule()ÂáΩÊï∞Êü•Êâægoroutine</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">schedule</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">top</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">inheritTime</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂèëÁîü‰∫Ü61Ê¨°Ë∞ÉÂ∫¶Ôºå‰∏îÂÖ®Â±ÄÈòüÂàó‰∏ç‰∏∫Á©∫ÔºåÂàôÂéªÂÖ®Â±ÄÈòüÂàó‰∏≠Êâægoroutine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedtick</span><span class="o">%</span><span class="mi">61</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">runqsize</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">gp</span> <span class="p">=</span> <span class="nf">globrunqget</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="p">=</span> <span class="nf">runqget</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">gp</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="p">=</span> <span class="nf">findrunnable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">lockedm</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Hands off own p to the locked m,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// then blocks waiting for a new p.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">startlockedm</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="nx">top</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">inheritTime</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>‰∏∫‰∫Ü‰øùËØÅÂÖ¨Âπ≥ÔºåÂΩìÂÖ®Â±ÄËøêË°åÈòüÂàó‰∏≠ÊúâÂæÖÊâßË°åÁöÑ Goroutine Êó∂ÔºåÈÄöËøá <code>schedtick</code> ‰øùËØÅÊúâ‰∏ÄÂÆöÂá†Áéá‰ºö‰ªéÂÖ®Â±ÄÁöÑËøêË°åÈòüÂàó‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑ GoroutineÔºõ</li>
<li>‰ªéÂ§ÑÁêÜÂô®Êú¨Âú∞ÁöÑËøêË°åÈòüÂàó‰∏≠Êü•ÊâæÂæÖÊâßË°åÁöÑ GoroutineÔºõ</li>
<li>Â¶ÇÊûúÂâç‰∏§ÁßçÊñπÊ≥ïÈÉΩÊ≤°ÊúâÊâæÂà∞ GoroutineÔºå‰ºöÈÄöËøá <code>runtime.findrunnable</code>ËøõË°åÈòªÂ°ûÂú∞Êü•Êâæ GoroutineÔºõ</li>
</ol>
<p>findrunnableÂáΩÊï∞‰ºöÊâßË°å‰ª•‰∏ãÊìç‰ΩúÔºö</p>
<ol>
<li>‰ªéÊú¨Âú∞ËøêË°åÈòüÂàó„ÄÅÂÖ®Â±ÄËøêË°åÈòüÂàó‰∏≠Êü•ÊâæÔºõ</li>
<li>‰ªéÁΩëÁªúËΩÆËØ¢Âô®‰∏≠Êü•ÊâæÊòØÂê¶Êúâ Goroutine Á≠âÂæÖËøêË°åÔºõ</li>
<li>ÈÄöËøá <code>runtime.runqsteal</code>Â∞ùËØï‰ªéÂÖ∂‰ªñÈöèÊú∫ÁöÑÂ§ÑÁêÜÂô®‰∏≠Á™ÉÂèñÂæÖËøêË°åÁöÑ GoroutineÔºåËØ•ÂáΩÊï∞ËøòÂèØËÉΩÁ™ÉÂèñÂ§ÑÁêÜÂô®ÁöÑËÆ°Êó∂Âô®Ôºõ</li>
</ol>
<p>Âú®Ëé∑ÂèñÂà∞Goroutine‰ª•ÂêéÔºåÊúÄÁªà‰ºöË∞ÉÁî®executeÂáΩÊï∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">execute</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">inheritTime</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">curg</span> <span class="p">=</span> <span class="nx">gp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitsince</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">preempt</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">gp</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">lo</span> <span class="o">+</span> <span class="nx">_StackGuard</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">!</span><span class="nx">inheritTime</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">schedtick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">gogo</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">gp</span><span class="p">.</span><span class="nx">sched</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈÄöËøágogoÂáΩÊï∞ÔºåÂ∞ÜËøô‰∏™GoroutineË∞ÉÂ∫¶Âà∞ÂΩìÂâçÁ∫øÁ®ã‰∏äÔºågogoÂáΩÊï∞‰ºö‰ªé <code>runtime.gobuf</code> ‰∏≠ÂèñÂá∫‰∫Ü <code>runtime.goexit</code>ÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®ÂíåÂæÖÊâßË°åÂáΩÊï∞ÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®ÔºåÂÖ∂‰∏≠Ôºö</p>
<ul>
<li><code>runtime.goexit</code> ÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®Ë¢´ÊîæÂà∞‰∫ÜÊ†à SP ‰∏äÔºõ</li>
<li>ÂæÖÊâßË°åÂáΩÊï∞ÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô®Ë¢´ÊîæÂà∞‰∫ÜÂØÑÂ≠òÂô® BX ‰∏äÔºõ</li>
</ul>
<p>ÂΩìËøô‰∏™GoroutineÁªìÊùüÁöÑÊó∂ÂÄôÔºå‰ºöruntime¬∑goexit(SB)ÔºåÂÜçÁªèËøá‰∏ÄÁ≥ªÂàóÂ§çÊùÇÁöÑÂáΩÊï∞Ë∞ÉÁî®ÔºåÊàë‰ª¨ÊúÄÁªàÂú®ÂΩìÂâçÁ∫øÁ®ãÁöÑ g0 ÁöÑÊ†à‰∏äË∞ÉÁî® <code>runtime.goexit0</code>ÂáΩÊï∞ÔºåËØ•ÂáΩÊï∞‰ºöÂ∞Ü Goroutine ËΩ¨Êç¢‰ºö <code>_Gdead</code> Áä∂ÊÄÅ„ÄÅÊ∏ÖÁêÜÂÖ∂‰∏≠ÁöÑÂ≠óÊÆµ„ÄÅÁßªÈô§ Goroutine ÂíåÁ∫øÁ®ãÁöÑÂÖ≥ËÅîÂπ∂Ë∞ÉÁî® <code>runtime.gfput</code>ÈáçÊñ∞Âä†ÂÖ•Â§ÑÁêÜÂô®ÁöÑ Goroutine Á©∫Èó≤ÂàóË°® <code>gFree</code>Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goexit0</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gdead</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">param</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">labels</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">timer</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">gfput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂèØ‰ª•ÁúãÂà∞ÔºåÂú®goexit0Ë∞ÉÁî®ÁªìÊùüÂêéÔºå‰ºöÂÜçÊ¨°Âá∫Âèëschedule()ÈáçÊñ∞ËøõË°å‰∏ÄËΩÆË∞ÉÂ∫¶„ÄÇ</p>
<h3 id="14-trigger-scheduling">1.4. Trigger Scheduling</h3>
<h4 id="140-create">1.4.0. Create</h4>
<p>ËØ¶ÊÉÖËßÅ1.2ÔºåÂú®Á∫øÁ®ãÂêØÂä® <code>runtime.mstart</code>Âíå Goroutine ÊâßË°åÁªìÊùü <code>runtime.goexit0</code>Ëß¶ÂèëË∞ÉÂ∫¶‰πãÂ§ñ„ÄÇËøòÊúâ‰ª•‰∏ãÊñπÊ≥ï‰ºöÊâßË°åÁ≥ªÁªüË∞ÉÂ∫¶Á≠ñÁï•„ÄÇ</p>
<h4 id="141-park">1.4.1. Park</h4>
<p>‰∏ªÂä®ÊåÇËµ∑ÊòØËß¶ÂèëË∞ÉÂ∫¶ÊúÄÂ∏∏ËßÅÁöÑÊñπÊ≥ïÔºåËØ•ÂáΩÊï∞‰ºöÂ∞ÜÂΩìÂâç Goroutine ÊöÇÂÅúÔºåË¢´ÊöÇÂÅúÁöÑ‰ªªÂä°‰∏ç‰ºöÊîæÂõûËøêË°åÈòüÂàó</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">gopark</span><span class="p">(</span><span class="nx">unlockf</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">lock</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">reason</span> <span class="nx">waitReason</span><span class="p">,</span> <span class="nx">traceEv</span> <span class="kt">byte</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span> <span class="o">:=</span> <span class="nx">mp</span><span class="p">.</span><span class="nx">curg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitlock</span> <span class="p">=</span> <span class="nx">lock</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waitunlockf</span> <span class="p">=</span> <span class="nx">unlockf</span>
</span></span><span class="line"><span class="cl">    <span class="nx">gp</span><span class="p">.</span><span class="nx">waitreason</span> <span class="p">=</span> <span class="nx">reason</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceev</span> <span class="p">=</span> <span class="nx">traceEv</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">waittraceskip</span> <span class="p">=</span> <span class="nx">traceskip</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mcall</span><span class="p">(</span><span class="nx">park_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠park_mËøò‰ºöÂ∞ÜÁä∂ÊÄÅÁî±_GrunningÂàáÊç¢‰∏∫_GwaitingÔºåÂπ∂‰∏î‰ΩøÁî®dropgÁßªÈô§ÂΩìÂâçÁ∫øÁ®ãÂíåËøô‰∏™GoroutineÁöÑÂÖ≥ËÅî„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">park_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÜçÈúÄË¶ÅÈáçÊñ∞Âî§ÈÜíÁöÑÊó∂ÂÄôÔºå‰ºöË∞ÉÁî®‰ª•‰∏ãÊñπÊ≥ïËøõË°åÂî§ÈÜíÔºåÂ∞ÜÁä∂ÊÄÅÂàáÊç¢Âõû_Grunnable Âπ∂Â∞ÜÂÖ∂Âä†ÂÖ•Â§ÑÁêÜÂô®ÁöÑËøêË°åÈòüÂàó‰∏≠ÔºåÁ≠âÂæÖË∞ÉÂ∫¶Âô®ÁöÑË∞ÉÂ∫¶„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">traceskip</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">ready</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">,</span> <span class="nx">traceskip</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">next</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Gwaiting</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">runqput</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">(),</span> <span class="nx">gp</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">npidle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">nmspinning</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">wakep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="142-system-call">1.4.2. System call</h4>
<p>Go ËØ≠Ë®ÄÈÄöËøá <code>syscall.Syscall</code>Âíå <code>syscall.RawSyscall</code>Á≠â‰ΩøÁî®Ê±áÁºñËØ≠Ë®ÄÁºñÂÜôÁöÑÊñπÊ≥ïÂ∞ÅË£ÖÊìç‰ΩúÁ≥ªÁªüÊèê‰æõÁöÑÊâÄÊúâÁ≥ªÁªüË∞ÉÁî®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">#define INVOKE_SYSCALL    INT    $0x80
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">TEXT ¬∑Syscall(SB),NOSPLIT,$0-28
</span></span><span class="line"><span class="cl">    CALL    runtime¬∑entersyscall(SB)
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    INVOKE_SYSCALL
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    CALL    runtime¬∑exitsyscall(SB)
</span></span><span class="line"><span class="cl">    RET
</span></span><span class="line"><span class="cl">ok:
</span></span><span class="line"><span class="cl">    ...
</span></span><span class="line"><span class="cl">    CALL    runtime¬∑exitsyscall(SB)
</span></span><span class="line"><span class="cl">    RET
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go‰ΩøÁî®‰∫ÜentrysyscallÂíåexitsyscallÂÆåÊàêÁ≥ªÁªüË∞ÉÁî®Êó∂ÁöÑÂáÜÂ§á‰∏éÊ∏ÖÁêÜÂ∑•‰ΩúÔºåÂØπ‰∫é‰∏çÈúÄË¶ÅËøêË°åÊó∂ÂèÇ‰∏éÁöÑÁ≥ªÁªüË∞ÉÁî®ÔºåÊØîÂ¶ÇSYS_TIMEÔºåSYS_EPOLL_WAITÔºåGoÂ∞ÅË£Ö‰∫Ü‰∏ÄÂ±ÇRawSyscallÊù•Ë∞ÉÁî®„ÄÇ</p>
<p>Âú®Ë∞ÉÁî®entrysyscall‰ºöË∞ÉÁî®reentersyscallÂáΩÊï∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:linkname entersyscall
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">entersyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">reentersyscall</span><span class="p">(</span><span class="nf">getcallerpc</span><span class="p">(),</span> <span class="nf">getcallersp</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">reentersyscall</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span> <span class="kt">uintptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">stackguard0</span> <span class="p">=</span> <span class="nx">stackPreempt</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallsp</span> <span class="p">=</span> <span class="nx">sp</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">syscallpc</span> <span class="p">=</span> <span class="nx">pc</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">syscalltick</span> <span class="p">=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">mcache</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pp</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">pp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">sched</span><span class="p">.</span><span class="nx">gcwaiting</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="nx">entersyscall_gcwait</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">save</span><span class="p">(</span><span class="nx">pc</span><span class="p">,</span> <span class="nx">sp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">locks</span><span class="o">--</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Á¶ÅÊ≠¢Á∫øÁ®ã‰∏äÂèëÁîüÁöÑÊä¢Âç†ÔºåÈò≤Ê≠¢Âá∫Áé∞ÂÜÖÂ≠ò‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢òÔºõ</li>
<li>‰øùËØÅÂΩìÂâçÂáΩÊï∞‰∏ç‰ºöËß¶ÂèëÊ†àÂàÜË£ÇÊàñËÄÖÂ¢ûÈïøÔºõ</li>
<li>‰øùÂ≠òÂΩìÂâçÁöÑÁ®ãÂ∫èËÆ°Êï∞Âô® PC ÂíåÊ†àÊåáÈíà SP ‰∏≠ÁöÑÂÜÖÂÆπÔºõ</li>
<li>Â∞Ü Goroutine ÁöÑÁä∂ÊÄÅÊõ¥Êñ∞Ëá≥ <code>_Gsyscall</code>Ôºõ</li>
<li>Â∞Ü Goroutine ÁöÑÂ§ÑÁêÜÂô®ÂíåÁ∫øÁ®ãÊöÇÊó∂ÂàÜÁ¶ªÂπ∂Êõ¥Êñ∞Â§ÑÁêÜÂô®ÁöÑÁä∂ÊÄÅÂà∞ <code>_Psyscall</code>Ôºõ</li>
<li>ÈáäÊîæÂΩìÂâçÁ∫øÁ®ã‰∏äÁöÑÈîÅÔºõ</li>
</ol>
<p>ÂΩìÂâçÁ∫øÁ®ã‰ºöÈô∑ÂÖ•Á≥ªÁªüË∞ÉÁî®Á≠âÂæÖËøîÂõûÔºåÂú®ÈîÅË¢´ÈáäÊîæÂêéÔºå‰ºöÊúâÂÖ∂‰ªñ Goroutine Êä¢Âç†Â§ÑÁêÜÂô®ËµÑÊ∫ê„ÄÇ</p>
<p>ÂΩìÁ≥ªÁªüË∞ÉÁî®ÁªìÊùüÂêéÔºå‰ºöÂÜçÊ¨°ËøîÂõû</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">exitsyscall</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">oldp</span> <span class="o">:=</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span><span class="p">.</span><span class="nf">ptr</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">oldp</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nf">exitsyscallfast</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">        <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">_g_</span><span class="p">,</span> <span class="nx">_Gsyscall</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">mcall</span><span class="p">(</span><span class="nx">exitsyscall0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">syscalltick</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">throwsplit</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ∂‰∏≠exitsyscallfast‰ºöÊúâ‰∏§Áßç‰∏çÂêåÁöÑÂàÜÊîØÔºö</p>
<ol>
<li>Â¶ÇÊûú Goroutine ÁöÑÂéüÂ§ÑÁêÜÂô®Â§Ñ‰∫é <code>_Psyscall</code> Áä∂ÊÄÅÔºå‰ºöÁõ¥Êé•Ë∞ÉÁî® <code>wirep</code> Â∞Ü Goroutine ‰∏éÂ§ÑÁêÜÂô®ËøõË°åÂÖ≥ËÅîÔºõ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">    <span class="c1">// Try to re-acquire the last P.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">oldp</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="nx">_Psyscall</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Cas</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">oldp</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="nx">_Psyscall</span><span class="p">,</span> <span class="nx">_Pidle</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// There&#39;s a cpu for us, so we can run.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">wirep</span><span class="p">(</span><span class="nx">oldp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exitsyscallfast_reacquired</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Â¶ÇÊûúË∞ÉÂ∫¶Âô®‰∏≠Â≠òÂú®Èó≤ÁΩÆÁöÑÂ§ÑÁêÜÂô®Ôºå‰ºöË∞ÉÁî® <code>acquirep</code>‰ΩøÁî®Èó≤ÁΩÆÁöÑÂ§ÑÁêÜÂô®Â§ÑÁêÜÂΩìÂâç GoroutineÔºõ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">exitsyscallfast_pidle</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span> <span class="o">:=</span> <span class="nf">pidleget</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">atomic</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonwait</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">notewakeup</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">sysmonnote</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Associate p and the current m.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// This function is allowed to have write barriers even if the caller
</span></span></span><span class="line"><span class="cl"><span class="c1">// isn&#39;t because it immediately acquires _p_.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:yeswritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">acquirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Do the part that isn&#39;t allowed to have write barriers.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Have p; write barriers now allowed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Perform deferred mcache flush before this P can allocate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// from a potentially stale mcache.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">_p_</span><span class="p">.</span><span class="nx">mcache</span><span class="p">.</span><span class="nf">prepareForSweep</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceProcStart</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// wirep is the first step of acquirep, which actually associates the
</span></span></span><span class="line"><span class="cl"><span class="c1">// current M to _p_. This is broken out so we can disallow write
</span></span></span><span class="line"><span class="cl"><span class="c1">// barriers for this part, since we don&#39;t yet have a P.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nowritebarrierrec
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:nosplit
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">wirep</span><span class="p">(</span><span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: already in go&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="nx">_Pidle</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">id</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">id</span> <span class="p">=</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">ptr</span><span class="p">().</span><span class="nx">id</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s">&#34;wirep: p-&gt;m=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="s">&#34;(&#34;</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#34;) p-&gt;status=&#34;</span><span class="p">,</span> <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span><span class="p">,</span> <span class="s">&#34;\n&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;wirep: invalid p state&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">p</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_p_</span><span class="p">.</span><span class="nx">status</span> <span class="p">=</span> <span class="nx">_Prunning</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âè¶‰∏Ä‰∏™Áõ∏ÂØπËæÉÊÖ¢ÁöÑË∑ØÂæÑ <a class="link" href="https://draveness.me/golang/tree/runtime.exitsyscall0"  target="_blank" rel="noopener"
    ><code>runtime.exitsyscall0</code></a> ‰ºöÂ∞ÜÂΩìÂâç Goroutine ÂàáÊç¢Ëá≥ <code>_Grunnable</code> Áä∂ÊÄÅÔºåÂπ∂ÁßªÈô§Á∫øÁ®ã M ÂíåÂΩìÂâç Goroutine ÁöÑÂÖ≥ËÅîÔºö</p>
<ol>
<li>ÂΩìÊàë‰ª¨ÈÄöËøá <a class="link" href="https://draveness.me/golang/tree/runtime.pidleget"  target="_blank" rel="noopener"
    ><code>runtime.pidleget</code></a> Ëé∑ÂèñÂà∞Èó≤ÁΩÆÁöÑÂ§ÑÁêÜÂô®Êó∂Â∞±‰ºöÂú®ËØ•Â§ÑÁêÜÂô®‰∏äÊâßË°å GoroutineÔºõ</li>
<li>Âú®ÂÖ∂ÂÆÉÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨‰ºöÂ∞ÜÂΩìÂâç Goroutine ÊîæÂà∞ÂÖ®Â±ÄÁöÑËøêË°åÈòüÂàó‰∏≠ÔºåÁ≠âÂæÖË∞ÉÂ∫¶Âô®ÁöÑË∞ÉÂ∫¶Ôºõ</li>
</ol>
<p>Êó†ËÆ∫Âì™ÁßçÊÉÖÂÜµÔºåÊàë‰ª¨Âú®Ëøô‰∏™ÂáΩÊï∞‰∏≠ÈÉΩ‰ºöË∞ÉÁî® <a class="link" href="https://draveness.me/golang/tree/runtime.schedule"  target="_blank" rel="noopener"
    ><code>runtime.schedule</code></a> Ëß¶ÂèëË∞ÉÂ∫¶Âô®ÁöÑË∞ÉÂ∫¶„ÄÇ</p>
<h4 id="143-cooperative">1.4.3. Cooperative</h4>
<p>ËØ•ÊñπÊ≥ï‰∏ç‰ºöÊåÇËµ∑GoroutineÔºåËÄåÊòØÂ∞ÜÂΩìÂâçÁöÑGoroutineË∞ÉÂ∫¶Âà∞ÂÖ∂‰ªñÁ∫øÁ®ã‰∏ä</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Gosched yields the processor, allowing other goroutines to run. It does not
</span></span></span><span class="line"><span class="cl"><span class="c1">// suspend the current goroutine, so execution resumes automatically.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">Gosched</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nf">checkTimeouts</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">mcall</span><span class="p">(</span><span class="nx">gosched_m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Gosched continuation on g0.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">gosched_m</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">trace</span><span class="p">.</span><span class="nx">enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">traceGoSched</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">goschedImpl</span><span class="p">(</span><span class="nx">gp</span> <span class="o">*</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">status</span> <span class="o">:=</span> <span class="nf">readgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">status</span><span class="o">&amp;^</span><span class="nx">_Gscan</span> <span class="o">!=</span> <span class="nx">_Grunning</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">dumpgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">throw</span><span class="p">(</span><span class="s">&#34;bad g status&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">casgstatus</span><span class="p">(</span><span class="nx">gp</span><span class="p">,</span> <span class="nx">_Grunning</span><span class="p">,</span> <span class="nx">_Grunnable</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dropg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">globrunqput</span><span class="p">(</span><span class="nx">gp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">sched</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">schedule</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøêË°åÊó∂‰ºöÊõ¥Êñ∞ Goroutine ÁöÑÁä∂ÊÄÅÂà∞ <code>_Grunnable</code>ÔºåËÆ©Âá∫ÂΩìÂâçÁöÑÂ§ÑÁêÜÂô®Âπ∂Â∞Ü Goroutine ÈáçÊñ∞ÊîæÂõûÂÖ®Â±ÄÈòüÂàóÔºåÂú®ÊúÄÂêéÔºåËØ•ÂáΩÊï∞‰ºöË∞ÉÁî® <code>runtime.schedule</code> Ëß¶ÂèëË∞ÉÂ∫¶„ÄÇ</p>
<h3 id="15-thread-control">1.5. Thread Control</h3>
<p>Goroutine Â∫îËØ•Âú®Ë∞ÉÁî®Êìç‰ΩúÁ≥ªÁªüÊúçÂä°ÊàñËÄÖ‰æùËµñÁ∫øÁ®ãÁä∂ÊÄÅÁöÑÈùû Go ËØ≠Ë®ÄÂ∫ìÊó∂Ë∞ÉÁî®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">LockOSThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">atomic</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">newmHandoff</span><span class="p">.</span><span class="nx">haveTemplateThread</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">GOOS</span> <span class="o">!=</span> <span class="s">&#34;plan9&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">startTemplateThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedExt</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">dolockOSThread</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">dolockOSThread</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span> <span class="o">:=</span> <span class="nf">getg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nx">lockedg</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">_g_</span><span class="p">.</span><span class="nx">lockedm</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_g_</span><span class="p">.</span><span class="nx">m</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ºöÂàÜÂà´ËÆæÁΩÆÁ∫øÁ®ãÁöÑ <code>lockedg</code> Â≠óÊÆµÂíå Goroutine ÁöÑ <code>lockedm</code> Â≠óÊÆµÔºåËøô‰∏§Ë°å‰ª£Á†Å‰ºöÁªëÂÆöÁ∫øÁ®ãÂíå Goroutine„ÄÇ</p>
<p>ÂΩìGoroutineÂÆåÊàêÊìç‰Ωú‰πãÂêéÔºå‰ºö‰ΩøÁî®Â¶Ç‰∏ãÊñπÊ≥ïÂàÜÁ¶ªGoroutineÂíåÁ∫øÁ®ã„ÄÇ</p>
<p>Go ËØ≠Ë®ÄÁöÑËøêË°åÊó∂‰ºöÈÄöËøá <a class="link" href="https://draveness.me/golang/tree/runtime.startm"  target="_blank" rel="noopener"
    ><code>runtime.startm</code></a> ÂêØÂä®Á∫øÁ®ãÊù•ÊâßË°åÂ§ÑÁêÜÂô® PÔºåÂ¶ÇÊûúÊàë‰ª¨Âú®ËØ•ÂáΩÊï∞‰∏≠Ê≤°ËÉΩ‰ªéÈó≤ÁΩÆÂàóË°®‰∏≠Ëé∑ÂèñÂà∞Á∫øÁ®ã M Â∞±‰ºöË∞ÉÁî® <a class="link" href="https://draveness.me/golang/tree/runtime.newm"  target="_blank" rel="noopener"
    ><code>runtime.newm</code></a> ÂàõÂª∫Êñ∞ÁöÑÁ∫øÁ®ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">,</span> <span class="nx">id</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">,</span> <span class="nx">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">iscgo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËØ•ÂáΩÊï∞Âú® Linux Âπ≥Âè∞‰∏ä‰ºöÈÄöËøáÁ≥ªÁªüË∞ÉÁî® <code>clone</code> ÂàõÂª∫Êñ∞ÁöÑÊìç‰ΩúÁ≥ªÁªüÁ∫øÁ®ãÔºåÂÆÉ‰πüÊòØÂàõÂª∫Á∫øÁ®ãÈìæË∑Ø‰∏äË∑ùÁ¶ªÊìç‰ΩúÁ≥ªÁªüÊúÄËøëÁöÑ Go ËØ≠Ë®ÄÂáΩÊï∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stk</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">clone</span><span class="p">(</span><span class="nx">cloneFlags</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="2-system-monitor">2. System Monitor</h2>
<p>Âú®Á®ãÂ∫èÂêØÂä®ÂâçÔºå‰ºöÈ¶ñÂÖàË∞ÉÁî®runtime.mainÂáΩÊï∞ÔºåÂÖ∂‰∏≠Â∞±ÂåÖÊã¨‰∫ÜsysmonÁöÑÂàõÂª∫</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">GOARCH</span> <span class="o">!=</span> <span class="s">&#34;wasm&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">newm</span><span class="p">(</span><span class="nx">sysmon</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newm</span><span class="p">(</span><span class="nx">fn</span> <span class="kd">func</span><span class="p">(),</span> <span class="nx">_p_</span> <span class="o">*</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">allocm</span><span class="p">(</span><span class="nx">_p_</span><span class="p">,</span> <span class="nx">fn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">nextp</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">_p_</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">sigmask</span> <span class="p">=</span> <span class="nx">initSigmask</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nf">newm1</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>newm1‰ºöË∞ÉÁî®ÁâπÂÆöÂπ≥Âè∞ÁöÑ <a class="link" href="https://draveness.me/golang/tree/runtime.newosproc"  target="_blank" rel="noopener"
    ><code>runtime.newosproc</code></a> ÈÄöËøáÁ≥ªÁªüË∞ÉÁî® <code>clone</code> ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÁ∫øÁ®ãÂπ∂Âú®Êñ∞ÁöÑÁ∫øÁ®ã‰∏≠ÊâßË°å <a class="link" href="https://draveness.me/golang/tree/runtime.mstart"  target="_blank" rel="noopener"
    ><code>runtime.mstart</code></a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">newosproc</span><span class="p">(</span><span class="nx">mp</span> <span class="o">*</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">stk</span> <span class="o">:=</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">.</span><span class="nx">stack</span><span class="p">.</span><span class="nx">hi</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">oset</span> <span class="nx">sigset</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">sigset_all</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ret</span> <span class="o">:=</span> <span class="nf">clone</span><span class="p">(</span><span class="nx">cloneFlags</span><span class="p">,</span> <span class="nx">stk</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">mp</span><span class="p">.</span><span class="nx">g0</span><span class="p">),</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nf">funcPC</span><span class="p">(</span><span class="nx">mstart</span><span class="p">)))</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sigprocmask</span><span class="p">(</span><span class="nx">_SIG_SETMASK</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">oset</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âú®Êñ∞Âª∫Á∫øÁ®ãÊó∂Ôºå‰ºöÊâßË°åruntime.m‰∏≠ÁöÑsysmonÂêØÂä®ÁõëÊéß</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">sysmon</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">sched</span><span class="p">.</span><span class="nx">nmsys</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="nf">checkdead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">lasttrace</span> <span class="o">:=</span> <span class="nb">int64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">idle</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">delay</span> <span class="o">:=</span> <span class="nb">uint32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">idle</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="p">=</span> <span class="mi">20</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">idle</span> <span class="p">&gt;</span> <span class="mi">50</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="o">*=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">delay</span> <span class="p">&gt;</span> <span class="mi">10</span><span class="o">*</span><span class="mi">1000</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">delay</span> <span class="p">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1000</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">usleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂΩìËøêË°åÊó∂ÂàöÂàöË∞ÉÁî®‰∏äËø∞ÂáΩÊï∞Êó∂Ôºå‰ºöÂÖàÈÄöËøá <a class="link" href="https://draveness.me/golang/tree/runtime.checkdead"  target="_blank" rel="noopener"
    ><code>runtime.checkdead</code></a> Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Ê≠ªÈîÅÔºåÁÑ∂ÂêéËøõÂÖ•Ê†∏ÂøÉÁöÑÁõëÊéßÂæ™ÁéØÔºõÁ≥ªÁªüÁõëÊéßÂú®ÊØèÊ¨°Âæ™ÁéØÂºÄÂßãÊó∂ÈÉΩ‰ºöÈÄöËøá <code>usleep</code> ÊåÇËµ∑ÂΩìÂâçÁ∫øÁ®ãÔºåËØ•ÂáΩÊï∞ÁöÑÂèÇÊï∞ÊòØÂæÆÁßíÔºåËøêË°åÊó∂‰ºöÈÅµÂæ™‰ª•‰∏ãÁöÑËßÑÂàôÂÜ≥ÂÆö‰ºëÁú†Êó∂Èó¥Ôºö</p>
<ul>
<li>ÂàùÂßãÁöÑ‰ºëÁú†Êó∂Èó¥ÊòØ 20ŒºsÔºõ</li>
<li>ÊúÄÈïøÁöÑ‰ºëÁú†Êó∂Èó¥ÊòØ 10msÔºõ</li>
<li>ÂΩìÁ≥ªÁªüÁõëÊéßÂú® 50 ‰∏™Âæ™ÁéØ‰∏≠ÈÉΩÊ≤°ÊúâÂî§ÈÜí Goroutine Êó∂Ôºå‰ºëÁú†Êó∂Èó¥Âú®ÊØè‰∏™Âæ™ÁéØÈÉΩ‰ºöÂÄçÂ¢ûÔºõ</li>
</ul>
<p>ÂΩìÁ®ãÂ∫èË∂ã‰∫éÁ®≥ÂÆö‰πãÂêéÔºåÁ≥ªÁªüÁõëÊéßÁöÑËß¶ÂèëÊó∂Èó¥Â∞±‰ºöÁ®≥ÂÆöÂú® 10ms„ÄÇÂÆÉÈô§‰∫Ü‰ºöÊ£ÄÊü•Ê≠ªÈîÅ‰πãÂ§ñÔºåËøò‰ºöÂú®Âæ™ÁéØ‰∏≠ÂÆåÊàê‰ª•‰∏ãÁöÑÂ∑•‰ΩúÔºö</p>
<ul>
<li>ËøêË°åËÆ°Êó∂Âô® ‚Äî Ëé∑Âèñ‰∏ã‰∏Ä‰∏™ÈúÄË¶ÅË¢´Ëß¶ÂèëÁöÑËÆ°Êó∂Âô®Ôºõ</li>
<li>ËΩÆËØ¢ÁΩëÁªú ‚Äî Ëé∑ÂèñÈúÄË¶ÅÂ§ÑÁêÜÁöÑÂà∞ÊúüÊñá‰ª∂ÊèèËø∞Á¨¶Ôºõ</li>
<li>Êä¢Âç†Â§ÑÁêÜÂô® ‚Äî Êä¢Âç†ËøêË°åÊó∂Èó¥ËæÉÈïøÁöÑÊàñËÄÖÂ§Ñ‰∫éÁ≥ªÁªüË∞ÉÁî®ÁöÑ GoroutineÔºõ</li>
<li>ÂûÉÂúæÂõûÊî∂ ‚Äî Âú®Êª°Ë∂≥Êù°‰ª∂Êó∂Ëß¶ÂèëÂûÉÂúæÊî∂ÈõÜÂõûÊî∂ÂÜÖÂ≠òÔºõ</li>
</ul>
<h2 id="3-stack-and-heap">3. Stack And Heap</h2>
<h3 id="31-traditional-language">3.1. Traditional Language</h3>
<ol>
<li>
<p>Ê†à‰∏ÄËà¨Áî±Êìç‰ΩúÁ≥ªÁªüÊù•ÂàÜÈÖçÂíåÈáäÊîæÔºåÂ†ÜÁî±Á®ãÂ∫èÂëòÈÄöËøáÁºñÁ®ãËØ≠Ë®ÄÊù•Áî≥ËØ∑ÂàõÂª∫‰∏éÈáäÊîæ„ÄÇ</p>
</li>
<li>
<p>Ê†àÁî®Êù•Â≠òÊîæÂáΩÊï∞ÁöÑÂèÇÊï∞„ÄÅËøîÂõûÂÄº„ÄÅÂ±ÄÈÉ®ÂèòÈáè„ÄÅÂáΩÊï∞Ë∞ÉÁî®Êó∂ÁöÑ‰∏¥Êó∂‰∏ä‰∏ãÊñáÁ≠âÔºåÂ†ÜÁî®Êù•Â≠òÊîæÂÖ®Â±ÄÂèòÈáè„ÄÇÊàë‰ª¨ÂèØ‰ª•ËøôÊ†∑ÁêÜËß£Êï∞ÊçÆÂ≠òÊîæÁöÑËßÑÂàôÔºöÂè™Ë¶ÅÊòØÂ±ÄÈÉ®ÁöÑ„ÄÅÂç†Áî®Á©∫Èó¥Á°ÆÂÆöÁöÑÊï∞ÊçÆÔºå‰∏ÄËà¨ÈÉΩÂ≠òÊîæÂú®stack ÈáåÈù¢ÔºåÂê¶ÂàôÂ∞±ÊîæÂú® heap ÈáåÈù¢„ÄÇ</p>
</li>
<li>
<p>Ê†àÁöÑËÆøÈóÆÈÄüÂ∫¶Áõ∏ÂØπÊØîÂ†ÜÂø´„ÄÇ</p>
</li>
<li>
<p>‰∏ÄËà¨Êù•ËØ¥ÔºåÊØè‰∏™Á∫øÁ®ãÂàÜÈÖç‰∏Ä‰∏™stackÔºåÊØè‰∏™ËøõÁ®ãÂàÜÈÖç‰∏Ä‰∏™heapÔºå‰πüÂ∞±ÊòØËØ¥Ôºåstack ÊòØÁ∫øÁ®ãÁã¨Âç†ÁöÑÔºåheap ÊòØÁ∫øÁ®ãÂÖ±Áî®ÁöÑ„ÄÇ</p>
</li>
<li>
<p>stack ÂàõÂª∫ÁöÑÊó∂ÂÄôÔºåÂ§ßÂ∞èÊòØÁ°ÆÂÆöÁöÑÔºåÊï∞ÊçÆË∂ÖËøáËøô‰∏™Â§ßÂ∞èÔºåÂ∞±ÂèëÁîüstack overflow ÈîôËØØÔºåËÄåheapÁöÑÂ§ßÂ∞èÊòØ‰∏çÁ°ÆÂÆöÁöÑÔºåÈúÄË¶ÅÁöÑËØùÂèØ‰ª•‰∏çÊñ≠Â¢ûÂä†„ÄÇ</p>
</li>
<li>
<p>Ê†àÊòØÁî±È´òÂú∞ÂùÄÂêë‰ΩéÂú∞ÂùÄÂ¢ûÈïøÁöÑÔºåËÄåÂ†ÜÊòØÁî±‰ΩéÂú∞ÂùÄÂêëÈ´òÂú∞ÂùÄÂ¢ûÈïøÁöÑ„ÄÇ</p>
<p>Âú®GoËØ≠Ë®Ä‰∏≠ÔºåÂÆòÊñπÂØπÂ†ÜÊ†àÁÆ°ÁêÜÂÅö‰∫ÜÂ¶Ç‰∏ãÁöÑËß£Èáä
Âè™Ë¶ÅÊúâÂØπÂèòÈáèÁöÑÂºïÁî®ÔºåÂèòÈáèÂ∞±‰ºöÂ≠òÂú®ÔºåËÄåÂÆÉÂ≠òÂÇ®ÁöÑ‰ΩçÁΩÆ‰∏éËØ≠Ë®ÄÁöÑËØ≠‰πâÊó†ÂÖ≥„ÄÇÂ¶ÇÊûúÂèØËÉΩÔºåÂèòÈáè‰ºöË¢´ÂàÜÈÖçÂà∞ÂÖ∂ÂáΩÊï∞ÁöÑÊ†àÔºå‰ΩÜÂ¶ÇÊûúÁºñËØëÂô®Êó†Ê≥ïËØÅÊòéÂáΩÊï∞ËøîÂõû‰πãÂêéÂèòÈáèÊòØÂê¶‰ªçÁÑ∂Ë¢´ÂºïÁî®ÔºåÂ∞±ÂøÖÈ°ªÂú®Â†Ü‰∏äÂàÜÈÖçËØ•ÂèòÈáèÔºåÈááÁî®ÂûÉÂúæÂõûÊî∂Êú∫Âà∂ËøõË°å    ÁÆ°ÁêÜÔºå‰ªéËÄåÈÅøÂÖçÊåáÈíàÊÇ¨Á©∫„ÄÇÊ≠§Â§ñÔºåÂ±ÄÈÉ®ÂèòÈáèÂ¶ÇÊûúÈùûÂ∏∏Â§ßÔºå‰πü‰ºöÂ≠òÂú®Â†Ü‰∏ä„ÄÇ</p>
</li>
</ol>
<p>Âú®ÁºñËØëÂô®‰∏≠ÔºåÂ¶ÇÊûúÂèòÈáèÂÖ∑ÊúâÂú∞ÂùÄÔºåÂ∞±‰Ωú‰∏∫Â†ÜÂàÜÈÖçÁöÑÂÄôÈÄâÔºå‰ΩÜÂ¶ÇÊûúÈÄÉÈÄ∏ÂàÜÊûêÂèØ‰ª•Á°ÆÂÆöÂÖ∂ÁîüÂ≠òÂë®Êúü‰∏ç‰ºöË∂ÖËøáÂáΩÊï∞ËøîÂõûÔºåÂ∞±‰ºöÂàÜÈÖçÂú®Ê†à‰∏ä„ÄÇ</p>
<h3 id="32-implement">3.2. Implement</h3>
<p>Go ÁöÑÂÜÖÂ≠òÂàÜÈÖçÂô®Âü∫‰∫é Thread-Cache Malloc (tcmalloc) Ôºåtcmalloc ‰∏∫ÊØè‰∏™Á∫øÁ®ãÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Êú¨Âú∞ÁºìÂ≠òÔºå Âå∫ÂàÜ‰∫ÜÂ∞èÂØπË±°ÔºàÂ∞è‰∫é 32kbÔºâÂíåÂ§ßÂØπË±°ÂàÜÈÖç‰∏§ÁßçÂàÜÈÖçÁ±ªÂûãÔºåÂÖ∂ÁÆ°ÁêÜÁöÑÂÜÖÂ≠òÂçïÂÖÉÁß∞‰∏∫ span„ÄÇ</p>
<ul>
<li>heapArena: ‰øùÁïôÊï¥‰∏™ËôöÊãüÂú∞ÂùÄÁ©∫Èó¥</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// A heapArena stores metadata for a heap arena. heapArenas are stored
</span></span></span><span class="line"><span class="cl"><span class="c1">// outside of the Go heap and accessed via the mheap_.arenas index.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">heapArena</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">bitmap</span>     <span class="p">[</span><span class="nx">heapArenaBitmapBytes</span><span class="p">]</span><span class="kt">byte</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spans</span>      <span class="p">[</span><span class="nx">pagesPerArena</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span>  <span class="c1">// spans maps from virtual address page ID within this arena to *mspan.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">pageInUse</span>  <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pageMarks</span>  <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">pageSpecials</span> <span class="p">[</span><span class="nx">pagesPerArena</span> <span class="o">/</span> <span class="mi">8</span><span class="p">]</span><span class="kt">uint8</span>
</span></span><span class="line"><span class="cl">    <span class="nx">checkmarks</span> <span class="o">*</span><span class="nx">checkmarksMap</span>
</span></span><span class="line"><span class="cl">    <span class="nx">zeroedBase</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//arenaHint is a hint for where to grow the heap arenas. See
</span></span></span><span class="line"><span class="cl"><span class="c1">// mheap_.arenaHints.
</span></span></span><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">arenaHint</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">addr</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">down</span> <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nx">next</span> <span class="o">*</span><span class="nx">arenaHint</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>mheapÔºöÂàÜÈÖçÁöÑÂ†ÜÔºåÂú®È°µÂ§ßÂ∞è‰∏∫ 8KB ÁöÑÁ≤íÂ∫¶‰∏äËøõË°åÁÆ°ÁêÜ</p>
<p>ÁÑ∂ËÄåÁÆ°ÁêÜ arena Â¶ÇÊ≠§Á≤íÂ∫¶ÁöÑÂÜÖÂ≠òÂπ∂‰∏çÁ¨¶ÂêàÂÆûË∑µÔºåÁõ∏ÂèçÔºåÊâÄÊúâÁöÑÂ†ÜÂØπË±°ÈÉΩÈÄöËøá span ÊåâÁÖßÈ¢ÑÂÖàËÆæÂÆöÂ•ΩÁöÑ Â§ßÂ∞èÁ≠âÁ∫ßÂàÜÂà´ÂàÜÈÖçÔºåÂ∞è‰∫é 32KB ÁöÑÂ∞èÂØπË±°ÂàôÂàÜÈÖçÂú®Âõ∫ÂÆöÂ§ßÂ∞èÁ≠âÁ∫ßÁöÑ span ‰∏äÔºåÂê¶ÂàôÁõ¥Êé•‰ªé mheap ‰∏äËøõË°åÂàÜÈÖç„ÄÇ</p>
</li>
<li>
<p>mspanÔºöÊòØ mheap ‰∏äÁÆ°ÁêÜÁöÑ‰∏ÄËøû‰∏≤ÁöÑÈ°µ</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mspan</span> <span class="kd">struct</span> <span class="p">{</span> <span class="c1">// ÂèåÂêëÈìæË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next</span> <span class="o">*</span><span class="nx">mspan</span>     <span class="c1">// ÈìæË°®‰∏≠ÁöÑ‰∏ã‰∏Ä‰∏™ spanÔºåÂ¶ÇÊûú‰∏∫Á©∫Âàô‰∏∫ nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">prev</span> <span class="o">*</span><span class="nx">mspan</span>     <span class="c1">// ÈìæË°®‰∏≠ÁöÑÂâç‰∏Ä‰∏™ spanÔºåÂ¶ÇÊûú‰∏∫Á©∫Âàô‰∏∫ nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">startAddr</span>      <span class="kt">uintptr</span> <span class="c1">// span ÁöÑÁ¨¨‰∏Ä‰∏™Â≠óËäÇÁöÑÂú∞ÂùÄÔºåÂç≥ s.base()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">npages</span>         <span class="kt">uintptr</span> <span class="c1">// ‰∏Ä‰∏™ span ‰∏≠ÁöÑ page Êï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">manualFreeList</span> <span class="nx">gclinkptr</span> <span class="c1">// mSpanManual span ÁöÑÈáäÊîæÂØπË±°ÈìæË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">freeindex</span>  <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nelems</span>     <span class="kt">uintptr</span> <span class="c1">// span ‰∏≠ÂØπË±°ÁöÑÊï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">allocCache</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allocBits</span>  <span class="o">*</span><span class="nx">gcBits</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">allocCount</span>  <span class="kt">uint16</span>     <span class="c1">// ÂàÜÈÖçÂØπË±°ÁöÑÊï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">spanclass</span>   <span class="nx">spanClass</span>  <span class="c1">// Â§ßÂ∞èÁ≠âÁ∫ß‰∏é noscan (uint8)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">incache</span>     <span class="kt">bool</span>       <span class="c1">// ÊòØÂê¶Ë¢´ mcache ‰ΩøÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">state</span>       <span class="nx">mSpanState</span> <span class="c1">// mspaninuse Á≠âÂæÖ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcentralÔºöÊî∂ÈõÜ‰∫ÜÁªôÂÆöÂ§ßÂ∞èÁ≠âÁ∫ßÁöÑÊâÄÊúâ span„ÄÇÂΩì mcentral ‰∏≠ nonempty ÂàóË°®‰∏≠‰πüÊ≤°ÊúâÂèØÂàÜÈÖçÁöÑ span Êó∂ÔºåÂàô‰ºöÂêë mheap ÊèêÂá∫ËØ∑Ê±ÇÔºå‰ªéËÄåËé∑ÂæóÊñ∞ÁöÑ spanÔºåÂπ∂ËøõËÄå‰∫§Áªô mcache„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcentral</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lock</span>      <span class="nx">mutex</span>
</span></span><span class="line"><span class="cl">    <span class="nx">spanclass</span> <span class="nx">spanClass</span>
</span></span><span class="line"><span class="cl">    <span class="nx">nonempty</span>  <span class="nx">mSpanList</span> <span class="c1">// Â∏¶ÊúâËá™Áî±ÂØπË±°ÁöÑ span ÂàóË°®ÔºåÂç≥ÈùûÁ©∫Èó≤ÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">empty</span>     <span class="nx">mSpanList</span> <span class="c1">// Ê≤°ÊúâËá™Áî±ÂØπË±°ÁöÑ span ÂàóË°®ÔºàÊàñÁºìÂ≠òÂú® mcache ‰∏≠Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcacheÔºö‰∏∫ per-P ÁöÑÁºìÂ≠ò„ÄÇ</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tiny</span>             <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tinyoffset</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local_tinyallocs</span> <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">alloc</span>            <span class="p">[</span><span class="nx">numSpanClasses</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span> <span class="c1">// Áî®Êù•ÂàÜÈÖçÁöÑ spansÔºåÁî± spanClass Á¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stackcache</span>       <span class="p">[</span><span class="nx">_NumStackOrders</span><span class="p">]</span><span class="nx">stackfreelist</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>mcacheË¥üË¥£Â∞èÂØπË±°ÂíåÂæÆÂØπË±°ÁöÑÂàÜÈÖçÔºåÂÖ∂ÊåÅÊúâmspan</p>
<h3 id="33-allocation">3.3. Allocation</h3>
<p>Â∏∏ËßÅÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÊ®°ÂùóÂàÜ‰∏∫Â¶Ç‰∏ã‰∏âÁßçfixalloc„ÄÅlinearAlloc„ÄÅmcache</p>
<p>fixalloc ÊòØ‰∏Ä‰∏™Âü∫‰∫éËá™Áî±ÂàóË°®ÁöÑÂõ∫ÂÆöÂ§ßÂ∞èÁöÑÂàÜÈÖçÂô®„ÄÇÂÖ∂Ê†∏ÂøÉÂéüÁêÜÊòØÂ∞ÜËã•Âπ≤Êú™ÂàÜÈÖçÁöÑÂÜÖÂ≠òÂùóËøûÊé•Ëµ∑Êù•Ôºå Â∞ÜÊú™ÂàÜÈÖçÁöÑÂå∫ÂüüÁöÑÁ¨¨‰∏Ä‰∏™Â≠ó‰∏∫ÊåáÂêë‰∏ã‰∏Ä‰∏™Êú™ÂàÜÈÖçÂå∫ÂüüÁöÑÊåáÈíà‰ΩøÁî®„ÄÇGo ÁöÑ‰∏ªÂàÜÈÖçÂ†Ü‰∏≠ mallocÔºàspan„ÄÅcache„ÄÅtreap„ÄÅfinalizer„ÄÅprofile„ÄÅarena hint Á≠âÔºâ Âùá Âõ¥ÁªïÂÆÉ‰∏∫ÂÆû‰ΩìËøõË°åÂõ∫ÂÆöÂàÜÈÖçÂíåÂõûÊî∂„ÄÇ</p>
<p>fixalloc ‰Ωú‰∏∫ÊäΩË±°ÔºåÈùûÂ∏∏ÁÆÄÊ¥ÅÔºåÂè™ÂåÖÂê´‰∏â‰∏™Âü∫Êú¨Êìç‰ΩúÔºöÂàùÂßãÂåñ„ÄÅÂàÜÈÖç„ÄÅÂõûÊî∂</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// fixalloc ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÂõ∫ÂÆöÂ§ßÂ∞èÂØπË±°ÁöÑËá™Áî±Ë°®ÂÜÖÂ≠òÂàÜÈÖçÂô®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Malloc ‰ΩøÁî®Âõ¥Áªï sysAlloc ÁöÑ fixalloc Êù•ÁÆ°ÁêÜÂÖ∂ MCache Âíå MSpan ÂØπË±°„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1">// fixalloc.alloc ËøîÂõûÁöÑÂÜÖÂ≠òÈªòËÆ§‰∏∫Èõ∂Ôºå‰ΩÜË∞ÉÁî®ËÄÖÂèØ‰ª•ÈÄöËøáÂ∞Ü zero Ê†áÂøóËÆæÁΩÆ‰∏∫ false
</span></span></span><span class="line"><span class="cl"><span class="c1">// Êù•Ëá™Ë°åË¥üË¥£Â∞ÜÂàÜÈÖçÂΩíÈõ∂„ÄÇÂ¶ÇÊûúËøôÈÉ®ÂàÜÂÜÖÂ≠òÊ∞∏Ëøú‰∏çÂåÖÂê´Â†ÜÊåáÈíàÔºåÂàôËøôÊ†∑ÁöÑÊìç‰ΩúÊòØÂÆâÂÖ®ÁöÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Ë∞ÉÁî®ÊñπË¥üË¥£ÈîÅÂÆö fixalloc Ë∞ÉÁî®„ÄÇË∞ÉÁî®ÊñπÂèØ‰ª•Âú®ÂØπË±°‰∏≠‰øùÊåÅÁä∂ÊÄÅÔºå
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‰ΩÜÂΩìÈáäÊîæÂíåÈáçÊñ∞ÂàÜÈÖçÊó∂Á¨¨‰∏Ä‰∏™Â≠ó‰ºöË¢´Á†¥Âùè„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ËÄÉËôë‰Ωø fixalloc ÁöÑÁ±ªÂûãÂèò‰∏∫ go:notinheap.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">fixalloc</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span>   <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">first</span>  <span class="kd">func</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="c1">// È¶ñÊ¨°Ë∞ÉÁî®Êó∂ËøîÂõû p
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arg</span>    <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">list</span>   <span class="o">*</span><span class="nx">mlink</span>
</span></span><span class="line"><span class="cl">    <span class="nx">chunk</span>  <span class="kt">uintptr</span> <span class="c1">// ‰ΩøÁî® uintptr ËÄåÈùû unsafe.Pointer Êù•ÈÅøÂÖç write barrier
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">nchunk</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inuse</span>  <span class="kt">uintptr</span> <span class="c1">// Ê≠£Âú®‰ΩøÁî®ÁöÑÂ≠óËäÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">stat</span>   <span class="o">*</span><span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">    <span class="nx">zero</span>   <span class="kt">bool</span> <span class="c1">// ÂΩíÈõ∂ÁöÑÂàÜÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Go ËØ≠Ë®ÄÂØπ‰∫éÈõ∂ÂÄºÊúâËá™Â∑±ÁöÑËßÑÂÆöÔºåËá™ÁÑ∂‰πüÂ∞±‰ΩìÁé∞Âú®ÂÜÖÂ≠òÂàÜÈÖçÂô®‰∏ä„ÄÇËÄå fixalloc ‰Ωú‰∏∫ÂÜÖÂ≠òÂàÜÈÖçÂô®ÂÜÖÈÉ®ÁªÑ‰ª∂ÁöÑÊù•Ê∫ê‰∫é Êìç‰ΩúÁ≥ªÁªüÁöÑÂÜÖÂ≠òÔºåËá™ÁÑ∂ÈúÄË¶ÅËá™Ë°åÂàùÂßãÂåñÔºåÂõ†Ê≠§Ôºåfixalloc ÁöÑÂàùÂßãÂåñ‰πüÂ∞±‰∏çÂèØÈÅøÂÖçÁöÑÈúÄË¶ÅÂ∞ÜËá™Ë∫´ÁöÑÂêÑ‰∏™Â≠óÊÆµÂΩíÈõ∂Ôºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">fixalloc</span><span class="p">)</span> <span class="nf">init</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">first</span> <span class="kd">func</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">),</span> <span class="nx">arg</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">,</span> <span class="nx">stat</span> <span class="o">*</span><span class="kt">uint64</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">size</span> <span class="p">=</span> <span class="nx">size</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">first</span> <span class="p">=</span> <span class="nx">first</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">arg</span> <span class="p">=</span> <span class="nx">arg</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">list</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">chunk</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">nchunk</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">inuse</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">stat</span> <span class="p">=</span> <span class="nx">stat</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">zero</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>fixalloc Âü∫‰∫éËá™Áî±Ë°®Á≠ñÁï•ËøõË°åÂÆûÁé∞ÔºåÂàÜ‰∏∫‰∏§ÁßçÊÉÖÂÜµÔºö</p>
<ol>
<li>
<p>Â≠òÂú®Ë¢´ÈáäÊîæ„ÄÅÂèØÂ§çÁî®ÁöÑÂÜÖÂ≠ò</p>
</li>
<li>
<p>‰∏çÂ≠òÂú®ÂèØÂ§çÁî®ÁöÑÂÜÖÂ≠ò</p>
</li>
</ol>
<p>ÂØπ‰∫éÁ¨¨‰∏ÄÁßçÊÉÖÂÜµÔºå‰πüÂ∞±ÊòØÂú®ËøêË°åÊó∂ÂÜÖÂ≠òË¢´ÈáäÊîæÔºå‰ΩÜËøôÈÉ®ÂàÜÂÜÖÂ≠òÂπ∂‰∏ç‰ºöË¢´Á´ãÂç≥ÂõûÊî∂ÁªôÊìç‰ΩúÁ≥ªÁªüÔºå Êàë‰ª¨Áõ¥Êé•‰ªéËá™Áî±Ë°®‰∏≠Ëé∑ÂæóÂç≥ÂèØÔºå‰ΩÜÈúÄË¶ÅÊ≥®ÊÑèÊåâÈúÄÂ∞ÜËøôÈÉ®ÂàÜÂÜÖÂ≠òËøõË°åÊ∏ÖÈõ∂Êìç‰Ωú„ÄÇ</p>
<p>ÂØπ‰∫éÁ¨¨‰∫åÁßçÊÉÖÂÜµÔºåÁõ¥Êé•ÂêëÊìç‰ΩúÁ≥ªÁªüÁî≥ËØ∑Âõ∫ÂÆöÂ§ßÂ∞èÁöÑÂÜÖÂ≠òÔºåÁÑ∂ÂêéÊâ£Èô§ÂàÜÈÖçÁöÑÂ§ßÂ∞èÂç≥ÂèØ„ÄÇ
ÂõûÊî∂Èò∂ÊÆµ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="o">*</span><span class="nx">fixalloc</span><span class="p">)</span> <span class="nf">free</span><span class="p">(</span><span class="nx">p</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂáèÂ∞ë‰ΩøÁî®ÁöÑÂ≠óËäÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f</span><span class="p">.</span><span class="nx">inuse</span> <span class="o">-=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">size</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜË¶ÅÈáäÊîæÁöÑÂÜÖÂ≠òÂú∞ÂùÄ‰Ωú‰∏∫ mlink ÊåáÈíàÊèíÂÖ•Âà∞ f.list ÂÜÖÔºåÂÆåÊàêÂõûÊî∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">v</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">mlink</span><span class="p">)(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">v</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">list</span>
</span></span><span class="line"><span class="cl">    <span class="nx">f</span><span class="p">.</span><span class="nx">list</span> <span class="p">=</span> <span class="nx">v</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>linearAlloc</code> ÊòØ‰∏Ä‰∏™Âü∫‰∫éÁ∫øÊÄßÂàÜÈÖçÁ≠ñÁï•ÁöÑÂàÜÈÖçÂô®Ôºå‰ΩÜÁî±‰∫éÂÆÉÂè™‰Ωú‰∏∫ <code>mheap_.heapArenaAlloc</code> Âíå <code>mheap_.arena</code> Âú® 32 ‰ΩçÁ≥ªÁªü‰∏ä‰ΩøÁî®ÔºåËøôÈáå‰∏çÂÅöËØ¶ÁªÜÂàÜÊûê„ÄÇ</p>
<p>Ê≠§Â§ñÔºåÂØπ‰∫éÊØè‰∏Ä‰∏™PÔºåÈÉΩÊúâmcacheÂÅöÁºìÂ≠òÔºåÊØè‰∏™Á∫øÁ®ãÁã¨Á´ãÊåÅÊúâÔºå‰πüÂ∞±‰∏ç‰ºöÂá∫Áé∞Âπ∂ÂèëÈóÆÈ¢òÔºå‰πü‰∏çÁî®‰∏äÈîÅ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//go:notinheap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">mcache</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏ãÈù¢ÁöÑÊàêÂëòÂú®ÊØèÊ¨° malloc Êó∂ÈÉΩ‰ºöË¢´ËÆøÈóÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Âõ†Ê≠§Â∞ÜÂÆÉ‰ª¨ÊîæÂà∞‰∏ÄËµ∑Êù•Âà©Áî®ÁºìÂ≠òÁöÑÂ±ÄÈÉ®ÊÄßÂéüÁêÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">next_sample</span> <span class="kt">uintptr</span>    <span class="c1">// ÂàÜÈÖçËøô‰πàÂ§öÂ≠óËäÇÂêéËß¶ÂèëÂ†ÜÊ†∑Êú¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_scan</span>  <span class="kt">uintptr</span> <span class="c1">// ÂàÜÈÖçÁöÑÂèØÊâ´ÊèèÂ†ÜÁöÑÂ≠óËäÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê≤°ÊúâÊåáÈíàÁöÑÂæÆÂ∞èÂØπË±°ÁöÑÂàÜÈÖçÂô®ÁºìÂ≠ò„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ËØ∑ÂèÇËÄÉ malloc.go ‰∏≠ÁöÑ &#34;Â∞èÂûãÂàÜÈÖçÂô®&#34; Ê≥®Èáä„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tiny ÊåáÂêëÂΩìÂâç tiny ÂùóÁöÑËµ∑Âßã‰ΩçÁΩÆÔºåÊàñÂΩìÊ≤°Êúâ tiny ÂùóÊó∂ÂÄô‰∏∫ nil
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// tiny ÊòØ‰∏Ä‰∏™Â†ÜÊåáÈíà„ÄÇÁî±‰∫é mcache Âú®Èùû GC ÂÜÖÂ≠ò‰∏≠ÔºåÊàë‰ª¨ÈÄöËøáÂú®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// mark termination ÊúüÈó¥Âú® releaseAll ‰∏≠Ê∏ÖÈô§ÂÆÉÊù•Â§ÑÁêÜÂÆÉ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">tiny</span>             <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tinyoffset</span>       <span class="kt">uintptr</span>
</span></span><span class="line"><span class="cl">    <span class="nx">local_tinyallocs</span> <span class="kt">uintptr</span> <span class="c1">// ‰∏çËÆ°ÂÖ•ÂÖ∂‰ªñÁªüËÆ°ÁöÑÊûÅÂ∞èÂàÜÈÖçÁöÑÊï∞Èáè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰∏ãÈù¢ÁöÑ‰∏çÂú®ÊØè‰∏™ malloc Êó∂Ë¢´ËÆøÈóÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">alloc</span> <span class="p">[</span><span class="nx">numSpanClasses</span><span class="p">]</span><span class="o">*</span><span class="nx">mspan</span> <span class="c1">// Áî®Êù•ÂàÜÈÖçÁöÑ spansÔºåÁî± spanClass Á¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">stackcache</span> <span class="p">[</span><span class="nx">_NumStackOrders</span><span class="p">]</span><span class="nx">stackfreelist</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Êú¨Âú∞ÂàÜÈÖçÂô®ÁªüËÆ°ÔºåÂú® GC ÊúüÈó¥Ë¢´Âà∑Êñ∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_largefree</span>  <span class="kt">uintptr</span>                  <span class="c1">// bytes freed for large objects (&gt;maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_nlargefree</span> <span class="kt">uintptr</span>                  <span class="c1">// number of frees for large objects (&gt;maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">local_nsmallfree</span> <span class="p">[</span><span class="nx">_NumSizeClasses</span><span class="p">]</span><span class="kt">uintptr</span> <span class="c1">// number of frees for small objects (&lt;=maxsmallsize)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// flushGen indicates the sweepgen during which this mcache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// was last flushed. If flushGen != mheap_.sweepgen, the spans
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// in this mcache are stale and need to the flushed so they
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// can be swept. This is done in acquirep.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">flushGen</span> <span class="kt">uint32</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ËøêË°åÊó∂ÁöÑ <code>runtime.allocmcache</code> ‰ªé <code>mheap</code> ‰∏äÂàÜÈÖç‰∏Ä‰∏™ <code>mcache</code>„ÄÇ Áî±‰∫é <code>mheap</code> ÊòØÂÖ®Â±ÄÁöÑÔºåÂõ†Ê≠§Âú®ÂàÜÈÖçÊúüÂøÖÈ°ªÂØπÂÖ∂ËøõË°åÂä†ÈîÅÔºåËÄåÂàÜÈÖçÈÄöËøá fixAlloc ÁªÑ‰ª∂ÂÆåÊàêÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ËôöÊãüÁöÑMSpanÔºå‰∏çÂåÖÂê´‰ªª‰ΩïÂØπË±°„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">emptymspan</span> <span class="nx">mspan</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">allocmcache</span><span class="p">()</span> <span class="o">*</span><span class="nx">mcache</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span> <span class="p">=</span> <span class="p">(</span><span class="o">*</span><span class="nx">mcache</span><span class="p">)(</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">cachealloc</span><span class="p">.</span><span class="nf">alloc</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">flushGen</span> <span class="p">=</span> <span class="nx">mheap_</span><span class="p">.</span><span class="nx">sweepgen</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span> <span class="c1">// ÊöÇÊó∂ÊåáÂêëËôöÊãüÁöÑ mspan ‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøîÂõû‰∏ã‰∏Ä‰∏™ÈááÊ†∑ÁÇπÔºåÊòØÊúç‰ªéÊ≥äÊùæËøáÁ®ãÁöÑÈöèÊú∫Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">next_sample</span> <span class="p">=</span> <span class="nf">nextSample</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂΩìÈúÄË¶ÅÈáäÊîæÊó∂Ë∞ÉÁî®freemcacheÂáΩÊï∞</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">freemcache</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">systemstack</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÂΩíËøò span
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">c</span><span class="p">.</span><span class="nf">releaseAll</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈáäÊîæ stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">stackcache_clear</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËÆ∞ÂΩïÂ±ÄÈÉ®ÁªüËÆ°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">purgecachedstats</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â∞Ü mcache ÈáäÊîæ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">mheap_</span><span class="p">.</span><span class="nx">cachealloc</span><span class="p">.</span><span class="nf">free</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="nf">unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">mheap_</span><span class="p">.</span><span class="nx">lock</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">mcache</span><span class="p">)</span> <span class="nf">releaseAll</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">s</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">s</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â∞Ü span ÂΩíËøò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">mheap_</span><span class="p">.</span><span class="nx">central</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">mcentral</span><span class="p">.</span><span class="nf">uncacheSpan</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nx">c</span><span class="p">.</span><span class="nx">alloc</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">emptymspan</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê∏ÖÁ©∫ tinyalloc Ê±†.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span><span class="p">.</span><span class="nx">tiny</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">.</span><span class="nx">tinyoffset</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>mcache ‰ºöË¢´ P ÊåÅÊúâÔºåÂΩì M Âíå P ÁªëÂÆöÊó∂ÔºåM ÂêåÊ†∑‰ºö‰øùÁïô mcache ÁöÑÊåáÈíà</li>
<li>mcache Áõ¥Êé•ÂêëÊìç‰ΩúÁ≥ªÁªüÁî≥ËØ∑ÂÜÖÂ≠òÔºå‰∏îÂ∏∏È©ªËøêË°åÊó∂</li>
<li>P ÈÄöËøá make ÂëΩ‰ª§ËøõË°åÂàÜÈÖçÔºå‰ºöÂàÜÈÖçÂú® Go Â†Ü‰∏ä</li>
</ul>
<h3 id="34-escape">3.4. Escape</h3>
<p>Go Á®ãÂ∫èÁöÑÊâßË°åÊòØÂü∫‰∫é goroutine ÁöÑÔºågoroutine Âíå‰º†ÁªüÊÑè‰πâ‰∏äÁöÑÁ®ãÂ∫è‰∏ÄÊ†∑Ôºå‰πüÊúâÊ†àÂíåÂ†ÜÁöÑÊ¶ÇÂøµ„ÄÇÂè™‰∏çËøá Go ÁöÑËøêË°åÊó∂Â∏ÆÊàë‰ª¨Â±èËîΩÊéâ‰∫ÜËøô‰∏§‰∏™Ê¶ÇÂøµÔºåÂè™Âú®ËøêË°åÊó∂ÂÜÖÈÉ®Âå∫ÂàÜÂπ∂ÂàÜÂà´ÂØπÂ∫îÔºögoroutine ÊâßË°åÊ†à‰ª•Âèä Go Â†Ü„ÄÇ</p>
<p>goroutine ÁöÑÊâßË°åÊ†à‰∏é‰º†ÁªüÊÑè‰πâ‰∏äÁöÑÊ†à‰∏ÄÊ†∑ÔºåÂΩìÂáΩÊï∞ËøîÂõûÊó∂ÔºåÂú®Ê†à‰∏äÂ∞±‰ºöË¢´ÂõûÊî∂ÔºåÊ†à‰∏≠ÁöÑÂØπË±°ÈÉΩ‰ºöË¢´ÂõûÊî∂Ôºå‰ªéËÄå Êó†ÈúÄ GC ÁöÑÊ†áËÆ∞ÔºõËÄåÂ†ÜÂàôÈ∫ªÁÉ¶‰∏Ä‰∫õÔºåÁî±‰∫é Go ÊîØÊåÅÂûÉÂúæÂõûÊî∂ÔºåÂè™Ë¶ÅÂØπË±°ÁîüÂ≠òÂú®Â†Ü‰∏äÔºåGo ÁöÑËøêË°åÊó∂ GC Â∞±‰ºöÂú® ÂêéÂè∞Â∞ÜÂØπÂ∫îÁöÑÂÜÖÂ≠òËøõË°åÊ†áËÆ∞‰ªéËÄåËÉΩÂ§üÂú®ÂûÉÂúæÂõûÊî∂ÁöÑÊó∂ÂÄôÂ∞ÜÂØπÂ∫îÁöÑÂÜÖÂ≠òÂõûÊî∂ÔºåËøõËÄåÂ¢ûÂä†‰∫ÜÂºÄÈîÄ„ÄÇ</p>
<p>‰ª•‰∏ãÂÆö‰πâ‰∫Ü4ÁßçÊÉÖÂÜµÔºå‰ΩøÁî® <code>-gcflags &quot;-N -l -m&quot;</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kn">package</span> <span class="nx">main</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">smallobj</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">arr</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">]</span><span class="kt">byte</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">largeobj</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">arr</span> <span class="p">[</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">]</span><span class="kt">byte</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f1</span><span class="p">()</span> <span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span>  <span class="c1">// Áõ¥Êé•ËøîÂõûÔºåÊ≤°ÊúâÈÄÉÈÄ∏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f2</span><span class="p">()</span> <span class="o">*</span><span class="kt">int</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span> <span class="o">:=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">y</span> <span class="c1">// ÂèëÁîüÈÄÉÈÄ∏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f3</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">large</span> <span class="o">:=</span> <span class="nx">largeobj</span><span class="p">{}</span> <span class="c1">// large Êó†Ê≥ïË¢´‰∏Ä‰∏™ÊâßË°åÊ†àË£Ö‰∏ãÔºå‰πü‰ºöÈÄÉÈÄ∏
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">println</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">large</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">f4</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">small</span> <span class="o">:=</span> <span class="nx">smallobj</span><span class="p">{}</span> <span class="c1">// small ÂØπË±°ËÉΩÂ§üË¢´‰∏Ä‰∏™ÊâßË°åÊ†àË£Ö‰∏ãÔºåÂèòÈáèÊ≤°ÊúâËøîÂõûÂà∞Ê†àÂ§ñÔºåËøõËÄåÊ≤°ÊúâÂèëÁîüÈÄÉÈÄ∏„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nb">print</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">small</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">x</span> <span class="o">:=</span> <span class="nf">f1</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">y</span> <span class="o">:=</span> <span class="nf">f2</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f3</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nf">f4</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nb">println</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>GoËØ≠Ë®Ä‰∏≠ÁöÑÂºïÁî®Á±ªÂûãÊúâfuncÔºàÂáΩÊï∞Á±ªÂûãÔºâÔºåinterfaceÔºàÊé•Âè£Á±ªÂûãÔºâÔºåsliceÔºàÂàáÁâáÁ±ªÂûãÔºâÔºåmapÔºàÂ≠óÂÖ∏Á±ªÂûãÔºâÔºåchannelÔºàÁÆ°ÈÅìÁ±ªÂûãÔºâÔºå*ÔºàÊåáÈíàÁ±ªÂûãÔºâ„ÄÇ</p>
<p>Âú®ÁºñËØëÈò∂ÊÆµÔºåÂèØ‰ª•‰ΩøÁî®<code>go tool compile</code>ÂëΩ‰ª§ÔºåÊü•ÁúãÔºåÂ¶ÇÊûúÊúâruntime.newobjectÔºåÂàôËØ¥ÊòéÂú®Â†Ü‰∏äÔºåÂèç‰πãÂàôÂú®Ê†à‰∏ä„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">newobject</span><span class="p">(</span><span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">typ</span><span class="p">.</span><span class="nx">size</span><span class="p">,</span> <span class="nx">typ</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span> <span class="c1">// true ÂÜÖÂ≠òÊ∏ÖÈõ∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">mallocgc</span><span class="p">(</span><span class="nx">size</span> <span class="kt">uintptr</span><span class="p">,</span> <span class="nx">typ</span> <span class="o">*</span><span class="nx">_type</span><span class="p">,</span> <span class="nx">needzero</span> <span class="kt">bool</span><span class="p">)</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫Â§ßÂ∞è‰∏∫Èõ∂ÁöÑÂØπË±°Ôºå‰æãÂ¶ÇÁ©∫ÁªìÊûÑ‰Ωì
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="nx">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">zerobase</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span> <span class="o">:=</span> <span class="nf">acquirem</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">mallocing</span> <span class="p">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂΩìÂâç g ÊâÄÂú® M ÊâÄÁªëÂÆö P ÁöÑ mcache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">c</span> <span class="o">:=</span> <span class="nf">gomcache</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">x</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl">    <span class="nx">noscan</span> <span class="o">:=</span> <span class="nx">typ</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">typ</span><span class="p">.</span><span class="nx">kind</span><span class="o">&amp;</span><span class="nx">kindNoPointers</span> <span class="o">!=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nx">size</span> <span class="o">&lt;=</span> <span class="nx">maxSmallSize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nx">noscan</span> <span class="o">&amp;&amp;</span> <span class="nx">size</span> <span class="p">&lt;</span> <span class="nx">maxTinySize</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// ÂæÆÂØπË±°ÂàÜÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â∞èÂØπË±°ÂàÜÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â§ßÂØπË±°ÂàÜÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="nx">mp</span><span class="p">.</span><span class="nx">mallocing</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="nf">releasem</span><span class="p">(</span><span class="nx">mp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>Â∞èÂØπË±°ÂàÜÈÖç</li>
</ol>
<p>ÂΩìÂØπ‰∏Ä‰∏™Â∞èÂØπË±°Ôºà&lt;32KBÔºâÂàÜÈÖçÂÜÖÂ≠òÊó∂Ôºå‰ºöÂ∞ÜËØ•ÂØπË±°ÊâÄÈúÄÁöÑÂÜÖÂ≠òÂ§ßÂ∞èË∞ÉÊï¥Âà∞Êüê‰∏™ËÉΩÂ§üÂÆπÁ∫≥ËØ•ÂØπË±°ÁöÑÂ§ßÂ∞èÁ≠âÁ∫ßÔºàsize classÔºâÔºå Âπ∂Êü•Áúã mcache ‰∏≠ÂØπÂ∫îÁ≠âÁ∫ßÁöÑ mspanÔºåÈÄöËøáÊâ´Êèè mspan ÁöÑ <code>freeindex</code> Êù•Á°ÆÂÆöÊòØÂê¶ËÉΩÂ§üËøõË°åÂàÜÈÖç„ÄÇ</p>
<p>ÂΩìÊ≤°ÊúâÂèØÂàÜÈÖçÁöÑ mspan Êó∂Ôºå‰ºö‰ªé mcentral ‰∏≠Ëé∑Âèñ‰∏Ä‰∏™ÊâÄÈúÄÂ§ßÂ∞èÁ©∫Èó¥ÁöÑÊñ∞ÁöÑ mspanÔºå‰ªé mcentral ‰∏≠ÂàÜÈÖç‰ºöÂØπÂÖ∂ËøõË°åÂä†ÈîÅÔºå ‰ΩÜ‰∏ÄÊ¨°ÊÄßËé∑ÂèñÊï¥‰∏™ span ÁöÑËøáÁ®ãÂùáÊëä‰∫ÜÂØπ mcentral Âä†ÈîÅÁöÑÊàêÊú¨„ÄÇ</p>
<p>Â¶ÇÊûú mcentral ÁöÑ mspan ‰πü‰∏∫Á©∫Êó∂ÔºåÂàôÂÆÉ‰πü‰ºöÂèëÁîüÂ¢ûÈïøÔºå‰ªéËÄå‰ªé mheap ‰∏≠Ëé∑Âèñ‰∏ÄËøû‰∏≤ÁöÑÈ°µÔºå‰Ωú‰∏∫‰∏Ä‰∏™Êñ∞ÁöÑ mspan ËøõË°åÊèê‰æõ„ÄÇ ËÄåÂ¶ÇÊûú mheap ‰ªçÁÑ∂‰∏∫Á©∫ÔºåÊàñËÄÖÊ≤°ÊúâË∂≥Â§üÂ§ßÁöÑÂØπË±°Êù•ËøõË°åÂàÜÈÖçÊó∂ÔºåÂàô‰ºö‰ªéÊìç‰ΩúÁ≥ªÁªü‰∏≠ÂàÜÈÖç‰∏ÄÁªÑÊñ∞ÁöÑÈ°µÔºàËá≥Â∞ë 1MBÔºâÔºå ‰ªéËÄåÂùáÊëä‰∏éÊìç‰ΩúÁ≥ªÁªüÊ≤üÈÄöÁöÑÊàêÊú¨„ÄÇ</p>
<ol start="2">
<li>ÂæÆÂØπË±°ÂàÜÈÖç</li>
</ol>
<p>ÂØπ‰∫éËøáÂ∞èÁöÑÂæÆÂØπË±°Ôºà&lt;16BÔºâÔºåÂÆÉ‰ª¨ÁöÑÂàÜÈÖçËøáÁ®ã‰∏éÂ∞èÂØπË±°ÁöÑÂàÜÈÖçËøáÁ®ãÂü∫Êú¨Á±ª‰ººÔºå‰ΩÜÊòØÊòØÁõ¥Êé•Â≠òÂÇ®Âú® mcache ‰∏äÔºåÂπ∂Áî±ÂÖ∂‰ª• 16B ÁöÑÂùóÂ§ßÂ∞èÁõ¥Êé•ËøõË°åÁÆ°ÁêÜÂíåÈáäÊîæ„ÄÇ</p>
<ol start="3">
<li>Â§ßÂØπË±°ÂàÜÈÖç</li>
</ol>
<p>Â§ßÂØπË±°ÂàÜÈÖçÈùûÂ∏∏Á≤óÊö¥Ôºå‰∏ç‰∏é mcache Âíå mcentral Ê≤üÈÄöÔºåÁõ¥Êé•ÁªïËøáÂπ∂ÈÄöËøá mheap ËøõË°åÂàÜÈÖç„ÄÇ</p>
<h2 id="4-garbage-collection">4. Garbage Collection</h2>
<ol>
<li>Ê∏ÖÁêÜÁªàÊ≠¢Èò∂ÊÆµÔºõ
<ol>
<li><strong>ÊöÇÂÅúÁ®ãÂ∫è</strong>ÔºåÊâÄÊúâÁöÑÂ§ÑÁêÜÂô®Âú®ËøôÊó∂‰ºöËøõÂÖ•ÂÆâÂÖ®ÁÇπÔºàSafe pointÔºâÔºõ</li>
<li>Â¶ÇÊûúÂΩìÂâçÂûÉÂúæÊî∂ÈõÜÂæ™ÁéØÊòØÂº∫Âà∂Ëß¶ÂèëÁöÑÔºåÊàë‰ª¨ËøòÈúÄË¶ÅÂ§ÑÁêÜËøòÊú™Ë¢´Ê∏ÖÁêÜÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÔºõ</li>
</ol>
</li>
<li>Ê†áËÆ∞Èò∂ÊÆµÔºõ
<ol>
<li>Â∞ÜÁä∂ÊÄÅÂàáÊç¢Ëá≥ <code>_GCmark</code>„ÄÅÂºÄÂêØÂÜôÂ±èÈöú„ÄÅÁî®Êà∑Á®ãÂ∫èÂçèÂä©ÔºàMutator AssistsÔºâÂπ∂Â∞ÜÊ†πÂØπË±°ÂÖ•ÈòüÔºõ</li>
<li>ÊÅ¢Â§çÊâßË°åÁ®ãÂ∫èÔºåÊ†áËÆ∞ËøõÁ®ãÂíåÁî®‰∫éÂçèÂä©ÁöÑÁî®Êà∑Á®ãÂ∫è‰ºöÂºÄÂßãÂπ∂ÂèëÊ†áËÆ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÂØπË±°ÔºåÂÜôÂ±èÈöú‰ºöÂ∞ÜË¢´Ë¶ÜÁõñÁöÑÊåáÈíàÂíåÊñ∞ÊåáÈíàÈÉΩÊ†áËÆ∞ÊàêÁÅ∞Ëâ≤ÔºåËÄåÊâÄÊúâÊñ∞ÂàõÂª∫ÁöÑÂØπË±°ÈÉΩ‰ºöË¢´Áõ¥Êé•Ê†áËÆ∞ÊàêÈªëËâ≤Ôºõ</li>
<li>ÂºÄÂßãÊâ´ÊèèÊ†πÂØπË±°ÔºåÂåÖÊã¨ÊâÄÊúâ Goroutine ÁöÑÊ†à„ÄÅÂÖ®Â±ÄÂØπË±°‰ª•Âèä‰∏çÂú®Â†Ü‰∏≠ÁöÑËøêË°åÊó∂Êï∞ÊçÆÁªìÊûÑÔºåÊâ´Êèè Goroutine Ê†àÊúüÈó¥‰ºöÊöÇÂÅúÂΩìÂâçÂ§ÑÁêÜÂô®Ôºõ</li>
<li>‰æùÊ¨°Â§ÑÁêÜÁÅ∞Ëâ≤ÈòüÂàó‰∏≠ÁöÑÂØπË±°ÔºåÂ∞ÜÂØπË±°Ê†áËÆ∞ÊàêÈªëËâ≤Âπ∂Â∞ÜÂÆÉ‰ª¨ÊåáÂêëÁöÑÂØπË±°Ê†áËÆ∞ÊàêÁÅ∞Ëâ≤Ôºõ</li>
<li>‰ΩøÁî®ÂàÜÂ∏ÉÂºèÁöÑÁªàÊ≠¢ÁÆóÊ≥ïÊ£ÄÊü•Ââ©‰ΩôÁöÑÂ∑•‰ΩúÔºåÂèëÁé∞Ê†áËÆ∞Èò∂ÊÆµÂÆåÊàêÂêéËøõÂÖ•Ê†áËÆ∞ÁªàÊ≠¢Èò∂ÊÆµÔºõ</li>
</ol>
</li>
<li>Ê†áËÆ∞ÁªàÊ≠¢Èò∂ÊÆµÔºõ
<ol>
<li><strong>ÊöÇÂÅúÁ®ãÂ∫è</strong>„ÄÅÂ∞ÜÁä∂ÊÄÅÂàáÊç¢Ëá≥ <code>_GCmarktermination</code> ÔºåÁ°ÆËÆ§Ê†áËÆ∞Â∑•‰ΩúÂ∑≤ÁªèÂÆåÊàêÔºåÂπ∂ÂÖ≥Èó≠ËæÖÂä©Ê†áËÆ∞ÁöÑÁî®Êà∑Á®ãÂ∫èÔºõ</li>
<li>Ê∏ÖÁêÜÂ§ÑÁêÜÂô®‰∏äÁöÑÁ∫øÁ®ãÁºìÂ≠òÔºõ</li>
</ol>
</li>
<li>Ê∏ÖÁêÜÈò∂ÊÆµÔºõ
<ol>
<li>Â∞ÜÁä∂ÊÄÅÂàáÊç¢Ëá≥ <code>_GCoff</code> ÂºÄÂßãÊ∏ÖÁêÜÈò∂ÊÆµÔºåÂú®Ê≠§‰πãÂâçÔºåÊñ∞Âª∫ÁöÑÂØπË±°ÊòØÈªëËâ≤ÔºåÂàáÊç¢ÂêéÁöÑÂØπË±°ÊòØÁôΩËâ≤ÔºåÂàùÂßãÂåñÊ∏ÖÁêÜÁä∂ÊÄÅÂπ∂ÂÖ≥Èó≠ÂÜôÂ±èÈöúÔºõ</li>
<li>ÂêéÂè∞Âπ∂ÂèëÊ∏ÖÁêÜÊâÄÊúâÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÔºåÂΩì Goroutine Áî≥ËØ∑Êñ∞ÁöÑÂÜÖÂ≠òÁÆ°ÁêÜÂçïÂÖÉÊó∂Â∞±‰ºöËß¶ÂèëÊ∏ÖÁêÜÔºõ</li>
</ol>
</li>
</ol>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/go/">Go</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span><a class="link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ml"  target="_blank" rel="noopener"
    >Licensed under CC BY-NC-SA 4.0</a></span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.css"integrity="sha256-J&#43;iAE0sgH8QSz9hpcDxXIftnj65JEZgNhGcgReTTK9s="crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/katex.min.js"integrity="sha256-InsNdER1b2xUewP&#43;pKCUJpkhiqwHgqiPXDlIk7GzBu4="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.15.6/dist/contrib/auto-render.min.js"integrity="sha256-y39Mpg7V3D4lhBX4x6O0bUqTV4pSrfgwEfGKfxkOdgI="crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/post/go6-network/">
        
        
            <div class="article-image">
                <img src="/post/go6-network/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(6) Network"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(6) Network</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go5-concurrency/">
        
        
            <div class="article-image">
                <img src="/post/go5-concurrency/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(5) Concurrency"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(5) Concurrency</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go3-common-keywords/">
        
        
            <div class="article-image">
                <img src="/post/go3-common-keywords/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(3) Common Keywords"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(3) Common Keywords</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go2-language-basic/">
        
        
            <div class="article-image">
                <img src="/post/go2-language-basic/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(2) Language Basic"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(2) Language Basic</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/post/go1-builtin-data-structure/">
        
        
            <div class="article-image">
                <img src="/post/go1-builtin-data-structure/go-model-sheet.812604dc332b963cd105cd1d8b0d254f_hu639b7f51186e99c0b2036c3dd41de527_43318_250x150_fill_q75_h2_box_smart1_2.webp" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Go(1) Builtin Data Structure"
                        
                        data-hash="md5-gSYE3DMrljzRBc0diw0lTw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Go(1) Builtin Data Structure</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="Chasing1020/Chasing1020.github.io"
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2019 - 
        
        2023 Chasing&#39;s blog
    </section>
    
    <section class="powerby">
        
            I just want a peaceful life without troubles <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.16.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-CDYPFNXQDZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CDYPFNXQDZ');
</script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


    </body>
</html>
