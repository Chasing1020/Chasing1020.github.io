[{"content":"oh-my-zsh 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 # ~/.zshrc plugins=( git colored-man-pages command-not-found fzf-zsh-plugin zsh-wakatime zsh-autosuggestions zsh-syntax-highlighting ) source $ZSH/oh-my-zsh.sh export http_proxy=\u0026#34;127.0.0.1:7890\u0026#34; export https_proxy=\u0026#34;127.0.0.1:7890\u0026#34; alias unproxy=\u0026#34;unset http_proxy https_proxy\u0026#34; alias l=\u0026#34;exa -FHlahb --git\u0026#34; alias ll=\u0026#34;exa -FHlahb --git\u0026#34; alias chrome=\u0026#39;/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome\u0026#39; alias ip=\u0026#34;dig +short myip.opendns.com @resolver1.opendns.com\u0026#34; alias localip=\u0026#34;ipconfig getifaddr en0\u0026#34; alias ips=\u0026#34;ifconfig -a | grep -o \u0026#39;inet6\\? \\(addr:\\)\\?\\s\\?\\(\\(\\([0-9]\\+\\.\\)\\{3\\}[0-9]\\+\\)\\|[a-fA-F0-9:]\\+\\)\u0026#39; | awk \u0026#39;{ sub(/inet6? (addr:)? ?/, \\\u0026#34;\\\u0026#34;); print }\u0026#39;\u0026#34; # Canonical hex dump; some systems have this symlinked command -v hd \u0026gt; /dev/null || alias hd=\u0026#34;hexdump -C\u0026#34; # macOS has no `md5sum`, so use `md5` as a fallback command -v md5sum \u0026gt; /dev/null || alias md5sum=\u0026#34;md5\u0026#34; # macOS has no `sha1sum`, so use `shasum` as a fallback command -v sha1sum \u0026gt; /dev/null || alias sha1sum=\u0026#34;shasum\u0026#34; # Recursively delete `.DS_Store` files alias cleanup=\u0026#34;find . -type f -name \u0026#39;*.DS_Store\u0026#39; -ls -delete\u0026#34; # Print each PATH entry on a separate line alias path=\u0026#39;echo -e ${PATH//:/\\\\n}\u0026#39; # Extract archives -- usage: extract \u0026lt;file\u0026gt; function extract () { if [ -f $1 ] ; then case $1 in *.tar.bz2) tar xjf $1 ;; *.tar.gz) tar xzf $1 ;; *.bz2) bunzip2 $1 ;; *.rar) unrar e $1 ;; *.gz) gunzip $1 ;; *.tar) tar xf $1 ;; *.tbz2) tar xjf $1 ;; *.tgz) tar xzf $1 ;; *.zip) unzip \u0026#34;$1\u0026#34; ;; *.Z) uncompress $1 ;; *.7z) 7z x $1 ;; *) echo \u0026#34;\u0026#39;$1\u0026#39; cannot be extracted via extract()\u0026#34; ;; esac else echo \u0026#34;\u0026#39;$1\u0026#39; is not a valid file\u0026#34; fi } export HOMEBREW_NO_AUTO_UPDATE=1 export ZSH_WAKATIME_PROJECT_DETECTION=true # Make vim the default editor. export EDITOR=\u0026#39;vim\u0026#39;; alias vi=\u0026#34;nvim\u0026#34; alias vim=\u0026#34;nvim\u0026#34; # Enable persistent REPL history for `node`. export NODE_REPL_HISTORY=~/.node_history; # Allow 32Â³ entries; the default is 1000. export NODE_REPL_HISTORY_SIZE=\u0026#39;32768\u0026#39;; # Use sloppy mode by default, matching web browsers. export NODE_REPL_MODE=\u0026#39;sloppy\u0026#39;; # Make Python use UTF-8 encoding for output to stdin, stdout, and stderr. export PYTHONIOENCODING=\u0026#39;UTF-8\u0026#39;; # Highlight section titles in manual pages. export LESS_TERMCAP_md=\u0026#34;${yellow}\u0026#34;; # Donâ€™t clear the screen after quitting a manual page. export MANPAGER=\u0026#39;less -X\u0026#39;; # Avoid issues with `gpg` as installed via Homebrew. # https://stackoverflow.com/a/42265848/96656 export GPG_TTY=$(tty); # Hide the â€œdefault interactive shell is now zshâ€ warning on macOS. export BASH_SILENCE_DEPRECATION_WARNING=1; [ -f ~/.fzf.zsh ] \u0026amp;\u0026amp; source ~/.fzf.zsh eval \u0026#34;$(zoxide init --cmd cd zsh)\u0026#34; eval \u0026#34;$(starship init zsh)\u0026#34; Alacritty 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578 579 580 581 582 583 584 585 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635 636 637 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784 785 786 787 788 789 790 791 792 793 794 795 796 797 798 799 800 801 802 803 804 805 806 807 808 809 810 811 812 813 814 815 816 817 818 819 820 821 822 823 824 825 826 827 828 829 830 831 832 833 834 835 836 837 838 839 840 841 842 843 844 # ~/.config/alacritty/alacritty.yml env: # TERM variable # # This value is used to set the `$TERM` environment variable for # each instance of Alacritty. If it is not present, alacritty will # check the local terminfo database and use `alacritty` if it is # available, otherwise `xterm-256color` is used. TERM: xterm-256color window: # Window dimensions (changes require restart) # # Number of lines/columns (not pixels) in the terminal. Both lines and columns # must be non-zero for this to take effect. The number of columns must be at # least `2`, while using a value of `0` for columns and lines will fall back # to the window manager\u0026#39;s recommended size dimensions: columns: 120 lines: 34 # Window position (changes require restart) # # Specified in number of pixels. # If the position is not set, the window manager will handle the placement. #position: # x: 0 # y: 0 # Window padding (changes require restart) # # Blank space added around the window in pixels. This padding is scaled # by DPI and the specified value is always added at both opposing sides. # padding: # x: 18 # y: 14 # Spread additional padding evenly around the terminal content. dynamic_padding: true # Window decorations # # Values for `decorations`: # - full: Borders and title bar # - none: Neither borders nor title bar # # Values for `decorations` (macOS only): # - transparent: Title bar, transparent background and title bar buttons # - buttonless: Title bar, transparent background and no title bar buttons decorations: full # Background opacity # # Window opacity as a floating point number from `0.0` to `1.0`. # The value `0.0` is completely transparent and `1.0` is opaque. #opacity: 1.0 opacity: 0.97 # Startup Mode (changes require restart) # # Values for `startup_mode`: # - Windowed # - Maximized # - Fullscreen # # Values for `startup_mode` (macOS only): # - SimpleFullscreen #startup_mode: Windowed # Window title title: Alacritty # Allow terminal applications to change Alacritty\u0026#39;s window title. dynamic_title: true # Window class (Linux/BSD only): #class: # Application instance name #instance: Alacritty # General application class #general: Alacritty # Decorations theme variant # # Override the variant of the System theme/GTK theme/Wayland client side # decorations. Commonly supported values are `Dark`, `Light`, and `None` for # auto pick-up. Set this to `None` to use the default theme variant. decorations_theme_variant: Dark # Make `Option` key behave as `Alt` (macOS only): # - OnlyLeft # - OnlyRight # - Both # - None (default) #option_as_alt: None scrolling: # How many lines of scrollback to keep, # \u0026#39;0\u0026#39; will disable scrolling. history: 10000 # Number of lines the viewport will move for every line # scrolled when scrollback is enabled (history \u0026gt; 0). multiplier: 3 # Faux Scrolling # # The `faux_multiplier` setting controls the number # of lines the terminal should scroll when the alternate # screen buffer is active. This is used to allow mouse # scrolling for applications like `man`. # # To disable this completely, set `faux_multiplier` to 0. faux_multiplier: 3 # Automatically scroll to the bottom when new text is written # to the terminal. auto_scroll: false # Font configuration font: # Normal (roman) font face normal: # Font family # # Default: # - (macOS) Menlo # - (Linux/BSD) monospace # - (Windows) Consolas family: \u0026#34;JetBrainsMono Nerd Font Mono\u0026#34; # The `style` can be specified to pick a specific face. style: Regular # Bold font face #bold: # Font family # # If the bold family is not specified, it will fall back to the # value specified for the normal font. #family: monospace # The `style` can be specified to pick a specific face. #style: Bold # Italic font face #italic: # Font family # # If the italic family is not specified, it will fall back to the # value specified for the normal font. #family: monospace # The `style` can be specified to pick a specific face. #style: Italic # Bold italic font face #bold_italic: # Font family # # If the bold italic family is not specified, it will fall back to the # value specified for the normal font. #family: monospace # The `style` can be specified to pick a specific face. #style: Bold Italic # Point size size: 16.0 # Offset is the extra space around each character. `offset.y` can be thought # of as modifying the line spacing, and `offset.x` as modifying the letter # spacing. #offset: # x: 0 # y: 0 # Glyph offset determines the locations of the glyphs within their cells with # the default being at the bottom. Increasing `x` moves the glyph to the # right, increasing `y` moves the glyph upward. #glyph_offset: # x: 0 # y: 0 # Use built-in font for box drawing characters. # # If `true`, Alacritty will use a custom built-in font for box drawing # characters (Unicode points 2500 - 259f). # #builtin_box_drawing: true # If `true`, bold text is drawn using the bright color variants. draw_bold_text_with_bright_colors: true # Colors (iTerm2) colors: # Default colors primary: background: \u0026#39;0x000000\u0026#39; foreground: \u0026#39;0xc7c7c7\u0026#39; cursor: text: \u0026#39;0xc7c7c7\u0026#39; cursor: \u0026#39;0xfffefe\u0026#39; # Normal colors normal: black: \u0026#39;0x000000\u0026#39; red: \u0026#39;0xcf2004\u0026#39; green: \u0026#39;0x00c200\u0026#39; yellow: \u0026#39;0xc7c400\u0026#39; blue: \u0026#39;0x0225c7\u0026#39; magenta: \u0026#39;0xc930c7\u0026#39; cyan: \u0026#39;0x00c5c7\u0026#39; white: \u0026#39;0xc7c7c7\u0026#39; # Bright colors bright: black: \u0026#39;0x676767\u0026#39; red: \u0026#39;0xe4544e\u0026#39; green: \u0026#39;0x78e364\u0026#39; yellow: \u0026#39;0xe5e152\u0026#39; blue: \u0026#39;0x6871ff\u0026#39; magenta: \u0026#39;0xff76ff\u0026#39; cyan: \u0026#39;0x5ffdff\u0026#39; white: \u0026#39;0xd0d0d0\u0026#39; # Bell # # The bell is rung every time the BEL control character is received. #bell: # Visual Bell Animation # # Animation effect for flashing the screen when the visual bell is rung. # # Values for `animation`: # - Ease # - EaseOut # - EaseOutSine # - EaseOutQuad # - EaseOutCubic # - EaseOutQuart # - EaseOutQuint # - EaseOutExpo # - EaseOutCirc # - Linear #animation: EaseOutExpo # Duration of the visual bell flash in milliseconds. A `duration` of `0` will # disable the visual bell animation. #duration: 0 # Visual bell animation color. #color: \u0026#39;#ffffff\u0026#39; # Bell Command # # This program is executed whenever the bell is rung. # # When set to `command: None`, no command will be executed. # # Example: # command: # program: notify-send # args: [\u0026#34;Hello, World!\u0026#34;] # #command: None selection: # This string contains all characters that are used as separators for # \u0026#34;semantic words\u0026#34; in Alacritty. semantic_escape_chars: \u0026#34;,â”‚`|:\\\u0026#34;\u0026#39; ()[]{}\u0026lt;\u0026gt;\\t\u0026#34; # When set to `true`, selected text will be copied to the primary clipboard. save_to_clipboard: false cursor: # Cursor style style: # Cursor shape # # Values for `shape`: # - â–‡ Block # - _ Underline # - | Beam shape: Beam # Cursor blinking state # # Values for `blinking`: # - Never: Prevent the cursor from ever blinking # - Off: Disable blinking by default # - On: Enable blinking by default # - Always: Force the cursor to always blink blinking: On # Vi mode cursor style # # If the vi mode cursor style is `None` or not specified, it will fall back to # the style of the active value of the normal cursor. # # See `cursor.style` for available options. vi_mode_style: shape: Beam # Cursor blinking interval in milliseconds. #blink_interval: 750 # Time after which cursor stops blinking, in seconds. # # Specifying \u0026#39;0\u0026#39; will disable timeout for blinking. #blink_timeout: 5 # If this is `true`, the cursor will be rendered as a hollow box when the # window is not focused. #unfocused_hollow: true # Thickness of the cursor relative to the cell width as floating point number # from `0.0` to `1.0`. #thickness: 0.15 # Live config reload (changes require restart) live_config_reload: true # Shell # # You can set `shell.program` to the path of your favorite shell, e.g. # `/bin/fish`. Entries in `shell.args` are passed unmodified as arguments to the # shell. # # Default: # - (Linux/BSD/macOS) `$SHELL` or the user\u0026#39;s login shell, if `$SHELL` is unset # - (Windows) powershell shell: program: /opt/homebrew/bin/tmux # \u0026lt;- set this to the path of your tmux installation args: - new-session - -A - -D - -s - main # Startup directory # # Directory the shell is started in. If this is unset, or `None`, the working # directory of the parent process will be used. #working_directory: None # Offer IPC using `alacritty msg` (unix only) #ipc_socket: true #mouse: # Click settings # # The `double_click` and `triple_click` settings control the time # alacritty should wait for accepting multiple clicks as one double # or triple click. #double_click: { threshold: 300 } #triple_click: { threshold: 300 } # If this is `true`, the cursor is temporarily hidden when typing. #hide_when_typing: false # Hints # # Terminal hints can be used to find text or hyperlink in the visible part of # the terminal and pipe it to other applications. #hints: # Keys used for the hint labels. #alphabet: \u0026#34;jfkdls;ahgurieowpq\u0026#34; # List with all available hints # # Each hint must have any of `regex` or `hyperlinks` field and either an # `action` or a `command` field. The fields `mouse`, `binding` and # `post_processing` are optional. # # The `hyperlinks` option will cause OSC 8 escape sequence hyperlinks to be # highlighted. # # The fields `command`, `binding.key`, `binding.mods`, `binding.mode` and # `mouse.mods` accept the same values as they do in the `key_bindings` section. # # The `mouse.enabled` field controls if the hint should be underlined while # the mouse with all `mouse.mods` keys held or the vi mode cursor is above it. # # If the `post_processing` field is set to `true`, heuristics will be used to # shorten the match if there are characters likely not to be part of the hint # (e.g. a trailing `.`). This is most useful for URIs and applies only to # `regex` matches. # # Values for `action`: # - Copy # Copy the hint\u0026#39;s text to the clipboard. # - Paste # Paste the hint\u0026#39;s text to the terminal or search. # - Select # Select the hint\u0026#39;s text. # - MoveViModeCursor # Move the vi mode cursor to the beginning of the hint. #enabled: # - regex: \u0026#34;(ipfs:|ipns:|magnet:|mailto:|gemini:|gopher:|https:|http:|news:|file:|git:|ssh:|ftp:)\\ # [^\\u0000-\\u001F\\u007F-\\u009F\u0026lt;\u0026gt;\\\u0026#34;\\\\s{-}\\\\^âŸ¨âŸ©`]+\u0026#34; # hyperlinks: true # command: xdg-open # post_processing: true # mouse: # enabled: true # mods: None # binding: # key: U # mods: Control|Shift # Mouse bindings # # Mouse bindings are specified as a list of objects, much like the key # bindings further below. # # To trigger mouse bindings when an application running within Alacritty # captures the mouse, the `Shift` modifier is automatically added as a # requirement. # # Each mouse binding will specify a: # # - `mouse`: # # - Middle # - Left # - Right # - Numeric identifier such as `5` # # - `action` (see key bindings for actions not exclusive to mouse mode) # # - Mouse exclusive actions: # # - ExpandSelection # Expand the selection to the current mouse cursor location. # # And optionally: # # - `mods` (see key bindings) #mouse_bindings: # - { mouse: Right, action: ExpandSelection } # - { mouse: Right, mods: Control, action: ExpandSelection } # - { mouse: Middle, mode: ~Vi, action: PasteSelection } # Key bindings # # Key bindings are specified as a list of objects. For example, this is the # default paste binding: # # `- { key: V, mods: Control|Shift, action: Paste }` # # Each key binding will specify a: # # - `key`: Identifier of the key pressed # # - A-Z # - F1-F24 # - Key0-Key9 # # A full list with available key codes can be found here: # https://docs.rs/winit/*/winit/event/enum.VirtualKeyCode.html#variants # # Instead of using the name of the keys, the `key` field also supports using # the scancode of the desired key. Scancodes have to be specified as a # decimal number. This command will allow you to display the hex scancodes # for certain keys: # # `showkey --scancodes`. # # Then exactly one of: # # - `chars`: Send a byte sequence to the running application # # The `chars` field writes the specified string to the terminal. This makes # it possible to pass escape sequences. To find escape codes for bindings # like `PageUp` (`\u0026#34;\\x1b[5~\u0026#34;`), you can run the command `showkey -a` outside # of tmux. Note that applications use terminfo to map escape sequences back # to keys. It is therefore required to update the terminfo when changing an # escape sequence. # # - `action`: Execute a predefined action # # - ToggleViMode # - SearchForward # Start searching toward the right of the search origin. # - SearchBackward # Start searching toward the left of the search origin. # - Copy # - Paste # - IncreaseFontSize # - DecreaseFontSize # - ResetFontSize # - ScrollPageUp # - ScrollPageDown # - ScrollHalfPageUp # - ScrollHalfPageDown # - ScrollLineUp # - ScrollLineDown # - ScrollToTop # - ScrollToBottom # - ClearHistory # Remove the terminal\u0026#39;s scrollback history. # - Hide # Hide the Alacritty window. # - Minimize # Minimize the Alacritty window. # - Quit # Quit Alacritty. # - ToggleFullscreen # - SpawnNewInstance # Spawn a new instance of Alacritty. # - CreateNewWindow # Create a new Alacritty window from the current process. # - ClearLogNotice # Clear Alacritty\u0026#39;s UI warning and error notice. # - ClearSelection # Remove the active selection. # - ReceiveChar # - None # # - Vi mode exclusive actions: # # - Open # Perform the action of the first matching hint under the vi mode cursor # with `mouse.enabled` set to `true`. # - ToggleNormalSelection # - ToggleLineSelection # - ToggleBlockSelection # - ToggleSemanticSelection # Toggle semantic selection based on `selection.semantic_escape_chars`. # - CenterAroundViCursor # Center view around vi mode cursor # # - Vi mode exclusive cursor motion actions: # # - Up # One line up. # - Down # One line down. # - Left # One character left. # - Right # One character right. # - First # First column, or beginning of the line when already at the first column. # - Last # Last column, or beginning of the line when already at the last column. # - FirstOccupied # First non-empty cell in this terminal row, or first non-empty cell of # the line when already at the first cell of the row. # - High # Top of the screen. # - Middle # Center of the screen. # - Low # Bottom of the screen. # - SemanticLeft # Start of the previous semantically separated word. # - SemanticRight # Start of the next semantically separated word. # - SemanticLeftEnd # End of the previous semantically separated word. # - SemanticRightEnd # End of the next semantically separated word. # - WordLeft # Start of the previous whitespace separated word. # - WordRight # Start of the next whitespace separated word. # - WordLeftEnd # End of the previous whitespace separated word. # - WordRightEnd # End of the next whitespace separated word. # - Bracket # Character matching the bracket at the cursor\u0026#39;s location. # - SearchNext # Beginning of the next match. # - SearchPrevious # Beginning of the previous match. # - SearchStart # Start of the match to the left of the vi mode cursor. # - SearchEnd # End of the match to the right of the vi mode cursor. # # - Search mode exclusive actions: # - SearchFocusNext # Move the focus to the next search match. # - SearchFocusPrevious # Move the focus to the previous search match. # - SearchConfirm # - SearchCancel # - SearchClear # Reset the search regex. # - SearchDeleteWord # Delete the last word in the search regex. # - SearchHistoryPrevious # Go to the previous regex in the search history. # - SearchHistoryNext # Go to the next regex in the search history. # # - macOS exclusive actions: # - ToggleSimpleFullscreen # Enter fullscreen without occupying another space. # # - Linux/BSD exclusive actions: # # - CopySelection # Copy from the selection buffer. # - PasteSelection # Paste from the selection buffer. # # - `command`: Fork and execute a specified command plus arguments # # The `command` field must be a map containing a `program` string and an # `args` array of command line parameter strings. For example: # `{ program: \u0026#34;alacritty\u0026#34;, args: [\u0026#34;-e\u0026#34;, \u0026#34;vttest\u0026#34;] }` # # And optionally: # # - `mods`: Key modifiers to filter binding actions # # - Command # - Control # - Option # - Super # - Shift # - Alt # # Multiple `mods` can be combined using `|` like this: # `mods: Control|Shift`. # Whitespace and capitalization are relevant and must match the example. # # - `mode`: Indicate a binding for only specific terminal reported modes # # This is mainly used to send applications the correct escape sequences # when in different modes. # # - AppCursor # - AppKeypad # - Search # - Alt # - Vi # # A `~` operator can be used before a mode to apply the binding whenever # the mode is *not* active, e.g. `~Alt`. # # Bindings are always filled by default, but will be replaced when a new # binding with the same triggers is defined. To unset a default binding, it can # be mapped to the `ReceiveChar` action. Alternatively, you can use `None` for # a no-op if you do not wish to receive input characters for that binding. # # If the same trigger is assigned to multiple actions, all of them are executed # in the order they were defined in. #key_bindings: #- { key: Paste, action: Paste } #- { key: Copy, action: Copy } #- { key: L, mods: Control, action: ClearLogNotice } #- { key: L, mods: Control, mode: ~Vi|~Search, chars: \u0026#34;\\x0c\u0026#34; } #- { key: PageUp, mods: Shift, mode: ~Alt, action: ScrollPageUp } #- { key: PageDown, mods: Shift, mode: ~Alt, action: ScrollPageDown } #- { key: Home, mods: Shift, mode: ~Alt, action: ScrollToTop } #- { key: End, mods: Shift, mode: ~Alt, action: ScrollToBottom } # Vi Mode #- { key: Space, mods: Shift|Control, mode: ~Search, action: ToggleViMode } #- { key: Space, mods: Shift|Control, mode: Vi|~Search, action: ScrollToBottom } #- { key: Escape, mode: Vi|~Search, action: ClearSelection } #- { key: I, mode: Vi|~Search, action: ToggleViMode } #- { key: I, mode: Vi|~Search, action: ScrollToBottom } #- { key: C, mods: Control, mode: Vi|~Search, action: ToggleViMode } #- { key: Y, mods: Control, mode: Vi|~Search, action: ScrollLineUp } #- { key: E, mods: Control, mode: Vi|~Search, action: ScrollLineDown } #- { key: G, mode: Vi|~Search, action: ScrollToTop } #- { key: G, mods: Shift, mode: Vi|~Search, action: ScrollToBottom } #- { key: B, mods: Control, mode: Vi|~Search, action: ScrollPageUp } #- { key: F, mods: Control, mode: Vi|~Search, action: ScrollPageDown } #- { key: U, mods: Control, mode: Vi|~Search, action: ScrollHalfPageUp } #- { key: D, mods: Control, mode: Vi|~Search, action: ScrollHalfPageDown } #- { key: Y, mode: Vi|~Search, action: Copy } #- { key: Y, mode: Vi|~Search, action: ClearSelection } #- { key: Copy, mode: Vi|~Search, action: ClearSelection } #- { key: V, mode: Vi|~Search, action: ToggleNormalSelection } #- { key: V, mods: Shift, mode: Vi|~Search, action: ToggleLineSelection } #- { key: V, mods: Control, mode: Vi|~Search, action: ToggleBlockSelection } #- { key: V, mods: Alt, mode: Vi|~Search, action: ToggleSemanticSelection } #- { key: Return, mode: Vi|~Search, action: Open } #- { key: Z, mode: Vi|~Search, action: CenterAroundViCursor } #- { key: K, mode: Vi|~Search, action: Up } #- { key: J, mode: Vi|~Search, action: Down } #- { key: H, mode: Vi|~Search, action: Left } #- { key: L, mode: Vi|~Search, action: Right } #- { key: Up, mode: Vi|~Search, action: Up } #- { key: Down, mode: Vi|~Search, action: Down } #- { key: Left, mode: Vi|~Search, action: Left } #- { key: Right, mode: Vi|~Search, action: Right } #- { key: Key0, mode: Vi|~Search, action: First } #- { key: Key4, mods: Shift, mode: Vi|~Search, action: Last } #- { key: Key6, mods: Shift, mode: Vi|~Search, action: FirstOccupied } #- { key: H, mods: Shift, mode: Vi|~Search, action: High } #- { key: M, mods: Shift, mode: Vi|~Search, action: Middle } #- { key: L, mods: Shift, mode: Vi|~Search, action: Low } #- { key: B, mode: Vi|~Search, action: SemanticLeft } #- { key: W, mode: Vi|~Search, action: SemanticRight } #- { key: E, mode: Vi|~Search, action: SemanticRightEnd } #- { key: B, mods: Shift, mode: Vi|~Search, action: WordLeft } #- { key: W, mods: Shift, mode: Vi|~Search, action: WordRight } #- { key: E, mods: Shift, mode: Vi|~Search, action: WordRightEnd } #- { key: Key5, mods: Shift, mode: Vi|~Search, action: Bracket } #- { key: Slash, mode: Vi|~Search, action: SearchForward } #- { key: Slash, mods: Shift, mode: Vi|~Search, action: SearchBackward } #- { key: N, mode: Vi|~Search, action: SearchNext } #- { key: N, mods: Shift, mode: Vi|~Search, action: SearchPrevious } # Search Mode #- { key: Return, mode: Search|Vi, action: SearchConfirm } #- { key: Escape, mode: Search, action: SearchCancel } #- { key: C, mods: Control, mode: Search, action: SearchCancel } #- { key: U, mods: Control, mode: Search, action: SearchClear } #- { key: W, mods: Control, mode: Search, action: SearchDeleteWord } #- { key: P, mods: Control, mode: Search, action: SearchHistoryPrevious } #- { key: N, mods: Control, mode: Search, action: SearchHistoryNext } #- { key: Up, mode: Search, action: SearchHistoryPrevious } #- { key: Down, mode: Search, action: SearchHistoryNext } #- { key: Return, mode: Search|~Vi, action: SearchFocusNext } #- { key: Return, mods: Shift, mode: Search|~Vi, action: SearchFocusPrevious } # (Windows, Linux, and BSD only) #- { key: V, mods: Control|Shift, mode: ~Vi, action: Paste } #- { key: C, mods: Control|Shift, action: Copy } #- { key: F, mods: Control|Shift, mode: ~Search, action: SearchForward } #- { key: B, mods: Control|Shift, mode: ~Search, action: SearchBackward } #- { key: C, mods: Control|Shift, mode: Vi|~Search, action: ClearSelection } #- { key: Insert, mods: Shift, action: PasteSelection } #- { key: Key0, mods: Control, action: ResetFontSize } #- { key: Equals, mods: Control, action: IncreaseFontSize } #- { key: Plus, mods: Control, action: IncreaseFontSize } #- { key: NumpadAdd, mods: Control, action: IncreaseFontSize } #- { key: Minus, mods: Control, action: DecreaseFontSize } #- { key: NumpadSubtract, mods: Control, action: DecreaseFontSize } # (Windows only) #- { key: Return, mods: Alt, action: ToggleFullscreen } # (macOS only) #- { key: K, mods: Command, mode: ~Vi|~Search, chars: \u0026#34;\\x0c\u0026#34; } #- { key: K, mods: Command, mode: ~Vi|~Search, action: ClearHistory } #- { key: Key0, mods: Command, action: ResetFontSize } #- { key: Equals, mods: Command, action: IncreaseFontSize } #- { key: Plus, mods: Command, action: IncreaseFontSize } #- { key: NumpadAdd, mods: Command, action: IncreaseFontSize } #- { key: Minus, mods: Command, action: DecreaseFontSize } #- { key: NumpadSubtract, mods: Command, action: DecreaseFontSize } #- { key: V, mods: Command, action: Paste } #- { key: C, mods: Command, action: Copy } #- { key: C, mods: Command, mode: Vi|~Search, action: ClearSelection } #- { key: H, mods: Command, action: Hide } #- { key: H, mods: Command|Alt, action: HideOtherApplications } #- { key: M, mods: Command, action: Minimize } #- { key: Q, mods: Command, action: Quit } #- { key: W, mods: Command, action: Quit } #- { key: N, mods: Command, action: CreateNewWindow } #- { key: F, mods: Command|Control, action: ToggleFullscreen } #- { key: F, mods: Command, mode: ~Search, action: SearchForward } #- { key: B, mods: Command, mode: ~Search, action: SearchBackward } #debug: # Display the time it takes to redraw each frame. #render_timer: false # Keep the log file after quitting Alacritty. #persistent_logging: false # Log level # # Values for `log_level`: # - Off # - Error # - Warn # - Info # - Debug # - Trace #log_level: Warn # Renderer override. # - glsl3 # - gles2 # - gles2_pure #renderer: None # Print all received window events. #print_events: false # Highlight window damage information. #highlight_damage: false key_bindings: # Rename the current tmux window - { key: Comma, mods: Command, chars: \u0026#34;\\x02\\x2c\u0026#34; } # Select a new tmux session for the attached client interactively - { key: K, mods: Command, chars: \u0026#34;\\x02\\x73\u0026#34; } # Select window 1-9 - { key: Key1, mods: Command, chars: \u0026#34;\\x02\\x31\u0026#34; } - { key: Key2, mods: Command, chars: \u0026#34;\\x02\\x32\u0026#34; } - { key: Key3, mods: Command, chars: \u0026#34;\\x02\\x33\u0026#34; } - { key: Key4, mods: Command, chars: \u0026#34;\\x02\\x34\u0026#34; } - { key: Key5, mods: Command, chars: \u0026#34;\\x02\\x35\u0026#34; } - { key: Key6, mods: Command, chars: \u0026#34;\\x02\\x36\u0026#34; } - { key: Key7, mods: Command, chars: \u0026#34;\\x02\\x37\u0026#34; } - { key: Key8, mods: Command, chars: \u0026#34;\\x02\\x38\u0026#34; } - { key: Key9, mods: Command, chars: \u0026#34;\\x02\\x39\u0026#34; } - { key: Key0, mods: Command, chars: \u0026#34;\\x02\\x30\u0026#34; } # Switch to last tmux session - { key: L, mods: Command, chars: \u0026#34;\\x02\\x4c\u0026#34; } - { key: LBracket, mods: Command, chars: \u0026#34;\\x02\\x5b\u0026#34; } # Change to the previous tmux window - { key: LBracket, mods: Command|Shift, chars: \u0026#34;\\x02\\x70\u0026#34; } # Split the current pane into two, left and right - { key: D, mods: Command, chars: \u0026#34;\\x02\\x25\u0026#34; } # Split the current pane into two, top and bottom. - { key: D, mods: Command|Shift, chars: \u0026#34;\\x02\\x22\u0026#34; } # Detach the current tmux client - { key: W, mods: Command|Shift, chars: \u0026#34;\\x02\\x64\u0026#34; } # Change to the next tmux window - { key: RBracket, mods: Command|Shift, chars: \u0026#34;\\x02\\x6e\u0026#34; } # Type \u0026lt;escape\u0026gt;:w\u0026lt;enter\u0026gt; to save neovim - { key: S, mods: Command, chars: \u0026#34;\\x1b\\x3a\\x77\\x0a\u0026#34; } # Create a new tmux window - { key: T, mods: Command, chars: \u0026#34;\\x02\\x63\u0026#34; } # Break the current tmux pane out of the tmux window - { key: T, mods: Command|Shift, chars: \u0026#34;\\x02\\x21\u0026#34; } # Kill the current tmux pane (and window if last pane) - { key: X, mods: Command, chars: \u0026#34;\\x02\\x78\u0026#34; } # Toggle the zoom state of the current tmux pane - { key: Z, mods: Command, chars: \u0026#34;\\x02\\x7a\u0026#34; } # Navigating Panes - { key: Left, mods: Command, chars: \u0026#34;\\x02\\x1b\\x5b\\x44\u0026#34; } - { key: Right, mods: Command, chars: \u0026#34;\\x02\\x1b\\x5b\\x43\u0026#34; } - { key: Down, mods: Command, chars: \u0026#34;\\x02\\x1b\\x5b\\x42\u0026#34; } - { key: Up, mods: Command, chars: \u0026#34;\\x02\\x1b\\x5b\\x41\u0026#34; } - { key: PageUp, mods: Shift, action: ScrollPageUp, mode: ~Alt } - { key: PageDown, mods: Shift, action: ScrollPageDown, mode: ~Alt } - { key: Home, mods: Shift, action: ScrollToTop, mode: ~Alt } - { key: End, mods: Shift, action: ScrollToBottom, mode: ~Alt } Starship 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 # ~/.config/starship.toml # Get editor completions based on the config schema \u0026#34;$schema\u0026#34; = \u0026#39;https://starship.rs/config-schema.json\u0026#39; format = \u0026#34;\u0026#34;\u0026#34; $username\\ $hostname\\ $localip\\ $shlvl\\ $singularity\\ $kubernetes\\ $directory\\ $vcsh\\ $git_branch\\ $git_commit\\ $git_state\\ $git_metrics\\ $git_status\\ $hg_branch\\ $docker_context\\ $package\\ $c\\ $cmake\\ $cobol\\ $daml\\ $dart\\ $deno\\ $dotnet\\ $elixir\\ $elm\\ $erlang\\ $golang\\ $guix_shell\\ $haskell\\ $haxe\\ $helm\\ $java\\ $julia\\ $kotlin\\ $lua\\ $nim\\ $nodejs\\ $ocaml\\ $opa\\ $perl\\ $php\\ $pulumi\\ $purescript\\ $python\\ $raku\\ $rlang\\ $red\\ $ruby\\ $rust\\ $scala\\ $swift\\ $terraform\\ $vlang\\ $vagrant\\ $zig\\ $buf\\ $nix_shell\\ $conda\\ $meson\\ $spack\\ $memory_usage\\ $aws\\ $gcloud\\ $openstack\\ $azure\\ $env_var\\ $crystal\\ $custom\\ $sudo\\ $cmd_duration\\ $line_break\\ $jobs\\ $battery\\ $time\\ $status\\ $shell\\ $character\u0026#34;\u0026#34;\u0026#34; # Inserts a blank line between shell prompts command_timeout = 1000 add_newline = false # Replace the \u0026#34;â¯\u0026#34; symbol in the prompt with \u0026#34;âœ\u0026#34; [character] # The name of the module we are configuring is \u0026#34;character\u0026#34; success_symbol = \u0026#34;[ \u0026gt;](bold green)\u0026#34; # The \u0026#34;success_symbol\u0026#34; segment is being set to \u0026#34;âœ\u0026#34; with the color \u0026#34;bold green\u0026#34; error_symbol = \u0026#34;[ \u0026gt;](bold red)\u0026#34; [directory] format = \u0026#34;[$path]($style)\u0026#34; truncation_length = 3 [git_status] format = \u0026#39;([\\[$all_status$ahead_behind\\]]($style))\u0026#39; conflicted = \u0026#34;ğŸ¤”\u0026#34; ahead = \u0026#34;ğŸğŸ’¨\u0026#34; behind = \u0026#34;ğŸ˜°\u0026#34; diverged = \u0026#34;ğŸ˜µ\u0026#34; up_to_date = \u0026#34;\u0026#34; untracked = \u0026#34;ğŸ¤·\u0026#34; stashed = \u0026#34;ğŸ“¦\u0026#34; modified = \u0026#34;ğŸ“\u0026#34; staged = \u0026#39;[++\\($count\\)](green)\u0026#39; renamed = \u0026#34;ğŸ‘…\u0026#34; deleted = \u0026#34;ğŸ—‘\u0026#34; [aws] format = \u0026#39;\\[[$symbol($profile)(\\($region\\))(\\[$duration\\])]($style)\\]\u0026#39; disabled = true [c] format = \u0026#39;\\[[$symbol($version(-$name))]($style)\\]\u0026#39; disabled = true [cmake] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [cmd_duration] format = \u0026#39;\\[[âŒ›ï¸$duration]($style)\\]\u0026#39; # format = \u0026#39;\\[[$duration]($style)\\]\u0026#39; [cobol] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [conda] format = \u0026#39;\\[[$symbol$environment]($style)\\]\u0026#39; disabled = true [crystal] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [dart] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [deno] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [docker_context] format = \u0026#39;\\[[$symbol$context]($style)\\]\u0026#39; [dotnet] format = \u0026#39;\\[[$symbol($version)(ğŸ¯ $tfm)]($style)\\]\u0026#39; disabled = true [elixir] format = \u0026#39;\\[[$symbol($version \\(OTP $otp_version\\))]($style)\\]\u0026#39; disabled = true [elm] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [erlang] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [gcloud] format = \u0026#39;\\[[$symbol$account(@$domain)(\\($region\\))]($style)\\]\u0026#39; disabled = true [git_branch] format = \u0026#39;\\[[$branch]($style)\\]\u0026#39; [golang] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [haskell] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [helm] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [hg_branch] format = \u0026#39;\\[[$symbol$branch]($style)\\]\u0026#39; disabled = true [java] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [julia] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [kotlin] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [kubernetes] format = \u0026#39;\\[[$symbol$context( \\($namespace\\))]($style)\\]\u0026#39; disabled = true [line_break] disabled = true [localip] ssh_only = true\t# Only show IP address when connected to an SSH session. format = \u0026#39;[$localipv4]($style) \u0026#39; # The format for the module. style = \u0026#39;bold yellow\u0026#39; # The style for the module. #Disables the localip module. # disabled = false [lua] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [memory_usage] format = \u0026#39;\\[$symbol[$ram( | $swap)]($style)\\]\u0026#39; disabled = true [nim] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [nix_shell] format = \u0026#39;\\[[$symbol$state( \\($name\\))]($style)\\]\u0026#39; disabled = true [nodejs] format = \u0026#39;\\[[ğŸ¤– ($version)]($style)\\]\u0026#39; disabled = true [ocaml] format = \u0026#39;\\[[$symbol($version)(\\($switch_indicator$switch_name\\))]($style)\\]\u0026#39; disabled = true [openstack] format = \u0026#39;\\[[$symbol$cloud(\\($project\\))]($style)\\]\u0026#39; disabled = true [package] format = \u0026#39;\\[[$symbol$version]($style)\\]\u0026#39; disabled = true [perl] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [php] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [pulumi] format = \u0026#39;\\[[$symbol$stack]($style)\\]\u0026#39; disabled = true [purescript] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [python] format = \u0026#39;\\[[${symbol}${pyenv_prefix}(${version})(\\($virtualenv\\))]($style)\\]\u0026#39; disabled = true [red] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [ruby] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [rust] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [singularity] format = \u0026#39;[ğŸ“¦ \\[$env\\]]($style) \u0026#39; disabled = true [scala] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [spack] format = \u0026#39;\\[[$symbol$environment]($style)\\]\u0026#39; disabled = true [sudo] format = \u0026#39;\\[[as $symbol]\\]\u0026#39; [swift] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [terraform] format = \u0026#39;\\[[$symbol$workspace]($style)\\]\u0026#39; disabled = true [time] format = \u0026#39;\\[[$symbol$time]($style)\\]\u0026#39; disabled = true [username] format = \u0026#39;\\[[$user]($style)\\]\u0026#39; disabled = true [vagrant] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; disabled = true [vlang] disabled = true [zig] format = \u0026#39;\\[[$symbol($version)]($style)\\]\u0026#39; tmux 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 set -g mouse on set -g base-index 1 setw -g pane-base-index 1 set -g visual-activity off set -g visual-bell off set -g visual-silence off setw -g monitor-activity off set -g bell-action none # modes setw -g clock-mode-colour colour5 setw -g mode-style \u0026#39;fg=colour1 bg=colour18 bold\u0026#39; # panes set -g pane-border-style \u0026#39;fg=colour19 bg=colour0\u0026#39; set -g pane-active-border-style \u0026#39;bg=colour0 fg=colour9\u0026#39; # statusbar set -g status-position bottom set -g status-justify left set -g status-style \u0026#39;bg=colour18 fg=colour137 dim\u0026#39; set -g status-left \u0026#39;\u0026#39; set -g status-right \u0026#39;#[fg=colour233,bg=colour19] %d/%m #[fg=colour233,bg=colour8] %H:%M:%S \u0026#39; set -g status-right-length 50 set -g status-left-length 20 # window setw -g window-status-current-style \u0026#39;fg=colour1 bg=colour19 bold\u0026#39; setw -g window-status-current-format \u0026#39; #I#[fg=colour249]:#[fg=colour255]#W#[fg=colour249]#F \u0026#39; setw -g window-status-style \u0026#39;fg=colour9 bg=colour18\u0026#39; setw -g window-status-format \u0026#39; #I#[fg=colour237]:#[fg=colour250]#W#[fg=colour244]#F \u0026#39; setw -g window-status-bell-style \u0026#39;fg=colour255 bg=colour1 bold\u0026#39; # messages set -g message-style \u0026#39;fg=colour232 bg=colour16 bold\u0026#39; ","date":"2023-02-17T00:50:19+08:00","permalink":"https://chasing1020.github.io/post/dotfiles/","title":"Dotfiles"},{"content":"æœ¬æ¬¡å®ç°æ˜¯å…³äº PingCap Talenet Plan 2022 TinySQL å­¦ä¹ è¥ç›¸å…³çš„å®éªŒè§£é¢˜æ€è·¯ã€‚æœ¬æ¬¡å®éªŒå¯ä»¥ä½œä¸º CMU 15-445 çš„è¡¥å……ï¼Œä¸»è¦å†…å®¹ä¸ºæ¯å‘¨çš„è®²åº§+é€šè¿‡Labçš„æ‰€æœ‰æµ‹è¯„ Case ï¼Œæ€»ä½“å®ç°éš¾åº¦å¹¶ä¸é«˜ï¼Œä»¥ä¸‹æ˜¯æ¯ä¸ª Project å®ç°çš„å…·ä½“æ€è·¯ç»†èŠ‚ã€‚\nProject 1 ç›¸å½“äºæ˜¯é¡¹ç›®çš„ kick-off ï¼Œä¸»è¦å†…å®¹ä¸ºé¡¹ç›®çš„åŸºæœ¬ä»‹ç»ï¼ŒåŒ…æ‹¬ SQL å…³ç³»ä»£æ•°å…¥é—¨ä¸ç ”ç©¶æ•°æ®å¦‚ä½•æ˜ å°„åˆ° TinyKV ä¸Šã€‚ å…·ä½“æ¥è¯´ï¼Œå¯¹æ¯ä¸ªè¡¨åˆ†é…ä¸€ä¸ª TableIDï¼Œæ¯ä¸€è¡Œåˆ†é…ä¸€ä¸ª RowIDï¼Œå…¶ä¸­ TableID åœ¨æ•´ä¸ªé›†ç¾¤å†…å”¯ä¸€ï¼ŒRowID åœ¨è¡¨å†…å”¯ä¸€ï¼Œè¿™äº› ID éƒ½æ˜¯ int64 ç±»å‹ã€‚ æœ¬æ¬¡é¡¹ç›®å®ç°éå¸¸ç®€å•ï¼Œ\nProject 2 æœ¬èŠ‚ä¸º Parser éƒ¨åˆ†ï¼Œä¸»è¦ç ”ç©¶ TinySQL æ˜¯å¦‚ä½•å°†æ–‡æœ¬è½¬åŒ–ä¸º AST çš„ã€‚ æœ¬èŠ‚åˆ©ç”¨ yacc æ¥è¿›è¡Œ SQL è¯­æ³•çš„è¡¥å……ï¼Œå¯ä»¥çœ‹å‡ºï¼Œast.XXXStmt ç»“æ„ä½“å†…åŒ…å«çš„å†…å®¹å’Œç›¸å¯¹åº”çš„è¯­å¥è¯­æ³•éƒ½æ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚ æ‰€æœ‰äº§ç”Ÿå¼ä¹Ÿéƒ½æ˜¯æ ¹æ®å¯¹åº”çš„ SQL è¯­æ³•æ¥ç¼–å†™çš„ã€‚è¿™ä¸ªæ–‡ä»¶æœ€åˆæ˜¯ç”¨å·¥å…·ä» BNF è½¬åŒ–ç”Ÿæˆçš„ï¼Œæ­¤ Project ä¸­è¡¥å……çš„æ˜¯ Join çš„è¯­æ³•ï¼Œé’ˆå¯¹æµ‹è¯•ç”¨ä¾‹ä¸­çš„ join, left join, right join, join on ç¼–å†™ yacc æ–‡ä»¶å³å¯ï¼Œå³å®Œæˆå¦‚ä¸‹ä¸¤ç§æ¨¡å¼çš„åŒ¹é…ã€‚\n1 2 TableRef JoinType OuterOpt \u0026#34;JOIN\u0026#34; TableRef \u0026#34;ON\u0026#34; Expression TableRef CrossOpt TableRef \u0026#34;ON\u0026#34; Expression Project 3 æœ¬èŠ‚å®ç°äº† SQL DDL ä¸­åˆ é™¤ä¸€åˆ—çš„æ“ä½œï¼ŒTinySQL ä¸­çš„å¼‚æ­¥ schema å˜æ›´æ˜¯å‚ç…§äº† Google F1 ä¸­çš„ schema å˜æ›´çš„ç®—æ³•ã€‚ä¸»è¦å†…å®¹ä¸ºå‚è€ƒè®ºæ–‡åŸæ–‡ Online, Asynchronous Schema Change in F1ã€‚ å®éªŒä»£ç ä¸»è¦æ·»åŠ äº† public â€“\u0026gt; write-only â€“\u0026gt; delete-only â€“\u0026gt; (reorg) â€“\u0026gt; absent ä¸€ç³»åˆ—è½¬æ¢çš„é€»è¾‘ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æœ€åæ£€æŸ¥ job.IsRollingback() ï¼Œä»¥æ­¤åˆ¤æ–­è°ƒç”¨FinishTableJobæ—¶æ˜¯å®Œæˆè¿˜æ˜¯éœ€è¦RollBackã€‚\nProject 4 åœ¨ä¼˜åŒ–è¿™ä¸€éƒ¨åˆ†ï¼Œä¸»è¦ç ”ç©¶ä¼˜åŒ–å™¨çš„ä¸¤ç§æ¡†æ¶ï¼Œå¦‚ä½•ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯è¿›è¡Œæ•°æ®åˆ†å¸ƒçš„ä¼°ç®—å’Œç´¢å¼•çš„é€‰æ‹©ã€‚\nPart 1 æœ¬éƒ¨åˆ†ä¸»è¦å…³äº System R ä¼˜åŒ–å™¨çš„å®ç°ï¼Œä¸»è¦æ˜¯å®ç° PredicatePushDown è¿™ä¸ªæ–¹æ³•ã€‚\nä¼˜åŒ–å™¨çš„å…¥å£ä¸º plannercore.DoOptimizeï¼Œåœ¨é€»è¾‘ä¼˜åŒ–éƒ¨åˆ†ï¼Œå…ˆé€šè¿‡flagåˆ¤æ–­éœ€è¦æ‰§è¡Œçš„å†…å®¹ï¼Œéå†ä¼˜åŒ–çš„è§„åˆ™åˆ—è¡¨ã€‚\nPredicatePushDown è¿™ä¸ªæ–¹æ³•ä¸ºå®é™…çš„é€»è¾‘è®¡åˆ’å®ç°è°“è¯ä¸‹æ¨ã€‚è¿™é‡Œå®ç°äº† LogicalAggregation çš„è°“è¯ä¸‹æ¨ï¼Œå…ˆé€šè¿‡ group by çš„åˆ—æ‰¾åˆ°å¯ä»¥ä¸‹æ¨çš„ condtionï¼Œç„¶åä¿ç•™å…¶ä¸­æœ‰ç”¨çš„åˆ—ï¼Œæœ€åå°†é€‰å‡ºæ¥çš„è°“è¯è¿›è¡Œä¸‹æ¨å³å¯ã€‚ä¸»è¦ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 for _, cond := range predicates { switch cond.(type) { // ... case *expression.ScalarFunction: newFunc := expression.ColumnSubstitute(cond, la.Schema(), exprsOriginal) condsToPush = append(condsToPush, newFunc) // ... } } la.baseLogicalPlan.PredicatePushDown(condsToPush) Part 2 æœ¬æ¬¡Partä¸»è¦å®ç°å’Œä»£ä»·é€‰æ‹©ç›¸å…³çš„ä¸€äº›å†…å®¹\n1. Count-Min Sketch å½“ç»“æŸå¯å‘å¼è§„åˆ™çš„ç­›é€‰ä¹‹åï¼Œæˆ‘ä»¬ä»ç„¶å¯èƒ½å‰©ä½™å¤šç»„ç´¢å¼•ç­‰å¾…ç­›é€‰æˆ‘ä»¬å°±éœ€è¦çŸ¥é“æ¯ä¸ªç´¢å¼•ç©¶ç«Ÿä¼šè¿‡æ»¤å¤šå°‘è¡Œæ•°æ®ã€‚ å®ç° CM Sketch ç®—æ³•ï¼ŒåŒ…æ‹¬æ–°å¢ value ä»¥åŠæŸ¥è¯¢ valueã€‚æ ¸å¿ƒ insert é€»è¾‘å¦‚ä¸‹\n1 2 3 4 h1, h2 := murmur3.Sum128(bytes) for i := range c.table { j := (h1 + h2*uint64(i)) % uint64(c.width) // hash } æ–°å¢ value è¾ƒä¸ºç®€å•ï¼Œç®—å‡º Hash ä¹‹åå†å°† table ä¸­å¯¹åº”ä½ç½®çš„ count å¢åŠ å³å¯ã€‚å‚è€ƒæ–‡ç«  TiDB ä½¿ç”¨äº† Count-Mean-Min Sketch ç®—æ³•ï¼Œå¼•å…¥äº†ä¸€ä¸ªå™ªå£°å€¼ (N - CM[i, j]) / (w-1) ï¼Œå…¶ä¸­ N ä¸ºæ€»æ•°ï¼Œw ä¸º table å®½åº¦ï¼Œå†å–æ‰€æœ‰è¡Œçš„å€¼å‡å»å™ªéŸ³ä¹‹åçš„ä¼°è®¡å€¼çš„ä¸­ä½æ•°ä½œä¸ºæœ€åçš„ä¼°è®¡å€¼ã€‚\n2. Join Reorder æœ¬èŠ‚å®ç°äº†ç”¨åŠ¨æ€è§„åˆ’ç®—æ³•æ‰¾å‡ºæœ€ä¼˜ join é¡ºåºã€‚æœ¬æ¬¡å®éªŒé€»è¾‘å‚è€ƒè¾ƒå¤š TiDB å®ç°ã€‚ä¸»è¦å®ç°ä¸¤ä¸ªå‡½æ•° bfsGraph å’Œ dpGraphã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š\nä»¥é‚»æ¥è¡¨çš„æ–¹å¼å»ºç«‹ Join å›¾ï¼Œè®°å½•ä¸‹ joinGroupEqEdge ä¸ joinGroupNonEqEdgeã€‚ ä»ä¸€ä¸ªæ²¡æœ‰è®¿é—®çš„ç‚¹å¼€å§‹è¿›è¡Œå¹¿åº¦ä¼˜å…ˆéå†ï¼Œå¾—åˆ°ä¸€ä¸ªè¿é€šçš„ Join èŠ‚ç‚¹åºåˆ—ï¼Œè¿”å›æ•°ç»„ visitID2NodeIDã€‚ å¯¹äºè¿™äº›èŠ‚ç‚¹çš„ costï¼Œè¿›è¡ŒåŠ¨æ€è§„åˆ’ç®—æ³•å¾—å‡ºæœ€å°‘ cost çš„ Join æ–¹æ¡ˆï¼Œå¦‚æœè¿˜æœ‰æ²¡è®¿é—®çš„èŠ‚ç‚¹ï¼Œåˆ™è¿›è¡Œå¾ªç¯ã€‚ å¯¹æ‰€æœ‰ Join æ–¹æ¡ˆè°ƒç”¨ s.makeBushyJoin å¾—åˆ°æœ€ç»ˆç»“æœã€‚ 3. Access Path Selection æœ¬èŠ‚å®ç° Skyline Prune å¯å‘å¼ç®—æ³•æ¥æ’é™¤æ•ˆæœä¸€å®šæ›´å·®çš„è·¯å¾„ï¼Œé‡ç‚¹åœ¨äºå®ç° compareCandidates å‡½æ•°ã€‚æ ¹æ®æ³¨é‡Šæ¥å®ç°ï¼š\næ¯”è¾ƒä¸¤ä¸ª candidate çš„ colï¼Œè¦†ç›–èŒƒå›´æ›´å¤§çš„ candidate æ›´ä¼˜ã€‚è¿™é‡Œçš„ columnSet æ•°æ®ç»“æ„ä¸º intsets.Sparseï¼Œæ‰€ä»¥åªéœ€è¦åˆ¤æ–­ s2.Len() \u0026lt; s1.Len() \u0026amp;\u0026amp; s2.SubsetOf(s1) å³å¯ã€‚ æ¯”è¾ƒä¸¤ä¸ª candidate æ˜¯å¦ match physical propertyï¼Œmatch çš„é‚£ä¸ªæ›´ä¼˜ï¼Œè¿™é‡Œ isSingleScan å·²ç»æ˜¾ç¤ºç»™å‡ºã€‚ æ¯”è¾ƒä¸¤ä¸ª candidate æ˜¯å¦åªéœ€è¦æ‰«é¢ä¸€æ¬¡ï¼Œåªæ‰«æä¸€æ¬¡çš„é‚£ä¸ªæ›´ä¼˜ï¼ŒåŒä¸Šï¼Œåªéœ€è¦æ¯”è¾ƒ isMatchProp å³å¯ã€‚ æœ€åç»¼åˆä»¥ä¸Šä¸‰ç§æƒ…å†µï¼Œå°†ä¸‰è€…æ¯”è¾ƒçš„éƒ¨åˆ†è¿›è¡Œæ±‚å’Œï¼Œå³ accessResult + scanResult + matchResult å¤§äº0ä¸”æ‰€æœ‰å€¼å‡å¤§äºç­‰äºçš„æƒ…å†µä¸‹æ’é™¤è¯¥åˆ†æ”¯ã€‚\nProject 5 Part 1 1. å®ç°å‘é‡åŒ–è¡¨è¾¾å¼ å‚è€ƒå…¶ä»–å‡½æ•°å‘é‡åŒ–æ–¹æ³•ç¼–å†™ï¼Œå…ˆè·å–æ•°æ®ï¼Œå†ç¼–å†™ä¸»è¦é€»è¾‘ï¼Œå‚è€ƒ MySQL String ç›¸å…³å‡½æ•°ï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 result.ResizeInt64(n, false) result.MergeNulls(buf) i64s := result.Int64s() for i := 0; i \u0026lt; n; i++ { if result.IsNull(i) { continue } i64s[i] = int64(len(buf.GetString(i))) } 2. å®ç°å‘é‡åŒ– selection çš„ Next ä¸º SelectionExec å®ç° Next æ–¹æ³•ï¼Œæ•´ä½“é€»è¾‘å¯ä»¥å‚è€ƒ unBatchedNext æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äºæ¯æ¬¡éƒ½æ˜¯å‘é‡åŒ–æ‰¹é‡å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå’Œä¼ ç»Ÿçš„ Volcano æ¨¡å‹çš„ä¸€æ¬¡å–ä¸€è¡Œç›¸æ¯”ï¼Œè¿™é‡Œä¼šé€šè¿‡ selected æ•°ç»„å¾ªç¯åˆ¤æ–­ï¼Œä¸€æ¬¡å–ä¸€æ‰¹æ•°æ®ã€‚è¿™ä¸ª selected æ•°ç»„é€šè¿‡è°ƒç”¨ VectorizedFilter å³å¯ä» children ä¸­æ‹¿åˆ°ï¼Œå®éªŒä»£ç æ•°æ®ç»“æ„ä¸º SelectionExec.selectedã€‚ç†è§£ Next çš„å…³é”®å°±æ˜¯å½“å‰ Executor èŠ‚ç‚¹çš„ input æ˜¯é€šè¿‡å…¶ children çš„ Next æ‹¿åˆ°ï¼Œå‘é‡åŒ–çš„ä½œç”¨åˆ™æ˜¯æ¯æ¬¡æ˜¯æ‹¿ä¸€æ‰¹æ•°æ®è€Œä¸å•å•åªæ˜¯ä¸€è¡Œã€‚åœ¨ç†æ˜æœ€åæœ€åæ‰§è¡Œ expression.VectorizedFilter(e.ctx, e.filters, e.inputIter, e.selected) è¿›è¡Œ selected æ•°ç»„çš„æ›´æ–°å³å¯ã€‚\nPart 2 å®ç°å¹¶è¡Œ Hash Join ç®—æ³•ã€‚\n1. å®ç° fetchAndBuildHashTable é¦–å…ˆè°ƒç”¨ newHashRowContainer ç”Ÿæˆä¸€ä¸ªæ–°çš„ hash tableï¼Œç„¶åé€šè¿‡å¾ªç¯è°ƒç”¨ Next ä» inner table ä¸­è·å–æ•°æ®ï¼ˆchunkï¼‰ï¼Œå†å°†æ•°æ®æ”¾å…¥ hash tableï¼Œç›´è‡³æ²¡æœ‰æ›´å¤šæ•°æ®å³å¯ã€‚ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 e.rowContainer = newHashRowContainer(e.ctx, int(e.innerSideEstCount), hCtx, initList) for { chk := chunk.NewChunkWithCapacity(retTypes(e.innerSideExec), e.maxChunkSize) err := Next(ctx, e.innerSideExec, chk) if err != nil { return err } if chk.NumRows() == 0 { return nil } if err = e.rowContainer.PutChunk(chk); err != nil { return err } } 2. å®ç° runJoinWorker è¿™éƒ¨åˆ†çš„æ ¸å¿ƒåœ¨äºåˆ†æ¸…æ¥šå„ä¸ª Channel çš„åŠŸèƒ½ä¸æ”¶å‘æ•°æ®çš„æ—¶æœºã€‚è´Ÿè´£æ‹¿å– outer table çš„æ•°æ®å¹¶ probe inner table å»ºç«‹çš„ hash è¡¨è¿›è¡Œ join æ“ä½œï¼Œå¹¶è¿”å›äº¤è¿‡åˆ° main threadï¼Œä»¥ä¸‹æ˜¯å‡ ä¸ªä¸»è¦éœ€è¦ç”¨çš„ channel å˜é‡åŠå…¶ç”¨æ³•ï¼š\ncloseChï¼š ç”¨äºç»“æŸ loop çš„é€šé“ï¼Œselect ç›‘æµ‹åˆ°è¯¥ä¿¡å·ç›´æ¥é€€å‡ºå¾ªç¯ã€‚ outerResultChsï¼š outer fetcher é€šè¿‡æ­¤é€šé“æ¥å‘ä¸åŒçš„ join worker åˆ†å‘ä»»åŠ¡ã€‚ outerChkResourceChï¼šè¿”å›å½“å‰ worker æ¥æ”¶ä»»åŠ¡ç”¨çš„é€šé“ä»¥åŠæœ¬ worker ç”¨çš„ chunkï¼Œå¾ªç¯åˆ©ç”¨ chunkï¼Œé¿å…é‡æ–°åˆ†é…å†…å­˜ã€‚ joinChkResourceChï¼š outer table çš„æ•°æ®æ”¶é›†å®Œæ¯•åï¼Œé€šè¿‡æ­¤é€šé“è¿”å› hash join çš„ç»“æœã€‚ å¼„æ¸…æ¥šå„ä¸ª Channel ä¹‹é—´çš„å…³ç³»ä»¥å åªéœ€åœ¨å¾ªç¯ä¸­åå¤è°ƒç”¨ e.join2Chunk(workerID, probeSideResult, hCtx, joinResult, selected) æ ¹æ®å…·ä½“æƒ…å†µå‘é€ Channel å³å¯ã€‚\nPart 3 æœ¬èŠ‚ä¸»è¦å®ç° Hash Aggregateã€‚æœ‰ç‚¹ç±»ä¼¼äº MapReduce çš„æ€è·¯ï¼Œå³æŠŠæ•´ä¸ªè®¡ç®—ä»»åŠ¡åˆ†é…ç»™å¤šä¸ª PartialWorkerï¼Œç„¶åæŒ‰ç…§ Key é¢„èšåˆï¼Œå†Shuffle ç»™ä¸åŒçš„ FinalWorker è¿›è¡Œ Value çš„èšåˆï¼Œæœ€åå†è¿”å›ç»™ Main ç»„åˆæˆæœ€ç»ˆç»“æœã€‚\n1. consumeIntermData å¾ªç¯é€šè¿‡ w.getPartialResult(sc, w.groupKeys, w.partialResultMap) æ‹¿åˆ°æ•°æ®ï¼Œå†å°†æ•°æ®èšåˆåˆ°å¯¹åº”çš„ af.MergePartialResult(sctx, prs[j], finalPartialResults[i][j]) çš„ä½ç½®ï¼Œå®ç°éš¾åº¦ä¸å¤§ã€‚\n2. shuffleIntermData ä½¿ç”¨ int(murmur3.Sum32([]byte(groupKey))) % finalConcurrency ç®—å‡ºæŸä¸ª Key åº”è¯¥å‘ç»™å“ªä¸ª final workerï¼Œç„¶åé€šè¿‡ outputChs å°†è¿™äº› groupKeysSlice[i] ä¸ w.partialResultsMapï¼Œå‘é€ç»™å¯¹åº” worker å³å¯ã€‚\nProject6 Percolator æäº¤åè®®çš„ä¸¤é˜¶æ®µæäº¤åˆ†ä¸º Prewrite å’Œ Commitï¼šPrewrite å®é™…å†™å…¥æ•°æ®ï¼ŒCommit è®©æ•°æ®å¯¹å¤–å¯è§ã€‚ åœ¨å¯¹ Key è¿›è¡Œå†™æ“ä½œæ—¶ï¼Œéœ€è¦å°†å…¶å‘é€åˆ°æ­£ç¡®çš„ Region ä¸Šæ‰èƒ½å¤Ÿå¤„ç†ã€‚ä¸»è¦ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 for i, k := range keys { if lastLoc == nil || !lastLoc.Contains(k) { var err error lastLoc, err = c.LocateKey(bo, k) if err != nil { return nil, first, err } if filter != nil \u0026amp;\u0026amp; filter(k, lastLoc.StartKey) { continue } } if i == 0 { first = lastLoc.Region } regionVerIDMap[lastLoc.Region] = append(regionVerIDMap[lastLoc.Region], k) } åœ¨ Prewrite é˜¶æ®µï¼Œå¯¹äºä¸€ä¸ª Key çš„æ“ä½œä¼šå†™å…¥ä¸¤æ¡è®°å½•ã€‚1. Default CF ä¸­å­˜å‚¨å®é™…çš„ KV æ•°æ®ï¼›2.Lock CF ä¸­å­˜å‚¨äº†é”ï¼ŒåŒ…æ‹¬ Key å’Œæ—¶é—´æˆ³ä¿¡æ¯ï¼Œä¼šåœ¨ Commit æˆåŠŸæ—¶æ¸…ç†ã€‚\nLock Resolver çš„èŒè´£å°±æ˜¯åº”å¯¹ä¸€ä¸ªäº‹åŠ¡åœ¨æäº¤è¿‡ç¨‹ä¸­é‡åˆ° Lock çš„æƒ…å†µã€‚\nè¿™é‡Œçš„ buildPrewriteRequest éœ€è¦å°†è¯·æ±‚çš„ Mutations è¿›è¡Œå°è£…ï¼Œæ­¤å¤– PrimaryLock åº”èµ‹å€¼ä¸º c.primary() ä»¥é˜²æ­¢ primaryKey ä¸º 0 çš„åœºæ™¯ã€‚\n1 2 3 for _, key := range batch.keys { req.Mutations = append(req.Mutations, \u0026amp;c.mutations[string(key)].Mutation) } åœ¨ handleSingleBatch é€»è¾‘é‡Œä¸ actionPrewrite åŸºæœ¬ç±»ä¼¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯åœ¨ actionCleanup æ‰§è¡Œåå°† c.mu.committed èµ‹å€¼ä¸º falseã€‚\nå¯¹äº tikvSnapshot.Get æ–¹æ³•ï¼Œæ·»åŠ å¦‚ä¸‹é€»è¾‘ï¼š\nå¦‚æœäº‹åŠ¡æ­£åœ¨æäº¤ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å¹¶é‡è¯•ï¼› 2. å¦‚æœäº‹åŠ¡å·²ç»ç»“æŸå¹¶ä¸”å¸¦æœ‰é”ï¼Œåˆ™è¿›è¡Œå¼‚å¸¸å¤„ç† 1 2 3 4 5 6 7 8 9 10 msBeforeExpired, _, err := s.store.lockResolver.ResolveLocks(bo, 0, []*Lock{lock}) if err != nil { return nil, err } if msBeforeExpired \u0026gt; 0 { err = bo.BackoffWithMaxSleep(BoTxnLock, int(msBeforeExpired), errors.Errorf(\u0026#34;2PC get lockedKeys: %d\u0026#34;, 1)) if err != nil { return nil, errors.Trace(err) } } Comments and Suggestions å¦‚ä¸‹ä¸ºæœ¬æ¬¡å®éªŒçš„ä¸€äº›æ”¹è¿›å»ºè®®ï¼Œéƒ¨åˆ†å†…å®¹å·²æäº¤prã€‚\nåœ¨ Project1-Part2 ä¸­ï¼Œ DecodeIndexKeyPrefix æ“ä½œå¯ä»¥åœ¨ä»¥ä¸‹æšä¸¾å€¼ä¸­æ·»åŠ ä¸€é¡¹ï¼Œæ–¹ä¾¿å¯¹å«ç´¢å¼•çš„å†…å®¹éƒ¨åˆ†è¿›è¡Œæ“ä½œï¼Œåä¹‹åˆ™éœ€è¦åœ¨ä»£ç ä¸­æ’å…¥å¸¸æ•°åç§»å€¼ï¼Œä¸ä¾¿ç»´æŠ¤ã€‚ 1 2 3 4 5 6 7 8 9 const ( idLen = 8 prefixLen = 1 + idLen /*tableID*/ + 2 // RecordRowKeyLen is public for calculating average row size. RecordRowKeyLen = prefixLen + idLen /*handle*/ tablePrefixLength = 1 recordPrefixSepLength = 2 indexPrefixSepLength = 2 // Add here ) åœ¨ Project2 ä¸­ï¼Œå‚è€ƒ MySQL çš„æ‰‹å†Œï¼Œå»ºè®®æ·»åŠ  join_specification ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ–è€…ä¿®æ”¹ parser.y ä¸­å¦‚ä¸‹æ³¨é‡Šï¼Œé¿å…å­¦ç”Ÿäº§ç”Ÿè¯¯è§£ã€‚ 1 2 3 4 5 joined_table: { table_reference {[INNER | CROSS] JOIN | STRAIGHT_JOIN} table_factor [join_specification] | table_reference {LEFT|RIGHT} [OUTER] JOIN table_reference join_specification | table_reference NATURAL [INNER | {LEFT|RIGHT} [OUTER]] JOIN table_factor } åœ¨ Project3 ä¸­ï¼Œåœ¨ AutoGrading Machine ä¸Šçš„æµ‹è¯•ç»“æœåº”è¯¥è°ƒæ•´ä¸ Project6 æ— å…³ï¼Œé¿å…æµ‹è¯•ç»“æœä¸æœ¬åœ°å­˜åœ¨å·®å¼‚ä½¿å­¦ç”Ÿäº§ç”Ÿç–‘æƒ‘ã€‚\nProject6 ä¸­ï¼ŒttlEquals.ttlEquals çš„æµ‹è¯•ä»£ç  c.Assert(int(math.Abs(float64(x-y))), LessEqual, 2) åœ¨æ–°ç‰ˆè‹¹æœç”µè„‘ä¸Šè¿è¡Œç»“æœä¸ºé”™è¯¯ï¼Œä½†æ˜¯æäº¤æµ‹è¯„æœºç»“æœæ­£å¸¸ï¼ŒåŸå› æ˜¯ arm64 ä¸‹ math.Abs() è¿”å›å€¼ä¹Ÿæ˜¯ uintï¼ˆè¿™éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹çš„åˆ¤æ–­é€»è¾‘å†™çš„å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œå®Œå…¨å¯ä»¥æ‰‹å†™ abs å‡½æ•°é¿å…å¼ºè½¬ä¸º float64 è¿‡ç¨‹ä¸­å¯èƒ½çš„é”™è¯¯ï¼‰ï¼Œå¯¹äº runtime.GOARCH çš„æ£€æµ‹éœ€å¢åŠ  â€œarm64â€ã€‚è¿™éƒ¨åˆ†å†…å®¹å·²ç»æäº¤ Pull Request #145ã€‚\n","date":"2022-08-13T18:24:56+08:00","image":"https://chasing1020.github.io/post/tinysql-implementation/talent-plan_hub37bed894517c8c0c46efedb5ba1232d_43996_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/tinysql-implementation/","title":"TinySQL Implementation"},{"content":"By default, the theme even doesn\u0026rsquo;t support the search and copy to the clipboard button which is proposed in issues#289 and issues#399. So I have finished implementing the features.\n1. Search Initially, you should add the output of JSON in your ./config.toml file.\n1 2 [outputs] home = [\u0026#34;HTML\u0026#34;, \u0026#34;RSS\u0026#34;, \u0026#34;JSON\u0026#34;] Then create the file ./themes/even/layouts/_default/index.json and add these lines. Then make sure you can see the output in the localhost:1313/index.json.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 {{- $.Scratch.Add \u0026#34;index\u0026#34; slice -}} {{- range $index, $element := .Site.RegularPages.ByTitle -}} {{if ne .Params.tags nil}}{{if ne .Plain nil}} {{- $.Scratch.Add \u0026#34;index\u0026#34; (dict \u0026#34;id\u0026#34; $index \u0026#34;date\u0026#34; .Date \u0026#34;tags\u0026#34; .Params.tags \u0026#34;categories\u0026#34; .Params.categories \u0026#34;title\u0026#34; .Title \u0026#34;permalink\u0026#34; .Permalink \u0026#34;contents\u0026#34; .Plain ) -}} {{end}}{{end}} {{- end -}} {{- $.Scratch.Get \u0026#34;index\u0026#34; | jsonify -}} And add file ./themes/even/static/js/search.js. I have stored the search object so just need to load the file one time once you enter the search page.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 const summaryInclude = 100; let fuseOptions = { includeMatches: true, threshold: 0.1, tokenize: true, location: 0, distance: 100000, maxPatternLength: 32, minMatchCharLength: 1, keys: [ {name: \u0026#34;title\u0026#34;, weight: 0.9}, {name: \u0026#34;contents\u0026#34;, weight: 0.8}, {name: \u0026#34;tags\u0026#34;, weight: 0.3}, {name: \u0026#34;categories\u0026#34;, weight: 0.3} ] }; let fuse; fetch(\u0026#34;../index.json\u0026#34;) .then(resp =\u0026gt; resp.json()) .then(data =\u0026gt; fuse = new Fuse(data, fuseOptions)); let searchContent = \u0026#34;\u0026#34;; async function executeSearch() { searchContent = $(\u0026#39;#search-content\u0026#39;)[0].value; let results = fuse.search(searchContent); await populateResults(results); } function highlight(str) { return str.replace( new RegExp(searchContent, \u0026#39;gi\u0026#39;), searchContent =\u0026gt; `\u0026lt;strong\u0026gt;\u0026lt;span style=\u0026#34;background-color:yellow;\u0026#34;\u0026gt;${searchContent}\u0026lt;/span\u0026gt;\u0026lt;/strong\u0026gt;` ); } async function populateResults(result){ $(\u0026#39;#search-results\u0026#39;).html(\u0026#39;\u0026#39;); $.each(result, function(key, value) { let contents = value.item.contents; let snippet = \u0026#34;\u0026#34;, start = 0, end = 0; let pos = contents.toLocaleLowerCase().indexOf(searchContent.toLocaleLowerCase()); if (pos != -1) { start = pos - summaryInclude; end = pos + summaryInclude; if (start \u0026lt; 0) start = 0; if (end \u0026gt; contents.length) end = contents.length; snippet = contents.substring(start, end); } $.each(value.matches,function(k, v) { start = v.indices[0][0] - summaryInclude; end = v.indices[0][1] + summaryInclude + 1; if (start \u0026lt; 0) start = 0; if (end \u0026gt; v.value.length) end = v.value.length; if (pos == -1 \u0026amp;\u0026amp; v.key == \u0026#34;contents\u0026#34;) { snippet += v.value.substring(start, end); } }); if(snippet.length \u0026lt; 1){ snippet += contents.substring(0, summaryInclude * 2); } let tags = []; value.item.tags.forEach(t =\u0026gt; tags.push(highlight(t))); let categories = []; value.item.categories.forEach(c =\u0026gt; categories.push(highlight(c))); let template = ` \u0026lt;div id=\u0026#34;summary-${key}\u0026#34;\u0026gt; \u0026lt;article style=\u0026#34;padding: 0px\u0026#34; class=\u0026#34;post\u0026#34;\u0026gt; \u0026lt;header class=\u0026#34;post-header\u0026#34;\u0026gt; \u0026lt;h1 class=\u0026#34;post-title\u0026#34;\u0026gt;\u0026lt;a style=\u0026#34;color:black\u0026#34; class=\u0026#34;post-link\u0026#34; href=\u0026#34;${value.item.permalink}\u0026#34;\u0026gt;${highlight(value.item.title)}\u0026lt;/a\u0026gt;\u0026lt;/h1\u0026gt; \u0026lt;div class=\u0026#34;post-meta\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;post-time\u0026#34;\u0026gt;${value.item.date}\u0026lt;/span\u0026gt; \u0026lt;div class=\u0026#34;post-category\u0026#34;\u0026gt;\u0026lt;a href=\u0026#34;/categories/${value.item.categories}/\u0026#34;\u0026gt; ${categories} \u0026lt;/a\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/header\u0026gt; \u0026lt;div class=\u0026#34;post-content\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;post-summary\u0026#34;\u0026gt; ${highlight(snippet)} \u0026lt;a href=\u0026#34;${value.item.permalink}\u0026#34; class=\u0026#34;read-more-link\u0026#34;\u0026gt;Read more...\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;footer class=\u0026#34;post-footer\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;post-tags\u0026#34;\u0026gt; \u0026lt;a href=\u0026#34;/tags/${value.item.tags}\u0026#34;\u0026gt;${tags}\u0026lt;/a\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/footer\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/article\u0026gt; \u0026lt;/div\u0026gt;`; $(\u0026#39;#search-results\u0026#39;).append(template); }); } And then just add the search page in your ./content/post/search.md. Although it\u0026rsquo;s not recommended to add the script tag in the middle of your markdown file, it is easy to implement the style that we expected.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 --- title: \u0026#34;Search\u0026#34; layout: \u0026#34;search\u0026#34; priority : 1 menu: \u0026#34;main\u0026#34; weight: 5 --- \u0026lt;script src=\u0026#34;https://cdn.jsdelivr.net/npm/fuse.js@6.6.2\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;script src=\u0026#34;/js/search.js\u0026#34;\u0026gt;\u0026lt;/script\u0026gt; \u0026lt;section id=\u0026#34;search-input\u0026#34;\u0026gt; \u0026lt;input style=\u0026#34;display: center\u0026#34; id=\u0026#34;search-content\u0026#34; placeholder=\u0026#34;Search text\u0026#34; type=\u0026#34;search\u0026#34; oninput=\u0026#34;executeSearch()\u0026#34;\u0026gt; ğŸ” \u0026lt;/section\u0026gt; \u0026lt;hr\u0026gt; \u0026lt;section id=\u0026#34;search-results\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;Please input some keywords to search\u0026lt;/h3\u0026gt; \u0026lt;/section\u0026gt; 2. Copy to clipboard I just add these lines to the end of ./themes/even/layouts/partials/scripts.html.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 \u0026lt;script\u0026gt; function createCopyButton(highlightDiv) { const div = document.createElement(\u0026#34;div\u0026#34;); div.className = \u0026#34;copy-code\u0026#34;; div.innerText = \u0026#34;Copy\u0026#34;; div.addEventListener(\u0026#34;click\u0026#34;, () =\u0026gt; copyCodeToClipboard(div, highlightDiv) ); addCopyButtonToDom(div, highlightDiv); } async function copyCodeToClipboard(button, highlightDiv) { const codeToCopy = highlightDiv.querySelector(\u0026#34;:last-child \u0026gt; .chroma \u0026gt; code\u0026#34;) .innerText; try { result = await navigator.permissions.query({ name: \u0026#34;clipboard-write\u0026#34; }); if (result.state == \u0026#34;granted\u0026#34; || result.state == \u0026#34;prompt\u0026#34;) { await navigator.clipboard.writeText(codeToCopy); } else { copyCodeBlockExecCommand(codeToCopy, highlightDiv); } } catch (_) { copyCodeBlockExecCommand(codeToCopy, highlightDiv); } finally { codeWasCopied(button); } } function codeWasCopied(div) { div.blur(); div.innerText = \u0026#34;Copied!\u0026#34;; setTimeout(function () { div.innerText = \u0026#34;Copy\u0026#34;; }, 2000); } function addCopyButtonToDom(button, highlightDiv) { highlightDiv.insertBefore(button, highlightDiv.firstChild); const wrapper = document.createElement(\u0026#34;div\u0026#34;); wrapper.className = \u0026#34;highlight-wrapper\u0026#34;; highlightDiv.parentNode.insertBefore(wrapper, highlightDiv); wrapper.appendChild(highlightDiv); } document.querySelectorAll(\u0026#34;.highlight\u0026#34;) .forEach((highlightDiv) =\u0026gt; createCopyButton(highlightDiv)); \u0026lt;/script\u0026gt; And modify the ./themes/even/assets/sass/_partial/_post/_code.sass file, add these lines. I think it is a good idea to make the theme style the same as the type on the left of the code block.\n1 2 3 4 5 6 7 8 9 10 11 12 .copy-code { position: absolute; right: 0; z-index: 2; font-size: .9em !important; padding: 0px 1.5rem !important; color: #b1b1b1; font-family: Arial; font-weight: bold; cursor: pointer; user-select: none; } ","date":"2022-07-04T10:50:10+08:00","image":"https://chasing1020.github.io/post/amend-hugo-theme-even/even_hu7239b18983faa84c364ba0614e368fc1_33946_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/amend-hugo-theme-even/","title":"Amend Hugo Theme Even"},{"content":"It is a yearly \u0026ldquo;divide major\u0026rdquo; season, and now I am looking back at the series of computer science questions and answers I have browsed in Zhihu during my freshman year, and I feel a lot of emotions. I have been thinking about it for a long time, and this is the first time I have seen such numerous questions and discussions about computer science, hence I write about this post. If you find any bugs or grammar issues, please don\u0026rsquo;t hesitate to contact me to fix them. Anyway, thanks again for accepting my poor English.\n0. Preface What is computer science? Why does our country need students majoring in it? What is the future of this major? Will computer science be popular in the future?\nTwo years later, when I introduced this major to my younger brother and sister who study at our university as a \u0026ldquo;past person\u0026rdquo;, it was too difficult for me to write the answer because I was worried about my lack of ability and short-sightedness, which brought all kinds of misguidance to them; secondly, the choice of major at the undergraduate level will probably affect a person\u0026rsquo;s life and mislead others. The third is that the choice of major at the undergraduate level may affect one\u0026rsquo;s life and mislead the future of others.\nTherefore, in this article, I will try my best to talk about my experience and thoughts in computer science over the past two years, and hope readers can gain something worthwhile. The content I share is only my opinion and does not represent any absolute theory.\n1. Our Environment This is an era of prosperity and crisis: Owing to the COVID-19, our world is experiencing changes never seen in a century.\nThe annually spring and autumn recruitment is the barometer of the development of the computer industry, from last year, Tencent paid 40w high salary in the hot search, and then some time ago, due to the epidemic of the re-emergence of the side of layoffs while also locking the head count. Until today President Liu Kiping of Tencent issued an article: \u0026ldquo;Internal manpower investment will be adjusted from the edge of the business to the core business, in the industry to occur fundamental changes in the industry when actively embracing change\u0026rdquo;.\nIn the general environment, today\u0026rsquo;s Internet is far less than what it was 10 years ago, the so-called \u0026ldquo;Although it is a pig, it can wind and waves.\u0026rdquo;, which Howard\u0026rsquo;s comment is: \u0026ldquo;Now the Internet from the era of incremental into the era of stock. Everyone has no way to make the cake bigger, so they can only grab each other\u0026rsquo;s cake\u0026rdquo;.\nThe Mythical Man-Month which is the bible of software engineering points out that more people can not shorten the software development progress, and it is dangerous to use \u0026ldquo;man-month\u0026rdquo; to measure the size of the work. Because the number of people != efficiency, the way to adjust the organizational structure of the current major manufacturers is also very straightforward - leaving the most valuable programmers. In this environment, with only a small pool of talent to dig, the Internet starting salary also seems very high.\nIf only to high salary or good employment and blindly choose computer science major, it can only be said to have entered the survivorship bias. An objective fact is that the average salary of students graduating from our school is far below the average level of Zhihu or Maimai. The best students can collect offers from all the big companies, but the students who usually waste their time, even though they choose this major, often end up not as good as they expect. The salary distribution of this industry is not normal but power-law distribution, only a small group of the best people can share the most cake, the variance of the future development of the same industry will be very large. If you will choose to enter the industry in the future, please try to become the front group of people.\nIn this regard, I think the reason for choosing this major should be \u0026ldquo;you love computer science enough\u0026rdquo;, not \u0026ldquo;this major is hot\u0026rdquo;. If you like the process of building a whole world of order through a process control (auto-state machine) and have some interest in this major, you may want to read on below.\n2. About CES What is the Computer Engineering and Science?\nThe School of Computer Engineering and Science (CES) offers four majors: Computer Science and Technology, Intelligent Science and Technology, Cyberspace Security, and Artificial Intelligence.\nThe gap between these majors, as reflected in the professional courses taken at the undergraduate level, will not be so big, at least most of the basic courses such as data structures, principles of computer composition, operating systems, computer networks (i.e., the 408 in the Master\u0026rsquo;s degree examination) are treated equally. Corresponding professional courses will focus on the study content, specific details refer to Shanghai University undergraduate professional training program in 2019 and 2020. And all majors\u0026rsquo; rankings are represented by the following table:\nName 2021 Plan 2021 Rank 2020 Plan 2020 Rank 2019 Plan 2019 Rank Computer Science and Technology 110 289/1573 135 560/2029 150 582/2090 Intelligent Science and Technology 26 375/1573 45 486/2029 60 281/2090 Cyberspace Security 20 396/1573 25 495/2029 - - Artificial Intelligence 21 366/1573 - - - - In most cases, there will not be a significant gap in the daily academic communication of interdisciplinary students, because the skills you will use in your future work may not be as closely related to your current chosen major. What teachers teach you will not determine what you will learn about. For example, if you choose computer science and technology, you can still study artificial intelligence, and if you choose AI, you can study cybersecurity-related content. But in detail:\nComputer science and technology: can be understood as the computer industry, the Polytechnic University class, belongs to the computer in the basic disciplines, both soft and hard, optional development direction range is very wide, and the specific direction of research depends entirely on your interest. Intelligent science and technology: need to learn some signal processing, matrix algebra, brain cognition, and operations research-related courses, across a wide range. Cyberspace security: a new major in my year, the scope of the study is not limited to the so-called \u0026ldquo;cyber security\u0026rdquo;, but also distinguishes penetration, reverse, cryptography and so on. Artificial intelligence: the research direction and professional course arrangement are also close to the wisdom of science, including mathematical logic, data mining, brain cognition, etc., it is recommended that students with good mathematics choose, need very good linear algebra and probability theory foundation, but also this is the Department of Mathematics \u0026ldquo;to grab a job\u0026rdquo; one of the directions. There is no absolute answer to the question of whether a specific major is better or worse. From a personal point of view, the teaching program of the new major still needs time to settle down, 10 weeks of short semesters are compressed together, and even if you take grade 4.0 does not mean that you learned the course well.\nRemember what the school teaches != what I need to learn, you need to be clear about where your future competitiveness in the industry lies. Nowadays, more than 90% of the interview contents of large Internet companies are not what the teachers can teach you, but the fact that the teacher did not teach is not a reason why you don\u0026rsquo;t know that.\n3. The future What I will do in the future?\nIn fact, each road is divided and the choice will be different.\nFor work: If you do not have the intention to study what, it is not recommended to go in the direction of algorithms, the main directions include front-end, client, back-end, testing, operations and maintenance, security, etc. Before the junior year, make sure to finish the professional courses, and do not leave too many courses for the senior year. As early as possible to determine the technology stack used in the interview, looking for online classes (preferably open courses in foreign famous universities, books, blogs, and awesome list; job search in the early efforts to do leetcode, the summer of the junior year (or the end of the second year of winter) as early as possible to go to the Internet companies for internship, more accumulated internship experience project experience.\nInternship: it is best to find the schoolmates or online internal push, more understanding of the department\u0026rsquo;s working environment, overtime status, etc. The primary purpose of the internship is to enrich the resume, it is not recommended to care too much about the salary more or less, the key is you will learn what. When you are looking for a job with your internship experience, the name of your internship company only exists for the interviewer to have heard of/not heard of two situations. If the goal is to work for a big company, it is not particularly recommended to go to outsourcing companies and traditional industry companies (i.e. companies whose old business is not the Internet) or if you want to take \u0026ldquo;private jobs\u0026rdquo; from teachers and make sure to identify the good and bad projects, refer to Shanghai Jiao Tong University Survives Guide. Taking part in the civil servant exam: Mainly depends on the province, city, unit, and tier, the specific details are unknown.\nPush avoid: The specific policy will change every year, refer to The Implementation plan for the work of recommending fresh outstanding undergraduate graduates to be exempted from studying for a master\u0026rsquo;s degree in 2022 and 2021 School of Computer Science of Shanghai University. The details of the policy will change every year, but it is important to be clear about where you need to get extra points.\nNote that \u0026ldquo;the scientific research achievements and competition awards of students who cooperate with their immediate family members or those with significantly higher education, titles and positions than themselves are only for reference and are not included in the calculation system of the comprehensive evaluation results.\u0026rdquo;, means that the route of publishing papers in cooperation with supervisors, finding joint competitions for graduate Ph.D. will not work. On the other hand, Shanghai University has a lot of ACM experts == Shanghai University ACM is powerful != you will be powerful definitely when you come to ACM, same for CTF, ASC, etc. Some competitions will cost a lot of time investment if you find it is not suitable also please give up the sunk cost in time, spend time to do leetcode than waste time in the competition. Taking part in the postgraduate entrance exams: The students with low GPAs who want to fulfill their dreams of a famous domestic school is also the choice of most students who do not want to work for the time being. The preparation time for the exam begins in the second semester of the junior year, choice is greater than effort. The process of preparing for the exam, choosing a school, etc., depends on the individual situation, so I won\u0026rsquo;t go into detail here.\nStudy abroad: The first thing you need to do is to make sure that you are ready to go to the country you want to go to, whether you need to take IELTS or TOEFL, and whether you want to take GRE. In addition, striving to participate in internationally renowned competitions or publish some academic results but also trying to accumulate some foreign company internship experience, in the application are very plus points. As for whether to stay or return to your home country at the end of your graduate studies abroad, it ultimately depends on your situation.\n4. Daily life What is life like in the college?\nGrade 2019 and 2020 dormitories are arranged in the New Century, subsequent accommodation is unknown, depending on the school arrangements. Some classes have been deleted from the seminar, but there are still a lot of reports, and some teachers have a lot of requirements. College study materials, textbooks, etc., in the major group chat, can also be seen, you can also refer to CES Materials and you may find it helpful to browse the libshu which includes the material collected by the Open Source Community. Many of the final exams are far less detailed than the freshman year, most of them are less incomplete, and you will need some preparation skills. In class, most of the girls sit in the front row more, and whether or not you can get rid of the single depends on your ability. About class activities, because our courses are self-selected, everyone\u0026rsquo;s daily life trajectory is more scattered or gathered in their small circle, I think the class cohesion is not so strong to some extent. Most of the courses, including laboratory classes, will be on the East Side, or relatively far, winter morning on eight East Side is very painful, so it is recommended to learn a bicycle for convenience. ACM and Cyberspace security labs are located on the 7th and 6th floors of the computer building, which are currently open to specific students. For teamwork competitions, it is important to find like-minded partners who are willing to devote their time and have strong abilities (not reflected in their GPAs). Students who major in AI should try to contact their supervisors as early as possible to try to borrow a GPU server, and those who are strong can also try to contact their supervisors in advance to join their graduate groups. 5. On the way If you have decided to major in the Computer Science and Technology, here are some suggestions for studying in advance.\nEnglish counts! English counts! English counts!\nLearn to use Google and learn to read English materials. Never use Baidu to find answers. (It is highly recommended to add 127.0.0.1 www.baidu.com in your /etc/hosts file, which will promise that you will not able to use it.) Learn more on Github, Stackoverflow and less on CSDN or Cnblogs. Learn to fix bugs by STFW and RTFM, which is the most important skill for a programmer. Learn how to ask questions the smart way. Create a GitHub account, and build a personal blog on it, you can use hugo, hexo and other frameworks, the whole specific process follows Google and official documentation, the process you will learn a lot, including Git, read documents, write configuration files and other operations.\nSpecific learning direction, learning a new language and related technologies, learning process to take notes.\nBack-end: Java, Golang, C++, Rust, etc., and Web frameworks such as Springboot, and Gin, capable students can learn about DBMS, Redis, MQ, ES and other technologies in advance. Front-end/client: JavaScript, TypeScript, Dart, Kotlin, Swift and so on, frameworks including Vue, React, Angular, etc., learning Node.js, as well as agents, caches, gateways, tunnels, etc. AI can start to learn Python, Matlab and so on, as well as the common TensorFlow or PyTorch, efforts to improve the level of English and start trying to improve the ability to find literature/reading literature. Learn Linux including WSL and Docker, it is highly recommended to learn Docker to save the time to build the environment.\nLearn the professional course knowledge in advance, refer to the CS Self-Study Guide, it is suggested to learn computer science by doing the labs.\nWhen you finish the above, you should have a general direction of what to study in the future, you can also read My Computer Study Route.\n6. Ending This article is only expressing my personal opinion, I hope students will not change their opinion towards this major because of the shortcomings of the profession I mentioned, or blindly decide because of the so-called high salary. On the way of choosing a major, often a decision will greatly affect the future trajectory of your life.\nThe fact that you have the grades to get into a computer science college also means that you have the right to choose almost any major, so please choose your major carefully. After all, the final choice of major is still yours, so please make sure to make a decision based on your interests, family environment, future development and all kinds of factors, and remember that at this point, anyone, including your teachers, family and classmates, can only just provide advice at all.\nFour years of college life is neither too long nor too short. While enjoying the comfortable campus life, you have become a frog in warm water without realizing it.\nWe need to break away from the inertia of student thinking under the score measurement system, \u0026ldquo;Please be sure to remember: four years of college life gives you is just a kind of the undergo of your life, when you graduate, the string of pale scores has been invalidated.\u0026rdquo;.\n7. Remarks Here are some links related to this post.\nGuide of Choice SHU CES\nA Guide for newbies in Cyberspace Security\nThank you for reading here, after you have finished your blog, you can comment on this post below to contact me to add your link. Anyway, you are free to ask any questions about this post. If there is anything inappropriate, please comment/contact me and I will change it as soon as possible.\n","date":"2022-06-19T22:27:02+08:00","image":"https://chasing1020.github.io/post/about-computer-science/force_hu2f7a4f0d3aab2fb44bd6811e98148674_312962_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/about-computer-science/","title":"About Computer Science"},{"content":"1. Overview 2. Language Grammar å­—æ¯è¡¨ï¼ˆAlphabetï¼‰ï¼š$\\sum$æ˜¯ä¸€ä¸ªæœ‰ç©·ç¬¦å·é›†åˆï¼ŒåŒ…æ‹¬å­—æ¯ã€æ•°å­—ã€æ ‡ç‚¹ç­‰ã€‚\nä¹˜ç§¯ï¼ˆproductï¼‰ï¼šå­—æ¯è¡¨$\\sum_1$å’Œ$\\sum_2$çš„ä¹˜ç§¯ï¼š$\\sum_1\\sum_2 = {ab|a\\in\\sum_1, b\\in\\sum_2}$\nnæ¬¡å¹‚ï¼ˆpowerï¼‰ï¼šå­—æ¯è¡¨$\\sum$çš„næ¬¡å¹‚ï¼š1. $\\sum^0={\\varepsilon}$; 2. $\\sum^n =\\sum^{n-1}\\sum, if\\ n \u0026gt; 1$\næ­£é—­åŒ…ï¼ˆpositive closureï¼‰ï¼š$\\sum^+ = \\sum \\cup \\sum^2 \\cup\\sum^3 \\cup\u0026hellip;$\nå…‹æ—é—­åŒ…ï¼ˆKleene closureï¼‰ï¼šå³ä»»æ„ç¬¦å·ä¸²ï¼ˆå…è®¸é•¿åº¦0ï¼‰çš„é›†åˆ$\\sum^* = \\sum^{0} + \\sum^+ = \\sum^0 \\cup \\sum \\cup \\sum^2 \\cup \\sum^3 \\cup \u0026hellip;$\nä¸²ï¼ˆstringï¼‰ï¼šè®¾$\\sum$æ˜¯ä¸€ä¸ªå­—æ¯è¡¨ï¼Œ$\\forall x\\in \\sum^*$ï¼Œxç§°ä¸º$\\sum$ä¸Šçš„ä¸€ä¸ªä¸²ï¼Œä¸²æ˜¯å­—æ¯è¡¨ä¸­çš„ç¬¦å·çš„ä¸€ä¸ªæœ‰ç©·åºåˆ—ã€‚\nä¸²çš„é•¿åº¦ï¼ˆlengthï¼‰ï¼šsçš„é•¿åº¦ï¼Œè®°ä½œ|s|ï¼Œå³sä¸­ç¬¦å·çš„ä¸ªæ•°ï¼Œé•¿åº¦ä¸º0è®°ä½œç©ºä¸²ã€‚\nè¿æ¥ï¼ˆconcatenationï¼‰ï¼šå³yä¸²é™„åŠ åˆ°xä¸²åé¢å½¢æˆçš„ä¸²ï¼Œç©ºä¸²æ˜¯è¿æ¥è¿ç®—çš„å•ä½å…ƒï¼ˆidentityï¼‰ã€‚\nä¸²çš„næ¬¡å¹‚ï¼šå°†nä¸ªä¸²sè¿æ¥èµ·æ¥ï¼š1. $s^0=\\varepsilon$; 2. $s^n = s^{n-1}s, nâ‰¥1$ï¼Œ\næ–‡æ³•çš„å½¢å¼åŒ–å®šä¹‰ï¼š$G=(V_T,V_N,P,S)$ï¼Œå…¶ä¸­$V_T$ï¼šç»ˆç»“ç¬¦é›†åˆï¼›$V_N$ï¼šéç»ˆç»“ç¬¦é›†åˆï¼›Pï¼šäº§ç”Ÿå¼é›†åˆï¼›Sï¼šå¼€å§‹ç¬¦å·\nç»ˆç»“ç¬¦ï¼ˆterminal symbolï¼‰ï¼šæ‰€æœ‰æ–‡æ³•å®šä¹‰çš„è¯­è¨€çš„åŸºæœ¬ç¬¦å·ï¼Œå³tokenã€‚\nExamples:\nIdentifier: strings of letters or digits, starting with a letter Integer: a non-empty string of digits Keyword: â€œelseâ€ or â€œifâ€ or â€œbeginâ€ or â€¦ Whitespace: a non-empty sequence of blanks, newlines, and tabs éç»ˆç»“ç¬¦ï¼ˆnonterminalï¼‰ï¼šè¡¨ç¤ºè¯­æ³•æˆåˆ†çš„ç¬¦å·ï¼Œä¹Ÿç§°ä¸ºâ€œè¯­æ³•å˜é‡â€\näº§ç”Ÿå¼ï¼ˆproductionï¼‰ï¼šæè¿°äº†å°†ç»ˆç»“ç¬¦å’Œéç»ˆç»“ç¬¦ç»„åˆæˆä¸²çš„æ–¹æ³•äº§ç”Ÿå¼çš„ä¸€èˆ¬å½¢å¼ï¼š$\\alpha\\rightarrow\\beta$ã€‚å…¶ä¸­ï¼Œ$\\alpha\\in(V_T\\cup V_N)^+$ï¼Œä¸”$\\alpha$è‡³å°‘åŒ…å«$V_N$ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼šç§°ä¸ºäº§ç”Ÿæ—¶çš„å¤´éƒ¨ï¼ˆheadï¼‰æˆ–è€…å·¦éƒ¨ï¼ˆleft sideï¼‰ï¼›$\\beta\\in(V_T\\cup V_N)^*$ï¼šç§°ä¸ºäº§ç”Ÿå¼çš„ä½“ï¼ˆbodyï¼‰æˆ–è€…å³éƒ¨ï¼ˆright sideï¼‰ã€‚\nå¼€å§‹ç¬¦å·ï¼ˆstart symbolï¼‰ï¼š$S\\in V_N$ï¼Œè¡¨ç¤ºçš„æ˜¯è¯¥æ–‡æ³•ä¸­æœ€å¤§çš„è¯­æ³•æˆåˆ†ã€‚\näº§ç”Ÿå¼çš„ç®€å†™ï¼šå¯¹äºä¸€ç»„å…·æœ‰ç›¸åŒå·¦éƒ¨$\\alpha$çš„äº§ç”Ÿå¼$\\alpha \\rightarrow \\beta_1,\\alpha \\rightarrow \\beta_2,\u0026hellip;,\\alpha \\rightarrow \\beta_n$ã€‚\nå¯ä»¥ç®€å•è®¡ä¸º$\\alpha \\rightarrow \\beta_1|\\beta_2|\u0026hellip;|\\beta_n$ã€‚è¿™é‡Œçš„$\\beta_1,\\beta_2,\u0026hellip;,\\beta_n$ç§°ä¸º$\\alpha$çš„å€™é€‰å¼ï¼ˆcandidateï¼‰ã€‚\nç»ˆç»“ç¬¦çº¦å®šï¼šå­—æ¯è¡¨ä¸­å‰é¢çš„å°å†™å­—æ¯ï¼›è¿ç®—ç¬¦ï¼›æ ‡ç‚¹ç¬¦å·ï¼›æ•°å­—ï¼›ç²—ä½“å­—ç¬¦ä¸²\néç»ˆç»“ç¬¦çº¦å®šï¼šå­—æ¯è¡¨ä¸­å‰é¢çš„å¤§å†™å­—æ¯ï¼›Sé€šå¸¸è¡¨ç¤ºå¼€å§‹ç¬¦å·ï¼›å°å†™ã€æ–œä½“çš„åå­—ï¼›ä»£è¡¨ç¨‹åºæ„é€ çš„å¤§å†™å­—æ¯ã€‚\næ–‡æ³•ç¬¦å·ï¼šæ’åœ¨åé¢çš„å¤§å†™å­—æ¯ã€‚\nç»ˆç»“ç¬¦å·ä¸²ï¼šæ’åœ¨åé¢çš„å°å†™å­—æ¯ï¼ˆåŒ…æ‹¬ç©ºä¸²ï¼‰ã€‚\næ–‡æ³•ç¬¦å·ä¸²ï¼šå°å†™å¸Œè…Šå­—æ¯ï¼ˆåŒ…æ‹¬ç©ºä¸²ï¼‰ã€‚\nè¯­è¨€å®šä¹‰\nç»™å®šæ–‡æ³•$G=(V_T,V_N,P,S)$ï¼Œå¦‚æœ$\\alpha\\rightarrow\\beta\\in P$ï¼Œé‚£ä¹ˆå¯ä»¥å°†$\\gamma\\alpha\\delta$ä¸­çš„$\\alpha$æ¢æˆ$\\beta$ã€‚å³é‡å†™ä¸º$\\gamma\\beta\\delta$ï¼Œè®°ä½œ$\\gamma\\alpha\\delta\\Rightarrow\\gamma\\beta\\delta$ã€‚æ­¤æ—¶ï¼Œç§°æ–‡æ³•ä¸­çš„ç¬¦å·ä¸²$\\gamma\\alpha\\delta$ç›´æ¥æ¨å¯¼ï¼ˆdirectly deriveï¼‰$\\gamma\\beta\\delta$ï¼Œå³ç”¨äº§ç”Ÿå¼çš„å³éƒ¨æ›¿æ¢äº§ç”Ÿå¼çš„å·¦éƒ¨ã€‚\nå¦‚æœæœ‰$\\alpha_0 \\Rightarrow \\alpha_1 , \\alpha_1\\Rightarrow \\alpha_2 ,\u0026hellip;, \\alpha_{n-1} \\Rightarrow \\alpha_n $ ï¼Œåˆ™æœ‰$\\alpha_0\\Rightarrow\\alpha_1\\Rightarrow\\alpha_2\\Rightarrow\u0026hellip;\\Rightarrow\\alpha_n$ï¼Œç§°ç¬¦å·ä¸²$\\alpha_0$ç»è¿‡næ­¥æ¨å¯¼å‡º$\\alpha_n$ï¼Œå¯ä»¥ç®€è®°ä¸º$\\alpha_0\\Rightarrow^n\\alpha_n$ã€‚\nç‰¹åˆ«åœ°ï¼š$\\alpha \\Rightarrow^0 \\alpha$ï¼Œ$\\Rightarrow^+$ è¡¨ç¤ºç»è¿‡æ­£æ•°æ­¥æ¨å¯¼ï¼Œ$\\Rightarrow^*$ è¡¨ç¤ºç»è¿‡è‹¥å¹²æ­¥ï¼ˆå¯ä»¥ä¸º0ï¼‰æ¨å¯¼ã€‚\nå¥å­çš„æ¨å¯¼ï¼šä»ç”Ÿæˆè¯­è¨€çš„è§’åº¦ï¼Œå¥å­çš„è§„çº¦ï¼šä»è¯†åˆ«è¯­è¨€çš„è§’åº¦ã€‚\nå¥å‹ï¼ˆsentential formï¼‰ï¼šå¦‚æœ$S\\Rightarrow^* \\alpha,\\alpha \\in (V_T\\cup V_N)^* $ï¼Œåˆ™ç§°$\\alpha$æ˜¯Gçš„ä¸€ä¸ªå¥å‹ã€‚\nå¥å‹å¯ä»¥åŒ…å«ç»ˆç»“ç¬¦ï¼Œä¹Ÿå¯ä»¥åŒ…å«éç»ˆç»“ç¬¦ï¼Œä¹Ÿå¯èƒ½æ˜¯ç©ºä¸²ã€‚ å¥å­ï¼ˆsentenceï¼‰ï¼šå¦‚æœ$S\\Rightarrow^* w,\\ w\\in V_T^*$ï¼Œåˆ™ç§°wæ˜¯Gçš„ä¸€ä¸ªå¥å­ã€‚\nå¥å­æ˜¯ä¸åŒ…å«éç»ˆç»“ç¬¦çš„å¥å‹ã€‚ è¯­è¨€çš„å½¢å¼åŒ–å®šä¹‰ï¼šç”±æ–‡æ³•Gå¼€å§‹çš„ç¬¦å·Sæ¨å¯¼å‡ºçš„æ‰€æœ‰å¥å­æ„æˆçš„é›†åˆç§°ä¸ºæ–‡æ³•Gç”Ÿæˆçš„è¯­è¨€ï¼Œè®°ä¸ºL(G)ã€‚å³ï¼š$L(G)={w|S\\Rightarrow^* w,\\ w\\in V_T^*}$ã€‚\næ ‡è¯†ç¬¦ï¼šä»¤$L={A,B,C,\u0026hellip;,Z,a,b,c,\u0026hellip;,z},D={0,1,2,\u0026hellip;,9}$ï¼Œåˆ™$L(L\\cup D)^*$ï¼Œè¡¨ç¤ºçš„è¯­è¨€æ˜¯æ ‡è¯†ç¬¦ã€‚\nChomskyæ–‡æ³•åˆ†ç±»ä½“ç³»\n0å‹æ–‡æ³•ï¼ˆType-0 Grammarï¼‰ï¼šæ— é™åˆ¶æ–‡æ³•ï¼ˆUnrestricted Grammerï¼‰/çŸ­è¯­ç»“æ„æ–‡æ³•ï¼ˆPhrase Structure Grammer, PSGï¼‰ï¼š$\\forall\\alpha\\rightarrow\\beta\\in P$ï¼Œ$\\alpha$ä¸­è‡³å°‘åŒ…å«ä¸€ä¸ªéç»ˆç»“ç¬¦ã€‚\n0å‹è¯­è¨€ï¼šç”±0å‹æ–‡æ³•Gç”Ÿæˆçš„è¯­è¨€L(G) 1å‹æ–‡æ³•ï¼ˆType-1 Grammarï¼‰ï¼šä¸Šä¸‹æ–‡æœ‰å…³æ–‡æ³•ï¼ˆContext-Sensitive Grammarï¼ŒCSGï¼‰ï¼š$\\forall\\alpha\\rightarrow\\beta\\in P,\\ |\\alpha|â‰¤|\\beta|$ï¼Œäº§ç”Ÿå¼çš„ä¸€èˆ¬å½¢å¼$\\alpha_1A\\alpha_2\\rightarrow\\alpha_1\\beta\\alpha_2(\\beta â‰  \\varepsilon)$\n1å‹è¯­è¨€ï¼ˆä¸Šä¸‹æ–‡æœ‰å…³è¯­è¨€ï¼‰ï¼šç”±1å‹æ–‡æ³•Gç”Ÿæˆçš„è¯­è¨€L(G)ï¼ŒCSGä¸­ä¸åŒ…å«$\\varepsilon$äº§ç”Ÿå¼ã€‚ 2å‹æ–‡æ³•ï¼ˆType-2 Grammarï¼‰ï¼šä¸Šä¸‹æ–‡æ— å…³æ–‡æ³•ï¼ˆContext-Free Grammar, CFGï¼‰ï¼š$\\forall\\alpha\\rightarrow\\beta\\in P, \\alpha\\in V_N$ï¼Œäº§ç”Ÿå¼çš„ä¸€èˆ¬å½¢å¼$A\\rightarrow\\beta$\n2å‹è¯­è¨€ï¼ˆä¸Šä¸‹æ–‡æ— å…³è¯­è¨€ï¼‰ï¼šç”±2å‹æ–‡æ³•Gç”Ÿæˆçš„è¯­è¨€L(G) 3å‹æ–‡æ³•ï¼ˆType-3 Grammarï¼‰ï¼šæ­£åˆ™æ–‡æ³•ï¼ˆRegular Grammar, RGï¼‰ï¼Œå³çº¿æ€§ï¼ˆRight Linearï¼‰æ–‡æ³•ï¼š$A\\rightarrow wB\\ or\\ A\\rightarrow w$ï¼Œå·¦çº¿æ€§ï¼ˆleft Linearï¼‰æ–‡æ³•ï¼š$A\\rightarrow Bw\\ or\\ A\\rightarrow w$ï¼Œä¸¤è€…éƒ½ç§°ä¸ºæ­£åˆ™æ–‡æ³•ã€‚\n3å‹è¯­è¨€ï¼ˆæ­£åˆ™è¯­è¨€ï¼‰ï¼šç”±3å‹æ–‡æ³•Gç”Ÿæˆçš„è¯­è¨€L(G) å››ç§è¯­è¨€çš„å…³ç³»ï¼Œé€çº§é™åˆ¶ï¼Œé€çº§åŒ…å«ï¼š\n0å‹æ–‡æ³•ï¼š$\\alpha$ä¸­è‡³å°‘åŒ…å«ä¸€ä¸ªéç»ˆç»“ç¬¦ 1å‹æ–‡æ³•ï¼š$|\\alpha|â‰¤|\\beta|$ 2å‹æ–‡æ³•ï¼š$\\alpha\\in V_N$ 3å‹æ–‡æ³•ï¼š$A\\rightarrow wB\\ or\\ A\\rightarrow w$ï¼ˆæˆ–$A\\rightarrow Bw\\ or\\ A\\rightarrow w$ï¼‰ CFG åˆ†ææ ‘\næ ¹èŠ‚ç‚¹æ ‡å·æ—¢æ˜¯æ–‡æ³•å¼€å§‹ç¬¦å·\nå†…éƒ¨èŠ‚ç‚¹è¡¨ç¤ºå¯¹ä¸€ä¸ªäº§ç”Ÿå¼$A\\rightarrow\\beta$çš„åº”ç”¨\nå¶ç»“ç‚¹æ ‡å·æ—¢å¯ä»¥æ˜¯éç»ˆç»“ç¬¦ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»ˆç»“ç¬¦ã€‚ä»å·¦åˆ°å³æ’åˆ—å¶ç»“ç‚¹å¾—åˆ°çš„ç¬¦å·ä¸²ç§°ä¸ºæ˜¯è¿™é¢—æ ‘çš„äº§å‡ºï¼ˆyieldï¼‰æˆ–è¾¹ç¼˜ï¼ˆfrontierï¼‰ã€‚\nå¦‚æœä¸€ä¸ªæ–‡æ³•å¯ä»¥ä¸ºæŸä¸ªå¥å­ç”Ÿæˆå¤šæ£µåˆ†ææ ‘ï¼Œåˆ™ç§°è¯¥æ–‡æ³•å­˜åœ¨äºŒä¹‰æ€§\n3. Lexical Analysis æ­£åˆ™è¡¨è¾¾å¼å®šä¹‰\n$\\varepsilon$æ˜¯ä¸€ä¸ªREï¼Œ$L(\\varepsilon) = {\\varepsilon}$ï¼›å¦‚æœ$\\alpha\\in \\sum$ï¼Œåˆ™$\\alpha$æ˜¯ä¸€ä¸ªREï¼Œ$L(\\alpha) = {\\alpha}$ã€‚\nå‡è®¾r, séƒ½æ˜¯REï¼Œè¡¨ç¤ºçš„è¯­è¨€åˆ†åˆ«æ˜¯L(r), L(s)ï¼Œåˆ™$r|s, rs, r*, (r)$éƒ½æ˜¯REã€‚\næ­£åˆ™è¯­è¨€ï¼ˆRegular languageï¼‰æˆ–æ­£åˆ™é›†åˆï¼ˆRegular languageï¼‰\nå®šå¾‹ æè¿° $r s = s $r (s $r(st)=r(st)$ è¿æ¥å¯ç»“åˆ $r(s t) = rs $\\varepsilon r=r\\varepsilon =r$ $\\varepsilon$æ˜¯è¿æ¥çš„å•ä½å…ƒ $r^* = (rï½œ\\varepsilon )^*$ é—­åŒ…ä¸­ä¸€å®šå«æœ‰$\\varepsilon$ $r^{**} = r^*$ *å…·æœ‰å¹‚ç­‰æ€§ æ­£åˆ™æ–‡æ³•å’Œæ­£åˆ™è¡¨è¾¾å¼ç­‰ä»·ï¼Œä»»æ„æ­£åˆ™æ–‡æ³•Gï¼Œå­˜åœ¨å®šä¹‰ç»Ÿä¸€è¯­è¨€çš„æ­£åˆ™è¡¨è¾¾å¼rï¼Œåä¹‹äº¦ç„¶ã€‚\næ­£åˆ™å®šä¹‰ï¼ˆregular definitionï¼‰ï¼šæŒ‡å…·æœ‰å¦‚ä¸‹å½¢å¼çš„å®šä¹‰åºåˆ—$d_1 \\rightarrow r_1,d_2 \\rightarrow r_2,\u0026hellip;,d_n \\rightarrow r_n$\nå…¶ä¸­æ¯ä¸ª$d_i$éƒ½æ˜¯ä¸€ä¸ªæ–°ç¬¦å·ï¼Œä»–ä»¬éƒ½ä¸åœ¨å­—æ¯è¡¨$\\sum$ä¸­ï¼Œè€Œä¸”å„ä¸ç›¸åŒã€‚ æ¯ä¸ª$r_i$éƒ½æ˜¯å­—æ¯è¡¨$\\sum \\cup {d_1, d2_, \u0026hellip;, d_i-1}$ä¸Šçš„æ­£åˆ™è¡¨è¾¾å¼ã€‚ Exp: Cè¯­è¨€çš„æ ‡è¯†ç¬¦ $digit\\rightarrow 0|1|2|\u0026hellip;|9$ $letter \\rightarrow A|B|\u0026hellip;|Z|a|b|\u0026hellip;|z|$_ $identification \\rightarrow letter(letter|digit)*$ å•è¯è¯†åˆ«\næœ‰ç©·è‡ªåŠ¨æœºï¼ˆFinite Automata, FAï¼‰ï¼šç³»ç»Ÿæ ¹æ®å½“å‰çŠ¶æ€å’Œè¾“å…¥ä¿¡æ¯å†³å®šç³»ç»Ÿåç»§è¡Œä¸ºã€‚\nè½¬æ¢å›¾ï¼ˆTransition Graphï¼‰ï¼šç»“ç‚¹è¡¨ç¤ºFAçŠ¶æ€ï¼Œåˆå§‹çŠ¶æ€ç”¨startè¡¨ç¤ºï¼Œç»ˆæ­¢çŠ¶æ€ä¸ºåŒåœˆï¼Œæœ‰å‘è¾¹å¸¦æ ‡è®°è¡¨ç¤ºè½¬æ¢æ¡ä»¶ã€‚\nç¡®å®šçš„æœ‰ç©·è‡ªåŠ¨æœºï¼ˆDeterministic finite automata, DFAï¼‰ï¼šå®šä¹‰$M=(S,\\sum,\\delta,s_0 ,F)$\nSï¼šæœ‰ç©·çŠ¶æ€é›† $\\sum$ï¼šè¾“å…¥å­—æ¯è¡¨ï¼Œå³è¾“å…¥ç¬¦å·é›†åˆã€‚$\\varepsilon$ä¸æ˜¯$\\sum$ä¸­çš„å…ƒç´  $\\delta$ï¼šå°†$S*\\sum$æ˜ å°„åˆ°$S$çš„è½¬æ¢å‡½æ•°ã€‚$\\forall s\\in S, a\\in \\sum, \\delta (s, a)$è¡¨ç¤ºä»çŠ¶æ€så‡ºå‘ï¼Œæ²¿ç€aè¾¹èƒ½åˆ°è¾¾çš„çŠ¶æ€ $s_0$ï¼šå¼€å§‹çŠ¶æ€ï¼Œ$s_0\\in S$ $F$ï¼šæ¥å—çŠ¶æ€é›†åˆï¼Œ$F\\subsetneqq S$ éç¡®å®šçš„åˆç©·è‡ªåŠ¨æœºï¼ˆNondeterministic finite automata, NFAï¼‰ï¼šå®šä¹‰$M=(S,\\sum,\\delta,s_0 ,F)$\nSï¼šæœ‰ç©·çŠ¶æ€é›† $\\sum$ï¼šè¾“å…¥å­—æ¯è¡¨ï¼Œå³è¾“å…¥ç¬¦å·é›†åˆã€‚$\\varepsilon$ä¸æ˜¯$\\sum$ä¸­çš„å…ƒç´  $\\delta$ï¼šå°†$S*\\sum$æ˜ å°„åˆ° $2^S$ çš„è½¬æ¢å‡½æ•°ã€‚$\\forall s\\in S, a\\in \\sum, \\delta (s, a)$è¡¨ç¤ºä»çŠ¶æ€så‡ºå‘ï¼Œæ²¿ç€aè¾¹èƒ½åˆ°è¾¾çš„çŠ¶æ€çš„é›†åˆ å¦‚æœæ˜¯å¸¦æœ‰ç©ºè¾¹çš„NFAï¼Œåˆ™$\\delta$ï¼šå°†$S*(\\sum \\cup{\\varepsilon})$æ˜ å°„åˆ° $2^S$ çš„è½¬æ¢å‡½æ•°ã€‚$\\forall s\\in S, a\\in \\sum \\cup {\\varepsilon}, \\delta (s, a)$è¡¨ç¤ºä»çŠ¶æ€så‡ºå‘ï¼Œæ²¿ç€aè¾¹èƒ½åˆ°è¾¾çš„çŠ¶æ€çš„é›†åˆ $s_0$ï¼šå¼€å§‹çŠ¶æ€ï¼Œ$s_0\\in S$ $F$ï¼šæ¥å—çŠ¶æ€é›†åˆï¼Œ$F\\subsetneqq S$ DFAå’ŒNFAå”¯ä¸€ç¡®å®šå¹¶ä¸”ç›¸äº’ç­‰ä»·ã€‚ä¸”å¸¦æœ‰å’Œä¸å¸¦æœ‰$\\varepsilon$è¾¹çš„NFAç­‰ä»·ã€‚DFAæ¯ä¸ªçŠ¶æ€éƒ½æ˜¯NFAçŠ¶æ€æ„æˆçš„ä¸€ä¸ªé›†åˆã€‚åœ¨Goä¸­ï¼Œé‡‡ç”¨scannerç»“æ„ä½“nextæ–¹æ³•ä½œä¸ºDFAçš„è¾“å…¥ï¼Œè·å–ç¨‹åºTokenã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 // next advances the scanner by reading the next token. func (s *scanner) next() { nlsemi := s.nlsemi s.nlsemi = false redo: // skip white space s.stop() startLine, startCol := s.pos() for s.ch == \u0026#39; \u0026#39; || s.ch == \u0026#39;\\t\u0026#39; || s.ch == \u0026#39;\\n\u0026#39; \u0026amp;\u0026amp; !nlsemi || s.ch == \u0026#39;\\r\u0026#39; { s.nextch() } // token start s.line, s.col = s.pos() s.blank = s.line \u0026gt; startLine || startCol == colbase s.start() if isLetter(s.ch) || s.ch \u0026gt;= utf8.RuneSelf \u0026amp;\u0026amp; s.atIdentChar(true) { s.nextch() s.ident() return } switch s.ch { case -1: // omit default: s.errorf(\u0026#34;invalid character %#U\u0026#34;, s.ch) s.nextch() goto redo } return assignop: if s.ch == \u0026#39;=\u0026#39; { s.nextch() s.tok = _AssignOp return } s.tok = _Operator } 4. Sytax Analysis è‡ªé¡¶å‘ä¸‹åˆ†æ\nä»åˆ†ææ ‘çš„é¡¶éƒ¨å‘åº•éƒ¨æ–¹å‘æ„é€ åˆ†ææ ‘ï¼Œå¯ä»¥çœ‹æˆæ˜¯ä»æ–‡æ³•å¼€å§‹ç¬¦å·Sæ¨å¯¼å‡ºè¯ä¸²wçš„è¿‡ç¨‹ã€‚\næœ€å·¦æ¨å¯¼ï¼šæ¯æ¬¡é€‰æ‹©æ¯ä¸ªå¥å‹çš„æœ€å·¦éç»ˆç»“ç¬¦æ›¿æ¢ï¼Œ$S\\Rightarrow^*_{left most}\\alpha$ï¼Œåˆ™ç§°$\\alpha$æ˜¯å½“å‰æ–‡æ³•çš„æœ€å·¦å¥å‹ï¼ˆleft- sentential formï¼‰ã€‚\næœ€å³æ¨å¯¼ï¼šæ€»æ˜¯é€‰æ‹©æ¯ä¸ªå¥å‹çš„æœ€å³éç»ˆç»“ç¬¦è¿›è¡Œæ›¿æ¢ã€‚\né¢„æµ‹åˆ†æï¼šåœ¨è¾“å…¥ä¸­å‘å‰çœ‹å›ºå®šä¸ªæ•°ç¬¦å·æ¥é€‰æ‹©æ­£ç¡®çš„A-äº§ç”Ÿå¼ï¼Œä¸éœ€è¦å›æº¯ï¼Œå°†å‘å‰çœ‹kä¸ªè¿™äº›æ–‡æ³•ç±»å¯ä»¥è®°$LL(K)$æ–‡æ³•ç±»ã€‚\nå·¦é€’å½’æ–‡æ³•ï¼šå­˜åœ¨ä¸€ä¸ªéç»ˆç»“ç¬¦$A$ï¼Œä½¿å¾—å¯¹æŸä¸ªä¸²æœ‰$A\\Rightarrow ^+A\\alpha$ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡æ³•æ˜¯å·¦é€’å½’çš„ï¼Œä¼šä½¿å¾—é€’å½’ä¸‹é™åˆ†æå™¨è¿›å…¥æ— é™å¾ªç¯ã€‚\næ¶ˆé™¤å·¦é€’å½’ï¼šå¼•å…¥éç»ˆç»“ç¬¦å’Œ$_\\varepsilon$äº§ç”Ÿå¼ä¸ºä»£ä»·ã€‚ä¼ªä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 A := make(NonTerminal, n) for i := range A { for j := 0; j \u0026lt; i; j++ { // å°†A[i]-\u0026gt;A[j]yçš„äº§ç”Ÿå¼æ›¿æ¢æˆäº§ç”Ÿå¼ç»„A[i]-\u0026gt;d[1]y|d[2]y|...|d[k]y // A[j]-\u0026gt;d[1]|d[2]|...|d[k]ï¼Œæ˜¯æ‰€æœ‰A[j]äº§ç”Ÿå¼ } // æ¶ˆé™¤A[i]äº§ç”Ÿå¼ä¹‹é—´çš„ç«‹å³å·¦é€’å½’ } æå–å·¦å…¬å› å­ç®—æ³•ï¼šæ”¹å†™äº§ç”Ÿå¼æ¥æ¨è¿Ÿå†³å®šï¼Œå¦‚æœå¤šä¸ªé€‰é¡¹æœ‰å…¬å…±æœ€é•¿å‰ç¼€$\\alpha, \\alpha â‰  \\varepsilon$ï¼Œå³å­˜åœ¨éå¹³å‡¡ï¼ˆnontrivialï¼‰çš„å…¬å…±å‰ç¼€ï¼Œåˆ™å¯ä»¥å°†æ‰€æœ‰A-äº§ç”Ÿå¼æ›¿æ¢ã€‚\nS_æ–‡æ³•ï¼šä¸å«$\\varepsilon$äº§ç”Ÿå¼ï¼Œå€™é€‰å¼å”¯ä¸€ï¼Œæ¯ä¸ªäº§ç”Ÿå¼å³éƒ¨ä»¥ç»ˆç»“ç¬¦å¼€å§‹ï¼ŒåŒä¸€éç»ˆç»“ç¬¦çš„å„ä¸ªå€™é€‰å¼çš„é¦–ç»ˆç»“ç¬¦éƒ½ä¸åŒã€‚\nåç»§ç¬¦å·é›†ï¼šå¯èƒ½åœ¨æŸä¸ªå¥å‹ä¸­ç´§è·ŸAåè¾¹çš„ç»ˆç»“ç¬¦açš„é›†åˆï¼Œè®°ä¸º$FOLLOW(A)$ï¼Œå¦‚æœAæ˜¯æœ€å³ç¬¦å·ï¼Œåˆ™è¿˜è¦æ·»åŠ ç»“æŸç¬¦\u0026quot;$\u0026quot;ã€‚\n$FOLLOW(A) = {a|S\\Rightarrow ^* \\alpha Aa\\beta, a\\in V_T, \\alpha,\\beta \\in (V_T \\cup V_N )^* }$ äº§ç”Ÿå¼çš„å¯é€‰é›†ï¼šäº§ç”Ÿå¼$A\\rightarrow \\beta$çš„å¯é€‰é›†æ˜¯æŒ‡å¯ä»¥ç”¨æ”¹äº§ç”Ÿå¼è¿›è¡Œæ¨å¯¼çš„å¯¹åº”è¾“å…¥ç¬¦å·çš„é›†åˆï¼Œè®°ä¸º$SELECT(A\\rightarrow \\beta)$ã€‚\n$SELECT(A\\rightarrow \\alpha \\beta) = {\\alpha}; SELECT(A\\rightarrow \\varepsilon) = FOLLOW(A)$ q_æ–‡æ³•ï¼šæ¯ä¸ªäº§ç”Ÿå¼çš„å³éƒ¨è¦ä¹ˆæ˜¯$\\varepsilon$è¦ä¹ˆæ˜¯ç»ˆç»“ç¬¦å¼€å§‹ï¼Œå…·æœ‰ç›¸åŒå·¦éƒ¨çš„äº§ç”Ÿå¼æœ‰ä¸ç›¸äº¤çš„å¯é€‰é›†ã€‚\nä¸²é¦–ç»ˆç»“ç¬¦é›†ï¼šç»™å®šä¸€ä¸ªæ–‡æ³•ç¬¦å·ä¸²$\\alpha$ï¼Œ$\\alpha$ä¸²é¦–ç»ˆç»“ç¬¦é›†$FIRST(\\alpha)$è¢«å®šä¹‰ä¸ºå¯ä»¥ä»$\\alpha$æ¨å¯¼å‡ºçš„æ‰€æœ‰ä¸²ç»ˆç»“ç¬¦æ„æˆçš„é›†åˆã€‚å¦‚æœ$\\alpha\\Rightarrow ^* \\varepsilon$ï¼Œåˆ™$\\alpha$ä¹Ÿåœ¨$FIRST(\\alpha)$ä¸­ã€‚\n$\\forall \\alpha \\in (V_T \\cup V_N)^+ , FIRST(\\alpha)={a|\\alpha \\Rightarrow^* a\\beta, a\\in V_T, \\beta \\in (V_T \\cup V_N)^*}$ å¦‚æœ$\\alpha \\Rightarrow ^* \\varepsilon$ï¼Œé‚£ä¹ˆ$\\varepsilon \\in FIRST(\\alpha)$ å¦‚æœ$\\varepsilon \\notin FIRST(\\alpha)$ï¼Œé‚£ä¹ˆ$SELECT(A\\rightarrow \\alpha) = FIRST(\\alpha)$ å¦‚æœ$\\varepsilon \\in FIRST(\\alpha)$ï¼Œé‚£ä¹ˆ$SELECT(A\\rightarrow \\alpha)=(FIRST(\\alpha)-{\\varepsilon})\\cup FOLLOW(A)$ $LL(1)$æ–‡æ³•ï¼šæ–‡æ³•Gæ˜¯$LL(1)$å½“å‰ä»…å½“ä»»æ„ä¸¤ä¸ªç›¸åŒçš„å·¦éƒ¨äº§ç”Ÿå¼$A\\rightarrow \\alpha|\\beta$æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š\nå¦‚æœ$\\alpha$å’Œ$\\beta$éƒ½ä¸èƒ½æ¨å¯¼å‡º$\\varepsilon$ï¼Œåˆ™$FIRST(\\alpha)\\cap FRIST(\\beta) = \\Phi$ $\\alpha$å’Œ$\\beta$è‡³å¤šæœ‰ä¸€ä¸ªèƒ½å¤Ÿæ¨å¯¼å‡º$\\varepsilon$ å¦‚æœ$\\beta \\Rightarrow ^* \\varepsilon$ï¼Œåˆ™$FIRST(\\alpha)\\cap FOLLOW(A) = \\Phi$ å¦‚æœ$\\alpha \\Rightarrow ^* \\varepsilon$ï¼Œåˆ™$FIRST(\\beta)\\cap FOLLOW(A) = \\Phi$ é€’å½’çš„é¢„æµ‹åˆ†ææ³•ï¼šåœ¨é€’å½’ä¸‹é™åˆ†æä¸­ï¼Œæ ¹æ®é¢„æµ‹åˆ†æè¡¨è¿›è¡Œäº§ç”Ÿå¼çš„é€‰æ‹©ï¼Œä¸ºæ¯ä¸ªç»ˆç»“ç¬¦ç¼–å†™å¯¹åº”è¿‡ç¨‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 func PredictRecursion() { A := SelectExpression() // A-\u0026gt;X[1]X[2]...X[k] for i := 0; i \u0026lt; k; i++ { switch A.X[i].(type) { case NonTerminal: CallExpression(A.X[i]) case Terminal: ReadNext() default: panic(\u0026#34;type assert error\u0026#34;) } } } éé€’å½’é¢„æµ‹åˆ†ææ³•ï¼šä¸ºé¢„æµ‹åˆ†æè¡¨æ„é€ ä¸€ä¸ªè‡ªåŠ¨æœºã€‚\né¢„æµ‹åˆ†ææ³•å®ç°æ­¥éª¤ï¼šæ„é€ æ–‡æ³•ï¼›æ”¹é€ æ–‡æ³•ï¼Œæ¶ˆé™¤äºŒä¹‰æ€§ã€æ¶ˆé™¤å·¦é€’å½’ã€æ¶ˆé™¤å›æº¯ï¼›æ±‚æ¯ä¸ªå˜é‡çš„$FIRST, FOLLOW$é›†ï¼Œè¿›è€Œå¾—åˆ°$SELECT$é›†ï¼›æ£€æŸ¥æ˜¯ä¸æ˜¯$LL(1)$æ–‡æ³•ï¼Œå¦‚æœæ˜¯ï¼Œæ„é€ é¢„æµ‹åˆ†æè¡¨ï¼›è¿›è¡Œé€’å½’/éé€’å½’åˆ†æã€‚\nè‡ªåº•å‘ä¸Šçš„è¯­æ³•åˆ†æ\nä»åˆ†ææ ‘çš„åº•éƒ¨å‘é¡¶éƒ¨æ–¹å‘æ„é€ åˆ†ææ ‘ï¼Œå¯ä»¥çœ‹æˆæ˜¯å°†è¾“å…¥ä¸²wè§„çº¦ä¸ºæ–‡æ³•å¼€å§‹ç¬¦å·Sçš„è¿‡ç¨‹ã€‚\nç§»å…¥-å½’çº¦ï¼šå°†è¾“å…¥ä¸²ä»å·¦åˆ°å³çš„æ‰«æä¸­ï¼Œå°†0ä¸ªæˆ–å¤šä¸ªè¾“å…¥ç¬¦å·ç§»å…¥åˆ°æ ˆçš„é¡¶ç«¯ï¼ŒçŸ¥é“èƒ½è¿›è¡Œå½’çº¦ä¸ºæ­¢ã€‚\nLRæ–‡æ³•ï¼ˆKnuthï¼Œ1963ï¼‰ï¼šæœ€å¤§çš„ã€å¯ä»¥æ„é€ å‡ºç›¸åº”ç§»å…¥-å½’çº¦è¯­æ³•åˆ†æå™¨çš„æ–‡æ³•ç±»ï¼ŒLR(k)è¡¨ç¤ºéœ€è¦å‘å‰æŸ¥çœ‹kä¸ªè¾“å…¥ç¬¦å·çš„LRåˆ†æã€‚\né‡‡ç”¨â€œçŠ¶æ€â€çš„è‡ªåŠ¨æœºè¡¨ç¤ºå¥æŸ„è¯†åˆ«è¿›åº¦ LR(0)é¡¹ç›®ï¼šå³éƒ¨æŸä½ç½®æ ‡æœ‰åœ†ç‚¹çš„äº§ç”Ÿå¼ï¼Œæè¿°äº†å¥æŸ„è¯†åˆ«çŠ¶æ€ã€‚\nåœ†ç‚¹åé¢ä¸ºéç»ˆç»“ç¬¦ï¼šç§»è¿›é¡¹ç›® åœ†ç‚¹åé¢ä¸ºç»ˆç»“ç¬¦ï¼šå¾…çº¦é¡¹ç›® åœ†ç‚¹åé¢ä¸ºç©ºä¸²ï¼šå½’çº¦é¡¹ç›® å¢å¹¿è¯­æ³•ï¼šå¦‚æœGæ˜¯Så¼€å§‹ç¬¦å·çš„æ–‡æ³•ï¼Œåˆ™Gçš„å¢å…‰æ–‡æ³•G\u0026rsquo;æ˜¯Gä¸­åŠ ä¸Šå¼€å§‹ç¬¦å·S\u0026rsquo;å’Œäº§ç”Ÿå¼$S\u0026rsquo;\\rightarrow S$çš„æ–‡æ³•ï¼Œä½¿å¾—æ–‡æ³•å¼€å§‹ç¬¦å·ä»…å‡ºç°åœ¨ä¸€ä¸ªäº§ç”Ÿå¼çš„å·¦è¾¹ï¼Œä»è€Œä½¿å¾—åˆ†æå™¨åªæœ‰ä¸€ä¸ªæ¥å—çŠ¶æ€ã€‚\né¡¹ç›®é›†çš„é—­åŒ…ï¼šç»™å®šé¡¹ç›®é›†Iï¼Œæœ‰\n$CLOSURE(I) = I \\cup {B\\rightarrow Â·\\gamma|A \\rightarrow \\alphaÂ·B\\beta \\in CLOSURE(I), B\\rightarrow \\gamma \\in P }$ åç»§é¡¹ç›®é›†é—­åŒ…ï¼šç»™å®šé¡¹ç›®é›†Iå¯¹åº”æ–‡æ³•ç¬¦å·Xçš„åç»§é¡¹ç›®é›†é—­åŒ…\n$GOTO(I, X) = CLOSURE({A\\rightarrow \\alpha XÂ·\\beta | A\\rightarrow \\alphaÂ·X\\beta \\in I})$ è§„èŒƒLR(0)é¡¹ç›®é›†æ—ï¼ˆCanonical LR(0) Collectionï¼‰ï¼š\nLR(0)è‡ªåŠ¨æœºï¼šæ–‡æ³•$G=(V_N, V_T, P, S)$ï¼Œåˆ™LR(0)è‡ªåŠ¨æœºå®šä¹‰å¦‚ä¸‹\n$M=(C, V_N\\cup V_T, GOTO, I_0,F)$ $C ={ I_0 }\\cup {I|\\exists J\\in C, X\\in V_N \\cup V_T, I = GOTO(J,X) }$ $I_0=CLOSURE({S\u0026rsquo;\\rightarrow .S})$ $F={CLOSURE({S\u0026rsquo;\\rightarrow S.})}$ SLRåˆ†æï¼šå·²çŸ¥é¡¹ç›®é›†Iæœ‰mä¸ªç§»è¿›é¡¹ç›®ï¼Œnä¸ªå½’çº¦é¡¹ç›®\n$A_1 \\rightarrow \\alpha_1 Â· a_1 \\beta_1; A_2 \\rightarrow \\alpha_2 Â· a_2 \\beta_2;\u0026hellip;;A_m \\rightarrow \\alpha_m Â· a_m \\beta_m.$\n$B_1\\rightarrow \\gamma_1; B_2\\rightarrow \\gamma_2; \u0026hellip; ;B_n\\rightarrow \\gamma_n;$\nå¦‚æœé›†åˆ${a_1,a_2,\u0026hellip;,a_m}$å’Œ$FOLLOW(B_1), FOLLOW(B_2), \u0026hellip;, FOLLOW(B_n)$ä¸¤ä¸¤ä¸ç›¸äº¤ï¼ŒæŒ‰åŸåˆ™å¦‚æœaæ˜¯ä¸‹ä¸€ä¸ªè¾“å…¥ï¼Œ$if\\ a \\in { a_1,a_2,\u0026hellip;,a_n }$ï¼Œåˆ™ç§»è¿›aï¼Œ$if\\ a\\in \\cup FOLLOW(B_i)$ï¼Œåˆ™ç”¨$B_i\\rightarrow \\gamma_i$å½’çº¦ï¼Œå¦åˆ™æŠ¥é”™ã€‚\nLR(1)é¡¹ç›®ï¼š$[A\\rightarrow \\alpha Â·\\beta]$ï¼Œçš„é¡¹ç§°ä¸ºLR(1)é¡¹ï¼Œå…¶ä¸­aæ˜¯ä¸€ä¸ªç»ˆç»“ç¬¦ï¼Œè¡¨ç¤ºå½“å‰çŠ¶æ€ä¸‹Aå¿…é¡»ç´§è·Ÿçš„ç»ˆç»“ç¬¦ï¼Œç§°ä¸ºè¯¥é¡¹çš„å±•æœ›ç¬¦ã€‚\n$CLOUSURE(I)=I\\cup{[B\\rightarrow Â·\\gamma,b]|[A\\rightarrow \\alphaÂ·B\\beta, a]\\in CLOSURE(I), B\\rightarrow \\gamma \\in P, b \\in FIRST(\\beta a) }$\n$GOTO(I,X)=CLOSURE({[A\\rightarrow \\alpha XÂ·\\beta, a]|[A\\rightarrow \\alpha Â·X \\beta ]\\in I})$\nLALR(lookahead-LR)åˆ†ææ€æƒ³ï¼šæ‰¾å…·æœ‰ç›¸åŒæ ¸å¿ƒçš„LR(1)é¡¹é›†ï¼Œåˆå¹¶ï¼›æœ€ç»ˆåˆ†æè¡¨å¦‚æœæ²¡æœ‰å†²çªï¼Œåˆ™ä¸ºLALR(1)æ–‡æ³•ã€‚\nå½¢å¼ä¸Šä¸LR(1)ç›¸åŒï¼Œå¤§å°å’ŒLR(0)/SLRç›¸å½“ï¼Œåˆ†æèƒ½åŠ›SLR\u0026lt;LALR(1)\u0026lt;LR(1) 5. Sytax-Directed Translation é¢å‘æ–‡æ³•ç¿»è¯‘ï¼šä»¥CFGçš„æ–‡æ³•ç¬¦å·è®¾ç½®è¯­ä¹‰å±æ€§ï¼Œç”¨æ¥è¡¨è¿°è¯­æ³•æˆåˆ†å¯¹åº”çš„è¯­ä¹‰ä¿¡æ¯ï¼ŒåŸºäºè¯­ä¹‰è§„åˆ™æ¥è¿›è¡Œè®¡ç®—ã€‚\nè¯­æ³•åˆ¶å¯¼å®šä¹‰ï¼ˆSyntax-Directed Definitions, SDDï¼‰ï¼šå°†æ¯ä¸ªæ–‡æ³•ç¬¦å·å’Œè¯­ä¹‰å±æ€§é›†åˆç›¸å…³è”ï¼Œæ¯ä¸ªäº§ç”Ÿå¼å’Œä¸€ç»„è¯­ä¹‰è§„åˆ™ç›¸å…³è”ã€‚\nè¯­æ³•åˆ¶å¯¼ç¿»è¯‘æ–¹æ¡ˆï¼ˆSyntax-Directed Translation, SDTï¼‰ï¼šåœ¨äº§ç”Ÿå¼å³éƒ¨åµŒå…¥ç¨‹åºç‰‡æ®µçš„CFGï¼ˆä½ç½®è·å†³å®šæ‰§è¡Œæ—¶é—´ï¼‰ï¼Œè¢«ç§°ä¹‹ä¸ºè¯­ä¹‰åŠ¨ä½œï¼Œæ˜¯SDDå…·ä½“çš„æ–¹æ¡ˆã€‚\nç»¼åˆå±æ€§ï¼šåªèƒ½é€šè¿‡å­ç»“ç‚¹æˆ–è€…æœ¬èº«çš„å±æ€§å€¼æ¥å®šä¹‰ï¼Œç»ˆç»“ç¬¦å¯ä»¥å…·æœ‰ç»¼åˆå±æ€§ï¼ˆç”±è¯æ³•åˆ†æå™¨æä¾›çš„è¯æ³•å€¼ï¼‰ã€‚\nç»§æ‰¿å±æ€§ï¼šåœ¨åˆ†ææ ‘ä¸Šç»§æ‰¿å±æ€§åªèƒ½ç”±è¯¥ç»“ç‚¹çš„çˆ¶äº²ï¼Œå…„å¼Ÿæˆ–è€…è‡ªèº«å±æ€§å€¼æ¥å®šä¹‰ã€‚\nå±æ€§æ–‡æ³•ï¼šæ²¡æœ‰å‰¯ä½œç”¨SDDã€‚\nå±æ€§å€¼è®¡ç®—é¡ºåºï¼šå°†æœ‰å‘å›¾å˜ä¸ºæ‹“æ‰‘æ’åºï¼Œä»æ— ä¾èµ–çš„ç»“ç‚¹å‡ºå‘ã€‚\nS-SDDï¼šä»…ä»…ä½¿ç”¨ç»¼åˆå±æ€§çš„SDDï¼Œå¯ä»¥è‡ªåº•å‘ä¸Šé¡ºåºæ¥è®¡ç®—å®ƒå„ä¸ªèŠ‚ç‚¹çš„å±æ€§å€¼ã€‚å°†æ¯ä¸€ä¸ªè¯­ä¹‰åŠ¨ä½œæ”¾åœ¨äº§ç”Ÿå¼æœ€åå³å¯è½¬æ¢ä¸ºSDTã€‚\nL-SDDï¼šåœ¨å„å±æ€§ä¹‹é—´ï¼Œä¾èµ–å›¾çš„è¾¹å¯ä»¥ä»å·¦åˆ°å³ä½†æ˜¯ä¸èƒ½ä»å³åˆ°å·¦ï¼Œä¸èƒ½ä»å³åˆ°å·¦ï¼Œæ¯ä¸€ä¸ªS-SDDéƒ½æ˜¯L-SDDã€‚å°†ç»§æ‰¿å±æ€§ç´§é åœ¨å‡ºç°ä¹‹å‰çš„ä½ç½®ï¼Œç»¼åˆå±æ€§æ”¾åœ¨æœ€å³ç«¯å³å¯è½¬æ¢ä¸ºSDTã€‚\n6. Intermediate Code Generation ç±»å‹è¡¨è¾¾å¼ï¼ˆType Expressionsï¼‰ï¼šå¯ä»¥ä¸ºå…¶å‘½åï¼Œç±»å‹åä¹Ÿæ˜¯è¡¨è¾¾å¼ï¼ŒåŒ…æ‹¬æ•°ç»„æ„é€ ç¬¦ã€æŒ‡é’ˆã€ç¬›å¡å°”ç§¯ã€å‡½æ•°æ„é€ ç¬¦ã€è®°å½•æ„é€ ç¬¦ï¼ˆç»“æ„ä½“å†…çš„æ ‡è¯†ç¬¦ä¸ç±»å‹ä¿¡æ¯çš„ç¬›å¡å°”ç§¯ï¼‰ã€‚\nè¯­ä¹‰åˆ†ææœŸé—´ï¼Œå¯¹æ¯ä¸€ä¸ªæ ‡è¯†ç¬¦éƒ½ä¼šæ”¶é›†ç±»å‹ä¿¡æ¯ï¼Œç¡®å®šè¿™ä¸ªç±»å‹çš„å®½åº¦ï¼Œå¹¶åˆ†é…ä¸€ä¸ªç›¸å¯¹åœ°å€ï¼Œä¿å­˜åœ¨ç¬¦å·è¡¨çš„è®°å½•ä¸­ã€‚\n","date":"2022-03-05T17:00:35+08:00","image":"https://chasing1020.github.io/post/compilers/Compilers_hu8c64e4fc292413cef039e3f7a5ec8a84_74016_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/compilers/","title":"Compilers"},{"content":"Overview Software is more than just a program code. It is considered to be collection of executable programming code, associated libraries and documentations.\nEngineering on the other hand, is all about developing products, using well-defined, scientific principles and methods.\nIEEE Definition\n(1) The application of a systematic, disciplined, quantifiable approach to the development, operation, and maintenance of software; that is, the application of engineering to software.\n(2) The study of approaches as in the above statement.\nEvolution: Change Request \u0026gt; Impact Analysis \u0026gt; Release Planning \u0026gt; System update \u0026gt; System Release.\nThree categories\nStatic-type (S-type): This is a software, which works strictly according to defined specifications and solutions. For example, calculator program for mathematical computation .\nPractical-type (P-type) : This is a software with a collection of procedures which specifications can be described but the solution is not obviously instant. For example, gaming software.\nEmbedded-type (E-type): This software works closely as the requirement of real-world environment. For example, Online trading software.\nNeeds of Software Engineering: Large, Scalability, Cost, Dynamic Nature, Quality Management.\nDevelopment Life Cycle Software Life Cycle Activities: Communication, Requirement Gathering, Feasibility Study, System Analysis, Software Design, Coding, Testing, Integration, Implementation, Operations \u0026amp; Maintenance, Disposition.\nCommunication: This is the first step where the user initiates the request for a desired software product.\nRequirement Gathering: This step onwards the software development team works to carry on the project.\nFeasibility Study: After requirement gathering, the team comes up with a rough plan of software process.\nSystem Analysis: At this step the developers decide a roadmap of their plan and try to bring up the best software model suitable for the project.\nSoftware Design: Next step is to bring down whole knowledge of requirements and analysis on the desk and design the software product.\nCoding: This step is also known as programming phase.\nTesting: An estimate says that 50% of whole software development process should be tested.\nIntegration: Software may need to be integrated with the libraries, databases, and other program(s).\nImplementation: This means installing the software on user machines.\nOperation and Maintenance: This phase confirms the software operation in terms of more efficiency and less errors.\nWaterfall Model\nWaterfall model is the simplest model of software development paradigm. This model assumes that everything is carried out and taken place perfectly as planned in the previous stage and there is no need to think about the past issues that may arise in the next phase. This model does not work smoothly if there are some issues left at the previous step. The sequential nature of model does not allow us to go back and undo or redo our actions.\nThis model is best suited when developers already have designed and developed similar software in the past and are aware of all its domains.\nInteractive Model\nThis model leads the software development process in iterations. The software is first developed on very small scale and all the steps are followed which are taken into consideration. Then, on every next iteration, more features and modules are designed, coded, tested, and added to the software. Every cycle produces a software, which is complete in itself and has more features and capabilities than that of the previous one. After each iteration, the management team can do work on risk management and prepare for the next iteration. Because a cycle includes small portion of whole software process, it is easier to manage the development process but it consumes more resources.\nSpiral Model\nSpiral model is a combination of both, iterative model and one of the SDLC model.\nThis model considers risk, which often goes un-noticed by most other models. The model starts with determining objectives and constraints of the software at the start of one iteration. Next phase is of prototyping the software. This includes risk analysis. Then one standard SDLC model is used to build the software. In the fourth phase of the plan of next iteration is prepared.\nV Model\nThe major drawback of waterfall model is we move to the next stage only when the previous one is finished and there was no chance to go back if something is found wrong in later stages. V-Model provides means of testing of software at each stage in reverse manner.\nAt every stage, test plans and test cases are created to verify and validate the product according to the requirement of that stage. For example, in requirement gathering stage the test team prepares all the test cases in correspondence to the requirements. Later, when the product is developed and is ready for testing, test cases of this stage verify the software against its validity towards requirements at this stage.\nBig Bang Model\nThis model is the simplest model in its form. It requires little planning, lots of programming and lots of funds. This model is conceptualized around the big bang of universe. As scientists say that after big bang lots of galaxies, planets, and stars evolved just as an event. Likewise, if we put together lots of programming and funds, you may achieve the best software product.\nBig Bang Model\nThis model is the simplest model in its form. It requires little planning, lots of programming and lots of funds. This model is conceptualized around the big bang of universe. As scientists say that after big bang lots of galaxies, planets, and stars evolved just as an event. Likewise, if we put together lots of programming and funds, you may achieve the best software product.\nProject Management A Software Project is the complete procedure of software development from requirement gathering to testing and maintenance, carried out according to the execution methodologies, in a specified period of time to achieve intended software product.\nIt is an essential part of software organization to deliver quality product, keeping the cost within clientâ€™s budget constrain and deliver the project as per scheduled.\nSoftware Management Activities\nProject Planning: Software project planning is task, which is performed before the production of software actually starts. It is there for the software production but involves no concrete activity that has any direct connection with the software production; rather it is a set of multiple processes, which facilitates software production. Project planning may include the following:\nScope Management: It defines scope of the project; this includes all the activities, process need to be done in order to make a deliverable software product. Scope management is essential because it creates boundaries of the project by clearly defining what would be done in the project and what would not be done. This makes project to contain limited and quantifiable tasks, which can easily be documented and in turn avoids cost and time overrun. During Project Scope management, it is necessary to: 1. Define the scope; 2. Decide its verification and control; 3. Divide the project into various smaller parts for ease of management.\nProject Estimation: For an effective management, accurate estimation of various measures is a must. With the correct estimation, managers can manage and control the project more efficiently and effectively. Project estimation may involve the following: 1. Software size estimation; 2. Effort estimation; 3. Time estimation; 4. Cost estimation\nDecomposition Technique: 1. Line of Code: Here the estimation is done on behalf of number of line of codes in the software product. 2. Function Points: Here the estimation is done on behalf of number of function points in the software product.\nGantt Chart\nIt is a horizontal bar chart with bars representing activities and time scheduled for the project activities.\nPERT(Program Evaluation \u0026amp; Review Technique) Chart\nEvents are shown as numbered nodes. They are connected by labeled arrows depicting the sequence of tasks in the project.\nSoftware Requirements Requirements Engineering Process takes four steps: Feasibility Study; Requirement Gathering; Software Requirement Specification; Software Requirement Validation.\nRequirement Elicitation Process\nRequirements gathering - The developers discuss with the client and end users and know their expectations from the software.\nOrganizing Requirements - The developers prioritize and arrange the requirements in order of importance, urgency and convenience.\nNegotiation \u0026amp; discussion - If requirements are ambiguous or there are some conflicts in requirements of various stakeholders, it is then negotiated and discussed with the stakeholders. Requirements may then be prioritized and reasonably compromised.\nThe requirements come from various stakeholders. To remove the ambiguity and conflicts, they are discussed for clarity and correctness. Unrealistic requirements are compromised reasonably.\nDocumentation - All formal and informal, functional and non-functional requirements are documented and made available for next phase processing.\nDesign Basics ","date":"2022-03-03T13:47:04+08:00","image":"https://chasing1020.github.io/post/software-engineering/code_hu8931b1e4159b9bd74cb80acff6dca036_21936_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/software-engineering/","title":"Software Engineering"},{"content":"The gets() function cannot be used securely. Because of its lack of bounds checking, and the inability of the calling program to reliably determine the length of the next incoming line, the use of this function enables malicious users to arbitrarily change a running program\u0026rsquo;s functionality through a buffer overflow attack. It is strongly suggested that the fgets() function be used in all cases.\nHow can we find and/or prevent problems like this?\nDynamic analysis: Run the program, watch what it does, and look for problematic behavior. Static analysis: read the source code and try to spot the issues. Write code differently: create habits and frameworks that make it harder to produce these kinds of mistakes. Sandbox: accept that these issues will happen, but try to minimize the consequences. ","date":"2022-02-19T23:20:42+08:00","image":"https://chasing1020.github.io/post/safety-in-systems-programming/rust_hu30e010f31589b8e65428ec80a1a54916_89788_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/safety-in-systems-programming/","title":"Safety in Systems Programming"},{"content":"1. Query Engine 1.1. Relational Model å…³ç³»å‹æ•°æ®åº“æ˜¯å»ºæ¨¡ç°å®ä¸–ç•Œçš„å…³è”æ•°æ®çš„æœ‰ç»„ç»‡çš„é›†åˆã€‚æœ€æ—©æœŸæ•°æ®åº“éš¾äºæ„å»ºï¼Œé€»è¾‘ä¸ç‰©ç†å±‚å¼ºè€¦åˆã€‚\næŸ¥è¯¢æµç¨‹\nSQLï¼ˆParserï¼‰ï¼šè¯æ³•åˆ†æå’Œè¯­æ³•åˆ†æã€‚\nASTï¼ˆLogical Optimizerï¼‰ï¼šåŸºäºå…³ç³»ä»£æ•°è¡¨è¾¾å¼çš„é€»è¾‘è®¡åˆ’ï¼ŒåŸºäºè§„åˆ™çš„ä¼˜åŒ–ï¼Œä¾æ®å…³ç³»ä»£æ•°çš„ç­‰ä»·äº¤æ¢åŸåˆ™åšé€»è¾‘å˜æ¢ã€‚\nLogical Planï¼ˆPhysical Optimizerï¼‰ï¼šåŸºäºä»£ä»·çš„ä¼˜åŒ–ï¼Œä¾æ®ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯¹æ•°æ®è¯»å–ï¼Œè¡¨è¿æ¥æ–¹å¼ï¼Œè¿æ¥é¡ºåºç­‰è¿›è¡Œä¼˜åŒ–ï¼›è®¡ç®—å¤šç§å¯èƒ½çš„æ‰§è¡Œè®¡åˆ’çš„ä»£ä»·ï¼Œç”Ÿæˆä»£ä»·æœ€å°çš„ç‰©ç†æ‰§è¡Œè®¡åˆ’\nPhysical Planï¼ˆExecutorï¼‰ï¼šé‡‡å–ä¸²è¡Œæˆ–è€…æ˜¯å¹¶è¡Œçš„æ–¹å¼æ‰§è¡ŒOperatorï¼Œè‡ªé¡¶å‘ä¸‹æˆ–è€…è‡ªé¡¶å‘ä¸Šè¿”å›æ•°æ®ã€‚\nå…³ç³»ä»£æ•°ç­‰ä»·åŸåˆ™\nåœ¨æ»¡è¶³ç”Ÿæˆç›¸åŒç»“æœé›†çš„æ¡ä»¶ä¸‹ï¼Œä¾æ®å…³ç³»ä»£æ•°çš„ç­‰ä»·äº¤æ¢åŸåˆ™åšé€»è¾‘äº¤æ¢ï¼ŒåŒ…æ‹¬ï¼šè°“è¯ä¸‹æ¨ï¼ˆå°½æ—©è¿›è¡Œè¿‡æ»¤ï¼›åˆ†è§£å¤æ‚æ¡ä»¶ï¼›ç¬›å¡å°”ç§¯è½¬Joinï¼‰ï¼ŒæŠ•å½±ä¸‹æ¨ï¼Œæ’åºã€Limitã€èšåˆä¸‹æ¨ï¼ŒæŠ•å½±æ¶ˆé™¤ï¼Œæ’åºæ¶ˆé™¤ç­‰ã€‚\néå…³è”å­æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢ä¸åŒ…å«éå­æŸ¥è¯¢çš„åˆ—ï¼‰ï¼šå°†å­æŸ¥è¯¢å±•å¼€æ”¹å†™ï¼Œå¯¹äºåŒ…å«INçš„å­æŸ¥è¯¢è½¬ä¸ºJOIN\nå…³è”å­æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢åŒ…å«éå­æŸ¥è¯¢çš„åˆ—ï¼‰ï¼šä¼˜åŒ–å™¨æ·»åŠ Apply Operatorï¼Œå°†æ•´ä¸ªåŒ…å«å­æŸ¥è¯¢çš„è¡¨è¾¾å¼è½¬ç§»åˆ°Applyçš„å³å­æ ‘ä¸Šï¼Œå°½åŠ›å°†Applyè½¬åŒ–ä¸ºç­‰ä»·çš„JOINã€‚éœ€è¦å°†INNER PLANåŒ…å«ç›¸å…³çš„åˆ—çš„ç®—å­æå‰åˆ°Applyä¸­æˆ–ä¹‹ä¸Šã€‚\n1.2. Execution Engine 1.3. Storage æ’å…¥æµç¨‹ï¼š\nClientå‘èµ·è¯·æ±‚ï¼ŒæŸ¥è¯¢å¤„ç†å™¨ä½¿ç”¨æ•°æ®å­—å…¸å’Œç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆæœ€æœ‰æ‰§è¡Œè®¡åˆ’ è°ƒç”¨äº‹åŠ¡ç®¡ç†ç›¸å…³é€»è¾‘ï¼Œå¦‚é”ã€åˆ†é…äº‹åŠ¡å·æ—¶é—´æˆ³ç­‰ è°ƒç”¨æ–‡ä»¶ç®¡ç†å™¨WALï¼Œå‘ç¼“å­˜åŒºç®¡ç†å™¨æ’å…¥æ•°æ®å’Œç´¢å¼• æ£€ç´¢æµç¨‹ï¼š\nClientå‘èµ·è¯·æ±‚ï¼ŒæŸ¥è¯¢å¤„ç†å™¨ä½¿ç”¨æ•°æ®å­—å…¸å’Œç»Ÿè®¡ä¿¡æ¯ç”Ÿæˆæœ€æœ‰æ‰§è¡Œè®¡åˆ’ è°ƒç”¨äº‹åŠ¡ç®¡ç†ç›¸å…³é€»è¾‘ï¼Œå¦‚é”ã€åˆ†é…äº‹åŠ¡å·æ—¶é—´æˆ³ç­‰ è°ƒç”¨ç¼“å­˜åŒºç®¡ç†å™¨æŸ¥è¯¢ç´¢å¼•æˆ–è€…æ˜¯æ•°æ®çš„ç¼“å­˜ï¼Œå‘æ–‡ä»¶ç®¡ç†å™¨æŸ¥è¯¢æ•°æ®å’Œç´¢å¼•ï¼Œå¹¶ä¸”å†™å…¥ç¼“å­˜ å­˜å‚¨å½¢å¼ç»„ç»‡\nåˆ—å­˜å‚¨ï¼šæ–¹ä¾¿æ•°æ®å‹ç¼©ï¼Œé€‚ç”¨äºOLAPï¼Œæˆ–è€…æ˜¯æŸ¥è¯¢åªæ¶‰åŠéƒ¨åˆ†åˆ—ã€‚\nå¦‚æœæ¶‰åŠåˆ°å¤šä¸ªä¸åŒçš„åˆ—ï¼Œå°±éœ€è¦å¤šæ¬¡IOæ¥ç»„åˆæœ€åçš„è®°å½•\næ•°æ®ç²’åº¦Pageï¼šå°†å¤šè¡Œæ•°æ®èšåˆPageï¼Œç”¨äºä¼ ç»Ÿçš„MySQLï¼ŒPostgreSQLç­‰ã€‚å­˜åœ¨è¯»å†™æ”¾å¤§é—®é¢˜ï¼Œå…ƒæ•°æ®å°‘ã€‚\næ•°æ®ç²’åº¦Tupleï¼šé€‚ç”¨äºæ–°å‹NVMä»‹è´¨ï¼Œä½†è¡Œè®°å½•å°±æ˜¯æœ€å°çš„è®¿é—®å•å…ƒï¼Œå‡å°‘Tupleå’ŒPageä¹‹é—´çš„ç¼–è§£ç ï¼Œå…ƒæ•°æ®å¤šã€‚\nç´¢å¼•ç»„ç»‡ç»“æ„\nB-Treeï¼š\nä¼˜ç‚¹ï¼š1. éå¶å­ç»“ç‚¹ä¸åŒ…å«æ•°æ®ï¼Œé«˜åº¦å°ï¼Œå•æ¬¡è¯·æ±‚è®¾è®¡çš„ç£ç›˜IOæ¬¡æ•°å°‘ï¼› 2. æ¯æ¬¡æŸ¥è¯¢éƒ½è¦åˆ°å¶å­ç»“ç‚¹ï¼Œè·¯å¾„é•¿åº¦ç›¸åŒï¼Œæ•ˆç‡ç¨³å®šï¼› 3. æ‰€æœ‰æŸ¥è¯¢éƒ½ä»æ ¹èŠ‚ç‚¹å‡ºå‘ï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡é«˜ã€‚\nç¼ºç‚¹ï¼šåˆ†è£‚æ—¶ï¼Œé€»è¾‘è¿ç»­çš„å¶å­èŠ‚ç‚¹åœ¨ç‰©ç†ä¸Šä¸è¿ç»­ï¼Œä¼šäº§ç”Ÿå¤§é‡éšæœºçš„IOï¼Œå½±å“æ€§èƒ½ã€‚\nLSMï¼ˆLog- Structured Merge Treeï¼‰\né€šè¿‡å†…å­˜æ’å…¥ä¸ç£ç›˜é¡ºåºå†™ä¸€è‡´ï¼Œå¤§å¹…æå‡å†™æ“ä½œï¼Œé€‚ç”¨äºHBaseï¼Œæ•ˆç‡æ¯”MySQLé«˜ä¸€ä¸ªé‡çº§ã€‚\nä½å›¾ç´¢å¼•ï¼š\nç»Ÿè®¡èŒƒå›´é€Ÿåº¦è¾ƒå¿«ï¼Œä¸é€‚ç”¨äºèŒƒå›´å¹¿ã€æˆ–è€…é¢‘ç¹æ›´æ–°çš„åˆ—\n2. Log 2.1. Undo Log Undoå­˜å‚¨ä½ç½®ï¼Œåœ¨Undo Tablespaceçš„é¡µé¢ï¼Œå’Œæ­£å¸¸çš„è¡¨ç©ºé—´ä¸€æ ·ï¼Œä¿®æ”¹ä¹Ÿç”±redologè®°å½•ï¼Œæ‰€ä»¥äº‹ç‰©ä¼šæ»šæ—¶ä¼šæ“ä½œä¸¤è¾¹redologã€‚è½ç›˜æ—¶ï¼Œä¹Ÿå’Œæ™®é€šçš„æ•°æ®é¡µä¸€æ ·ï¼Œç”±backgroud threadå®šæœŸä»ç¼“å†²åŒºåˆ·å…¥ç£ç›˜ã€‚\n","date":"2022-02-03T16:11:16+08:00","image":"https://chasing1020.github.io/post/advanced-mysql/mysql_hubf29412fdbd9303c575ba06f7ee7c6af_94146_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/advanced-mysql/","title":"Advanced MySQL"},{"content":"1. Overview æœ€åˆçš„TCPå› ä¸ºä¸æ”¯æŒæ‹¥å¡æ§åˆ¶è€Œé¢‘ç¹è¢«ä¸¢å¼ƒæ•°æ®åŒ…ï¼Œåè®®æ ˆè¢«æŠ•å…¥ä½¿ç”¨8å¹´åï¼ŒVan Jacobsonåœ¨1988å¹´å°† TCP æ‹¥å¡æ§åˆ¶å¼•å…¥ç½‘ç»œã€‚\nIPå±‚å¹¶æ²¡æœ‰æä¾›æ‹¥å¡æ§åˆ¶åŠŸèƒ½ï¼Œå„ä¸ªä¸»æœºä¸çŸ¥é“ä»€ä¹ˆæ˜¯åˆç†çš„é€Ÿåº¦ã€‚ç†æƒ³åœºæ™¯åˆ©ç”¨è´Ÿåé¦ˆæ§åˆ¶çª—å£ï¼Œæ¯ä¸€ä¸ªTCPè¿æ¥ï¼Œå¼•å…¥å˜é‡CongestionWindowä¸SlowStartThresholdã€‚\n2. Tahoe å®šä¹‰æ‹¥å¡å‘ç”Ÿäº‹ä»¶ï¼šè¶…æ—¶æˆ–è€…æ˜¯3ä¸ªå†—ä½™ACKã€‚MSSï¼šMaximum Segment Size\nSlowStartï¼ˆSSï¼‰çŠ¶æ€ï¼š\næ¯ä¸€æ¬¡RTTï¼Œcwnd\u0026gt;\u0026gt;=1ï¼Œä¿æŒSSã€‚ è¶…æ—¶æˆ–è€…æ˜¯3-ACKï¼šé‡å‘ï¼Œcwnd=1MSSï¼Œssthresh=cwnd\u0026gt;\u0026gt;1ï¼Œä¿æŒSSã€‚ å¦‚æœè¾¾åˆ°è­¦æˆ’é˜ˆå€¼ï¼Œè¿›å…¥CAã€‚ CongestionAvoidanceï¼ˆCAï¼‰çŠ¶æ€ï¼š\næ¯ä¸€æ¬¡RTTï¼Œcwndå€å¢ï¼Œä¿æŒCAã€‚ è¶…æ—¶æˆ–è€…æ˜¯3-ACKï¼šé‡å‘ï¼Œcwnd=1MSSï¼Œè¿›å…¥SSã€‚ 3. Reno å®šä¹‰æ–°çš„çŠ¶æ€ï¼šFastRecoveryï¼Œè€ƒè™‘åˆ°2-ACKå¿…å®šä¹±åºé€ æˆçš„ï¼Œä¸¢åŒ…è‚¯å®šä¼šé€ æˆ2-ACKã€‚ä½†æ˜¯è¶…æ—¶çš„æƒ…å†µä¸‹å¿…å®šä¼šè¿›å…¥SSã€‚\nSlowStartï¼ˆSSï¼‰çŠ¶æ€ï¼š\næ¯ä¸€æ¬¡RTTï¼Œcwndå€å¢ã€‚ è¶…æ—¶ï¼šé‡å‘ï¼Œcwnd=1MSSï¼Œssthresh=cwnd\u0026gt;\u0026gt;1ï¼Œä¿æŒSSã€‚ 3-ACKï¼šå¿«é€Ÿé‡ä¼ ï¼Œssthresh=cwnd\u0026gt;\u0026gt;1ï¼Œcwnd=ssthresh+3ï¼Œè¿›å…¥FRã€‚ å¦‚æœè¾¾åˆ°è­¦æˆ’é˜ˆå€¼ï¼Œè¿›å…¥CAã€‚ CongestionAvoidanceï¼ˆCAï¼‰çŠ¶æ€ï¼š\næ¯ä¸€æ¬¡RTTï¼Œcwndå€å¢ã€‚\nè¶…æ—¶ï¼šé‡å‘ï¼Œcwnd=1MSSï¼Œè¿›å…¥SSã€‚\n3-ACKï¼šssthresh=cwnd\u0026gt;\u0026gt;1ï¼Œcwnd=ssthresh+3ï¼Œé‡ä¼ ï¼Œè¿›å…¥FRã€‚\nFastRecoveryï¼ˆFRï¼‰çŠ¶æ€ï¼š\ndupACK: cwnd=cwnd+1MSSï¼Œä¿æŒFRã€‚ newACKï¼šcwnd=ssthresthï¼Œè¿›å…¥CAã€‚ è¶…æ—¶ï¼šssthtresh=cwnd\u0026gt;\u0026gt;1ï¼Œcwnd=1ï¼Œé‡ä¼ ï¼Œè¿›å…¥SSã€‚ 4. New Reno Renoå­˜åœ¨çš„é—®é¢˜ï¼šä»FRæ¢å¤è¿‡å¿«ï¼Œä½†æ˜¯å®é™…ä¸Šåœ¨æ‹¥å¡æ—¶åˆ†ç»„æ˜¯æˆä¸²è¢«ä¸¢å¼ƒçš„ï¼Œåé¢æ®µçš„ä¸¢å¤±ï¼Œè¶…æ—¶åè¿˜æ˜¯ä¼šè¿›å…¥è¿›å…¥SSï¼Œä½¿å¾—cwndåˆå›åˆ°1ã€‚\næ”¹è¿›ï¼šç”±å‘é€æ–¹è®°ä½ç¼ºå°‘ç¡®è®¤çš„æ®µï¼Œå½“è¿™äº›ç¼ºå°‘çš„æ®µéƒ½è¢«ç¡®è®¤åï¼Œå†èµ°å‡ºFRçŠ¶æ€ã€‚\nFastRecoveryï¼ˆFRï¼‰çŠ¶æ€ï¼š\ndupACKï¼šåŒä¸Šï¼Œcwnd=cwnd+1ï¼Œä¿æŒFR\néƒ¨åˆ†ç¡®è®¤ï¼ˆPACKï¼‰ï¼šæ”¶åˆ°éƒ¨åˆ†æ–°ç¡®è®¤ï¼Œä¿æŒFR\nå‘é€ç¡®è®¤åé¢çš„æ®µï¼Œå†—ä½™ACKæ•°é‡=0ï¼Œ å®šæ—¶å™¨å¤ä½ä¸è¦è¶…æ—¶äº†ï¼Œ cwnd=cwnd+1\næœ‰æ–°æ®µå¯ä»¥å‘é€ï¼Œå‘é€æ–°çš„æ®µ\næ¢å¤ç¡®è®¤ï¼ˆRACKï¼‰ï¼šæ”¶åˆ°æ‰€æœ‰æ‹¥å¡æ—¶æœªç¡®è®¤çš„æ®µç¡®è®¤ï¼Œcwnd = ssthresh ï¼Œå®šæ—¶å™¨å¤ä½ï¼Œè¿›å…¥CAé˜¶æ®µ\nå­˜åœ¨é—®é¢˜ï¼šåªèƒ½æ¢å¤ä¸€ä¸ªæ®µçš„ä¸¢å¤±ã€‚\nè€ƒè™‘RFC793ï¼Œåœ¨TCPå¤´éƒ¨ä¿ç•™æœ‰Options\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Source Port | Destination Port | | 16 bit | 16 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Sequence Number | | 32 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Acknowledgment Number | | 32 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Data | |U|A|P|R|S|F| | |Offset | Reserved |R|C|S|S|Y|I| Window | | | |G|K|H|T|N|N| | |4 bits | 6 bits | 6 bits | 16 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Checksum | Urgent Pointer | | 16 bits | 16 bits | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Options | Padding | | variable length | | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | data | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ é€šè¿‡SACKï¼Œå¦‚æ¥æ”¶æ–¹ç»™å‡ºå“ªäº›æ®µæ”¶åˆ°äº†ï¼Œå“ªäº›æ®µä¹±åºåˆ°è¾¾äº†ç­‰ä¿¡æ¯ç»™å‘é€æ–¹ã€‚å‘é€ç«¯ä¸€æ¬¡å‘é€å¤šä¸ªä¸¢å¤±æ®µï¼Œæ¯RTTå¯ä»¥é‡ä¼ å¤šä¸ªä¸¢å¤±æ®µï¼Œæå‡æ•ˆç‡ã€‚ä¿®æ”¹TCPé¦–éƒ¨çš„Optionså¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | nop | nop | SACK(5) | L = 10 | | 8 bits | 8 bits | 8 bits | 8 bits | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Left Edge | | 32 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ | Right Edge | | 32 bit | +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+ SACKï¼ˆSeveral ACKï¼‰ï¼šåœ¨NewRenoçš„åŸºç¡€ä¸Šï¼Œä½¿ç”¨pipe=å¾…ç¡®è®¤çš„æ®µæ•°é‡ï¼ˆ åœ¨ç®¡é“ä¸­å·²å‘é€å‡ºå»çš„æ®µæ•°ï¼‰ th=cwnd\u0026gt;\u0026gt;1ï¼Œcwnd=th+3ã€‚pipeä¸èƒ½å¤Ÿå¤ªæ»¡ï¼Œä¹Ÿä¸èƒ½å¤Ÿå¤ªå°‘ã€‚\n5. Cubic WIP\n","date":"2022-01-18T22:37:50+08:00","image":"https://chasing1020.github.io/post/tcp-congestion-control/tcp_hu2620574533357265ba63411697f2b8cd_37372_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/tcp-congestion-control/","title":"TCP Congestion Control"},{"content":"The Eight Fallacies of Distributed Computing by Peter Deutsch.\nEssentially everyone, when they first build a distributed application, makes the following eight assumptions. All prove to be false in the long run and all cause big trouble and painful learning experiences.\nThe network is reliable Latency is zero Bandwidth is infinite The network is secure Topology doesn\u0026rsquo;t change There is one administrator Transport cost is zero The network is homogeneous 1. 2PC XAè§„èŒƒä¸­å®šä¹‰çš„åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å‹åŒ…æ‹¬å››ä¸ªç»„æˆéƒ¨åˆ†ï¼š\nRMï¼ˆResource Managerï¼Œèµ„æºç®¡ç†å™¨ï¼‰ï¼Œè´Ÿè´£ç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†æ•°æ®èµ„æºï¼Œä¿éšœè¯¥éƒ¨åˆ†æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ»¡è¶³è§„èŒƒè¦æ±‚çš„æ•°æ®ç®¡ç†ç³»ç»Ÿå‡å¯ä½œä¸ºRMå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œæœ€å…¸å‹çš„åº”ç”¨æ˜¯æ•°æ®åº“ï¼Œå¦‚MySQLã€Oracleã€SQLServerç­‰å‡æ”¯æŒè¯¥è§„èŒƒ TMï¼ˆTransaction Managerï¼Œäº‹åŠ¡ç®¡ç†å™¨ï¼‰ï¼Œè´Ÿè´£åè°ƒè·¨RMçš„å…¨å±€äº‹åŠ¡çš„å¼€å¯ã€æäº¤å’Œå›æ»š APï¼ˆApplication Programï¼Œåº”ç”¨ç¨‹åºï¼‰ï¼Œé€šè¿‡TMå®šä¹‰äº‹åŠ¡è¾¹ç•Œï¼Œæ‰§è¡Œå…¨å±€äº‹åŠ¡ CRMï¼ˆCommunication Resource Managersï¼Œé€šä¿¡ç®¡ç†å™¨ï¼‰ï¼Œè´Ÿè´£å…¨å±€äº‹åŠ¡è¿‡ç¨‹ä¸­çš„è·¨èŠ‚ç‚¹é€šä¿¡ äºŒé˜¶æ®µæäº¤æ˜¯ä¸€ç§å¼ºä¸€è‡´æ€§çš„è®¾è®¡ã€‚è®¾ç½®ä¸€ä¸ªä¸­å¿ƒçš„åè°ƒè€…ï¼ˆCoordinatorï¼Œä¹Ÿç§°Transaction Managerï¼ŒTMï¼‰ä¸å¤šä¸ªè¢«è°ƒåº¦çš„ä¸šåŠ¡èŠ‚ç‚¹å‚ä¸è€…ï¼ˆParticipantï¼Œä¹Ÿç§°Resource Managerï¼ŒRMï¼‰ã€‚\nç¬¬ä¸€é˜¶æ®µï¼ˆprepareï¼‰ï¼š\nTMè®°å½•äº‹åŠ¡å¼€å§‹æ—¥å¿—ã€‚ å‘æ‰€æœ‰RMå‘é€Prepareæ¶ˆæ¯ï¼Œç­‰å¾…å“åº”ã€‚ æ¯ä¸ªå‚ä¸è€…éƒ½æ‰§è¡Œäº‹åŠ¡ï¼Œè®°å½•Undo/Redoæ—¥å¿—ï¼Œå‘TMè¿”å›ç»“æœï¼ŒRMå¹¶ä¸æäº¤äº‹åŠ¡ã€‚ TMè®°å½•å‡†å¤‡å®Œæˆæ—¥å¿—ã€‚ ç¬¬äºŒé˜¶æ®µï¼ˆif commitï¼‰ï¼š\nå½“äº‹åŠ¡ç®¡ç†è€…(TM)ç¡®è®¤æ‰€æœ‰å‚ä¸è€…(RM)éƒ½readyåï¼ŒTMè®°å½•äº‹åŠ¡æäº¤æ—¥å¿—ã€‚ TMå‘æ‰€æœ‰RMå‘é€commitå‘½ä»¤ã€‚ RMæäº¤äº‹åŠ¡ï¼Œå‘TMè¿”å›æ‰§è¡Œç»“æœã€‚ TMè®°å½•äº‹åŠ¡ç»“æŸæ—¥å¿—ã€‚ ç¬¬äºŒé˜¶æ®µï¼ˆif rollbackï¼‰ï¼š\nå½“äº‹åŠ¡ç®¡ç†è€…(TM)ç¡®è®¤æœ‰ä»»ä¸€å‚ä¸è€…(RM)å¤±è´¥æˆ–è¶…æ—¶åï¼ŒTMè®°å½•äº‹åŠ¡ä¼šæ»šæ—¥å¿—ã€‚ TMå‘æ‰€æœ‰RMå‘é€rollbackå‘½ä»¤ã€‚ RMå›æ»šäº‹åŠ¡ï¼Œå‘TMè¿”å›æ‰§è¡Œç»“æœã€‚ TMè®°å½•äº‹åŠ¡ç»“æŸæ—¥å¿—ã€‚ 2PCæ˜¯å¯¹ä¸šåŠ¡ä¾µå…¥æ€§è¾ƒå°çš„å¼ºä¸€è‡´æ€§çš„ä¿è¯ã€‚å¯¹äºMySQLï¼ŒXAæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹å¯¹åº”çš„èµ„æºéƒ½è¦åŠ é”ï¼Œé˜»å¡å…¶ä»–äº‹åŠ¡è®¿é—®ã€‚å¹¶ä¸”TMå¾ˆå®¹æ˜“å‘ç”Ÿå•ç‚¹æ•…éšœï¼Œæ­¤æ—¶ä¾¿ä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´ä¸ä¸ç¡®å®šæ€§ã€‚\n2. Saga Sagaç†è®ºåŸºç¡€æ¥æºäºHector \u0026amp; Kenneth åœ¨1987å¹´å‘è¡¨çš„è®ºâ½‚ã€ŠSAGASã€‹ã€‚å®ƒæŠŠåˆ†å¸ƒå¼äº‹åŠ¡çœ‹ä½œä¸€ç»„æœ¬åœ°åˆ†æ”¯äº‹åŠ¡æ„æˆçš„äº‹åŠ¡é“¾ï¼Œä¸šåŠ¡æµç¨‹ä¸­æ¯ä¸ªå‚ä¸è€…éƒ½æäº¤æœ¬åœ°äº‹åŠ¡ã€‚åœ¨æ‰§è¡Œé“¾ä¸­ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™åæ–¹å‘è¿›è¡Œè¡¥å¿æ“ä½œã€‚\nè¡¥å¿æ˜¯å­äº‹åŠ¡çš„æäº¤ï¼Œå¯¹çº¿ä¸Šå…¶ä»–äº‹åŠ¡å¯è§ï¼Œå³ï¼šå·²ç»äº§ç”Ÿäº†å½±å“ï¼Œåªèƒ½å°½å¯èƒ½è¡¥å¿ã€‚ Sagaæ˜¯æ»¡è¶³äº†BASEï¼Œå¹¶ä¸æ”¯æŒéš”ç¦»æ€§ï¼Œå¯èƒ½ä¼šå‘ç”Ÿè„è¯»è„å†™ã€‚ååé‡è¾ƒé«˜ï¼Œä¸€é˜¶æ®µæäº¤æœ¬åœ°äº‹åŠ¡ï¼Œæ— é”ï¼Œé«˜æ€§èƒ½ã€‚äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œå‚ä¸è€…å¯å¼‚æ­¥æ‰§è¡Œï¼Œè€Œä¸”å­äº‹åŠ¡å¹¶ä¸ä¸€å®šéƒ½éœ€è¦æ˜¯DBç›¸å…³æ“ä½œã€‚\n3. TCC TCCï¼ˆTry-Confirm-Cancelï¼‰ç†è®ºæºäº Pat Helland åœ¨2007å¹´å‘è¡¨çš„è®ºæ–‡ã€ŠLife beyond Distributed Transactions:an Apostateâ€™s Opinionã€‹ã€‚å…¶å°†æ”¯æŒæŠŠè‡ªå®šä¹‰çš„åˆ†æ”¯äº‹åŠ¡çº³å…¥åˆ°å…¨å±€äº‹åŠ¡çš„ç®¡ç†ä¸­\nå…¨å±€äº‹åŠ¡æ˜¯ç”±è‹¥å¹²åˆ†æ”¯äº‹åŠ¡ç»„æˆçš„ï¼Œåˆ†æ”¯äº‹åŠ¡è¦æ»¡è¶³2PCæ¨¡å‹çš„è¦æ±‚ã€‚\nå°†TMå˜æˆå¤šèŠ‚ç‚¹ï¼Œå¼•å…¥è¶…æ—¶è¡¥å¿çš„æ¦‚å¿µï¼Œå¹¶ä¸ä¼šé”ä½æ‰€æœ‰èµ„æºã€‚\nTry é˜¶æ®µï¼šå®Œæˆæ‰€æœ‰ä¸šåŠ¡æ£€æŸ¥ï¼Œé¢„ç•™å¿…é¡»ä¸šåŠ¡èµ„æºã€‚ Confirm é˜¶æ®µï¼šç¡®è®¤æ‰§è¡ŒçœŸæ­£æ‰§è¡Œä¸šåŠ¡ï¼Œåªä½¿ç”¨ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚ä¸€æ—¦å¼‚å¸¸ï¼Œå‘ç°äº‹åŠ¡æäº¤æ ‡è®°ï¼Œé‡è¯•æ‰€æœ‰Confirmæ“ä½œï¼ˆéœ€è¦ä¿è¯å¹‚ç­‰æ€§ï¼‰ã€‚ Cancel é˜¶æ®µï¼šå–æ¶ˆæ‰§è¡Œï¼Œé‡Šæ”¾ Try é˜¶æ®µé¢„ç•™çš„ä¸šåŠ¡èµ„æºã€‚ä¸€æ—¦å¼‚å¸¸ï¼Œå‘ç°äº‹åŠ¡ä¼šæ»šæ ‡è®°ï¼Œé‡è¯•æ‰€æœ‰Cancelæ“ä½œï¼ˆéœ€è¦ä¿è¯å¹‚ç­‰æ€§ï¼‰ã€‚ TCCæ»¡è¶³BASEï¼Œç›¸è¾ƒäº2PCï¼Œååæ€§ã€å¯ç”¨æ€§æ›´é«˜ã€‚åœ¨ä¸šåŠ¡å±‚é¢ä¿è¯éš”ç¦»æ€§ã€‚\n4. AT ATï¼ˆAutomatic Transactionï¼‰æ¨¡å¼ä¸ä¾èµ–å‚ä¸è€…å¯¹AXäº‹åŠ¡çš„æ”¯æŒã€‚\nåœ¨seataçš„å®ç°ä¸­ï¼ŒAutomatic (Branch) Transaction Modeå¯¹åº”ATæ¨¡å¼ï¼ŒManual (Branch) Transaction Modeå¯¹åº”TCCæ¨¡å¼ã€‚\nç¬¬ä¸€é˜¶æ®µï¼ˆprepareï¼‰ï¼šåœ¨æœ¬åœ°äº‹åŠ¡ä¸­ï¼Œä¸€å¹¶æäº¤ä¸šåŠ¡æ•°æ®æ›´æ–°å’Œç›¸åº”å›æ»šæ—¥å¿—è®°å½•ã€‚ ç¬¬äºŒé˜¶æ®µï¼ˆcommitï¼‰ï¼šé©¬ä¸ŠæˆåŠŸç»“æŸï¼Œè‡ªåŠ¨ å¼‚æ­¥æ‰¹é‡æ¸…ç†å›æ»šæ—¥å¿—ã€‚ ç¬¬äºŒé˜¶æ®µï¼ˆrollbackï¼‰ï¼šé€šè¿‡å›æ»šæ—¥å¿—ï¼Œè‡ªåŠ¨ ç”Ÿæˆè¡¥å¿æ“ä½œï¼Œå®Œæˆæ•°æ®å›æ»šã€‚ éš”ç¦»çº§åˆ«ä¸ºRUï¼Œæœªæäº¤çš„äº‹åŠ¡æ•°æ®ä¹Ÿä¼šè¢«å…¶ä»–äº‹åŠ¡è¯»åˆ°ã€‚\n*. Conclusion XA AT TCC Saga æœ¬åœ°/äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆ ä¸€è‡´æ€§ å¼ºä¸€è‡´ å¼ºä¸€è‡´ æœ€ç»ˆä¸€è‡´ æœ€ç»ˆä¸€è‡´ æœ€ç»ˆä¸€è‡´ éš”ç¦»æ€§ æ”¯æŒ è¯»æœªæäº¤ æ”¯æŒï¼ˆé€šè¿‡ä¸šåŠ¡å±‚é¢åœ¨Tryé˜¶æ®µçš„èµ„æºé”å®šå®ç°éš”ç¦»ï¼‰ ä¸æ”¯æŒ ä¸æ”¯æŒ æ€§èƒ½ å…¨å±€é”ï¼Œæ€§èƒ½å·® ååé‡å·®ï¼Œä¼˜äºXA Tryæ“ä½œä½¿èµ„æºé”å®šå¯ä»¥å°½æ—©é‡Šæ”¾ï¼Œç³»ç»Ÿååé‡é«˜ ååé‡é«˜ ååé‡é«˜ ä¸šåŠ¡ä¾µå…¥ æ— ä¾µå…¥ æ— ä¾µå…¥ è¾ƒé«˜ è¾ƒä½ è¾ƒä½ ä¼˜ç‚¹ å¼ºä¸€è‡´æ€§ä¿è¯ ä¸šåŠ¡æ— ä¾µå…¥ ä¸šåŠ¡æ— ä¾µå…¥ é€‚ç”¨äºçŸ­äº‹åŠ¡ ç”±ä¸šåŠ¡å±‚é¢æ¥ä¿è¯éš”ç¦»æ€§ æ€§èƒ½ç›¸å¯¹è¾ƒé«˜ï¼Œååé‡é«˜ æ€§èƒ½ç›¸å¯¹è¾ƒé«˜ï¼Œååé‡é«˜ å¯¹ä¸šåŠ¡ä¾µå…¥è¾ƒå°‘ å¯¹ä¸šåŠ¡ä¾µå…¥è¾ƒå°‘ é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶è§£è€¦ï¼Œä¸‹æ¸¸äº‹åŠ¡å¼‚æ­¥åŒ– ç¼ºç‚¹ éœ€è¦XAè§„èŒƒã€‚å­˜åœ¨åŒæ­¥é˜»å¡ã€å•ç‚¹æ•…éšœã€æ•°æ®ä¸ä¸€è‡´ã€ä¸ç¡®å®šæ€§ç­‰å¯ç”¨æ€§é—®é¢˜ äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºè„è¯» ä¸é€‚ç”¨äºé•¿äº‹åŠ¡ ä¸šåŠ¡æ”¹é€ æˆæœ¬è¾ƒé«˜ï¼Œä¸šåŠ¡éœ€åˆ†æ‹†ä¸ºTry/Confirm/Cancelä¸‰ä¸ªæ“ä½œ å¼•å…¥ä¸­é—´æ€ï¼Œä¸šåŠ¡å¤æ‚ï¼Œä¸åˆ©äºè¿­ä»£ç»´æŠ¤ã€‚ ä¸å…·å¤‡éš”ç¦»æ€§ï¼Œæ˜“å‡ºç°è„è¯»ï¼Œè„å†™é—®é¢˜ï¼Œå¯èƒ½é€ æˆè„å†™æ— æ³•å›æ»š ä¸å…·å¤‡éš”ç¦»æ€§ ä¸å…·å¤‡äº‹åŠ¡å›æ»šï¼Œåªèƒ½é‡è¯• é€‚ç”¨ä¸šåŠ¡ å¼ºä¸€è‡´æ€§ çŸ­äº‹åŠ¡ ä¸€èˆ¬å¯ç”¨æ€§ å¼ºä¸€è‡´æ€§ çŸ­äº‹åŠ¡ ä¸€èˆ¬å¯ç”¨æ€§ æœ€ç»ˆä¸€è‡´æ€§ çŸ­äº‹åŠ¡ å¼ºå¯ç”¨æ€§ æœ€ç»ˆä¸€è‡´æ€§ é•¿äº‹åŠ¡ å¼ºå¯ç”¨æ€§ ä¸è¦æ±‚éš”ç¦»æ€§ å¤‡æ³¨ éœ€è¦æ³¨æ„å¤„ç†ç©ºå›æ»šï¼Œé‡å¤æäº¤ï¼Œæ‚¬æŒ‚ç­‰å¼‚å¸¸æƒ…å†µ éœ€è¦æ³¨æ„å¤„ç†ç©ºè¡¥å¿ï¼Œé‡å¤æäº¤ï¼Œæ‚¬æŒ‚ç­‰å¼‚å¸¸æƒ…å†µ ","date":"2022-01-08T15:08:08+08:00","image":"https://chasing1020.github.io/post/distributed-transaction/saga_hu6e13a83e426eecead9676ebbb90e90b9_79808_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/distributed-transaction/","title":"Distributed Transaction"},{"content":"1. Definition of security confidentiality: only sender, intended receiver should â€œunderstandâ€ message contents\nsender encrypts message receiver decrypts message authentication: sender, receiver want to confirm identity of each other\nmessage integrity: sender, receiver want to ensure message not altered (in transit, or afterwards) without detection\naccess and availability: services must be accessible and available to users. Access is the basis of availability.\nWithout network security, the intruder can eavesdrop, insert messages, impersonation, hijacking(taking over ongoing connection), denial of service and so on.\n2. Principles of cryptography we can define that:\nm: plaintext message\n$K_A(m)$: ciphertext, encrypted with key $K_A$\n$m = K_B(K_A(m))$\nThere are two kinds of scheme about attacking: 1. cipher-text only attack; 2. known-plaintext attack and chosen-plaintext attack.\nDES: Data Encryption Standard\n56-bit symmetric key, 64-bit plaintext input. Block cipher with cipher block chaining.\n3DES: encrypt 3 times with 3 different keys.\nAES: Advanced Encryption Standard\nprocesses data in 128 bit blocks.\nUsing block chiper, the ith input as $m(i)$, let $c(i) = m(i)\\ xor\\ c(i-1)$.\nRSA: Rivest, Shamir, Adelson algorithm\nCreating public/private key pair: Let m be the plain text message that the originator will encrypt and send to the intended recipient. Let e be the public encryption key, d the private decryption key, c the ciphertext.\nproof: Let $n = pq \\implies \\varphi(n) = (p âˆ’ 1)(q âˆ’ 1)$\nEuler\u0026rsquo;s theorem: $m^{\\varphi(n)}\\equiv1\\ (mod\\ n)$\n$\\implies m^{(p-1)(q-1)}\\equiv1 \\mod(pq)$\n$\\implies m^{k\\varphi(n)+1}\\equiv m \\mod(pq)$\nBased on the RSA basic principle, $ed = k\\varphi(n)+1$.\nThis is equivalent to say we need to satisfy: $ed\\equiv1(mod \\varphi(n))$\nIf e is determined, $dmod\\varphi(n)$ could be determined, using the Extend Euclidean algorithm which takes $O(log^2\\varphi(n))$ to run.\n3. Message integrity Cryptographic technique analogous to hand-written signatures.\nDigital signatures: signed message digest\nSuppose Alice receives msg m, with signature: m, $K_B^-(m)$\nAlice verifies $m$ signed by Bob by applying Bobâ€™s public key $K_B^+$ to $K_B^-(m)$ then checks whether $K_B^+(K_B^-(m)) = m$\nIf $K_B^+(K_B^-(m)) = m$, whoever signed m must have used Bobâ€™s private key\nHash function algorithms\nMD5 hash function widely used (RFC 1321) :\ncomputes 128-bit message digest in 4-step process.\narbitrary 128-bit string x, appears difficult to construct msg m whose MD5 hash is equal to x\nSHA-1 is also used:\nUS standard [NIST, FIPS PUB 180-1]\n160-bit message digest\nPublic key Certification Authorities (CA)\ncertification authority (CA): binds public key to particular entity, E.\nentity (person, website, router) registers its public key with CE provides â€œproof of identityâ€ to CA (bind by OS).\nCA creates certificate binding identity E to Eâ€™s public key.\ncertificate containing Eâ€™s public key digitally signed by CA: CA says â€œthis is Eâ€™s public keyâ€.\n4. Securing TCP connections: TLS TLS is a widely deployed security protocol above the transport layer; supported by almost all browsers, web servers: https (port 443)\nTLS provides: 1.confidentiality: via symmetric encryption; 2. integrity: via cryptographic hashing; 3. authentication: via public key cryptography.\nTLS needed:\nhandshake: Alice, Bob use their certificates, private keys to authenticate each other, exchange or create shared secret.\nkey derivation: Alice, Bob use shared secret to derive set of keys\ndata transfer: stream data transfer: data as a series of records not just one-time transactions\nconnection closure: special messages to securely close connection\nWhich need four keys:\n$K_c$: encryption key for data sent from client to server\n$M_c$: MAC key for data sent from client to server\n$K_s$: encryption key for data sent from server to client\n$M_s$: MAC key for data sent from server to client\nDiffie Hellman Algorithm\nDH algorithm is based on a famous problem called Discrete Logarithm Problem (DLP).\nIt based on a theory that if I define a prime p, and g is a primitive root modulo p. If gives you a random number $a$, it is esay to calculate $g^amodp$. But it is difficult to get the inverse solution $a$ if you only have $p$, $g$, and $g^amodp$.\nThey first agree between them a large prime number p, and a generator (or base) g (where 0 \u0026lt; g \u0026lt; p).\nAlice chooses a secret integer a (her private key) and then calculates $g^a mod p$ (which is her public key). Bob chooses his private key b, and calculates his public key in the same way.\nBob knows $b$ and $g^a$, so he can calculate $(g^a)^b mod p = g^{ab} mod p$. Therefore both Alice and Bob know a shared secret $g^{ab} mod p$. An eavesdropper Eve who was listening in on the communication knows p, g, Aliceâ€™s public key $(g^a mod p)$ and Bobâ€™s public key $(g^b mod p)$. She is unable to calculate the shared secret from these values.\n$(g^a mod p)^b mod p = g^{ab} mod p$\n$(g^b mod p)^a mod p = g^{ba} mod p$\nTLS: 1.3 cipher suite\nâ€œcipher suiteâ€: algorithms that can be used for key generation, encryption, MAC, digital signature.\nclient TLS hello message: guesses key agreement protocol (DH key agreement protocol), parameters\nindicates cipher suites it supports\nserver TLS hello msg chooses key agreement protocol (DH key agreement protocol), parameters\nselected cipher suite\nserver-signed certificate\nthen client will: 1. checks server certificate; 2. generates key; 3.can now make application request (e.g.., HTTPS GET)\nRecover connection:\ninitial hello message contains encrypted application data!\nâ€œresumingâ€ earlier connection between client and server\napplication data encrypted using â€œresumption master secretâ€ from earlier connection\nvulnerable to replay attacks!\nmaybe OK for get HTTP GET or client requests not modifying server state 5. IPSec IPSec provides datagram-level encryption, authentication, integrity, and it has two types:\ntransport mode: only datagram payload is encrypted, authenticated.\ntunnel mode: entire datagram is encrypted, authenticated. Encrypted datagram encapsulated in new datagram with new IP header, tunneled to destination.\n6. Firewall Firewall isolates organizationâ€™s internal network from larger Internet, allowing some packets to pass, blocking others.\nStateless packet filtering examples:\nPolicy Firewall Setting no outside Web access drop all outgoing packets to any IP address, port 80 no incoming TCP connections, except those for institutionâ€™s public Web server only drop all incoming TCP SYN packets to any IP except 130.207.244.203, port 80 prevent Web-radios from eating up the available bandwidth. drop all incoming UDP packets - except DNS and router broadcasts prevent your network from being used for a smurf DoS attack drop all ICMP packets going to a â€œbroadcastâ€ address (e.g. 130.207.255.255) prevent your network from being tracerouted drop all outgoing ICMP TTL expired traffic ","date":"2022-01-06T22:39:42+08:00","image":"https://chasing1020.github.io/post/network-security/rsa_hu34ccd06c2b23f5aba077d2a875a1a9d2_56262_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/network-security/","title":"Network Security"},{"content":"AKF Availability Cube éšç€ä¸šåŠ¡è§„æ¨¡å¢é•¿ï¼Œæ‹†è§£å•ä½“åº”ç”¨ï¼ˆmonolithï¼‰ï¼Œè®¾è®¡æˆä¸ºé¢å‘æœåŠ¡æ¶æ„ï¼ˆService-oriented architectutreï¼‰ï¼Œåšæˆä¸€ä¸ªä¸ªå¾®æœåŠ¡ï¼ˆMicro-serviceï¼‰å·²ç»æ˜¯å¦‚ä»Šçš„å¤§è¶‹åŠ¿ã€‚\nScale Cube Model ä»æ‹†åˆ†çš„è§’åº¦æ¥çœ‹ï¼Œä¹Ÿåˆ†æˆå¤šä¸ªå¯ä»¥è€ƒè™‘çš„ç»´åº¦ï¼Œå…¶ä¸­æœ€å¸¸ç”¨å®šä¹‰åˆ†å‰²æœåŠ¡ã€å®šä¹‰å¾®æœåŠ¡å’Œæ‰©å±•äº§å“çš„æ¨¡å‹å³æ˜¯æ¯”ä¾‹ç«‹æ–¹æ¨¡å‹ã€‚å…¶ä¸­ä¿è¯å¯ç”¨æ€§çš„è§£å†³æ–¹æ¡ˆAKF Availability Cubeä¾¿æ˜¯æœ€ç»å…¸çš„æ¨¡å‹ã€‚ç”¨äºæŒ‡å¯¼æœ‰å…³å¦‚ä½•å®ç°é«˜å¯ç”¨æ€§çš„è®¨è®ºï¼Œä»¥åŠè¯„ä¼°ç°æœ‰ç³»ç»Ÿç†è®ºä¸Šâ€œè®¾è®¡â€å¯ç”¨æ€§çš„å·¥å…·ã€‚å®ƒæ˜¯å…³äºé«˜å¯ç”¨æ€§è®¾è®¡çš„ä¸¤éƒ¨åˆ†ç³»åˆ—ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ Measuring Availability äº’è”ç½‘äº§å“ä¸€ç›´åœ¨â€œæœåŠ¡å§‹ç»ˆå¯ç”¨â€çš„è¿½æ±‚ä¸Šå°½å¯èƒ½å‡å°‘æˆæœ¬ï¼Œä»è¿™ä¸ªè§’åº¦å‡ºå‘ï¼ŒæœåŠ¡è¡¡é‡æ ‡å‡†æµ‹åº¦ä¸ºè¿½æ±‚å¯ç”¨æ€§æ”¹è¿›æä¾›äº†ä¸€ä¸ªèµ·ç‚¹ã€‚\nClock is not the best measure\næ—¶é—´å¯¹äºä¸šåŠ¡çš„å½±å“æ˜¯ä¸ç›¸ç­‰çš„ï¼Œè¿™å–å†³äºä¸šåŠ¡æ˜¯å¦å¤„äºé«˜å³°æœŸï¼›ä¼ä¸šçš„å•†ä¸šæœ¯è¯­ï¼šæ”¶å…¥ã€æˆæœ¬ã€åˆ©æ¶¦ã€æŠ•èµ„å›æŠ¥ç‡ï¼Œéƒ½ä»¥é‡‘é’±è€Œéæ—¶é—´ä½œä¸ºè¡¡é‡ï¼›åŸºç¡€è®¾æ–½ç»„ä»¶çš„æ—¶é—´ä½œä¸ºæµ‹åº¦æ˜¯ä¸å‡†ç¡®çš„ï¼Œä»–ä»¬å¹¶ä¸ä¼šæ•è·ç¨‹åºçš„å¼‚å¸¸ï¼Œå°½ç®¡æœåŠ¡æ— æ³•è¿è¡Œã€‚\nTransactional Metics\nRates: ä»¥é€Ÿåº¦è®°å½•ï¼Œä¾‹å¦‚ç™»å½•ã€æ·»åŠ åˆ°è´­ç‰©è½¦ã€æ³¨å†Œã€ä¸‹è½½ã€è®¢å•ç­‰ã€‚åº”ç”¨ç»Ÿè®¡è¿‡ç¨‹æ§åˆ¶æˆ–å…¶ä»–åˆ†ææ–¹æ³•æ¥å»ºç«‹æŒ‡ç¤ºäº¤æ˜“é€Ÿåº¦å¼‚å¸¸åå·®çš„é˜ˆå€¼ã€‚ Ratios: é¢„æ–™å¤–çš„æˆ–å¤±è´¥çš„ç»“æœçš„æ¯”ä¾‹å¯ç”¨äºè¡¡é‡æœåŠ¡è´¨é‡ã€‚å¯¹æ­¤ç±»æ¯”ç‡çš„åˆ†æå°†å»ºç«‹å¼‚å¸¸çš„åå·®æ°´å¹³ã€‚ Patterns: äº¤æ˜“æ¨¡å¼å¯ä»¥è¯†åˆ«é¢„æœŸçš„æ´»åŠ¨ï¼Œæ²¡æœ‰é¢„æœŸçš„æ¨¡å¼æ›´æ”¹å¯èƒ½è¡¨ç¤ºæ‚¨çš„äº§å“æˆ–æœåŠ¡å­˜åœ¨å¯ç”¨æ€§é—®é¢˜ã€‚ 3-Dimensions of scaling Dimension Description X-Axis Horizontal Duplication and Cloning of services and data Y-Axis Functional Decomposition and Segmentation - Microservices (or micro-services) Z-Axis Service and Data Partitioning along Customer Boundaries - Shards/Pods X-axis scaling Xè½´çš„æ ¸å¿ƒæ€è·¯åœ¨äº\u0026quot;cloning/replication\u0026quot;ï¼Œæˆ‘ä»¬å°†åº”ç”¨å¤åˆ¶ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚æˆ‘ä»¬å‡å®šæ•´ä½“å¯ç”¨ç‡\n$P_{singleton\\ availability}=\\frac{Total\\ Available-Non\\ Available}{Total\\ Available}$\nå½“æ·»åŠ äº†å¤šä¸ªç»“ç‚¹ä»¥åï¼Œæ–°çš„å¯ç”¨æ€§æ¦‚ç‡è¯„ä¼°å˜ä¸º\n$P_{overall\\ availability}=1-(1-P_{singleton\\ availability})^n$\nä½†æ˜¯ä»…ä»…åšåº”ç”¨å¤åˆ¶ï¼Œä¹Ÿæ— æ³•è§£å†³å¦‚ä¸‹ç¼ºç‚¹ï¼š\nå¤§é‡ä¸ä¼šè¯ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šå¸¸éš¾ä»¥åˆ†å‘æˆ–éœ€è¦æŒä¹…åŒ–åˆ°æœåŠ¡å™¨\næ¯ä¸ªæ‹·è´éœ€è¦è®¿é—®æ‰€æœ‰çš„æ•°æ®ï¼Œå¯¹ç¼“å­˜æœºåˆ¶è¦æ±‚å¾ˆé«˜ï¼Œæ•°æ®åº“å¾ˆå¯èƒ½æˆä¸ºå…¶ä¸­çš„ç“¶é¢ˆã€‚\nä¸ä¼šå‡å°‘æ—¥ç›Šå¢é•¿çš„å¼€å‘å¤æ‚åº¦ã€‚\nY-axis scaling Yè½´é€šè¿‡ä¸¤ä¸ªè§’åº¦è¿›è¡ŒæœåŠ¡åˆ‡åˆ†ã€‚åˆ†åˆ«æ˜¯åŠ¨è¯ï¼ˆæ“ä½œæµç¨‹ï¼‰å’Œåè¯ï¼ˆå¯¹è±¡ç±»å‹ï¼‰ï¼š\næŒ‰åŠ¨è¯åˆ†å‰²ï¼šæœåŠ¡1åªè´Ÿè´£è´­ä¹°æµç¨‹ï¼ŒæœåŠ¡2åªè´Ÿè´£å”®åæµç¨‹ï¼ŒæœåŠ¡3åªè´Ÿè´£å¹¿å‘ŠæŠ•æ”¾æµç¨‹\næŒ‰åè¯åˆ†å‰²ï¼šæœåŠ¡1åªè´Ÿè´£å•†å“ä¿¡æ¯ï¼›æœåŠ¡2åªè´Ÿè´£ç”¨æˆ·ä¿¡æ¯ã€‚\nå¾®æœåŠ¡çš„è®¾è®¡æ ¸å¿ƒæ€è·¯ä¾¿ä½“ç°åœ¨Yè½´ï¼Œå…¶å¯ä»¥å°†ç›®æ ‡åº”ç”¨åˆ’åˆ†æ³³é“ï¼Œé™åˆ¶åº”ç”¨çš„æ•…éšœåŸŸï¼Œå°†åº”ç”¨æ•…éšœä¿æŒåœ¨è¾¹ç•Œå†…ï¼Œä¸ä¼šä¼ æ’­å½±å“å¤–ç•Œçš„æœåŠ¡ã€‚\nç„¶è€Œï¼ŒYè½´åˆ’åˆ†çš„è¶Šç»†è‡´ï¼Œè¶Šå¤æ‚çš„ç³»ç»Ÿè¶Šå®¹æ˜“äº§ç”Ÿâ€œå¤šç±³è¯ºéª¨ç‰Œâ€æ•ˆåº”ï¼Œå¯èƒ½å¯¼è‡´ç›¸é‚»ç³»ç»Ÿç˜«ç—ªï¼Œä»è€Œå¯¼è‡´å»¶è¿Ÿã€åœæœºå’Œ/æˆ–å®Œå…¨å¤±è´¥ã€‚\næ¯”è¾ƒåˆç†çš„æ–¹å¼æ˜¯ï¼šå°†æœåŠ¡é›†æˆåœ¨ä¸€ä¸ªéš”ç¦»çš„å †æ ˆæˆ–æ³³é“å†…ï¼ˆæ‰˜ç®¡äº‘æˆ–å…¬å…±äº‘ï¼‰ï¼Œä»¥é¿å…è·¨æ•°æ®ä¸­å¿ƒè°ƒç”¨ã€‚å¹¶åŒæ—¶åœ¨Xè½´è§’åº¦ï¼Œå¤åˆ¶æœåŠ¡ï¼Œä»¥ä¾¿æ¯ä¸ªæ•°æ®ä¸­å¿ƒæˆ–äº‘å®ä¾‹éƒ½æ‹¥æœ‰æ‰€éœ€çš„ä¸€åˆ‡ã€‚\nç»¼ä¸Šï¼ŒYè½´åˆ’åˆ†çš„æœåŠ¡éœ€è¦åœ¨å¢åŠ æœåŠ¡æ•°é‡æé«˜å¯ç”¨æ€§ä¸å‡å°‘æœåŠ¡é—´é€šä¿¡æŸå¤±åšå‡ºä¸€ä¸ªTrade offã€‚\nZ-axis scaling Zè½´ä¸Xè½´å¾ˆåƒï¼ŒåŒºåˆ«åœ¨äºZè½´è´Ÿè´£çš„æ˜¯æ•°æ®çš„å­é›†è€Œä¸æ˜¯å¤åˆ¶ï¼Œå¸¸è§äºæ•°æ®åº“åˆ†ç‰‡ã€‚\nå¯¹äºæ¯ä¸€ä¸ªZè½´çš„åˆ†ç‰‡ï¼Œè½¯ä»¶æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ï¼ŒåŒºåˆ«ä»…ä»…åœ¨äºæ•°æ®ï¼Œå…¶å®šä¹‰äº†â€œçˆ†ç‚¸åŠå¾„â€ï¼ˆblast radius, aka Swimlanes or Bulkheadï¼‰ï¼Œè¾¹ç•Œå‡è®¾åœ¨æ³³é“ä¹‹é—´ä¸å­˜åœ¨åŒæ­¥è°ƒç”¨ã€‚æé«˜äº†è§£å†³æ–¹æ¡ˆçš„äº‹åŠ¡å¯æ‰©å±•æ€§ï¼ŒåŒæ—¶èƒ½å¤Ÿå®ç°æ•…éšœçš„éš”ç¦»ã€‚\nç¼“å­˜å‘½ä¸­ç‡é€šå¸¸éšç€è¾ƒå°çš„æ•°æ®é›†è€Œä¸Šå‡ï¼Œä¼˜åŒ–äº†ç¼“å­˜åˆ©ç”¨ç‡ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨å’ŒI/Oã€‚\néšç€å¯ä»¥ä½¿ç”¨å•†å“æœåŠ¡å™¨æˆ–è¾ƒå°çš„ IaaS å®ä¾‹ï¼Œè¿è¥æˆæœ¬é€šå¸¸ä¼šä¸‹é™ã€‚\nä½†æ˜¯å¦ä¸€ä¸ªè§’åº¦ï¼ŒZè½´çš„åˆ†ç‰‡ä¹Ÿå¸¦æ¥äº†å¦‚ä¸‹ç¼ºç‚¹ï¼š\nå¢åŠ äº†æ•´ä½“çš„å¤æ‚åº¦ã€‚ éœ€è¦å®ç°åˆ†ç‰‡æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶éš¾ä»¥å˜æ›´ï¼Œå¯¹æ–°çš„éœ€æ±‚ä¸å‹å¥½ã€‚ ","date":"2022-01-03T15:53:45+08:00","image":"https://chasing1020.github.io/post/akf-availability-cube/AKF-Cube_hue62ac97e307d13c6c7d5ffce8f17b997_58080_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/akf-availability-cube/","title":"AKF Availability Cube"},{"content":"Gorm Source Code 1. sql.DB 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 // driverConn wraps a driver.Conn with a mutex, to // be held during all calls into the Conn. (including any calls onto // interfaces returned via that Conn, such as calls on Tx, Stmt, // Result, Rows) type driverConn struct { db *DB createdAt time.Time sync.Mutex // guards following ci driver.Conn needReset bool // The connection session should be reset before use if true. closed bool finalClosed bool // ci.Close has been called openStmt map[*driverStmt]bool // guarded by db.mu inUse bool returnedAt time.Time // Time the connection was created or returned. onPut []func() // code (with db.mu held) run when conn is next returned dbmuClosed bool // same as closed, but guarded by db.mu, for removeClosedStmtLocked } sql.DBæ•°æ®ç»“æ„å¯¹æ•°æ®åº“åšäº†ä¸€å±‚ç®€å•çš„æŠ½è±¡ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡®çš„æ˜¯ï¼šsql.DBä¸æ˜¯ä¸€ä¸ªè¿æ¥ï¼Œä¹Ÿä¸æ˜¯æ˜ å°„åˆ°ä»»ä½•DataBaseæˆ–è€…æ˜¯Schemaçš„æ¦‚å¿µã€‚\nsql.DBå¯ä»¥æ‰§è¡Œä¸€ç³»åˆ—é‡è¦çš„ä»»åŠ¡ï¼šåŒ…æ‹¬ä½¿ç”¨é©±åŠ¨æ‰“å¼€å’Œå…³é—­å®é™…åº•å±‚æ•°æ®åº“çš„è¿æ¥ï¼›é€šè¿‡ç®¡ç†è¿æ¥æ± ï¼Œæ¶‰åŠç›¸å…³çš„äº‹åŠ¡ã€‚\nè¿™ä¸ªæ•°æ®ç»“æ„è®¾è®¡ä¸ºé•¿æœŸå­˜åœ¨çš„ï¼Œä¸åº”è¯¥ç»å¸¸æ€§åœ°æ–°å»ºæˆ–è€…æ˜¯åˆ é™¤ã€‚\nåœ¨Gormä¸­ï¼Œå°†DBç±»å‹å’ŒSessionç±»å‹è¿›è¡Œäº†å°è£…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // DB GORM DB definition type DB struct { *Config Error error RowsAffected int64 Statement *Statement clone int } // Session session config when create session with Session() method type Session struct { // ... Context context.Context Logger logger.Interface NowFunc func() time.Time CreateBatchSize int } å…¶ä¸­æ•°æ®åº“å¯¹è±¡æ”¾ç½®åœ¨Statementä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Statement statement type Statement struct { *DB TableExpr *clause.Expr Table string Model interface{} Unscoped bool Dest interface{} ReflectValue reflect.Value Clauses map[string]clause.Clause // ... ConnPool ConnPool Schema *schema.Schema Context context.Context // ... } 2. Parse å¯¹äºä¸€èˆ¬æ•°æ®å¯¹è±¡ï¼Œæ¶‰åŠå¯¹è¡¨çš„è½¬æ¢ï¼Œä¸€èˆ¬éœ€è¦è¿™ä¸ªå¯¹è±¡æä¾›ä¿¡æ¯ï¼š\nåŒ…æ‹¬è¡¨ååˆ°ç»“æ„ä½“åã€å­—æ®µåå’Œå­—æ®µç±»å‹ã€é¢å¤–çš„çº¦æŸæ¡ä»¶ï¼ˆéç©ºï¼Œè‡ªå¢ç­‰ç­‰ï¼‰\nåœ¨schema/field.goä¸‹é¢ï¼Œè®¾è®¡äº†Fieldç»“æ„ä½“ï¼Œä¸»è¦éƒ¨åˆ†å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 type Field struct { Name string DBName string BindNames []string DataType DataType GORMDataType DataType // ... FieldType reflect.Type Tag reflect.StructTag // ... } å¯¹åº”reflectåŒ…ä¸‹çš„Tagæ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // A StructTag is the tag string in a struct field. // // By convention, tag strings are a concatenation of // optionally space-separated key:\u0026#34;value\u0026#34; pairs. // Each key is a non-empty string consisting of non-control // characters other than space (U+0020 \u0026#39; \u0026#39;), quote (U+0022 \u0026#39;\u0026#34;\u0026#39;), // and colon (U+003A \u0026#39;:\u0026#39;). Each value is quoted using U+0022 \u0026#39;\u0026#34;\u0026#39; // characters and Go string literal syntax. type StructTag string // Get returns the value associated with key in the tag string. // If there is no such key in the tag, Get returns the empty string. // If the tag does not have the conventional format, the value // returned by Get is unspecified. To determine whether a tag is // explicitly set to the empty string, use Lookup. func (tag StructTag) Get(key string) string { v, _ := tag.Lookup(key) return v } åœ¨å¯¹æ•°æ®ç±»å‹è¿›è¡Œè§£ææ—¶ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹çš„æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func (schema *Schema) ParseField(fieldStruct reflect.StructField) *Field { // ... // default value is function or null or blank (primary keys) field.DefaultValue = strings.TrimSpace(field.DefaultValue) skipParseDefaultValue := strings.Contains(field.DefaultValue, \u0026#34;(\u0026#34;) \u0026amp;\u0026amp; strings.Contains(field.DefaultValue, \u0026#34;)\u0026#34;) || strings.ToLower(field.DefaultValue) == \u0026#34;null\u0026#34; || field.DefaultValue == \u0026#34;\u0026#34; switch reflect.Indirect(fieldValue).Kind() { case reflect.Bool: field.DataType = Bool if field.HasDefaultValue \u0026amp;\u0026amp; !skipParseDefaultValue { if field.DefaultValueInterface, err = strconv.ParseBool(field.DefaultValue); err != nil { schema.err = fmt.Errorf(\u0026#34;failed to parse %s as default value for bool, got error: %v\u0026#34;, field.DefaultValue, err) } } case reflect.Int, reflect.Int8, reflect.Int16, reflect.Int32, reflect.Int64: // case ... } } 3. Cause å¯¹äºå¤æ‚çš„SQLè¯­å¥ï¼Œä¸€èˆ¬æ˜¯ç”±å¤šä¸ªå­å¥ç»„åˆè€Œæˆï¼Œå¯¹äºæ¯ä¸€ä¸ªå­å¥ï¼ŒGormåšäº†ç®€å•çš„æŠ½è±¡ï¼Œå¹¶æŠŠå­å¥ç”Ÿæˆçš„è¿‡ç¨‹ç®€åŒ–ä¸ºBuildæ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 // Interface clause interface type Interface interface { Name() string Build(Builder) MergeClause(*Clause) } // Expression expression interface type Expression interface { Build(builder Builder) } // Builder builder interface type Builder interface { Writer WriteQuoted(field interface{}) AddVar(Writer, ...interface{}) } // Clause type Clause struct { Name string // WHERE BeforeExpression Expression AfterNameExpression Expression AfterExpression Expression Expression Expression Builder ClauseBuilder } å…¶ä¸­ï¼ŒBuilderå‡½æ•°è¿”å›æ˜¯Gormé“¾å¼æ“ä½œçš„æ ¸å¿ƒã€‚\n3.1. Select å¯¹äºæŸ¥è¯¢éƒ¨åˆ†ï¼Œé¦–å…ˆå®šä¹‰äº†æŸ¥è¯¢çš„éƒ¨åˆ†å†…å®¹ï¼Œå°†é»˜è®¤çš„æŸ¥è¯¢å†…å®¹ç”¨é€—å·åˆ†éš”ã€å»é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 package clause // Select select attrs when querying, updating, creating type Select struct { Distinct bool Columns []Column Expression Expression } func (s Select) Name() string { return \u0026#34;SELECT\u0026#34; } func (s Select) Build(builder Builder) { if len(s.Columns) \u0026gt; 0 { if s.Distinct { builder.WriteString(\u0026#34;DISTINCT \u0026#34;) } for idx, column := range s.Columns { if idx \u0026gt; 0 { builder.WriteByte(\u0026#39;,\u0026#39;) } builder.WriteQuoted(column) } } else { builder.WriteByte(\u0026#39;*\u0026#39;) } } func (s Select) MergeClause(clause *Clause) { if s.Expression != nil { if s.Distinct { if expr, ok := s.Expression.(Expr); ok { expr.SQL = \u0026#34;DISTINCT \u0026#34; + expr.SQL clause.Expression = expr return } } clause.Expression = s.Expression } else { clause.Expression = s } } // CommaExpression represents a group of expressions separated by commas. type CommaExpression struct { Exprs []Expression } func (comma CommaExpression) Build(builder Builder) { for idx, expr := range comma.Exprs { if idx \u0026gt; 0 { _, _ = builder.WriteString(\u0026#34;, \u0026#34;) } expr.Build(builder) } } 3.2. From é‡‡ç”¨åˆ†ç±»æ–¹å¼ï¼Œè€ƒè™‘SQL92å’ŒSQL99è¯­æ³•ä¸Šçš„å·®å¼‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package clause // From from clause type From struct { Tables []Table Joins []Join } // Name from clause name func (from From) Name() string { return \u0026#34;FROM\u0026#34; } // Build build from clause func (from From) Build(builder Builder) { if len(from.Tables) \u0026gt; 0 { for idx, table := range from.Tables { if idx \u0026gt; 0 { builder.WriteByte(\u0026#39;,\u0026#39;) } builder.WriteQuoted(table) } } else { builder.WriteQuoted(currentTable) } for _, join := range from.Joins { builder.WriteByte(\u0026#39; \u0026#39;) join.Build(builder) } } // MergeClause merge from clause func (from From) MergeClause(clause *Clause) { clause.Expression = from } 3.3. Where åˆ¤å®šå¤šç§æ•°æ®çš„ç»“æ„è¿›è¡Œåˆå¹¶æ“ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 func (not NotConditions) Build(builder Builder) { if len(not.Exprs) \u0026gt; 1 { builder.WriteByte(\u0026#39;(\u0026#39;) } for idx, c := range not.Exprs { if idx \u0026gt; 0 { builder.WriteString(\u0026#34; AND \u0026#34;) } if negationBuilder, ok := c.(NegationExpressionBuilder); ok { negationBuilder.NegationBuild(builder) } else { builder.WriteString(\u0026#34;NOT \u0026#34;) e, wrapInParentheses := c.(Expr) if wrapInParentheses { sql := strings.ToLower(e.SQL) if wrapInParentheses = strings.Contains(sql, \u0026#34;and\u0026#34;) || strings.Contains(sql, \u0026#34;or\u0026#34;); wrapInParentheses { builder.WriteByte(\u0026#39;(\u0026#39;) } } c.Build(builder) if wrapInParentheses { builder.WriteByte(\u0026#39;)\u0026#39;) } } } if len(not.Exprs) \u0026gt; 1 { builder.WriteByte(\u0026#39;)\u0026#39;) } } åç»­ä¸€ç³»åˆ—æ“ä½œä¸æ­¤ç±»ä¼¼ï¼Œåœ¨æ­¤ä¸å†ä¸€ä¸€åˆ—å‡ºã€‚\n4. Hooks åˆ©ç”¨æ¥å£å®ç°ï¼Œåœ¨æ‰§è¡Œå¯¹åº”æ“ä½œæ—¶ï¼Œä¼šå…ˆè¿›è¡Œç›¸å…³çš„æ£€æŸ¥æ“ä½œï¼Œå®ç°è¾ƒä¸ºç®€å•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func BeforeCreate(db *gorm.DB) { if db.Error == nil \u0026amp;\u0026amp; db.Statement.Schema != nil \u0026amp;\u0026amp; !db.Statement.SkipHooks \u0026amp;\u0026amp; (db.Statement.Schema.BeforeSave || db.Statement.Schema.BeforeCreate) { callMethod(db, func(value interface{}, tx *gorm.DB) (called bool) { if db.Statement.Schema.BeforeSave { if i, ok := value.(BeforeSaveInterface); ok { called = true db.AddError(i.BeforeSave(tx)) } } if db.Statement.Schema.BeforeCreate { if i, ok := value.(BeforeCreateInterface); ok { called = true db.AddError(i.BeforeCreate(tx)) } } return called }) } } 5. Transaction Gormé‡‡ç”¨çš„ç­–ç•¥æ˜¯ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåˆ¤æ–­DBå¯¹è±¡çš„errä¿¡æ¯ï¼Œä¸ä¸ºç©ºåˆ™è¿”å›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func BeginTransaction(db *gorm.DB) { if !db.Config.SkipDefaultTransaction \u0026amp;\u0026amp; db.Error == nil { if tx := db.Begin(); tx.Error == nil { db.Statement.ConnPool = tx.Statement.ConnPool db.InstanceSet(\u0026#34;gorm:started_transaction\u0026#34;, true) } else if tx.Error == gorm.ErrInvalidTransaction { tx.Error = nil } else { db.Error = tx.Error } } } func CommitOrRollbackTransaction(db *gorm.DB) { if !db.Config.SkipDefaultTransaction { if _, ok := db.InstanceGet(\u0026#34;gorm:started_transaction\u0026#34;); ok { if db.Error != nil { db.Rollback() } else { db.Commit() } db.Statement.ConnPool = db.ConnPool } } } å®é™…ä¸Šè¿˜å¯ä»¥é‡‡ç”¨ä¸€ç§æ¯”è¾ƒä¼˜é›…çš„è®¾è®¡å®ç°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func (s Service) DoSomething() (err error) { tx, err := s.db.Begin() if err != nil { return } defer func() { if err != nil { tx.Rollback() return } if r := recover(); r != nil { tx.Rollback() } err = tx.Commit() }() if _, err = tx.Exec(...); err != nil { return } if _, err = tx.Exec(...); err != nil { return } // ... return } è¿™é‡Œå¯ä»¥å¯¹æ¯”Javaçš„JDBCæ“ä½œï¼Œé‡‡ç”¨trycatchå®ç°å›æ»šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Test public void testUpdateWithTx() { Connection conn = null; try { //1.è·å–è¿æ¥çš„æ“ä½œï¼ˆ //â‘  æ‰‹å†™çš„è¿æ¥ï¼šJDBCUtils.getConnection(); //â‘¡ ä½¿ç”¨æ•°æ®åº“è¿æ¥æ± ï¼šC3P0;DBCP;Druid //2.å¯¹æ•°æ®è¡¨è¿›è¡Œä¸€ç³»åˆ—CRUDæ“ä½œ //â‘  ä½¿ç”¨PreparedStatementå®ç°é€šç”¨çš„å¢åˆ æ”¹ã€æŸ¥è¯¢æ“ä½œï¼ˆversion 1.0 \\ version 2.0) //version2.0çš„å¢åˆ æ”¹public void update(Connection conn,String sql,Object ... args){} //version2.0çš„æŸ¥è¯¢ public \u0026lt;T\u0026gt; T getInstance(Connection conn,Class\u0026lt;T\u0026gt; clazz,String sql,Object ... args){} //â‘¡ ä½¿ç”¨dbutilsæä¾›çš„jaråŒ…ä¸­æä¾›çš„QueryRunnerç±» //æäº¤æ•°æ® conn.commit(); } catch (Exception e) { e.printStackTrace(); try { //å›æ»šæ•°æ® conn.rollback(); } catch (SQLException e1) { e1.printStackTrace(); } }finally{ //3.å…³é—­è¿æ¥ç­‰æ“ä½œ //â‘  JDBCUtils.closeResource(); //â‘¡ ä½¿ç”¨dbutilsæä¾›çš„jaråŒ…ä¸­æä¾›çš„DbUtilsç±»æä¾›äº†å…³é—­çš„ç›¸å…³æ“ä½œ } } ","date":"2021-12-22T18:24:56+08:00","image":"https://chasing1020.github.io/post/gorm-source-code/gorm_huf43c23aaba4e097a63ec0037d5296908_43864_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/gorm-source-code/","title":"Gorm Source Code"},{"content":"1. Implements volatileï¼šå£°æ˜åæ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„æ”¹å˜é‡çš„å€¼æ˜¯ä¸€æ ·çš„ã€‚å†™æ“ä½œæ—¶ï¼Œä¼šæ·»åŠ Lockå‰ç¼€çš„æ±‡ç¼–ã€‚\nä¿è¯äº†1. ä¿è¯ç¼“å­˜è¡Œçš„æ•°æ®å†™å›å†…å­˜ï¼›2. å†™å›çš„æ“ä½œä¼šä½¿å…¶ä»–ç¼“å­˜å¤±æ•ˆã€‚\nsynchronizedï¼šæ™®é€šçš„æ–¹æ³•ï¼Œé”æ˜¯å®ä¾‹ï¼›é™æ€åŒæ­¥æ–¹æ³•ï¼Œé”æ˜¯Classï¼›åŒæ­¥æ–¹æ³•å—ï¼Œé”æ˜¯æ‹¬å·é‡Œçš„å¯¹è±¡ã€‚\né”ä¿å­˜åœ¨å¯¹è±¡å¤´ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œåˆ™ç”¨ä¸‰ä¸ªå­—å®½ä¿å­˜å¯¹è±¡å¤´ï¼Œéæ•°ç»„åˆ™ç”¨ä¸¤ä¸ªè‡ªå®½ä¿å­˜å¯¹è±¡å¤´ã€‚\né•¿åº¦ å†…å®¹ è¯´æ˜ 32bit/64bit Mark Word å­˜å‚¨å¯¹è±¡çš„hashCodeæˆ–è€…æ˜¯é”ä¿¡æ¯ 32bit/64bit Class Metadata Address å­˜å‚¨åˆ°å¯¹è±¡ç±»å‹çš„æŒ‡é’ˆ 32bit/64bit Array Length æ•°ç»„çš„é•¿åº¦ï¼Œï¼ˆéæ•°ç»„æ— è¯¥å­—æ®µï¼‰ 32ä½ä¸‹å¯¹è±¡å¤´çš„å­˜å‚¨ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 |----------------------------------------------------------------------------------------|--------------------| | Object Header (64 bits) | State | |-------------------------------------------------------|--------------------------------|--------------------| | Mark Word (32 bits) | Klass Word (32 bits) | | |-------------------------------------------------------|--------------------------------|--------------------| | identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Normal | |-------------------------------------------------------|--------------------------------|--------------------| | thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Biased | |-------------------------------------------------------|--------------------------------|--------------------| | ptr_to_lock_record:30 | lock:2 | OOP to metadata object | Lightweight Locked | |-------------------------------------------------------|--------------------------------|--------------------| | ptr_to_heavyweight_monitor:30 | lock:2 | OOP to metadata object | Heavyweight Locked | |-------------------------------------------------------|--------------------------------|--------------------| | | lock:2 | OOP to metadata object | Marked for GC | |-------------------------------------------------------|--------------------------------|--------------------| é”çŠ¶æ€ 25bit 4bit 1bit 2bit çŠ¶æ€ å¯¹è±¡çš„hashCode å¯¹è±¡åˆ†ä»£å¹´é¾„ æ˜¯å¦æ˜¯åå‘é” é”æ ‡å¿—ä½ 64ä½ä¸‹å¯¹è±¡å¤´çš„å­˜å‚¨ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 |------------------------------------------------------------------------------------------------------------|--------------------| | Object Header (128 bits) | State | |------------------------------------------------------------------------------|-----------------------------|--------------------| | Mark Word (64 bits) | Klass Word (64 bits) | | |------------------------------------------------------------------------------|-----------------------------|--------------------| | unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Normal | |------------------------------------------------------------------------------|-----------------------------|--------------------| | thread:54 | epoch:2 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Biased | |------------------------------------------------------------------------------|-----------------------------|--------------------| | ptr_to_lock_record:62 | lock:2 | OOP to metadata object | Lightweight Locked | |------------------------------------------------------------------------------|-----------------------------|--------------------| | ptr_to_heavyweight_monitor:62 | lock:2 | OOP to metadata object | Heavyweight Locked | |------------------------------------------------------------------------------|-----------------------------|--------------------| | | lock:2 | OOP to metadata object | Marked for GC | |------------------------------------------------------------------------------|-----------------------------|--------------------| é”çŠ¶æ€ 25bit 31bit 1bit 4bit 1bit 2bit çŠ¶æ€ unused å¯¹è±¡çš„hashCode cms_free å¯¹è±¡åˆ†ä»£å¹´é¾„ æ˜¯å¦åå‘é” é”æ ‡å¿—ä½ å¯ä»¥è®¾ç½®å‚æ•°-XX:+UseCompressedOopsï¼Œæ¥è¿›è¡Œå‹ç¼©ï¼Œå‚è€ƒ32bitçš„PAEå®ç°ï¼Œå¯ä»¥ä½¿JVMçš„å†…å­˜è¶…è¿‡4Gï¼Œä½†ä¸è¶…è¿‡32Gï¼ˆè¶…è¿‡32Gï¼Œå¯ä»¥ä½¿ç”¨-XX:ObjectAlignmentInBytesï¼Œæ¥é™åˆ¶å‹ç¼©çš„å¤§å°ï¼Œå¦‚å½“å¯¹è±¡å¯¹é½ä¸º 16 å­—èŠ‚æ—¶ï¼Œæœ€å¤šå¯ä»¥ä½¿ç”¨ 64 GB çš„å †ç©ºé—´å’Œå‹ç¼©æŒ‡é’ˆï¼‰ï¼Œç»è¿‡å‹ç¼©åï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 |--------------------------------------------------------------------------------------------------------------|--------------------| | Object Header (96 bits) | State | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | Mark Word (64 bits) | Klass Word (32 bits) | | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | unused:25 | identity_hashcode:31 | cms_free:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Normal | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | thread:54 | epoch:2 | cms_free:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Biased | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | ptr_to_lock_record | lock:2 | OOP to metadata object | Lightweight Locked | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | ptr_to_heavyweight_monitor | lock:2 | OOP to metadata object | Heavyweight Locked | |--------------------------------------------------------------------------------|-----------------------------|--------------------| | | lock:2 | OOP to metadata object | Marked for GC | |--------------------------------------------------------------------------------|-----------------------------|--------------------| åå‘é”ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ²¡æœ‰é”ç«äº‰ï¼Œåå‘é”åœ¨ç­‰åˆ°ç«äº‰æ—¶æ‰ä¼šé‡Šæ”¾é”ã€‚æœ‰ç«äº‰æ—¶ ï¼Œä¼šåœ¨å…¨å±€å®‰å…¨ç‚¹æ’¤é”€åå‘é”ã€‚\nä½¿ç”¨-XX:BiasedeLoackingStartupDelay=0ï¼Œå¦‚æœå¤§å¤šæ•°é”å¤„äºç«äº‰çŠ¶æ€ï¼Œå¯ä»¥ä½¿ç”¨-XX:UseBiasedLocking=falseå…³é—­ï¼Œè¿™æ ·ç¨‹åºä¼šé»˜è®¤è¿›å…¥è½»é‡çº§é”çš„çŠ¶æ€ã€‚\nè½»é‡çº§é”ï¼šä½¿ç”¨CASæ“ä½œMark Wordï¼Œå¦‚æœæˆåŠŸï¼Œå°±è·å¾—é”ï¼›é‡Šæ”¾æ—¶ï¼ŒCASå¦‚æœå¤±è´¥ï¼Œå°±å‡çº§åˆ°é‡é‡çº§é”ã€‚\né‡é‡çº§é”ï¼šåœ¨è¿™ä¸ªçŠ¶æ€ä¸‹ï¼Œæ‰€æœ‰è·å–é”çš„æ“ä½œéƒ½ä¼šè¢«é˜»å¡ï¼ŒæŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾åä¼šå”¤é†’è¿™äº›çº¿ç¨‹ã€‚\né” ä¼˜ç‚¹ ç¼ºç‚¹ åœºæ™¯ åå‘é” åŠ é”ä¸ç”¨é¢å¤–æ¶ˆè€—ï¼Œæ•ˆç‡æ¥è¿‘éåŒæ­¥æ–¹æ³• å¦‚æœæœ‰é”ç«äº‰ï¼Œä¼šå¸¦æ¥æ’¤é”€æ¶ˆè€— åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®çš„åœºæ™¯ è½»é‡çº§é” çº¿ç¨‹ä¸ä¼šé˜»å¡ï¼Œæé«˜ç›¸åº”é€Ÿåº¦ å¾—ä¸åˆ°é”ç«äº‰çš„çº¿ç¨‹ä¼šè‡ªæ—‹æ¶ˆè€—CPU è¿½æ±‚å“åº”æ—¶é—´ï¼Œæ‰§è¡Œé€Ÿåº¦å¿« é‡é‡çº§é” çº¿ç¨‹ç«äº‰ä¸ç”¨è‡ªæ—‹ï¼Œä¸ä¼šæ¶ˆè€—CPU çº¿ç¨‹é˜»å¡ï¼Œå“åº”æ—¶é—´ç¼“æ…¢ è¿½æ±‚ååé‡ï¼ŒåŒæ­¥å—æ‰§è¡Œé€Ÿåº¦è¾ƒé•¿ ABAé—®é¢˜è§£å†³ï¼šé‡‡ç”¨AtomicStampedReferenceæ¥è§£å†³ï¼Œåˆ¤æ–­æ˜¯å¦æ—¶ç­‰äºé¢„æœŸå¼•ç”¨å’Œé¢„æœŸæ ‡å¿—ï¼Œä¸¤ä¸ªéƒ½æˆåŠŸåˆ™è®¾ç½®ã€‚\n2. Memory Model ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’åºï¼šä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®‰æ’é¡ºåºã€‚\næŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºï¼šæŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼‰ï¼Œå¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¯ä»¥æ”¹å˜æŒ‡ä»¤æ‰§è¡Œçš„é¡ºåºã€‚\nå†…å­˜ç³»ç»Ÿçš„é‡æ’åºï¼šè¯»/å†™ç¼“å†²åŒºï¼Œä½¿å¾—è¯»å†™æ“ä½œå¯èƒ½çš„ä¹±åºã€‚\nå±éšœç±»å‹ï¼šLoadLoadBarriersï¼ŒStoreStoreBarriersï¼ŒLoadStoreBarriersï¼ŒStoreLoadBarriers\nå…¶ä¸­StoreLoadBarriersæ‹¥æœ‰å…¶ä»–ä¸‰ä¸ªå±éšœçš„æ•ˆæœï¼Œä½œä¸ºå…¨èƒ½å‹å±éšœã€‚è¿™ä¸ªå±éšœå¼€é”€æ˜‚è´µï¼Œéœ€è¦å°†å†™ç¼“å†²çš„æ•°æ®å…¨éƒ¨åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚\nJDK5å¼€å§‹ï¼Œé‡‡ç”¨JSR133åŸåˆ™ï¼Œä½¿ç”¨happens-beforeæ¥è§£é‡Šå†…å­˜çš„å¯è§æ€§ï¼š\nç¨‹åºé¡ºåºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œï¼Œhappens-beforeäºåè¾¹çš„æ“ä½œ ç›‘è§†å™¨é”è§„åˆ™ï¼šè§£é”æ“ä½œhappens-beforeäºä¸Šé”æ“ä½œ volatileå˜é‡è§„åˆ™ï¼šå¯¹volatileä¿®é¥°å˜é‡çš„å†™æ“ä½œï¼Œhappens-beforeäºè¯»æ“ä½œ ä¼ é€’æ€§ï¼šA happens-before Bï¼ŒB happens-before Cï¼Œåˆ™æœ‰A happens-before C æ•°æ®ä¾èµ–æ€§ï¼šå¯¹åŒä¸€ä¸ªå˜é‡çš„å†™å†™ï¼Œå†™è¯»ï¼Œè¯»å†™æ“ä½œï¼Œå­˜åœ¨æ•°æ®ä¾èµ–ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šéµå®ˆæ•°æ®ä¾èµ–æ€§ã€‚\nas-if-serialï¼šæ’åºç»“æœä¸èƒ½å½±å“æœ¬æ¥çš„æ‰§è¡Œç»“æœã€‚ç¼–è¯‘å™¨ï¼Œruntimeï¼Œå¤„ç†å™¨éƒ½ä¼šéµå®ˆã€‚\nJMMä¸ä¿è¯å¯¹64ä½çš„longå’Œdoubleç±»å‹çš„å†™æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œä¼šæŠŠ64ä½çš„å†™æ“ä½œæ‹†æˆä¸¤ä¸ª32ä½çš„æ“ä½œï¼Œè™½ç„¶è¿™è¿åäº†é¡ºåºä¸€è‡´æ€§æ¨¡å‹ã€‚\nvolatileçš„å†™æ“ä½œå‰é¢åŠ StoreStoreå±éšœï¼Œåé¢åŠ StoreLoadå±éšœï¼›\nvolatileçš„å†™æ“ä½œåé¢åŠ LoadLoadå±éšœï¼Œåé¢åŠ LoadStoreå±éšœã€‚ç¼–è¯‘å™¨èƒ½å¤Ÿé€šè¿‡å…·ä½“æƒ…å†µçœç•¥ä¸å¿…è¦çš„å±éšœã€‚\nJavaåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizerã€‚\nfinalåŸŸä¿è¯æ„é€ å‡½æ•°å†…çš„finalåŸŸçš„å†™å…¥å’Œå¼•ç”¨èµ‹å€¼ç»™å¦ä¸€ä¸ªå¼•ç”¨å˜é‡è¿™ä¸ªæ“ä½œä¸å¯ä»¥é‡æ’åºï¼›ç¬¬ä¸€æ¬¡è¯»finalåŸŸå¯¹è±¡çš„å¼•ç”¨å’Œè¯»å–finalåŸŸä¸­çš„æ“ä½œä¸èƒ½é‡æ’åºã€‚\næ„é€ å‡½æ•°finalåŸŸçš„å†™æ“ä½œï¼Œåœ¨returnå‰ï¼Œä¼šæ’å…¥StoreStoreå±éšœï¼Œè¯»finalåŸŸå‰ä¼šåŠ ä¸ŠLoadLoadå±éšœï¼Œç¦æ­¢finalçš„å†™æ“ä½œé‡æ’åºåˆ°æ„é€ å‡½æ•°ä¹‹å¤–ã€‚ä¿è¯äº†finalè¯»å–åˆ°çš„å€¼ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚\nåŒé‡é”æ£€æŸ¥çš„æœºåˆ¶instance = new Instance();å®é™…ä¸Šä¼šè¢«æ‹†æˆä¸‰è¡Œä¼ªä»£ç ï¼Œåœ¨2ï¼Œ3ä¹‹é—´ä¼šå¯èƒ½å‘ç”Ÿé‡æ’åºã€‚\n1 2 3 memory = allocate(); // 1. åˆ†é…å¯¹è±¡çš„å†…å­˜ç©ºé—´ ctorInstance(memory); // 2. åˆå§‹åŒ–å¯¹è±¡ï¼Œå®Œæˆåinstance != null instance = memory; // 3. è®¾ç½®instanceæŒ‡å‘åˆšåˆ†é…çš„å†…å­˜åœ°å€ å›é¡¾ç±»åŠ è½½çš„æ—¶æœºï¼šåŠ è½½ï¼ˆé€šè¿‡å…¨é™å®šåè·å–äºŒè¿›åˆ¶å­—èŠ‚æµï¼Œè½¬åŒ–ä¸ºæ–¹æ³•åŒºè¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œç”Ÿæˆjava.lang.Classå¯¹è±¡ï¼‰ï¼ŒéªŒè¯ï¼ˆæ–‡ä»¶æ ¼å¼ï¼Œå…ƒæ•°æ®ï¼Œå­—èŠ‚ç ï¼Œç¬¦å·å¼•ç”¨ï¼‰ï¼Œå‡†å¤‡ï¼ˆæ­£å¼åˆ†é…å†…å­˜å¹¶ä¸”åˆå§‹åŒ–å€¼ï¼Œå¯¹åº”ä¸Šè¿°ä»£ç çš„1ï¼Œ2æ­¥éª¤ï¼‰ï¼Œè§£æï¼ˆå°†å¸¸é‡æ± çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼›ç¬¦å·å¼•ç”¨å°±æ˜¯ä¸€ç»„ç¬¦å·æ¥æè¿°ç›®æ ‡ï¼Œå¯ä»¥æ˜¯ä»»ä½•å­—é¢é‡ã€‚ç›´æ¥å¼•ç”¨å°±æ˜¯ç›´æ¥æŒ‡å‘ç›®æ ‡çš„æŒ‡é’ˆã€ç›¸å¯¹åç§»é‡æˆ–ä¸€ä¸ªé—´æ¥å®šä½åˆ°ç›®æ ‡çš„å¥æŸ„ã€‚ï¼‰ï¼Œåˆå§‹åŒ–ï¼ˆåˆå§‹åŒ–é˜¶æ®µæ˜¯æ‰§è¡Œåˆå§‹åŒ–æ–¹æ³• \u0026lt;clinit\u0026gt; ()æ–¹æ³•çš„è¿‡ç¨‹ï¼Œå¯¹é™æ€å˜é‡/ä»£ç å—è¿›è¡Œåˆå§‹åŒ–ï¼Œä¼šä¿è¯å¤šçº¿ç¨‹å®‰å…¨æ€§ï¼‰ï¼Œä½¿ç”¨ï¼Œå¸è½½ã€‚\nä½¿ç”¨volatileåï¼Œå¯ä»¥é˜²æ­¢2ï¼Œ3ä¹‹é—´çš„é‡æ’åºã€‚\n3. Basic suspend(), resume(), stop()æ ‡è®°ä¸ºdeprecatedï¼Œè°ƒç”¨åä¸ä¸€å®šä¼šé‡Šæ”¾å æœ‰çš„èµ„æºã€‚\nä½¿ç”¨wait(), notify(), notifyAll()ä¹‹å‰éœ€è¦å¯¹è°ƒç”¨å¯¹è±¡åŠ é”ã€‚\nç®¡é“è¾“å…¥è¾“å‡ºæµï¼Œè¾“å‡ºä¸è¾“å…¥è¿›è¡Œç»‘å®š\n4. Lock AbstractQueuedSynchronizeré€šè¿‡å†…ç½®çš„FIFOæ¥å®ç°èµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚\nå½“å‰çº¿ç¨‹ä¿¡æ¯å’Œç­‰å¾…çŠ¶æ€æ„é€ æˆä¸€ä¸ªç»“ç‚¹ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼ŒåŒæ—¶é˜»å¡çº¿ç¨‹ã€‚åŒæ­¥çŠ¶æ€é‡Šæ”¾æ—¶ï¼Œé¦–ç»“ç‚¹ä¸­çš„çº¿ç¨‹å°†ä¼šè¢«å”¤é†’ã€‚åœ¨å°¾éƒ¨åŠ å…¥æ—¶ï¼Œé‡‡ç”¨CASåˆ¤æ–­æ’å…¥åˆ°â€œåº”è¯¥æ’å…¥çš„ä½ç½®â€ã€‚\nacquire(int arg)è·å–åŒæ­¥çŠ¶æ€ï¼Œå¯¹ä¸­æ–­ä¸æ•æ„Ÿã€‚è¯»acquiredSharedè·å–å…±äº«å¼çš„åŒæ­¥çŠ¶æ€ã€‚\né‡å…¥é”åœ¨è·å–næ¬¡ï¼Œå¹¶é‡Šæ”¾næ¬¡åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ï¼Œé»˜è®¤éå…¬å¹³ï¼Œé€šè¿‡ç»„åˆè‡ªå®šä¹‰åŒæ­¥å™¨æ¥å®ç°é”çš„è·å–ä¸é‡Šæ”¾ã€‚\nè¯»å†™é”ï¼Œå†™çŠ¶æ€ä½S\u0026amp;0x0000FFFFï¼Œè¯»çŠ¶æ€ä¸ºS\u0026raquo;\u0026gt;16ï¼Œå†™é”ç›¸å½“äºä¸€ä¸ªæ”¯æŒé‡è¿›å…¥çš„æ’ä»–é”ã€‚\n","date":"2021-12-05T14:16:11+08:00","image":"https://chasing1020.github.io/post/concurrency-programming/philosophers_hu135b0dfdb273b3f01121dcaaaebb65d0_49918_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/concurrency-programming/","title":"Concurrency Programming"},{"content":"As of the time I am writing this post, I have been studying computer science for a year and a half. I have started to organize and share my own computer science related study materials and routes.\nThe courses in this schedule are not a substitute for college courses, but they can help you further your studies in computer science, or build an initial understanding of the field.\nIn some ways, this route can be more of a substitute for college courses outside of class, as a required course to become an industry technician.\nOur industry is different from other industries in that you may simply need a laptop, a good learning environment, or you may also need a good body, and you need more than anything else a solid and unrelenting state of mind to explore. What you also need is how you can stand out among the many people at the level of thinking, which is the key.\nSo with this article, I hope this article can make you have a clearer learning plan and can take less detours, and this article is also a reminiscence of my undergraduate computer learning journey.\n1. The Lesson We\u0026rsquo;re Missing For me personally, this chapter is almost all from the potholes I have stepped in, and the turns I took when I was lost. From another point of view, this is also to become a computer technology personnel must be a mandatory course or a necessary literacy.\nHow To Ask Questions The Smart Way: You don\u0026rsquo;t have to be technically proficient to get our attention, but you must demonstrate the traits that lead you to become proficient: resourceful, thoughtful, observant, and willing to take the initiative to solve problems. Academic Integrity: Honesty is the foundation of good academic work. Whether you are working on a problem set, lab report, project or paper, avoid engaging in plagiarism, unauthorized collaboration, cheating, or facilitating academic dishonesty. The Missing Semester of Your CS Education: Classes teach you all about advanced topics within CS, from operating systems to machine learning, but thereâ€™s one critical subject thatâ€™s rarely covered, and is instead left to students to figure out on their own: proficiency with their tools. Crash Course Computer Science(Youtube Link): This is one of the few videos I\u0026rsquo;ve watched more than twice, and although it\u0026rsquo;s a documentary on computer science, I guarantee it\u0026rsquo;s more effective than any general education class in school. carrie Anne is an excellent teacher, and the curriculum is designed to cover almost all areas of computing, from history to applications to the future, covering a wide range of knowledge. 2. Computer Systems Course: Intro to Computer Systems: It is known as a course study site for the must-read book ã€ŠCSAPPã€‹. NJU-projectn: The computer system fundamentals course lab at Nanjing University is very helpful for personal improvement after completion. Write Great Code: Volume 1: Understanding the Machine: This book explains the underlying mechanics of how a computer works. What Every Programmer Should Know About Memory: A paper by Red Hat, Inc. It explains the structure of memory subsystems in use on modern commodity hardware, illustrating why CPU caches were developed, how they work, and what programs should do to achieve optimal performance by utilizing them. 3. Data Structure ã€ŠData Structures and Algorithmsã€‹: As a class note, the books are not very extensive, but they are also all very concise and can be used as a table of contents for study. MIT\u0026rsquo;s Course Introduction To Algorithms 3rd Edition: This course provides an introduction to mathematical modeling of computational problems. It covers the common algorithms, algorithmic paradigms, and data structures used to solve these problems. The course emphasizes the relationship between algorithms and programming, and introduces basic performance measures and analysis techniques for these problems. ã€ŠIntroduction To Algorithms 3rd Editionã€‹: It can be counted as the bible of algorithm books, which covers very comprehensive knowledge points and is relatively difficult, requiring a lot of time and patience. In contrast, I would recommend reading the following book. ã€ŠAlgorithhms 4th Edition by Robert Sedgewick, Kevin Wayne.pdfã€‹: A classic book on algorithms written in Java language, with moderate difficulty and rich corresponding illustrations, is more suitable for reading. CS 61B Data structures: A course about data structures and programming methods about Java. 4. Computer Network ã€ŠComputer Networking A Top Down Approach 7thã€‹: A classic computer networking book, but the latest version has been updated with more changes. UMASS Computer Networking PowerPoint: Of the book ã€ŠComputer Networking A Top Down Approachã€‹ teaching resources courseware, very unfortunately, is the eighth edition, currently the appropriate version on the network is only the seventh edition. USTC\u0026rsquo;s Computer Networking Course: The \u0026ldquo;Computer Networks\u0026rdquo; mooc is the recorded version of the undergraduate course of the Department of Automation of the University of Science and Technology in autumn 2020. On the basis of the introduction of computer network architecture, top-down, the Internet as an example systematically describes the main services, working principles, common technologies and protocols of each level of the network architecture. Mr. Zheng\u0026rsquo;s level is very high and the quality of lecture is excellent. ã€ŠTCP/IP Illustrated, Volume 1 The Protocolsã€‹: As a top-down, advanced version of the book, it is more difficult, but I think parts of it can be skimmed. 5. Operating System Operating Systems: Three Easy Pieces: One of the best OS textbooks in the world, including the most basic OS content teaching. I highly recommend reading the original English version of this book, because the Chinese translation is really bad. NJU\u0026rsquo;s Operating Systems Course: The companion online course of OSTEP, which was made public by Jiang Yanyan of Nanjing University during the epidemic, is of very high lecture quality and can give a good realistic perspective and a good research direction. Supporting course website jyywiki. ã€ŠModern Operating Systems: Principle and Implementationã€‹: The textbook published by Shanghai Jiao Tong University is a joint effort by a team of teachers from Shanghai Jiao Tong University and one of the few quality textbooks in China. Most of the implementations are based on the Arm platform, and the content is very well developed, with a wide coverage of what is taught, as well as the accompanying Lab. I think the quality of this book is going to be due to Modern Operating Systems. ã€ŠVbird Linux Basicã€‹ : It can be used as reference material, in fact, the main thing is to really install and practice application in project development, do not memorize commands, use more will naturally remember. The main way to learn is to really install a Linux distribution and then use it. ã€ŠLinux Inslidesã€‹: A book-in-progress about the linux kernel and its insides. It can be done to supplement the above teaching content. 6. Data Base Systems ã€ŠDatabase System Concepts 7th Editionã€‹: Database system concept, can be said to be a very complete and systematic database books, although some of the content is a bit old, but still can be used as a modern database learning textbook. Because the sixth edition of the textbook has been very old, here is more recommended to use the seventh edition of the textbook. This book website: Link CMU\u0026rsquo;s Course Database Systems: I think this is the best quality database online course, the teaching materials provided are very well made. However, the more difficult point is the experimental part, which can be learned on demand according to your level. 7. Compilers ã€Šcompilers principles techniques and toolsã€‹: Known as the \u0026ldquo;Dragon Book\u0026rdquo; of compilation principles books, it is recommended to patiently watch online classes little by little to break through, and this may be the only book I recommend reading the Chinese version, because the difficulty is too great. ã€ŠWriting An Interpreter In Goã€‹: Interpreter written in Go language, which can be used as a supplementary reading material. ","date":"2021-11-28T23:35:55+08:00","image":"https://chasing1020.github.io/post/my-cs-learning-route/Dunning_hu7e9c870d2fcd00ef46b2bd8203d1a11e_21576_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/my-cs-learning-route/","title":"My CS Learning Route"},{"content":"SHUè®¡ç®—æœºå­¦é™¢èµ„æ–™æ•´ç† å¡«å®ŒåŸ‹äº†å¾ˆä¹…çš„å‘ï¼Œè¡¥å…¨äº†è®¡ç®—æœºå­¦é™¢ç›¸å…³çš„èµ„æ–™ã€‚\næœ¬æ–‡ä»…åŒ…å«ç›¸å…³ç”µå­ä¹¦ï¼Œå·²å…¬å¼€çš„å†å¹´è¯•å·ç­‰èµ„æºã€‚ æœ¬æ–‡ä¸å«ä»»ä½•æ•™å¸ˆçš„ä¸ªäººè¯¾ä»¶ï¼Œå­¦é•¿çš„å†å²ä»£ç ï¼Œä½œä¸šï¼ŒæŠ¥å‘Šç­‰æ•æ„Ÿå†…å®¹ã€‚ æœ¬æ–‡æ‰€åˆ†äº«çš„æ‰€æœ‰èµ„æ–™ï¼Œä»…ä¾›ä¸Šæµ·å¤§å­¦è®¡ç®—æœºå­¦é™¢å­¦ç”Ÿå­¦ä¹ ä¸äº¤æµä½¿ç”¨ã€‚ æœ¬æ–‡çš„èµ„æ–™ä»…ä¾›å‚è€ƒï¼Œè¯·è‡ªå·±åˆ¤æ–­å…¶é€‚ç”¨æ€§ã€‚ æœ¬æ–‡ä¸€äº›æ–‡ä»¶å¦‚ä¾µçŠ¯äº†æ‚¨çš„æƒç›Šï¼Œè¯·å‘æˆ‘é‚®ä»¶ï¼Œæˆ‘ä¼šåŠæ—¶å½»åº•æ¸…é™¤è¿™äº›æ–‡ä»¶ã€‚ æœ¬æ–‡è®¸å¯ï¼šCC-BY-NC-SAï¼šç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«\næ–‡ç« ç‰ˆæƒå½’ä¸ªäººæ‰€æœ‰ï¼Œæœªç»ä½œè€…æˆæƒç¦æ­¢è½¬è½½ï¼ˆæˆ–æ³¨æ˜å‡ºå¤„ï¼‰ï¼Œä¸å¾—å°†å…¶ä¸­çš„èµ„æ–™ç”¨ä½œä»»ä½•å•†ä¸šç”¨é€”ã€‚\nå¦‚æœ‰ä¸ªäººè¡¥å……èµ„æ–™ï¼Œæ¬¢è¿å‰å¾€å¼€æºç¤¾åŒºé¡¹ç›®libshuæäº¤PRï¼Œå¯¼èˆª: https://github.com/shuosc/libshu\n1. é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ OOPå†å¹´è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1UPVNIDUHoBK6N3x6w5vnTw\næå–ç : 4hd3\n2. è®¡ç®—æœºç»„æˆåŸç†ï¼ˆ1-2ï¼‰ å› ä¸ºèµ„æ–™å¤ªå°‘ï¼Œå°±ä¸åˆ†äº†\né“¾æ¥: https://pan.baidu.com/s/1Lk_a0IezoaA0clFS_kQYJA\næå–ç : l76i\n3. æ•°æ®ç»“æ„ï¼ˆ1ï¼‰ è¯¾æœ¬ã€è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1qzMa3rjZtvj04E3je7Ib3g\næå–ç : nb4r\n4. æ•°æ®ç»“æ„ï¼ˆ2ï¼‰ è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1cMfku5w90jgycaN4iGl8VQ\næå–ç : agec\n5. ç¦»æ•£æ•°å­¦ï¼ˆ1ï¼‰ è¯¾æœ¬ã€è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1BRzkz8_Mj6SyubMH_wwZLQ\næå–ç : ff8j\n6. ç¦»æ•£æ•°å­¦ï¼ˆ2ï¼‰ è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1TzXBu5PT2f16FNwEclg9Qg\næå–ç : kes0\n7. æ¦‚ç‡è®ºä¸æ•°ç†ç»Ÿè®¡ è¯•å·éå¸¸å…¨\né“¾æ¥: https://pan.baidu.com/s/1OiB_NtoXdcsWuaqWYBK0zQ\næå–ç : mmb2\n8. æ“ä½œç³»ç»Ÿ è¯¾æœ¬\né“¾æ¥: https://pan.baidu.com/s/1jvjSzjeZKArY7-xxipWA7A\næå–ç : ohbe\n9. ç¼–ç ç†è®º è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1A2wrYHBKOC34bBA0twL8Bw\næå–ç : apm4\n10. è½¯ä»¶å·¥ç¨‹ è¯¾æœ¬ã€è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1SyvWYF6S32vai9Zmfd3veg\næå–ç : frp1\n11. ç¼–è¯‘åŸç† è¯¾æœ¬ã€è¯•å·\né“¾æ¥: https://pan.baidu.com/s/1BBfrcxm8s9MEczF7Bbqhqw\næå–ç : rgl3\n*. é™„å½• å‚è€ƒé“¾æ¥ï¼š\næ¸…åå¤§å­¦è®¡ç®—æœºç³»è¯¾ç¨‹æ”»ç•¥: https://github.com/PKUanonym/REKCARC-TSC-UHT\næµ™æ±Ÿå¤§å­¦è¯¾ç¨‹æ”»ç•¥å…±äº«è®¡åˆ’: https://qsctech.github.io/zju-icicles/\nä¸Šæµ·äº¤é€šå¤§å­¦è¯¾ç¨‹èµ„æ–™åˆ†äº«: https://github.com/c-hj/SJTU-Courses\næŒ–å‘: My Computer Learning Route (WIP)\n","date":"2021-11-27T14:25:59+08:00","image":"https://chasing1020.github.io/post/ces-materials/material_hu4783a9fa510b9a24914cdcd138fe363a_51364_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/ces-materials/","title":"CES Materials"},{"content":"Reference Book: Database System Concepts Seventh Edition\n1. Relational Model Readings: Chapters 1-2, 6\nDefinition\nDataBase: Organized collection of inter-related data that models some aspect of the real-world. Databases are the core component of most computer applications.\nA database management system (DBMS) is software that allows applications to store and analyze information in a database. A general-purpose DBMS is designed to allow the definition, creation, querying, update, and administration of databases.\nData Model: is a collection of concepts for describing the data in a database. Schema: is a description of a particular collection of data, using a given data model.\nKinds of DataModels\nType Description Relational Most DBMSs K-V, Graph, Document, Column-family NoSQL Array / Matrix Machine Learning Hierarchical, Network, Multi-Value Obsolete / Legacy / Rare Relational Model\nStructure: The definition of the database\u0026rsquo;s relations and their contents. Integrity: Ensure the database\u0026rsquo;s contents satisfy constraints. Manipulation: Programming interface for accessing and modifying a database\u0026rsquo;s contents.\nA relationis an unordered set that contain the relationship of attributes that represent entities.\nA relation\u0026rsquo;s primary keyuniquely identifies a single tuple.\nforeign keyspecifies that an attribute from one relation has to map to a tuple in another relation.\nData Manipulation Languages\nMethods to store and retrieve information from a database.\nProcedural: (Relational Algebra)\nThe query specifies the (high-level) strategythe DBMS should use to find the desired result. Non-Procedural (Declarative): (Relational Calculus)\nThe query specifies only what data is wanted and not how to find it. Relational Algebra\nSymbol Operation Description Ïƒ Select Choose a subset of the tuples from a relation that satisfies a selection predicate. Ï€ Projection Generate a relation with tuples that contains only the specified attributes. â‹ƒ Union Generate a relation that contains all tuples that appear in either only one or both input relations. â‹‚ Intersection Generate a relation that contains only the tuples that appear in both of the inputrelations. - Difference Generate a relation that contains only the tuples that appear in the first and not the second of the input relations. Ã— Product Generate a relation that contains all possible combinations of tuples from the input relations. â‹ˆ Join Generate a relation that contains all tuples that are a combination of two tuples (one from each input relation) with a common value(s) for one or more attributes. Extra Operations:\nRename (Ï), Assignment (Râ†S), Duplicate Elimination (Î´), Aggregation (Î³), Sorting (Ï„), Division (RÃ·S).\nThe relational model is independent of any query language implementation. SQL is the de facto standard (many dialects).\n2. Advanced SQL Readings: Chapters 3-5\nSQL Standard\nANSI Standard in 1986. ISO in 1987. Structured Query Language\nSQL:2016: JSON, Polymorphic tables\nSQL:2011: Temporal DBs, Pipelined DML\nSQL:2008: Truncation, Fancy Sorting\nSQL:2003: XML, Windows, Sequences, Auto-Gen IDs.\nSQL:1999: Regex, Triggers, OO\nData Manipulation Language (DML): SELECT, INSERT, UPDATE, and DELETE statements.\nData Definition Language (DDL): Schema definitions for tables, indexes, views, and other objects.\nData Control Language (DCL): Security, access controls.\nImportant: SQL is based on bags(duplicates) not sets(no duplicates). Aggregates\nFunctions that return a single value from a bag of tuples. Aggregate functions can (almost) only be used in the SELECT output list.\nAVG(col): Return the average col value.\nMIN(col): Return minimum col value.\nMAX(col): Return maximum col value.\nSUM(col): Return sum of values in col.\nCOUNT(col): Return # of values for col.\nGroup by\nProject tuples into subsets and calculate aggregates againsteach subset.\nNon-aggregated values in SELECT output clause must appear in GROUPBY clause.\nFilters results based on aggregation computation. Like a WHERE clause for a GROUPBY.\nString / Date / Time Operations\nString Case String Quotes SQL-92 Sensitive SingleOnly Postgres Sensitive SingleOnly MySQL Insensitive Single/Double SQLite Sensitive Single/Double DB2 Sensitive SingleOnly Oracle Sensitive Single Only LIKE is used for string matching. String-matching operators.\n\u0026lsquo;%\u0026rsquo; Matches any substring (including empty strings). \u0026lsquo;_\u0026rsquo; Match any one character.\nSQL-92 defines string functions, whereas many DBMSs also have their own unique functions.\nSQL standard says to use || operator to concatenate two or more strings together.\nOperations to manipulate and modify DATE/TIME attributes.\nCan be used in both output and predicates.\nOutput Redirection\nStore query results in another table: 1.Table must not already be defined. 2.Table will have the same # of columns with the same types as the input.\nInsert tuples from query into another table:\nInner SELECT must generate the same columns as the target table.\nDBMSs have different options/syntax on what to do with integrity violations (e.g., invalid duplicates).\nOutput Control\nOrder the output tuples by the values in one or more of their columns.\nLimit the # of tuples returned in output. Can set an offset to return a \u0026ldquo;range\u0026rdquo;\nNested Queries\nQueries containing other queries.\nThey are often difficult to optimize.\nInner queries can appear (almost) anywhere in query.\nALL: Must satisfy expression for all rows in the sub-query.\nANY: Must satisfy expression for at least one row in the sub-query.\nIN: Equivalent to \u0026lsquo;=ANY()\u0026rsquo; .\nEXISTS: At least one row is returned.\nWindow functions\nPerforms a \u0026ldquo;sliding\u0026rdquo; calculation across a set of tuples that are related.\nLike an aggregation but tuples are not grouped into a single output tuples.\n3. DataBase Storage (1) Readings: Chapter 10.1-10.2, 10.5-10.6\nStorage\nVolatile Devices: (CPU Registers, CPU Caches, DRAM)\nVolatile means that if you pull the power from the machine, then the data is lost. Volatile storage supports fast random access with byte-addressable locations. This means that the program can jump to any byte address and get the data that is there. For our purposes, we will always refer to this storage class as \u0026ldquo;memory.\u0026rdquo; Non-Volatile Devices: (SSD, HDD, Network Storage)\nNon-volatile means that the storage device does not require continuous power in order for the device to retain the bits that it is storing. It is also block/page addressable. This means that in order to read a value at a particular offset, the program first has to load the 4 KB page into memory that holds the value the program wants to read. Non-volatile storage is traditionally better at sequential access (reading multiple contiguous chunks of data at the same time). We will refer to this as \u0026ldquo;disk\u0026rdquo;. We will not make a (major) distinction between solid-state storage (SSD) and spinning hard drives (HDD). The DBMS assumes that the primary storage location of the database is on non-volatile disk.\nThe DBMS\u0026rsquo;s components manage the movement of data between non-volatile and volatile storage.\nRandom access on non-volatile storage is usually much slower than sequential access. So DBMS will want to maximize sequential access.\nAlgorithms try to reduce number of writes to random pages so that data is stored in contiguous blocks.\nAllocating multiple pages at the same time is called an extent.\nDBMS vs OS\nIt is possible to use the OS by using mmap. Regarding correctness and performance reasons, mmap hits a page fault, the process will be blocked:\nYou never want to use mmap in your DBMS if you need to write.\nThe DBMS (almost) always wants to control things itself and can do a better job at it since it knows more about the data being accessed and the queries being processed.\nIt is possible to use the OS by using:\nmadvise: Tells the OS know when you are planning on reading certain pages. mlock: Tells the OS to not swap memory ranges out to disk. msync: Tells the OS to flush memory ranges out to disk. Why not use the OS? DBMS (almost) always wants to control things itself and can do a better job than the OS.\nFlushing dirty pages to disk in the correct order.\nSpecialized prefetching.\nBuffer replacement policy.\nThread/process scheduling.\nStorage Manager\nThe DBMSâ€™s storage manager is responsible for managing a databaseâ€™s files. It represents the files as a collection of pages. It also keeps track of what data has been read and written to pages as well how much free space there is in these pages.\nDataBase Pages\nThe DBMS organizes the database across one or more files in fixed-size blocks of data called pages.\nPages can contain different kinds of data (tuples, indexes, etc).\nMost systems will not mix these types within pages.\nSome systems will require that pages are self-contained, meaning that all the information needed to read each page is on the page itself.\nEach page is given a unique identifier. If the database is a single file, then the page id can just be the file offset. Most DBMSs have an indirection layer that maps a page id to a file path and offset. The upper levels of the system will ask for a specific page number. Then, the storage manager will have to turn that page number into a file and an offset to find the page.\nMost DBMSs uses fixed-size pages to avoid the engineering overhead needed to support variable-sized pages. For example, with variable-size pages, deleting a page could create a hole in files that the DBMS cannot easily fill with new pages. There are three concepts of pages in DBMS:\nHardware page (usually 4 KB). OS page (4 KB). Database page (0.5-16 KB). (4KB: SqLite, DB2, Oracle; 8KB: SQL Server, PostgreSQL; 16KB: MySQL) The storage device guarantees an atomic write of the size of the hardware page.\nA hardware page is the largest block of data that the storage device can guarantee failsafe writes. So if the hardware page is 4 KB and the system tries to write 4 KB to the disk, either all 4 KB will be written, or none of it will.\nThis means that if our database page is larger than our hardware page, the DBMS will have to take extra measures to ensure that the data gets written out safely since the program can get partway through writing a database page to disk when the system crashes.\nExample: MySQL Doublewrite Buffer: The doublewrite buffer is a storage area where InnoDB writes pages flushed from the buffer pool before writing the pages to their proper positions in the InnoDB data files. If there is an operating system, storage subsystem, or unexpected mysqld process exit in the middle of a page write, InnoDB can find a good copy of the page from the doublewrite buffer during crash recovery.\nAlthough data is written twice, the doublewrite buffer does not require twice as much I/O overhead or twice as many I/O operations. Data is written to the doublewrite buffer in a large sequential chunk, with a single fsync() call to the operating system\nDataBase Heap\nA heap file is an unordered collection of pages with tuples that are stored in random order.\nCreate / Get / Write / Delete Page\nMust also support iterating over all pages.\nMaintain a header page at the beginning of the file that stores two pointers: HEAD of the free page list and the data page list.\nEach page keeps track of how many free slots they currently have.\nThe DBMS maintains special pages that tracks the location of data pages in the database files. The directory also records the number of free slots per page. Must make sure that the directory pages are in sync with the data pages.\nPage Layout\nEvery page contains a header of meta-data about the page\u0026rsquo;s contents. Page Size, Checksum, DBMS Version, Transaction Visibility, Compression Information.\nThe most common layout scheme is called slotted pages. The slot array maps \u0026ldquo;slots\u0026rdquo; to the tuples\u0026rsquo; starting position offsets. The header keeps track of: 1. The # of used slots 2. The offset of the starting location of the last slot used.\nEach tuple is assigned a unique record identifier. Most common: page_id+ offset/slot, Can also contain file location info.\nEach tuple is prefixed with a header that contains meta-data about it. Visibility info (concurrency control), Bit Map for NULL values.\nDBMS can physically denormalize (e.g., \u0026ldquo;pre join\u0026rdquo;) related tuples and store them together in the same page.\n4. DataBase Storage (2) Readings: Chapter 10.5-10.8\nData Represtentation\nInstead of storing tuples in pages, the DBMS only stores log records.\nThe system appends log records to the file of how the database was modified:\nInserts store the entire tuple.\nDeletes mark the tuple as deleted.\nUpdates contain the delta of just the attributes that were modified.\nTo read a record, the DBMS scans the log backwards and \u0026ldquo;recreates\u0026rdquo; the tuple to find what it needs. Build indexes to allow it to jump to locations in the log. And periodically compact the log.\nCompaction coalesces larger log files into smaller files by removing unnecessary records.\nNumeric data types with (potentially) arbitrary precision and scale. Used when rounding errors. Many different implementations. Example: NUMERIC, DECIMAL\nExample: Store in an exact, variable-length binary representation with additional meta-data.\nCan be less expensive if you give up arbitrary precision.\nMost DBMSs don\u0026rsquo;t allow a tuple to exceed the size of a single page.\nTo store values that are larger than a page, the DBMS uses separate overflow storage pages.\nPostgres: TOAST (\u0026gt;2KB)\nMySQL: Overflow (\u0026gt;1/2 size of page)\nSQL Server: Overflow (\u0026gt;size of page)\nSome systems allow you to store a really largevalue in an external file.Treated as a BLOB type.\nOracle: BFILE data type\nMicrosoft: FILESTREAM data type\nThe DBMS can not manipulate the contents of an external file. No durability protections. No transaction protections.\nSystem Catalogs\nA DBMS stores meta-data about databases in its internal catalogs.\nTables, columns, indexes, views; Users, permissions; Internal statistics Almost every DBMS stores the database\u0026rsquo;s catalog inside itself (i.e., as tables). You can query the DBMSâ€™s internal INFORMATION_SCHEMA catalog to get info about the database.\nANSI standard set of read-only views that provide info about all the tables, views, columns, and procedures in a database DataBase WorkLoads\nOn-Line Transaction Processing (OLTP):\nFast operations that only read/update a small amount of data each time.\nSimple queries that read/update a small amount of data that is related to a single entity in the database.\nThis is usually the kind of application that people build first.\nOn-Line Analytical Processing (OLAP):\nComplex queries that read a lot of data to compute aggregates.\nComplex queries that read large portions of the database spanning multiple entities.\nHybrid Transaction + Analytical Processing: OLTP + OLAP together on the same database instance\nIdeal for OLTP workloads where queries tend to operate only on an individual entity and insert-heavy workloads.\nThe relational model does not specify that we have to store all of a tuple\u0026rsquo;s attributes together in a single page.\nN-ARY Storage Model\nThe DBMS can store tuples in different ways that are better for either OLTP or OLAP workloads.\nWe have been assuming the n-ary storage model(aka \u0026ldquo;row storage\u0026rdquo;) so far this semester.\nExample: MySQL, PostgreSQL\nAdvantages\nFast inserts, updates, and deletes.\nGood for queries that need the entire tuple.\nDisadvantages\nNot good for scanning large portions of the table and/or a subset of the attributes. Ideal for OLAP workloads where read-only queries perform large scans over a subset of the tableâ€™s attributes.\nDecomposition Storage Model\nThe DBMS stores the values of a single attribute for all tuples contiguously in a page(aka \u0026ldquo;column store\u0026rdquo;).\nIdeal for OLAP workloads where read-only queries perform large scans over a subset of the tableâ€™s attributes.\nAdvantages\nReduces the amount wasted I/O because the DBMS only reads the data that it needs.\nBetter query processing and data compression (more on this later).\nDisadvantages\nSlow for point queries, inserts, updates, and deletes because of tuple splitting/stitching. Conclusion\nIt is important to choose the right storage model for the target workload:\nOLTP = Row Store\nOLAP = Column Store\n5. Buffer Pools Readings: Chapter 10.5-10.8\nMeta Data\nMemory region organized as an array of fixed-size pages.An array entry is called a frame.\nWhen the DBMS requests a page, an exact copy is placed into one of these frames.\nThe page table keeps track of pages that are currently in memory.\nAlso maintains additional meta-data per page:\nDirty Flag, 2. Pin/Reference Counter Locks and Latches\nLocks:\nProtects the database\u0026rsquo;s logical contents from other transactions.\nHeld for transaction duration.\nNeed to be able to rollback changes.\nLatches:\nProtects the critical sections of the DBMS\u0026rsquo;s internal data structure from other threads.\nHeld for operation duration.\nDo not need to be able to rollback changes.\nPage directory\nThe page directory is the mapping from page ids to page locations in the database files.\nAll changes must be recorded on disk to allow the DBMS to find on restart. The page table is the mapping from page ids to a copy of the page in buffer pool frames.\nThis is an in-memory data structure that does not need to be stored on disk. Global Policies:\nMake decisions for all active transactions. Local Policies:\nAllocate frames to a specific transactions without considering the behavior of concurrent transactions s.\nStill need to support sharing pages.\nBuffer Pool Optimizations\nThe DBMS does not always have a single buffer pool for the entire system.\nMultiple buffer pool instances\nPer-database buffer pool\nPer-page type buffer pool\nHelps reduce latch contention and improve locality.\nEmbed an object identifier in record ids and then maintain a mapping from objects to specific buffer pools.\nHash the page id to select whichbuffer pool to access.\nPrefetching\nThe DBMS can also prefetch pages based on a query plan.\nSequential Scans, 2. Index Scans Scan Sharing\nQueries can reuse data retrieved from storage or operator computations.\nAlso called synchronized scans.\nThis is different from result caching.\nAllow multiple queries to attach to a single cursor that scans a table.\nQueries do not have to be the same.\nCan also share intermediate results.\nIf a query wants to scan a table and another query is already doing this, then the DBMS will attach the second query\u0026rsquo;s cursor to the existing cursor.\nThe sequential scan operator will not store fetched pages in the buffer pool to avoid overhead.\nMemory is local to running query.\nWorks well if operator needs to read a large sequence of pages that are contiguous on disk.\nCan also be used for temporary data (sorting, joins).\nOS Page Caching\nMost disk operations go through the OS API.\nUnless you tell it not to, the OS maintains its own filesystem cache (i.e., the page cache).\nMost DBMSs use direct I/O (O_DIRECT) to bypass the OSâ€™s page cache.\nRedundant copies of pages.\nDifferent eviction policies.\nLoss of control over file I/O.\nBuffer Replacement Policies\nWhen the DBMS needs to free up a frame to make room for a new page, it must decide which page to evictfrom the buffer pool.\nGoals: Correctness, Accuracy, Speed, Meta-data overhead\nMaintain a single timestamp of when each page was last accessed.\nWhen the DBMS needs to evict a page, select the one with the oldest timestamp.\nKeep the pages in sorted order to reduce the search time on eviction. Approximation of LRU that does not need a separate timestamp per page.\nEach page has a reference bit.\nWhen a page is accessed, set to 1.\nOrganize the pages in a circular buffer with a \u0026ldquo;clock hand\u0026rdquo;:\nUpon sweeping, check if a page\u0026rsquo;s bit is set to 1.\nIf yes, set to zero. If no, then evict.\nProblems\nLRU and CLOCK replacement policies are susceptible to sequential flooding.\nA query performs a sequential scan that reads every page.\nThis pollutes the buffer pool with pages that are read once and then never again.\nIn some workloads the most recently used page is the most unneeded page.\nTrack the history of last Kreferences to each page as timestamps and compute the interval between subsequent accesses.\nThe DBMS then uses this history to estimate the next time that page is going to be accessed.\nLocalization\nThe DBMS chooses which pages to evict on a per transactions /query basis. This minimizes the pollution of the buffer pool from each query.\nKeep track of the pages that a query has accessed. Example: Postgres maintains a small ring buffer that is private to the query.\nThe DBMS knows about the context of each page during query execution.\nIt can provide hints to the buffer pool on whether a page is important or not.\nDiary Pages\nFAST: If a page in the buffer pool is notdirty, then the DBMS can simply \u0026ldquo;drop\u0026rdquo; it.\nSLOW: If a page is dirty, then the DBMS must write back to disk to ensure that its changes are persisted.\nTrade-off between fast evictions versus dirty writing pages that will not be read again in the future.\nOther Memory Pools\nThe DBMS needs memory for things other than just tuples and indexes.\nThese other memory pools may not always backed by disk. Depends on implementation.\nSorting + Join Buffers\nQuery Caches\nMaintenance Buffers\nLog Buffers\nDictionary Caches\n6. Hash Tables Readings: Chapter 11.6-11.7\nDefinition\nA hash table implements an unordered associative array that maps keys to values.\nIt uses a hash function to compute an offset into the array for a given key, from which the desired value can be found.\nSpace Complexity: O(n) Time Complexity:\nAverage: O(1)\nWorst: O(n)\nTo find an entry, mod the key by the number of elements to find the offset in the array.\nHash Function\nWe do not want to use a crypto graphic hash function for DBMS hash tables.\nWe want something that is fast and has a low collision rate.\nName Usage CRC-64(1975) Used in networking for error detection. MurmurHash(2008) Designed as a fast, general-purpose hash function. Google CityHash(2011) Designed to be faster for short keys (\u0026lt;64 bytes). Facebook XXHash(2012) From the creator of zstdcompression. Google FarmHash(2014) Newer version of CityHashwith better collision rates. Static Hash Shemes\nLingering Probing Hashing Resolve collisions by linearly searching for the next free slot in the table.\nTo determine whether an element is present, hash to a location in the index and scan for it.\nMust store the key in the index to know when to stop scanning.\nInsertions and deletions are generalizations of lookups.\nRobin Hood Hashing Variant of linear probe hashing that steals slots from \u0026ldquo;rich\u0026rdquo; keys and give them to \u0026ldquo;poor\u0026rdquo; keys.\nEach key tracks the number of positions they are from where its optimal position in the table.\nOn insert, a key takes the slot of another key if the first key is farther away from its optimal position than the second key.\n1 2 3 4 5 6 7 8 9 iterator find(const FindKey\u0026amp; key) { size_t index = hash_policy.index_for_hash(hash_object(key), num_slots_minus_one); EntryPointer it = entries + ptrdiff_t(index); for (int8_t distance = 0; it-\u0026gt;distance_from_desired \u0026gt;= distance; ++distance, ++it) { if (compares_equal(key, it-\u0026gt;value)) return {it}; } return end(); } Cuckoo Hasing Use multiple hash tables with different hash function seeds.\nOn insert, check every table and pick anyone that has a free slot.\nIf no table has a free slot, evict the element from one of them and then re-hash it find a new location.\nLook-ups and deletions are always O(1) because only one location per hash table is checked.\nDynamic hashing Shemes\nThe previous hash tables require the DBMS to know the number of elements it wants to store.\nOtherwise, it must rebuild the table if it needs to grow/shrink in size. Dynamic hash tables resize themselves on demand.\nChained Hashing Maintain a linked list of buckets for each slot in the hash table.\nResolve collisions by placing all elements with the same hash key into the same bucket.\nTo determine whether an element is present, hash to its bucket and scan for it.\nInsertions and deletions are generalizations of lookups.\nExtendible Hashing Chained-hashing approach where we split buckets instead of letting the linked list grow forever.\nMultiple slot locations can point to the same bucket chain.\nReshuffle bucket entries on split and increase the number of bits to examine.\nData movement is localized to just the split chain. Linear Hashing The hash table maintains a pointer that tracks the next bucket to split.\nWhen any bucket overflows, split the bucket at the pointer location. Use multiple hashes to find the right bucket for a given key.\nCan use different overflow criterion:\nSpace Utilization\nAverage Length of Overflow Chains\n7. Tree Indexes Readings: Chapter 11.1-11.4\nA table index is a replica of a subset of a table\u0026rsquo;s attributes that are organized and/or sorted for efficient access using those attributes.\nThe DBMS ensures that the contents of the table and the index are logically synchronized.\nThere is a trade-off regarding the number of indexes to create per database.\nStorage Overhead\nMaintenance Overhead\nPeople also use the term to generally refer to a class of balanced tree data structures:\nB-Tree(1971), B+Tree(1973), B*Tree(1977?), Blink-Tree(1981) A B+Tree is a self-balancing tree data structure that keeps data sorted and allows searches, sequential access, insertions, and deletions in O(log n).\nGeneralization of a binary search tree, since a node can have more than two children.\nOptimized for systems that read and write large blocks of data.\nB+ Tree Properties\nA B+Tree is an M-way search tree with the following properties:\nIt is perfectly balanced (i.e., every leaf node is at the same depth in the tree)\nEvery node other than the root is at least half-full M/2-1 â‰¤ #keys â‰¤ M-1\nEvery inner node with k keys has k+1 non-null children\nNodes\nEvery B+ Treenode is comprised of an array of key/value pairs.\nIt contains level, slots, previous, next, sorted keys and values.\nThe keys are derived from the attribute(s) that the index is based on.\nThe values will differ based on whether the node is classified as an inner node or a leaf node.\nThe arrays are (usually) kept in sorted key order.\nValues Approach:\nRecord IDs(Used: PostgreSQL, SQLServer, DB2, Oracle): A pointer to the location of the tuple to which the index entry corresponds. Tuple Data(Used: SQLite, SQLServer, MySQL, Oracle): The leaf nodes store the actual contents of the tuple. Secondary indexes must store the Record ID as their values. B Tree vs B+Tree\nThe original B-Tree from 1972 stored keys and values in all nodes in the tree.\nMore space-efficient, since each key only appears once in the tree. A B+Tree only stores values in leaf nodes. Inner nodes only guide the search process.\nB+Tree Insert\nFind correct leaf node L.Put data entry into Lin sorted order.\nIf L has enough space, done!\nOtherwise, split L keys into L and a new node L2\nRedistribute entries evenly, copy up middle key.\nInsert index entry pointing to L2 into parent of L.\nTo split inner node, redistribute entries evenly, but push up middle key.\nDuplicate Keys\nApproach #1: Append Record ID\nAdd the tuple\u0026rsquo;s unique Record ID as part of the key to ensure that all keys are unique.\nThe DBMS can still use partial keys to find tuples.\nApproach #2: Overflow Leaf Nodes\nAllow leaf nodes to spill into overflow nodes that contain the duplicate keys.\nThis is more complex to maintain and modify.\nB+Tree Delete\nStart at root, find leaf L where entry belongs. Remove the entry. If Lis at least half-full, done! If L has only M/2-1 entries, then:\nTry to re-distribute, borrowing from sibling (adjacent node with same parent as L).\nIf re-distribution fails, merge L and sibling.\nIf merge occurred, must delete entry (pointing to L or sibling) from parent of L.\nSome DBMSs do not always merge nodes when they are half full.\nDelaying a merge operation may reduce the amount of reorganization.\nIt may also be better to just let smaller nodes exist and then periodically rebuild entire tree.\nClustered Indexs\nThe table is stored in the sort order specified by the primary key.\nCan be either heap-or index-organized storage. Some DBMSs always use a clustered index.\nIf a table does not contain a primary key, the DBMS will automatically make a hidden primary key. Other DBMSs cannot use them at all.\nTraverse to the left-most leaf page and then retrieve tuples from all leaf pages.\nThis will always be better than external sorting.\nRetrieving tuples in the order they appear in a non-clustered index can be very inefficient.\nThe DBMS can first figure out all the tuples that it needs and then sort them based on their Page ID.\nNode Size\nThe slower the storage device, the larger the optimal node size for a B+Tree.\nHDD: ~1MB\nSSD: ~10KB\nIn-Memory: ~512B\nOptimal sizes can vary depending on the workload\nLeaf Node Scans vs. Root-to-Leaf Traversals. Merge Threshold\nSome DBMSs do not always merge nodes when they are half full.\nDelaying a merge operation may reduce the amount of reorganization.\nIt may also be better to just let smaller nodes exist and then periodically rebuild entire tree.\nOptimizations\nPerfix Compression Sorted keys in the same leaf node are likely to have the same prefix.\nInstead of storing the entire key each time, extract common prefix and store only unique suffix for each key.\nDeduplication Non-unique indexes can end up storing multiple copies of the same key in leaf nodes.\nThe leaf node can store the key once and then maintain a list of tuples with that key (similar to what we discussed for hash tables).\nBulk insert The fastest way to build a new B+Treefor an existing table is to first sort the keys and then build the index from the bottom up.\n8. Index Concurrency Control Readings: Chapter 15.10\nA concurrency control protocol is the method that the DBMS uses to ensure \u0026ldquo;correct\u0026rdquo; results for concurrent operations on a shared object.\nLocks Latches Separate User Transactions Threads Protect Database Contents In-Memory Data Structures During Entire Transactions Critical Sections Modes Shared,Exclusive, Update, Intention Read, Write Deadlock Detection \u0026amp; Resolution Avoidance by Waits-for, Timeout, Aborts Coding Discipline Keptin LockManager Protected Data Structure Latch Mode\nRead Mode\nMultiple threads can read the same object at the same time.\nA thread can acquire the read latch if another thread has it in read mode.\nWrite Mode\nOnly one thread can access the object.\nA thread cannot acquire a write latch if another thread has it in any mode.\nApproach\nBlocking OS Mutex Simple to use; Non-scalable (about 25ns per lock/unlock invocation);\nExample: std::mutex.\nReference: https://en.wikipedia.org/wiki/Futex\nTest-and-Set Spin Latch (TAS) Very efficient (single instruction to latch/unlatch); Non-scalable, not cache-friendly, not OS-friendly;\nExample: std::atomic\u0026lt;T\u0026gt;. \u0026ldquo;do not use spinlocks in user space, unless you actually know what you\u0026rsquo;re doing.\u0026rdquo;\nReader-Writer Latches Allows for concurrent readers; Must manage read/write queues to avoid starvation; Can be implemented on top of spin latches.\nHash Table Latch\nEasy to support concurrent access due to the limited ways threads access the data structure.\nAll threads move in the same direction and only access a single page/slot at a time.\nDeadlocks are not possible.\nTo resize the table, take a global write latch on the entire table (e.g., in the header page).\nApproach #1: Page Latches:\nEach page has its own reader-writer latch that protects its entire contents.\nThreads acquire either a read or write latch before they access a page.\nApproach #2: Slot Latches\nEach slot has its own latch.\nCan use a single-mode latch to reduce meta-data and computational overhead.\nAtomic instruction that compares contents of a memory location M to a given value V\nIf values are equal, installs new given value Vâ€™ in M\nOtherwise, operation fails\nB+ Tree Concurrency Control\nWe want to allow multiple threads to read and update a B+Treeat the same time.\nWe need to protect against two types of problems:\nThreads trying to modify the contents of a node at the same time.\nOne thread traversing the tree while another thread splits/merges nodes.\nProtocol to allow multiple threads to access/modify B+Treeat the same time.\nBasic Idea:\nGet latch for parent\nGet latch for child\nRelease latch for parent if \u0026ldquo;safe\u0026rdquo;\nA safe node is one that will not split or merge when updated.\nNot full (on insertion)\nMore than half-full (on deletion)\nFind: Start at root and go down; repeatedly,\nAcquire R latch on child\nThen unlatch parent\nInsert/Delete: Start at root and go down, obtaining W latches as needed. Once child is latched, check if it is safe:\nIf child is safe, release all latches on ancestors Better Latching Algorithm\nIt depends on it that most modifications to a B+ Tree will not require a split or merge.\nSearch: Same as before.\nInsert/Delete:\nSet latches as if for search, get to leaf, and set W latch on leaf.\nIf leaf is not safe, release all latches, and restart thread using previous insert/delete protocol with write latches.\nThis approach optimistically assumes that only leaf node will be modified; if not, R latches set on the first pass to leaf are wasteful.\nObservation\nThe threads in all the examples so far have acquired latches in a \u0026ldquo;top-down\u0026rdquo; manner.\nA thread can only acquire a latch from a node that is below its current node.\nIf the desired latch is unavailable, the thread must wait until it becomes available.\nLeaf Node Scans\nLatches do not support deadlock detection or avoidance. The only way we can deal with this problem is through coding discipline.\nThe leaf node sibling latch acquisition protocol must support a \u0026ldquo;no-wait\u0026rdquo; mode.\nThe DBMS\u0026rsquo;s data structures must cope with failed latch acquisitions.\n9. Sorting \u0026amp; Aggregations Readings: Chapter 12.4-12.5\nJust like it cannot assume that a table fits entirely in memory, a disk-oriented DBMS cannot assume that query results fit in memory.\nWe are going to rely on the buffer pool to implement algorithms that need to spill to disk.\nWe are also going to prefer algorithms that maximize the amount of sequential I/O.\nExternal Merge Sort\nDivide-and-conquer algorithm that splits data into separate runs, sorts them individually, and then combines them into longer sorted runs.\nSorting Sort chunks of data that fit in memory and then write back the sorted chunks to a file on disk. Merging Combine sorted runs into larger chunks. The DBMS has a finite number of B buffer pool pages to hold input and output data.\nSteps:\nRead all B pages of the table into memory;\nSort pages into runs and write them back to disk;\nRecursively merge pairs of runs into runs twice as long.\nUses three buffer pages (2 for input pages, 1 for output)\nIn each pass, we read and writeevery page in the file.\n$Number \\ of \\ passes \\ =\\ 1 + âŒˆ\\log_2NâŒ‰ $\n$Total\\ I/O\\ cost\\ =\\ 2N \\times (Nums \\ of\\ passes)$\nThis algorithm only requires three buffer pool pages to perform the sorting ($B=3$): Two input pages, one output page.\nBut even if we have more buffer space available ($B \u0026gt; 3$), it does not effectively utilize them if the worker must block on disk I/O. Although we can get the equation:\n$Number\\ of\\ passes\\ with\\ N\\ pages\\ and\\ B\\ buffer\\ pools\\ =\\ 1+âŒˆ\\log_B-1âŒˆN/ BâŒ‰âŒ‰$\nDouble Buffering Optimization\nPrefetch the next run in the background and store it in a second buffer while the system is processing the current run.\nReduces the wait time for I/O requests at each step by continuously utilizing the disk. B+ Trees for Sorting\nIf the table that must be sorted already has a B+Tree index on the sort attribute(s), then we can use that to accelerate sorting.\nRetrieve tuples in desired sort order by simply traversing the leaf pages of the tree.\nClustered B+ Tree Traverse to the left-most leaf page, and then retrieve tuples from all leaf pages.\nThis is always better than external sorting because there is no computational cost, and all disk access is sequential.\nUnclustered B+ Tree Chase each pointer to the page that contains the data.\nThis is almost always a bad idea. In general, one I/O per data record.\nAggregations\nCollapse values for a single attribute from multiple tuples into a single scalar value.\nWhat if we do not need the data to be ordered?\nForming groups in GROUPBY (no ordering)\nRemoving duplicates in DISTINCT (no ordering)\nHashing is a better alternative in this scenario.\nOnly need to remove duplicates, no need for ordering.\nCan be computationally cheaper than sorting.\nPopulate an ephemeral hash table as the DBMS scans the table. For each record, check whether there is already an entry in the hash table:\nDISTINCT: Discard duplicate\nGROUPBY: Perform aggregate computation\nExternal Hashing Aggregate\nPhase #1 Partition\nDivide tuples into buckets based on hash key\nWrite them out to disk when they get full\nPhase #2 ReHash\nBuild in-memory hash table for each partition and compute the aggregation Partition\nUse a hash function $h_1$ to split tuples into partitions on disk.\nA partition is one or more pages that contain the set of keys with the same hash value.\nPartitions are â€œspilledâ€ to disk via output buffers.\nAssume that we have B buffers.\nWe will use B-1 buffers for the partitions and 1 buffer for the input data.\nReHash\nFor each partition on disk:\nRead it into memory and build an in-memory hash table based on a second hash function $h_2$.\nThen go through each bucket of this hash table to bring together matching tuples.\nThis assumes that each partition fits in memory.\n10. Join Algorithms Readings: Chapter 12.4-12.6\nWe will focus on performing binary joins (two tables) using inner equi join algorithms.\nThese algorithms can be tweaked to support other joins.\nMulti-way joins exist primarily in research literature.\nIn general, we want the smaller table to always be the left table (\u0026ldquo;outer table\u0026rdquo;) in the query plan.\nDecision #1: Output\nWhat data does the join operator emit to its parent operator in the query plan tree? Decision #2: Cost Analysis Criteria\nHow do we determine whether one join algorithm is better than another? Subsequent operators in the query plan never need to go back to the base tables to get more data.\nMaterialization\nEarly Materialization:\nCopy the values for the attributes in outer and inner tuples into a new output tuple. Subsequent operators in the query plan never need to go back to the base tables to get more data.\nLate Materialization:\nOnly copy the joins keys along with the Record IDs of the matching tuples. Ideal for column stores because the DBMS does not copy data that is not needed for the query.\nAnalysis Criteria\nAssume:\nM pages in table R, m tuples in R\nN pages in table S, n tuples in S\nCost Metric: # of IOs to compute join\nWe will ignore output costs since that depends on the data and we cannot compute that yet.\n$R\\ â¨\\ S$ is the most common operation and thus must be carefully optimized.\n$R\\ \\times\\ S$ followed by a selection is inefficient because the cross-product is large.\nThere are many algorithms for reducing join cost, but no algorithm works well in all scenarios.\nNested Loop Join\nStupid: For every tuple in R, it scans Sonce Cost: $M + (m\\ \\times\\ N)$\nBlock Nested Loop Join: For every block in R, it scans S once. Cost: $M+(M\\ \\times\\ N)$\nIf we have B buffers available:\nUse B-2 buffers for scanning the outer table. Use one buffer for the inner table, one buffer for storing output. This algorithm uses B-2 buffers for scanning R. Cost: $M+ ( âŒˆM / (B-2) âŒ‰\\times N)$, if $B\u0026gt;M+2$, then will be $M+N$\nIndex Nested Join: Assume the cost of each index probe is some constant C per tuple. Cost: $M + (m \\times C)$ Sort Merge Join\nPhase #1: Sort\nSort both tables on the join key(s).\nWe can use the external merge sort algorithm that we talked about last class.\nPhase #2: Merge\nStep through the two sorted tables with cursors and emit matching tuples.\nMay need to backtrack depending on the join type.\nSort Cost (R): $2M \\times (1 + âŒˆ logB-1 âŒˆM/ BâŒ‰ âŒ‰)$ Sort Cost (S): $2N \\times (1 + âŒˆ logB-1 âŒˆN / BâŒ‰ âŒ‰)$ Merge Cost: $(M+ N)$ Total Cost: Sort + Merge\nThe worst case for the merging phase is when the join attribute of all the tuples in both relations contains the same value.\nThe input relations may be sorted either by an explicit sort operator, or by scanning the relation using an index on the join key.\nHash Join\nPhase #1: Build\nScan the outer relation and populate a hash table using the hash function h1 on the join attributes. Phase #2: Probe\nScan the inner relation and use h1 on each tuple to jump to a location in the hash table and find a matching tuple. Approach #1: Full Tuple\nAvoid having to retrieve the outer relation\u0026rsquo;s tuple contents on a match.\nTakes up more space in memory.\nApproach #2: Tuple Identifier\nCould be to either the base tables or the intermediate output from child operators in the query plan.\nIdeal for column stores because the DBMS does not fetch data from disk that it does not need.\nAlso better if join selectivity is low.\nOptimization: Create a Bloom Filterduring the build phase when the key is likely to not exist in the hash table.\nThreads check the filter before probing the hash table. This will be faster since the filter will fit in CPU caches.\nSometimes called (sideways information passing.)\nGrace Hash Join\nIf the buckets do not fit in memory, then use recursive partitioningto split the tables into chunks that will fit.\nBuild another hash table for $bucket_{R,i}$, using hash function $h_2$ (with $h_2â‰ h_1$). Then probe it for each tuple of the other table\u0026rsquo;s bucket at that level. Cost of hash join?\nAssume that we have enough buffers. Cost: $3(M+ N)$ Partitioning Phase:\nRead+Write both tables Cost: $2(M+N)$ Probing Phase:\nRead both tables $M+N$ Summary\nAlgorithm IO Cost Example Simple Nested Loop Join $M+(m\\times N)$ 1.3 hours Block Nested Loop Join $M+(M\\times N)$ 50 seconds Index Nested Loop Join $M+(M\\times C)$ Variable Sort-Merge Join $M+N+(sort\\ cost)$ 0.75 seconds Hash Join $3\\times(M+N)$ 0.45 seconds Hashing is almost always better than sorting for operator execution.\nCaveats:\nSorting is better on non-uniform data.\nSorting is better when result needs to be sorted.\n11. Query Execution (1) Readings: Chapter 12.1-12.3, 12.7\nIterator Model\nEach query plan operator implements a Next() function.\nOn each invocation, the operator returns either a single tuple or a null marker if there are no more tuples.\nThe operator implements a loop that calls Next() on its children to retrieve their tuples and then process them.\nAlso called Volcano or Pipeline Model.\nThis is used in almost every DBMS. Allows for tuple pipelining. Some operators must block until their children emit all their tuples.\nJoins, Subqueries, Order By Materialization Model\nEach operator processes its input all at once and then emits its output all at once.\nThe operator \u0026ldquo;materializes\u0026rdquo; its output as a single result.\nThe DBMS can push down hints (e.g., LIMIT) to avoid scanning too many tuples.\nCan send either a materialized row or a single column.\nThe output can be either whole tuples (NSM) or subsets of columns (DSM).\nBetter for OLTP workloads because queries only access a small number of tuples at a time.\nLower execution / coordination overhead.\nFewer function calls.\nNot good for OLAP queries with large intermediate results.\nVectorization Model\nLike the Iterator Model where each operator implements a Next() function, but:\nEach operator emits a batch of tuples instead of a single tuple.\nThe operator\u0026rsquo;s internal loop processes multiple tuples at a time.\nThe size of the batch can vary based on hardware or query properties.\nIdeal for OLAP queries because it greatly reduces the number of invocations per operator.\nAllows for operators to more easily use vectorized (SIMD) instructions to process batches of tuples.\nSequential Scan\nFor each page in the table:\nRetrieve it from the buffer pool.\nIterate over each tuple and check whether to include it.\nThe DBMS maintains an internal cursor that tracks the last page / slot it examined.\nThis is almost always the worst thing that the DBMS can do to execute a query.\nSequential Scan Optimizations: Prefetching, Buffer Pool Bypass, Parallelization, Heap Clustering, Zone Maps, Late Materialization.\nZone Maps: Pre-computed aggregates for the attribute values in a page. DBMS checks the zone map first to decide whether it wants to access the page.\nLate Materialization: DSM DBMSs can delay stitching together tuples until the upper parts of the query plan.\nIndex Scan\nThe DBMS picks an index to find the tuples that the query needs. Which index to use depends on:\nWhat attributes the index contains What attributes the query references The attribute\u0026rsquo;s value domains Predicate composition Whether the index has unique or non-unique keys Multi Index Scan\nSet intersection can be done with bitmaps, hash tables, or Bloom filters.\nOperators that modify the database (INSERT, UPDATE, DELETE) are responsible for checking constraints and updating indexes.\nUPDATE/DELETE:\nChild operators pass Record IDs for target tuples. Must keep track of previously seen tuples. INSERT:\nChoice #1: Materialize tuples inside of the operator.\nChoice #2: Operator inserts any tuple passed in from child operators.\nHalloween Problem: Anomaly where an update operation changes the physical location of a tuple, which causes a scan operator to visit the tuple multiple times.\nCan occur on clustered tables or index scans. First discoveredby IBM researchers while working on System R on Halloween day in 1976.\nExpression Evaluation\nThe DBMS represents a WHERE clause as an expression tree.\nThe nodes in the tree represent different expression types:\nComparisons (=, \u0026lt;, \u0026gt;, !=); Conjunction (AND), Disjunction (OR); Arithmetic Operators (+, -, *****, /, %); Constant Values; Tuple Attribute References.\nEvaluating predicates in this manner is slow.\nThe DBMS traverses the tree and for each node that it visits it must figure out what the operator needs to do.\nA better approach is to just evaluate the expression directly. (Think JIT compilation)\n12. Query Execution (2) Readings: Chapter 12.1-12.3, 12.7\nParallel DBMSs vs Distributed DBMSs\nDatabase is spread out across multiple resources to improve different aspects of the DBMS.\nAppears as a single logical database instance to the application, regardless of physical organization.\nSQL query for a single-resource DBMS should generate same result on a parallel or distributed DBMS. Parallel DBMSs\nResources are physically close to each other.\nResources communicate over high-speed interconnect.\nCommunication is assumed to be cheap and reliable.\nDistributed DBMSs\nResources can be far from each other.\nResources communicate using slow(er) interconnect.\nCommunication cost and problems cannot be ignored.\nProcess Model\nA DBMSâ€™s process model defines how the system is architected to support concurrent requests from a multi-user application.\nA worker is the DBMS component that is responsible for executing tasks on behalf of the client and returning the results.\nProcess per DBMS Worker Each worker is a separate OS process.\nRelies on OS scheduler. Use shared-memory for global data structures. A process crash doesnâ€™t take down entire system. Examples: IBM DB2, Postgres, Oracle Process Pool A worker uses any free process from the pool.\nStill relies on OS scheduler and shared memory. Bad for CPU cache locality. Examples: IBM DB2, Postgres (2015). Thread per DBMS Worker Single process with multiple worker threads.\nDBMS manages its own scheduling. May or may not use a dispatcher thread. Thread crash (may) kill the entire system. Examples: IBM DB2, MSSQL, MySQL, Oracle (2014). Advantages of a multi-threaded architecture:\nLess overhead per context switch. Do not have to manage shared memory. The thread per worker model does not mean that the DBMS supports intra-query parallelism. Inter- vs Intra- Query Parallelism\nInter-Query: Different queries are executed concurrently.\nIncreases throughput \u0026amp; reduces latency. Intra-Query: Execute the operations of a single query in parallel. Decreases latency for long-running queries. Improve overall performance by allowing multiple queries to execute simultaneously. If queries are read-only, then this requires little coordination between queries. If multiple queries are updating the database at the same time, then this is hard to do correctly.\nInter Query Parallelism\nImprove overall performance by allowing multiple queries to execute simultaneously.\nIf queries are read-only, then this requires little coordination between queries.\nIf multiple queries are updating the database at the same time, then this is hard to do correctlyâ€¦\nIntra Query Parallelism\nImprove the performance of a single query by executing its operators in parallel. Think of organization of operators in terms of a producer/consumer paradigm. There are parallel versions of every operator.\nCan either have multiple threads access centralized data structures or use partitioning to divide work up. Parallel Grace Hash Join: Use a separate worker to perform the join for each level of buckets for R and S after partitioning.\nIntra Operator(Horizontal)\nDecompose operators into independent fragments that perform the same function on different subsets of data.\nThe DBMS inserts an exchange operator into the query plan to coalesce/split results from multiple children/parent operators.\nExchange Operator has three types as follows:\nExchange Type #1 â€“Gather\nCombine the results from multiple workers into a single output stream. Exchange Type #2 â€“Distribute\nSplit a single input stream into multiple output streams. Exchange Type #3 â€“Repartition\nShuffle multiple input streams across multiple output streams. Inter Operator(Vertical)\nOperations are overlapped in order to pipeline data from one stage to the next without materialization.\nWorkers execute operators from different segments of a query plan at the same time.\nAlso called pipeline parallelism.\nBushy Parallelism\nHybrid of intra-and inter-operator parallelism where workers execute multiple operators from different segments of a query plan at the same time.\nStill need exchange operators to combine intermediate results from segments.\nObservation\nUsing additional processes/threads to execute queries in parallel won\u0026rsquo;t help if the disk is always the main bottleneck.\nIn fact, it can make things worse if each worker is working on different segments of the disk. I/O Parallelism\nConfigure OS/hardware to store the DBMS\u0026rsquo;s files across multiple storage devices.\nStorage Appliances, RAID Configuration This is transparent to the DBMS.\nDataBase Partition\nSome DBMSs allow you to specify the disk location of each individual database.\nThe buffer pool manager maps a page to a disk location. This is also easy to do at the filesystem level if the DBMS stores each database in a separate directory.\nThe DBMS recovery log file might still be shared if transactions can update multiple databases. Partitioning\nSplit single logical table into disjoint physical segments that are stored/managed separately.\nPartitioning should (ideally) be transparent to the application.\nThe application should only access logical tables and not have to worry about how things are physically stored. Vertical Partioning Store a tableâ€™s attributes in a separate location (e.g., file, disk volume).\nMust store tuple information to reconstruct the original record.\nHorizontal Partioning Divide table into disjoint segments based on some partitioning key. Hash Partitioning\nRange Partitioning\nPredicate Partitioning\n13. Optimization (1) Readings: Chapter 13\nRemember that SQL is declarative. User tells the DBMS what answer they want, not how to get the answer.\nFirst implementation of a query optimizer from the 1970s. People argued that the DBMS could never choose a query plan better than what a human could write.\nHeuristics / Rules\nRewrite the query to remove stupid / inefficient things.\nThese techniques may need to examine catalog, but they do notneed to examine data.\nCost-based Search\nUse a model to estimate the cost of executing a plan.\nEvaluate multiple equivalent plans for a query and pick the one with the lowest cost.\nLogical vs Physical Plans\nThe optimizer generates a mapping of a logical algebra expression to the optimal equivalent physical algebra expression.\nPhysical operators define a specific execution strategy using an access path.\nThey can depend on the physical format of the data that they process (i.e., sorting, compression).\nNot always a 1:1 mapping from logical to physical.\nRelational Algebra Equivalences\nTwo relational algebra expressions are equivalent if they generate the same set of tuples.\nThe DBMS can identify better query plans without a cost model.\nThis is often called query rewriting.\nPredicate Pushdown\nExample:\n1 2 3 4 SELECT s.name, e.cid FROM studnet AS s, enrolled AS e WHERE s.id = e.sid AND e.grade = \u0026#39;A\u0026#39; The algrbra expression is:\n$\\pi_{name,cid}(\\sigma_{grade=\u0026lsquo;A\u0026rsquo;}(studentâ‹ˆenrolled))$\nwhich is equal to the expression:\n$\\pi_{name,cid}(studentâ‹ˆ\\sigma_{grade={\u0026lsquo;A\u0026rsquo;}}(enrolled))$\nSelections Optimize:\nPerform filters as early as possible. Break a complex predicate, and push down:\n$\\sigma_{p1 \\wedge p2\\wedge \u0026hellip;\\wedge pn}(R)=\\sigma_{p1}(\\sigma_{p2}(\u0026hellip;\\sigma_{pn}(R)))$\nJoins Optimize:\n$Râ‹ˆS=Sâ‹ˆR, \\ (Râ‹ˆSâ‹ˆT) =Râ‹ˆ(Sâ‹ˆT)$\nThe number of different join orderings for an n-way join is a Catalan Number ($â‰ˆ4^n$)\nExhaustive enumeration will be too slow.\nProjections Optimize (Not important for a column store) :\nPerform them early to create smaller tuples and reduce intermediate results (if duplicates are eliminated) Project out all attributes except the ones requested or required (e.g., joining keys) Let\u0026rsquo;s see the example again:\n1 2 3 4 SELECT s.name, e.cid FROM student AS s, enrolled AS e WHERE s.sid = e.sid AND e.grade = \u0026#39;A\u0026#39; $\\pi_{name,cid}(studentâ‹ˆ\\sigma_{grade={\u0026lsquo;A\u0026rsquo;}}(enrolled))$\n$\\pi_{name,cid}(\\pi_{sid,name}(student)â‹ˆ\\pi_{cid,sid}(\\sigma_{grade={\u0026lsquo;A\u0026rsquo;}}(enrolled)))$\nLogical Query Optimization\nTransform a logical plan into an equivalent logical plan using pattern matching rules.\nThe goal is to increase the likelihood of enumerating the optimal plan in the search.\nCannot compare plans because there is no cost model but can \u0026ldquo;direct\u0026rdquo; a transformation to a preferred side.\nSplit Conjunctive predicates\n1 2 3 4 5 SELECT ARTIST.NAME FROM ARTIST, APPEARS, ALBUM WHERE ARTIST.ID=APPEARS.ARTIST_ID AND APPEARS.ALBUM_ID=ALBUM.ID AND ALBUM.NAME=\u0026#34;Andy\u0026#39;s OG Remix\u0026#34; Decompose predicates into their simplest forms to make it easier for the optimizer to move them around.\n$\\pi_{name}(\\sigma_{id=artist_id \\wedge album_id=album.id \\wedge name=\u0026ldquo;Andy\u0026rsquo;s OG Remix\u0026rdquo;}(artist\\times appears\\times album))$\nUsing selections optimization, break a complex predicate, and push down:\n$\\pi_{name}(\\sigma_{id=artist_id }(\\sigma_{album_id=album.id }(\\sigma_{name=\u0026ldquo;Andy\u0026rsquo;s OG Remix\u0026rdquo;}(artist\\times appears\\times album))))$\nMove the predicate to the lowest applicable point in the plan:\n$\\pi_{name}(\\sigma_{album_id=album.id }(\\sigma_{name=\u0026ldquo;Andy\u0026rsquo;s OG Remix\u0026rdquo;}album)\\times(\\sigma_{id=artist_id }(artist\\times appears))))$\nReplace all Cartesian Products with inner joins using the join predicates:\n$\\pi_{name}(\\sigma_{name=\u0026ldquo;Andy\u0026rsquo;s OG Remix\u0026rdquo;}album)â‹ˆ_{album_id=album.id } (artist â‹ˆ_{id=artist_id} appears))$\nEliminate redundant attributes before pipeline breakers to reduce materialization cost:\n$\\pi_{name}(\\pi_{id}(\\sigma_{name=\u0026ldquo;Andy\u0026rsquo;s OG Remix\u0026rdquo;}album)â‹ˆ_{album_id=album.id } $\\ $(\\pi_{id}(\\pi_{id, name}(artist) â‹ˆ_{id=artist_{id}} \\pi_{artist_{id}, album_{id}}(appears))))$\nNested Sub-Queries\nThe DBMS treats nested sub-queries in the where clause as functions that take parameters and return a single value or set of values. Two Approaches:\nRewrite to de-correlate and/or flatten them Decompose nested query and store result to temporary table 1 2 3 4 5 6 7 8 9 10 11 SELECT name FROM sailors AS S WHERE EXISTS ( SELECT * FROM reserves AS R WHERE S.sid = R.sid AND R.day = \u0026#39;2018-10-15\u0026#39; ) SELECT name FROM sailors AS S, reserves AS R WHERE S.sid = R.sid AND R.day = \u0026#39;2018-10-15\u0026#39; Decompose\n1 2 3 4 5 6 7 8 9 10 11 12 -- For each sailor with the highest rating (over all sailors) and at least -- two reservations for red boats, find the sailor id and the earliest date -- on which the sailor has a reservation for a red boat. SELECT S.sid, MIN(R.day) FROM sailors S, reserves R, boats B WHERE S.sid = R.sid AND R.bid = B.bid AND B.color = \u0026#39;red\u0026#39; AND S.rating = (SELECT MAX(S2.rating) FROM sailors S2) GROUP BY S.sid HAVING COUNT(*) \u0026gt; 1 For harder queries, the optimizer breaks up queries into blocks and then concentrates on one block at a time.\nSub-queries are written to a temporary table that are discarded after the query finishes.\n1 SELECT MAX(rating) FROM sailors -- Nested Block An optimizer transforms a query\u0026rsquo;s expressions (e.g., WHERE clause predicates) into the optimal/minimal set of expressions.\nImplemented using if/then/else clauses or a pattern-matching rule engine.\nSearch for expressions that match a pattern.\nWhen a match is found, rewrite the expression.\nHalt if there are no more rules that match.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 -- Impossible / Unnecessary Predicates SELECT * FROM A WHERE 1 = 0; -- return empty set SELECT * FROM A WHERE 1 = 1; -- remove where predicate -- Join Elimination SELECT A1.* FROM A AS A1 JOIN A AS A2 ON A1.id = A2.id; -- after optimize SELECT * FROM A; SELECT * FROM A AS A1 WHERE EXISTS(SELECT val FROM A AS A2 WHERE A1.id = A2.id); -- after optimize SELECT * FROM A; -- Merging Predicates SELECT * FROM A WHERE val BETWEEN 1 AND 100 OR val BETWEEN 50 AND 150; -- after optimize SELECT * FROM A WHERE val BETWEEN 1 AND 150; Cost-based Query Planning\nGenerate an estimate of the cost of executing a particular query plan for the current state of the database.\nEstimates are only meaningful internally. This is independent of the plan enumeration step that we will talk about next class.\nChoice #1: Physical Costs\nPredict CPU cycles, I/O, cache misses, RAM consumption, pre-fetching, etcâ€¦\nDepends heavily on hardware.\nChoice #2: Logical Costs\nEstimate result sizes per operator.\nIndependent of the operator algorithm.\nNeed estimations for operator result sizes.\nChoice #3: Algorithmic Costs\nComplexity of the operator algorithm implementation. Disk based DBMS cost Model\nThe number of disk accesses will always dominate the execution time of a query.\nCPU costs are negligible.\nMust consider sequential vs. random I/O.\nThis is easier to model if the DBMS has full control over buffer management.\nWe will know the replacement strategy, pinning, and assume exclusive access to disk. Postages cost Model\nUses a combination of CPU and I/O costs that are weighted by â€œmagicâ€ constant factors.\nDefault settings are obviously for a disk-resident database without a lot of memory:\nProcessing a tuple in memory is 400x faster than reading a tuple from disk.\nSequential I/O is 4x faster than random I/O.\nExample (IBM DB2 cost Model)\nDatabase characteristics in system catalogs; Hardware environment (microbenchmarks); Storage device characteristics (microbenchmarks); Communications bandwidth (distributed only); Memory resources (buffer pools, sort heaps); Concurrency Environment(Average number of users, Isolation level / blocking, Number of available locks).\n14. Optimization (2) Readings: Chapter 13\nStatistics\nThe DBMS stores internal statistics about tables, attributes, and indexes in its internal catalog.\nDifferent systems update them at different times.\nManual invocations:\nPostgres/SQLite: ANALYZE Oracle/MySQL: ANALYZETABLE SQL Server: UPDATE STATISTICS DB2: RUNSTATS Derivable Statistics\nFor each relation R, the DBMS maintains the following information:\n$N_R$: Number of tuples in R.\n$V(A,R)$: Number of distinct values for attribute A.\nThe selection cardinality $SC(A,R)$ is the average number of records with a value for an attribute A given $N_{R}/ V(A,R)$\nNote that this formula assumes data uniformity where every value has the same frequency as all other values.\nThe selectivity (sel) of a predicate P is the fraction of tuples that qualify.\nEquality Predicate: $sel (A=constant) = SC(P) / N_R$\nRange Predicate: $sel(A\u0026gt;=a) = (A_{max}â€“ a+1) / (A_{max}â€“ A_{min}+1)$\nNegation Query: $sel(not \\ P) = 1 â€“ sel(P)$\nObservation: Selectivity â‰ˆ Probability\nConjunction: $sel(P1 \\wedge P2) = sel(P1) Â· sel(P2)$\nDisjunction: $sel(P1 \\vee P2)= sel(P1) + sel(P2) â€“ sel(P1 \\wedge P2)= sel(P1) + sel(P2)â€“sel(P1)Â·sel(P2)$\nThis assumes that the predicates are independent.\nResult size estimation\nGiven a join of R and S, what is the range of possible result sizes in # of tuples? General case: $R_{cols}\\cap S_{cols}={A}$ where A is not a primary key for either table.\nMatch each R-tuple with S-tuples: $estSize â‰ˆ N_{R} Â· N_{S} / V(A, S)$\nSymmetrically, for S: $estSize â‰ˆ N_{R} Â· N_{S} / V(A, R) $\nOverall: $estSize â‰ˆ N_{R} Â· N_{S} / max({V(A,S), V(A,R)})$\nSelection Cardinality\nAssumption #1: Uniform Data\nThe distribution of values (except for the heavy hitters) is the same. Assumption #2: Independent Predicates\nThe predicates on attributes are independent Assumption #3: Inclusion Principle\nThe domain of join keys overlap such that each key in the inner relation will also exist in the outer table. Sketches\nProbabilistic data structures that generate approximate statistics about a data set.\nCost-model can replace histograms with sketches to improve its selectivity estimate accuracy.\nMost common examples:\nCount-Min Sketch(1988): Approximate frequency count of elements in a set.\nHyperLogLog(2007): Approximate the number of distinct elements in a set.\nSampling\nModern DBMSs also collect samples from tables to estimate selectivities.\nUpdate samples when the underlying tables changes significantly.\nQuery Optimization\nAfter performing rule-based rewriting, the DBMS will enumerate different plans for the query and estimate their costs. Like Single relation, Multiple relations, and Nested sub-queries.\nIt chooses the best plan it has seen for the query after exhausting all plans or some timeout.\nSimple heuristics are often good enough for this. OLTP queries are especially easy.\nQuery planning for OLTP queries is easy because they are sargable (Search Argument Able).\nIt is usually just picking the best index.\nJoins are almost always on foreign key relationships with a small cardinality.\nCan be implemented with simple heuristics.\nMulti-Relation Query Planning\nAs number of joins increases, number of alternative plans grows rapidly\nWe need to restrict search space. Fundamental decision in System R: only left-deep join trees are considered.\nModern DBMSs do not always make this assumption anymore. Use dynamic programming to reduce the number of cost estimations.\nEnumerate the orderings. Example: Left-deep tree #1, Left-deep tree #2â€¦\nEnumerate the plans for each operator. Example: Hash, Sort-Merge, Nested Loopâ€¦\nEnumerate the access paths for each table. Example: Index #1, Index #2, SeqScanâ€¦\n15. Concurrency Control Theory Readings: Chapter 14\nA transaction is the execution of a sequence of one or more operations (e.g., SQL queries) on a database to perform some higher-level function.\nA transactions may carry out many operations on the data retrieved from the database\nThe DBMS is onlyconcerned about what data is read/written from/to the database.\nStrawman System\nExecute each transactions one-by-one (i.e., serial order) as they arrive at the DBMS.\nOne and only one transactions can be running at the same time in the DBMS. Before a transactions starts, copy the entire database to a new file and make all changes to that file.\nIf the transactions completes successfully, overwrite the original file with the new one.\nIf the transactions fails, just remove the dirty copy.\nCorrectness Criteria ACID\nAtomicity: All actions in the transactions happen, or none happen.(â€œall or nothingâ€)\nConsistency: If each transactions is consistent and the DB starts consistent, then it ends up consistent.(â€œit looks correct to meâ€)\nIsolation: Execution of one transactions is isolated from that of other transactions s.(â€œas if aloneâ€)\nDurability: If a transactions commits, its effects persist.(â€œsurvive failuresâ€)\nAtomicity\nDBMS guarantees that transactions are atomic.\nFrom user\u0026rsquo;s point of view: transactions always either executes all its actions or executes no actions at all. Mechanism For Ensuring Atomicity\nApproach #1: Logging\nDBMS logs all actions so that it can undo the actions of aborted transactions.\nMaintain undo records both in memory and on disk.\nThink of this like the black box in airplanesâ€¦\nApproach #2: Shadow Paging\nDBMS makes copies of pages and transactions smake changes to those copies. Only when the transactions commits is the page made visible to others.\nOriginally from System R.\nDatabase Consistency\nThe \u0026ldquo;world\u0026rdquo; represented by the database is logicallycorrect. All questions asked about the data are given logicallycorrect answers.\nIf the database is consistent before the transaction starts (running alone), it will also be consistent after.\nTransaction consistency is the application\u0026rsquo;s responsibility. DBMS cannot control this.\nIsolation\nDBMS achieves concurrency by interleaving the actions (reads/writes of DB objects) of transactions s.\nA concurrency controlprotocol is how the DBMS decides the proper interleaving of operations from multiple transactions.\nTwo categories of protocols:\nPessimistic: Don\u0026rsquo;t let problems arise in the first place.\nOptimistic: Assume conflicts are rare, deal with them after they happen.\nSerial Schedule\nA schedule that does not interleave the actions of different transactions. Equivalent Schedules\nFor any database state, the effect of executing the first schedule is identical to the effect of executing the second schedule.\nDoesn\u0026rsquo;t matter what the arithmetic operations are!\nSerializable Schedule\nA schedule that is equivalent to some serial execution of the transactions. If each transaction preserves consistency, every serializable schedule preserves consistency.\nThere are different levels of serializability:\nConflict Serializability (Most DBMSs try to support this.)\nView Serializability (No DBMS can do this.)\nDepency Graphs\nOne node per transactions .\nEdge from $T_i$ to $T_j$ if:\nAn operation $O_i$ of $T_i$ conflicts with an operation $O_j$ of $T_j$ and\n$O_i$ appears earlier in the schedule than $O_j$.\nAlternative (weaker) notion of serializability. Schedules $S_1$ and $S_2$ are view equivalent if:\nIf $T_1$ reads initial value of A in $S_1$, then $T_1$ also reads initial value of A in $S_2$.\nIf $T_1$ reads value of A written by $T_2$ in $S_1$, then $T_1$ also reads value of A written by $T_2$ in $S_2$.\nIf $T_1$ writes final value of A in $S_1$, then $T_1$ also writes final value of A in $S_2$.\nAlso known as a precedence graph. A schedule is conflict serializable if fits dependency graph is acyclic.\nView Serializability allows for (slightly) more schedules than Conflict Serializability does.\nBut is difficult to enforce efficiently. Neither definition allows all schedules that you would consider \u0026ldquo;serializable\u0026rdquo;.\nThis is because they don\u0026rsquo;t understand the meanings of the operations or the data (recall example #3) Transaction\nAll the changes of committed transactions should be persistent.\nNo torn updates.\nNo changes from failed transactions.\nThe DBMS can use either logging or shadow paging to ensure that all changes are durable.\n16. Two Phase Locking Readings: Chapter 15.1-15.3, 15.9\nS-LOCK: Shared locks for reads.\nX-LOCK: Exclusive locks for writes.\nCompatibility Matrix\nShared Exclusive Shared âœ… âŒ Exclusive âŒ âŒ Transactions request locks (or upgrades).\nLock manager grants or blocks requests.\nTransactions release locks.\nLock manager updates its internal lock-table.\nIt keeps track of what transactions hold what locks and what transactions are waiting to acquire any locks. Two-phase locking (2PL) is a concurrency control protocol that determines whether a transactions can access an object in the database on the fly.\nThe protocol does not need to know all the queries that a transactions will execute ahead of time.\nPhase #1: Growing\nEach transactions requests the locks that it needs from the DBMSâ€™s lock manager.\nThe lock manager grants/denies lock requests.\nPhase #2: Shrinking\nThe transactions is allowed to only release locks that it previously acquired. It cannot acquire new locks. 2PL on its own is sufficient to guarantee conflict serializability.\nIt generates schedules whose precedence graph is acyclic. But it is subject to cascading aborts\nProblems\nThere are potential schedules that are serializable but would not be allowed by 2PL.\nLocking limits concurrency. Dirty reads Solution: Strong Strict 2PL (aka Rigorous 2PL)\nA schedule is strict if a value written by a transactions is not read or overwritten by other transactions suntil that transactions finishes.\nAdvantages:\nDoes not incur cascading aborts.\nAborted transactions scan be undone by just restoring original values of modified tuples.\nDead Lock Solution\nDeadlocks Solution: Detection or Prevention\nThe DBMS creates a waits-for graph to keep track of what locks each transactions is waiting to acquire:\nNodes are transactions\nEdge from $T_i$ to $T_j$ if $T_i$ is waiting for $T_j$ to release a lock.\nThe system periodically checks for cycles in waits-for graph and then decides how to break it.\nWhen the DBMS detects a deadlock, it will select a \u0026ldquo;victim\u0026rdquo; transactions to rollback to break the cycle.\nThe victim transactions will either restart or abort(more common) depending on how it was invoked.\nThere is a trade-off between the frequency of checking for deadlocks and how long transactions have to wait before deadlocks are broken.\nWhen a transactions tries to acquire a lock that is held by another transactions , the DBMS kills one of them to prevent a deadlock.\nThis approach does not require a waits-for graph or detection algorithm.\nIntension Locks\nTrade-off between parallelism versus overhead.\nFewer Locks, Larger Granularity vs. More Locks, Smaller Granularity. An intention lock allows a higher-level node to be locked in shared or exclusive mode without having to check all descendent nodes.\nIf a node is locked in an intention mode, then some transactions is doing explicit locking at a lower level in the tree.\nIntention-Shared (IS): Indicates explicit locking at lower level with shared locks.\nIntention-Exclusive (IX): Indicates explicit locking at lower level with exclusive locks.\nShared+Intention-Exclusive (SIX): The subtree rooted by that node is locked explicitly in shared mode and explicit locking is being done at a lower level with exclusive-mode locks.\nCompatibility Matrix\nIS IX S SIX X IS âœ… âœ… âœ… âœ… âŒ IX âœ… âœ… âŒ âŒ âŒ S âœ… âŒ âœ… âŒ âŒ SIX âœ… âŒ âŒ âŒ âŒ X âŒ âŒ âŒ âŒ âŒ Hierarchical locks are useful in practice as each transactions only needs a few locks. Intention locks help improve concurrency:\nIntention-Shared (IS): Intent to get lock(s) at finer granularity.\nIntention-Exclusive (IX): Intent to get X lock(s) at finer granularity.\nShared+Intention-Exclusive (SIX): Like and IX at the same time.\nLock escalation dynamically asks for coarser-grained locks when too many low-level locks acquired.\nThis reduces the number of requests that the lock manager must process.\nLock in Practice\nYou typically don\u0026rsquo;t set locks manually in transactions s.\nSometimes you will need to provide the DBMS with hints to help it to improve concurrency. Explicit locks are also useful when doing major changes to the database.\nExplicitly locks a table. Not part of the SQL standard.\nPostgres/DB2/Oracle Modes: SHARE, EXCLUSIVE\nMySQL Modes: READ, WRITE\nPerform a select and then sets an exclusive lock on the matching tuples. Can also set shared locks:\nPostgres: FOR SHARE\nMySQL: LOCK IN SHARE MODE\n17. Timestamp Ordering Readings: Chapter 15.4-15.5\nEvery object Xis tagged with timestamp of the last transactions that successfully did read/write:\nW-TS(X)â€“Write timestamp on X\nR-TS(X)â€“Read timestamp on X\nCheck timestamps for every operation:\nIf transactions tries to access an object \u0026ldquo;from the future\u0026rdquo;, it aborts and restarts. Read\nIf $TS(T_{i}) \u0026lt; W-TS(X)$, this violates timestamp order of $T_{i}$ with regard to the writer of $X$.\nAbort $T_{i}$ and restart it with a new TS. Else:\nAllow $T_{i}$ to read $X$. Update $R-TS(X)$ to $max(R-TS(X), TS(T_{i}))$ Make a local copy of $X$ to ensure repeatable reads for $T_{i}$. write\nIf $TS(T_{i})\u0026lt; R-TS(X)$ or $TS(T_{i})\u0026lt; W-TS(X)$\nAbort and restart $T_{i}$. Else:\nAllow Tito write Xand update $W-TS(X)$ Thomas Write Rule: Ignore the write to allow the transactions to continue executing without aborting. Also make a local copy of Xto ensure repeatable reads. Thomas Write Rule\nGenerates a schedule that is conflict serializable if you do not use the Thomas Write Rule.\nNo deadlocks because no transactions ever waits. Possibility of starvation for long transactions if short transactions keep causing conflicts. Recoverable Schedules\nA schedule is recoverable if transactions scommit only after all transactions swhose changes they read, commit.\nOtherwise, the DBMS cannot guarantee that transactions read data that will be restored after recovering from a crash.\nHigh overhead from copying data to transactions\u0026rsquo;s workspace and from updating timestamps.\nLong running transactions can get starved.\nThe likelihood that a transactions will read something from a newer transactions increases. Optimistic Concurrency Control\n#1 â€“Read Phase:\nTrack the read/write sets of transactions and store their writes in a private workspace. The DBMS copies every tuple that the transactions accesses from the shared database to its workspace ensure repeatable reads. #2 â€“Validation Phase:\nWhen a transactions commits, check whether it conflicts with other transactions s.\nWhen transactions $T_i$ invokes COMMIT, the DBMS checks if it conflicts with other transactions s.\nThe DBMS needs to guarantee only serializable schedules are permitted.\nChecks other transactions sfor RW and WW conflicts and ensure that conflicts are in one direction (e.g., older- younger).\nTwo methods for this phase:\nBackward Validation\nForward Validation\nBackword: Check whether the committing transactions intersects its read/write sets with those of any transactions sthat have already committed.\nForward: Check whether the committing transactions intersects its read/write sets with any active transactions sthat have not yet committed.\n#3 â€“Write Phase:\nIf validation succeeds, apply private changes to database. Otherwise abort and restart the transactions . 18. Multi-Version Concurrency Control Readings: Chapter 15.6-15.7\nThe DBMS maintains multiple physical versions of a single logical object in the database:\nWhen a transactions writes to an object, the DBMS creates a new version of that object.\nWhen a transactions reads an object, it reads the newest version that existed when the transactions started.\nWriters do not block readers. Readers do not block writers.\nRead-only transactions scan read a consistent snapshotwithout acquiring locks.\nUse timestamps to determine visibility. Easily support time-travelqueries.\nMVCC is more than just a concurrency control protocol. It completely affects how the DBMS manages transactions and the database.\nConcurrency Control\nApproach #1: Timestamp Ordering\nAssign transactions stimestamps that determine serial order. Approach #2: Optimistic Concurrency Control\nThree-phase protocol from last class.\nUse private workspace for new versions.\nApproach #3: Two-Phase Locking\nVersion Storage\ntransactions acquire appropriate lock on physical version before they can read/write a logical tuple. The DBMS uses the tuples\u0026rsquo; pointer field to create a version chain per logical tuple.\nThis allows the DBMS to find the version that is visible to a particular transactions at runtime.\nIndexes always point to the \u0026ldquo;head\u0026rdquo; of the chain.\nApproach #1: Append-Only Storage\nNew versions are appended to the same table space. Approach #2: Time-Travel Storage\nOld versions are copied to separate table space. Approach #3: Delta Storage\nThe original values of the modified attributes are copied into a separate delta record space. Different storage schemes determine where/what to store for each version.\nGC\nTuple Level:\nBackground Vacuuming: Separate thread(s) periodically scan the table and look for reclaimable versions. Works with any storage.\nCooperative Cleaning: Worker threads identify reclaimable versions as they traverse version chain. Only works with O2N.\nTransaction Level:\nEach transactions keeps track of its read/write set.\nThe DBMS determines when all versions created by a finished transactions are no longer visible.\nMay still require multiple threads to reclaim the memory fast enough for the workload.\nMVCC Indexes\nEach index\u0026rsquo;s underlying data structure must support the storage of non-unique keys.\nUse additional execution logic to perform conditional inserts for pkey/ unique indexes.\nAtomically check whether the key exists and then insert. Workers may get back multiple entries for a single fetch. They then must follow the pointers to find the proper physical version.\nImplementations\nProtocol VersionStorage GarbageCollection Indexes Oracle MV2PL Delta Vacuum Logical Postgres MV-2PL/MV-TO Append-Only Vacuum Physical MySQL-InnoDB MV-2PL Delta Vacuum Logical HYRISE MV-OCC Append-Only â€“ Physical Hekaton MV-OCC Append-Only Cooperative Physical MemSQL MV-OCC Append-Only Vacuum Physical SAP HANA MV-2PL Time-travel Hybrid Logical NuoDB MV-2PL Append-Only Vacuum Logical HyPer MV-OCC Delta transactions -level Logical NoisePage MV-OCC Delta transactions -level Logical 19. Logging Protocols + Schemes Readings: Chapter 16.1-16.7\nRecovery algorithms are techniques to ensure database consistency, transaction atomicity, and durability despite failures.\nRecovery algorithms have two parts:\nActions during normal transactions processing to ensure that the DBMS can recover from a failure.\nActions after a failure to recover the database to a state that ensures atomicity, consistency, and durability.\nStorage\nVolatile Storage:\nData does notpersist after power loss or program exit.\nExamples: DRAM, SRAM\nNon-volatile Storage:\nData persists after power loss and program exit.\nExamples: HDD, SDD\nStable Storage:\nA non-existentform of non-volatile storage that survives all possible failures scenarios. Redo vs Undo\nUndo: The process of removing the effects of an incomplete or aborted transactions .\nRedo: The process of re-instating the effects of a committed transactions for durability.\nHow the DBMS supports this functionality depends on how it manages the buffer pool.\nWhether the DBMS allows an uncommitted transactions to overwrite the most recent committed value of an object in non-volatile storage.\nSTEAL: Is allowed.\nNO-STEAL: Is notallowed.\nWhether the DBMS requires that all updates made by a transactions are reflected on non-volatile storage before the transactions can commit.\nFORCE: Is required.\nNO-FORCE: Is notrequired.\nThis approach is the easiest to implement:\nNever have to undochanges of an aborted transactions because the changes were not written to disk.\nNever have to redo changes of a committed transactions because all the changes are guaranteed to be written to disk at commit time (assuming atomic hardware writes).\nPrevious example cannot support write sets that exceed the amount of physical memory available.\nShaow pages\nTo install the updates, overwrite the root so it points to the shadow, thereby swapping the master and shadow:\nBefore overwriting the root, none of the transactions \u0026lsquo;supdates are part of the disk-resident database\nAfter overwriting the root, all the transactions \u0026lsquo;supdates are part of the disk-resident database.\nSupporting rollbacks and recovery is easy.\nUndo: Remove the shadow pages. Leave the master and the DB root pointer alone.\nRedo: Not needed at all.\nDisadvantages\nCopying the entire page table is expensive:\nUse a page table structured like a B+tree.\nNo need to copy entire tree, only need to copy paths in the tree that lead to updated leaf nodes.\nCommit overhead is high:\nFlush every updated page, page table, and root.\nData gets fragmented.\nNeed garbage collection.\nOnly supports one writer transactions at a time or transactions sin a batch.\nWrite Ahead Log\nMaintain a log file separate from data files that contains the changes that transactions smake to database.\nAssume that the log is on stable storage.\nLog contains enough information to perform the necessary undo and redo actions to restore the database.\nDBMS must write to disk the log file records that correspond to changes made to a database object beforeit can flush that object to disk.\nBuffer Pool Policy: STEAL+ NO-FORCE\nThe DBMS stages all a transactions \u0026lsquo;slog records in volatile storage (usually backed by buffer pool).\nAll log records pertaining to an updated page are written to non-volatile storage beforethe page itself is over-written in non-volatile storage.\nA transactions is not considered committed until allits log records have been written to stable storage.\nWhen should the DBMS write log entries to disk?\nWhen the transaction commits.\nCan use group committo batch multiple log flushes together to amortize overhead.\nWhen should the DBMS write dirty records to disk?\nEvery time the transactions executes an update?\nOnce when the transactions commits?\nLogging Schemes\nLogical logging requires less data written in each log record than physical logging.\nDifficult to implement recovery with logical logging if you have concurrent transactions s.\nHard to determine which parts of the database may have been modified by a query before crash.\nAlso takes longer to recover because you must re-execute every transactions all over again.\nHybrid approach where log records target a single page but do not specify organization of the page.\nIdentify tuples based on their slot number.\nAllows DBMS to reorganize pages after a log record has been written to disk.\nThis is the most popular approach.\nCheck Points\nThe WAL will grow forever.\nAfter a crash, the DBMS must replay the entire log, which will take a long time.\nThe DBMS periodically takes a checkpoint where it flushes all buffers out to disk.\nOutput onto stable storage all log records currently residing in main memory.\nOutput to the disk all modified blocks.\nWrite a \u0026lt;CHECKPOINT\u0026gt; entry to the log and flush to stable storage.\nCheckpointing too often causes the runtime performance to degrade.\nSystem spends too much time flushing buffers. But waiting a long time is just as bad:\nThe checkpoint will be large and slow.\nMakes recovery time much longer.\n20. Crash Recovery Readings: Chapter 16.1-16.8\nAlgorithms for Recovery and Isolation Exploiting Semantics\nWrite-Ahead Logging:\nAny change is recorded in log on stable storage before the database change is written to disk.\nMust use STEAL+ NO-FORCE buffer pool policies.\nRepeating History During Redo:\nOn restart, retrace actions and restore database to exact state before crash. Logging Changes During Undo:\nRecord undo actions to log to ensure action is not repeated in the event of repeated failures. WAL Records\nEvery log record now includes a globally unique log sequence number(LSN).\nName Where Definition flushedLSN Memory Last LSN in log on disk pageLSN $page_x$ Newest update to $page_x$ recLSN $page_x$ Oldest update to $page_x$ since it was last flushed lastLSN $T_i$ Latest record of transactions $T_i$ MasterRecord Disk LSN of latest checkpoint Each data page contains a pageLSN.\nThe LSN of the most recent update to that page. System keeps track of flushedLSN.\nThe max LSN flushed so far. Before page xcan be written to disk, we must flush log at least to the point where:\n$pageLSN_x â‰¤ flushedLSN$ Transaction Commit\nWrite COMMITrecord to log.\nAll log records up to transactions\u0026rsquo; COMMIT record are flushed to disk.\nLog flushes are sequential, synchronous writes to disk.\nMany log records per log page.\nWhen the commit succeeds, write a special transactions\u0026rsquo; END record to log.\nThis does notneed to be flushed immediately. A CLR describes the actions taken to undo the actions of a previous update record.\nIt has all the fields of an update log record plus the undoNextpointer (the next-to-be-undone LSN).\nCLRs are added to log records but the DBMS does not wait for them to be flushed before notifying the application that the transactions aborted.\nNON-FUZZY CHECKPOINTS\nThe DBMS halts everything when it takes a checkpoint to ensure a consistent snapshot:\nHalt the start of any new transactions s.\nWait until all active transactions sfinish executing.\nFlushes dirty pages on disk.\nThis is bad for runtime performance but makes recovery easy.\nSLIGHTLY BETTER CHECKPOINTS\nPause modifying transactions swhile the DBMS takes the checkpoint.\nPrevent queries from acquiring write latch on table/index pages.\nDon\u0026rsquo;t have to wait until all transactions sfinish before taking the checkpoint.\nWe must record internal state as of the beginning of the checkpoint.\nActive Transaction Table (ATT)\nDirty Page Table (DPT)\nACTIVE TRANSACTION TABLE\nOne entry per currently active transactions .\ntransactions Id: Unique transactions identifier.\nstatus: The current \u0026ldquo;mode\u0026rdquo; of the transactions .\nlastLSN: Most recent LSN created by transactions .\nEntry removed after the transactions -END message.\ntransactions Status Codes:\nR: Running\nC: Committing\nU: Candidate for Undo\nA fuzzy checkpoint is where the DBMS allows active transactions sto continue the run while the system writes the log records for checkpoint.\nNo attempt to force dirty pages to disk. New log records to track checkpoint boundaries:\nCHECKPOINT-BEGIN: Indicates start of checkpoint\nCHECKPOINT-END: Contains ATT+ DPT.\nARIES\nStart from last BEGIN-CHECKPOINTfound via MasterRecord.\nAnalysis: Figure out which transactions scommitted or failed since checkpoint.\nRedo: Repeat allactions.\nUndo: Reverse effects of failed transactions s.\n21. Distributed Databases Approach #1: Homogenous Nodes\nEvery node in the cluster can perform the same set of tasks (albeit on potentially different partitions of data). Makes provisioning and failover \u0026ldquo;easier\u0026rdquo;. Approach #2: Heterogenous Nodes\nNodes are assigned specific tasks.\nCan allow a single physical node to host multiple \u0026ldquo;virtual\u0026rdquo; node types for dedicated tasks.\nFor User, it is Transparent. Users should not be required to know where data is physically located, how tables are partitioned or replicated.\nSplit a table\u0026rsquo;s tuples into disjoint subsets.\nChoose column(s) that divides the database equally in terms of size, load, or usage.\nHash Partitioning, Range Partitioning\nThe DBMS can partition a database physically(shared nothing) or logically (shared disk).\nTP Monitors\nA TP Monitor is an example of a centralized coordinator for distributed DBMSs.\nOriginally developed in the 1970-80s to provide transactions between terminals and mainframe databases.\nExamples: ATMs, Airline Reservations. Many DBMSs now support the same functionality internally.\n22. Distributed OLTP If you do nottrust the other nodes in a distributed DBMS, then you need to use a Byzantine Fault Tolerantprotocol for transactions(blockchain).\nWhen a multi-node transaction finishes, the DBMS needs to ask all the nodes involved whether it is safe to commit.\n2PC Optimizations\nEarly Prepare Voting\nIf you send a query to a remote node that you know will be the last one you execute there, then that node will also return their vote for the prepare phase with the query result. Early Acknowledgement After Prepare\nIf all nodes vote to commit a transaction, the coordinator can send the client an acknowledgement that their transaction was successful before the commit phase finishes. Blocks if coordinator fails after the prepare message is sent, until coordinator recovers.\nPAXOS\nIf the system elects a single leader that oversees proposing changes for some period, then it can skip the Propose phase.\nFall back to full Paxoswhenever there is a failure. The system periodically renews who the leader is using another Paxosround.\nNodes must exchange log entries during leader election to make sure that everyone is up-to-date. Non-blocking if a majority participants are alive, provided there is a sufficiently long period without further failures.\n23. Distributed OLAP Most shared-nothing distributed OLAP DBMSs are designed to assume that nodes do not fail during query execution.\nIf one node fails during query execution, then the whole query fails. The DBMS could take a snapshot of the intermediate results for a query during execution to allow it to recover if nodes fail.\nAll the optimizations that we talked about before are still applicable in a distributed environment.\nPredicate Pushdown\nEarly Projections\nOptimal Join Orderings\nDistributed query optimization is even harder because it must consider the physical location of data and network transfer costs.\n","date":"2021-11-25T14:11:42+08:00","image":"https://chasing1020.github.io/post/database-systems/mysql_hubf29412fdbd9303c575ba06f7ee7c6af_94146_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/database-systems/","title":"Database Systems"},{"content":"Mathematic Fomulars The mathematical typesetting is based on LaTeX, so if you need to search for the way to make a particular symbol, include latex in your search. But note: Not all LaTeX macros are available without using additional packages, and those packages likely will only work if you are creating a PDF. On the plus side, if you are working in PDF, you can use additional packages that give much better control and/or easier syntax.\nThis article is about the basics about math symbols in Latex.\nGreek Letters Î±A $\\alpha A$ Î½N $\\nu N$ Î²B $\\beta B$ Î¾Î $\\xi\\Xi$ Î³Î“ $\\gamma \\Gamma$ oO $o O$ (omicron) Î´Î” $\\delta \\Delta$ Ï€Î  $\\pi \\Pi$ ÏµÎµE $\\epsilon \\varepsilon E$ ÏÏ±P $\\rho\\varrho P$ Î¶Z $\\zeta Z \\sigma \\,\\!$ Î£Î£ $\\sigma \\Sigma$ Î·H $\\eta H$ Ï„T $\\tau T$ Î¸Ï‘ $\\theta \\vartheta \\Theta$ Ï…Î¥ $\\upsilon \\Upsilon$ Î¹I $\\iota I$ Ï•Ï†Î¦ $\\phi \\varphi \\Phi$ ÎºK $\\kappa K$ Ï‡X $\\chi X$ Î»Î› $\\lambda \\Lambda$ ÏˆÎ¨ $\\psi \\Psi$ Î¼M $\\mu M$ Ï‰Î© $\\omega \\Omega$ Operators Symbol Script $\\cos$ \\cos $\\sin$ \\sin $\\lim$ \\lim $\\exp$ \\exp $\\to$ \\to $\\infty$ \\infty $\\equiv$ \\equiv $\\bmod$ \\bmod $\\times$ \\times Power and Indices Symbol Script $k_{n+1}$ k_{n+1} $n^2$ n^2 $k_n^2$ k_n^2 Fractions and Binomials Symbol Script $\\frac{n!}{k!(n-k)!}$ \\frac{n!}{k!(n-k)!} $\\binom{n}{k}$ \\binom{n}{k} $\\frac{\\frac{x}{1}}{x - y}$ \\frac{\\frac{x}{1}}{x - y} $^3/_7$ ^3/_7 Roots Symbol Script $\\sqrt{k}$ \\sqrt{k} $\\sqrt[n]{k}$ \\sqrt[n]{k} Sums and Integrals $\\int a^4 tan^2t sec^3t dt$\nSymbol Script $\\sum_{i=1}^{10} t_i$ \\sum_{i=1}^{10} t_i $\\int_0^\\infty \\mathrm{e}^{-x}\\mathrm{d}x$ \\int_0^\\infty \\mathrm{e}^{-x}\\mathrm{d}x $\\int_{-\\infty}^{\\infty} f(x) ; dx$ \\int_{-\\infty}^{\\infty} f(x) ; dx $\\left. F(x) \\right _{a}^{b}$ $\\sum$ \\sum $\\prod$ \\prod $\\coprod$ \\coprod $\\implies$ \\implies $\\bigoplus$ \\bigoplus $\\bigotimes$ \\bigotimes $\\bigodot$ \\bigodot $\\bigcup$ \\bigcup $\\bigcap$ \\bigcap $\\biguplus$ \\biguplus $\\bigsqcup$ \\bigsqcup $\\bigvee$ \\bigvee $\\vee$ \\vee $\\bigwedge$ \\bigwedge $\\wedge$ \\wedge $\\int$ \\int $\\oint$ \\oint $\\iint$ \\iint $\\iiint$ \\iiint $\\idotsint$ \\idotsint $\\sum_{\\substack{0\u0026lt;i\u0026lt;m,0\u0026lt;j\u0026lt;n}} P(i, j)$ \\sum_{\\substack{0\u0026lt;i\u0026lt;m,0\u0026lt;j\u0026lt;n}} P(i, j) $\\int\\limits_a^b$ \\int\\limits_a^b Marks Symbol Script $aâ€™$ $a^{\\prime}$ a` a^{\\prime} $aâ€™â€™$ aâ€™â€™ $\\hat{a}$ hat{a} $\\bar{a}$ \\bar{a} $\\grave{a}$ \\grave{a} $\\acute{a}$ \\acute{a} $\\stackrel{Â·}{\\sim}$ \\dot{a} $\\ddot{a}$ \\ddot{a} $\\not{a}$ \\not{a} $\\mathring{a}$ \\mathring{a} $\\overrightarrow{AB}$ \\overrightarrow{AB} $\\overleftarrow{AB}$ \\overleftarrow{AB} $aâ€™â€™â€™$ aâ€™â€™â€™ $\\overline{aaa}$ \\overline{aaa} $\\check{a}$ \\check{a} $\\vec{a}$ \\vec{a} $\\underline{a}$ \\underline{a} $\\color{red}x$ \\color{red}x $\\pm$ \\pm $\\mp$ \\mp $\\int y \\mathrm{d}x$ \\int y \\mathrm{d}x $,$ , $:$ : $;$ ; $!$ ! $\\int y, \\mathrm{d}x$ \\int y, \\mathrm{d}x $\\dots$ \\dots $\\ldots$ \\ldots $\\cdots$ \\cdots $\\vdots$ \\vdots $\\ddots$ \\ddots $\\stackrel{\\bf{}}{\\sim}$\nBrackets etc Symbol Script $(a)$ (a) $[a]$ [a] ${a}$ {a} $\\langle f \\rangle$ \\langle f \\rangle $\\lfloor f \\rfloor$ \\lfloor f \\rfloor $\\lceil f \\rceil$ \\lceil f \\rceil $\\ulcorner f \\urcorner$ \\ulcorner f \\urcorner Aligning equations use \\begin{align*} \u0026hellip; \\end{align*}. Separate lines with \\\\ and use \u0026amp; to mark where things should line up.\n1 2 3 4 5 $\\begin{align*} a \u0026amp; = b \\\\ X \u0026amp;\\sim {\\sf Norm}(10, 3) \\\\ 5 \u0026amp; \\le 10 \\end{align*}$ $\\begin{align*} a \u0026amp; = b \\ X \u0026amp;\\sim {\\sf Norm}(10, 3) \\ 5 \u0026amp; \\le 10 \\end{align*}$\n","date":"2021-11-20T21:48:46+08:00","image":"https://chasing1020.github.io/post/mathematic-fomulars/math_hu83b9f6e293f1a315f3c631b3d80c5053_31522_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/mathematic-fomulars/","title":"Mathematic Fomulars"},{"content":"1. Overview ä»€ä¹ˆæ˜¯æ“ä½œç³»ç»Ÿï¼Ÿ\nç¡¬ä»¶è§’åº¦ï¼š\nç®¡ç†ç¡¬ä»¶ï¼šå°†å¤æ‚çš„ï¼Œå…·å¤‡ä¸åŒåŠŸèƒ½çš„ç¡¬ä»¶èµ„æºçº³å…¥ç»Ÿä¸€ç®¡ç†ã€‚ å¯¹ç¡¬ä»¶è¿›è¡ŒæŠ½è±¡ï¼šæŠ½è±¡æˆä¸ä¾èµ–å…·ä½“ç¡¬ä»¶ç‰¹æ€§çš„èµ„æºã€‚ å°†æœ‰é™çš„ï¼Œç¦»æ•£çš„èµ„æºé«˜æ•ˆåœ°æŠ½è±¡æˆæ— é™çš„ã€è¿ç»­çš„èµ„æºï¼Œå¹¶æäº¤æ¥å£ç»™ä¸Šå±‚ç³»ç»Ÿè°ƒç”¨ã€‚\nåº”ç”¨è§’åº¦ï¼š\næœåŠ¡äºåº”ç”¨ï¼šæä¾›ä¸åŒå±‚æ¬¡ï¼Œä¸åŒåŠŸèƒ½çš„æ¥å£ä»¥æ»¡è¶³åº”ç”¨éœ€æ±‚ ç®¡ç†åº”ç”¨ï¼šè´Ÿè´£åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬åŠ è½½ï¼Œå¯åŠ¨ï¼Œåˆ‡æ¢ï¼Œè°ƒåº¦ç­‰ã€‚ 2. Hardware Infrastructure å†¯è¯ºä¾æ›¼æ¶æ„ï¼šä¸­å¤®å¤„ç†å•å…ƒï¼Œå­˜å‚¨å™¨ï¼Œè¾“å…¥è¾“å‡ºã€‚\nç¼“å­˜ç»“æ„ï¼šCPUç¼“å­˜æ˜¯ç”±è‹¥å¹²ä¸ªç¼“å­˜è¡Œå†³å®šçš„ï¼Œæ¯ä¸ªç¼“å­˜è¡ŒåŒ…æ‹¬ä¸€ä¸ªæœ‰æ•ˆä½ï¼ˆvalid bitï¼‰ï¼Œä¸€ä¸ªæ ‡è®°åœ°å€ï¼ˆtag addressï¼‰ã€‚ç‰©ç†åœ°å€åœ¨é€»è¾‘ä¸Šåˆ†ä¸ºä¸‰æ®µã€‚Tagã€Index(Set)ã€Wayã€‚ç‰©ç†åœ°å€èƒ½è¡¨ç¤ºIndex(Set)çš„æœ€å¤§æ•°ç›®ä¸ºç»„ï¼Œæ”¯æŒTagæœ€å¤§çš„æ•°ç›®ä¸ºè·¯ï¼ˆWayï¼‰ã€‚\nç‰©ç†åœ°å€ç»“æ„ï¼šTagï¼ˆç‰©ç†åœ°å€ï¼‰+ Setï¼ˆç»„å·ï¼‰+ OffSetï¼ˆç»„å†…åç§»ï¼‰\nç›´æ¥æ˜ å°„ï¼šå†…å­˜ä¸CPUçš„CacheLineç›¸å¯¹ä½ç½®å›ºå®šï¼Œå¯¼è‡´æ·˜æ±°æ¢å‡ºé¢‘ç¹ã€‚\nå…¨ç›¸è”æ˜ å°„ï¼šçµæ´»ï¼Œç”µè·¯è®¾è®¡å›°éš¾ï¼Œåªé€‚åˆå°å®¹é‡Cacheã€‚\nç»„ç›¸è”æ˜ å°„ï¼šCPUå’Œä¸»å­˜éƒ½åˆ†ç»„ï¼ŒåŒç»„çš„ç¼“å­˜è¡Œæ•°é‡ç§°ä¸ºè·¯ï¼Œç»„å†…é‡‡ç”¨ç›´æ¥æ˜ å°„ï¼Œç»„é—´é‡‡ç”¨å…¨ç›¸è”æ˜ å°„ã€‚\nCPUè®¿é—®è®¾å¤‡çš„æ–¹å¼ï¼šå†…å­˜æ˜ å°„è¾“å…¥è¾“å‡ºï¼ˆMemory-Mapped I/Oï¼‰ï¼Œå°†IOè®¾å¤‡å’Œç‰©ç†å†…å­˜æ”¾åˆ°åŒä¸€ä¸ªå­˜å‚¨ç©ºé—´ã€‚\nå¦‚æœCPUé€šè¿‡ä¸æ–­è½®è¯¢ï¼ŒæŸ¥çœ‹MMIOæ˜¯å¦æœ‰è¾“å…¥æ•ˆç‡ä¼šå¾ˆä½ï¼Œæ‰€ä»¥æ›´é«˜æ•ˆçš„åšæ³•æ˜¯åˆ©ç”¨ä¸­æ–­ï¼Œä¸»åŠ¨é€šçŸ¥CPUã€‚\n3. Operating System Architecture è®¾è®¡ä¸Šï¼Œç­–ç•¥ï¼ˆPolicyï¼Œâ€œè¦åšä»€ä¹ˆâ€ï¼‰å’Œæœºåˆ¶ï¼ˆMechanismï¼Œâ€œæ€ä¹ˆåšâ€ï¼‰éš”ç¦»ã€‚\nå†…æ ¸æ¶æ„\nç®€è¦ç»“æ„ï¼šä»¥DOSå…¸å‹ï¼Œæ²¡æœ‰ç°ä»£æ„ä¹‰çš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰\nå®å†…æ ¸æ¶æ„ï¼ˆMonolithic Kernelï¼‰ï¼šåˆç§°å•å†…æ ¸ï¼Œç°ä»£Unixï¼ŒLinuxï¼ŒWindowséƒ½é‡‡ç”¨å®å†…æ ¸ã€‚\næ¨¡å—åŒ–ï¼ˆmodularityï¼‰ï¼šä½¿ç”¨å¯åŠ è½½å†…æ ¸æ¨¡å—ï¼ˆLoadable Kernel Moduleï¼‰æœºåˆ¶ï¼Œä½¿å†…æ ¸ä¸å…¶ä»–æ¨¡å—ï¼ˆå¦‚é©±åŠ¨ï¼‰è§£è€¦ã€‚ æŠ½è±¡ï¼ˆabstractionï¼‰ï¼šé‡‡ç”¨â€œEverything is a fileâ€æ€æƒ³ï¼Œä¸ºä¸Šå±‚åº”ç”¨æä¾›ç»Ÿä¸€æ¥å£ï¼Œé™ä½å¤æ‚æ€§ï¼Œå¢å¼ºç»´æŠ¤æ€§ã€‚ åˆ†å±‚ï¼ˆlayeringï¼‰ï¼šDijkstraæå‡ºçš„â€œTHEâ€æ“ä½œç³»ç»Ÿï¼Œåˆ†ä¸º6å±‚ï¼Œæ›´å¥½åœ°ç»„ç»‡å„ç§åŠŸèƒ½ã€‚ å±‚çº§ï¼ˆhierarchyï¼‰ï¼šåº”ç”¨äºèµ„æºç®¡ç†ï¼Œå¦‚è°ƒåº¦ç®—æ³•ä¼˜å…ˆçº§åˆ†ç±»ï¼Œæ§åˆ¶ç»„ï¼ˆcgroupï¼‰åˆ†ç±»ã€‚ å¾®å†…æ ¸æ¶æ„ï¼šä»¥Machä¸ºä»£è¡¨ï¼Œå°†å•ä¸ªåŠŸèƒ½æˆ–æ¨¡å—ä»å†…æ ¸ä¸­æ‹†åˆ†å‡ºæ¥ï¼Œæé«˜å®‰å…¨æ€§ã€‚ç”±äºMachå¯¹IPCè®¾è®¡è¿‡äºé€šç”¨ï¼Œä»¥è‡³äºè‡ªèº«èµ„æºå ç”¨è¿‡å¤§ï¼Œæ•ˆç‡å¹¶ä¸åŠåŒæœŸçš„å®å†…æ ¸ã€‚ä½†æ˜¯å¾®å†…æ ¸å…·æœ‰å¼¹æ€§æ‹“å±•çš„èƒ½åŠ›ï¼Œç¡¬ä»¶å¼‚æ„ï¼Œå¹¶ä¸”å…·æœ‰åŠŸèƒ½å®‰å…¨ä¸ä¿¡æ¯å®‰å…¨ï¼Œå¹¶ä¸”è°ƒç”¨å…·æœ‰ç¡®å®šçš„æ—¶å»¶ã€‚\nå¤–æ ¸æ¶æ„ï¼šåº“æ“ä½œç³»ç»ŸLibOSï¼Œå¯ä»¥æŒ‰ç…§åº”ç”¨é¢†åŸŸçš„ç‰¹ç‚¹ä¸éœ€æ±‚ï¼Œå®‰è£…æœ€é€‚åˆçš„LibOSï¼Œæœ€å°åŒ–éå¿…è¦ä»£ç ï¼Œå¤šä¸ªLibOSä¹‹é—´çš„éš”ç¦»å¾ˆå¼ºï¼Œå…·æœ‰å¾ˆå¥½çš„å®‰å…¨æ€§ã€‚è¿˜æœ‰äº‘è®¡ç®—çš„å®¹å™¨ï¼ŒåŸºäºUnikernelå°†è™šæ‹Ÿæœºç›‘æ§å™¨ä½œä¸ºæ”¯æ’‘Unikernel/LibOSè¿è¡Œçš„å†…æ ¸ã€‚\nå…¶ä»–æ¡†æ¶ç»“æ„ï¼šä»¥Androidä¸ºä¾‹ï¼Œå…¶åŒ…å«ç¡¬ä»¶æŠ½è±¡å±‚ï¼ŒAndroidåº“ï¼ŒAndroidè¿è¡Œç¯å¢ƒï¼ŒAndroidè¿è¡Œæ¡†æ¶ã€‚\n4. Memory Management ç°ä»£æ“ä½œç³»ç»Ÿé‡‡ç”¨è™šæ‹Ÿå†…å­˜ï¼Œä»¥ä¸‹ä½œä¸ºè®¾è®¡ç›®æ ‡\né«˜æ•ˆæ€§ï¼šè™šæ‹Ÿå†…å­˜æ²¡æœ‰æ˜æ˜¾æ€§èƒ½å¼€é”€ã€‚ å®‰å…¨æ€§ï¼šä½¿åº”ç”¨ä¹‹é—´çš„å†…å­˜ç›¸äº’éš”ç¦»ã€‚ é€æ˜æ€§ï¼šè™šæ‹Ÿå†…å­˜æŠ½è±¡å¯¹ç¨‹åºå‘˜é€æ˜ã€‚ CPUçš„å†…å­˜ç®¡ç†å•å…ƒï¼ˆMemory Management Unitï¼ŒMMUï¼‰è´Ÿè´£è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ï¼Œæ­¤å¤–ï¼Œè¿˜æœ‰åœ°å€æ—è·¯ç¼“å­˜ï¼ˆTranslation Lookaside Bufferï¼ŒTLBï¼‰\nåˆ†æ®µæœºåˆ¶ï¼šå¦‚å°†åº”ç”¨åˆ†æˆä»£ç æ®µï¼Œæ•°æ®æ®µã€‚æ¯ä¸ªæ®µè¡¨ï¼Œä½œä¸ºæ®µå†…åœ°å€ä¸æ®µå†…åç§»æ¥ç¡®å®šä½ç½®ã€‚å¾ˆå®¹æ˜“äº§ç”Ÿå¤–éƒ¨ç¢ç‰‡ã€‚\nåˆ†é¡µæœºåˆ¶ï¼šç”¨è™šæ‹Ÿé¡µå·ä¸é¡µå†…åç§»é‡ï¼ŒæŒ‰å›ºå®šå¤§å°ç®¡ç†ï¼Œå‡å°‘å¤–éƒ¨ç¢ç‰‡ã€‚\nè®¿å­˜æ¬¡æ•°ï¼ˆä¸€èˆ¬è®¿é—®TLBä¸ç®—è®¿å­˜ï¼‰\né¡µå¼å­˜å‚¨ï¼Œ2æ¬¡ï¼šç¬¬ä¸€æ¬¡ã€è®¿é—®å†…å­˜ä¸­çš„é¡µè¡¨ï¼Œåˆ©ç”¨é€»è¾‘åœ°å€ä¸­çš„é¡µå·æŸ¥æ‰¾åˆ°é¡µå¸§å·ï¼Œä¸é€»è¾‘åœ°å€ä¸­çš„é¡µå†…åç§»æ‹¼æ¥å½¢æˆç‰©ç†åœ°å€ï¼›ç¬¬äºŒæ¬¡ï¼šå¾—åˆ°ç‰©ç†åœ°å€åï¼Œå†ä¸€æ¬¡è®¿é—®å†…å­˜ï¼Œå­˜å–æŒ‡ä»¤æˆ–è€…æ•°æ®ã€‚\næ®µå¼å­˜å‚¨ï¼Œ2æ¬¡ï¼ˆåŒä¸Šï¼‰\næ®µé¡µå¼å­˜å‚¨ï¼Œ3æ¬¡ï¼š\nç¬¬ä¸€æ¬¡ï¼šè®¿é—®å†…å­˜ä¸­çš„æ®µè¡¨æŸ¥åˆ°é¡µè¡¨çš„èµ·å§‹åœ°å€\nç¬¬äºŒæ¬¡ï¼šè®¿é—®å†…å­˜ä¸­çš„é¡µè¡¨æ‰¾åˆ°é¡µå¸§å·ï¼Œå½¢æˆç‰©ç†åœ°å€\nç¬¬ä¸‰æ¬¡ï¼šå¾—åˆ°ç‰©ç†åœ°å€åï¼Œå†ä¸€æ¬¡è®¿é—®å†…å­˜ï¼Œå­˜å–æŒ‡ä»¤æˆ–è€…æ•°æ®\nå¤šçº§é¡µè¡¨ï¼Œè‹¥é¡µè¡¨åˆ’åˆ†ä¸ºNçº§ï¼Œåˆ™éœ€è¦è®¿é—®å†…å­˜N+1æ¬¡ã€‚TLBå‘½ä¸­ï¼Œåªéœ€è®¿é—®1æ¬¡å†…å­˜å³å¯ã€‚\n4.1. Paging å†…æ ¸æŠŠç‰©ç†é¡µä½œä¸ºå†…å­˜ç®¡ç†çš„åŸºæœ¬å•ä½ã€‚ç‰©ç†é¡µçš„åŸºæœ¬æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 struct page { unsigned long flags; // é¡µæ˜¯ä¸æ˜¯è„çš„ï¼Œæ˜¯å¦é”å®šåœ¨å†…å­˜ä¸­ atomic_t _count; // é¡µçš„å¼•ç”¨è®¡æ•° atomic_t _mapcount; unsigned long private; struct address_space *mapping; pgoff_t index; struct list_head lru; void *virtual; // é¡µçš„è™šæ‹Ÿåœ°å€ } 64ä½ç³»ç»Ÿä¸‹çš„4çº§é¡µè¡¨ï¼šæ¯ä¸ªé¡µ4KBï¼Œæœ€ä½12ä½($2^{12}$=4KB)æ¥è¡¨ç¤ºé¡µå†…åç§»ã€‚æ¯ä¸ªé¡µè¡¨é¡µä¹Ÿå ç”¨ç‰©ç†å†…å­˜çš„ä¸€ä¸ªç‰©ç†é¡µ(4KB)ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹8å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªé¡µè¡¨é¡µå¯ä»¥å¯¹åº”512é¡µè¡¨é¡¹(4KB/8B=512=$2^9$)ã€‚æ‰€ä»¥ï¼Œ48-63ä½å…¨éƒ¨ç½®ä¸º0æˆ–è€…æ˜¯1ã€‚å‰©ä¸‹36+12åˆ†åˆ«å¯¹åº”å››çº§é¡µè¡¨ï¼Œå’Œé¡µè¡¨å†…åç§»é‡ã€‚\n32ä½ç³»ç»Ÿä¸‹çš„2çº§é¡µè¡¨ï¼šæ¯ä¸ªé¡µ4KBï¼Œæœ€ä½12ä½($2^{12}$=4KB)æ¥è¡¨ç¤ºé¡µå†…åç§»ã€‚æ¯ä¸ªé¡µè¡¨é¡µä¹Ÿå ç”¨ç‰©ç†å†…å­˜çš„ä¸€ä¸ªç‰©ç†é¡µ(4KB)ï¼Œæ¯ä¸ªé¡µè¡¨é¡¹4å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªé¡µè¡¨é¡µå¯ä»¥å¯¹åº”1024é¡µè¡¨é¡¹(4KB/4B=1024=$2^{10}$)ã€‚æ‰€ä»¥ï¼Œ20+12åˆ†åˆ«å¯¹åº”äºŒçº§é¡µè¡¨(2*10)ï¼Œå’Œé¡µè¡¨å†…åç§»é‡ã€‚\nå¯¹äº32bitæ“ä½œç³»ç»Ÿï¼Œé€šè¿‡ç‰©ç†åœ°å€æ‰©å±•ï¼ˆPhysical Address Extensionï¼ŒPAEï¼‰ï¼ŒCPUæ‰§è¡Œå•å…ƒå‘å‡ºçš„åœ°å€å°†è¢«MMUæˆªè·ï¼Œè¿›è¡Œä¸€æ¬¡åœ°å€è½¬æ¢åæ‰ä¼ ç»™å†…å­˜ã€‚è¿™æ ·å…è®¸32ä½ç³»ç»Ÿä¸‹å¤šä¸ªè¿›ç¨‹çš„ä½¿ç”¨å†…å­˜åŠ èµ·æ¥è¶…è¿‡4GBã€‚\nTLBç¡¬ä»¶ä¸€èˆ¬é‡‡ç”¨åˆ†å±‚ç»“æ„ï¼ŒL1éƒ¨åˆ†åˆ†ä¸ºæŒ‡ä»¤TLBä¸æ•°æ®TLBï¼ŒL2ä¸åŒºåˆ†æŒ‡ä»¤ä¸æ•°æ®ï¼Œä½œä¸ºCPUå†…éƒ¨ç¡¬ä»¶ã€‚\nåœ¨åˆ‡æ¢åº”ç”¨åˆ·æ–°æ—¶ï¼Œä¸ºæ¯ä¸ªTLBæ‰“ä¸Šæ ‡ç­¾ï¼ˆåœ¨AArchç§°ä¸ºAddress Space IDentifierï¼ŒASIDï¼›x86-64ä¸­ç§°ä¸ºProcess Context IDentifierï¼‰ï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸€ä¸ªåº”ç”¨åˆ†é…ä¸åŒçš„æ ‡ç­¾ï¼Œè¿™ä¸ªæ ‡ç­¾è®°å½•åœ¨é¡µè¡¨åŸºå€å¯„å­˜å™¨ï¼Œè¿™æ ·TLBçš„ç¼“å­˜é¡¹å°±è¢«åº”ç”¨åŒºåˆ†å¼€ï¼Œåˆ‡æ¢åº”ç”¨æ—¶ä¸ç”¨æ¸…ç©ºTLBã€‚\nåœ¨è™šæ‹Ÿé¡µä½¿ç”¨åï¼Œä¸ä¸€å®šä¼šåœ¨é¡µè¡¨ä¸­ã€‚å½“ç‰©ç†å†…å­˜ä¸å¤Ÿçš„æ—¶å€™ï¼Œåº”è¯¥å°†ç‰©ç†é¡µçš„å†…å®¹å†™å…¥åˆ°ç£ç›˜ä¸­ï¼ŒåŒæ—¶è®°å½•ç‰©ç†é¡µçš„ä½ç½®ï¼Œè¿™ä¸ªæµç¨‹ç§°ä¹‹ä¸ºæ¢å‡ºã€‚\nå½“è®¿é—®æœªæ˜ å°„åˆ°å†…å­˜çš„è™šæ‹Ÿé¡µæ—¶ï¼Œå‘ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œå°†æ‰€æœ‰ç£ç›˜çš„æ•°æ®åŠ åˆ°ç‰©ç†é¡µï¼Œå†å¡«å†™ç‰©ç†é¡µçš„æ˜ å°„ï¼Œè¿™ä¸ªæµç¨‹ç§°ä¸ºæ¢å…¥ã€‚\né¢„å–ï¼ˆPrefetchingï¼‰ï¼šå½“æ¢å…¥æ—¶ï¼ŒçŒœæµ‹è¿˜æœ‰å“ªäº›é¡µä¼šè¢«è®¿é—®ï¼Œæå‰æ¢å…¥å†…å­˜ï¼Œå‡å°‘ç¼ºé¡µæ­¤æ•°ã€‚\næŒ‰éœ€åˆ†é…ï¼ˆDemand Pagingï¼‰ï¼šå°†åˆ†é…çš„è™šæ‹Ÿé¡µæ ‡è®°ä¸ºâ€œå·²ç»åˆ†é…ï¼Œä½†æ˜¯æ²¡æœ‰æ˜ å°„åˆ°ç‰©ç†å†…å­˜â€çš„çŠ¶æ€ï¼Œæœ‰æ•ˆæé«˜èµ„æºåˆ©ç”¨ç‡ã€‚\n4.2. Strategy MIN/OPTï¼ˆMinimumï¼ŒOptimalï¼‰ï¼šä¼˜å…ˆé€‰æ‹©æœªæ¥ä¸ä¼šè®¿é—®çš„é¡µï¼Œç†è®ºæœ€ä¼˜ï¼Œå®è·µå›°éš¾ã€‚\nFIFOï¼ˆFirst-In First-Outï¼‰ï¼šæ—¶é—´å¼€é”€ä½ï¼Œä½†æ˜¯å®é™…è¡¨ç°ä¸ä½³ï¼Œå…ˆåé¡ºåºå’Œä½¿ç”¨é¢‘ç¹å…³ç³»ä¸å¦ä¸å¤§ã€‚\nSecond Chanceï¼šç»™é˜Ÿåˆ—æ¯ä¸€ä¸ªè®¿é—®åˆ°çš„è®¾ç½®æ ‡å¿—ä½ï¼ŒæŒ‰FIFOçš„â€œé€»è¾‘â€ï¼Œæ¯æ¬¡å°†æ¢å‡ºæ—¶ï¼Œæ ‡å¿—æ¸…é›¶ï¼Œå¹¶ç§»åˆ°é˜Ÿå°¾ï¼›å¦‚æœæ²¡æœ‰æ ‡å¿—ï¼Œä¸”åœ¨é˜Ÿå¤´ï¼Œåˆ™ä¼šè¢«æ¢å‡ºã€‚å½“æ‰€æœ‰æ ‡å¿—å¤±æ•ˆæ—¶ï¼Œå¼±åŒ–ä¸ºFIFOã€‚æ­¤å¤–ï¼Œè¿˜æœ‰å¯èƒ½å‘ç”Ÿï¼ˆBeladyå¼‚å¸¸ï¼‰\nLRUï¼ˆLeast Recently Usedï¼‰ï¼šè¢«æ¢å‡ºæ—¶ï¼Œä¼˜å…ˆé€‰æ‹©æœ€ä¹…æœªè¢«è®¿é—®åˆ°çš„ï¼Œé“¾è¡¨å°¾æ”¾æœ€å¸¸ç”¨çš„ï¼Œé¦–ç«¯æ”¾æœ€ä¸å¸¸ç”¨çš„ï¼Œæ¯æ¬¡æ·˜æ±°é¦–ç«¯ã€‚\nMRUï¼ˆMost Recently Usedï¼‰ï¼šç”¨LRUç›¸åçš„ç­–ç•¥ï¼ŒåŸºäºå‡è®¾â€œç¨‹åºä¸ä¼šåå¤è®¿é—®ç›¸åŒçš„åœ°å€â€ã€‚\nClock Algorithmï¼šç±»ä¼¼äºSecond Chanceï¼Œä½†æ˜¯ä¸éœ€è¦ç§»åŠ¨é“¾è¡¨ä¸­çš„é¡µå·ï¼Œæ•ˆç‡æ›´é«˜ã€‚\n4.3. Virtual Memory COWï¼ˆCopy On Writeï¼‰ï¼šç”¨äºåŠ¨æ€é“¾æ¥åº“ï¼Œforkç­‰ã€‚ç”¨åªè¯»çš„æ–¹å¼å…±äº«å†…å­˜ã€‚ä¸€æ—¦å‘ç”Ÿå†™æ“ä½œï¼Œäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œè§¦å‘COWæœºåˆ¶ã€‚\nKSMï¼ˆKernel Same-page Mergingï¼‰ï¼šåŸºäºCOWï¼Œå®šæœŸæ‰«æç›¸åŒçš„ç‰©ç†é¡µï¼Œè¿›è¡Œåˆå¹¶ï¼Œå‡å°‘å†…å­˜å ç”¨ã€‚\nzswapï¼šåœ¨æ¢å‡ºå†…å­˜æ—¶ï¼Œä½¿ç”¨å‹ç¼©ç®—æ³•ï¼Œå°†æ•°æ®å‹ç¼©åï¼Œå­˜æ”¾è‡³ç¼“å†²åŒºï¼Œè€Œä¸ç›´æ¥å­˜ç£ç›˜ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…ç£ç›˜IOã€‚\nbuddy systemï¼šéœ€æ±‚mé¡µæ—¶ï¼Œåˆ†è£‚($2^{n-1}\u0026lt; m â‰¤ 2^n$)è‡³åˆé€‚çš„ç‰©ç†å—ï¼Œé‡Šæ”¾æ—¶åˆå¹¶ç©ºé—²å—ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯çº§è”çš„ï¼Œå‡å°‘å¤–éƒ¨ç¢ç‰‡ã€‚\nSLABï¼šä¸€èˆ¬ä¸ºSLUBï¼ŒSLOBï¼ŒSLABçš„ç»Ÿç§°ã€‚ä¸ºé«˜æ•ˆåˆ†é…è¾ƒå°çš„å†…å­˜å—æé«˜é€Ÿåº¦ï¼ŒSLABåªä¼šåˆ†é…å›ºå®šå¤§å°çš„å†…å­˜å—($2^n$, $3â‰¤ n \u0026lt;12$)ï¼Œå®é™…è¿˜ä¼šæœ‰ç‰¹æ®Šå€¼é¿å…å†…éƒ¨ç¢ç‰‡ï¼Œè¿™äº›å—ç§°ä¸ºslabï¼Œæ¯ä¸ªslabä¼šè¢«åˆ†æˆå°å—ï¼Œç”¨é“¾è¡¨é“¾æ¥ï¼Œå…¶ä¸­currentæŒ‡å‘å½“å‰çš„slabï¼ŒpartialæŒ‡å‘æ‰€æœ‰ç©ºé—²çš„slabï¼Œåˆ†é…æ—¶ï¼Œå…ˆå»currentå–ï¼Œcurrentç©ºäº†å†å–ä¸€ä¸ªpartialçš„slabäº¤ç»™currentã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒLinuxé‡‡ç”¨slabåˆ†é…å™¨åˆ†é…task_structç»“æ„ï¼Œèƒ½å¤Ÿæ›´å¥½å®ç°å¯¹è±¡å¤ç”¨å’Œç¼“å­˜ç€è‰²ã€‚\nImplicit Free Listï¼šæ¯ä¸ªå†…å­˜å—çš„å¤´éƒ¨ï¼Œç”¨é“¾è¡¨ç»´æŠ¤æ˜¯å¦ç©ºé—²ï¼Œå—å¤§å°çš„ä¿¡æ¯ï¼Œåˆ†é…è¯·æ±‚æ—¶ï¼Œä¾æ¬¡åˆå¹¶ã€‚\nExplicit Free Listï¼šä»…ä»…æŠŠç©ºé—²çš„é“¾æ¥èµ·æ¥ï¼Œæ‰€ä»¥æ¯ä¸ªç©ºé—²å—åªç”¨ç»´æŠ¤ä¸¤ä¸ªæŒ‡é’ˆå’Œå—å¤§å°ï¼Œåˆ†é…é€Ÿåº¦æ¯”éšå¼å¿«ã€‚\nSegregated Free Listï¼šç»´æŠ¤å¤šæ¡æ˜¾ç¤ºé“¾è¡¨ï¼Œæ‰¾åˆ°å—å¤§å°æœ€åˆé€‚çš„ç©ºé—²å—ï¼Œæœ‰ç©ºä½™åˆ™æ’å…¥ç©ºé—²é“¾è¡¨ä¸­ã€‚\nCache coloringï¼šä¸åŒä½ç½®çš„ç‰©ç†é¡µæ ‡ä¸Šä¸åŒé¢œè‰²ï¼Œè¿ç»­åˆ†é…å†…å­˜ç‰©ç†é¡µæ—¶ï¼Œä¼˜å…ˆé€‰æ‹©ä¸åŒç‰©ç†é¡µé¢œè‰²çš„è¿›è¡Œåˆ†é…ã€‚\nZero Copy\nä¼ ç»Ÿçš„å†…å­˜è®¿é—®æ–¹å¼ï¼Œå¦‚read/writeï¼Œæ¯æ¬¡æ“ä½œéƒ½éœ€è¦è¿›è¡Œå†…æ ¸æ€ä¸ç”¨æˆ·æ€ä¹‹é—´çš„åˆ‡æ¢ï¼Œread() æŠŠæ•°æ®ä»å­˜å‚¨å™¨ (ç£ç›˜ã€ç½‘å¡ç­‰) è¯»å–åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼Œwrite() åˆ™æ˜¯æŠŠæ•°æ®ä»ç”¨æˆ·ç¼“å†²åŒºå†™å‡ºåˆ°å­˜å‚¨å™¨ï¼š\n1 2 3 4 5 6 #include \u0026lt;unistd.h\u0026gt; // å…¶ä¸­void *bufæŒ‡å‘çš„å†…å­˜ç©ºé—´è¦æ±‚åˆæ³•åˆ¤æ–­ï¼Œä¸ºäº†å®‰å…¨è€ƒè™‘ï¼Œ // å†…æ ¸ä¼šå‘èµ·ä»ç”¨æˆ·å†…å­˜åˆ°å†…æ ¸å†…å­˜çš„æ‹·è´çš„è°ƒç”¨ ssize_t read(int fd, void *buf, size_t count); ssize_t write(int fd, const void *buf, size_t count); ä¸€èˆ¬Linuxé›¶æ‹·è´æœ‰ä¸‰ç§å®ç°æ–¹å¼ï¼š1.å‡å°‘æ‹·è´æ¬¡æ•°ï¼Œ2.ç»•è¿‡å†…æ ¸ç›´æ¥IOï¼Œ3.COWæŠ€æœ¯ï¼ˆåªè¯»åˆ™ä¸ç”¨æ‹·è´ï¼‰\næ–¹æ³•ä¸€ï¼šé‡‡ç”¨mmap+writeï¼Œå¯ä»¥å‡å°‘ä¸€æ¬¡CPUæ‹·è´ï¼ŒèŠ‚çœ50%å†…å­˜ï¼Œé€‚ç”¨äºå¤§æ–‡ä»¶ä¼ è¾“ï¼›å°æ–‡ä»¶åè€Œä¼šé€ æˆæ›´å¤šçš„å†…å­˜ç¢ç‰‡æµªè´¹ã€‚\n1 2 3 4 #include \u0026lt;sys/mman.h\u0026gt; // mmap creates a new mapping in the virtual address space of the calling process. // The starting address for the new mapping is specified in addr. void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset); æ–¹æ³•äºŒï¼šé‡‡ç”¨Linuxå†…æ ¸ç‰ˆæœ¬2.1å¼•å…¥çš„sendfileç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸ºè¿™ç§æ‹·è´å‘ç”Ÿåœ¨å†…æ ¸æ€ï¼Œç›¸æ¯”äºread/writeèŠ‚çœäº†å°†æ•°æ®æ‹·è´è‡³ç”¨æˆ·æ€çš„æ—¶é—´ã€‚\n1 2 3 4 #include \u0026lt;sys/sendfile.h\u0026gt; // sendfile copies data between one file descriptor and another. ssize_t sendfile(int out_fd, int in_fd, off_t *offset, size_t count); æ–¹æ³•ä¸‰ï¼šé‡‡ç”¨Linux å†…æ ¸ç‰ˆæœ¬2.6.17å¼•å…¥çš„spliceç³»ç»Ÿè°ƒç”¨ï¼Œè§£å†³äº†sendfileåªåœ¨ç½‘ç»œåè®®ä¸“ç”¨çš„å¼Šç«¯ï¼Œåœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œä»…ä¼ é€’å†…å­˜é¡µçš„æŒ‡é’ˆè€Œä¸æ˜¯çœŸå®çš„æ•°æ®\n1 2 3 4 5 6 7 #define _GNU_SOURCE /* See feature_test_macros(7) */ #include \u0026lt;fcntl.h\u0026gt; // splice moves data between two file descriptors // without copying between kernel address space and user address space. ssize_t splice(int fd_in, loff_t *off_in, int fd_out, loff_t *off_out, size_t len, unsigned int flags); 5. Process and Thread 5.1. Process è¿›ç¨‹çš„çŠ¶æ€ï¼šæ–°ç”Ÿï¼ˆnewï¼‰ã€å°±ç»ªï¼ˆreadyï¼‰ã€è¿è¡Œï¼ˆrunningï¼‰ã€é˜»å¡ï¼ˆblockedï¼‰ã€ç»ˆæ­¢ï¼ˆterminatedï¼‰ã€‚åœ¨è¿›ç¨‹ç»“æ„ä½“ä¸­çš„stateåŸŸåšäº†æ ‡è®°\næ ‡è®° çŠ¶æ€ TASK_RUNNING æ­£åœ¨æ‰§è¡Œæˆ–è€…æ˜¯è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ TASK_INTERRUPTIBLE è¿›ç¨‹æ­£åœ¨é˜»å¡ï¼Œç­‰å¾…æŸä¸€äº‹ä»¶çš„è¾¾æˆã€‚ TASK_UNINTERRUPTIBLE æ”¶åˆ°ä¿¡å·ä¹Ÿä¸ä¼šè¢«å”¤é†’æˆ–è€…å‡†å¤‡æŠ•å…¥è¿è¡Œã€‚ __TASK_TRACED è¢«å…¶ä»–è·Ÿè¸ªçš„è¿›ç¨‹ï¼ˆå¦‚ptraceï¼‰ __TASK_STOPPED åœæ­¢æ‰§è¡Œï¼Œæ”¶åˆ°SIGSTOPï¼ŒSIGTSPï¼ŒSIGTTINï¼ŒSIGTTOUä¿¡å·å è¿›ç¨‹çš„å†…å­˜ç©ºé—´å¸ƒå±€ï¼šï¼ˆåœ¨/proc/\u0026lt;PID\u0026gt;/mapsæŸ¥çœ‹å¸ƒå±€ï¼‰\nå†…æ ¸éƒ¨åˆ†ï¼šç©ºé—´æœ€é¡¶ç«¯çš„éƒ¨åˆ†ï¼Œåªæœ‰è¿›å…¥å†…æ ¸æ€æ‰å¯è§ã€‚\nç”¨æˆ·æ ˆï¼šè‡ªé¡¶å‘ä¸‹ï¼Œä¿å­˜å„ç§ä¸´æ—¶å˜é‡çš„å€¼ã€‚\nä»£ç åº“ï¼šä¿å­˜ä¾èµ–å…±äº«çš„ä»£ç åº“ï¼Œå¦‚libcç­‰ï¼Œè¿™æ®µæ ‡è®°ä¸ºåªè¯»ã€‚\næ•°æ®ä¸ä»£ç æ®µï¼šè‡ªåº•å‘ä¸Šï¼Œè¿™ä¸ªæ®µç”¨äºä¿å­˜äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŠ è½½æ—¶ä¼šè¢«è½½å…¥è™šæ‹Ÿç©ºé—´ä¸­ã€‚\n1 2 3 4 5 6 #inclue\u0026lt;unistd.h\u0026gt; #inclue\u0026lt;sys/types.h\u0026gt; pid_t fork(void); #inclue\u0026lt;unistd.h\u0026gt; int execve(const char *pathname, char *const argv[], char *const envp[]); exevceä¼šæ ¹æ®pathnameçš„è·¯å¾„ï¼Œå°†æ•°æ®æ®µå’Œä»£ç æ®µåŠ è½½åˆ°å½“å‰è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼Œå†é‡æ–°åˆå§‹åŒ–å †æ ˆå†å°†PCæŒ‡å‘ä»£ç æ®µå®šä¹‰çš„å…¥å£\nè¿›ç¨‹ç›‘æ§ï¼šwait\n1 2 3 4 #include\u0026lt;sys/types.h\u0026gt; #include\u0026lt;sys/wait.h\u0026gt; pid_t waitpid(pid_t pid, int *wstatus, int options); 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 #include\u0026lt;stdio.h\u0026gt; #include\u0026lt;stdlib.h\u0026gt; #include\u0026lt;sys/wait.h\u0026gt; #include\u0026lt;sys/types.h\u0026gt; #include\u0026lt;unistd.h\u0026gt; int main(int argc, char *argv[]) { int rc = fork(); if (rc \u0026lt; 0) { fprintf(stderr, \u0026#34;Fork failed\\n\u0026#34;); } else if (rc == 0) { printf(\u0026#34;ChildProcess: existing\\n\u0026#34;); } else { int status = 0; if (waitpid(rc, \u0026amp;status, 0) \u0026lt; 0) { fprintf(stderr, \u0026#34;Parent process: waitpid failed\u0026#34;); exit(-1); } if (WIFEXITED(status)) { printf(\u0026#34;Parent process: my child has exited\\n\u0026#34;); } else { fprintf(stderr, \u0026#34;Parent process: waitpid returns for unkonwn reasons\u0026#34;); } } return 0; } å¦‚æœçˆ¶è¿›ç¨‹æ²¡æœ‰waitæˆ–è€…æ²¡è¿è¡Œåˆ°åˆ°waitï¼Œå­è¿›ç¨‹ä¸­æ­¢äº†ï¼Œçˆ¶è¿›ç¨‹æœªè¿›è¡Œé€‚å½“å¤„ç†SIGCHLDä¿¡å·ï¼Œå ç”¨çš„èµ„æºä¹Ÿä¸ä¼šé‡Šæ”¾ï¼Œè¢«ç§°ä¸ºåƒµå°¸è¿›ç¨‹ã€‚å†…æ ¸ä¼šä¸ºåƒµå°¸è¿›ç¨‹ä¿ç•™Pidä»¥åŠç»ˆæ­¢æ—¶çš„statusã€‚å¦‚æœçˆ¶è¿›ç¨‹é€€å‡ºäº†ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„ä¿¡æ¯ä¹Ÿä¸ä¼šè¢«çˆ¶è¿›ç¨‹å ç”¨ï¼Œæ‰€æœ‰çš„åƒµå°¸è¿›ç¨‹éƒ½ä¼šè¢«initç”¨waitå›æ”¶ã€‚ï¼ˆå¦‚æœçˆ¶è¿›ç¨‹ä¸é€€å‡ºï¼Œä¸€ç›´æ­»å¾ªç¯ï¼Œé‚£åƒµå°¸è¿›ç¨‹ä¼šè¶Šæ¥è¶Šå¤šï¼‰\nè¿›ç¨‹ç»„ï¼ˆProcess Groupï¼‰ï¼šé»˜è®¤çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œå­è¿›ç¨‹å¯ä»¥setpgid()åˆ›å»ºæ–°è¿›ç¨‹ç»„æˆ–è€…ç§»å…¥å·²æœ‰è¿›ç¨‹ç»„ã€‚åº”ç”¨ç¨‹åºå¯ä»¥killpgå‘é€ä¿¡å·ï¼Œé€šçŸ¥è¿›ç¨‹ç»„çš„æ¯ä¸ªè¿›ç¨‹ã€‚\nä¼šè¯ï¼ˆSessionï¼‰ï¼šè¿›ç¨‹ç»„çš„é›†åˆï¼Œæ ¹æ®æ‰§è¡ŒçŠ¶æ€ï¼Œåˆ†ä¸ºå‰å°è¿›ç¨‹ç»„ï¼ˆforeground thread groupï¼‰ï¼Œå’Œåå°è¿›ç¨‹ç»„ï¼ˆbackground groupï¼‰ã€‚æ§åˆ¶ç»ˆç«¯æ˜¯ä¼šè¯ä¸å¤–ç•Œäº¤äº’çš„ä¸€ä¸ªå…¥å£ã€‚\n1 2 #include\u0026lt;sched.h\u0026gt; int clone(int (fn*)(void *), void *stack, int flags, void *arg, ...); Linuxæ”¯æŒå¯¹cloneè¿›è¡Œæ›´ç²¾å¯†çš„æ§åˆ¶ï¼Œå…è®¸æŒ‡å®šè¿›ç¨‹æ ˆçš„ä½ç½®ã€ç¦æ­¢å¤åˆ¶å†…å­˜ç­‰æ“ä½œã€‚åŒ…æ‹¬éš”ç¦»namespaceç­‰ã€‚\n5.2. Thread Linuxæ“ä½œç³»ç»ŸæŠŠæ‰€æœ‰çš„çº¿ç¨‹éƒ½å½“ä½œè¿›ç¨‹æ¥å®ç°ï¼Œå†…æ ¸å¹¶æ²¡æœ‰å‡†å¤‡ç‰¹åˆ«çš„è°ƒåº¦ç®—æ³•æˆ–è€…å®šä¹‰ç‰¹åˆ«çš„æ•°æ®ç»“æ„æ¥è¡¨å¾çº¿ç¨‹ã€‚ä»…ä»…è¢«è§†ä¸ºä¸å…¶ä»–è¿›ç¨‹åšäº†èµ„æºå…±äº«çš„è¿›ç¨‹ã€‚\nçº¿ç¨‹åˆ†ä¸ºç”¨æˆ·æ€çº¿ç¨‹å’Œå†…æ ¸æ€çº¿ç¨‹ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸‰ç§è°ƒåº¦æ¨¡å‹ï¼š\nç”¨æˆ·å¯¹å†…æ ¸ï¼šå¤šå¯¹ä¸€ï¼Œä¸€å¯¹ä¸€ï¼Œå¤šå¯¹å¤šã€‚æ²¡æœ‰ä¸€å¯¹å¤šï¼ˆå³ä¸€ä¸ªç”¨æˆ·çº¿ç¨‹å¯¹åº”å¤šä¸ªå†…æ ¸çº¿ç¨‹ï¼‰ã€‚\n1 2 3 4 5 6 7 8 #include\u0026lt;pthread.h\u0026gt; int pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine)(void *), void *arg); int pthread_exit(void *retval); int pthread_yield(void); int pthread_join(pthread_t thread, void **retval); çº¿ç¨‹åˆ›å»ºå‡½æ•°æœ€åè¿˜æ˜¯ä¼šè°ƒç”¨cloneï¼Œå…¶ä¸­clone_flagä¸ºCLONE_THREADã€‚\nçº¿ç¨‹é€€å‡ºå‡½æ•°ä¸æ˜¯å¿…è¦çš„ï¼Œé€€å‡ºæ—¶è‡ªåŠ¨ä¼šé€€å‡ºï¼›yieldç”¨äºè®©å‡ºï¼Œä¼šå‘èµ·sched_yieldç³»ç»Ÿè°ƒç”¨ã€‚\nåˆå¹¶æ“ä½œå…è®¸ç­‰å¾…ä¸€ä¸ªçº¿ç¨‹ç»“æŸï¼Œå¹¶ä¿ç•™è¿”å›å€¼ã€‚\n1 2 3 4 #include\u0026lt;unistd.h\u0026gt; unsigned int sleep(unsigned int seconds); int pthread_cond_wait(pthread_t *restrict cond, pthread_mutex_t *restrict mutex); sleepä¼šè®©çº¿ç¨‹æŒ‚èµ·æ•°ç§’ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨cond_waitåœ¨æ¡ä»¶å˜é‡ä¸ºåŒæ­¥æ–¹å¼ç­‰å¾…ã€‚\n6. Operating System Scheduling Long-term Schedulingï¼šå†³å®šå½“å‰çœŸæ­£å¯ä»¥è¢«è°ƒåº¦çš„è¿›ç¨‹æ•°é‡ã€‚\nShort-term Schedulingï¼šè´Ÿè´£è¿›ç¨‹åœ¨å°±ç»ªã€è¿è¡Œã€é˜»å¡ä¸‰ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚\nMidium-term Schedulingï¼šè´Ÿè´£ç®¡ç†å†…å­˜ï¼Œæ¢é¡µæœºåˆ¶ç­‰\nç»å…¸è°ƒåº¦ç­–ç•¥ï¼š\nFIFO/FCFSï¼ˆFirst In First Out / First Come First Serveï¼‰ï¼šåœ¨é•¿çŸ­ä»»åŠ¡æ··åˆçš„æƒ…å†µä¸‹å¯¹çŸ­ä»»åŠ¡ä¸å‹å¥½ã€‚\nSJFï¼ˆShortest Job Firstï¼‰ï¼šè¡¨ç°ä¸¥é‡ä¾èµ–äºä»»åŠ¡åˆ°è¾¾çš„æ—¶é—´ç‚¹ã€‚\nSTCFï¼ˆShortest Time-to-Completion Firstï¼‰ï¼šç›¸æ¯”FIFOå’ŒSJFï¼Œå¼•å…¥preemptiveæœºåˆ¶ï¼Œä½†æ˜¯å¯èƒ½ä¼šå¯¼è‡´é•¿ä»»åŠ¡é¥¥é¥¿ã€‚\nRRï¼ˆRound Robinï¼‰ï¼šåœ¨ä»»åŠ¡è¿è¡Œæ—¶é—´ç›¸ä¼¼çš„æƒ…å†µä¸‹å‘¨è½¬æ—¶é—´å¾ˆé«˜ã€‚\nä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥ï¼š\nMLQï¼ˆMulti-Level Queueï¼‰ï¼šæŒ‰å¤šä¸ªç­‰çº§æ’åˆ—ï¼Œä¸‹ä¸€çº§é˜Ÿåˆ—ä¸ºç©ºåï¼Œå†è°ƒåº¦æ–°çš„ä»»åŠ¡ï¼Œåœ¨æ¯çº§é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ä¸åŒçš„è°ƒåº¦ç­–ç•¥ã€‚ä½†æ˜¯å¯èƒ½é€ æˆä½ä¼˜å…ˆçº§é¥¥é¥¿ï¼ŒåŒæ—¶ï¼Œåœ¨åˆ‡æ¢ä»»åŠ¡æ—¶ï¼Œå‘ç”Ÿé”ç«äº‰ï¼Œå¯èƒ½ä¼šäº§ç”Ÿä¼˜å…ˆçº§åè½¬ã€‚è§£å†³æ–¹æ³•ï¼špriority inheritanceï¼Œå°†è‡ªå·±çš„ä¼˜å…ˆçº§äº¤ç»™ä½çš„ï¼Œç­‰å¾…æ”¾é”åç«‹å³æ‰§è¡Œã€‚\nMLFQï¼ˆMulti-Level Feedback Queueï¼‰ï¼šç›¸åŒä¼˜å…ˆçº§çš„é‡‡ç”¨RRç­–ç•¥ï¼ŒåŒæ—¶çŸ­ä»»åŠ¡æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚å¦‚æœæŸä¸€ä»»åŠ¡è¶…è¿‡é˜Ÿåˆ—å…è®¸è¿è¡Œçš„æœ€å¤§çš„æ—¶é—´ï¼Œåˆ™ä¼˜å…ˆçº§é™ä½ã€‚åŒæ—¶ï¼Œå°†ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é‡‡ç”¨æ›´é•¿çš„æ—¶é—´ç‰‡ï¼Œå®šæ—¶å°†æ‰€æœ‰ä»»åŠ¡çš„ä¼˜å…ˆçº§æè‡³æœ€é«˜ã€‚é‡‡ç”¨è¿™ç§åŠ¨æ€æå‡ä¸é™ä½ï¼ˆBoost and Penaltyï¼‰è¢«åº”ç”¨äºæ—©æœŸçš„Linuxã€‚\nå…¬å¹³å…±äº«è°ƒåº¦ç­–ç•¥ï¼š\nFair-share Schedulingï¼šä»¥ä»½é¢é‡åŒ–CPUæ—¶é—´\nLottery Schedulingï¼šä»¥æŠ½å½©ç¥¨æ•°é‡å†³å®šè¢«è°ƒåº¦çš„æ¦‚ç‡ï¼›ä»½é¢å¤§çš„ä»»åŠ¡å¯ä»¥å½©ç¥¨è½¬è®©ï¼ˆticket transferï¼‰ç»™å°çš„ä»»åŠ¡ï¼›åŒæ—¶å…è®¸ç»™è‡ªå·±çš„å­ä»»åŠ¡ä¸åŒçš„å½©ç¥¨è´§å¸ï¼ˆticket currencyï¼‰é¿å…é¢‘ç¹ä¿®æ”¹ï¼›ä»»åŠ¡å¯ä»¥æ ¹æ®CPUéœ€æ±‚ï¼Œé€šè¿‡å½©ç¥¨é€šèƒ€ï¼ˆticket inflationï¼‰å†³å®šè‡ªå·±çš„è°ƒåº¦ä»½é¢ã€‚\nStride Schedulingï¼šå¼•å…¥è™šæ‹Ÿæ—¶é—´ï¼ˆvirtual runtimeï¼‰ä»¥æ­¥å¹…æ¥å†³å®šè°ƒåº¦ï¼Œä»»åŠ¡ä»½é¢å†³å®šæ­¥å¹…çš„å€’æ•°ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨å€Ÿç”¨è™šæ‹Ÿæ—¶é—´ï¼ˆBorrowed Virtual Runtimeï¼‰ï¼Œä¿è¯å…¬å¹³çš„åŒæ—¶æå‡å®æ—¶æ€§ã€‚\nå¤šæ ¸è°ƒåº¦ç­–ç•¥ï¼š\nLoad Sharingï¼šä»å…¨å±€é˜Ÿåˆ—ä¸­å–ä»»åŠ¡ã€‚åç»­æ·»åŠ äº†ï¼ˆTwo-level Schedulingï¼‰ç­–ç•¥ï¼Œå¼•å…¥äº†æœ¬åœ°é˜Ÿåˆ—ã€‚ Energy Aware Schedulingï¼šå¯¹æ¯ä¸ªCPUçš„å®¹é‡ï¼ŒåŠŸç‡æƒè¡¡ï¼Œåˆ’åˆ†æ€§èƒ½åŸŸï¼Œæ‰¾åˆ°æœ€åˆé€‚çš„æ ¸æ¥è¿è¡Œã€‚ Linux Schedulingï¼š\n2.6.23å¼€å§‹é‡‡ç”¨Complete Fair Schedulingç­–ç•¥ã€‚å°†è°ƒåº¦å™¨å®ä½“å°è£…æˆå¦‚ä¸‹æ•°æ®ç»“æ„\n1 2 3 4 5 6 7 8 9 10 struct sched_entity { struct load_weight load; struct rb_node; struct list_head; unsigned int on_rq; u64 exec_start; u64 sum_exec_time; u64 vruntime; // ... }; Linuxæ“ä½œç³»ç»Ÿå°†vruntimeä½œä¸ºçº¢é»‘æ ‘çš„valueï¼Œåœ¨é€‰æ‹©ä¸‹ä¸€ä¸ªè¿è¡Œè¿›ç¨‹æ—¶ï¼Œåªéœ€è¦æ‰¾åˆ°æœ€å·¦å¶å­ç»“ç‚¹çš„ç¼“å­˜ï¼Œå³åªéœ€è¦O(1)å¤æ‚åº¦ï¼Œè€Œä¸æ˜¯O(logn)ã€‚\n7. Inter-Process Communication ç®¡é“ï¼šä»¥FIFOçš„å½¢å¼ç¼“å†²æ•°æ®ï¼Œæœ‰åŒ¿åç®¡é“ï¼ˆforkåå­è¿›ç¨‹ç»§æ‰¿æ–‡ä»¶æè¿°ç¬¦ï¼‰å’Œå‘½åç®¡é“ï¼ˆmkfifoï¼‰ä¸¤ç§å®ç°æ–¹å¼ã€‚\næ¶ˆæ¯é˜Ÿåˆ—ï¼šå››ä¸ªåŸºæœ¬æ“ä½œï¼šmsggetï¼šè·å–å·²æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—è¿æ¥æˆ–è€…æ–°åˆ›å»ºä¸€ä¸ªï¼Œmsgsndå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸Šå‘æ¶ˆæ¯ï¼Œmsgrcvï¼šæ¥æ”¶æ¶ˆæ¯ï¼ˆæ”¶å‘è¿‡ç¨‹å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—å·²æ»¡æˆ–ä¸ºç©ºï¼Œåˆ™é˜»å¡ï¼‰ï¼Œmsgctlã€‚\nä¿¡å·é‡ï¼šPï¼ˆProbeerï¼Œå°è¯•ï¼‰è®¡æ•°å™¨å‡ä¸€ï¼Œæ“ä½œå¤±è´¥ä¼šè¿›å…¥é˜»å¡ï¼ŒVï¼ˆVerhoogï¼Œå¢åŠ ï¼‰è®¡æ•°å™¨åŠ ä¸€ï¼Œå”¤é†’Pã€‚\nå…±äº«å†…å­˜ï¼šä¸ºéœ€è¦é€šä¿¡çš„è¿›ç¨‹å»ºç«‹å…±äº«åŒºåŸŸï¼Œä¸€æ—¦å»ºç«‹æˆåŠŸï¼Œå°±ä¸å†éœ€è¦å†…æ ¸å‚ä¸è¿›ç¨‹é—´é€šä¿¡ã€‚\nä¿¡å·ï¼šä½¿ç”¨killæˆ–è€…æ˜¯tgkillå‘è¿›ç¨‹æˆ–çº¿ç¨‹å‘é€ä¿¡å·ï¼Œå…¶ä¸­1ï½31ä¸ºå¸¸è§„ä¿¡å·ï¼Œ32ï½64ä¸ºå®æ—¶ä¿¡å·ã€‚å¤„ç†æ—¶æœºé€šå¸¸åœ¨æ‰§è¡Œå®Œå¼‚å¸¸ã€ä¸­æ–­ã€ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ã€‚\nå¥—æ¥å­—ï¼šä½¿ç”¨ç‰¹å®šâ€œåœ°å€â€æ¥æ‰¾åˆ°è¦è°ƒç”¨çš„æœåŠ¡ç«¯è¿›ç¨‹ã€‚\n8. Synchronization Primitives çš®ç‰¹æ£®ç®—æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 while(true) { flag[0] = true; turn = 1; while(flag[1] == true \u0026amp;\u0026amp; turn == 1); do_critical_section(); flag[0] = false; } while(true) { flag[1] = true; turn = 0; while(flag[0] == true \u0026amp;\u0026amp; turn == 0); do_critical_section(); flag[1] = false; } è¦æ±‚è®¿å­˜æ“ä½œä¸¥æ ¼é¡ºåˆ©æ‰§è¡Œã€‚\nåŸå­æ“ä½œï¼šCASï¼ˆCompare And Swapï¼‰ï¼Œä»¥åŠFAAï¼ˆFetch-And-Addï¼‰ã€‚\nIntelå¹³å°é‡‡ç”¨å†…è”æ±‡ç¼–æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œæ¯”è¾ƒexpectedï¼ˆè¿™é‡Œ+aå½“ä½œå¯„å­˜å™¨%eaxï¼‰å’Œaddrçš„å€¼ï¼Œå¦‚æœç›¸ç­‰å°±å­˜å…¥åœ°å€addrä¸­ã€‚\n1 2 3 4 5 6 7 int atomic_CAS(int *addr, int expected, int new_value) { asm volatile(\u0026#34;lock empxchg %[new], %[ptr]\u0026#34; :\u0026#34;+a\u0026#34;(expected), [ptr] \u0026#34;+m\u0026#34;(*addr) :[new] \u0026#34;r\u0026#34;(new_value) :\u0026#34;memory\u0026#34;); return expected; } ARMå¹³å°é‡‡ç”¨Load-Linkå’Œ/Store-Conditionalçš„æŒ‡ä»¤ç»„åˆï¼Œé€šè¿‡CPUç›‘è§†å™¨æ¥å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 int atomic_CAS(int *addr, int expected, int new_value) { int oldval, ret; asm volatile( \u0026#34;1: ldxr %w0, %2\\n\u0026#34; \u0026#34; cmp %w0, %3\\n\u0026#34; \u0026#34; b.ne %2f\\n\u0026#34; \u0026#34; stxr %w1, %w4, %2\\n\u0026#34; \u0026#34;2:\u0026#34; : \u0026#34;=\u0026amp;r\u0026#34; (oldval), \u0026#34;=\u0026amp;r\u0026#34; (ret), \u0026#34;+Q\u0026#34; (*addr) : \u0026#34;r\u0026#34; (expected), \u0026#34;r\u0026#34; (new_value) : \u0026#34;memory\u0026#34;); return oldval; } è‡ªæ—‹é”\n1 2 3 4 5 6 7 8 9 10 11 12 void lock_init(int *lock) { *lock = 0; } void lock(int *lock) { while (atomic_CAS(lock, 0, 1) != 0) ; } void unlock(int *lock) { *lock = 0; } å¹¶ä¸ä¿è¯æœ‰é™ç­‰å¾…ï¼Œå³ä¸å…·æœ‰å…¬å¹³æ€§ï¼Œä¼šé™·å…¥å¾ªç¯ç­‰å¾…ã€‚\næ’å·é”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 struct lock { volatile int owner; volatile int next; } void lock_init(struct lock *lock) { lock-\u0026gt;owner = 0; lock-\u0026gt;next = 0; } void lock(struct lock *lock) { volatile int my_ticket = atomic_FAA(\u0026amp;lock-\u0026gt;next, 1); while (lock-\u0026gt;owner != my_ticket) ; } void unlock(struct lock *lock) { lock-\u0026gt;owner++; } æ¡ä»¶å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 struct cond { struct thread *wait_list; } void cond_wait(struct cond *cond, struct lock *mutex) { list_append(cond-\u0026gt;wait_list, thread_self()); atomic_block_unlock(mutex); // åŸå­æŒ‚èµ·å¹¶é‡Šæ”¾é” lock(mutex); // é‡æ–°è·å¾—äº’æ–¥é” } void cond_signal(struct cond *cond) { if (!list_empty(cond-\u0026gt;wait_list)) { wakeup(list_remove(cond-\u0026gt;wait_list)); } } void cond_broadcast(struct cond *cond) { while (!list_empty(cond-\u0026gt;wait_list)) { wakeup(list_remove(cond-\u0026gt;wait_list)); } } ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œé‡‡ç”¨æ¡ä»¶å˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 int empty_slot = 5; int filled_slot = 0; struct cond empty_cond; struct lock empty_cnt_lock; struct cond filled_cond; struct lock filled_cnt_lock; void producer(void) { int new_msg; while (true) { new_msg = produce_new(); lock(\u0026amp;empty_cnt_lock); while (empty_slot == 0) { cond_wait(\u0026amp;empty_cond, \u0026amp;empty_cnt_lock); } empty_slot--; unlock(\u0026amp;empty_cnt_lock); buffer_add_safe(new_msg); lock(\u0026amp;filled_cnt_lock); filled_slot++; cond_signal(\u0026amp;filled_cond); unlock(\u0026amp;filled_cnt_lock); } } void consumer(void) { int cur_msg; while (true) { lock(\u0026amp;filled_cnt_lock); while (\u0026amp;filled_slot == 0) { cond_wait(\u0026amp;filled_cond, \u0026amp;filled_cnt_lock); } filled_slot--; unlock(\u0026amp;filled_cnt_lock); cur_msg = buffer_remove_safe(); lock(\u0026amp;empty_cnt_lock); empty_slot++; cond_signal(\u0026amp;empty_cond); unlock(\u0026amp;empty_cnt_lock); comsume_msg(cur_msg); } } ä¿¡å·é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 struct sem { int value; int wakeup; struct lock sem_lock; struct cond sem_cond; } void wait(struct sem *S) { lock(\u0026amp;S-\u0026gt;sem_lock); S-\u0026gt;value--; if (S-\u0026gt;value \u0026lt; 0) { do { cond_wait(\u0026amp;S-\u0026gt;sem_cond, \u0026amp;S-\u0026gt;sem_lock); } while(S-\u0026gt;wakeup == 0); S-\u0026gt;wakeup--; } unlock(\u0026amp;S-\u0026gt;sem_lock); } void signal(struct sem *S) { lock(\u0026amp;S-\u0026gt;sem_lock); S-\u0026gt;value++; if (S-\u0026gt;value \u0026lt;= 0) { S-\u0026gt;wakeup++; cond_signal(\u0026amp;S-\u0026gt;sem_cond); } unlock(\u0026amp;S-\u0026gt;sem_lock); } ç”Ÿäº§è€…æ¶ˆè´¹è€…é—®é¢˜ï¼Œé‡‡ç”¨ä¿¡å·é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 sem_t empty_slot; sem_t empty_slot; void producer(void) { int new_msg; while(true) { new_msg = produce_new(); wait(\u0026amp;empty_slot); // P buffer_add_safe(new_msg); signal(\u0026amp;filled_slot); // V } } void consumer(void) { int cur_msg; while(true) { wait(\u0026amp;filled_slot); // P cur_msg = buffer_remove_safe(); signal(\u0026amp;empty_slot); // V consume_msg(cur_msg); } } æ­»é”äº§ç”Ÿçš„åŸå› ï¼š\näº’æ–¥è®¿é—®ã€æŒæœ‰å¹¶ç­‰å¾…ã€èµ„æºéæŠ¢å ã€å¾ªç¯ç­‰å¾… é“¶è¡Œå®¶ç®—æ³•ï¼šå‡è®¾ç³»ç»Ÿæœ‰Mä¸ªèµ„æºï¼ŒNä¸ªçº¿ç¨‹ã€‚\nå…¨å±€å¯åˆ©ç”¨èµ„æºAvailable[M]ï¼Œæ¯ä¸ªçº¿ç¨‹æœ€å¤§éœ€æ±‚Max[N][M]ï¼Œå·²åˆ†é…èµ„æºAllocation[N][M]ï¼Œè¿˜éœ€è¦åˆ†é…çš„èµ„æºNeed[N][M]ã€‚åŒæ—¶ï¼Œä¿è¯ä¾›ç»™å…³ç³»å›ºå®šã€‚çº¿ç¨‹çš„éœ€æ±‚ä¸èƒ½è¶…è¿‡æ€»é‡ï¼Œä»»æ„çº¿ç¨‹åˆ†é…çš„èµ„æºåŠ ä¸Šè¿˜éœ€è¦çš„èµ„æºå°é›¨è¯¥çº¿ç¨‹çš„æœ€å¤§éœ€æ±‚ã€‚çº¿ç¨‹è·å¾—èµ„æºåï¼Œæœ‰é™æ—¶é—´èƒ½å®Œæˆï¼Œå¹¶ä¸”æœ€åä¼šé‡Šæ”¾è¿™äº›èµ„æºã€‚\nä¼˜å…ˆçº§åè½¬é¿å…ï¼šä¼˜å…ˆçº§ç»§æ‰¿åè®®ï¼ˆPriority Inheritance protocolï¼‰ï¼šé«˜ä¼˜å…ˆçº§ç­‰å¾…é”æ—¶ï¼Œä¼šä½¿æŒæœ‰è€…ç»§æ‰¿å…¶ä¼˜å…ˆçº§ï¼Œé¿å…ä¸´ç•ŒåŒºè¢«ä½ä¼˜å…ˆçº§æ‰“æ–­ã€‚\n9. File System Index Nodeï¼šè®°å½•æ–‡ä»¶ç´¢å¼•èŠ‚ç‚¹ï¼ˆå³å­˜å‚¨å—ï¼Œä½¿ç”¨ls -iæŸ¥çœ‹ï¼Œstatï¼‰ï¼Œinodeä¿å­˜ä¸‰å—æŒ‡é’ˆï¼Œä¸€ç§ç›´æ¥æŒ‡å‘æ•°æ®å—ï¼Œä¸€ç§æ˜¯é—´æ¥æŒ‡å‘ä¸€ä¸ªä¸€çº§ç´¢å¼•å—ï¼Œä¸€ç§æ˜¯äºŒçº§æŒ‡é’ˆæŒ‡å‘ä¸€çº§ç´¢å¼•ã€‚\ninodeä¹Ÿä¿å­˜ç€æ–‡ä»¶æ¨¡å¼ã€é“¾æ¥æ•°ã€æ‹¥æœ‰è€…ç”¨æˆ·ç»„ï¼Œå¤§å°ã€è®¿é—®æ—¶é—´ç­‰ä¿¡æ¯ã€‚\nSymbol File type Description - Ordinary or regular files Contain data of various content types such as text, script, image, videos, etc. d Directory files Contain the name and address of other files. b \u0026amp; c Block or character special files Represent device files such as hard drives, monitors, etc. l Link files Point or mirror other files s Socket files Provide inter-process communication p Named pipe files Allow processes to send data to other processes or receive data from other processes. ç›®å½•å¤§å°å³è®°å½•çš„æ–‡ä»¶æ•°é‡ä»¥åŠæ–‡ä»¶åé•¿åº¦çš„å¤§å°ã€‚\næ¯ä¸ªinodeå¯ä»¥è¢«å¤šä¸ªç›®å½•é¡¹æŒ‡å‘ï¼Œè¯¥é“¾æ¥æ•°ä¸º0æ—¶ï¼Œinodeèµ„æºå’Œæ•°æ®å¯ä»¥è¢«é”€æ¯ã€‚\nVirtual File Systemï¼šé€šè¿‡åŸºäºinodeè®¾è®¡äº†ä¸€ç³»åˆ—æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬è¶…çº§å¿«ï¼Œinodeï¼Œç›®å½•é¡¹ç­‰ï¼ŒVFSéšè”½äº†å®ç°ç»†èŠ‚ã€‚\nmountï¼šæ–‡ä»¶è®¿é—®åˆ°æŒ‚è½½ç‚¹ï¼Œå°±ä¼šè·³è½¬åˆ°æŒ‚è½½ç‚¹çš„æ ¹ç›®å½•è®¿é—®ã€‚\nPseudo File Systemï¼ˆSynthetic file systemï¼‰ï¼šå¸¸è§çš„ä¼ªæ–‡ä»¶ç³»ç»Ÿå¦‚/procï¼Œ/sysï¼Œ/sys/kernel/configç­‰ã€‚\n10. Device Management Peripheral Component Interconnectï¼šPCIæ ‡å‡†ï¼Œæ»¡è¶³ç”¨äºPCIæ’æ§½ä¸CPUé«˜æ•ˆé€šä¿¡\nData Memory Accessï¼ŒDMAï¼šè®¾å¤‡ä¸å†…å­˜ä¹‹é—´é«˜æ•ˆæ•°æ®ä¼ è¾“å½¢å¼ã€‚ä¸€èˆ¬æœ‰ä¸‰ä¸ªæµç¨‹\nå¤„ç†å™¨å‘DMAå‘é€è‡³ç¼“å†²åŒºçš„ä½ç½®å’Œé•¿åº¦ï¼Œä»¥åŠæ•°æ®æ–¹å‘ã€‚ DMAè·å¾—æ€»çº¿æ§åˆ¶æƒï¼Œå¯ä»¥ç›´æ¥å’Œå†…å­˜ä¸è®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚ DMAæ§åˆ¶å™¨å°†æ ¹æ®å¤„ç†å™¨è·å¾—çš„å‘½ä»¤ï¼Œå°†è®¾å¤‡æ•°æ®æ‹·è´è‡³å†…å­˜ï¼Œè¿™æœŸé—´å¤„ç†å™¨å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ å®Œæˆåï¼ŒDMAæ§åˆ¶å™¨å‘å¤„ç†å™¨å‘é€ä¸­æ–­ï¼Œæ­¤æ—¶å¤„ç†å™¨é‡æ–°è·å¾—æ€»çº¿çš„æ§åˆ¶æƒã€‚ Generic Interrupt Controllerï¼šARMä¸‹çš„é€šç”¨ä¸­æ–­æ§åˆ¶å™¨ï¼Œè´Ÿè´£å¯¹è®¾å¤‡çš„ä¸­æ–­ä¿¡å·å¤„ç†ã€‚æ¯ä¸ªä¸­æ–­æœ‰å››ç§çŠ¶æ€ï¼š\nInactiveï¼šæ— æ•ˆï¼Œæ­¤æ—¶ä¸­æ–­æœªåˆ°æ¥ã€‚ Pendingï¼šæœ‰æ•ˆçŠ¶æ€ï¼Œä¸­æ–­å·²å‘ç”Ÿï¼ŒCPUæœªå“åº”ä¸­æ–­ã€‚ Activeï¼šCPUå¤„äºå“åº”å¹¶å¤„ç†ä¸­æ–­çš„è¿‡ç¨‹ä¸­ã€‚ Active \u0026amp; Pendingï¼šå¤„ç†ä¸­æ–­æ—¶ï¼Œæœ‰ç›¸åŒçš„ä¸­æ–­å·å‘ç”Ÿã€‚ Linuxæ“ä½œç³»ç»Ÿä¸­ï¼Œä¸­æ–­åˆ†ä¸ºä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ã€‚ä¸ŠåŠéƒ¨å¤„ç†æ—¶ï¼Œå…³é—­ä¸­æ–­ï¼Œåšä¸€äº›ä¸¥æ ¼æœ‰æ—¶é™çš„å·¥ä½œï¼Œå¦‚åº”ç­”å¹¶ä¸”å¤ä½ç¡¬ä»¶ã€‚å®Œæˆåå‘ä¸­æ–­æ§åˆ¶å™¨å£°æ˜ä¸­æ–­å¤„ç†å™¨å¹¶å¼€ä¸­æ–­ï¼Œè®¾å¤‡é©±åŠ¨é€šè¿‡ä»¥ä¸‹å‡½æ•°æ¥æ³¨å†Œ/é‡Šæ”¾ç›¸åº”è®¾å¤‡ç¡¬ä¸­æ–­ã€‚\n1 2 3 4 5 6 7 8 9 typedef irqreturn_t (*irq_headler_t)(int, void *); int request_irq (unsigned int irq, // ä¸åŒè®¾å¤‡çš„ä¸­æ–­å· irq_handler_t handler, // æŒ‡å‘è¿™ä¸ªä¸­æ–­å¤„ç†ç¨‹åºçš„æŒ‡é’ˆ unsigned long flags, // æ ‡å¿—æ©ç ï¼Œå¦‚å…³ä¸­æ–­ç­‰ const char *name, // ä¸­æ–­è®¾å¤‡åç§°çš„çš„ASCIIè¡¨ç¤º void* dev) // å…±äº«ä¸­æ–­æ€»çº¿ï¼Œæ ‡å¿—ä¸­æ–­å¤„ç†ç¨‹åº void free_irq (unsigned int irq, // æ³¨é”€ä¸­æ–­å¤„ç†ç¨‹åºï¼Œé‡Šæ”¾ä¸­æ–­çº¿ void *dev) // å¦‚æœä¸­æ–­æ€»çº¿å…±äº«ï¼Œåˆ™ä»…åˆ é™¤devå¯¹åº”çš„å¤„ç†ç¨‹åº è½¯ä¸­æ–­ï¼šå¤„ç†å‡½æ•°è¦æ±‚æ˜¯å¯é‡å…¥çš„ï¼Œè¦æ±‚è½¯ä¸­æ–­çš„æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥è¢«ç¡¬ä¸­æ–­æŠ¢å ã€‚æ‰€ä»¥ï¼Œè½¯ä¸­æ–­æ—¶åº”è¯¥é¿å…å…¨å±€å˜é‡ï¼Œæˆ–è€…åŠ é”ä¿æŠ¤å…³é”®æ•°æ®ç»“æ„ã€‚Linuxå…±æœ‰10ç§ä¸­æ–­ä¿¡å·ï¼Œä»TASKLET_HIå¾€ä¸‹åŒ…æ‹¬å®šæ—¶å™¨ï¼Œç½‘å¡æ”¶å‘ï¼Œå—è®¾å¤‡ä¸­æ–­ç­‰ã€‚å†…æ ¸ä¼šé€‰æ‹©æ°å½“æ—¶æœºæ¥å¤„ç†è½¯ä¸­æ–­ï¼ˆå¤§å¤šæ•°æ—¶é—´åœ¨ç¡¬ä¸­æ–­å¾—åˆ°å¤„ç†åï¼Œé™¤éCPUè¿˜æŒæœ‰æœªæ‰§è¡Œçš„è½¯ä¸­æ–­ï¼‰ã€‚\n1 2 3 4 5 struct softirq_action { void (*action)(struct softirq_action *); } // è½¯ä¸­æ–­åœ¨ç¼–è¯‘é˜¶æ®µé™æ€åˆ†é…ï¼Œæœ€å¤šåªèƒ½æœ‰32ä¸ª static struct softirq_action softirq_vec[NR_SOFTIRQS]; é€šå¸¸æ ‡è®°äº†è½¯ä¸­æ–­åæ‰§è¡Œçš„åœºæ™¯æœ‰ï¼š1.ä»ç¡¬ä»¶ä¸­æ–­ä»£ç è¿”å›æ—¶ï¼›2.åœ¨ksoftirqdå†…æ ¸çº¿ç¨‹ä¸­ï¼›3.åœ¨é‚£äº›æ˜¾ç¤ºæ£€æŸ¥å’Œæ‰§è¡Œå¾…å¤„ç†çš„è½¯ä¸­æ–­ä»£ç ä¸­ï¼Œå¦‚ç½‘ç»œå­ç³»ç»Ÿã€‚\ntaskletï¼šè½¯ä¸­æ–­åªèƒ½ç¼–è¯‘æ—¶é™æ€åˆ†é…ï¼Œä¸ºäº†åŠ¨æ€åˆ†é…è®¾è®¡äº†taskletï¼Œæ¯ä¸ªtaskletåªæœ‰SCHEDï¼ˆå·²è¢«è°ƒåº¦æœªæ‰§è¡Œï¼‰å’ŒRUNï¼ˆæ­£åœ¨æ‰§è¡Œï¼‰ï¼Œå°†æ‰€æœ‰taskletç”¨é“¾è¡¨ä¸²èµ·æ¥ã€‚æ­¤å¤–taskletä¸å…è®¸å¤šCPUå¹¶å‘æ‰§è¡Œï¼ŒåŒæ—¶ä¿è¯åŸå­æ€§ï¼Œä¸å…è®¸è¢«å…¶ä»–ä¸‹åŠéƒ¨æœºåˆ¶æŠ¢å ï¼Œæ»¡è¶³å¯é‡å…¥æ€§ã€‚\n1 2 3 4 5 6 7 struct tasklet_struct { struct tasklet_strcut *next; // é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªtasklet unsigned long state; // ä¸‰ä¸ªçŠ¶æ€ï¼š0ï¼Œå‡†å¤‡è¿è¡Œï¼Œæ­£åœ¨è¿è¡Œï¼ˆä»…é™å¤šæ ¸ä½œä¸ºä¼˜åŒ–ä½¿ç”¨ï¼‰ atomic_t count; // å¼•ç”¨è®¡æ•°å™¨ void (*func)(unsigned long); // taskletå¤„ç†å‡½æ•° unsigned long data; // ç»™taskletå¤„ç†ç”¨çš„å‚æ•° } Work Queueï¼šæŠŠéœ€è¦æ¨è¿Ÿçš„å‡½æ•°æ”¾åœ¨ä¸‹åŠéƒ¨ï¼Œç”¨å†…æ ¸çº¿ç¨‹æ¥æ‰§è¡Œã€‚Work Queueç”±é©±åŠ¨å¼€å‘è€…è‡ªå·±å®šä¹‰ï¼Œå¹¶ä¸”ç”±äºå…¶æ˜¯ä¸²è¡Œçš„ï¼Œå¯èƒ½äº§ç”Ÿé˜»å¡ï¼Œä¹Ÿä¼šæµªè´¹PIDèµ„æºã€‚\nConcurrency Managed WorkQueueï¼šå°†å·¥ä½œé˜Ÿåˆ—ç®¡ç†è¿˜ç»™å†…æ ¸ï¼ŒåŒä¸€ä¸ªé˜Ÿåˆ—çš„workä¸éµå®ˆä¸²è¡Œï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œï¼Œå¦‚æœæœ‰ä»»åŠ¡é•¿æ—¶é—´è¶³é¢ï¼Œé‚£ä¹ˆCMWQä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹å»å¤„ç†è¯¥ä»»åŠ¡åç»­çš„å·¥ä½œã€‚\n11. System Virtualization CPUè™šæ‹ŸåŒ–ï¼šé€šè¿‡vCPUæŠ½è±¡æ‰§è¡ŒæŒ‡ä»¤ï¼Œç›´æ¥è¿è¡Œåœ¨ç‰©ç†æœºä¸Šï¼Œä½¿ç”¨ç‰©ç†ISAã€‚è™šæ‹Ÿæœºæ¨¡æ‹Ÿä¸€ä¸ªå®‰å…¨çš„ä¸‹é™·çš„è¿‡ç¨‹ã€‚\nå†…å­˜è™šæ‹ŸåŒ–ï¼šä½¿ç”¨å®¢æˆ·ç‰©ç†åœ°å€ä¸ä¸»æœºç‰©ç†åœ°å€ï¼Œå½±å­é¡µè¡¨æœºåˆ¶\nIOè™šæ‹ŸåŒ–ï¼šä¸»å¼•å¯¼è®°å½•ï¼Œå…¨å±€å”¯ä¸€æ ‡è¯†åˆ†åŒºè¡¨ã€‚\n12. Multi-core processor æœ€å°çš„æ“ä½œç²’åº¦ï¼ˆCache Lineï¼‰ï¼šä¸€èˆ¬æ˜¯64å­—èŠ‚ï¼Œé€šå¸¸L1 Cache è¿›ä¸€æ­¥åˆ’åˆ†ä¸ºå•ç‹¬çš„æ•°æ®ç¼“å­˜ï¼ˆData Cacheï¼‰ä¸æŒ‡ä»¤ç¼“å­˜ï¼ˆInstruction Cacheï¼‰ã€‚æ‰€æœ‰æ ¸å¿ƒå…±äº«æœ€æœ«çº§ç¼“å­˜ï¼ˆLast Level Cacheï¼ŒLLCï¼‰ã€‚\nç›´å†™ç­–ç•¥ï¼ˆWrite Throughï¼‰ï¼šåœ¨å†™æ—¶ï¼Œç«‹åˆ»å°†ä¿®æ”¹çš„å€¼åˆ·å›å†…å­˜ï¼ˆè¯¥å€¼ä¼šåŒæ—¶ä¿ç•™åœ¨é«˜é€Ÿç¼“å­˜ä¸­ï¼‰ã€‚\nå†™å›ç­–ç•¥ï¼ˆWrite Backï¼‰ï¼šå°†å€¼æš‚æ—¶å­˜åœ¨é«˜é€Ÿç¼“å­˜ä¸­ã€‚åªæœ‰åœ¨å‡ºç°é«˜é€Ÿç¼“å­˜é€å‡ºï¼ˆCache Evictionï¼‰ï¼Œæˆ–æ˜¯CPU æ ¸å¿ƒè°ƒç”¨å†™å›æŒ‡ä»¤æ—¶ï¼Œä¿®æ”¹æ‰ä¼šè¢«æ›´æ–°è‡³ç‰©ç†å†…å­˜ã€‚\néä¸€è‡´ç¼“å­˜è®¿é—®ï¼ˆNon-Uniform Cache Accessï¼ŒNUCAï¼‰ï¼šä¸åŒæ ¸å¿ƒè®¿é—®æ—¶å»¶ä¼šä¾æ®ç¼“å­˜è¡Œæ‰€åœ¨ä½ç½®æœ‰æ‰€å·®åˆ«ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 var a, b int func main() { go func() { a++ fmt.Println(\u0026#34;b = \u0026#34;, b) }() go func() { b++ fmt.Println(\u0026#34;a = \u0026#34;, a) }() time.Sleep(time.Second) } å†…å­˜ä¸€è‡´æ€§æ¨¡å‹ï¼ˆMemory Consistency Modelï¼Œç®€ç§°ä¸ºå†…å­˜æ¨¡å‹ï¼‰æ˜ç¡®å®šä¹‰äº†ä¸åŒæ ¸å¿ƒå¯¹äºå…±äº«å†…å­˜æ“ä½œéœ€è¦éµå¾ªçš„é¡ºåºã€‚ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹ï¼Œä¸åŒæƒ…å†µä¸‹(a, b)å¯èƒ½çš„å–å€¼èŒƒå›´(0, 0), (1, 0), (0, 1), (1, 1)ä¹Ÿä¼šå‘ç”Ÿæ”¹å˜ã€‚\nä¸¥æ ¼ä¸€è‡´æ€§æ¨¡å‹ï¼ˆStrict Consistencyï¼‰ï¼šæ‰€æœ‰è®¿å­˜æ“ä½œéƒ½æ˜¯ä¸¥æ ¼æŒ‰ç¨‹åºé¡ºåºã€‚\né¡ºåºä¸€è‡´æ€§æ¨¡å‹ï¼ˆSequential Consistencyï¼‰ï¼šä¸åŒæ ¸å¿ƒçœ‹åˆ°çš„è®¿å­˜æ“ä½œé¡ºåºå®Œå…¨ä¸€è‡´ï¼Œè¿™ä¸ªé¡ºåºç§°ä¸ºå…¨å±€é¡ºåºã€‚åœ¨è¿™ç§æ¨¡å‹ä¸‹ï¼Œä¸å¯èƒ½å‡ºç°(a, b)=(0, 0)çš„æƒ…å†µã€‚\nTSOä¸€è‡´æ€§æ¨¡å‹ï¼ˆTotal Store Orderingï¼‰ï¼šä¿è¯å¯¹ä¸åŒåœ°å€ä¸”æ— ä¾èµ–çš„è¯»è¯»ã€è¯»å†™ã€å†™å†™æ“ä½œä¹‹é—´çš„å…¨å±€å¯è§é¡ºåºï¼Œåªæœ‰å†™è¯»çš„å…¨å±€å¯è§é¡ºåºä¸èƒ½å¾—åˆ°ä¿è¯ã€‚é€šè¿‡åŠ å…¥å†™ç¼“å†²æ¥å®ç°è¿™ä¸ªæ“ä½œï¼Œè¿™å…è®¸äº†(0, 0)å¯èƒ½çš„å‡ºç°ã€‚\nPSOä¸€è‡´æ€§æ¨¡å‹ï¼ˆPartial Store Orderingï¼‰ï¼šIs a more relaxed memory consistency model compare to the Total Store Ordering (TSO). PSO is essentially TSO with one additional relaxation to the consistency: PSO only guarantees writes to the same location is in order whereas writes to different memory location may not be in order at all. The processor may rearrange writes so that a sequence of write to memory system may not be in their original order.\nå¼±åºä¸€è‡´æ€§æ¨¡å‹ï¼ˆWeak-ordering Consistencyï¼‰ï¼šä¸ä¿è¯ä»»ä½•ä¸åŒåœ°å€ä¸”æ— ä¾èµ–çš„è®¿å­˜æ“ä½œä¹‹é—´çš„é¡ºåºï¼Œä¹Ÿå³è¯»è¯»ï¼Œè¯»å†™ï¼Œå†™è¯»ä¸å†™å†™æ“ä½œä¹‹é—´éƒ½å¯ä»¥ä¹±åºå…¨å±€å¯è§ã€‚\nè¯»è¯» è¯»å†™ å†™è¯» å†™å†™ ä¸¥æ ¼ä¸€è‡´æ€§æ¨¡å‹ âœ… âœ… âœ… âœ… é¡ºåºä¸€è‡´æ€§æ¨¡å‹ âœ… âœ… âœ… âœ… TSOä¸€è‡´æ€§æ¨¡å‹ âœ… âœ… âŒ âœ… PSOä¸€è‡´æ€§æ¨¡å‹ âœ… âœ… âŒ âœ…ï¼ˆåŒä½ç½®ï¼‰/âŒï¼ˆä¸åŒï¼‰ å¼±åºä¸€è‡´æ€§æ¨¡å‹ âŒ âŒ âŒ âŒ ç¡¬ä»¶å†…å­˜å±éšœï¼ˆBarrier/Fenceï¼Œç®€ç§°å†…å­˜å±éšœï¼‰:\n1 2 3 4 5 6 7 8 9 // Any of these GNU inline assembler statements forbids the GCC compiler // to reorder read and write commands around it: asm volatile (\u0026#34;\u0026#34;:::\u0026#34;memory\u0026#34;); __asm__ __volatile__ (\u0026#34;\u0026#34; ::: \u0026#34;memory\u0026#34;); // This C11/C++11 function forbids the compiler // to reorder read and write commands around it: atomic_signal_fence(memory_order_acq_rel); å¼±é¡ºåºä¸€è‡´æ€§ TSOä¸€è‡´æ€§æ¨¡å‹ é¡ºåºä¸€è‡´æ€§ ä½“ç³»ç»“æ„ ARMï¼ŒPowerPC x86 Dual386ï¼ŒMIPS R10000 ä½¿ç”¨åœºæ™¯ åµŒå…¥å¼ï¼Œæ‰‹æœº/å¹³æ¿ï¼Œé«˜æ€§èƒ½æœåŠ¡å™¨ æ¡Œé¢ç”µè„‘ï¼Œé«˜æ€§èƒ½æœåŠ¡å™¨ å·²è¢«æ·˜æ±° ä¾èµ–å…³ç³»ï¼šæ•°æ®ä¾èµ–ï¼ˆè¦å†™å…¥çš„æŸå€¼ï¼Œä¾èµ–å¦ä¸€ä¸ªè¿è¡Œç»“æœï¼ŒJavaçš„ç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šæ»¡è¶³è¿™ä¸ªä¾èµ–æ€§ï¼‰ï¼›åœ°å€ä¾èµ–ï¼ˆå¦‚å†™æ“ä½œéœ€è¦å†™çš„åœ°å€ä¾èµ–äºè¯»æ“ä½œè¯»å‡ºæ¥çš„å€¼ï¼‰ã€æ§åˆ¶ä¾èµ–ï¼ˆå¦‚å†™æ“ä½œåªæœ‰åœ¨è¯»æ“ä½œç»“æŸåˆ†æ”¯æ»¡è¶³åæ‰èƒ½æ‰§è¡Œï¼‰ã€‚\né‡æ’åºç¼“å†²åŒºï¼ˆRe-Order Buffer, ROBï¼‰ï¼Œè®©æŒ‡ä»¤æŒ‰ç…§ç¨‹åºé¡ºåºé€€å½¹ï¼ˆRetireï¼‰å¯¹åº”é¡ºåºæ‰§è¡Œä¸­çš„æ‰§è¡Œç»“æŸï¼Œå…¶æ„å‘³ç€è¯¥æ¡æŒ‡ä»¤å¯¹ç³»ç»Ÿçš„å½±å“ç»ˆå°†å…¨å±€å¯è§ã€‚\nå­˜å–å•å…ƒï¼ˆLoad/Store Unitï¼ŒLSUï¼‰ä¸­é¢„ç•™äº†è¯»ç¼“å†²åŒºä¸å†™ç¼“å†²åŒºã€‚\né˜¿å§†è¾¾å°”å®šå¾‹ï¼ˆAmdahlâ€™s Lawï¼‰ç”¨ä»¥æè¿°å¹¶è¡Œè®¡ç®—çš„åŠ é€Ÿæ¯”ï¼š$S = \\frac{1}{(1 âˆ’ p) + \\frac{p}{s}}$\nå…¶ä¸­ S æè¿°åŠ é€Ÿæ¯”ï¼Œp ä¸ºç¨‹åºä¸­å¯ä»¥å¹¶è¡Œçš„éƒ¨åˆ†æ‰€å æ¯”ä¾‹ï¼ˆ$0â‰¤pâ‰¤1$ï¼‰ï¼Œè€Œ s ä¸ºå¯ä»¥å¹¶è¡Œéƒ¨åˆ†çš„åŠ é€Ÿæ¯”ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå¦‚æˆ‘ä»¬å¦‚æœæœ‰N ä¸ªæ ¸ï¼Œæ­¤æ—¶çš„å¹¶è¡Œéƒ¨åˆ†åŠ é€Ÿæ¯”ä¸º$s = N$ã€‚\n*. Docker *.1. namespace å®¹å™¨æœ¬èº«ä½œä¸ºå®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œé€šè¿‡namespaceå®ç°èµ„æºéš”ç¦»ï¼Œcgroupså®ç°èµ„æºé™åˆ¶ï¼Œé€šè¿‡copy-on-writeå®ç°äº†é«˜æ•ˆçš„æ–‡ä»¶æ“ä½œã€‚\nnamespace éš”ç¦»æœºåˆ¶ï¼š\nnamespace ç³»ç»Ÿè°ƒç”¨å‚æ•° éš”ç¦»å†…å®¹ UTS CLONE_NEWUTS ä¸»æœºåå’ŒåŸŸå IPC CLONE_NEWIPC ä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜ PID CLONE_NEWPID è¿›ç¨‹ç¼–å· NetWork CLONE_NEWNET ç½‘ç»œè®¾å¤‡ï¼Œç½‘ç»œæ ˆï¼Œç½‘ç»œç«¯å£ç­‰ Mount CLONE_NEWNS æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰ User CLONE_NEWUSER ç”¨æˆ·å’Œç”¨æˆ·ç»„ ç³»ç»Ÿè°ƒç”¨æ–¹å¼ï¼šclone(), setns(), unshare(), ä»¥åŠ/procä¸‹çš„è™šæ‹Ÿæ–‡ä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #inclue\u0026lt;unistd.h\u0026gt; #inclue\u0026lt;sys/types.h\u0026gt; // fork - create a child process // ä¼ ç»Ÿåˆ›å»ºè¿›ç¨‹çš„æ–¹å¼ pid_t fork(void); #include\u0026lt;sched.h\u0026gt; // clone - create a child process // æ˜¯forkæ›´åŠ é€šç”¨çš„å®ç°æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨flagæ¥å®ç°åŠŸèƒ½ã€‚ int clone(int (fn*)(void *), void *stack, int flags, void *arg, ...); // setns - reassociate thread with a namespace // åŠ å…¥ç°æœ‰çš„namespaceä¸­ int setns(int fd, int nstype); // setns - reassociate thread with a namespace // åœ¨åŸè¿›ç¨‹ä¸Šè¿›è¡Œnamespaceéš”ç¦» int unshare(int flags); // Dockerå¹¶æœªé‡‡ç”¨ UTS(Unix Time-haring System) namespace: æä¾›äº†ä¸»æœºå’ŒåŸŸåçš„éš”ç¦»ï¼Œè¿™æ ·æ¯ä¸ªå®¹å™¨ä¾¿å¯ä»¥è§†ä½œç‹¬ç«‹èŠ‚ç‚¹è€Œéå®¿ä¸»æœºä¸Šçš„ä¸€ä¸ªè¿›ç¨‹ã€‚\nIPC(Inter-Process Communication) namespace: ä¸»è¦åŒ…æ‹¬å¸¸è§çš„ä¿¡å·é‡ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜ã€‚ç”³è¯·IPCå…¶å®å°±æ˜¯ç”³è¯·äº†å…¨å±€å”¯ä¸€çš„32ä½IDã€‚IPC namespaceå®é™…ä¸Šå°±åŒ…å«äº†ç³»ç»Ÿçš„IPCæ ‡è¯†ç¬¦ä»¥åŠå®ç°äº†POSIXæ¶ˆæ¯é˜Ÿåˆ—çš„æ–‡ä»¶ç³»ç»Ÿã€‚ä¸åŒçš„IPC namespaceä¸‹çš„è¿›ç¨‹ä¹‹é—´ä¸å¯è§ã€‚\nPID(Process ID) namespace: å¯¹è¿›ç¨‹çš„PIDè¿›è¡Œé‡å†™ï¼Œä¸åŒnamespaceä¸‹çš„è¿›ç¨‹å¯ä»¥æ‹¥æœ‰ç›¸åŒçš„PIDï¼Œæ‰€æœ‰PID namespaceç»´æŒä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚å…¶ä¸­initè¿›ç¨‹å…·æœ‰å±è”½æƒé™ï¼Œä¸€æ—¦initè¢«é”€æ¯ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªnamespaceä¸‹çš„PIDéƒ½ä¼šæ”¶åˆ°SIGKILLè€Œè¢«æ€æ­»\nmount namespace: æ˜¯å†å²ä¸Šç¬¬ä¸€ä¸ªnamespaceï¼Œæ‰€ä»¥æ ‡å¿—ä½æ¯”è¾ƒç‰¹æ®Šï¼Œå°±æ˜¯CLONE_NEWNSã€‚éš”ç¦»ä»¥åï¼Œä¸åŒnamespaceä¸‹çš„æ–‡ä»¶å°†ä¸å—å½±å“ã€‚\nåœ¨2006å¹´å¼•å…¥äº†æŒ‚è½½ä¼ æ’­(mount propagation)æœºåˆ¶ï¼Œä½¿å¾—æŒ‚è½½å¯ä»¥å®šä¹‰æŒ‚è½½å¯¹è±¡ä¹‹é—´çš„å…³ç³»ï¼Œå†³å®šäº†äº‹ä»¶å¦‚ä½•ä¼ æ’­åˆ°å…¶ä»–æŒ‚è½½çš„å¯¹è±¡ã€‚åŒ…æ‹¬ï¼šå…±äº«(share)ï¼Œä»å±(slave)ï¼Œå…±äº«/ä»å±(share and slave)ï¼Œç§æœ‰(private)ï¼Œä¸å¯ç»‘å®š(unbinable)ï¼Œå…±äº”ç§ã€‚\nnetwork namespace: æä¾›äº†ç½‘ç»œèµ„æºçš„éš”ç¦»ï¼ŒåŒ…æ‹¬ç½‘ç»œè®¾å¤‡ã€IPv4/IPv6åè®®æ ˆã€IPè·¯ç”±è¡¨ã€é˜²ç«å¢™ï¼Œ/proc/netç›®å½•ï¼Œ/sys/class/netç›®å½•ä»¥åŠsocketç­‰ã€‚ä¸€ä¸ªç‰©ç†çš„ç½‘ç»œè®¾å¤‡åªèƒ½å¤„äºä¸€ä¸ªnetwork namespaceä¸­ï¼Œé€šè¿‡åˆ›å»ºveth pairåˆ›å»ºé€šé“ä»¥è¾¾åˆ°é€šä¿¡ç›®çš„ã€‚\nåœ¨å»ºç«‹ç½‘æ¡¥ä¹‹å‰ï¼Œæ–°æ—§namespaceé€šè¿‡å»ºç«‹pipeï¼Œinitåœ¨pipeä¸€æ®µå¾ªç¯ç­‰å¾…ï¼Œç›´åˆ°ç®¡é“å¦ä¸€è¾¹ä¼ æ¥vethçš„ä¿¡æ¯ï¼Œinitæ‰ç»“æŸç­‰å¾…ã€‚\nuser namespace: ç›´åˆ°Linuxå†…æ ¸3.8å¼€å§‹éƒ½æœªå®Œå…¨å®ç°ï¼Œè¿˜æœ‰éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿæœªæ”¯æŒã€‚è®¾è®¡ä¸»è¦éš”ç¦»äº†å®‰å…¨ç›¸å…³çš„æ ‡è¯†ç¬¦(identifier)å’Œå±æ€§(attribute)ï¼ŒåŒ…æ‹¬ç”¨æˆ·IDï¼Œç”¨æˆ·ç»„IDï¼Œrootç›®å½•ï¼Œkeyï¼ˆå¯†é’¥ï¼‰ä»¥åŠç‰¹æ®Šæƒé™ã€‚Dockeråœ¨1.10å¼€å§‹æ‰æ”¯æŒuser namespaceï¼Œå¯åŠ¨daemonæ—¶æŒ‡å®šuserns-remapï¼Œåˆ™å®¹å™¨å†…çš„rootå°†ä¸å†ç­‰äºå®¿ä¸»æœºå†…çš„rootã€‚\nnamespace çš„æ ¸å¿ƒå®é™…ä¸Šæ˜¯é€šè¿‡å±‚æ¬¡å…³è”èµ·æ¥ï¼Œæ¯ä¸ªnamespaceéƒ½æºè‡ªäºroot namespaceçš„æ˜ å°„ã€‚\n*.2. cgroups cgroupsï¼šé™åˆ¶è¢«namespaceéš”ç¦»èµ·æ¥çš„èµ„æºï¼Œè¿˜å¯ä»¥ä¸ºèµ„æºè®¾ç½®æƒé‡ã€è®¡ç®—ä½¿ç”¨é‡ã€æ“æ§ä»»åŠ¡ï¼ˆè¿›ç¨‹æˆ–çº¿ç¨‹ï¼‰å¯åœç­‰ã€‚\ncgroupsæ˜¯Linuxå†…æ ¸æä¾›çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶å¯ä»¥æ ¹æ®éœ€æ±‚æŠŠä¸€ç³»åˆ—ç³»ç»Ÿä»»åŠ¡åŠå…¶å­ä»»åŠ¡æ•´åˆï¼ˆæˆ–åˆ†éš”ï¼‰åˆ°æŒ‰èµ„æºåˆ’åˆ†ç­‰çº§çš„ä¸åŒç»„å†…ï¼Œä»è€Œä¸ºç³»ç»Ÿèµ„æºç®¡ç†æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¡†æ¶ã€‚cgroupsçš„å®ç°æœ¬è´¨ä¸Šæ˜¯ç»™ä»»åŠ¡æŒ‚ä¸Šé’©å­ï¼Œå½“ä»»åŠ¡è¿è¡Œçš„è¿‡ç¨‹ä¸­æ¶‰åŠæŸç§èµ„æºæ—¶ï¼Œå°±ä¼šè§¦å‘é’©å­ä¸Šæ‰€é™„å¸¦çš„å­ç³»ç»Ÿè¿›è¡Œæ£€æµ‹\ncgroupsä¸ºäº†ä¸åŒç”¨æˆ·å±‚é¢çš„ç®¡ç†èµ„æºï¼Œå¹¶æä¾›ç»Ÿä¸€åŒ–çš„æ¥å£ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å››ä¸ªåŠŸèƒ½ï¼š\nèµ„æºé™åˆ¶ï¼šcgroupså¯ä»¥å¯¹èµ„æºçš„æ€»å’Œè¿›è¡Œé™åˆ¶ï¼Œå½“è¶…è¿‡ä¸Šé™å³è§¦å‘OOMã€‚ ä¼˜å…ˆçº§åˆ†é…ï¼šåˆ†é…CPUåˆ†å¾—çš„æ—¶é—´ç‰‡ä»¥åŠç£ç›˜I/Oå¸¦å®½ï¼Œå†³å®šå…¶ä¼˜é™çº§ã€‚ èµ„æºç»Ÿè®¡ï¼šç»Ÿè®¡å†…å­˜ä½¿ç”¨æ—¶é•¿ï¼ŒCPUä½¿ç”¨é‡ç­‰ã€‚ ä»»åŠ¡æ§åˆ¶ï¼šå®ç°ä»»åŠ¡æŒ‚èµ·ï¼Œæ¢å¤ç­‰æ“ä½œã€‚ é•œåƒåˆ†å±‚ï¼šæ¯ä¸ªé•œåƒéƒ½ç”±ä¸€ç³»åˆ—é•œåƒå±‚æ„æˆï¼Œé‡‡ç”¨COWæœºåˆ¶ï¼Œå¹¶æ ¹æ®æ–‡ä»¶å†…å®¹ç´¢å¼•é•œåƒå’Œé•œåƒå±‚ã€‚è”åˆæŒ‚è½½æŠ€æœ¯å¯ä»¥åœ¨ä¸€ä¸ªæŒ‚è½½ç‚¹åŒæ—¶æŒ‚è½½å¤šä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå°†æŒ‚è½½ç‚¹çš„åŸç›®å½•ä¸è¢«æŒ‚è½½å†…å®¹è¿›è¡Œæ•´åˆï¼Œä½¿å¾—æœ€ç»ˆå¯è§çš„æ–‡ä»¶ç³»ç»Ÿå°†ä¼šåŒ…å«æ•´åˆä¹‹åçš„å„å±‚çš„æ–‡ä»¶å’Œç›®å½•ã€‚\nOverlayFSæ˜¯ä¸€ç§æ–°å‹è”åˆæ–‡ä»¶ç³»ç»Ÿï¼ˆunion filesystemï¼‰ï¼ŒLinuxå†…æ ¸ç‰ˆæœ¬3.18å¼€å§‹æ”¯æŒï¼Œå®ƒå…è®¸ç”¨æˆ·å°†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸å¦ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿé‡å ï¼ˆoverlayï¼‰ï¼Œåœ¨ä¸Šå±‚çš„æ–‡ä»¶ç³»ç»Ÿä¸­è®°å½•æ›´æ”¹ï¼Œè€Œä¸‹å±‚çš„æ–‡ä»¶ç³»ç»Ÿä¿æŒä¸å˜ã€‚\nlibnetworkï¼šåœ¨Dockerçš„æ¡¥æ¥ç½‘ç»œæ¨¡å¼ä¸­ï¼Œdocker0çš„IPåœ°å€ä½œä¸ºè¿äºä¹‹ä¸Šçš„å®¹å™¨çš„é»˜è®¤ç½‘å…³åœ°å€å­˜åœ¨ã€‚\nBridgeé©±åŠ¨ï¼šé»˜è®¤æ–¹å¼ï¼ŒContainerä¼šæ¥åˆ°Dockerç½‘æ¡¥ä¸Šï¼Œä¸å¤–ç•Œé€šä¿¡é‡‡ç”¨NATï¼Œå¢åŠ äº†é€šä¿¡å¤æ‚æ€§ã€‚ hosté©±åŠ¨ï¼šä¸åˆ›å»ºé»˜è®¤çš„namespaceï¼Œä½¿ç”¨å®¿ä¸»æœºçš„ç½‘å¡ã€IPå’Œç«¯å£ï¼Œé¿å…äº†åœ°å€è½¬æ¢é—®é¢˜ã€‚ overlayé©±åŠ¨ï¼šé‡‡ç”¨IETFçš„VXLANæ–¹å¼ï¼Œé€‚åˆå¤§è§„æ¨¡çš„äº‘è®¡ç®—è™šæ‹ŸåŒ–SDN controlleræ¨¡å¼ï¼Œä½†æ˜¯éœ€è¦é¢å¤–é…ç½®æœåŠ¡ï¼Œå¦‚Consulï¼Œetcdå’ŒZooKeeperç­‰ï¼Œåœ¨å¯åŠ¨æ—¶æ·»åŠ å‚æ•° remoteé©±åŠ¨ï¼šæ²¡æœ‰ä½¿ç”¨çœŸæ­£çš„ç½‘ç»œæœåŠ¡å‘ç°ï¼Œè°ƒç”¨äº†ç”¨æˆ·è‡ªå·±çš„ç½‘ç»œé©±åŠ¨æ’ä»¶ã€‚ nullé©±åŠ¨ï¼šContaineræœ‰è‡ªå·±çš„namespaceï¼Œä½†æ˜¯ä¸ä¼šåšä»»ä½•ç½‘ç»œç›¸å…³çš„é…ç½®ã€‚ ","date":"2021-11-12T19:33:04+08:00","image":"https://chasing1020.github.io/post/operating-system/unix_hufdf70b6f514bae07260de36dd194916b_17388_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/operating-system/","title":"Operating System"},{"content":"Kubernetes åœºæ™¯ï¼šç®¡ç†å®¹å™¨åŒ–çš„å·¥ä½œè´Ÿè½½å’ŒæœåŠ¡ï¼Œå¯ä¿ƒè¿›å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒ–\nåŠŸèƒ½ï¼šæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€å­˜å‚¨ç¼–æ’ã€è‡ªåŠ¨éƒ¨ç½²å’Œå›æ»šã€è‡ªåŠ¨å®Œæˆè£…ç®±è®¡ç®—ã€è‡ªæˆ‘ä¿®å¤ã€å¯†é’¥ä¸é…ç½®ç®¡ç†\n1. Component ä¸€ä¸ª Kubernetes é›†ç¾¤ç”±ä¸€ç»„è¢«ç§°ä½œèŠ‚ç‚¹çš„æœºå™¨ç»„æˆã€‚è¿™äº›èŠ‚ç‚¹ä¸Šè¿è¡Œ Kubernetes æ‰€ç®¡ç†çš„å®¹å™¨åŒ–åº”ç”¨ã€‚é›†ç¾¤å…·æœ‰è‡³å°‘ä¸€ä¸ªå·¥ä½œèŠ‚ç‚¹ã€‚\nå·¥ä½œèŠ‚ç‚¹æ‰˜ç®¡ä½œä¸ºåº”ç”¨è´Ÿè½½çš„ç»„ä»¶çš„ Pod ã€‚æ§åˆ¶å¹³é¢ç®¡ç†é›†ç¾¤ä¸­çš„å·¥ä½œèŠ‚ç‚¹å’Œ Pod ã€‚ ä¸ºé›†ç¾¤æä¾›æ•…éšœè½¬ç§»å’Œé«˜å¯ç”¨æ€§ï¼Œè¿™äº›æ§åˆ¶å¹³é¢ä¸€èˆ¬è·¨å¤šä¸»æœºè¿è¡Œï¼Œé›†ç¾¤è·¨å¤šä¸ªèŠ‚ç‚¹è¿è¡Œã€‚\n1.1. Control Plane Components æ§åˆ¶é¢æ¿ç”¨äºæ§åˆ¶æ•´ä¸ªé›†ç¾¤çš„å·¥ä½œï¼Œå…¶åŒ…å«å¤šä¸ªç»„ä»¶ï¼Œå¯ä»¥è¿è¡Œåœ¨å•ä¸ªä¸»æœºä¸Šæˆ–è€…é€šè¿‡å‰¯æœ¬åˆ†åˆ«ä¸æ˜¯åœ¨å¤šä¸ªä¸»èŠ‚ç‚¹ç”¨ä»¥ç¡®ä¿é«˜å¯ç”¨\nkube-apiserver API æœåŠ¡å™¨æ˜¯ Kubernetes æ§åˆ¶é¢çš„ç»„ä»¶ï¼Œ è¯¥ç»„ä»¶å…¬å¼€äº† Kubernetes APIã€‚ API æœåŠ¡å™¨æ˜¯ Kubernetes æ§åˆ¶é¢çš„å‰ç«¯ã€‚\netcd etcd æ˜¯å…¼å…·ä¸€è‡´æ€§å’Œé«˜å¯ç”¨æ€§çš„é”®å€¼æ•°æ®åº“ï¼Œå¯ä»¥ä½œä¸ºä¿å­˜ Kubernetes æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚\nkube-scheduler æ§åˆ¶å¹³é¢ç»„ä»¶ï¼Œè´Ÿè´£ç›‘è§†æ–°åˆ›å»ºçš„ã€æœªæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹ï¼ˆnodeï¼‰çš„ Podsï¼Œé€‰æ‹©èŠ‚ç‚¹è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚\nkube-controller-manager ä»é€»è¾‘ä¸Šè®²ï¼Œæ¯ä¸ªæ§åˆ¶å™¨éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œ ä½†æ˜¯ä¸ºäº†é™ä½å¤æ‚æ€§ï¼Œå®ƒä»¬éƒ½è¢«ç¼–è¯‘åˆ°åŒä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¹¶åœ¨ä¸€ä¸ªè¿›ç¨‹ä¸­è¿è¡Œã€‚\nèŠ‚ç‚¹æ§åˆ¶å™¨ï¼ˆNode Controllerï¼‰: è´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº” ä»»åŠ¡æ§åˆ¶å™¨ï¼ˆJob controllerï¼‰: ç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶ååˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ ç«¯ç‚¹æ§åˆ¶å™¨ï¼ˆEndpoints Controllerï¼‰: å¡«å……ç«¯ç‚¹(Endpoints)å¯¹è±¡(å³åŠ å…¥ Service ä¸ Pod) æœåŠ¡å¸æˆ·å’Œä»¤ç‰Œæ§åˆ¶å™¨ï¼ˆService Account \u0026amp; Token Controllersï¼‰: ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ cloud-controller-manager äº‘æ§åˆ¶å™¨ç®¡ç†å™¨æ˜¯æŒ‡åµŒå…¥ç‰¹å®šäº‘çš„æ§åˆ¶é€»è¾‘çš„ æ§åˆ¶å¹³é¢ç»„ä»¶ã€‚ äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ä½¿å¾—ä½ å¯ä»¥å°†ä½ çš„é›†ç¾¤è¿æ¥åˆ°äº‘æä¾›å•†çš„ API ä¹‹ä¸Šï¼Œ å¹¶å°†ä¸è¯¥äº‘å¹³å°äº¤äº’çš„ç»„ä»¶åŒä¸ä½ çš„é›†ç¾¤äº¤äº’çš„ç»„ä»¶åˆ†ç¦»å¼€æ¥ã€‚ cloud-controller-manager ä»…è¿è¡Œç‰¹å®šäºäº‘å¹³å°çš„æ§åˆ¶å›è·¯ã€‚ å¦‚æœä½ åœ¨è‡ªå·±çš„ç¯å¢ƒä¸­è¿è¡Œ Kubernetesï¼Œæˆ–è€…åœ¨æœ¬åœ°è®¡ç®—æœºä¸­è¿è¡Œå­¦ä¹ ç¯å¢ƒï¼Œ æ‰€éƒ¨ç½²çš„ç¯å¢ƒä¸­ä¸éœ€è¦äº‘æ§åˆ¶å™¨ç®¡ç†å™¨ã€‚\n1.2. Node Component kubelet ä¸€ä¸ªåœ¨é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰ä¸Šè¿è¡Œçš„ä»£ç†ã€‚ å®ƒä¿è¯å®¹å™¨ï¼ˆcontainersï¼‰éƒ½ è¿è¡Œåœ¨ Pod ä¸­ã€‚\nkubelet æ¥æ”¶ä¸€ç»„é€šè¿‡å„ç±»æœºåˆ¶æä¾›ç»™å®ƒçš„ PodSpecsï¼Œç¡®ä¿è¿™äº› PodSpecs ä¸­æè¿°çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ä¸”å¥åº·ã€‚ kubelet ä¸ä¼šç®¡ç†ä¸æ˜¯ç”± Kubernetes åˆ›å»ºçš„å®¹å™¨ã€‚\nkube-proxy kube-proxy æ˜¯é›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç½‘ç»œä»£ç†ï¼Œ å®ç° Kubernetes æœåŠ¡ï¼ˆServiceï¼‰ æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£ç»„ä»¶ä¹‹é—´çš„è´Ÿè½½å‡è¡¡ç½‘ç»œæµé‡ã€‚\nkube-proxy ç»´æŠ¤èŠ‚ç‚¹ä¸Šçš„ç½‘ç»œè§„åˆ™ã€‚è¿™äº›ç½‘ç»œè§„åˆ™å…è®¸ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¼šè¯ä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚\nContainer Runtime å®¹å™¨è¿è¡Œç¯å¢ƒæ˜¯è´Ÿè´£è¿è¡Œå®¹å™¨çš„è½¯ä»¶ã€‚\nKubernetes æ”¯æŒå¤šä¸ªå®¹å™¨è¿è¡Œç¯å¢ƒ: Dockerã€ containerdã€CRI-O ä»¥åŠä»»ä½•å®ç° Kubernetes CRI (å®¹å™¨è¿è¡Œç¯å¢ƒæ¥å£)ã€‚\n1.3. Objects åœ¨ Kubernetes ç³»ç»Ÿä¸­ï¼ŒKubernetes å¯¹è±¡ æ˜¯æŒä¹…åŒ–çš„å®ä½“ã€‚ Kubernetes ä½¿ç”¨è¿™äº›å®ä½“å»è¡¨ç¤ºæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ã€‚ç‰¹åˆ«åœ°ï¼Œå®ƒä»¬æè¿°äº†å¦‚ä¸‹ä¿¡æ¯ï¼š\nå“ªäº›å®¹å™¨åŒ–åº”ç”¨åœ¨è¿è¡Œï¼ˆä»¥åŠåœ¨å“ªäº›èŠ‚ç‚¹ä¸Šï¼‰ å¯ä»¥è¢«åº”ç”¨ä½¿ç”¨çš„èµ„æº å…³äºåº”ç”¨è¿è¡Œæ—¶è¡¨ç°çš„ç­–ç•¥ï¼Œæ¯”å¦‚é‡å¯ç­–ç•¥ã€å‡çº§ç­–ç•¥ï¼Œä»¥åŠå®¹é”™ç­–ç•¥ 2. Minikube Quick Start 1 2 3 4 5 6 curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 sudo install minikube-linux-amd64 /usr/local/bin/minikube minikube start minikube dashboard åœ¨æµè§ˆå™¨å‡ºç°minikubeä»ªè¡¨ç›˜å³å®‰è£…æˆåŠŸã€‚\nä½¿ç”¨ kubectl create å‘½ä»¤åˆ›å»ºç®¡ç† Pod çš„ Deploymentã€‚è¯¥ Pod æ ¹æ®æä¾›çš„ Docker é•œåƒè¿è¡Œ Containerã€‚\n1 kubectl create deployment hello-node --image=k8s.gcr.io/echoserver:1.4 æŸ¥çœ‹ Deploymentï¼š\n1 kubectl get deployments æŸ¥çœ‹ Podï¼š\n1 kubectl get pods è¾“å‡ºç»“æœç±»ä¼¼äºè¿™æ ·ï¼š\n1 2 NAME READY STATUS RESTARTS AGE hello-node-5f76cf6ccf-br9b5 1/1 Running 0 1m æ¯å½“è¿è¡Œkubectlæ—¶ï¼Œå³åƒRESTAPIæœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œåˆ›å»ºPodå¹¶ä¸”è°ƒåº¦åˆ°å·¥ä½œèŠ‚ç‚¹ï¼Œkubetletæ”¶åˆ°é€šçŸ¥ï¼Œå†å»å‘Šè¯‰Dockerè¿è¡Œé•œåƒ\n3. Pod 3.1. Basic Podä½œä¸ºä¸€ç»„å¹¶ç½®çš„å®¹å™¨ï¼Œä»£è¡¨äº†k8sä¸­çš„åŸºæœ¬æ„å»ºæ¨¡å‹ï¼Œä¸€ä¸ªPodçš„æ‰€æœ‰å®¹å™¨åªèƒ½è¿è¡Œåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚\næ— è®ºæ˜¯IPCè¿˜æ˜¯æœ¬åœ°æ–‡ä»¶é€šä¿¡ï¼Œåœ¨ä¸€ä¸ªç‹¬ç«‹æœºå™¨ä¸Šæ˜¾å¾—ååˆ†åˆç†ã€‚\nåŒä¸€ä¸ªPodä¸‹çš„æ‰€æœ‰å®¹å™¨å…±äº«Linuxçš„namespaceä¸network interfaceï¼Œå› æ­¤å¯ä»¥é€šè¿‡IPCè¿›è¡Œé€šä¿¡ã€‚åŒä¸€ä¸ªPodä¸‹çš„ç«¯å£å·ä¼šå‘ç”Ÿå†²çªï¼Œä½†æ˜¯ä¸€ä¸ªPodä¸­çš„æ‰€æœ‰å®¹å™¨ä¹Ÿæœ‰ç›¸åŒçš„loopbackç½‘ç»œæ¥å£ï¼Œå³å¯ä»¥ä½¿ç”¨localhostä¸å…¶ä»–å®¹å™¨è¿›è¡Œé€šä¿¡ã€‚åœ¨Podä¹‹é—´éƒ½åœ¨ä¸€ä¸ªå…±äº«çš„ç½‘ç»œåœ°å€ç©ºé—´ä¸­ï¼Œå³ä¸éœ€è¦ç»è¿‡NATè½¬æ¢ã€‚\nPodå¸¸ç”¨çš„å‘½ä»¤\n1 2 3 4 5 6 7 8 kubectl explain pods kubetcl create -f xx.yaml kubectl get po xx -o json kubectl delete po xx kubectl logs xx kubectl port-forward xx 8888:8080 kubetcl get ns kubectl create namespace mynamespace é€šè¿‡yamlå®šä¹‰çš„Podï¼ŒåŒ…å«metadataï¼šåç§°å‘½åç©ºé—´ï¼Œæ ‡ç­¾ï¼›specï¼šPodå®é™…è¯´æ˜ï¼ŒåŒ…æ‹¬å®¹å™¨ï¼Œæ•°æ®å·ç­‰ï¼›statusï¼šPodå½“å‰ä¿¡æ¯ï¼Œæ‰€å¤„æ¡ä»¶ï¼Œå®¹å™¨çŠ¶æ€ã€‚\næ­¤å¤–ï¼Œè¿˜å¯ä»¥æ‰‹åŠ¨ç»™Podæ·»åŠ æ ‡ç­¾ï¼Œæ¯ä¸€ä¸ªPodæœ‰ä¸¤ç§æ ‡ç­¾ï¼Œåœ¨yamlçš„metadataå¤„ä¸ºPodé™„åŠ æ ‡ç­¾\nappï¼šæŒ‡å®šappå±äºå“ªä¸ªåº”ç”¨ã€ç»„å»ºæˆ–è€…å¾®æœåŠ¡\nrelï¼šæ˜¾ç¤ºPodè¿è¡Œåº”ç”¨ç¨‹åºç‰ˆæœ¬stableã€betaã€canary\n3.2. Workloads Controller 3.2.1 Liveness Probe é€šè¿‡å­˜æ´»æ¢é’ˆliveness probeæ£€æµ‹å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¸¸ç”¨æ–¹å¼æœ‰ï¼šHTTP GETã€TCP socketã€Exec commandã€‚\nåœ¨spec.containersä¸‹é¢å®šä¹‰livenessProbeå¹¶è®¾ç½®path\n1 kubectl describe po kubia-liveness 3.2.2. ReplicatoinController ReplicationControllerç”¨äºç¡®ä¿podå§‹ç»ˆæ˜¯å¯ä»¥è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœPodä»¥ä»»ä½•åŸå› æ¶ˆå¤±ï¼Œé‚£ä¹ˆReplicationControllerä¼šæ³¨æ„åˆ°ç¼ºå°‘ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªPodæ›¿ä»£ã€‚è¿è¡Œæ—¶ï¼ŒReplicationä¼šæŒç»­ç›‘æ§æ­£åœ¨è¿è¡Œçš„Podåˆ—è¡¨ï¼Œä¿è¯ç›¸å¯¹åº”çš„ç±»å‹çš„Podä¸é¢„æœŸç›¸ç¬¦ï¼Œå°±ç®—æœ‰å¤šä½™Podä¹Ÿä¼šåˆ é™¤ã€‚\nå¯ä»¥ç¡®ä¿ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰PodæŒç»­è¿è¡Œï¼Œæ–¹æ³•æ˜¯åœ¨ç°æœ‰Podä¸¢å¤±æ—¶å¯åŠ¨æ–°çš„Podã€‚\né€šè¿‡åˆ›å»ºkind: ReplicationControlleræ¥å®šä¹‰ï¼Œspec.replicas: xå†³å®šç›®æ ‡æ•°ç›®ï¼Œtemplateä¸‹å®šä¹‰åˆ›å»ºæ–°çš„Podæ‰€ç”¨çš„æ¨¡ç‰ˆã€‚\n1 2 3 4 5 6 7 kubectl get pods kubectl get rc kubectl describe rc kubia kubectl label pod xx app=foo --overwrite # ä¿®æ”¹åå°†ä¸å†ç”±è¯¥RCç®¡ç† kubectl edit rc kubia # å½“ç„¶ï¼Œå¯ä»¥ä½¿ç”¨export KUBE_EDITOR=\u0026#34;/usr/bin/vim\u0026#34;æ¥å†³å®šç¼–è¾‘å™¨ kubectl scale rc kubia --replicas=10 # æ‰©å®¹ å…¶ä¸»è¦ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š\nlabel selectorï¼šç¡®å®šå½“å‰ReplicationControllerä½œç”¨åŸŸä¸‹æœ‰å¤šå°‘Pod\nreplica countï¼šå‰¯æœ¬ä¸ªæ•°ï¼ŒæŒ‡å®šè¿è¡Œçš„æ•°é‡\npod templateï¼šç”¨äºåˆ›å»ºæ–°çš„podå‰¯æœ¬\n3.2.3. ReplicaSet ç›¸è¾ƒäºReplicationControllerï¼ŒReplicaSetå…·æœ‰ç±»ä¼¼çš„è¡Œä¸ºï¼Œä½†æ˜¯å¯ä»¥æ›´å¥½åœ°è¡¨è¾¾Podé€‰æ‹©å™¨ï¼Œå¯ä»¥å…è®¸åŒ¹é…ç¼ºå°‘æŸä¸ªæ ‡ç­¾çš„Podï¼Œæˆ–è€…åŒ…å«ç‰¹å®šæ ‡ç­¾åçš„Podã€‚\nå…¶åŒ…å«å››ä¸ªç‰¹å®šå­—æ®µï¼š\nInï¼šlabelçš„å€¼å¿…é¡»ä¸å…¶ä¸­ä¸€ä¸ªæŒ‡å®šçš„valuesåŒ¹é…\nNotInï¼šLabelçš„å€¼ä¸ä»»ä½•ä¸€ä¸ªvaluesä¸åŒ¹é…ã€‚\nExistsï¼šPodå¿…é¡»åŒ…å«ä¸€ä¸ªæŒ‡å®šåç§°çš„æ ‡ç­¾ï¼Œä½¿ç”¨æ­¤è¿ç®—ç¬¦ä¸åº”è¯¥åŒ…æ‹¬valueså­—æ®µã€‚\nDosNotExistï¼šPodä¸å¾—åŒ…å«æœ‰æŒ‡å®šåç§°çš„æ ‡ç­¾ï¼ŒåŒæ ·ä¸åŒ…æ‹¬valueså­—æ®µã€‚\n3.2.4. DaemonSet DaemonSet ç¡®ä¿å…¨éƒ¨ï¼ˆæˆ–è€…æŸäº›ï¼‰èŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ª Pod çš„å‰¯æœ¬ã€‚ å½“æœ‰èŠ‚ç‚¹åŠ å…¥é›†ç¾¤æ—¶ï¼Œ ä¹Ÿä¼šä¸ºä»–ä»¬æ–°å¢ä¸€ä¸ª Pod ã€‚ å½“æœ‰èŠ‚ç‚¹ä»é›†ç¾¤ç§»é™¤æ—¶ï¼Œè¿™äº› Pod ä¹Ÿä¼šè¢«å›æ”¶ã€‚åˆ é™¤ DaemonSet å°†ä¼šåˆ é™¤å®ƒåˆ›å»ºçš„æ‰€æœ‰ Podã€‚\nDaemonSet çš„ä¸€äº›å…¸å‹ç”¨æ³•ï¼š\nåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†å®ˆæŠ¤è¿›ç¨‹ åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§å®ˆæŠ¤è¿›ç¨‹ é€šè¿‡ç»™Nodeæ‰“ä¸Šæ ‡ç­¾\n1 kubectl label node xx disk=ssd å³å¯ä»¥å¯¹è¯¥èŠ‚ç‚¹ä¿è¯è¿è¡Œè®¾å®šå¥½çš„æ ¡éªŒssdçš„Podã€‚\n3.2.5. Jobs Job ä¼šåˆ›å»ºä¸€ä¸ªæˆ–è€…å¤šä¸ª Podsï¼Œå¹¶å°†ç»§ç»­é‡è¯• Pods çš„æ‰§è¡Œï¼Œç›´åˆ°æŒ‡å®šæ•°é‡çš„ Pods æˆåŠŸç»ˆæ­¢ã€‚ éšç€ Pods æˆåŠŸç»“æŸï¼ŒJob è·Ÿè¸ªè®°å½•æˆåŠŸå®Œæˆçš„ Pods ä¸ªæ•°ã€‚ å½“æ•°é‡è¾¾åˆ°æŒ‡å®šçš„æˆåŠŸä¸ªæ•°é˜ˆå€¼æ—¶ï¼Œä»»åŠ¡ï¼ˆå³ Jobï¼‰ç»“æŸã€‚ åˆ é™¤ Job çš„æ“ä½œä¼šæ¸…é™¤æ‰€åˆ›å»ºçš„å…¨éƒ¨ Podsã€‚ æŒ‚èµ· Job çš„æ“ä½œä¼šåˆ é™¤ Job çš„æ‰€æœ‰æ´»è·ƒ Podï¼Œç›´åˆ° Job è¢«å†æ¬¡æ¢å¤æ‰§è¡Œã€‚\nä¸€ç§ç®€å•çš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œä½ ä¼šåˆ›å»ºä¸€ä¸ª Job å¯¹è±¡ä»¥ä¾¿ä»¥ä¸€ç§å¯é çš„æ–¹å¼è¿è¡ŒæŸ Pod ç›´åˆ°å®Œæˆã€‚ å½“ç¬¬ä¸€ä¸ª Pod å¤±è´¥æˆ–è€…è¢«åˆ é™¤ï¼ˆæ¯”å¦‚å› ä¸ºèŠ‚ç‚¹ç¡¬ä»¶å¤±æ•ˆæˆ–è€…é‡å¯ï¼‰æ—¶ï¼ŒJob å¯¹è±¡ä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ Podã€‚\nä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ Job ä»¥å¹¶è¡Œçš„æ–¹å¼è¿è¡Œå¤šä¸ª Podã€‚\nåœ¨Jobä¸­å¯ä»¥å®šä¹‰è¿è¡Œå¤šä¸ªPodç¤ºä¾‹ï¼ŒåŒ…æ‹¬é¡ºåºï¼Œå¹¶è¡Œï¼ŒCronJobç­‰\n4. Service ç”±äºPodçš„å¯å˜åŠ¨æ€§ï¼Œå¯¼è‡´å…¶éšæ—¶ä¼šè¢«å¯åŠ¨æˆ–è€…å…³é—­ï¼Œå¹¶ä¸”åœ¨Podå¯åŠ¨é’±ï¼Œä¼šç»™å·²ç»è°ƒåº¦åˆ°èŠ‚ç‚¹ä¸Šçš„Podåˆ†é…IPåœ°å€ï¼Œä¸”ç”±äºæ°´å¹³ä¼¸ç¼©çš„ç‰¹æ€§ï¼Œå¤šä¸ªPodå¯èƒ½ä¼šæä¾›ç›¸åŒçš„æœåŠ¡ã€‚\né€šè¿‡åˆ›å»ºymlæ–‡ä»¶å®šä¹‰service\n1 kubectl get svc å¯ä»¥é€šè¿‡åˆ›å»ºæœåŠ¡ï¼Œæ¥è®©ä¸€ä¸ªå•ä¸€ç¨³å®šçš„IPè®¿é—®åˆ°Podï¼Œåœ¨æœåŠ¡çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œè¿™ä¸ªåœ°å€ä¼šä¿æŒä¸å˜ï¼Œåœ¨æœåŠ¡åçš„Podå¯ä»¥åˆ é™¤é‡å»ºï¼Œä½†æ˜¯å¯¹å¤–çš„IPä¸ä¼šå˜åŒ–ã€‚\nä¸ºäº†å¤–éƒ¨è¿æ¥k8sçš„æœåŠ¡ï¼Œåœ¨æœåŠ¡å’Œpodä¹‹é—´ä¸ä¼šç›´æ¥ç›¸è¿çš„ï¼Œè€Œæ˜¯å­˜åœ¨ä¸€ä¸ªendpointèµ„æºï¼Œç”¨ä»¥æš´éœ²æœåŠ¡ipå’Œç«¯å£çš„åˆ—è¡¨ã€‚\nå°†æœåŠ¡æš´éœ²ç»™å®¢æˆ·ç«¯ï¼Œæœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š\nNodePortï¼šæ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½ä¼šæ‰“å¼€ä¸€ä¸ªç«¯å£ï¼Œå¹¶å°†åœ¨è¯¥ç«¯å£ä¸Šæ¥å—åˆ°çš„æµé‡é‡å®šå‘åˆ°åŸºç¡€æœåŠ¡ã€‚ LoadBalanceï¼šä½¿å¾—æœåŠ¡å¯ä»¥é€šè¿‡ä¸€ä¸ªä¸“ç”¨çš„è´Ÿè½½å‡è¡¡å™¨è¿›è¡Œè®¿é—®ï¼Œ Ingressï¼šé€šè¿‡ä¸€ä¸ªIPåœ°å€å…¬å¼€å¤šä¸ªæœåŠ¡ ","date":"2021-10-29T15:40:00+08:00","image":"https://chasing1020.github.io/post/kubernetes/Kubernetes_hud7b15476b5e595aba60cfa91b194c1c9_41038_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/kubernetes/","title":"Kubernetes"},{"content":"Redis Data Structure 0. Redis Object 1 2 3 4 5 6 7 struct RedisObject { int4 type; // 4bits \\ int4 enconding; // 4bits = 4bytes int24 lru; // 24bits / int32 refcount; // 4bytes void* ptr; // 8bytes (64bit-system) } robj; RedisObjectå¯¹äºä¸é€šå¯¹è±¡éƒ½æ˜¯ç›¸åŒçš„ï¼Œå¯¹äºè¿™æ ·çš„ç»“æ„ï¼Œæ¯ä¸ªéƒ½éœ€è¦16byteçš„ç©ºé—´ã€‚\nRediså¯ä»¥è¯´æ˜¯å½“ä»£å†…å­˜æŠ é—¨å­¦çš„è®¾è®¡å…¸èŒƒä¹‹ä¸€ã€‚\nä¸‹æ–‡çš„int4ï¼Œint8ä»£è¡¨ä½åŸŸï¼Œå³type [member_name] : width ;æ¥é™åˆ¶æ•°æ®ç±»å‹çš„å®½åº¦ï¼›\nç‰¹å®šçš„ç»“æ„ä½“é‡‡ç”¨äº†__attribute__ ((__packed__))æ¥å–æ¶ˆä¼˜åŒ–å¯¹é½ï¼›\nå…¶ä¸­Generic (å³\u0026lt;T\u0026gt;) å€Ÿç”±TYPE_MASKçš„\u0026amp;è¿ç®—æ¥å®ç°ï¼ˆå½“ç„¶å¯¹äºCè€Œè¨€å¯ä»¥ç”¨å®ï¼Œä¸C11ä¸­çš„_Genericï¼‰ï¼Œè¿™é‡Œå½“ä½œä¼ªä»£ç ä½¿ç”¨ã€‚\n1. SDS Rediså­—ç¬¦ä¸²ç®€ç§°SDSï¼ˆSimple Dynamic Stringï¼‰ã€‚ Cè¯­è¨€ä¼ ç»Ÿä»¥NULLï¼Œå³\u0026rsquo;\\0\u0026rsquo;ä½œä¸ºå­—ç¬¦ä¸²ç»“æŸç¬¦ï¼Œè¿™æ ·ä½¿ç”¨strlenè·å–é•¿åº¦çš„å¤æ‚åº¦æ˜¯O(n)ï¼Œæ‰€ä»¥Redisæ²¡æœ‰ä½¿ç”¨Cçš„ä¼ ç»Ÿç»“æŸç¬¦ï¼Œè€Œæ˜¯ä½¿ç”¨äº†SDSè¿™æ ·çš„æ•°æ®ç»“æ„ã€‚\n1 2 3 4 5 6 struct SDS\u0026lt;T\u0026gt; { T capacity; T len; byte flags; byte[] content; } è¿™é‡Œçš„lenå’Œcapacityç±»æ¯”äºGoçš„[]byteåˆ‡ç‰‡ï¼Œä¸ºäº†æ”¯æŒappendå†…å®¹ï¼Œå¿…ç„¶ä¼šæ¶‰åŠåˆ°åˆ†é…æ–°æ•°ç»„ä¸å¤åˆ¶çš„è¿‡ç¨‹ï¼Œå°†ä¼šå¸¦æ¥ä¸å°‘çš„å¼€é”€ã€‚\n1 2 3 4 5 6 7 8 9 sds sdscatlen(sds s, const void *t, size_len) { size_t curlen = sdslen(s); s = sdsMakeRoomFor(s, len); if (s == NULL) return NULL; // OOM mencpy(s+curlen, t, len); sdssetlen(s, curlen+len); s[curlen+len] = \u0026#39;\\0\u0026#39;; return s; } é€‰æ‹©ä½¿ç”¨èŒƒå‹ä¸ºäº†è¿½æ±‚æé™çš„æ€§èƒ½ä¼˜åŒ–ï¼Œå¯ä»¥åœ¨è¾ƒçŸ­æ—¶ä½¿ç”¨byteå’Œshortã€‚\nRedisè®¾å®šStringä¸èƒ½è¶…è¿‡512MBï¼Œåˆ›å»ºæ—¶çš„lenå’Œcapacityä¸€æ ·é•¿ï¼Œä¸ä¼šåˆ†é…å¤šä½™ç©ºé—´ã€‚\n2. Dict 1 2 3 4 5 struct RedisDB{ dict* dict; dict* expires; // ... } é™¤äº†hashç»“æ„ä»¥å¤–ï¼ŒRedisä¹Ÿæœ‰å…¨å±€å­—å…¸è®°å½•é”®å€¼å¯¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 struct dictEntry { void* key; void* val; dictEntry* next; } struct dictht { dictEntry** table; long size; long used; // ... } struct dict { // ... dicht ht[2]; } Redisçš„å­—å…¸ä¸Javaçš„HashMapæ¥è¿‘ï¼Œé‡‡ç”¨åˆ†æ¡¶è§£å†³å“ˆå¸Œå†²çªï¼Œå³ä¸€ç»´æ•°ç»„+äºŒç»´é“¾è¡¨çš„æ–¹å¼ã€‚\nå½“hashè¡¨ä¸­å…ƒç´ ç­‰äºä¸€ç»´æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œå¼€å§‹æ‰©å®¹ï¼Œå¦‚æœRedisåœ¨åšbgsaveï¼Œä¸ºäº†å‡å°‘å†…å­˜é¡µçš„è¿‡å¤šåˆ†ç¦»(COW)ï¼Œå°±ä¸ä¼šæ‰©å®¹ï¼Œä½†æ˜¯å¦‚æœå…ƒç´ ä¸ªæ•°è¾¾åˆ°äº†5å€ï¼Œè¿˜æ˜¯ä¼šå‘ç”Ÿå¼ºåˆ¶æ‰©å®¹ã€‚\næ‰©å®¹æ—¶ï¼Œå¦‚æœå…¨éƒ¨é‡æ–°ç”³è¯·æ•°ç»„ï¼Œå¹¶å°†é“¾è¡¨å…ƒç´ æŒ‚åœ¨æ–°çš„æ•°ç»„ä¸‹ï¼Œè€—æ—¶O(n)ï¼Œå¯¹äºå•çº¿ç¨‹è€Œè¨€å¾ˆéš¾æ¥å—ï¼Œæ‰€ä»¥Redisé‡‡ç”¨æ¸è¿›å¼æ‰©å®¹ç­–ç•¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing){ long index; dictEntry *entry; dictht *ht; if (dictisRehashing(d)) _dictRehashing(d); if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1) return NULL; ht = dictIsRehashing(d) ? \u0026amp;d-\u0026gt;ht[1] : \u0026amp;d-\u0026gt;ht[0]; entry = zmalloc(sizeof(*entry))ï¼› entry-\u0026gt;next = ht-\u0026gt;table[index]; ht-\u0026gt;table[index] = entry; ht-\u0026gt;used++; dictSetKey(d, entry, key); return entry; } æ­¤å¤–ï¼Œåœ¨å®¢æˆ·ç«¯ç©ºé—²æ—¶ï¼ŒRedisä¹Ÿè®¾è®¡äº†å®šæ—¶ä»»åŠ¡(databaseCron)ï¼Œå¯¹å­—å…¸è¿›è¡Œä¸»åŠ¨æ¬è¿ã€‚\nRedisçš„Seté‡‡ç”¨çš„ä¸å­—å…¸ç›¸åŒçš„æ•°æ®ç»“æ„ï¼Œä¸è¿‡æ˜¯Valueéƒ½ä¸ºNULL(å’ŒGoä¸€æ ·)ã€‚\n3. Zip List å½“zsetå’Œhashå¯¹è±¡åœ¨å…ƒç´ ä¸ªæ•°è¾ƒå°‘æ—¶ï¼Œéƒ½åœ¨ç”¨å‹ç¼©åˆ—è¡¨å­˜å‚¨ï¼Œèƒ½ä¿è¯æ•°æ®æ²¡æœ‰å†—ä½™ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 struct ziplist\u0026lt;T\u0026gt; { int32 zlbytes; int32 zltail_offset; int16 zllength; T[] entries; int8 zlend; } struct entry { int\u0026lt;var\u0026gt; prevlen; int\u0026lt;var\u0026gt; encoding; optional byte[] content; } zltial_offsetç”¨äºè®°å½•æœ€åä¸€ä¸ªå…ƒç´ çš„åç§»é‡ï¼Œprevlenç”¨äºè®°å½•å‰ä¸€ä¸ªentryçš„é•¿åº¦ï¼Œå€’åºéå†æ—¶å¯ä»¥å¿«é€Ÿå®šä½åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ ä½ç½®ã€‚\nencodingå­—æ®µä¸ºè®°å½•ç¼–ç ä¿¡æ¯ï¼Œåšäº†ç›¸å½“å¤æ‚çš„è®¾è®¡ï¼Œç±»ä¼¼äºUTF8ç¼–ç ï¼Œé‡‡ç”¨äº†å‰ç¼€ä½ç±»åŒºåˆ†å†…å®¹ã€‚\noptionalä»£è¡¨è¯¥å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå¯¹äºå¾ˆå°çš„æ•´æ•°è€Œè¨€ï¼Œå¯èƒ½å†…å®¹å·²ç»inlineåˆ°encodingçš„å°¾éƒ¨äº†ã€‚\næ¯æ¬¡æ’å…¥ziplistéƒ½éœ€è¦ä½¿ç”¨reallocæ‹“å±•å†…å­˜ï¼Œå°†å…ˆå‰çš„å†…å®¹è¿›è¡Œæ‹·è´ï¼Œæˆ–è€…åœ¨åŸåœ°å€æ‹“å±•ã€‚è¿™ç§æ“ä½œå¯¹äºå¤§å†…å­˜çš„æ•ˆç‡ä¸é«˜ï¼Œæ‰€ä»¥ziplistå¹¶ä¸é€‚åˆå­˜å‚¨å¤§å…ƒç´ ã€‚\n4. Quick List 1 2 3 4 5 6 7 8 9 10 struct listNode\u0026lt;T\u0026gt; { listNode *prev; listNode *next; T value; } struct list { listNode *head; listNoed *tail; long length; } æ—©æœŸçš„Redisåœ¨å…ƒç´ å°‘æ—¶ä½¿ç”¨ziplistï¼Œå…ƒç´ å¤šæ—¶ä½¿ç”¨linkedlistï¼Œè¿™æ ·å‰åæŒ‡é’ˆå°±éœ€è¦16å­—èŠ‚ï¼Œæµªè´¹å†…å­˜ç©ºé—´ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 struct ziplist\u0026lt;T\u0026gt; { int32 zlbytes; int32 zltail_offset; int16 zllength; T[] entries; int8 zlend; } struct ziplist_compressed { int32 size; byte[] compressed_data; } struct quicklistNode { quicklistNode* prev; quicklistNode* next; ziplist* zl; int32 size; int16 count; int2 encoding; // ... } struct quicklist { quicklistNode* head; quicklistNode* tail; long count; int nodes; int compressDepth; // ... } æ¯ä¸ªziplisté•¿åº¦ä¸º8kbï¼Œè¶…è¿‡è¿™ä¸ªå€¼ä¼šæ–°å»ºä¸€ä¸ªziplistã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒRedisé»˜è®¤çš„å‹ç¼©æ·±åº¦ä¸º0ï¼Œå¯ä»¥é‡‡ç”¨LZFç®—æ³•å¯¹å†…å­˜è¿›è¡Œå‹ç¼©ï¼Œå¯ä»¥é€‰æ‹©å‹ç¼©æ·±åº¦ã€‚\n5. Skip List å¯¹äºzsetè¿™æ ·çš„å¤åˆç»“æ„ï¼Œéœ€è¦hashå­˜å‚¨kvï¼Œä¹Ÿéœ€è¦å¯¹scoreæ’åºï¼Œå³éœ€è¦SkipListæ•°æ®ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 struct zslnode { string value; double score; zslnode*[] forwards; zslnode* backward; } struct zsl { zslnode* header; int maxLevel; map\u0026lt;string, zslnode*\u0026gt; ht; } æ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œä»headeræœ€é«˜å±‚å¼€å§‹ï¼Œéå†æ‰¾åˆ°æœ€åä¸€ä¸ªæ¯”å½“å‰å±‚è¦å°çš„å…ƒç´ ï¼Œä¹‹åå‘ç”Ÿé™å±‚ã€‚\næ’å…¥æ—¶ï¼Œè®¾ç½®åˆ†åˆ°ç¬¬nå±‚çš„æ¦‚ç‡ä¸º$(1/2)^n$ï¼Œå³æ¯ä¸€å±‚æ™‹å‡ç‡ä¸º50%ï¼Œ(å®˜æ–¹çš„æºç ä¸­æ™‹å‡ç‡ä¸º25%ï¼Œç›¸å¯¹æ‰å¹³)ã€‚\næ›´æ–°æ—¶ï¼ŒRedisé‡‡ç”¨çš„ç­–ç•¥æ˜¯ï¼šå…ˆåˆ é™¤å†æ’å…¥ï¼Œèƒ½å¤Ÿè¾ƒå¥½è°ƒæ•´ä½ç½®ã€‚\nå¦‚æœscoreç›¸åŒï¼ŒRedisä¼šå°†æ’åºæŒ‡æ ‡è®¾è®¡ä¸ºValue(strcmp)ï¼Œæ¥é˜²æ­¢æ€§èƒ½é€€åŒ–è‡³O(n)ã€‚\n6. List Pack Redis5.0æ›´æ–°äº†listpackæ¥å¯¹ziplistè¿›è¡Œä¼˜åŒ–\n1 2 3 4 5 6 7 8 9 10 11 struct listpack\u0026lt;T\u0026gt; { int32 total_bytes; int16 size; T[] entries; int8 end; } struct lpentry { int\u0026lt;var\u0026gt; encoding; optional byte[] content; int\u0026lt;var\u0026gt; length; } listpacké‡‡ç”¨varintè¿›è¡Œç¼–ç ï¼Œä¸åŒçš„é•¿åº¦ç¼–ç å¯ä»¥æ˜¯1-5ä¸­ä»»æ„ä¸€ä¸ªã€‚è§£å†³äº†ziplistçº§è”æ›´æ–°çš„è¡Œä¸ºï¼Œå…ƒç´ é—´ç‹¬ç«‹ï¼Œä¸ä¼šå¯¹åç»­æœ‰å½±å“ã€‚ä¸è¿‡ç”±äºziplistä½¿ç”¨è¿‡å¹¿æ³›ï¼Œç°åœ¨åªæœ‰Streamé‡‡ç”¨äº†listpackã€‚\n7. Rax Radix Treeç±»æ¯”HttpRouterä¸­çš„TireTreeï¼Œè¢«ç”¨äºå­˜å‚¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶ä¸­æ¶ˆæ¯å‰ç¼€å³æ˜¯æ—¶é—´æˆ³+åºå·ã€‚\n1 2 3 4 5 6 7 struct raxNode { int1 isKey; int1 isNull; int1 isCompressed; int29 size; byte[] data; } raxåœ¨ç»“æ„ä¸Šå¹¶ä¸æ˜¯ä¸¥æ ¼çš„RadixTreeï¼Œå¦‚æœä¸­é—´èŠ‚ç‚¹æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œè·¯ç”±å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè·¯ç”±é”®å°±æ˜¯å­—ç¬¦ä¸²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 struct data { optional struct { byte[] childKey; raxNode* childNode; } child; optional string value; } struct data { byte[] childKeys; raxNode*[] childNodes; optional string value; } å¦‚æœå¶å­èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯å‹ç¼©ç»“æ„ã€‚åä¹‹åˆ™æ˜¯å­˜åœ¨å¤šä¸ªè·¯ç”±é”®ï¼Œä¸€ä¸ªé”®å¯¹åº”ä¸€ä¸ªå­—ç¬¦ã€‚\n","date":"2021-10-28T13:44:47+08:00","image":"https://chasing1020.github.io/post/redis-data-structure/redis_hu4c98b34389b2bed692880162a2db21b3_22204_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/redis-data-structure/","title":"Redis Data Structure"},{"content":"Part6. Network 1. IO/Polling select æ“ä½œçš„ä¸è¶³ä¹‹å¤„ï¼š\nç›‘å¬èƒ½åŠ›æœ‰é™ â€” æœ€å¤šåªèƒ½ç›‘å¬ 1024 ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼› å†…å­˜æ‹·è´å¼€é”€å¤§ â€” éœ€è¦ç»´æŠ¤ä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®ç»“æ„å­˜å‚¨æ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥ç»“æ„éœ€è¦æ‹·è´åˆ°å†…æ ¸ä¸­ï¼› æ—¶é—´å¤æ‚åº¦ O(n)O(n) â€” è¿”å›å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ä¸ªæ•°åï¼Œéœ€è¦éå†æ‰€æœ‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼› ä¸ºäº†æé«˜ I/O å¤šè·¯å¤ç”¨çš„æ€§èƒ½ï¼Œä¸åŒçš„æ“ä½œç³»ç»Ÿä¹Ÿéƒ½å®ç°äº†è‡ªå·±çš„ I/O å¤šè·¯å¤ç”¨å‡½æ•°ï¼Œä¾‹å¦‚ï¼šepollã€kqueue å’Œ evport ç­‰ã€‚Go è¯­è¨€ä¸ºäº†æé«˜åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šçš„ I/O æ“ä½œæ€§èƒ½ï¼Œä½¿ç”¨å¹³å°çš„ç‰¹å®šçš„å‡½æ•°å®ç°äº†å¤šä¸ªç‰ˆæœ¬çš„ç½‘ç»œè½®è¯¢æ¨¡å—ï¼š\n1 2 3 4 5 func netpollinit() func netpollopen(fd uintptr, pd *pollDesc) int32 func netpoll(delta int64) gList func netpollBreak() func netpollIsPollDescriptor(fd uintptr) bool runtime.netpollinit â€” åˆå§‹åŒ–ç½‘ç»œè½®è¯¢å™¨ï¼Œé€šè¿‡ sync.Once å’Œ netpollInited å˜é‡ä¿è¯å‡½æ•°åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼› runtime.netpollopen â€” ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„è¾¹ç¼˜è§¦å‘äº‹ä»¶ï¼Œåˆ›å»ºäº‹ä»¶å¹¶åŠ å…¥ç›‘å¬ï¼› runtime.netpollâ€” è½®è¯¢ç½‘ç»œå¹¶è¿”å›ä¸€ç»„å·²ç»å‡†å¤‡å°±ç»ªçš„ Goroutineï¼Œä¼ å…¥çš„å‚æ•°ä¼šå†³å®šå®ƒçš„è¡Œä¸º å¦‚æœå‚æ•°å°äº 0ï¼Œæ— é™æœŸç­‰å¾…æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼› å¦‚æœå‚æ•°ç­‰äº 0ï¼Œéé˜»å¡åœ°è½®è¯¢ç½‘ç»œï¼› å¦‚æœå‚æ•°å¤§äº 0ï¼Œé˜»å¡ç‰¹å®šæ—¶é—´è½®è¯¢ç½‘ç»œï¼› runtime.netpollBreak â€” å”¤é†’ç½‘ç»œè½®è¯¢å™¨ï¼Œä¾‹å¦‚ï¼šè®¡æ—¶å™¨å‘å‰ä¿®æ”¹æ—¶é—´æ—¶ä¼šé€šè¿‡è¯¥å‡½æ•°ä¸­æ–­ç½‘ç»œè½®è¯¢å™¨4ï¼› runtime.netpollIsPollDescriptor â€” åˆ¤æ–­æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦è¢«è½®è¯¢å™¨ä½¿ç”¨ï¼› å½“å‰\n2. Json Marshaler åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¼€é”€å®Œå…¨ä¸åŒï¼ŒJSON ååºåˆ—åŒ–çš„å¼€é”€æ˜¯åºåˆ—åŒ–å¼€é”€çš„å¥½å‡ å€ï¼Œç›¸ä¿¡è¿™èƒŒåçš„åŸå› ä¹Ÿéå¸¸å¥½ç†è§£ã€‚Go è¯­è¨€ä¸­çš„ JSON åºåˆ—åŒ–è¿‡ç¨‹ä¸éœ€è¦è¢«åºåˆ—åŒ–çš„å¯¹è±¡é¢„å…ˆå®ç°ä»»ä½•æ¥å£ï¼Œå®ƒä¼šé€šè¿‡åå°„è·å–ç»“æ„ä½“æˆ–è€…æ•°ç»„ä¸­çš„å€¼å¹¶ä»¥æ ‘å½¢çš„ç»“æ„é€’å½’åœ°è¿›è¡Œç¼–ç ï¼Œæ ‡å‡†åº“ä¹Ÿä¼šæ ¹æ® encoding/json.Unmarshal ä¸­ä¼ å…¥çš„å€¼å¯¹ JSON è¿›è¡Œè§£ç ã€‚\nåœ¨åˆ›å»ºç»“æ„ä½“æ—¶ï¼Œå¯ä»¥æ·»åŠ tagæ¥å®ç°åŸºæœ¬çš„è§£ç æ–¹å¼ï¼Œå…¶ä¸­omitemptyè¡¨ç¤ºä¸å­˜åœ¨æ—¶å°±ä¸¢å¼ƒï¼ŒåŠ å…¥-ä»£è¡¨æ°¸è¿œä¸¢å¼ƒè¯¥å­—æ®µ\n1 2 3 4 type Author struct { Name string `json:\u0026#34;name,omitempty\u0026#34;` Age int32 `json:\u0026#34;age,string,omitempty\u0026#34;` } å…¶ä¸­æœ€é‡è¦çš„ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Marshal returns the JSON encoding of v. func Marshal(v interface{}) ([]byte, error) { e := newEncodeState() err := e.marshal(v, encOpts{escapeHTML: true}) if err != nil { return nil, err } buf := append([]byte(nil), e.Bytes()...) encodeStatePool.Put(e) return buf, nil } ä¸ååºåˆ—åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 // Unmarshal parses the JSON-encoded data and stores the result // in the value pointed to by v. If v is nil or not a pointer, // Unmarshal returns an InvalidUnmarshalError. func Unmarshal(data []byte, v interface{}) error { // Check for well-formedness. // Avoids filling out half a data structure // before discovering a JSON syntax error. var d decodeState err := checkValid(data, \u0026amp;d.scan) if err != nil { return err } d.init(data) return d.unmarshal(v) } é¦–å…ˆæ ¡éªŒæ˜¯å¦ä¸ºValidæ•°æ®\n3. DataBase ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼ˆStructured Query Languageã€SQLï¼‰æ˜¯åœ¨å…³ç³»å‹æ•°æ®åº“ç³»ç»Ÿä¸­ä½¿ç”¨çš„é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDomain-Specific Languageã€DSLï¼‰ï¼Œå®ƒä¸»è¦ç”¨äºå¤„ç†ç»“æ„åŒ–çš„æ•°æ®1ã€‚ä½œä¸ºä¸€é—¨é¢†åŸŸç‰¹å®šè¯­è¨€ï¼Œå®ƒæœ‰æ›´åŠ å¼ºå¤§çš„è¡¨è¾¾èƒ½åŠ›ï¼Œä¸ä¼ ç»Ÿçš„å‘½ä»¤å¼ API ç›¸æ¯”ï¼Œå®ƒèƒ½å¤Ÿæä¾›ä¸¤ä¸ªä¼˜ç‚¹ï¼š\nå¯ä»¥ä½¿ç”¨å•ä¸ªå‘½ä»¤åœ¨æ•°æ®åº“ä¸­è®¿é—®å¤šæ¡æ•°æ®ï¼› ä¸éœ€è¦åœ¨æŸ¥è¯¢ä¸­æŒ‡å®šè·å–æ•°æ®çš„æ–¹æ³•ï¼› Go è¯­è¨€çš„database/sql å°±å»ºç«‹åœ¨ä¸Šè¿°å‰æä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç›¸åŒçš„ SQL è¯­è¨€æŸ¥è¯¢å…³ç³»å‹æ•°æ®åº“ï¼Œæ‰€æœ‰å…³ç³»å‹æ•°æ®åº“çš„å®¢æˆ·ç«¯éƒ½éœ€è¦å®ç°å¦‚ä¸‹æ‰€ç¤ºçš„é©±åŠ¨æ¥å£ï¼š\n1 2 3 4 5 6 7 8 9 type Driver interface { Open(name string) (Conn, error) } type Conn interface { Prepare(query string) (Stmt, error) Close() error Begin() (Tx, error) } database/sql/driver.Driveræ¥å£ä¸­åªåŒ…å«ä¸€ä¸ª Open æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ•°æ®åº“è¿æ¥ä¸²ä½œä¸ºè¾“å…¥å‚æ•°å¹¶è¿”å›ä¸€ä¸ªç‰¹å®šæ•°æ®åº“çš„è¿æ¥ï¼Œä½œä¸ºå‚æ•°çš„æ•°æ®åº“è¿æ¥ä¸²æ˜¯æ•°æ®åº“ç‰¹å®šçš„æ ¼å¼ï¼Œè¿™ä¸ªè¿”å›çš„è¿æ¥ä»ç„¶æ˜¯ä¸€ä¸ªæ¥å£ã€‚ database/sqlä¸­æä¾›çš„ database/sql.Register æ–¹æ³•å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰çš„æ•°æ®åº“é©±åŠ¨ï¼Œè¿™ä¸ª package çš„å†…éƒ¨åŒ…å«ä¸¤ä¸ªå˜é‡ï¼Œåˆ†åˆ«æ˜¯ drivers å“ˆå¸Œä»¥åŠ driversMu äº’æ–¥é”ï¼Œæ‰€æœ‰çš„æ•°æ®åº“é©±åŠ¨éƒ½ä¼šå­˜å‚¨åœ¨è¿™ä¸ªå“ˆå¸Œä¸­ï¼š\n1 2 3 4 5 6 7 8 9 10 11 func Register(name string, driver driver.Driver) { driversMu.Lock() defer driversMu.Unlock() if driver == nil { panic(\u0026#34;sql: Register driver is nil\u0026#34;) } if _, dup := drivers[name]; dup { panic(\u0026#34;sql: Register called twice for driver \u0026#34; + name) } drivers[name] = driver } MySQL é©±åŠ¨ä¼šåœ¨ go-sql-driver/mysql/mysql.initä¸­è°ƒç”¨ä¸Šè¿°æ–¹æ³•å°†å®ç° database/sql/driver.Driveræ¥å£çš„ç»“æ„ä½“æ³¨å†Œåˆ°å…¨å±€çš„é©±åŠ¨åˆ—è¡¨ä¸­ï¼š\n1 2 3 func init() { sql.Register(\u0026#34;mysql\u0026#34;, \u0026amp;MySQLDriver{}) } å½“æˆ‘ä»¬åœ¨å…¨å±€å˜é‡ä¸­æ³¨å†Œäº†é©±åŠ¨ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ database/sql.Openæ–¹æ³•è·å–ç‰¹å®šæ•°æ®åº“çš„è¿æ¥ã€‚åœ¨å¦‚ä¸‹æ‰€ç¤ºçš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¼ å…¥çš„é©±åŠ¨åè·å– database/sql/driver.Driverç»„æˆ database/sql.dsnConnectorç»“æ„ä½“åè°ƒç”¨ database/sql.OpenDBï¼š\n1 2 3 4 5 6 7 8 9 10 func Open(driverName, dataSourceName string) (*DB, error) { driversMu.RLock() driveri, ok := drivers[driverName] driversMu.RUnlock() if !ok { return nil, fmt.Errorf(\u0026#34;sql: unknown driver %q (forgotten import?)\u0026#34;, driverName) } ... return OpenDB(dsnConnector{dsn: dataSourceName, driver: driveri}), nil } database/sql.OpenDB ä¼šè¿”å›ä¸€ä¸ª database/sql.DB ç»“æ„ï¼Œè¿™æ˜¯æ ‡å‡†åº“åŒ…ä¸ºæˆ‘ä»¬æä¾›çš„å…³é”®ç»“æ„ä½“ï¼Œæ— è®ºæ˜¯æˆ‘ä»¬ç›´æ¥ä½¿ç”¨æ ‡å‡†åº“æŸ¥è¯¢æ•°æ®åº“ï¼Œè¿˜æ˜¯ä½¿ç”¨ GORM ç­‰ ORM æ¡†æ¶éƒ½ä¼šç”¨åˆ°å®ƒï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 func OpenDB(c driver.Connector) *DB { ctx, cancel := context.WithCancel(context.Background()) db := \u0026amp;DB{ connector: c, openerCh: make(chan struct{}, connectionRequestQueueSize), lastPut: make(map[*driverConn]string), connRequests: make(map[uint64]chan connRequest), stop: cancel, } go db.connectionOpener(ctx) return db } ç»“æ„ä½“ database/sql.DB åœ¨åˆšåˆšåˆå§‹åŒ–æ—¶ä¸ä¼šåŒ…å«ä»»ä½•çš„æ•°æ®åº“è¿æ¥ï¼Œå®ƒæŒæœ‰çš„æ•°æ®åº“è¿æ¥æ± ä¼šåœ¨çœŸæ­£åº”ç”¨ç¨‹åºç”³è¯·è¿æ¥æ—¶åœ¨å•ç‹¬çš„ Goroutine ä¸­è·å–ã€‚database/sql.DB.connectionOpeneræ–¹æ³•ä¸­åŒ…å«ä¸€ä¸ªä¸ä¼šé€€å‡ºçš„å¾ªç¯ï¼Œæ¯å½“è¯¥ Goroutine æ”¶åˆ°äº†è¯·æ±‚æ—¶éƒ½ä¼šè°ƒç”¨ database/sql.DB.openNewConnection\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func (db *DB) openNewConnection(ctx context.Context) { ci, _ := db.connector.Connect(ctx) ... dc := \u0026amp;driverConn{ db: db, createdAt: nowFunc(), returnedAt: nowFunc(), ci: ci, } if db.putConnDBLocked(dc, err) { db.addDepLocked(dc, dc) } else { db.numOpen-- ci.Close() } } æ•°æ®åº“ç»“æ„ä½“ database/sql.DB ä¸­çš„é“¾æ¥å™¨æ˜¯å®ç°äº† database/sql/driver.Connector](https://draveness.me/golang/tree/database/sql/driver.Connector) ç±»å‹çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥æ¥å£åˆ›å»ºä»»æ„æ•°é‡å®Œå…¨ç­‰ä»·çš„è¿æ¥ï¼Œåˆ›å»ºçš„æ‰€æœ‰è¿æ¥éƒ½ä¼šè¢«åŠ å…¥è¿æ¥æ± ä¸­ï¼ŒMySQL çš„é©±åŠ¨åœ¨ go-sql-driver/mysql/mysql.connector.Connectæ–¹æ³•å®ç°äº†è¿æ¥æ•°æ®åº“çš„é€»è¾‘ã€‚\næ— è®ºæ˜¯ä½¿ç”¨ ORM æ¡†æ¶è¿˜æ˜¯ç›´æ¥ä½¿ç”¨æ ‡å‡†åº“ï¼Œå½“æˆ‘ä»¬åœ¨æŸ¥è¯¢æ•°æ®åº“æ—¶éƒ½ä¼šè°ƒç”¨ database/sql.DB.Queryæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å…¥å‚å°±æ˜¯ SQL è¯­å¥å’Œ SQL è¯­å¥ä¸­çš„å‚æ•°ï¼Œå®ƒä¼šåˆå§‹åŒ–æ–°çš„ä¸Šä¸‹æ–‡å¹¶è°ƒç”¨ database/sql.DB.QueryContext\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (db *DB) QueryContext(ctx context.Context, query string, args ...interface{}) (*Rows, error) { var rows *Rows var err error for i := 0; i \u0026lt; maxBadConnRetries; i++ { rows, err = db.query(ctx, query, args, cachedOrNewConn) if err != driver.ErrBadConn { break } } if err == driver.ErrBadConn { return db.query(ctx, query, args, alwaysNewConn) } return rows, err } database/sql.DB.query çš„æ‰§è¡Œè¿‡ç¨‹å¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œé¦–å…ˆè°ƒç”¨ç§æœ‰æ–¹æ³• database/sql.DB.conn è·å–åº•å±‚æ•°æ®åº“çš„è¿æ¥ï¼Œæ•°æ®åº“è¿æ¥æ—¢å¯èƒ½æ˜¯åˆšåˆšé€šè¿‡è¿æ¥å™¨åˆ›å»ºçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¹‹å‰ç¼“å­˜çš„è¿æ¥ï¼›è·å–è¿æ¥ä¹‹åè°ƒç”¨ database/sql.DB.queryDCåœ¨ç‰¹å®šçš„æ•°æ®åº“è¿æ¥ä¸Šæ‰§è¡ŒæŸ¥è¯¢ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 func (db *DB) queryDC(ctx, txctx context.Context, dc *driverConn, releaseConn func(error), query string, args []interface{}) (*Rows, error) { queryerCtx, ok := dc.ci.(driver.QueryerContext) var queryer driver.Queryer if !ok { queryer, ok = dc.ci.(driver.Queryer) } if ok { var nvdargs []driver.NamedValue var rowsi driver.Rows var err error withLock(dc, func() { nvdargs, err = driverArgsConnLocked(dc.ci, nil, args) if err != nil { return } rowsi, err = ctxDriverQuery(ctx, queryerCtx, queryer, query, nvdargs) }) if err != driver.ErrSkip { if err != nil { releaseConn(err) return nil, err } rows := \u0026amp;Rows{ dc: dc, releaseConn: releaseConn, rowsi: rowsi, } rows.initContextClose(ctx, txctx) return rows, nil } } ... } ä¸Šè¿°æ–¹æ³•åœ¨å‡†å¤‡äº† SQL æŸ¥è¯¢æ‰€éœ€çš„å‚æ•°ä¹‹åï¼Œä¼šè°ƒç”¨ database/sql.ctxDriverQueryå®Œæˆ SQL æŸ¥è¯¢ï¼Œæˆ‘ä»¬ä¼šåˆ¤æ–­å½“å‰çš„æŸ¥è¯¢ä¸Šä¸‹æ–‡ç©¶ç«Ÿå®ç°äº†å“ªä¸ªæ¥å£ï¼Œç„¶åè°ƒç”¨å¯¹åº”æ¥å£çš„ Query æˆ–è€… QueryContextï¼š\n1 2 3 4 5 6 7 8 9 10 11 func ctxDriverQuery(ctx context.Context, queryerCtx driver.QueryerContext, queryer driver.Queryer, query string, nvdargs []driver.NamedValue) (driver.Rows, error) { if queryerCtx != nil { return queryerCtx.QueryContext(ctx, query, nvdargs) } dargs, err := namedValueToValue(nvdargs) if err != nil { return nil, err } ... return queryer.Query(query, dargs) } å¯¹åº”çš„æ•°æ®åº“é©±åŠ¨ä¼šçœŸæ­£è´Ÿè´£æ‰§è¡Œè°ƒç”¨æ–¹è¾“å…¥çš„ SQL æŸ¥è¯¢ï¼Œä½œä¸ºä¸­é—´å±‚çš„æ ‡å‡†åº“å¯ä»¥ä¸åœ¨ä¹å…·ä½“çš„å®ç°ï¼ŒæŠ¹å¹³ä¸åŒå…³ç³»å‹æ•°æ®åº“çš„å·®å¼‚ï¼Œä¸ºç”¨æˆ·ç¨‹åºæä¾›ç»Ÿä¸€çš„æ¥å£ã€‚\n","date":"2021-10-26T19:35:13+08:00","image":"https://chasing1020.github.io/post/go6-network/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go6-network/","title":"Go(6) Network"},{"content":"Part5. Concurrency 1. Channel 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 type hchan struct { qcount uint // total data in the queue dataqsiz uint // size of the circular queue buf unsafe.Pointer // points to an array of dataqsiz elements elemsize uint16 closed uint32 elemtype *_type // element type sendx uint // send index recvx uint // receive index recvq waitq // list of recv waiters sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G\u0026#39;s status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex } type waitq struct { first *sudog last *sudog } // sudog represents a g in a wait list, such as for sending/receiving // on a channel. // sudog is necessary because the g â†” synchronization object relation // is many-to-many. A g can be on many wait lists, so there may be // many sudogs for one g; and many gs may be waiting on the same // synchronization object, so there may be many sudogs for one object. // å¦‚æœç›®æ ‡ Channel æ²¡æœ‰è¢«å…³é—­å¹¶ä¸”å·²ç»æœ‰å¤„äºè¯»ç­‰å¾…çš„ Goroutineï¼Œé‚£ä¹ˆ runtime.chansend ä¼šä»æ¥æ”¶é˜Ÿåˆ— recvq ä¸­å–å‡ºæœ€å…ˆé™·å…¥ç­‰å¾…çš„ Goroutine å¹¶ç›´æ¥å‘å®ƒå‘é€æ•°æ®ï¼š\n1 2 3 4 if sg := c.recvq.dequeue(); sg != nil { send(c, sg, ep, func() { unlock(\u0026amp;c.lock) }, 3) return true } è°ƒç”¨ runtime.sendDirect å°†å‘é€çš„æ•°æ®ç›´æ¥æ‹·è´åˆ° x = \u0026lt;-c è¡¨è¾¾å¼ä¸­å˜é‡ x æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸Šï¼› è°ƒç”¨ runtime.goready å°†ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutine æ ‡è®°æˆå¯è¿è¡ŒçŠ¶æ€ Grunnable å¹¶æŠŠè¯¥ Goroutine æ”¾åˆ°å‘é€æ–¹æ‰€åœ¨çš„å¤„ç†å™¨çš„ runnext ä¸Šç­‰å¾…æ‰§è¡Œï¼Œè¯¥å¤„ç†å™¨åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶ä¼šç«‹åˆ»å”¤é†’æ•°æ®çš„æ¥æ”¶æ–¹ï¼› 1 2 3 4 5 6 7 8 9 10 func send(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if sg.elem != nil { sendDirect(c.elemtype, sg, ep) sg.elem = nil } gp := sg.g unlockf() gp.param = unsafe.Pointer(sg) goready(gp, skip+1) } å¦‚æœåˆ›å»ºçš„ Channel åŒ…å«ç¼“å†²åŒºå¹¶ä¸” Channel ä¸­çš„æ•°æ®æ²¡æœ‰è£…æ»¡ï¼Œä¼šæ‰§è¡Œä¸‹é¢è¿™æ®µä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { ... if c.qcount \u0026lt; c.dataqsiz { qp := chanbuf(c, c.sendx) typedmemmove(c.elemtype, qp, ep) c.sendx++ if c.sendx == c.dataqsiz { c.sendx = 0 } c.qcount++ unlock(\u0026amp;c.lock) return true } ... } åœ¨è¿™é‡Œæˆ‘ä»¬é¦–å…ˆä¼šä½¿ç”¨ runtime.chanbuf è®¡ç®—å‡ºä¸‹ä¸€ä¸ªå¯ä»¥å­˜å‚¨æ•°æ®çš„ä½ç½®ï¼Œç„¶åé€šè¿‡ runtime.typedmemmoveå°†å‘é€çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­å¹¶å¢åŠ  sendx ç´¢å¼•å’Œ qcount è®¡æ•°å™¨ã€‚\nå½“ Channel æ²¡æœ‰æ¥æ”¶è€…èƒ½å¤Ÿå¤„ç†æ•°æ®æ—¶ï¼Œå‘ Channel å‘é€æ•°æ®ä¼šè¢«ä¸‹æ¸¸é˜»å¡ï¼Œå½“ç„¶ä½¿ç”¨ select å…³é”®å­—å¯ä»¥å‘ Channel éé˜»å¡åœ°å‘é€æ¶ˆæ¯ã€‚å‘ Channel é˜»å¡åœ°å‘é€æ•°æ®ä¼šæ‰§è¡Œä¸‹é¢çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•æ¢³ç†ä¸€ä¸‹è¿™æ®µä»£ç çš„é€»è¾‘ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func chansend(c *hchan, ep unsafe.Pointer, block bool, callerpc uintptr) bool { ... if !block { unlock(\u0026amp;c.lock) return false } gp := getg() mysg := acquireSudog() mysg.elem = ep mysg.g = gp mysg.c = c gp.waiting = mysg c.sendq.enqueue(mysg) goparkunlock(\u0026amp;c.lock, waitReasonChanSend, traceEvGoBlockSend, 3) gp.waiting = nil gp.param = nil mysg.c = nil releaseSudog(mysg) return true } å½“æˆ‘ä»¬ä»ä¸€ä¸ªç©º Channel æ¥æ”¶æ•°æ®æ—¶ä¼šç›´æ¥è°ƒç”¨ runtime.gopark è®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { if c == nil { if !block { return } gopark(nil, nil, waitReasonChanReceiveNilChan, traceEvGoStop, 2) throw(\u0026#34;unreachable\u0026#34;) } lock(\u0026amp;c.lock) if c.closed != 0 \u0026amp;\u0026amp; c.qcount == 0 { unlock(\u0026amp;c.lock) if ep != nil { typedmemclr(c.elemtype, ep) } return true, false } å¦‚æœå½“å‰ Channel å·²ç»è¢«å…³é—­å¹¶ä¸”ç¼“å†²åŒºä¸­ä¸å­˜åœ¨ä»»ä½•æ•°æ®ï¼Œé‚£ä¹ˆä¼šæ¸…é™¤ ep æŒ‡é’ˆä¸­çš„æ•°æ®å¹¶ç«‹åˆ»è¿”å›ã€‚\né™¤äº†ä¸Šè¿°ä¸¤ç§ç‰¹æ®Šæƒ…å†µï¼Œä½¿ç”¨ runtime.chanrecv ä» Channel æ¥æ”¶æ•°æ®æ—¶è¿˜åŒ…å«ä»¥ä¸‹ä¸‰ç§ä¸åŒæƒ…å†µï¼š\nå½“å­˜åœ¨ç­‰å¾…çš„å‘é€è€…æ—¶ï¼Œé€šè¿‡ runtime.recv ä»é˜»å¡çš„å‘é€è€…æˆ–è€…ç¼“å†²åŒºä¸­è·å–æ•°æ®ï¼› å½“ç¼“å†²åŒºå­˜åœ¨æ•°æ®æ—¶ï¼Œä» Channel çš„ç¼“å†²åŒºä¸­æ¥æ”¶æ•°æ®ï¼› å½“ç¼“å†²åŒºä¸­ä¸å­˜åœ¨æ•°æ®æ—¶ï¼Œç­‰å¾…å…¶ä»– Goroutine å‘ Channel å‘é€æ•°æ®ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func recv(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf func(), skip int) { if c.dataqsiz == 0 { if ep != nil { recvDirect(c.elemtype, sg, ep) } } else { qp := chanbuf(c, c.recvx) if ep != nil { typedmemmove(c.elemtype, ep, qp) } typedmemmove(c.elemtype, qp, sg.elem) c.recvx++ c.sendx = c.recvx // c.sendx = (c.sendx+1) % c.dataqsiz } gp := sg.g gp.param = unsafe.Pointer(sg) goready(gp, skip+1) } å¦‚æœ Channel ä¸å­˜åœ¨ç¼“å†²åŒºï¼› è°ƒç”¨ runtime.recvDirect å°† Channel å‘é€é˜Ÿåˆ—ä¸­ Goroutine å­˜å‚¨çš„ elem æ•°æ®æ‹·è´åˆ°ç›®æ ‡å†…å­˜åœ°å€ä¸­ï¼› å¦‚æœ Channel å­˜åœ¨ç¼“å†²åŒºï¼› å°†é˜Ÿåˆ—ä¸­çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶æ–¹çš„å†…å­˜åœ°å€ï¼› å°†å‘é€é˜Ÿåˆ—å¤´çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºä¸­ï¼Œé‡Šæ”¾ä¸€ä¸ªé˜»å¡çš„å‘é€æ–¹ï¼› å½“ Channel çš„å‘é€é˜Ÿåˆ—ä¸­ä¸å­˜åœ¨ç­‰å¾…çš„ Goroutine å¹¶ä¸”ç¼“å†²åŒºä¸­ä¹Ÿä¸å­˜åœ¨ä»»ä½•æ•°æ®æ—¶ï¼Œä»ç®¡é“ä¸­æ¥æ”¶æ•°æ®çš„æ“ä½œä¼šå˜æˆé˜»å¡çš„ï¼Œç„¶è€Œä¸æ˜¯æ‰€æœ‰çš„æ¥æ”¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ï¼Œä¸ select è¯­å¥ç»“åˆä½¿ç”¨æ—¶å°±å¯èƒ½ä¼šä½¿ç”¨åˆ°éé˜»å¡çš„æ¥æ”¶æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func chanrecv(c *hchan, ep unsafe.Pointer, block bool) (selected, received bool) { ... if !block { unlock(\u0026amp;c.lock) return false, false } gp := getg() mysg := acquireSudog() mysg.elem = ep gp.waiting = mysg mysg.g = gp mysg.c = c c.recvq.enqueue(mysg) goparkunlock(\u0026amp;c.lock, waitReasonChanReceive, traceEvGoBlockRecv, 3) gp.waiting = nil closed := gp.param == nil gp.param = nil releaseSudog(mysg) return true, !closed } åœ¨æ­£å¸¸çš„æ¥æ”¶åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨ runtime.sudog å°†å½“å‰ Goroutine åŒ…è£…æˆä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„ Goroutine å¹¶å°†å…¶åŠ å…¥åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸­ã€‚\nå®Œæˆå…¥é˜Ÿä¹‹åï¼Œä¸Šè¿°ä»£ç è¿˜ä¼šè°ƒç”¨ runtime.goparkunlock ç«‹åˆ»è§¦å‘ Goroutine çš„è°ƒåº¦ï¼Œè®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒå¹¶ç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚\nch \u0026lt;- i å‘ Channel å‘é€æ•°æ®æ—¶é‡åˆ°çš„å‡ ç§æƒ…å†µï¼š\nå¦‚æœå½“å‰ Channel çš„ recvq ä¸Šå­˜åœ¨å·²ç»è¢«é˜»å¡çš„ Goroutineï¼Œé‚£ä¹ˆä¼šç›´æ¥å°†æ•°æ®å‘é€ç»™å½“å‰ Goroutine å¹¶å°†å…¶è®¾ç½®æˆä¸‹ä¸€ä¸ªè¿è¡Œçš„ Goroutineï¼› å¦‚æœ Channel å­˜åœ¨ç¼“å†²åŒºå¹¶ä¸”å…¶ä¸­è¿˜æœ‰ç©ºé—²çš„å®¹é‡ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†æ•°æ®å­˜å‚¨åˆ°ç¼“å†²åŒº sendx æ‰€åœ¨çš„ä½ç½®ä¸Šï¼› å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„ä¸¤ç§æƒ…å†µï¼Œä¼šåˆ›å»ºä¸€ä¸ª runtime.sudog ç»“æ„å¹¶å°†å…¶åŠ å…¥ Channel çš„ sendq é˜Ÿåˆ—ä¸­ï¼Œå½“å‰ Goroutine ä¹Ÿä¼šé™·å…¥é˜»å¡ç­‰å¾…å…¶ä»–çš„åç¨‹ä» Channel æ¥æ”¶æ•°æ®ï¼› å‘é€æ•°æ®çš„è¿‡ç¨‹ä¸­åŒ…å«å‡ ä¸ªä¼šè§¦å‘ Goroutine è°ƒåº¦çš„æ—¶æœºï¼š\nå‘é€æ•°æ®æ—¶å‘ç° Channel ä¸Šå­˜åœ¨ç­‰å¾…æ¥æ”¶æ•°æ®çš„ Goroutineï¼Œç«‹åˆ»è®¾ç½®å¤„ç†å™¨çš„ runnext å±æ€§ï¼Œä½†æ˜¯å¹¶ä¸ä¼šç«‹åˆ»è§¦å‘è°ƒåº¦ï¼› å‘é€æ•°æ®æ—¶å¹¶æ²¡æœ‰æ‰¾åˆ°æ¥æ”¶æ–¹å¹¶ä¸”ç¼“å†²åŒºå·²ç»æ»¡äº†ï¼Œè¿™æ—¶ä¼šå°†è‡ªå·±åŠ å…¥ Channel çš„ sendq é˜Ÿåˆ—å¹¶è°ƒç”¨ runtime.goparkunlock è§¦å‘ Goroutine çš„è°ƒåº¦è®©å‡ºå¤„ç†å™¨çš„ä½¿ç”¨æƒï¼› ä» Channel ä¸­æ¥æ”¶æ•°æ®æ—¶å¯èƒ½ä¼šå‘ç”Ÿçš„äº”ç§æƒ…å†µï¼š\nå¦‚æœ Channel ä¸ºç©ºï¼Œé‚£ä¹ˆä¼šç›´æ¥è°ƒç”¨ runtime.gopark æŒ‚èµ·å½“å‰ Goroutineï¼› å¦‚æœ Channel å·²ç»å…³é—­å¹¶ä¸”ç¼“å†²åŒºæ²¡æœ‰ä»»ä½•æ•°æ®ï¼Œruntime.chanrecv ä¼šç›´æ¥è¿”å›ï¼› å¦‚æœ Channel çš„ sendq é˜Ÿåˆ—ä¸­å­˜åœ¨æŒ‚èµ·çš„ Goroutineï¼Œä¼šå°† recvx ç´¢å¼•æ‰€åœ¨çš„æ•°æ®æ‹·è´åˆ°æ¥æ”¶å˜é‡æ‰€åœ¨çš„å†…å­˜ç©ºé—´ä¸Šå¹¶å°† sendq é˜Ÿåˆ—ä¸­ Goroutine çš„æ•°æ®æ‹·è´åˆ°ç¼“å†²åŒºï¼› å¦‚æœ Channel çš„ç¼“å†²åŒºä¸­åŒ…å«æ•°æ®ï¼Œé‚£ä¹ˆç›´æ¥è¯»å– recvx ç´¢å¼•å¯¹åº”çš„æ•°æ®ï¼› åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šæŒ‚èµ·å½“å‰çš„ Goroutineï¼Œå°† runtime.sudog ç»“æ„åŠ å…¥ recvq é˜Ÿåˆ—å¹¶é™·å…¥ä¼‘çœ ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼› æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä» Channel æ¥æ”¶æ•°æ®æ—¶ï¼Œä¼šè§¦å‘ Goroutine è°ƒåº¦çš„ä¸¤ä¸ªæ—¶æœºï¼š\nå½“ Channel ä¸ºç©ºæ—¶ï¼› å½“ç¼“å†²åŒºä¸­ä¸å­˜åœ¨æ•°æ®å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨æ•°æ®çš„å‘é€è€…æ—¶ï¼› 2. Select Linuxçš„select æ˜¯æ“ä½œç³»ç»Ÿä¸­çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ selectã€poll å’Œ epoll ç­‰å‡½æ•°æ„å»º I/O å¤šè·¯å¤ç”¨æ¨¡å‹æå‡ç¨‹åºçš„æ€§èƒ½ï¼ˆsynchronous I/O multiplexingï¼‰ã€‚Go è¯­è¨€çš„ select ä¸æ“ä½œç³»ç»Ÿä¸­çš„ select æ¯”è¾ƒç›¸ä¼¼ï¼ŒC è¯­è¨€çš„ select ç³»ç»Ÿè°ƒç”¨å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å¯è¯»æˆ–è€…å¯å†™çš„çŠ¶æ€ï¼ŒGo è¯­è¨€ä¸­çš„ select ä¹Ÿèƒ½å¤Ÿè®© Goroutine åŒæ—¶ç­‰å¾…å¤šä¸ª Channel å¯è¯»æˆ–è€…å¯å†™ï¼Œåœ¨å¤šä¸ªæ–‡ä»¶æˆ–è€… ChannelçŠ¶æ€æ”¹å˜ä¹‹å‰ï¼Œselect ä¼šä¸€ç›´é˜»å¡å½“å‰çº¿ç¨‹æˆ–è€… Goroutineã€‚\nå¦‚æœæ˜¯å¸¦æœ‰chançš„è¯­å¥ï¼Œåˆ™ä¼šç›´æ¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š\nå½“å­˜åœ¨å¯ä»¥æ”¶å‘çš„ Channel æ—¶ï¼Œç›´æ¥å¤„ç†è¯¥ Channel å¯¹åº”çš„ caseï¼› å½“ä¸å­˜åœ¨å¯ä»¥æ”¶å‘çš„ Channel æ—¶ï¼Œæ‰§è¡Œ default ä¸­çš„è¯­å¥ï¼› ç©ºçš„selectä¼šç›´æ¥è½¬æ¢æˆè°ƒç”¨ runtime.block å‡½æ•°ï¼Œé˜»å¡è¿™ä¸ªGoroutineå¹¶ä¸”æ°¸è¿œæ— æ³•å”¤é†’ã€‚\nå¦‚æœå½“å‰çš„ select æ¡ä»¶åªåŒ…å«ä¸€ä¸ª caseï¼Œé‚£ä¹ˆç¼–è¯‘å™¨ä¼šå°† select æ”¹å†™æˆ if æ¡ä»¶è¯­å¥ã€‚ä¸‹é¢å¯¹æ¯”äº†æ”¹å†™å‰åçš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 // æ”¹å†™å‰ select { case v, ok \u0026lt;-ch: // case ch \u0026lt;- v ... } // æ”¹å†™å if ch == nil { block() } v, ok := \u0026lt;-ch // case ch \u0026lt;- v ... å½“ select ä¸­ä»…åŒ…å«ä¸¤ä¸ª caseï¼Œå¹¶ä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯ default æ—¶ï¼ŒGo è¯­è¨€çš„ç¼–è¯‘å™¨å°±ä¼šè®¤ä¸ºè¿™æ˜¯ä¸€æ¬¡éé˜»å¡çš„æ”¶å‘æ“ä½œã€‚cmd/compile/internal/gc.walkselectcases ä¼šå¯¹è¿™ç§æƒ…å†µå•ç‹¬å¤„ç†ã€‚ä¸è¿‡åœ¨æ­£å¼ä¼˜åŒ–ä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¼šå°† case ä¸­çš„æ‰€æœ‰ Channel éƒ½è½¬æ¢æˆæŒ‡å‘ Channel çš„åœ°å€ï¼Œæˆ‘ä»¬ä¼šåˆ†åˆ«ä»‹ç»éé˜»å¡å‘é€å’Œéé˜»å¡æ¥æ”¶æ—¶ï¼Œç¼–è¯‘å™¨è¿›è¡Œçš„ä¸åŒä¼˜åŒ–ã€‚\nç¼–è¯‘å™¨ä¼šä½¿ç”¨å¦‚ä¸‹çš„æµç¨‹å¤„ç† select è¯­å¥\nå°†æ‰€æœ‰çš„ case è½¬æ¢æˆåŒ…å« Channel ä»¥åŠç±»å‹ç­‰ä¿¡æ¯çš„ runtime.scase ç»“æ„ä½“ï¼›\nè°ƒç”¨è¿è¡Œæ—¶å‡½æ•° runtime.selectgo ä»å¤šä¸ªå‡†å¤‡å°±ç»ªçš„ Channel ä¸­é€‰æ‹©ä¸€ä¸ªå¯æ‰§è¡Œçš„ runtime.scase ç»“æ„ä½“ï¼›\né€šè¿‡ for å¾ªç¯ç”Ÿæˆä¸€ç»„ if è¯­å¥ï¼Œåœ¨è¯­å¥ä¸­åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯è¢«é€‰ä¸­çš„ caseï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func selectgo(cas0 *scase, order0 *uint16, ncases int) (int, bool) { cas1 := (*[1 \u0026lt;\u0026lt; 16]scase)(unsafe.Pointer(cas0)) order1 := (*[1 \u0026lt;\u0026lt; 17]uint16)(unsafe.Pointer(order0)) ncases := nsends + nrecvs scases := cas1[:ncases:ncases] pollorder := order1[:ncases:ncases] lockorder := order1[ncases:][:ncases:ncases] norder := 0 for i := range scases { cas := \u0026amp;scases[i] } for i := 1; i \u0026lt; ncases; i++ { j := fastrandn(uint32(i + 1)) pollorder[norder] = pollorder[j] pollorder[j] = uint16(i) norder++ } pollorder = pollorder[:norder] lockorder = lockorder[:norder] // æ ¹æ® Channel çš„åœ°å€æ’åºç¡®å®šåŠ é”é¡ºåº ... sellock(scases, lockorder) ... } Go è¯­è¨€ä¼šå¯¹ select è¯­å¥è¿›è¡Œä¼˜åŒ–ï¼Œå®ƒä¼šæ ¹æ® select ä¸­ case çš„ä¸åŒé€‰æ‹©ä¸åŒçš„ä¼˜åŒ–è·¯å¾„ï¼š\nç©ºçš„ select è¯­å¥ä¼šè¢«è½¬æ¢æˆè°ƒç”¨ runtime.block ç›´æ¥æŒ‚èµ·å½“å‰ Goroutineï¼› å¦‚æœ select è¯­å¥ä¸­åªåŒ…å«ä¸€ä¸ª caseï¼Œç¼–è¯‘å™¨ä¼šå°†å…¶è½¬æ¢æˆ if ch == nil { block }; n; è¡¨è¾¾å¼ï¼› é¦–å…ˆåˆ¤æ–­æ“ä½œçš„ Channel æ˜¯ä¸æ˜¯ç©ºçš„ï¼›ç„¶åæ‰§è¡Œ case ç»“æ„ä¸­çš„å†…å®¹ï¼›å¦‚æœ select è¯­å¥ä¸­åªåŒ…å«ä¸¤ä¸ª case å¹¶ä¸”å…¶ä¸­ä¸€ä¸ªæ˜¯ defaultï¼Œé‚£ä¹ˆä¼šä½¿ç”¨ runtime.selectnbrecv å’Œ runtime.selectnbsend éé˜»å¡åœ°æ‰§è¡Œæ”¶å‘æ“ä½œï¼› åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šé€šè¿‡ runtime.selectgo è·å–æ‰§è¡Œ case çš„ç´¢å¼•ï¼Œå¹¶é€šè¿‡å¤šä¸ª if è¯­å¥æ‰§è¡Œå¯¹åº” case ä¸­çš„ä»£ç ï¼› åœ¨ç¼–è¯‘å™¨å·²ç»å¯¹ select è¯­å¥è¿›è¡Œä¼˜åŒ–ä¹‹åï¼ŒGo è¯­è¨€ä¼šåœ¨è¿è¡Œæ—¶æ‰§è¡Œç¼–è¯‘æœŸé—´å±•å¼€çš„ runtime.selectgo å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šæŒ‰ç…§ä»¥ä¸‹çš„æµç¨‹æ‰§è¡Œï¼š\néšæœºç”Ÿæˆä¸€ä¸ªéå†çš„è½®è¯¢é¡ºåº pollOrder å¹¶æ ¹æ® Channel åœ°å€ç”Ÿæˆé”å®šé¡ºåº lockOrderï¼› æ ¹æ® pollOrder éå†æ‰€æœ‰çš„ case æŸ¥çœ‹æ˜¯å¦æœ‰å¯ä»¥ç«‹åˆ»å¤„ç†çš„ Channelï¼› 1.å¦‚æœå­˜åœ¨ï¼Œç›´æ¥è·å– case å¯¹åº”çš„ç´¢å¼•å¹¶è¿”å›ï¼› 2.å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º runtime.sudog ç»“æ„ä½“ï¼Œå°†å½“å‰ Goroutine åŠ å…¥åˆ°æ‰€æœ‰ç›¸å…³ Channel çš„æ”¶å‘é˜Ÿåˆ—ï¼Œå¹¶è°ƒç”¨ runtime.gopark æŒ‚èµ·å½“å‰ Goroutine ç­‰å¾…è°ƒåº¦å™¨çš„å”¤é†’ï¼› å½“è°ƒåº¦å™¨å”¤é†’å½“å‰ Goroutine æ—¶ï¼Œä¼šå†æ¬¡æŒ‰ç…§ lockOrder éå†æ‰€æœ‰çš„ caseï¼Œä»ä¸­æŸ¥æ‰¾éœ€è¦è¢«å¤„ç†çš„ runtime.sudog å¯¹åº”çš„ç´¢å¼•ï¼› 3. Locker 1 2 3 4 5 // A Locker represents an object that can be locked and unlocked. type Locker interface { Lock() Unlock() } 4. Mutex 1 2 3 4 5 6 7 8 9 type Mutex struct { state int32 sema uint32 } //åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œäº’æ–¥é”çš„æ‰€æœ‰çŠ¶æ€ä½éƒ½æ˜¯ 0ï¼Œint32 ä¸­çš„ä¸åŒä½åˆ†åˆ«è¡¨ç¤ºäº†ä¸åŒçš„çŠ¶æ€ï¼š //waitersCount â€” å½“å‰äº’æ–¥é”ä¸Šç­‰å¾…çš„ Goroutine ä¸ªæ•°ï¼› //mutexStarving â€” å½“å‰çš„äº’æ–¥é”è¿›å…¥é¥¥é¥¿çŠ¶æ€ï¼› //mutexWoken â€” è¡¨ç¤ºä»æ­£å¸¸æ¨¡å¼è¢«ä»å”¤é†’ï¼› //mutexLocked â€” è¡¨ç¤ºäº’æ–¥é”çš„é”å®šçŠ¶æ€ï¼› åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œé”çš„ç­‰å¾…è€…ä¼šæŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„é¡ºåºè·å–é”ã€‚ä½†æ˜¯åˆšè¢«å”¤èµ·çš„ Goroutine ä¸æ–°åˆ›å»ºçš„ Goroutine ç«äº‰æ—¶ï¼Œå¤§æ¦‚ç‡ä¼šè·å–ä¸åˆ°é”ï¼Œä¸ºäº†å‡å°‘è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œä¸€æ—¦ Goroutine è¶…è¿‡ 1ms æ²¡æœ‰è·å–åˆ°é”ï¼Œå®ƒå°±ä¼šå°†å½“å‰äº’æ–¥é”åˆ‡æ¢é¥¥é¥¿æ¨¡å¼ï¼Œ\nåœ¨casçŠ¶æ€ä¸æˆåŠŸæ—¶ï¼Œä¼šè¿›å…¥å¦‚ä¸‹çš„ä¸€ä¸ªå¾ªç¯ï¼Œåˆ¤æ–­å½“å‰ Goroutine èƒ½å¦è¿›å…¥è‡ªæ—‹ï¼š\näº’æ–¥é”åªæœ‰åœ¨æ™®é€šæ¨¡å¼æ‰èƒ½è¿›å…¥è‡ªæ—‹ï¼› runtime.sync_runtime_canSpin éœ€è¦è¿”å› trueï¼š è¿è¡Œåœ¨å¤š CPU çš„æœºå™¨ä¸Šï¼Œå¹¶ä¸”GOMAXPROCS \u0026gt; 1ï¼› å½“å‰ Goroutine ä¸ºäº†è·å–è¯¥é”è¿›å…¥è‡ªæ—‹çš„æ¬¡æ•°å°äºå››æ¬¡ï¼› å½“å‰æœºå™¨ä¸Šè‡³å°‘å­˜åœ¨ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„å¤„ç†å™¨ P å¹¶ä¸”å¤„ç†çš„è¿è¡Œé˜Ÿåˆ—ä¸ºç©º 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 var waitStartTime int64 starving := false awoke := false iter := 0 old := m.state for { if old\u0026amp;(mutexLocked|mutexStarving) == mutexLocked \u0026amp;\u0026amp; runtime_canSpin(iter) { if !awoke \u0026amp;\u0026amp; old\u0026amp;mutexWoken == 0 \u0026amp;\u0026amp; old\u0026gt;\u0026gt;mutexWaiterShift != 0 \u0026amp;\u0026amp; atomic.CompareAndSwapInt32(\u0026amp;m.state, old, old|mutexWoken) { awoke = true } runtime_doSpin() iter++ old = m.state continue } åœ¨å¤„ç†è‡ªæ—‹é€»è¾‘ä»¥åï¼Œäº’æ–¥é”ä¼šå†æ¬¡æ ¹æ®ä¸Šä¸‹æ–‡æ¥è®¡ç®—äº’æ–¥é”æœ€æ–°çš„çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 new := old if old\u0026amp;mutexStarving == 0 { new |= mutexLocked } if old\u0026amp;(mutexLocked|mutexStarving) != 0 { new += 1 \u0026lt;\u0026lt; mutexWaiterShift } if starving \u0026amp;\u0026amp; old\u0026amp;mutexLocked != 0 { new |= mutexStarving } if awoke { new \u0026amp;^= mutexWoken } åœ¨äº’æ–¥é”çŠ¶æ€æ›´æ–°ç»“æŸä»¥åï¼Œä¼šè®©CASå†æ¬¡æ›´æ–°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 if atomic.CompareAndSwapInt32(\u0026amp;m.state, old, new) { if old\u0026amp;(mutexLocked|mutexStarving) == 0 { break // é€šè¿‡ CAS å‡½æ•°è·å–äº†é” } ... runtime_SemacquireMutex(\u0026amp;m.sema, queueLifo, 1) starving = starving || runtime_nanotime()-waitStartTime \u0026gt; starvationThresholdNs old = m.state if old\u0026amp;mutexStarving != 0 { delta := int32(mutexLocked - 1\u0026lt;\u0026lt;mutexWaiterShift) if !starving || old\u0026gt;\u0026gt;mutexWaiterShift == 1 { delta -= mutexStarving } atomic.AddInt32(\u0026amp;m.state, delta) break } awoke = true iter = 0 } else { old = m.state } åœ¨æ­£å¸¸æ¨¡å¼ä¸‹ï¼Œè¿™æ®µä»£ç ä¼šè®¾ç½®å”¤é†’å’Œé¥¥é¥¿æ ‡è®°ã€é‡ç½®è¿­ä»£æ¬¡æ•°å¹¶é‡æ–°æ‰§è¡Œè·å–é”çš„å¾ªç¯ï¼› åœ¨é¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œå½“å‰ Goroutine ä¼šè·å¾—äº’æ–¥é”ï¼Œå¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸­åªå­˜åœ¨å½“å‰ Goroutineï¼Œäº’æ–¥é”è¿˜ä¼šä»é¥¥é¥¿æ¨¡å¼ä¸­é€€å‡ºï¼›\né€šè¿‡è‡ªæ—‹ç­‰å¾…äº’æ–¥é”çš„é‡Šæ”¾ï¼› è®¡ç®—äº’æ–¥é”çš„æœ€æ–°çŠ¶æ€ï¼› æ›´æ–°äº’æ–¥é”çš„çŠ¶æ€å¹¶è·å–é”ï¼› å¦‚æœè¯¥å‡½æ•°è¿”å›çš„æ–°çŠ¶æ€ç­‰äº 0ï¼Œå½“å‰ Goroutine å°±æˆåŠŸè§£é”äº†äº’æ–¥é”ï¼› å¦‚æœè¯¥å‡½æ•°è¿”å›çš„æ–°çŠ¶æ€ä¸ç­‰äº 0ï¼Œè¿™æ®µä»£ç ä¼šè°ƒç”¨ sync.Mutex.unlockSlow å¼€å§‹æ…¢é€Ÿè§£é”ï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (m *Mutex) unlockSlow(new int32) { if (new+mutexLocked)\u0026amp;mutexLocked == 0 { throw(\u0026#34;sync: unlock of unlocked mutex\u0026#34;) } if new\u0026amp;mutexStarving == 0 { // æ­£å¸¸æ¨¡å¼ old := new for { if old\u0026gt;\u0026gt;mutexWaiterShift == 0 || old\u0026amp;(mutexLocked|mutexWoken|mutexStarving) != 0 { return } new = (old - 1\u0026lt;\u0026lt;mutexWaiterShift) | mutexWoken if atomic.CompareAndSwapInt32(\u0026amp;m.state, old, new) { runtime_Semrelease(\u0026amp;m.sema, false, 1) return } old = m.state } } else { // é¥¥é¥¿æ¨¡å¼ runtime_Semrelease(\u0026amp;m.sema, true, 1) } } 5. RWMutex 1 2 3 4 5 6 7 type RWMutex struct { w Mutex // held if there are pending writers writerSem uint32 // semaphore for writers to wait for completing readers readerSem uint32 // semaphore for readers to wait for completing writers readerCount int32 // number of pending readers readerWait int32 // number of departing readers } writerSemå’ŒreaderSemåˆ†åˆ«ç”¨äºå†™ç­‰å¾…è¯»å’Œè¯»ç­‰å¾…å†™\nå½“èµ„æºçš„ä½¿ç”¨è€…æƒ³è¦è·å–å†™é”æ—¶ï¼Œéœ€è¦è°ƒç”¨ sync.RWMutex.Lock æ–¹æ³•ï¼š\n1 2 3 4 5 6 7 func (rw *RWMutex) Lock() { rw.w.Lock() r := atomic.AddInt32(\u0026amp;rw.readerCount, -rwmutexMaxReaders) + rwmutexMaxReaders if r != 0 \u0026amp;\u0026amp; atomic.AddInt32(\u0026amp;rw.readerWait, r) != 0 { runtime_SemacquireMutex(\u0026amp;rw.writerSem, false, 0) } } è°ƒç”¨ç»“æ„ä½“æŒæœ‰çš„ sync.Mutex ç»“æ„ä½“çš„ sync.Mutex.Lock é˜»å¡åç»­çš„å†™æ“ä½œï¼› å› ä¸ºäº’æ–¥é”å·²ç»è¢«è·å–ï¼Œå…¶ä»– Goroutine åœ¨è·å–å†™é”æ—¶ä¼šè¿›å…¥è‡ªæ—‹æˆ–è€…ä¼‘çœ ï¼› è°ƒç”¨ sync/atomic.AddInt32 å‡½æ•°é˜»å¡åç»­çš„è¯»æ“ä½œï¼š å¦‚æœä»ç„¶æœ‰å…¶ä»– Goroutine æŒæœ‰äº’æ–¥é”çš„è¯»é”ï¼Œè¯¥ Goroutine ä¼šè°ƒç”¨ runtime.sync_runtime_SemacquireMutex è¿›å…¥ä¼‘çœ çŠ¶æ€ç­‰å¾…æ‰€æœ‰è¯»é”æ‰€æœ‰è€…æ‰§è¡Œç»“æŸåé‡Šæ”¾ writerSem ä¿¡å·é‡å°†å½“å‰åç¨‹å”¤é†’ï¼›\n1 2 3 4 5 6 7 8 9 10 func (rw *RWMutex) Unlock() { r := atomic.AddInt32(\u0026amp;rw.readerCount, rwmutexMaxReaders) if r \u0026gt;= rwmutexMaxReaders { throw(\u0026#34;sync: Unlock of unlocked RWMutex\u0026#34;) } for i := 0; i \u0026lt; int(r); i++ { runtime_Semrelease(\u0026amp;rw.readerSem, false, 0) } rw.w.Unlock() } è°ƒç”¨ sync/atomic.AddInt32 å‡½æ•°å°† readerCount å˜å›æ­£æ•°ï¼Œé‡Šæ”¾è¯»é”ï¼› é€šè¿‡ for å¾ªç¯é‡Šæ”¾æ‰€æœ‰å› ä¸ºè·å–è¯»é”è€Œé™·å…¥ç­‰å¾…çš„ Goroutineï¼š è°ƒç”¨ sync.Mutex.Unlock é‡Šæ”¾å†™é”ï¼› è¯»é”çš„åŠ é”æ–¹æ³• sync.RWMutex.RLock å¾ˆç®€å•ï¼Œè¯¥æ–¹æ³•ä¼šé€šè¿‡ sync/atomic.AddInt32 å°† readerCount åŠ ä¸€ï¼š\n1 2 3 4 5 func (rw *RWMutex) RLock() { if atomic.AddInt32(\u0026amp;rw.readerCount, 1) \u0026lt; 0 { runtime_SemacquireMutex(\u0026amp;rw.readerSem, false, 0) } } å¦‚æœè¯¥æ–¹æ³•è¿”å›è´Ÿæ•° â€” å…¶ä»– Goroutine è·å¾—äº†å†™é”ï¼Œå½“å‰ Goroutine å°±ä¼šè°ƒç”¨ runtime.sync_runtime_SemacquireMutex é™·å…¥ä¼‘çœ ç­‰å¾…é”çš„é‡Šæ”¾ï¼› å¦‚æœè¯¥æ–¹æ³•çš„ç»“æœä¸ºéè´Ÿæ•° â€” æ²¡æœ‰ Goroutine è·å¾—å†™é”ï¼Œå½“å‰æ–¹æ³•ä¼šæˆåŠŸè¿”å›ï¼› å½“ Goroutine æƒ³è¦é‡Šæ”¾è¯»é”æ—¶ï¼Œä¼šè°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºçš„ sync.RWMutex.RUnlock æ–¹æ³•ï¼š\n1 2 3 4 5 func (rw *RWMutex) RUnlock() { if r := atomic.AddInt32(\u0026amp;rw.readerCount, -1); r \u0026lt; 0 { rw.rUnlockSlow(r) } } è¯¥æ–¹æ³•ä¼šå…ˆå‡å°‘æ­£åœ¨è¯»èµ„æºçš„ readerCount æ•´æ•°ï¼Œæ ¹æ® sync/atomic.AddInt32 çš„è¿”å›å€¼ä¸åŒä¼šåˆ†åˆ«è¿›è¡Œå¤„ç†ï¼š\nå¦‚æœè¿”å›å€¼å¤§äºç­‰äºé›¶ â€” è¯»é”ç›´æ¥è§£é”æˆåŠŸï¼› å¦‚æœè¿”å›å€¼å°äºé›¶ â€” æœ‰ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„å†™æ“ä½œï¼Œåœ¨è¿™æ—¶ä¼šè°ƒç”¨sync.RWMutex.rUnlockSlow æ–¹æ³•ï¼›\n1 2 3 4 5 6 7 8 func (rw *RWMutex) rUnlockSlow(r int32) { if r+1 == 0 || r+1 == -rwmutexMaxReaders { throw(\u0026#34;sync: RUnlock of unlocked RWMutex\u0026#34;) } if atomic.AddInt32(\u0026amp;rw.readerWait, -1) == 0 { runtime_Semrelease(\u0026amp;rw.writerSem, false, 1) } } sync.RWMutex.rUnlockSlow ä¼šå‡å°‘è·å–é”çš„å†™æ“ä½œç­‰å¾…çš„è¯»æ“ä½œæ•° readerWait å¹¶åœ¨æ‰€æœ‰è¯»æ“ä½œéƒ½è¢«é‡Šæ”¾ä¹‹åè§¦å‘å†™æ“ä½œçš„ä¿¡å·é‡ writerSemï¼Œè¯¥ä¿¡å·é‡è¢«è§¦å‘æ—¶ï¼Œè°ƒåº¦å™¨å°±ä¼šå”¤é†’å°è¯•è·å–å†™é”çš„ Goroutineã€‚\n6. WaitGroup 1 2 3 4 5 6 7 8 9 10 type WaitGroup struct { noCopy noCopy // 64-bit value: high 32 bits are counter, low 32 bits are waiter count. // 64-bit atomic operations require 64-bit alignment, but 32-bit // compilers do not ensure it. So we allocate 12 bytes and then use // the aligned 8 bytes in them as state, and the other 4 as storage // for the sema. state1 [3]uint32 } å…¶ä¸­noCopyç¡®ä¿ä¸ä¼šè¢«èµ‹å€¼çš„æ–¹å¼æ‹·è´ï¼Œstate1è®°å½•çŠ¶æ€é‡ï¼Œå…¶æä¾›äº†ä¸‰ä¸ªæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func (wg *WaitGroup) Add(delta int) { statep, semap := wg.state() state := atomic.AddUint64(statep, uint64(delta)\u0026lt;\u0026lt;32) v := int32(state \u0026gt;\u0026gt; 32) w := uint32(state) if v \u0026lt; 0 { panic(\u0026#34;sync: negative WaitGroup counter\u0026#34;) } if v \u0026gt; 0 || w == 0 { return } *statep = 0 for ; w != 0; w-- { runtime_Semrelease(semap, false, 0) } } // Done decrements the WaitGroup counter by one. func (wg *WaitGroup) Done() { wg.Add(-1) } é€šè¿‡å¯¹ sync.WaitGroup çš„åˆ†æå’Œç ”ç©¶ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š\nsync.WaitGroup å¿…é¡»åœ¨ sync.WaitGroup.Wait æ–¹æ³•è¿”å›ä¹‹åæ‰èƒ½è¢«é‡æ–°ä½¿ç”¨ï¼› sync.WaitGroup.Done åªæ˜¯å¯¹ sync.WaitGroup.Add æ–¹æ³•çš„ç®€å•å°è£…ï¼Œæˆ‘ä»¬å¯ä»¥å‘ sync.WaitGroup.Add æ–¹æ³•ä¼ å…¥ä»»æ„è´Ÿæ•°ï¼ˆéœ€è¦ä¿è¯è®¡æ•°å™¨éè´Ÿï¼‰å¿«é€Ÿå°†è®¡æ•°å™¨å½’é›¶ä»¥å”¤é†’ç­‰å¾…çš„ Goroutineï¼› å¯ä»¥åŒæ—¶æœ‰å¤šä¸ª Goroutine ç­‰å¾…å½“å‰ sync.WaitGroup è®¡æ•°å™¨çš„å½’é›¶ï¼Œè¿™äº› Goroutine ä¼šè¢«åŒæ—¶å”¤é†’ï¼› 7. Once 1 2 3 4 type Once struct { done uint32 m Mutex } ä¸ºå½“å‰ Goroutine è·å–äº’æ–¥é”ï¼› æ‰§è¡Œä¼ å…¥çš„æ— å…¥å‚å‡½æ•°ï¼› è¿è¡Œå»¶è¿Ÿå‡½æ•°è°ƒç”¨ï¼Œå°†æˆå‘˜å˜é‡ done æ›´æ–°æˆ 1ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func (o *Once) Do(f func()) { if atomic.LoadUint32(\u0026amp;o.done) == 0 { o.doSlow(f) } } func (o *Once) doSlow(f func()) { o.m.Lock() defer o.m.Unlock() if o.done == 0 { defer atomic.StoreUint32(\u0026amp;o.done, 1) f() } } 8. Context 1 2 3 4 5 6 type Context interface { Deadline() (deadline time.Time, ok bool) Done() \u0026lt;-chan struct{} Err() error Value(key interface{}) interface{} } åœ¨ Goroutine æ„æˆçš„æ ‘å½¢ç»“æ„ä¸­å¯¹ä¿¡å·è¿›è¡ŒåŒæ­¥ä»¥å‡å°‘è®¡ç®—èµ„æºçš„æµªè´¹æ˜¯ context.Context çš„æœ€å¤§ä½œç”¨ã€‚Go æœåŠ¡çš„æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯é€šè¿‡å•ç‹¬çš„ Goroutine å¤„ç†çš„ï¼ŒHTTP/RPC è¯·æ±‚çš„å¤„ç†å™¨ä¼šå¯åŠ¨æ–°çš„ Goroutine è®¿é—®æ•°æ®åº“å’Œå…¶ä»–æœåŠ¡ã€‚\néƒ½ä¼šä»æœ€é¡¶å±‚çš„ Goroutine ä¸€å±‚ä¸€å±‚ä¼ é€’åˆ°æœ€ä¸‹å±‚ã€‚context.Context å¯ä»¥åœ¨ä¸Šå±‚ Goroutine æ‰§è¡Œå‡ºç°é”™è¯¯æ—¶ï¼Œå°†ä¿¡å·åŠæ—¶åŒæ­¥ç»™ä¸‹å±‚ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type emptyCtx int func (*emptyCtx) Deadline() (deadline time.Time, ok bool) { return } func (*emptyCtx) Done() \u0026lt;-chan struct{} { return nil } func (*emptyCtx) Err() error { return nil } func (*emptyCtx) Value(key interface{}) interface{} { return nil } context.Background æ˜¯ä¸Šä¸‹æ–‡çš„é»˜è®¤å€¼ï¼Œæ‰€æœ‰å…¶ä»–çš„ä¸Šä¸‹æ–‡éƒ½åº”è¯¥ä»å®ƒè¡ç”Ÿå‡ºæ¥ï¼› context.TODO åº”è¯¥ä»…åœ¨ä¸ç¡®å®šåº”è¯¥ä½¿ç”¨å“ªç§ä¸Šä¸‹æ–‡æ—¶ä½¿ç”¨ï¼› 9. Map 1 2 3 4 5 6 7 8 9 10 type Map struct { // åŠ é”ä½œç”¨ï¼Œä¿æŠ¤ dirty å­—æ®µ mu Mutex // åªè¯»çš„æ•°æ®ï¼Œå®é™…æ•°æ®ç±»å‹ä¸º readOnly read atomic.Value // æœ€æ–°å†™å…¥çš„æ•°æ® dirty map[interface{}]*entry // è®¡æ•°å™¨ï¼Œæ¯æ¬¡éœ€è¦è¯» dirty åˆ™ +1 misses int } ä½¿ç”¨readï¼Œdirtyç©ºé—´æ¢æ—¶é—´ã€‚é€šè¿‡å¼•å…¥ä¸¤ä¸ªmapå°†è¯»å†™åˆ†ç¦»åˆ°ä¸åŒçš„mapï¼Œå…¶ä¸­read mapæä¾›å¹¶å‘è¯»å’Œå·²å­˜å…ƒç´ åŸå­å†™ï¼Œè€Œdirty mapåˆ™è´Ÿè´£è¯»å†™ã€‚ è¿™æ ·read mapå°±å¯ä»¥åœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹è¿›è¡Œå¹¶å‘è¯»å–,å½“read mapä¸­æ²¡æœ‰è¯»å–åˆ°å€¼æ—¶,å†åŠ é”è¿›è¡Œåç»­è¯»å–,å¹¶ç´¯åŠ æœªå‘½ä¸­æ•°ã€‚ å½“æœªå‘½ä¸­æ•°å¤§äºç­‰äºdirty mapé•¿åº¦,å°†dirty mapä¸Šå‡ä¸ºread mapã€‚ ä»ç»“æ„ä½“çš„å®šä¹‰å¯ä»¥å‘ç°ï¼Œè™½ç„¶å¼•å…¥äº†ä¸¤ä¸ªmapï¼Œä½†æ˜¯åº•å±‚æ•°æ®å­˜å‚¨çš„æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘çš„æ˜¯åŒä¸€ä»½å€¼ã€‚\nå…¶ä¸­è®¾ç½®ReadOnlyçš„å­—æ®µä¸ºï¼š\n1 2 3 4 5 6 type readOnly struct { // å†…å»º map m map[interface{}]*entry // è¡¨ç¤º dirty é‡Œå­˜åœ¨ read é‡Œæ²¡æœ‰çš„ keyï¼Œé€šè¿‡è¯¥å­—æ®µå†³å®šæ˜¯å¦åŠ é”è¯» dirty amended bool } é€šè¿‡ read å’Œ dirty ä¸¤ä¸ªå­—æ®µå°†è¯»å†™åˆ†ç¦»ï¼Œè¯»çš„æ•°æ®å­˜åœ¨åªè¯»å­—æ®µ read ä¸Šï¼Œå°†æœ€æ–°å†™å…¥çš„æ•°æ®åˆ™å­˜åœ¨ dirty å­—æ®µä¸Š\nè¯»å–æ—¶ä¼šå…ˆæŸ¥è¯¢ readï¼Œä¸å­˜åœ¨å†æŸ¥è¯¢ dirtyï¼Œå†™å…¥æ—¶åˆ™åªå†™å…¥ dirty\nè¯»å– read å¹¶ä¸éœ€è¦åŠ é”ï¼Œè€Œè¯»æˆ–å†™ dirty éƒ½éœ€è¦åŠ é”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func (m *Map) Load(key interface{}) (value interface{}, ok bool) { read, _ := m.read.Load().(readOnly) e, ok := read.m[key] if !ok \u0026amp;\u0026amp; read.amended { m.mu.Lock() // Avoid reporting a spurious miss if m.dirty got promoted while we were // blocked on m.mu. (If further loads of the same key will not miss, it\u0026#39;s // not worth copying the dirty map for this key.) read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026amp;\u0026amp; read.amended { e, ok = m.dirty[key] // Regardless of whether the entry was present, record a miss: this key // will take the slow path until the dirty map is promoted to the read // map. m.missLocked() } m.mu.Unlock() } if !ok { return nil, false } return e.load() } func (e *entry) load() (value interface{}, ok bool) { p := atomic.LoadPointer(\u0026amp;e.p) if p == nil || p == expunged { return nil, false } return *(*interface{})(p), true } å¦å¤–æœ‰ misses å­—æ®µæ¥ç»Ÿè®¡ read è¢«ç©¿é€çš„æ¬¡æ•°ï¼ˆè¢«ç©¿é€æŒ‡éœ€è¦è¯» dirty çš„æƒ…å†µï¼‰ï¼Œè¶…è¿‡ä¸€å®šæ¬¡æ•°åˆ™å°† dirty æ•°æ®åŒæ­¥åˆ° read ä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // Store sets the value for a key. func (m *Map) Store(key, value interface{}) { read, _ := m.read.Load().(readOnly) if e, ok := read.m[key]; ok \u0026amp;\u0026amp; e.tryStore(\u0026amp;value) { return } m.mu.Lock() read, _ = m.read.Load().(readOnly) if e, ok := read.m[key]; ok { if e.unexpungeLocked() { // The entry was previously expunged, which implies that there is a // non-nil dirty map and this entry is not in it. m.dirty[key] = e } e.storeLocked(\u0026amp;value) } else if e, ok := m.dirty[key]; ok { e.storeLocked(\u0026amp;value) } else { if !read.amended { // We\u0026#39;re adding the first new key to the dirty map. // Make sure it is allocated and mark the read-only map as incomplete. m.dirtyLocked() m.read.Store(readOnly{m: read.m, amended: true}) } m.dirty[key] = newEntry(value) } m.mu.Unlock() } // tryStore stores a value if the entry has not been expunged. // // If the entry is expunged, tryStore returns false and leaves the entry // unchanged. func (e *entry) tryStore(i *interface{}) bool { for { p := atomic.LoadPointer(\u0026amp;e.p) if p == expunged { return false } if atomic.CompareAndSwapPointer(\u0026amp;e.p, p, unsafe.Pointer(i)) { return true } } } å¯¹äºåˆ é™¤æ•°æ®åˆ™ç›´æ¥é€šè¿‡æ ‡è®°æ¥å»¶è¿Ÿåˆ é™¤\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // LoadAndDelete deletes the value for a key, returning the previous value if any. // The loaded result reports whether the key was present. func (m *Map) LoadAndDelete(key interface{}) (value interface{}, loaded bool) { read, _ := m.read.Load().(readOnly) e, ok := read.m[key] if !ok \u0026amp;\u0026amp; read.amended { m.mu.Lock() read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok \u0026amp;\u0026amp; read.amended { e, ok = m.dirty[key] delete(m.dirty, key) // Regardless of whether the entry was present, record a miss: this key // will take the slow path until the dirty map is promoted to the read // map. m.missLocked() } m.mu.Unlock() } if ok { return e.delete() } return nil, false } // Delete deletes the value for a key. func (m *Map) Delete(key interface{}) { m.LoadAndDelete(key) } ","date":"2021-10-13T20:36:34+08:00","image":"https://chasing1020.github.io/post/go5-concurrency/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go5-concurrency/","title":"Go(5) Concurrency"},{"content":"Part4. Runtime 1. GMP 1.1. Implement 1.1.1. Data Structure åˆ›å»ºã€é”€æ¯ã€è°ƒåº¦ G éƒ½éœ€è¦æ¯ä¸ª M è·å–é”ï¼Œè¿™å°±å½¢æˆäº†æ¿€çƒˆçš„é”ç«äº‰ã€‚ M è½¬ç§» G ä¼šé€ æˆå»¶è¿Ÿå’Œé¢å¤–çš„ç³»ç»Ÿè´Ÿè½½ã€‚æ¯”å¦‚å½“ G ä¸­åŒ…å«åˆ›å»ºæ–°åç¨‹çš„æ—¶å€™ï¼ŒM åˆ›å»ºäº† Gâ€™ï¼Œä¸ºäº†ç»§ç»­æ‰§è¡Œ Gï¼Œéœ€è¦æŠŠ Gâ€™äº¤ç»™ Mâ€™æ‰§è¡Œï¼Œä¹Ÿé€ æˆäº†å¾ˆå·®çš„å±€éƒ¨æ€§ï¼Œå› ä¸º Gâ€™å’Œ G æ˜¯ç›¸å…³çš„ï¼Œæœ€å¥½æ”¾åœ¨ M ä¸Šæ‰§è¡Œï¼Œè€Œä¸æ˜¯å…¶ä»– Mâ€™ã€‚ ç³»ç»Ÿè°ƒç”¨ (CPU åœ¨ M ä¹‹é—´çš„åˆ‡æ¢) å¯¼è‡´é¢‘ç¹çš„çº¿ç¨‹é˜»å¡å’Œå–æ¶ˆé˜»å¡æ“ä½œå¢åŠ äº†ç³»ç»Ÿå¼€é”€ã€‚\nå…¨å±€é˜Ÿåˆ—ï¼ˆGlobal Queueï¼‰ï¼šå­˜æ”¾ç­‰å¾…è¿è¡Œçš„ Gã€‚ P çš„æœ¬åœ°é˜Ÿåˆ—ï¼šä¸è¶…è¿‡ 256 ä¸ªã€‚æ–°å»º Gâ€™æ—¶ï¼ŒGâ€™ä¼˜å…ˆåŠ å…¥åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œåˆ™ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­ä¸€åŠçš„ G ç§»åŠ¨åˆ°å…¨å±€é˜Ÿåˆ—ã€‚ P åˆ—è¡¨ï¼šæ‰€æœ‰çš„ P éƒ½åœ¨ç¨‹åºå¯åŠ¨æ—¶åˆ›å»ºï¼Œå¹¶ä¿å­˜åœ¨æ•°ç»„ä¸­ï¼Œæœ€å¤šæœ‰ GOMAXPROCS(å¯é…ç½®) ä¸ªã€‚ Mï¼šçº¿ç¨‹æƒ³è¿è¡Œä»»åŠ¡å°±å¾—è·å– Pï¼Œä» P çš„æœ¬åœ°é˜Ÿåˆ—è·å– Gï¼ŒP é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒM ä¹Ÿä¼šå°è¯•ä»å…¨å±€é˜Ÿåˆ—æ‹¿ä¸€æ‰¹ G æ”¾åˆ° P çš„æœ¬åœ°é˜Ÿåˆ—ï¼Œæˆ–ä»å…¶ä»– P çš„æœ¬åœ°é˜Ÿåˆ—å·ä¸€åŠæ”¾åˆ°è‡ªå·± P çš„æœ¬åœ°é˜Ÿåˆ—ã€‚M è¿è¡Œ Gï¼ŒG æ‰§è¡Œä¹‹åï¼ŒM ä¼šä» P è·å–ä¸‹ä¸€ä¸ª Gï¼Œä¸æ–­é‡å¤ä¸‹å»ã€‚\n1.1.1.1. G Gï¼šä½œä¸ºæœ€å°çš„è¿è¡Œçš„è°ƒåº¦å•å…ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 // Stack describes a Go execution stack. // The bounds of the stack are exactly [lo, hi), // with no implicit data structures on either side. type stack struct { lo uintptr hi uintptr } type g struct { // Stack parameters. // stack describes the actual stack memory: [stack.lo, stack.hi). // stackguard0 is the stack pointer compared in the Go stack growth prologue. // It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption. // stackguard1 is the stack pointer compared in the C stack growth prologue. // It is stack.lo+StackGuard on g0 and gsignal stacks. // It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash). stack stack // offset known to runtime/cgo stackguard0 uintptr // offset known to liblink stackguard1 uintptr // offset known to liblink _panic *_panic // innermost panic - offset known to liblink _defer *_defer // innermost defer m *m // current m; offset known to arm liblink sched gobuf syscallsp uintptr // if status==Gsyscall, syscallsp = sched.sp to use during gc syscallpc uintptr // if status==Gsyscall, syscallpc = sched.pc to use during gc stktopsp uintptr // expected sp at top of stack, to check in traceback param unsafe.Pointer // passed parameter on wakeup atomicstatus uint32 stackLock uint32 // sigprof/scang lock; TODO: fold in to atomicstatus goid int64 schedlink guintptr waitsince int64 // approx time when the g become blocked waitreason waitReason // if status==Gwaiting preempt bool // preemption signal, duplicates stackguard0 = stackpreempt preemptStop bool // transition to _Gpreempted on preemption; otherwise, just deschedule preemptShrink bool // shrink stack at synchronous safe point // asyncSafePoint is set if g is stopped at an asynchronous // safe point. This means there are frames on the stack // without precise pointer information. asyncSafePoint bool paniconfault bool // panic (instead of crash) on unexpected fault address gcscandone bool // g has scanned stack; protected by _Gscan bit in status throwsplit bool // must not split stack // activeStackChans indicates that there are unlocked channels // pointing into this goroutine\u0026#39;s stack. If true, stack // copying needs to acquire channel locks to protect these // areas of the stack. activeStackChans bool // parkingOnChan indicates that the goroutine is about to // park on a chansend or chanrecv. Used to signal an unsafe point // for stack shrinking. It\u0026#39;s a boolean value, but is updated atomically. parkingOnChan uint8 raceignore int8 // ignore race detection events sysblocktraced bool // StartTrace has emitted EvGoInSyscall about this goroutine sysexitticks int64 // cputicks when syscall has returned (for tracing) traceseq uint64 // trace event sequencer tracelastp puintptr // last P emitted an event for this goroutine lockedm muintptr sig uint32 writebuf []byte sigcode0 uintptr sigcode1 uintptr sigpc uintptr gopc uintptr // pc of go statement that created this goroutine ancestors *[]ancestorInfo // ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors) startpc uintptr // pc of goroutine function racectx uintptr waiting *sudog // sudog structures this g is waiting on (that have a valid elem ptr); in lock order cgoCtxt []uintptr // cgo traceback context labels unsafe.Pointer // profiler labels timer *timer // cached timer for time.Sleep selectDone uint32 // are we participating in a select and did someone win the race? // Per-G GC state // gcAssistBytes is this G\u0026#39;s GC assist credit in terms of // bytes allocated. If this is positive, then the G has credit // to allocate gcAssistBytes bytes without assisting. If this // is negative, then the G must correct this by performing // scan work. We track this in bytes to make it fast to update // and check for debt in the malloc hot path. The assist ratio // determines how this corresponds to scan work debt. gcAssistBytes int64 } å¯ä»¥çœ‹åˆ°ï¼Œgçš„stackä¿å­˜äº†å½“å‰çš„æ ˆèŒƒå›´ï¼Œåˆ†åˆ«å­˜å‚¨ defer å’Œ panic å¯¹åº”ç»“æ„ä½“çš„é“¾è¡¨ï¼Œ m â€” å½“å‰ Goroutine å ç”¨çš„çº¿ç¨‹ï¼Œå¯èƒ½ä¸ºç©ºï¼› atomicstatus â€” Goroutine çš„çŠ¶æ€ï¼› sched â€” å­˜å‚¨ Goroutine çš„è°ƒåº¦ç›¸å…³çš„æ•°æ®ï¼› goid â€” Goroutine çš„ IDï¼Œè¯¥å­—æ®µå¯¹å¼€å‘è€…ä¸å¯è§ï¼ŒGo å›¢é˜Ÿè®¤ä¸ºå¼•å…¥ ID ä¼šè®©éƒ¨åˆ† Goroutine å˜å¾—æ›´ç‰¹æ®Šï¼Œä»è€Œé™åˆ¶è¯­è¨€çš„å¹¶å‘èƒ½åŠ›ã€‚\nå…¶ä¸­gè¿˜å†…åµŒäº†ä¸€ä¸ªç»“æ„ä½“gobufï¼Œç”¨äºè°ƒåº¦å™¨ä¿å­˜ä»¥åŠæ¢å¤ä¸Šä¸‹æ–‡ä¸­ç”¨åˆ°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 type gobuf struct { // The offsets of sp, pc, and g are known to (hard-coded in) libmach. // // ctxt is unusual with respect to GC: it may be a // heap-allocated funcval, so GC needs to track it, but it // needs to be set and cleared from assembly, where it\u0026#39;s // difficult to have write barriers. However, ctxt is really a // saved, live register, and we only ever exchange it between // the real register and the gobuf. Hence, we treat it as a // root during stack scanning, which means assembly that saves // and restores it doesn\u0026#39;t need write barriers. It\u0026#39;s still // typed as a pointer so that any other writes from Go get // write barriers. sp uintptr pc uintptr g guintptr // æŒæœ‰è¯¥gobufçš„goroutine ctxt unsafe.Pointer ret uintptr // ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ lr uintptr bp uintptr // for framepointer-enabled architectures } æ­¤å¤–atomicstatusè¿˜è®°å½•äº†goroutineå½“å‰çš„çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 const ( // G status // // Beyond indicating the general state of a G, the G status // acts like a lock on the goroutine\u0026#39;s stack (and hence its // ability to execute user code). // _Gidle means this goroutine was just allocated and has not yet been initialized. _Gidle = iota // 0 // _Grunnable means this goroutine is on a run queue. It isnot currently executing user code. The stack is not owned. _Grunnable // 1 // _Grunning means this goroutine may execute user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M and a P (g.m and g.m.p are valid). _Grunning // 2 // _Gsyscall means this goroutine is executing a system call. It is not executing user code. The stack is owned by this goroutine. It is not on a run queue. It is assigned an M. _Gsyscall // 3 // _Gwaiting means this goroutine is blocked in the runtime. // It is not executing user code. It is not on a run queue, // but should be recorded somewhere (e.g., a channel wait // queue) so it can be ready()d when necessary. The stack is // not owned *except* that a channel operation may read or // write parts of the stack under the appropriate channel // lock. Otherwise, it is not safe to access the stack after a // goroutine enters _Gwaiting (e.g., it may get moved). _Gwaiting // 4 // _Gmoribund_unused is currently unused, but hardcoded in gdb // scripts. _Gmoribund_unused // 5 // _Gdead means this goroutine is currently unused. It may be // just exited, on a free list, or just being initialized. It // is not executing user code. It may or may not have a stack // allocated. The G and its stack (if any) are owned by the M // that is exiting the G or that obtained the G from the free // list. _Gdead // 6 // _Genqueue_unused is currently unused. _Genqueue_unused // 7 // _Gcopystack means this goroutine\u0026#39;s stack is being moved. It // is not executing user code and is not on a run queue. The // stack is owned by the goroutine that put it in _Gcopystack. _Gcopystack // 8 // _Gpreempted means this goroutine stopped itself for a // suspendG preemption. It is like _Gwaiting, but nothing is // yet responsible for ready()ing it. Some suspendG must CAS // the status to _Gwaiting to take responsibility for // ready()ing this G. _Gpreempted // 9 // _Gscan combined with one of the above states other than // _Grunning indicates that GC is scanning the stack. The // goroutine is not executing user code and the stack is owned // by the goroutine that set the _Gscan bit. // // _Gscanrunning is different: it is used to briefly block // state transitions while GC signals the G to scan its own // stack. This is otherwise like _Grunning. // // atomicstatus\u0026amp;~Gscan gives the state the goroutine will // return to when the scan completes. _Gscan = 0x1000 _Gscanrunnable = _Gscan + _Grunnable // 0x1001 _Gscanrunning = _Gscan + _Grunning // 0x1002 _Gscansyscall = _Gscan + _Gsyscall // 0x1003 _Gscanwaiting = _Gscan + _Gwaiting // 0x1004 _Gscanpreempted = _Gscan + _Gpreempted // 0x1009 ) ä¸»è¦çŠ¶æ€å¦‚ä¸‹ï¼š\nçŠ¶æ€ æè¿° _Gidle åˆšåˆšè¢«åˆ†é…å¹¶ä¸”è¿˜æ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ç»“æŸåå˜ä¸º_Gdead _Grunnable æ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œæ²¡æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œå­˜å‚¨åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ _Grunning å¯ä»¥æ‰§è¡Œä»£ç ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M å’Œå¤„ç†å™¨ P _Gsyscall æ­£åœ¨æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ‹¥æœ‰æ ˆçš„æ‰€æœ‰æƒï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œè¢«èµ‹äºˆäº†å†…æ ¸çº¿ç¨‹ M ä½†æ˜¯ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š _Gwaiting ç”±äºè¿è¡Œæ—¶è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨äº Channel çš„ç­‰å¾…é˜Ÿåˆ—ä¸Š _Gdead å¯ä»¥æ˜¯è¢«é”€æ¯çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åˆšåˆ›å»ºçš„ã€‚æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯èƒ½æœ‰åˆ†é…çš„æ ˆ _Gcopystack æ ˆæ­£åœ¨è¢«æ‹·è´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Š _Gpreempted ç”±äºæŠ¢å è€Œè¢«é˜»å¡ï¼Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç å¹¶ä¸”ä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œç­‰å¾…å”¤é†’ _Gscan GC æ­£åœ¨æ‰«ææ ˆç©ºé—´ï¼Œæ²¡æœ‰æ‰§è¡Œä»£ç ï¼Œå¯ä»¥ä¸å…¶ä»–çŠ¶æ€åŒæ—¶å­˜åœ¨ å…¶ä¸­g0ä½œä¸ºç‰¹æ®Šçš„è°ƒåº¦åç¨‹ï¼šæ‰§è¡Œå‡½æ•°çš„æµç¨‹ç›¸å¯¹å›ºå®šï¼Œåˆ‡ä¸ºäº†é¿å…æ ˆæº¢å‡ºï¼Œg0çš„æ ˆä¼šå¤ç”¨\n1.1.1.2. M 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 type m struct { g0 *g // goroutine with scheduling stack morebuf gobuf // gobuf arg to morestack divmod uint32 // div/mod denominator for arm - known to liblink // Fields not known to debuggers. procid uint64 // for debuggers, but offset not hard-coded gsignal *g // signal-handling g goSigStack gsignalStack // Go-allocated signal handling stack sigmask sigset // storage for saved signal mask tls [tlsSlots]uintptr // thread-local storage (for x86 extern register) mstartfn func() curg *g // current running goroutine caughtsig guintptr // goroutine running during fatal signal p puintptr // attached p for executing go code (nil if not executing go code) nextp puintptr oldp puintptr // the p that was attached before executing a syscall id int64 mallocing int32 throwing int32 preemptoff string // if != \u0026#34;\u0026#34;, keep curg running on this m locks int32 dying int32 profilehz int32 spinning bool // m is out of work and is actively looking for work blocked bool // m is blocked on a note newSigstack bool // minit on C thread called sigaltstack printlock int8 incgo bool // m is executing a cgo call freeWait uint32 // if == 0, safe to free g0 and delete m (atomic) fastrand [2]uint32 needextram bool traceback uint8 ncgocall uint64 // number of cgo calls in total ncgo int32 // number of cgo calls currently in progress cgoCallersUse uint32 // if non-zero, cgoCallers in use temporarily cgoCallers *cgoCallers // cgo traceback if crashing in cgo call doesPark bool // non-P running threads: sysmon and newmHandoff never use .park park note alllink *m // on allm schedlink muintptr lockedg guintptr createstack [32]uintptr // stack that created this thread. lockedExt uint32 // tracking for external LockOSThread lockedInt uint32 // tracking for internal lockOSThread nextwaitm muintptr // next m waiting for lock waitunlockf func(*g, unsafe.Pointer) bool waitlock unsafe.Pointer waittraceev byte waittraceskip int startingtrace bool syscalltick uint32 freelink *m // on sched.freem // mFixup is used to synchronize OS related m state // (credentials etc) use mutex to access. To avoid deadlocks // an atomic.Load() of used being zero in mDoFixupFn() // guarantees fn is nil. mFixup struct { lock mutex used uint32 fn func(bool) bool } // these are here because they are too large to be on the stack // of low-level NOSPLIT functions. libcall libcall libcallpc uintptr // for cpu profiler libcallsp uintptr libcallg guintptr syscall libcall // stores syscall parameters on windows vdsoSP uintptr // SP for traceback while in VDSO call (0 if not in call) vdsoPC uintptr // PC for traceback while in VDSO call // preemptGen counts the number of completed preemption // signals. This is used to detect when a preemption is // requested, but fails. Accessed atomically. preemptGen uint32 // Whether this is a pending preemption signal on this M. // Accessed atomically. signalPending uint32 dlogPerM mOS // Up to 10 locks held by this m, maintained by the lock ranking code. locksHeldLen int locksHeld [10]heldLockInfo } å…¶ä¸­ g0 æ˜¯æŒæœ‰è°ƒåº¦æ ˆçš„ Goroutineï¼Œcurg æ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸Šè¿è¡Œçš„ç”¨æˆ· Goroutineï¼Œè¿™ä¹Ÿæ˜¯æ“ä½œç³»ç»Ÿçº¿ç¨‹å”¯ä¸€å…³å¿ƒçš„ä¸¤ä¸ª Goroutineã€‚\n1.1.1.3. P è°ƒåº¦å™¨ä¸­çš„å¤„ç†å™¨ P æ˜¯çº¿ç¨‹å’Œ Goroutine çš„ä¸­é—´å±‚ï¼Œå®ƒèƒ½æä¾›çº¿ç¨‹éœ€è¦çš„ä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œä¹Ÿä¼šè´Ÿè´£è°ƒåº¦çº¿ç¨‹ä¸Šçš„ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡å¤„ç†å™¨ P çš„è°ƒåº¦ï¼Œæ¯ä¸€ä¸ªå†…æ ¸çº¿ç¨‹éƒ½èƒ½å¤Ÿæ‰§è¡Œå¤šä¸ª Goroutineï¼Œå®ƒèƒ½åœ¨ Goroutine è¿›è¡Œä¸€äº› I/O æ“ä½œæ—¶åŠæ—¶è®©å‡ºè®¡ç®—èµ„æºï¼Œæé«˜çº¿ç¨‹çš„åˆ©ç”¨ç‡ã€‚\nå› ä¸ºè°ƒåº¦å™¨åœ¨å¯åŠ¨æ—¶å°±ä¼šåˆ›å»º GOMAXPROCS ä¸ªå¤„ç†å™¨ï¼Œæ‰€ä»¥ Go è¯­è¨€ç¨‹åºçš„å¤„ç†å™¨æ•°é‡ä¸€å®šä¼šç­‰äº GOMAXPROCSï¼Œè¿™äº›å¤„ç†å™¨ä¼šç»‘å®šåˆ°ä¸åŒçš„å†…æ ¸çº¿ç¨‹ä¸Šã€‚\nruntime.p æ˜¯å¤„ç†å™¨çš„è¿è¡Œæ—¶è¡¨ç¤ºï¼Œä½œä¸ºè°ƒåº¦å™¨çš„å†…éƒ¨å®ç°ï¼Œå®ƒåŒ…å«çš„å­—æ®µä¹Ÿéå¸¸å¤šï¼Œå…¶ä¸­åŒ…æ‹¬ä¸æ€§èƒ½è¿½è¸ªã€åƒåœ¾å›æ”¶å’Œè®¡æ—¶å™¨ç›¸å…³çš„å­—æ®µï¼Œè¿™äº›å­—æ®µä¹Ÿéå¸¸é‡è¦ï¼Œä½†æ˜¯åœ¨è¿™é‡Œå°±ä¸å±•ç¤ºäº†ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨å¤„ç†å™¨ä¸­çš„çº¿ç¨‹å’Œè¿è¡Œé˜Ÿåˆ—ï¼š\nPï¼šä½œä¸ºä¸­é—´å±‚ï¼Œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 type p struct { id int32 status uint32 // one of pidle/prunning/... link puintptr schedtick uint32 // incremented on every scheduler call syscalltick uint32 // incremented on every system call sysmontick sysmontick // last tick observed by sysmon m muintptr // back-link to associated m (nil if idle) mcache *mcache pcache pageCache raceprocctx uintptr deferpool [5][]*_defer // pool of available defer structs of different sizes (see panic.go) deferpoolbuf [5][32]*_defer // Cache of goroutine ids, amortizes accesses to runtimeÂ·sched.goidgen. goidcache uint64 goidcacheend uint64 // Queue of runnable goroutines. Accessed without lock. runqhead uint32 runqtail uint32 runq [256]guintptr // runnext, if non-nil, is a runnable G that was ready\u0026#39;d by // the current G and should be run next instead of what\u0026#39;s in // runq if there\u0026#39;s time remaining in the running G\u0026#39;s time // slice. It will inherit the time left in the current time // slice. If a set of goroutines is locked in a // communicate-and-wait pattern, this schedules that set as a // unit and eliminates the (potentially large) scheduling // latency that otherwise arises from adding the ready\u0026#39;d // goroutines to the end of the run queue. // // Note that while other P\u0026#39;s may atomically CAS this to zero, // only the owner P can CAS it to a valid G. runnext guintptr // Available G\u0026#39;s (status == Gdead) gFree struct { gList n int32 } sudogcache []*sudog sudogbuf [128]*sudog // Cache of mspan objects from the heap. mspancache struct { // We need an explicit length here because this field is used // in allocation codepaths where write barriers are not allowed, // and eliminating the write barrier/keeping it eliminated from // slice updates is tricky, moreso than just managing the length // ourselves. len int buf [128]*mspan } tracebuf traceBufPtr // traceSweep indicates the sweep events should be traced. // This is used to defer the sweep start event until a span // has actually been swept. traceSweep bool // traceSwept and traceReclaimed track the number of bytes // swept and reclaimed by sweeping in the current sweep loop. traceSwept, traceReclaimed uintptr palloc persistentAlloc // per-P to avoid mutex _ uint32 // Alignment for atomic fields below // The when field of the first entry on the timer heap. // This is updated using atomic functions. // This is 0 if the timer heap is empty. timer0When uint64 // The earliest known nextwhen field of a timer with // timerModifiedEarlier status. Because the timer may have been // modified again, there need not be any timer with this value. // This is updated using atomic functions. // This is 0 if there are no timerModifiedEarlier timers. timerModifiedEarliest uint64 // Per-P GC state gcAssistTime int64 // Nanoseconds in assistAlloc gcFractionalMarkTime int64 // Nanoseconds in fractional mark worker (atomic) // gcMarkWorkerMode is the mode for the next mark worker to run in. // That is, this is used to communicate with the worker goroutine // selected for immediate execution by // gcController.findRunnableGCWorker. When scheduling other goroutines, // this field must be set to gcMarkWorkerNotWorker. gcMarkWorkerMode gcMarkWorkerMode // gcMarkWorkerStartTime is the nanotime() at which the most recent // mark worker started. gcMarkWorkerStartTime int64 // gcw is this P\u0026#39;s GC work buffer cache. The work buffer is // filled by write barriers, drained by mutator assists, and // disposed on certain GC state transitions. gcw gcWork // wbBuf is this P\u0026#39;s GC write barrier buffer. // // TODO: Consider caching this in the running G. wbBuf wbBuf runSafePointFn uint32 // if 1, run sched.safePointFn at next safe point // statsSeq is a counter indicating whether this P is currently // writing any stats. Its value is even when not, odd when it is. statsSeq uint32 // Lock for timers. We normally access the timers while running // on this P, but the scheduler can also do it from a different P. timersLock mutex // Actions to take at some time. This is used to implement the // standard library\u0026#39;s time package. // Must hold timersLock to access. timers []*timer // Number of timers in P\u0026#39;s heap. // Modified using atomic instructions. numTimers uint32 // Number of timerDeleted timers in P\u0026#39;s heap. // Modified using atomic instructions. deletedTimers uint32 // Race context used while executing timer functions. timerRaceCtx uintptr // preempt is set to indicate that this P should be enter the // scheduler ASAP (regardless of what G is running on it). preempt bool // Padding is no longer needed. False sharing is now not a worry because p is large enough // that its size class is an integer multiple of the cache line size (for any of our architectures). } å…¶ä¸­ P ä¹Ÿå®šä¹‰äº†çŠ¶æ€å­—æ®µ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 const ( // P status // _Pidle means a P is not being used to run user code or the // scheduler. Typically, it\u0026#39;s on the idle P list and available // to the scheduler, but it may just be transitioning between // other states. // // The P is owned by the idle list or by whatever is // transitioning its state. Its run queue is empty. _Pidle = iota // _Prunning means a P is owned by an M and is being used to // run user code or the scheduler. Only the M that owns this P // is allowed to change the P\u0026#39;s status from _Prunning. The M // may transition the P to _Pidle (if it has no more work to // do), _Psyscall (when entering a syscall), or _Pgcstop (to // halt for the GC). The M may also hand ownership of the P // off directly to another M (e.g., to schedule a locked G). _Prunning // _Psyscall means a P is not running user code. It has // affinity to an M in a syscall but is not owned by it and // may be stolen by another M. This is similar to _Pidle but // uses lightweight transitions and maintains M affinity. // // Leaving _Psyscall must be done with a CAS, either to steal // or retake the P. Note that there\u0026#39;s an ABA hazard: even if // an M successfully CASes its original P back to _Prunning // after a syscall, it must understand the P may have been // used by another M in the interim. _Psyscall // _Pgcstop means a P is halted for STW and owned by the M // that stopped the world. The M that stopped the world // continues to use its P, even in _Pgcstop. Transitioning // from _Prunning to _Pgcstop causes an M to release its P and // park. // // The P retains its run queue and startTheWorld will restart // the scheduler on Ps with non-empty run queues. _Pgcstop // _Pdead means a P is no longer used (GOMAXPROCS shrank). We // reuse Ps if GOMAXPROCS increases. A dead P is mostly // stripped of its resources, though a few things remain // (e.g., trace buffers). _Pdead ) çŠ¶æ€ æè¿° _Pidle å¤„ç†å™¨æ²¡æœ‰è¿è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨ï¼Œè¢«ç©ºé—²é˜Ÿåˆ—æˆ–è€…æ”¹å˜å…¶çŠ¶æ€çš„ç»“æ„æŒæœ‰ï¼Œè¿è¡Œé˜Ÿåˆ—ä¸ºç©º _Prunning è¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå¹¶ä¸”æ­£åœ¨æ‰§è¡Œç”¨æˆ·ä»£ç æˆ–è€…è°ƒåº¦å™¨ _Psyscall æ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå½“å‰çº¿ç¨‹é™·å…¥ç³»ç»Ÿè°ƒç”¨ _Pgcstop è¢«çº¿ç¨‹ M æŒæœ‰ï¼Œå½“å‰å¤„ç†å™¨ç”±äºåƒåœ¾å›æ”¶è¢«åœæ­¢ _Pdead å½“å‰å¤„ç†å™¨å·²ç»ä¸è¢«ä½¿ç”¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 struct P { Lock; uint32 status; P* link; uint32 tick; M* m; MCache* mcache; G** runq; // goroutineç»„æˆçš„ç¯å½¢æ•°ç»„ int32 runqhead; int32 runqtail; int32 runqsize; G* gfree; int32 gfreecnt; }; Gçš„çŠ¶æ€ ç©ºé—²ä¸­(_Gidle): è¡¨ç¤ºGåˆšåˆšæ–°å»º, ä»æœªåˆå§‹åŒ– å¾…è¿è¡Œ(_Grunnable): è¡¨ç¤ºGåœ¨è¿è¡Œé˜Ÿåˆ—ä¸­, ç­‰å¾…Må–å‡ºå¹¶è¿è¡Œ è¿è¡Œä¸­(_Grunning): è¡¨ç¤ºMæ­£åœ¨è¿è¡Œè¿™ä¸ªG, è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP ç³»ç»Ÿè°ƒç”¨ä¸­(_Gsyscall): è¡¨ç¤ºMæ­£åœ¨è¿è¡Œè¿™ä¸ªGå‘èµ·çš„ç³»ç»Ÿè°ƒç”¨, è¿™æ—¶å€™Må¹¶ä¸æ‹¥æœ‰P ç­‰å¾…ä¸­(_Gwaiting): è¡¨ç¤ºGåœ¨ç­‰å¾…æŸäº›æ¡ä»¶å®Œæˆ, è¿™æ—¶å€™Gä¸åœ¨è¿è¡Œä¹Ÿä¸åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­(å¯èƒ½åœ¨channelçš„ç­‰å¾…é˜Ÿåˆ—ä¸­) å·²ä¸­æ­¢(_Gdead): è¡¨ç¤ºGæœªè¢«ä½¿ç”¨, å¯èƒ½å·²æ‰§è¡Œå®Œæ¯•(å¹¶åœ¨freelistä¸­ç­‰å¾…ä¸‹æ¬¡å¤ç”¨) æ ˆå¤åˆ¶ä¸­(_Gcopystack): è¡¨ç¤ºGæ­£åœ¨è·å–ä¸€ä¸ªæ–°çš„æ ˆç©ºé—´å¹¶æŠŠåŸæ¥çš„å†…å®¹å¤åˆ¶è¿‡å»(ç”¨äºé˜²æ­¢GCæ‰«æ) Mçš„çŠ¶æ€ Må¹¶æ²¡æœ‰åƒGå’ŒPä¸€æ ·çš„çŠ¶æ€æ ‡è®°, ä½†å¯ä»¥è®¤ä¸ºä¸€ä¸ªMæœ‰ä»¥ä¸‹çš„çŠ¶æ€:\nè‡ªæ—‹ä¸­(spinning): Mæ­£åœ¨ä»è¿è¡Œé˜Ÿåˆ—è·å–G, è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP æ‰§è¡Œgoä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡Œgoä»£ç , è¿™æ—¶å€™Mä¼šæ‹¥æœ‰ä¸€ä¸ªP æ‰§è¡ŒåŸç”Ÿä»£ç ä¸­: Mæ­£åœ¨æ‰§è¡ŒåŸç”Ÿä»£ç æˆ–è€…é˜»å¡çš„syscall, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰P ä¼‘çœ ä¸­: Må‘ç°æ— å¾…è¿è¡Œçš„Gæ—¶ä¼šè¿›å…¥ä¼‘çœ , å¹¶æ·»åŠ åˆ°ç©ºé—²Mé“¾è¡¨ä¸­, è¿™æ—¶Må¹¶ä¸æ‹¥æœ‰P è‡ªæ—‹ä¸­(spinning)è¿™ä¸ªçŠ¶æ€éå¸¸é‡è¦, æ˜¯å¦éœ€è¦å”¤é†’æˆ–è€…åˆ›å»ºæ–°çš„Må–å†³äºå½“å‰è‡ªæ—‹ä¸­çš„Mçš„æ•°é‡.\nPçš„çŠ¶æ€ ç©ºé—²ä¸­(_Pidle): å½“Må‘ç°æ— å¾…è¿è¡Œçš„Gæ—¶ä¼šè¿›å…¥ä¼‘çœ , è¿™æ—¶Mæ‹¥æœ‰çš„Pä¼šå˜ä¸ºç©ºé—²å¹¶åŠ åˆ°ç©ºé—²Pé“¾è¡¨ä¸­ è¿è¡Œä¸­(_Prunning): å½“Mæ‹¥æœ‰äº†ä¸€ä¸ªPå, è¿™ä¸ªPçš„çŠ¶æ€å°±ä¼šå˜ä¸ºè¿è¡Œä¸­, Mè¿è¡ŒGä¼šä½¿ç”¨è¿™ä¸ªPä¸­çš„èµ„æº ç³»ç»Ÿè°ƒç”¨ä¸­(_Psyscall): å½“goè°ƒç”¨åŸç”Ÿä»£ç , åŸç”Ÿä»£ç åˆåè¿‡æ¥è°ƒç”¨goä»£ç æ—¶, ä½¿ç”¨çš„Pä¼šå˜ä¸ºæ­¤çŠ¶æ€ GCåœæ­¢ä¸­(_Pgcstop): å½“gcåœæ­¢äº†æ•´ä¸ªä¸–ç•Œ(STW)æ—¶, Pä¼šå˜ä¸ºæ­¤çŠ¶æ€ å·²ä¸­æ­¢(_Pdead): å½“Pçš„æ•°é‡åœ¨è¿è¡Œæ—¶æ”¹å˜, ä¸”æ•°é‡å‡å°‘æ—¶å¤šä½™çš„Pä¼šå˜ä¸ºæ­¤çŠ¶æ€ Pçš„æ•°é‡ï¼šè®¾ç½®ç”±å¯åŠ¨æ—¶ç¯å¢ƒå˜é‡ $GOMAXPROCS æˆ–è€…æ˜¯ç”± runtime çš„æ–¹æ³• GOMAXPROCS() å†³å®šã€‚è¿™æ„å‘³ç€åœ¨ç¨‹åºæ‰§è¡Œçš„ä»»æ„æ—¶åˆ»éƒ½åªæœ‰ $GOMAXPROCS ä¸ª goroutine åœ¨åŒæ—¶è¿è¡Œã€‚\nM çš„æ•°é‡ï¼šgo è¯­è¨€æœ¬èº«çš„é™åˆ¶ï¼šgo ç¨‹åºå¯åŠ¨æ—¶ï¼Œä¼šè®¾ç½® M çš„æœ€å¤§æ•°é‡ï¼Œé»˜è®¤ 10000. ä½†æ˜¯å†…æ ¸å¾ˆéš¾æ”¯æŒè¿™ä¹ˆå¤šçš„çº¿ç¨‹æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªé™åˆ¶å¯ä»¥å¿½ç•¥ã€‚runtime/debug ä¸­çš„ SetMaxThreads å‡½æ•°ï¼Œè®¾ç½® M çš„æœ€å¤§æ•°é‡ã€‚ä¸€ä¸ª M é˜»å¡äº†ï¼Œä¼šåˆ›å»ºæ–°çš„ Mã€‚\nåœ¨goä¸­æœ‰å¤šä¸ªè¿è¡Œé˜Ÿåˆ—å¯ä»¥ä¿å­˜å¾…è¿è¡Œ(_Grunnable)çš„G, å®ƒä»¬åˆ†åˆ«æ˜¯å„ä¸ªPä¸­çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å’Œå…¨å±€è¿è¡Œé˜Ÿåˆ—. å…¥é˜Ÿå¾…è¿è¡Œçš„Gæ—¶ä¼šä¼˜å…ˆåŠ åˆ°å½“å‰Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—, Mè·å–å¾…è¿è¡Œçš„Gæ—¶ä¹Ÿä¼šä¼˜å…ˆä»æ‹¥æœ‰çš„Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è·å–, æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å…¥é˜Ÿå’Œå‡ºé˜Ÿä¸éœ€è¦ä½¿ç”¨çº¿ç¨‹é”.\næœ¬åœ°è¿è¡Œé˜Ÿåˆ—æœ‰æ•°é‡é™åˆ¶, å½“æ•°é‡è¾¾åˆ°256ä¸ªæ—¶ä¼šå…¥é˜Ÿåˆ°å…¨å±€è¿è¡Œé˜Ÿåˆ—. æœ¬åœ°è¿è¡Œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯ç¯å½¢é˜Ÿåˆ—, ç”±ä¸€ä¸ª256é•¿åº¦çš„æ•°ç»„å’Œä¸¤ä¸ªåºå·(head, tail)ç»„æˆ.\nå½“Mä»Pçš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è·å–Gæ—¶, å¦‚æœå‘ç°æœ¬åœ°é˜Ÿåˆ—ä¸ºç©ºä¼šå°è¯•ä»å…¶ä»–Pç›—å–ä¸€åŠçš„Gè¿‡æ¥, è¿™ä¸ªæœºåˆ¶å«åšWork Stealing, è¯¦è§åé¢çš„ä»£ç åˆ†æ.\nå…¨å±€è¿è¡Œé˜Ÿåˆ—ä¿å­˜åœ¨å…¨å±€å˜é‡schedä¸­, å…¨å±€è¿è¡Œé˜Ÿåˆ—å…¥é˜Ÿå’Œå‡ºé˜Ÿéœ€è¦ä½¿ç”¨çº¿ç¨‹é”. å…¨å±€è¿è¡Œé˜Ÿåˆ—çš„æ•°æ®ç»“æ„æ˜¯é“¾è¡¨, ç”±ä¸¤ä¸ªæŒ‡é’ˆ(head, tail)ç»„æˆ.\n1.1.2. Start åœ¨è°ƒåº¦å™¨åˆå§‹å‡½æ•°æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ä¼šå°† maxmcount è®¾ç½®æˆ 10000ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸€ä¸ª Go è¯­è¨€ç¨‹åºèƒ½å¤Ÿåˆ›å»ºçš„æœ€å¤§çº¿ç¨‹æ•°ï¼Œè™½ç„¶æœ€å¤šå¯ä»¥åˆ›å»º 10000 ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹è¿˜æ˜¯ç”± GOMAXPROCS å˜é‡æ§åˆ¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func schedinit() { _g_ := getg() ... sched.maxmcount = 10000 ... sched.lastpoll = uint64(nanotime()) procs := ncpu if n, ok := atoi32(gogetenv(\u0026#34;GOMAXPROCS\u0026#34;)); ok \u0026amp;\u0026amp; n \u0026gt; 0 { procs = n } if procresize(procs) != nil { throw(\u0026#34;unknown runnable goroutine during bootstrap\u0026#34;) } } å½“procresizeå¯åŠ¨åï¼Œå¼€å§‹ç­‰å¾…ç”¨æˆ·åˆ›å»ºè¿è¡Œæ–°çš„ Goroutine å¹¶ä¸º Goroutine è°ƒåº¦å¤„ç†å™¨èµ„æº\n1.2. Create Goroutine å½“è°ƒç”¨go func()æ—¶ï¼Œç¼–è¯‘å™¨è°ƒç”¨callæ–¹æ³•ï¼Œç„¶åå†è½¬æ¢æˆnewprocçš„è°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 func (s *state) call(n *Node, k callKind) *ssa.Value { if k == callDeferStack { ... } else { switch { case k == callGo: call = s.newValue1A(ssa.OpStaticCall, types.TypeMem, newproc, s.mem()) default: } } ... } runtime.newprocçš„å…¥å‚æ˜¯å‚æ•°å¤§å°å’Œè¡¨ç¤ºå‡½æ•°çš„æŒ‡é’ˆ funcvalï¼Œå®ƒä¼šè·å– Goroutine ä»¥åŠè°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œç„¶åè°ƒç”¨ runtime.newproc1å‡½æ•°è·å–æ–°çš„ Goroutine ç»“æ„ä½“ã€å°†å…¶åŠ å…¥å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—å¹¶åœ¨æ»¡è¶³æ¡ä»¶æ—¶è°ƒç”¨ runtime.wakep å”¤é†’æ–°çš„å¤„ç†æ‰§è¡Œ Goroutineï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func newproc(siz int32, fn *funcval) { argp := add(unsafe.Pointer(\u0026amp;fn), sys.PtrSize) gp := getg() pc := getcallerpc() systemstack(func() { newg := newproc1(fn, argp, siz, gp, pc) _p_ := getg().m.p.ptr() runqput(_p_, newg, true) if mainStarted { wakep() } }) } å…¶ä¸­newproc1è°ƒç”¨å¦‚ä¸‹ï¼Œå…¶è°ƒç”¨å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰æ­¥ï¼š\nè·å–æˆ–è€…åˆ›å»ºæ–°çš„ Goroutine ç»“æ„ä½“ 1 2 3 4 5 6 7 8 9 10 11 12 13 func newproc1(fn *funcval, argp unsafe.Pointer, narg int32, callergp *g, callerpc uintptr) *g { _g_ := getg() siz := narg siz = (siz + 7) \u0026amp;^ 7 _p_ := _g_.m.p.ptr() newg := gfget(_p_) // è·å–æ–°çš„g if newg == nil { newg = malg(_StackMin) casgstatus(newg, _Gidle, _Gdead) allgadd(newg) } //... æŠŠå‚æ•°æ”¾å…¥æ ˆåŒºï¼š\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¼šè°ƒç”¨ runtime.memmove å°† fn å‡½æ•°çš„æ‰€æœ‰å‚æ•°æ‹·è´åˆ°æ ˆä¸Šï¼Œargp å’Œ narg åˆ†åˆ«æ˜¯å‚æ•°çš„å†…å­˜ç©ºé—´å’Œå¤§å°ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ä¼šå°†å‚æ•°å¯¹åº”çš„å†…å­˜ç©ºé—´æ•´å—æ‹·è´åˆ°æ ˆä¸Š\n1 2 3 4 5 6 7 8 9 //... totalSize := 4*sys.RegSize + uintptr(siz) + sys.MinFrameSize totalSize += -totalSize \u0026amp; (sys.SpAlign - 1) sp := newg.stack.hi - totalSize spArg := sp if narg \u0026gt; 0 { memmove(unsafe.Pointer(spArg), argp, uintptr(narg)) } //... æ›´æ–° Goroutine è°ƒåº¦ç›¸å…³çš„å±æ€§ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 //... memclrNoHeapPointers(unsafe.Pointer(\u0026amp;newg.sched), unsafe.Sizeof(newg.sched)) newg.sched.sp = sp newg.stktopsp = sp newg.sched.pc = funcPC(goexit) + sys.PCQuantum newg.sched.g = guintptr(unsafe.Pointer(newg)) gostartcallfn(\u0026amp;newg.sched, fn) newg.gopc = callerpc newg.startpc = fn.fn casgstatus(newg, _Gdead, _Grunnable) newg.goid = int64(_p_.goidcache) _p_.goidcache++ return newg } å…¶ä¸­gfgetæ–¹æ³•å¦‚ä¸‹ï¼š\nä» Goroutine æ‰€åœ¨å¤„ç†å™¨çš„ gFree åˆ—è¡¨æˆ–è€…è°ƒåº¦å™¨çš„ sched.gFree åˆ—è¡¨ä¸­è·å– runtime.gï¼› 1 2 3 4 5 6 7 8 9 10 // Available G\u0026#39;s (status == Gdead) gFree struct { gList n int32 } // A gList is a list of Gs linked through g.schedlink. A G can only be // on one gQueue or gList at a time. type gList struct { head guintptr } è°ƒç”¨ runtime.malgç”Ÿæˆä¸€ä¸ªæ–°çš„ runtime.g å¹¶å°†ç»“æ„ä½“è¿½åŠ åˆ°å…¨å±€çš„ Goroutine åˆ—è¡¨ allgs ä¸­ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func gfget(_p_ *p) *g { retry: if _p_.gFree.empty() \u0026amp;\u0026amp; (!sched.gFree.stack.empty() || !sched.gFree.noStack.empty()) { for _p_.gFree.n \u0026lt; 32 { gp := sched.gFree.stack.pop() if gp == nil { gp = sched.gFree.noStack.pop() if gp == nil { break } } _p_.gFree.push(gp) } goto retry } gp := _p_.gFree.pop() if gp == nil { return nil } return gp } å½“å¤„ç†å™¨çš„ Goroutine åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œä¼šå°†è°ƒåº¦å™¨æŒæœ‰çš„ç©ºé—² Goroutine è½¬ç§»åˆ°å½“å‰å¤„ç†å™¨ä¸Šï¼Œç›´åˆ° gFree åˆ—è¡¨ä¸­çš„ Goroutine æ•°é‡è¾¾åˆ° 32ï¼› å½“å¤„ç†å™¨çš„ Goroutine æ•°é‡å……è¶³æ—¶ï¼Œä¼šä»åˆ—è¡¨å¤´éƒ¨è¿”å›ä¸€ä¸ªæ–°çš„ Goroutineï¼› å½“è°ƒåº¦å™¨çš„ gFree å’Œå¤„ç†å™¨çš„ gFree åˆ—è¡¨éƒ½ä¸å­˜åœ¨ç»“æ„ä½“æ—¶ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ runtime.malgåˆå§‹åŒ–æ–°çš„ runtime.gç»“æ„ï¼Œå¦‚æœç”³è¯·çš„å †æ ˆå¤§å°å¤§äº 0ï¼Œè¿™é‡Œä¼šé€šè¿‡ runtime.stackalloc åˆ†é… 2KB çš„æ ˆç©ºé—´ï¼š\n1 2 3 4 5 6 7 8 9 10 func malg(stacksize int32) *g { newg := new(g) if stacksize \u0026gt;= 0 { stacksize = round2(_StackSystem + stacksize) newg.stack = stackalloc(uint32(stacksize)) newg.stackguard0 = newg.stack.lo + _StackGuard newg.stackguard1 = ^uintptr(0) } return newg } ä¹‹åä¼šè°ƒç”¨runtime.runqputä¼šå°† Goroutine æ”¾åˆ°è¿è¡Œé˜Ÿåˆ—ä¸Šï¼Œè¿™æ—¢å¯èƒ½æ˜¯å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func runqput(_p_ *p, gp *g, next bool) { if next { retryNext: oldnext := _p_.runnext if !_p_.runnext.cas(oldnext, guintptr(unsafe.Pointer(gp))) { goto retryNext } if oldnext == 0 { return } gp = oldnext.ptr() } retry: h := atomic.LoadAcq(\u0026amp;_p_.runqhead) t := _p_.runqtail if t-h \u0026lt; uint32(len(_p_.runq)) { _p_.runq[t%uint32(len(_p_.runq))].set(gp) atomic.StoreRel(\u0026amp;_p_.runqtail, t+1) return } if runqputslow(_p_, gp, h, t) { return } goto retry } å½“ next ä¸º true æ—¶ï¼Œå°† Goroutine è®¾ç½®åˆ°å¤„ç†å™¨çš„ runnext ä½œä¸ºä¸‹ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œçš„ä»»åŠ¡ï¼› å½“ next ä¸º false å¹¶ä¸”æœ¬åœ°è¿è¡Œé˜Ÿåˆ—è¿˜æœ‰å‰©ä½™ç©ºé—´æ—¶ï¼Œå°† Goroutine åŠ å…¥å¤„ç†å™¨æŒæœ‰çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ï¼› å½“å¤„ç†å™¨çš„æœ¬åœ°è¿è¡Œé˜Ÿåˆ—å·²ç»æ²¡æœ‰å‰©ä½™ç©ºé—´æ—¶å°±ä¼šæŠŠæœ¬åœ°é˜Ÿåˆ—ä¸­çš„ä¸€éƒ¨åˆ† Goroutine å’Œå¾…åŠ å…¥çš„ Goroutine é€šè¿‡ runtime.runqputslowæ·»åŠ åˆ°è°ƒåº¦å™¨æŒæœ‰çš„å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸Šï¼› è¿™é‡Œå–å…¨å±€é˜Ÿåˆ—çš„Goroutineæ•°ç›®åˆšå¥½ä¸ºn = min(len(GQ)/GOMAXPROCS + 1, len(GQ/2))\n1.3. Schedule 1.3.1. M0, G0 goè¯­è¨€çš„å¯åŠ¨æµç¨‹ç®€å•ç¤ºæ„è§ä¸‹æ³¨é‡Š\n1 2 3 4 5 6 7 8 // The bootstrap sequence is: // // call osinit // call schedinit // make \u0026amp; queue new G // call runtimeÂ·mstart // // The new G calls runtimeÂ·main. æ­¤å¤–ï¼Œruntime/procä¸‹ä¹Ÿå®šä¹‰äº†åˆå§‹çŠ¶æ€\n1 2 3 4 5 6 var ( m0 m g0 g mcache0 *mcache raceprocctx0 uintptr ) ç¨‹åºå¼€å§‹æ—¶ï¼Œä¼šå…ˆæ‰§è¡Œschedinitåˆ›å»ºç¬¬ä¸€ä¸ªGï¼Œmstartå‡½æ•°åˆ›å»ºç¬¬ä¸€ä¸ªM\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 func newm1(mp *m) { if iscgo { var ts cgothreadstart if _cgo_thread_start == nil { throw(\u0026#34;_cgo_thread_start missing\u0026#34;) } ts.g.set(mp.g0) ts.tls = (*uint64)(unsafe.Pointer(\u0026amp;mp.tls[0])) ts.fn = unsafe.Pointer(funcPC(mstart)) if msanenabled { msanwrite(unsafe.Pointer(\u0026amp;ts), unsafe.Sizeof(ts)) } execLock.rlock() // Prevent process clone. asmcgocall(_cgo_thread_start, unsafe.Pointer(\u0026amp;ts)) execLock.runlock() return } execLock.rlock() // Prevent process clone. newosproc(mp) execLock.runlock() } func mstart() { _g_ := getg() // è¿™é‡Œåˆ›å»ºçš„æ˜¯g0ï¼Œåˆ†é…åœ¨ç³»ç»Ÿå †æ ˆ osStack := _g_.stack.lo == 0 if osStack { // Initialize stack bounds from system stack. size := _g_.stack.hi if size == 0 { size = 8192 * sys.StackGuardMultiplier } _g_.stack.hi = uintptr(noescape(unsafe.Pointer(\u0026amp;size))) _g_.stack.lo = _g_.stack.hi - size + 1024 } // Initialize stack guard so that we can start calling regular // Go code. _g_.stackguard0 = _g_.stack.lo + _StackGuard // This is the g0, so we can also call go:systemstack // functions, which check stackguard1. _g_.stackguard1 = _g_.stackguard0 mstart1() // Exit this thread. if mStackIsSystemAllocated() { osStack = true } mexit(osStack) } ä»¥ä¸Šå‡½æ•°å‡½æ•°ä¼šè°ƒç”¨mstart1æ¥å°†g0ç»‘å®šåˆ°m0ä¸Šï¼Œå¹¶å¼€å§‹æ‰§è¡Œscheduleè°ƒåº¦\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 func mstart1() { _g_ := getg() if _g_ != _g_.m.g0 { throw(\u0026#34;bad runtimeÂ·mstart\u0026#34;) } // Record the caller for use as the top of stack in mcall and // for terminating the thread. // We\u0026#39;re never coming back to mstart1 after we call schedule, // so other calls can reuse the current frame. save(getcallerpc(), getcallersp()) asminit() minit() // å°†Mè¿›è¡Œåˆå§‹åŒ–ï¼Œè®¾ç½®çº¿ç¨‹çš„å¤‡ç”¨ä¿¡å·å †æ ˆå’Œä¿¡å·æ©ç  // Install signal handlers; after minit so that minit can // prepare the thread to be able to handle the signals. if _g_.m == \u0026amp;m0 { mstartm0() } if fn := _g_.m.mstartfn; fn != nil { fn() } if _g_.m != \u0026amp;m0 { acquirep(_g_.m.nextp.ptr()) _g_.m.nextp = 0 } schedule() } // mstartm0 implements part of mstart1 that only runs on the m0. // // Write barriers are allowed here because we know the GC can\u0026#39;t be // running yet, so they\u0026#39;ll be no-ops. // //go:yeswritebarrierrec func mstartm0() { // Create an extra M for callbacks on threads not created by Go. // An extra M is also needed on Windows for callbacks created by // syscall.NewCallback. See issue #6751 for details. if (iscgo || GOOS == \u0026#34;windows\u0026#34;) \u0026amp;\u0026amp; !cgoHasExtraM { cgoHasExtraM = true newextram() } initsig(false) } mstart1() åœ¨ç»“æŸé˜¶æ®µï¼Œä¼šè°ƒç”¨scheduleï¼Œè€Œscheduleåœ¨æœ¬åœ°é˜Ÿåˆ—ä¸­ç¬¬ä¸€æ¬¡ä¼šæ‰¾åˆ°main goroutineï¼Œè€Œç¬¬ä¸€ä¸ªgoroutineç»‘å®šçš„æ–¹æ³•å°±æ˜¯mainï¼Œè€Œmainæ–¹æ³•å®Œæˆä»¥ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 // The main goroutine. func main() { g := getg() // Racectx of m0-\u0026gt;g0 is used only as the parent of the main goroutine. // It must not be used for anything else. g.m.g0.racectx = 0 // Max stack size is 1 GB on 64-bit, 250 MB on 32-bit. // Using decimal instead of binary GB and MB because // they look nicer in the stack overflow failure message. if sys.PtrSize == 8 { maxstacksize = 1000000000 } else { maxstacksize = 250000000 } // An upper limit for max stack size. Used to avoid random crashes // after calling SetMaxStack and trying to allocate a stack that is too big, // since stackalloc works with 32-bit sizes. maxstackceiling = 2 * maxstacksize // Allow newproc to start new Ms. mainStarted = true if GOARCH != \u0026#34;wasm\u0026#34; { // no threads on wasm yet, so no sysmon // For runtime_syscall_doAllThreadsSyscall, we // register sysmon is not ready for the world to be // stopped. atomic.Store(\u0026amp;sched.sysmonStarting, 1) systemstack(func() { newm(sysmon, nil, -1) }) } // Lock the main goroutine onto this, the main OS thread, // during initialization. Most programs won\u0026#39;t care, but a few // do require certain calls to be made by the main thread. // Those can arrange for main.main to run in the main thread // by calling runtime.LockOSThread during initialization // to preserve the lock. lockOSThread() if g.m != \u0026amp;m0 { throw(\u0026#34;runtime.main not on m0\u0026#34;) } m0.doesPark = true // Record when the world started. // Must be before doInit for tracing init. runtimeInitTime = nanotime() if runtimeInitTime == 0 { throw(\u0026#34;nanotime returning zero\u0026#34;) } if debug.inittrace != 0 { inittrace.id = getg().goid inittrace.active = true } doInit(\u0026amp;runtime_inittask) // Must be before defer. // Defer unlock so that runtime.Goexit during init does the unlock too. needUnlock := true defer func() { if needUnlock { unlockOSThread() } }() gcenable() main_init_done = make(chan bool) if iscgo { if _cgo_thread_start == nil { throw(\u0026#34;_cgo_thread_start missing\u0026#34;) } if GOOS != \u0026#34;windows\u0026#34; { if _cgo_setenv == nil { throw(\u0026#34;_cgo_setenv missing\u0026#34;) } if _cgo_unsetenv == nil { throw(\u0026#34;_cgo_unsetenv missing\u0026#34;) } } if _cgo_notify_runtime_init_done == nil { throw(\u0026#34;_cgo_notify_runtime_init_done missing\u0026#34;) } // Start the template thread in case we enter Go from // a C-created thread and need to create a new thread. startTemplateThread() cgocall(_cgo_notify_runtime_init_done, nil) } doInit(\u0026amp;main_inittask) // Disable init tracing after main init done to avoid overhead // of collecting statistics in malloc and newproc inittrace.active = false close(main_init_done) needUnlock = false unlockOSThread() if isarchive || islibrary { // A program compiled with -buildmode=c-archive or c-shared // has a main, but it is not executed. return } fn := main_main // make an indirect call, as the linker doesn\u0026#39;t know the address of the main package when laying down the runtime fn() if raceenabled { racefini() } // Make racy client program work: if panicking on // another goroutine at the same time as main returns, // let the other goroutine finish printing the panic trace. // Once it does, it will exit. See issues 3934 and 20018. if atomic.Load(\u0026amp;runningPanicDefers) != 0 { // Running deferred functions should not take long. for c := 0; c \u0026lt; 1000; c++ { if atomic.Load(\u0026amp;runningPanicDefers) == 0 { break } Gosched() } } if atomic.Load(\u0026amp;panicking) != 0 { gopark(nil, nil, waitReasonPanicWait, traceEvGoStop, 1) } exit(0) for { var x *int32 *x = 0 } } ç»¼ä¸Šæ‰€è¿°ï¼šGoè¯­è¨€å¯åŠ¨æµç¨‹å¯ä»¥ç®€åŒ–å¦‚ä¸‹\nç¡®å®šå½“å‰ç³»ç»Ÿçš„å¹³å°ï¼ŒOSinit\nschedinitï¼šåšå¥½åˆå§‹åŒ–ä¸€äº›é”ï¼Œcpuï¼Œgcç­‰ï¼Œä¹‹åè°ƒç”¨procresize\nprocresizeï¼šå°†å½“å‰çš„m0å’Œallp[0]è¿›è¡Œç»‘å®šï¼Œå†è°ƒç”¨\nmstartï¼šåˆ†é…goçš„å †æ ˆï¼Œå°†m0å’Œg0ç»‘å®š\nscheduleï¼šè°ƒåº¦å¼€å§‹ï¼Œé¦–å…ˆæ‰§è¡Œm0çš„g0ï¼Œç»‘å®šçš„å‡½æ•°å³ä¸ºmain\nmain goroutineï¼šå¼€å§‹å‡½æ•°çš„æ‰§è¡Œæµ\n1.3.2. Schedinit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func schedinit() { _g_ := getg() ... sched.maxmcount = 10000 ... sched.lastpoll = uint64(nanotime()) procs := ncpu if n, ok := atoi32(gogetenv(\u0026#34;GOMAXPROCS\u0026#34;)); ok \u0026amp;\u0026amp; n \u0026gt; 0 { procs = n } if procresize(procs) != nil { throw(\u0026#34;unknown runnable goroutine during bootstrap\u0026#34;) } } å¦‚æœå…¨å±€å˜é‡ allp åˆ‡ç‰‡ä¸­çš„å¤„ç†å™¨æ•°é‡å°‘äºæœŸæœ›æ•°é‡ï¼Œä¼šå¯¹åˆ‡ç‰‡è¿›è¡Œæ‰©å®¹ï¼› ä½¿ç”¨ new åˆ›å»ºæ–°çš„å¤„ç†å™¨ç»“æ„ä½“å¹¶è°ƒç”¨ runtime.p.init åˆå§‹åŒ–åˆšåˆšæ‰©å®¹çš„å¤„ç†å™¨ï¼› é€šè¿‡æŒ‡é’ˆå°†çº¿ç¨‹ m0 å’Œå¤„ç†å™¨ allp[0] ç»‘å®šåˆ°ä¸€èµ·ï¼› è°ƒç”¨ runtime.p.destroy é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¤„ç†å™¨ç»“æ„ï¼› é€šè¿‡æˆªæ–­æ”¹å˜å…¨å±€å˜é‡ allp çš„é•¿åº¦ä¿è¯ä¸æœŸæœ›å¤„ç†å™¨æ•°é‡ç›¸ç­‰ï¼› å°†é™¤ allp[0] ä¹‹å¤–çš„å¤„ç†å™¨ P å…¨éƒ¨è®¾ç½®æˆ _Pidle å¹¶åŠ å…¥åˆ°å…¨å±€çš„ç©ºé—²é˜Ÿåˆ—ä¸­ï¼› 1.3.3. Schedule Loop å½“ç¨‹åºçš„è°ƒåº¦å™¨å¯åŠ¨ä¹‹åï¼Œä¼šæ‰§è¡Œschedule()å‡½æ•°æŸ¥æ‰¾goroutine\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 func schedule() { _g_ := getg() top: var gp *g var inheritTime bool if gp == nil { // å¦‚æœå‘ç”Ÿäº†61æ¬¡è°ƒåº¦ï¼Œä¸”å…¨å±€é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™å»å…¨å±€é˜Ÿåˆ—ä¸­æ‰¾goroutine if _g_.m.p.ptr().schedtick%61 == 0 \u0026amp;\u0026amp; sched.runqsize \u0026gt; 0 { lock(\u0026amp;sched.lock) gp = globrunqget(_g_.m.p.ptr(), 1) unlock(\u0026amp;sched.lock) } } if gp == nil { gp, inheritTime = runqget(_g_.m.p.ptr()) } if gp == nil { gp, inheritTime = findrunnable() } // ... if gp.lockedm != 0 { // Hands off own p to the locked m, // then blocks waiting for a new p. startlockedm(gp) goto top } execute(gp, inheritTime) } ä¸ºäº†ä¿è¯å…¬å¹³ï¼Œå½“å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æœ‰å¾…æ‰§è¡Œçš„ Goroutine æ—¶ï¼Œé€šè¿‡ schedtick ä¿è¯æœ‰ä¸€å®šå‡ ç‡ä¼šä»å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¯¹åº”çš„ Goroutineï¼› ä»å¤„ç†å™¨æœ¬åœ°çš„è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾å¾…æ‰§è¡Œçš„ Goroutineï¼› å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½æ²¡æœ‰æ‰¾åˆ° Goroutineï¼Œä¼šé€šè¿‡ runtime.findrunnableè¿›è¡Œé˜»å¡åœ°æŸ¥æ‰¾ Goroutineï¼› findrunnableå‡½æ•°ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š\nä»æœ¬åœ°è¿è¡Œé˜Ÿåˆ—ã€å…¨å±€è¿è¡Œé˜Ÿåˆ—ä¸­æŸ¥æ‰¾ï¼› ä»ç½‘ç»œè½®è¯¢å™¨ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ Goroutine ç­‰å¾…è¿è¡Œï¼› é€šè¿‡ runtime.runqstealå°è¯•ä»å…¶ä»–éšæœºçš„å¤„ç†å™¨ä¸­çªƒå–å¾…è¿è¡Œçš„ Goroutineï¼Œè¯¥å‡½æ•°è¿˜å¯èƒ½çªƒå–å¤„ç†å™¨çš„è®¡æ—¶å™¨ï¼› åœ¨è·å–åˆ°Goroutineä»¥åï¼Œæœ€ç»ˆä¼šè°ƒç”¨executeå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func execute(gp *g, inheritTime bool) { _g_ := getg() _g_.m.curg = gp gp.m = _g_.m casgstatus(gp, _Grunnable, _Grunning) gp.waitsince = 0 gp.preempt = false gp.stackguard0 = gp.stack.lo + _StackGuard if !inheritTime { _g_.m.p.ptr().schedtick++ } gogo(\u0026amp;gp.sched) } é€šè¿‡gogoå‡½æ•°ï¼Œå°†è¿™ä¸ªGoroutineè°ƒåº¦åˆ°å½“å‰çº¿ç¨‹ä¸Šï¼Œgogoå‡½æ•°ä¼šä» runtime.gobuf ä¸­å–å‡ºäº† runtime.goexitçš„ç¨‹åºè®¡æ•°å™¨å’Œå¾…æ‰§è¡Œå‡½æ•°çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå…¶ä¸­ï¼š\nruntime.goexit çš„ç¨‹åºè®¡æ•°å™¨è¢«æ”¾åˆ°äº†æ ˆ SP ä¸Šï¼› å¾…æ‰§è¡Œå‡½æ•°çš„ç¨‹åºè®¡æ•°å™¨è¢«æ”¾åˆ°äº†å¯„å­˜å™¨ BX ä¸Šï¼› å½“è¿™ä¸ªGoroutineç»“æŸçš„æ—¶å€™ï¼Œä¼šruntimeÂ·goexit(SB)ï¼Œå†ç»è¿‡ä¸€ç³»åˆ—å¤æ‚çš„å‡½æ•°è°ƒç”¨ï¼Œæˆ‘ä»¬æœ€ç»ˆåœ¨å½“å‰çº¿ç¨‹çš„ g0 çš„æ ˆä¸Šè°ƒç”¨ runtime.goexit0å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå°† Goroutine è½¬æ¢ä¼š _Gdead çŠ¶æ€ã€æ¸…ç†å…¶ä¸­çš„å­—æ®µã€ç§»é™¤ Goroutine å’Œçº¿ç¨‹çš„å…³è”å¹¶è°ƒç”¨ runtime.gfputé‡æ–°åŠ å…¥å¤„ç†å™¨çš„ Goroutine ç©ºé—²åˆ—è¡¨ gFreeï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func goexit0(gp *g) { _g_ := getg() casgstatus(gp, _Grunning, _Gdead) gp.m = nil ... gp.param = nil gp.labels = nil gp.timer = nil dropg() gfput(_g_.m.p.ptr(), gp) schedule() } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨goexit0è°ƒç”¨ç»“æŸåï¼Œä¼šå†æ¬¡å‡ºå‘schedule()é‡æ–°è¿›è¡Œä¸€è½®è°ƒåº¦ã€‚\n1.4. Trigger Scheduling 1.4.0. Create è¯¦æƒ…è§1.2ï¼Œåœ¨çº¿ç¨‹å¯åŠ¨ runtime.mstartå’Œ Goroutine æ‰§è¡Œç»“æŸ runtime.goexit0è§¦å‘è°ƒåº¦ä¹‹å¤–ã€‚è¿˜æœ‰ä»¥ä¸‹æ–¹æ³•ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒåº¦ç­–ç•¥ã€‚\n1.4.1. Park ä¸»åŠ¨æŒ‚èµ·æ˜¯è§¦å‘è°ƒåº¦æœ€å¸¸è§çš„æ–¹æ³•ï¼Œè¯¥å‡½æ•°ä¼šå°†å½“å‰ Goroutine æš‚åœï¼Œè¢«æš‚åœçš„ä»»åŠ¡ä¸ä¼šæ”¾å›è¿è¡Œé˜Ÿåˆ—\n1 2 3 4 5 6 7 8 9 10 11 func gopark(unlockf func(*g, unsafe.Pointer) bool, lock unsafe.Pointer, reason waitReason, traceEv byte, traceskip int) { mp := acquirem() gp := mp.curg mp.waitlock = lock mp.waitunlockf = unlockf gp.waitreason = reason mp.waittraceev = traceEv mp.waittraceskip = traceskip releasem(mp) mcall(park_m) } å…¶ä¸­park_mè¿˜ä¼šå°†çŠ¶æ€ç”±_Grunningåˆ‡æ¢ä¸º_Gwaitingï¼Œå¹¶ä¸”ä½¿ç”¨dropgç§»é™¤å½“å‰çº¿ç¨‹å’Œè¿™ä¸ªGoroutineçš„å…³è”ã€‚\n1 2 3 4 5 6 7 8 func park_m(gp *g) { _g_ := getg() casgstatus(gp, _Grunning, _Gwaiting) dropg() schedule() } å†éœ€è¦é‡æ–°å”¤é†’çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•è¿›è¡Œå”¤é†’ï¼Œå°†çŠ¶æ€åˆ‡æ¢å›_Grunnable å¹¶å°†å…¶åŠ å…¥å¤„ç†å™¨çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func goready(gp *g, traceskip int) { systemstack(func() { ready(gp, traceskip, true) }) } func ready(gp *g, traceskip int, next bool) { _g_ := getg() casgstatus(gp, _Gwaiting, _Grunnable) runqput(_g_.m.p.ptr(), gp, next) if atomic.Load(\u0026amp;sched.npidle) != 0 \u0026amp;\u0026amp; atomic.Load(\u0026amp;sched.nmspinning) == 0 { wakep() } } 1.4.2. System call Go è¯­è¨€é€šè¿‡ syscall.Syscallå’Œ syscall.RawSyscallç­‰ä½¿ç”¨æ±‡ç¼–è¯­è¨€ç¼–å†™çš„æ–¹æ³•å°è£…æ“ä½œç³»ç»Ÿæä¾›çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 #define INVOKE_SYSCALL INT $0x80 TEXT Â·Syscall(SB),NOSPLIT,$0-28 CALL runtimeÂ·entersyscall(SB) ... INVOKE_SYSCALL ... CALL runtimeÂ·exitsyscall(SB) RET ok: ... CALL runtimeÂ·exitsyscall(SB) RET Goä½¿ç”¨äº†entrysyscallå’Œexitsyscallå®Œæˆç³»ç»Ÿè°ƒç”¨æ—¶çš„å‡†å¤‡ä¸æ¸…ç†å·¥ä½œï¼Œå¯¹äºä¸éœ€è¦è¿è¡Œæ—¶å‚ä¸çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ¯”å¦‚SYS_TIMEï¼ŒSYS_EPOLL_WAITï¼ŒGoå°è£…äº†ä¸€å±‚RawSyscallæ¥è°ƒç”¨ã€‚\nåœ¨è°ƒç”¨entrysyscallä¼šè°ƒç”¨reentersyscallå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 //go:nosplit //go:linkname entersyscall func entersyscall() { reentersyscall(getcallerpc(), getcallersp()) } func reentersyscall(pc, sp uintptr) { _g_ := getg() _g_.m.locks++ _g_.stackguard0 = stackPreempt _g_.throwsplit = true save(pc, sp) _g_.syscallsp = sp _g_.syscallpc = pc casgstatus(_g_, _Grunning, _Gsyscall) _g_.m.syscalltick = _g_.m.p.ptr().syscalltick _g_.m.mcache = nil pp := _g_.m.p.ptr() pp.m = 0 _g_.m.oldp.set(pp) _g_.m.p = 0 atomic.Store(\u0026amp;pp.status, _Psyscall) if sched.gcwaiting != 0 { systemstack(entersyscall_gcwait) save(pc, sp) } _g_.m.locks-- } ç¦æ­¢çº¿ç¨‹ä¸Šå‘ç”Ÿçš„æŠ¢å ï¼Œé˜²æ­¢å‡ºç°å†…å­˜ä¸ä¸€è‡´çš„é—®é¢˜ï¼› ä¿è¯å½“å‰å‡½æ•°ä¸ä¼šè§¦å‘æ ˆåˆ†è£‚æˆ–è€…å¢é•¿ï¼› ä¿å­˜å½“å‰çš„ç¨‹åºè®¡æ•°å™¨ PC å’Œæ ˆæŒ‡é’ˆ SP ä¸­çš„å†…å®¹ï¼› å°† Goroutine çš„çŠ¶æ€æ›´æ–°è‡³ _Gsyscallï¼› å°† Goroutine çš„å¤„ç†å™¨å’Œçº¿ç¨‹æš‚æ—¶åˆ†ç¦»å¹¶æ›´æ–°å¤„ç†å™¨çš„çŠ¶æ€åˆ° _Psyscallï¼› é‡Šæ”¾å½“å‰çº¿ç¨‹ä¸Šçš„é”ï¼› å½“å‰çº¿ç¨‹ä¼šé™·å…¥ç³»ç»Ÿè°ƒç”¨ç­‰å¾…è¿”å›ï¼Œåœ¨é”è¢«é‡Šæ”¾åï¼Œä¼šæœ‰å…¶ä»– Goroutine æŠ¢å å¤„ç†å™¨èµ„æºã€‚\nå½“ç³»ç»Ÿè°ƒç”¨ç»“æŸåï¼Œä¼šå†æ¬¡è¿”å›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func exitsyscall() { _g_ := getg() oldp := _g_.m.oldp.ptr() _g_.m.oldp = 0 if exitsyscallfast(oldp) { _g_.m.p.ptr().syscalltick++ casgstatus(_g_, _Gsyscall, _Grunning) ... return } mcall(exitsyscall0) _g_.m.p.ptr().syscalltick++ _g_.throwsplit = false } å…¶ä¸­exitsyscallfastä¼šæœ‰ä¸¤ç§ä¸åŒçš„åˆ†æ”¯ï¼š\nå¦‚æœ Goroutine çš„åŸå¤„ç†å™¨å¤„äº _Psyscall çŠ¶æ€ï¼Œä¼šç›´æ¥è°ƒç”¨ wirep å°† Goroutine ä¸å¤„ç†å™¨è¿›è¡Œå…³è”ï¼› 1 2 3 4 5 6 7 // Try to re-acquire the last P. if oldp != nil \u0026amp;\u0026amp; oldp.status == _Psyscall \u0026amp;\u0026amp; atomic.Cas(\u0026amp;oldp.status, _Psyscall, _Pidle) { // There\u0026#39;s a cpu for us, so we can run. wirep(oldp) exitsyscallfast_reacquired() return true } å¦‚æœè°ƒåº¦å™¨ä¸­å­˜åœ¨é—²ç½®çš„å¤„ç†å™¨ï¼Œä¼šè°ƒç”¨ acquirepä½¿ç”¨é—²ç½®çš„å¤„ç†å™¨å¤„ç†å½“å‰ Goroutineï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 func exitsyscallfast_pidle() bool { lock(\u0026amp;sched.lock) _p_ := pidleget() if _p_ != nil \u0026amp;\u0026amp; atomic.Load(\u0026amp;sched.sysmonwait) != 0 { atomic.Store(\u0026amp;sched.sysmonwait, 0) notewakeup(\u0026amp;sched.sysmonnote) } unlock(\u0026amp;sched.lock) if _p_ != nil { acquirep(_p_) return true } return false } // Associate p and the current m. // // This function is allowed to have write barriers even if the caller // isn\u0026#39;t because it immediately acquires _p_. // //go:yeswritebarrierrec func acquirep(_p_ *p) { // Do the part that isn\u0026#39;t allowed to have write barriers. wirep(_p_) // Have p; write barriers now allowed. // Perform deferred mcache flush before this P can allocate // from a potentially stale mcache. _p_.mcache.prepareForSweep() if trace.enabled { traceProcStart() } } // wirep is the first step of acquirep, which actually associates the // current M to _p_. This is broken out so we can disallow write // barriers for this part, since we don\u0026#39;t yet have a P. // //go:nowritebarrierrec //go:nosplit func wirep(_p_ *p) { _g_ := getg() if _g_.m.p != 0 { throw(\u0026#34;wirep: already in go\u0026#34;) } if _p_.m != 0 || _p_.status != _Pidle { id := int64(0) if _p_.m != 0 { id = _p_.m.ptr().id } print(\u0026#34;wirep: p-\u0026gt;m=\u0026#34;, _p_.m, \u0026#34;(\u0026#34;, id, \u0026#34;) p-\u0026gt;status=\u0026#34;, _p_.status, \u0026#34;\\n\u0026#34;) throw(\u0026#34;wirep: invalid p state\u0026#34;) } _g_.m.p.set(_p_) _p_.m.set(_g_.m) _p_.status = _Prunning } å¦ä¸€ä¸ªç›¸å¯¹è¾ƒæ…¢çš„è·¯å¾„ runtime.exitsyscall0 ä¼šå°†å½“å‰ Goroutine åˆ‡æ¢è‡³ _Grunnable çŠ¶æ€ï¼Œå¹¶ç§»é™¤çº¿ç¨‹ M å’Œå½“å‰ Goroutine çš„å…³è”ï¼š\nå½“æˆ‘ä»¬é€šè¿‡ runtime.pidleget è·å–åˆ°é—²ç½®çš„å¤„ç†å™¨æ—¶å°±ä¼šåœ¨è¯¥å¤„ç†å™¨ä¸Šæ‰§è¡Œ Goroutineï¼› åœ¨å…¶å®ƒæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šå°†å½“å‰ Goroutine æ”¾åˆ°å…¨å±€çš„è¿è¡Œé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ï¼› æ— è®ºå“ªç§æƒ…å†µï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªå‡½æ•°ä¸­éƒ½ä¼šè°ƒç”¨ runtime.schedule è§¦å‘è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚\n1.4.3. Cooperative è¯¥æ–¹æ³•ä¸ä¼šæŒ‚èµ·Goroutineï¼Œè€Œæ˜¯å°†å½“å‰çš„Goroutineè°ƒåº¦åˆ°å…¶ä»–çº¿ç¨‹ä¸Š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // Gosched yields the processor, allowing other goroutines to run. It does not // suspend the current goroutine, so execution resumes automatically. func Gosched() { checkTimeouts() mcall(gosched_m) } // Gosched continuation on g0. func gosched_m(gp *g) { if trace.enabled { traceGoSched() } goschedImpl(gp) } func goschedImpl(gp *g) { status := readgstatus(gp) if status\u0026amp;^_Gscan != _Grunning { dumpgstatus(gp) throw(\u0026#34;bad g status\u0026#34;) } casgstatus(gp, _Grunning, _Grunnable) dropg() lock(\u0026amp;sched.lock) globrunqput(gp) unlock(\u0026amp;sched.lock) schedule() } è¿è¡Œæ—¶ä¼šæ›´æ–° Goroutine çš„çŠ¶æ€åˆ° _Grunnableï¼Œè®©å‡ºå½“å‰çš„å¤„ç†å™¨å¹¶å°† Goroutine é‡æ–°æ”¾å›å…¨å±€é˜Ÿåˆ—ï¼Œåœ¨æœ€åï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨ runtime.schedule è§¦å‘è°ƒåº¦ã€‚\n1.5. Thread Control Goroutine åº”è¯¥åœ¨è°ƒç”¨æ“ä½œç³»ç»ŸæœåŠ¡æˆ–è€…ä¾èµ–çº¿ç¨‹çŠ¶æ€çš„é Go è¯­è¨€åº“æ—¶è°ƒç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func LockOSThread() { if atomic.Load(\u0026amp;newmHandoff.haveTemplateThread) == 0 \u0026amp;\u0026amp; GOOS != \u0026#34;plan9\u0026#34; { startTemplateThread() } _g_ := getg() _g_.m.lockedExt++ dolockOSThread() } func dolockOSThread() { _g_ := getg() _g_.m.lockedg.set(_g_) _g_.lockedm.set(_g_.m) } ä¼šåˆ†åˆ«è®¾ç½®çº¿ç¨‹çš„ lockedg å­—æ®µå’Œ Goroutine çš„ lockedm å­—æ®µï¼Œè¿™ä¸¤è¡Œä»£ç ä¼šç»‘å®šçº¿ç¨‹å’Œ Goroutineã€‚\nå½“Goroutineå®Œæˆæ“ä½œä¹‹åï¼Œä¼šä½¿ç”¨å¦‚ä¸‹æ–¹æ³•åˆ†ç¦»Goroutineå’Œçº¿ç¨‹ã€‚\nGo è¯­è¨€çš„è¿è¡Œæ—¶ä¼šé€šè¿‡ runtime.startm å¯åŠ¨çº¿ç¨‹æ¥æ‰§è¡Œå¤„ç†å™¨ Pï¼Œå¦‚æœæˆ‘ä»¬åœ¨è¯¥å‡½æ•°ä¸­æ²¡èƒ½ä»é—²ç½®åˆ—è¡¨ä¸­è·å–åˆ°çº¿ç¨‹ M å°±ä¼šè°ƒç”¨ runtime.newm åˆ›å»ºæ–°çš„çº¿ç¨‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func newm(fn func(), _p_ *p, id int64) { mp := allocm(_p_, fn, id) mp.nextp.set(_p_) mp.sigmask = initSigmask ... newm1(mp) } func newm1(mp *m) { if iscgo { ... } newosproc(mp) } è¯¥å‡½æ•°åœ¨ Linux å¹³å°ä¸Šä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨ clone åˆ›å»ºæ–°çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œå®ƒä¹Ÿæ˜¯åˆ›å»ºçº¿ç¨‹é“¾è·¯ä¸Šè·ç¦»æ“ä½œç³»ç»Ÿæœ€è¿‘çš„ Go è¯­è¨€å‡½æ•°\n1 2 3 4 5 6 func newosproc(mp *m) { stk := unsafe.Pointer(mp.g0.stack.hi) ... ret := clone(cloneFlags, stk, unsafe.Pointer(mp), unsafe.Pointer(mp.g0), unsafe.Pointer(funcPC(mstart))) ... } 2. System Monitor åœ¨ç¨‹åºå¯åŠ¨å‰ï¼Œä¼šé¦–å…ˆè°ƒç”¨runtime.mainå‡½æ•°ï¼Œå…¶ä¸­å°±åŒ…æ‹¬äº†sysmonçš„åˆ›å»º\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func main() { ... if GOARCH != \u0026#34;wasm\u0026#34; { systemstack(func() { newm(sysmon, nil) }) } ... } func newm(fn func(), _p_ *p) { mp := allocm(_p_, fn) mp.nextp.set(_p_) mp.sigmask = initSigmask ... newm1(mp) } newm1ä¼šè°ƒç”¨ç‰¹å®šå¹³å°çš„ runtime.newosproc é€šè¿‡ç³»ç»Ÿè°ƒç”¨ clone åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹å¹¶åœ¨æ–°çš„çº¿ç¨‹ä¸­æ‰§è¡Œ runtime.mstart\n1 2 3 4 5 6 7 8 func newosproc(mp *m) { stk := unsafe.Pointer(mp.g0.stack.hi) var oset sigset sigprocmask(_SIG_SETMASK, \u0026amp;sigset_all, \u0026amp;oset) ret := clone(cloneFlags, stk, unsafe.Pointer(mp), unsafe.Pointer(mp.g0), unsafe.Pointer(funcPC(mstart))) sigprocmask(_SIG_SETMASK, \u0026amp;oset, nil) ... } åœ¨æ–°å»ºçº¿ç¨‹æ—¶ï¼Œä¼šæ‰§è¡Œruntime.mä¸­çš„sysmonå¯åŠ¨ç›‘æ§\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func sysmon() { sched.nmsys++ checkdead() lasttrace := int64(0) idle := 0 delay := uint32(0) for { if idle == 0 { delay = 20 } else if idle \u0026gt; 50 { delay *= 2 } if delay \u0026gt; 10*1000 { delay = 10 * 1000 } usleep(delay) ... } } å½“è¿è¡Œæ—¶åˆšåˆšè°ƒç”¨ä¸Šè¿°å‡½æ•°æ—¶ï¼Œä¼šå…ˆé€šè¿‡ runtime.checkdead æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ­»é”ï¼Œç„¶åè¿›å…¥æ ¸å¿ƒçš„ç›‘æ§å¾ªç¯ï¼›ç³»ç»Ÿç›‘æ§åœ¨æ¯æ¬¡å¾ªç¯å¼€å§‹æ—¶éƒ½ä¼šé€šè¿‡ usleep æŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œè¯¥å‡½æ•°çš„å‚æ•°æ˜¯å¾®ç§’ï¼Œè¿è¡Œæ—¶ä¼šéµå¾ªä»¥ä¸‹çš„è§„åˆ™å†³å®šä¼‘çœ æ—¶é—´ï¼š\nåˆå§‹çš„ä¼‘çœ æ—¶é—´æ˜¯ 20Î¼sï¼› æœ€é•¿çš„ä¼‘çœ æ—¶é—´æ˜¯ 10msï¼› å½“ç³»ç»Ÿç›‘æ§åœ¨ 50 ä¸ªå¾ªç¯ä¸­éƒ½æ²¡æœ‰å”¤é†’ Goroutine æ—¶ï¼Œä¼‘çœ æ—¶é—´åœ¨æ¯ä¸ªå¾ªç¯éƒ½ä¼šå€å¢ï¼› å½“ç¨‹åºè¶‹äºç¨³å®šä¹‹åï¼Œç³»ç»Ÿç›‘æ§çš„è§¦å‘æ—¶é—´å°±ä¼šç¨³å®šåœ¨ 10msã€‚å®ƒé™¤äº†ä¼šæ£€æŸ¥æ­»é”ä¹‹å¤–ï¼Œè¿˜ä¼šåœ¨å¾ªç¯ä¸­å®Œæˆä»¥ä¸‹çš„å·¥ä½œï¼š\nè¿è¡Œè®¡æ—¶å™¨ â€” è·å–ä¸‹ä¸€ä¸ªéœ€è¦è¢«è§¦å‘çš„è®¡æ—¶å™¨ï¼› è½®è¯¢ç½‘ç»œ â€” è·å–éœ€è¦å¤„ç†çš„åˆ°æœŸæ–‡ä»¶æè¿°ç¬¦ï¼› æŠ¢å å¤„ç†å™¨ â€” æŠ¢å è¿è¡Œæ—¶é—´è¾ƒé•¿çš„æˆ–è€…å¤„äºç³»ç»Ÿè°ƒç”¨çš„ Goroutineï¼› åƒåœ¾å›æ”¶ â€” åœ¨æ»¡è¶³æ¡ä»¶æ—¶è§¦å‘åƒåœ¾æ”¶é›†å›æ”¶å†…å­˜ï¼› 3. Stack And Heap 3.1. Traditional Language æ ˆä¸€èˆ¬ç”±æ“ä½œç³»ç»Ÿæ¥åˆ†é…å’Œé‡Šæ”¾ï¼Œå †ç”±ç¨‹åºå‘˜é€šè¿‡ç¼–ç¨‹è¯­è¨€æ¥ç”³è¯·åˆ›å»ºä¸é‡Šæ”¾ã€‚\næ ˆç”¨æ¥å­˜æ”¾å‡½æ•°çš„å‚æ•°ã€è¿”å›å€¼ã€å±€éƒ¨å˜é‡ã€å‡½æ•°è°ƒç”¨æ—¶çš„ä¸´æ—¶ä¸Šä¸‹æ–‡ç­‰ï¼Œå †ç”¨æ¥å­˜æ”¾å…¨å±€å˜é‡ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·ç†è§£æ•°æ®å­˜æ”¾çš„è§„åˆ™ï¼šåªè¦æ˜¯å±€éƒ¨çš„ã€å ç”¨ç©ºé—´ç¡®å®šçš„æ•°æ®ï¼Œä¸€èˆ¬éƒ½å­˜æ”¾åœ¨stack é‡Œé¢ï¼Œå¦åˆ™å°±æ”¾åœ¨ heap é‡Œé¢ã€‚\næ ˆçš„è®¿é—®é€Ÿåº¦ç›¸å¯¹æ¯”å †å¿«ã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªstackï¼Œæ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªheapï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œstack æ˜¯çº¿ç¨‹ç‹¬å çš„ï¼Œheap æ˜¯çº¿ç¨‹å…±ç”¨çš„ã€‚\nstack åˆ›å»ºçš„æ—¶å€™ï¼Œå¤§å°æ˜¯ç¡®å®šçš„ï¼Œæ•°æ®è¶…è¿‡è¿™ä¸ªå¤§å°ï¼Œå°±å‘ç”Ÿstack overflow é”™è¯¯ï¼Œè€Œheapçš„å¤§å°æ˜¯ä¸ç¡®å®šçš„ï¼Œéœ€è¦çš„è¯å¯ä»¥ä¸æ–­å¢åŠ ã€‚\næ ˆæ˜¯ç”±é«˜åœ°å€å‘ä½åœ°å€å¢é•¿çš„ï¼Œè€Œå †æ˜¯ç”±ä½åœ°å€å‘é«˜åœ°å€å¢é•¿çš„ã€‚\nåœ¨Goè¯­è¨€ä¸­ï¼Œå®˜æ–¹å¯¹å †æ ˆç®¡ç†åšäº†å¦‚ä¸‹çš„è§£é‡Š åªè¦æœ‰å¯¹å˜é‡çš„å¼•ç”¨ï¼Œå˜é‡å°±ä¼šå­˜åœ¨ï¼Œè€Œå®ƒå­˜å‚¨çš„ä½ç½®ä¸è¯­è¨€çš„è¯­ä¹‰æ— å…³ã€‚å¦‚æœå¯èƒ½ï¼Œå˜é‡ä¼šè¢«åˆ†é…åˆ°å…¶å‡½æ•°çš„æ ˆï¼Œä½†å¦‚æœç¼–è¯‘å™¨æ— æ³•è¯æ˜å‡½æ•°è¿”å›ä¹‹åå˜é‡æ˜¯å¦ä»ç„¶è¢«å¼•ç”¨ï¼Œå°±å¿…é¡»åœ¨å †ä¸Šåˆ†é…è¯¥å˜é‡ï¼Œé‡‡ç”¨åƒåœ¾å›æ”¶æœºåˆ¶è¿›è¡Œ ç®¡ç†ï¼Œä»è€Œé¿å…æŒ‡é’ˆæ‚¬ç©ºã€‚æ­¤å¤–ï¼Œå±€éƒ¨å˜é‡å¦‚æœéå¸¸å¤§ï¼Œä¹Ÿä¼šå­˜åœ¨å †ä¸Šã€‚\nåœ¨ç¼–è¯‘å™¨ä¸­ï¼Œå¦‚æœå˜é‡å…·æœ‰åœ°å€ï¼Œå°±ä½œä¸ºå †åˆ†é…çš„å€™é€‰ï¼Œä½†å¦‚æœé€ƒé€¸åˆ†æå¯ä»¥ç¡®å®šå…¶ç”Ÿå­˜å‘¨æœŸä¸ä¼šè¶…è¿‡å‡½æ•°è¿”å›ï¼Œå°±ä¼šåˆ†é…åœ¨æ ˆä¸Šã€‚\n3.2. Implement Go çš„å†…å­˜åˆ†é…å™¨åŸºäº Thread-Cache Malloc (tcmalloc) ï¼Œtcmalloc ä¸ºæ¯ä¸ªçº¿ç¨‹å®ç°äº†ä¸€ä¸ªæœ¬åœ°ç¼“å­˜ï¼Œ åŒºåˆ†äº†å°å¯¹è±¡ï¼ˆå°äº 32kbï¼‰å’Œå¤§å¯¹è±¡åˆ†é…ä¸¤ç§åˆ†é…ç±»å‹ï¼Œå…¶ç®¡ç†çš„å†…å­˜å•å…ƒç§°ä¸º spanã€‚\nheapArena: ä¿ç•™æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // A heapArena stores metadata for a heap arena. heapArenas are stored // outside of the Go heap and accessed via the mheap_.arenas index. //go:notinheap type heapArena struct { bitmap [heapArenaBitmapBytes]byte spans [pagesPerArena]*mspan // spans maps from virtual address page ID within this arena to *mspan. pageInUse [pagesPerArena / 8]uint8 pageMarks [pagesPerArena / 8]uint8 pageSpecials [pagesPerArena / 8]uint8 checkmarks *checkmarksMap zeroedBase uintptr } //arenaHint is a hint for where to grow the heap arenas. See // mheap_.arenaHints. //go:notinheap type arenaHint struct { addr uintptr down bool next *arenaHint } mheapï¼šåˆ†é…çš„å †ï¼Œåœ¨é¡µå¤§å°ä¸º 8KB çš„ç²’åº¦ä¸Šè¿›è¡Œç®¡ç†\nç„¶è€Œç®¡ç† arena å¦‚æ­¤ç²’åº¦çš„å†…å­˜å¹¶ä¸ç¬¦åˆå®è·µï¼Œç›¸åï¼Œæ‰€æœ‰çš„å †å¯¹è±¡éƒ½é€šè¿‡ span æŒ‰ç…§é¢„å…ˆè®¾å®šå¥½çš„ å¤§å°ç­‰çº§åˆ†åˆ«åˆ†é…ï¼Œå°äº 32KB çš„å°å¯¹è±¡åˆ™åˆ†é…åœ¨å›ºå®šå¤§å°ç­‰çº§çš„ span ä¸Šï¼Œå¦åˆ™ç›´æ¥ä» mheap ä¸Šè¿›è¡Œåˆ†é…ã€‚\nmspanï¼šæ˜¯ mheap ä¸Šç®¡ç†çš„ä¸€è¿ä¸²çš„é¡µ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 //go:notinheap type mspan struct { // åŒå‘é“¾è¡¨ next *mspan // é“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ª spanï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸º nil prev *mspan // é“¾è¡¨ä¸­çš„å‰ä¸€ä¸ª spanï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸º nil ... startAddr uintptr // span çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€ï¼Œå³ s.base() npages uintptr // ä¸€ä¸ª span ä¸­çš„ page æ•°é‡ manualFreeList gclinkptr // mSpanManual span çš„é‡Šæ”¾å¯¹è±¡é“¾è¡¨ ... freeindex uintptr nelems uintptr // span ä¸­å¯¹è±¡çš„æ•°é‡ allocCache uint64 allocBits *gcBits ... allocCount uint16 // åˆ†é…å¯¹è±¡çš„æ•°é‡ spanclass spanClass // å¤§å°ç­‰çº§ä¸ noscan (uint8) incache bool // æ˜¯å¦è¢« mcache ä½¿ç”¨ state mSpanState // mspaninuse ç­‰å¾…ä¿¡æ¯ ... } mcentralï¼šæ”¶é›†äº†ç»™å®šå¤§å°ç­‰çº§çš„æ‰€æœ‰ spanã€‚å½“ mcentral ä¸­ nonempty åˆ—è¡¨ä¸­ä¹Ÿæ²¡æœ‰å¯åˆ†é…çš„ span æ—¶ï¼Œåˆ™ä¼šå‘ mheap æå‡ºè¯·æ±‚ï¼Œä»è€Œè·å¾—æ–°çš„ spanï¼Œå¹¶è¿›è€Œäº¤ç»™ mcacheã€‚ 1 2 3 4 5 6 7 8 //go:notinheap type mcentral struct { lock mutex spanclass spanClass nonempty mSpanList // å¸¦æœ‰è‡ªç”±å¯¹è±¡çš„ span åˆ—è¡¨ï¼Œå³éç©ºé—²åˆ—è¡¨ empty mSpanList // æ²¡æœ‰è‡ªç”±å¯¹è±¡çš„ span åˆ—è¡¨ï¼ˆæˆ–ç¼“å­˜åœ¨ mcache ä¸­ï¼‰ ... } mcacheï¼šä¸º per-P çš„ç¼“å­˜ã€‚ 1 2 3 4 5 6 7 8 9 10 //go:notinheap type mcache struct { ... tiny uintptr tinyoffset uintptr local_tinyallocs uintptr alloc [numSpanClasses]*mspan // ç”¨æ¥åˆ†é…çš„ spansï¼Œç”± spanClass ç´¢å¼• stackcache [_NumStackOrders]stackfreelist ... } mcacheè´Ÿè´£å°å¯¹è±¡å’Œå¾®å¯¹è±¡çš„åˆ†é…ï¼Œå…¶æŒæœ‰mspan\n3.3. Allocation å¸¸è§çš„å†…å­˜ç®¡ç†æ¨¡å—åˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§fixallocã€linearAllocã€mcache\nfixalloc æ˜¯ä¸€ä¸ªåŸºäºè‡ªç”±åˆ—è¡¨çš„å›ºå®šå¤§å°çš„åˆ†é…å™¨ã€‚å…¶æ ¸å¿ƒåŸç†æ˜¯å°†è‹¥å¹²æœªåˆ†é…çš„å†…å­˜å—è¿æ¥èµ·æ¥ï¼Œ å°†æœªåˆ†é…çš„åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­—ä¸ºæŒ‡å‘ä¸‹ä¸€ä¸ªæœªåˆ†é…åŒºåŸŸçš„æŒ‡é’ˆä½¿ç”¨ã€‚Go çš„ä¸»åˆ†é…å †ä¸­ mallocï¼ˆspanã€cacheã€treapã€finalizerã€profileã€arena hint ç­‰ï¼‰ å‡ å›´ç»•å®ƒä¸ºå®ä½“è¿›è¡Œå›ºå®šåˆ†é…å’Œå›æ”¶ã€‚\nfixalloc ä½œä¸ºæŠ½è±¡ï¼Œéå¸¸ç®€æ´ï¼ŒåªåŒ…å«ä¸‰ä¸ªåŸºæœ¬æ“ä½œï¼šåˆå§‹åŒ–ã€åˆ†é…ã€å›æ”¶\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // fixalloc æ˜¯ä¸€ä¸ªç®€å•çš„å›ºå®šå¤§å°å¯¹è±¡çš„è‡ªç”±è¡¨å†…å­˜åˆ†é…å™¨ã€‚ // Malloc ä½¿ç”¨å›´ç»• sysAlloc çš„ fixalloc æ¥ç®¡ç†å…¶ MCache å’Œ MSpan å¯¹è±¡ã€‚ // // fixalloc.alloc è¿”å›çš„å†…å­˜é»˜è®¤ä¸ºé›¶ï¼Œä½†è°ƒç”¨è€…å¯ä»¥é€šè¿‡å°† zero æ ‡å¿—è®¾ç½®ä¸º false // æ¥è‡ªè¡Œè´Ÿè´£å°†åˆ†é…å½’é›¶ã€‚å¦‚æœè¿™éƒ¨åˆ†å†…å­˜æ°¸è¿œä¸åŒ…å«å †æŒ‡é’ˆï¼Œåˆ™è¿™æ ·çš„æ“ä½œæ˜¯å®‰å…¨çš„ã€‚ // è°ƒç”¨æ–¹è´Ÿè´£é”å®š fixalloc è°ƒç”¨ã€‚è°ƒç”¨æ–¹å¯ä»¥åœ¨å¯¹è±¡ä¸­ä¿æŒçŠ¶æ€ï¼Œ // ä½†å½“é‡Šæ”¾å’Œé‡æ–°åˆ†é…æ—¶ç¬¬ä¸€ä¸ªå­—ä¼šè¢«ç ´åã€‚ // è€ƒè™‘ä½¿ fixalloc çš„ç±»å‹å˜ä¸º go:notinheap. type fixalloc struct { size uintptr first func(arg, p unsafe.Pointer) // é¦–æ¬¡è°ƒç”¨æ—¶è¿”å› p arg unsafe.Pointer list *mlink chunk uintptr // ä½¿ç”¨ uintptr è€Œé unsafe.Pointer æ¥é¿å… write barrier nchunk uint32 inuse uintptr // æ­£åœ¨ä½¿ç”¨çš„å­—èŠ‚ stat *uint64 zero bool // å½’é›¶çš„åˆ†é… } Go è¯­è¨€å¯¹äºé›¶å€¼æœ‰è‡ªå·±çš„è§„å®šï¼Œè‡ªç„¶ä¹Ÿå°±ä½“ç°åœ¨å†…å­˜åˆ†é…å™¨ä¸Šã€‚è€Œ fixalloc ä½œä¸ºå†…å­˜åˆ†é…å™¨å†…éƒ¨ç»„ä»¶çš„æ¥æºäº æ“ä½œç³»ç»Ÿçš„å†…å­˜ï¼Œè‡ªç„¶éœ€è¦è‡ªè¡Œåˆå§‹åŒ–ï¼Œå› æ­¤ï¼Œfixalloc çš„åˆå§‹åŒ–ä¹Ÿå°±ä¸å¯é¿å…çš„éœ€è¦å°†è‡ªèº«çš„å„ä¸ªå­—æ®µå½’é›¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 func (f *fixalloc) init(size uintptr, first func(arg, p unsafe.Pointer), arg unsafe.Pointer, stat *uint64) { f.size = size f.first = first f.arg = arg f.list = nil f.chunk = 0 f.nchunk = 0 f.inuse = 0 f.stat = stat f.zero = true } fixalloc åŸºäºè‡ªç”±è¡¨ç­–ç•¥è¿›è¡Œå®ç°ï¼Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\nå­˜åœ¨è¢«é‡Šæ”¾ã€å¯å¤ç”¨çš„å†…å­˜\nä¸å­˜åœ¨å¯å¤ç”¨çš„å†…å­˜\nå¯¹äºç¬¬ä¸€ç§æƒ…å†µï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œæ—¶å†…å­˜è¢«é‡Šæ”¾ï¼Œä½†è¿™éƒ¨åˆ†å†…å­˜å¹¶ä¸ä¼šè¢«ç«‹å³å›æ”¶ç»™æ“ä½œç³»ç»Ÿï¼Œ æˆ‘ä»¬ç›´æ¥ä»è‡ªç”±è¡¨ä¸­è·å¾—å³å¯ï¼Œä½†éœ€è¦æ³¨æ„æŒ‰éœ€å°†è¿™éƒ¨åˆ†å†…å­˜è¿›è¡Œæ¸…é›¶æ“ä½œã€‚\nå¯¹äºç¬¬äºŒç§æƒ…å†µï¼Œç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å›ºå®šå¤§å°çš„å†…å­˜ï¼Œç„¶åæ‰£é™¤åˆ†é…çš„å¤§å°å³å¯ã€‚ å›æ”¶é˜¶æ®µ\n1 2 3 4 5 6 7 8 func (f *fixalloc) free(p unsafe.Pointer) { // å‡å°‘ä½¿ç”¨çš„å­—èŠ‚æ•° f.inuse -= f.size // å°†è¦é‡Šæ”¾çš„å†…å­˜åœ°å€ä½œä¸º mlink æŒ‡é’ˆæ’å…¥åˆ° f.list å†…ï¼Œå®Œæˆå›æ”¶ v := (*mlink)(p) v.next = f.list f.list = v } linearAlloc æ˜¯ä¸€ä¸ªåŸºäºçº¿æ€§åˆ†é…ç­–ç•¥çš„åˆ†é…å™¨ï¼Œä½†ç”±äºå®ƒåªä½œä¸º mheap_.heapArenaAlloc å’Œ mheap_.arena åœ¨ 32 ä½ç³»ç»Ÿä¸Šä½¿ç”¨ï¼Œè¿™é‡Œä¸åšè¯¦ç»†åˆ†æã€‚\næ­¤å¤–ï¼Œå¯¹äºæ¯ä¸€ä¸ªPï¼Œéƒ½æœ‰mcacheåšç¼“å­˜ï¼Œæ¯ä¸ªçº¿ç¨‹ç‹¬ç«‹æŒæœ‰ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç°å¹¶å‘é—®é¢˜ï¼Œä¹Ÿä¸ç”¨ä¸Šé”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 //go:notinheap type mcache struct { // ä¸‹é¢çš„æˆå‘˜åœ¨æ¯æ¬¡ malloc æ—¶éƒ½ä¼šè¢«è®¿é—® // å› æ­¤å°†å®ƒä»¬æ”¾åˆ°ä¸€èµ·æ¥åˆ©ç”¨ç¼“å­˜çš„å±€éƒ¨æ€§åŸç† next_sample uintptr // åˆ†é…è¿™ä¹ˆå¤šå­—èŠ‚åè§¦å‘å †æ ·æœ¬ local_scan uintptr // åˆ†é…çš„å¯æ‰«æå †çš„å­—èŠ‚æ•° // æ²¡æœ‰æŒ‡é’ˆçš„å¾®å°å¯¹è±¡çš„åˆ†é…å™¨ç¼“å­˜ã€‚ // è¯·å‚è€ƒ malloc.go ä¸­çš„ \u0026#34;å°å‹åˆ†é…å™¨\u0026#34; æ³¨é‡Šã€‚ // // tiny æŒ‡å‘å½“å‰ tiny å—çš„èµ·å§‹ä½ç½®ï¼Œæˆ–å½“æ²¡æœ‰ tiny å—æ—¶å€™ä¸º nil // tiny æ˜¯ä¸€ä¸ªå †æŒ‡é’ˆã€‚ç”±äº mcache åœ¨é GC å†…å­˜ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡åœ¨ // mark termination æœŸé—´åœ¨ releaseAll ä¸­æ¸…é™¤å®ƒæ¥å¤„ç†å®ƒã€‚ tiny uintptr tinyoffset uintptr local_tinyallocs uintptr // ä¸è®¡å…¥å…¶ä»–ç»Ÿè®¡çš„æå°åˆ†é…çš„æ•°é‡ // ä¸‹é¢çš„ä¸åœ¨æ¯ä¸ª malloc æ—¶è¢«è®¿é—® alloc [numSpanClasses]*mspan // ç”¨æ¥åˆ†é…çš„ spansï¼Œç”± spanClass ç´¢å¼• stackcache [_NumStackOrders]stackfreelist // æœ¬åœ°åˆ†é…å™¨ç»Ÿè®¡ï¼Œåœ¨ GC æœŸé—´è¢«åˆ·æ–° local_largefree uintptr // bytes freed for large objects (\u0026gt;maxsmallsize) local_nlargefree uintptr // number of frees for large objects (\u0026gt;maxsmallsize) local_nsmallfree [_NumSizeClasses]uintptr // number of frees for small objects (\u0026lt;=maxsmallsize) // flushGen indicates the sweepgen during which this mcache // was last flushed. If flushGen != mheap_.sweepgen, the spans // in this mcache are stale and need to the flushed so they // can be swept. This is done in acquirep. flushGen uint32 } è¿è¡Œæ—¶çš„ runtime.allocmcache ä» mheap ä¸Šåˆ†é…ä¸€ä¸ª mcacheã€‚ ç”±äº mheap æ˜¯å…¨å±€çš„ï¼Œå› æ­¤åœ¨åˆ†é…æœŸå¿…é¡»å¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œè€Œåˆ†é…é€šè¿‡ fixAlloc ç»„ä»¶å®Œæˆï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // è™šæ‹Ÿçš„MSpanï¼Œä¸åŒ…å«ä»»ä½•å¯¹è±¡ã€‚ var emptymspan mspan func allocmcache() *mcache { var c *mcache systemstack(func() { lock(\u0026amp;mheap_.lock) c = (*mcache)(mheap_.cachealloc.alloc()) c.flushGen = mheap_.sweepgen unlock(\u0026amp;mheap_.lock) } for i := range c.alloc { c.alloc[i] = \u0026amp;emptymspan // æš‚æ—¶æŒ‡å‘è™šæ‹Ÿçš„ mspan ä¸­ } // è¿”å›ä¸‹ä¸€ä¸ªé‡‡æ ·ç‚¹ï¼Œæ˜¯æœä»æ³Šæ¾è¿‡ç¨‹çš„éšæœºæ•° c.next_sample = nextSample() return c } å½“éœ€è¦é‡Šæ”¾æ—¶è°ƒç”¨freemcacheå‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func freemcache(c *mcache) { systemstack(func() { // å½’è¿˜ span c.releaseAll() // é‡Šæ”¾ stack stackcache_clear(c) lock(\u0026amp;mheap_.lock) // è®°å½•å±€éƒ¨ç»Ÿè®¡ purgecachedstats(c) // å°† mcache é‡Šæ”¾ mheap_.cachealloc.free(unsafe.Pointer(c)) unlock(\u0026amp;mheap_.lock) }) } func (c *mcache) releaseAll() { for i := range c.alloc { s := c.alloc[i] if s != \u0026amp;emptymspan { // å°† span å½’è¿˜ mheap_.central[i].mcentral.uncacheSpan(s) c.alloc[i] = \u0026amp;emptymspan } } // æ¸…ç©º tinyalloc æ± . c.tiny = 0 c.tinyoffset = 0 } mcache ä¼šè¢« P æŒæœ‰ï¼Œå½“ M å’Œ P ç»‘å®šæ—¶ï¼ŒM åŒæ ·ä¼šä¿ç•™ mcache çš„æŒ‡é’ˆ mcache ç›´æ¥å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä¸”å¸¸é©»è¿è¡Œæ—¶ P é€šè¿‡ make å‘½ä»¤è¿›è¡Œåˆ†é…ï¼Œä¼šåˆ†é…åœ¨ Go å †ä¸Š 3.4. Escape Go ç¨‹åºçš„æ‰§è¡Œæ˜¯åŸºäº goroutine çš„ï¼Œgoroutine å’Œä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ç¨‹åºä¸€æ ·ï¼Œä¹Ÿæœ‰æ ˆå’Œå †çš„æ¦‚å¿µã€‚åªä¸è¿‡ Go çš„è¿è¡Œæ—¶å¸®æˆ‘ä»¬å±è”½æ‰äº†è¿™ä¸¤ä¸ªæ¦‚å¿µï¼Œåªåœ¨è¿è¡Œæ—¶å†…éƒ¨åŒºåˆ†å¹¶åˆ†åˆ«å¯¹åº”ï¼šgoroutine æ‰§è¡Œæ ˆä»¥åŠ Go å †ã€‚\ngoroutine çš„æ‰§è¡Œæ ˆä¸ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„æ ˆä¸€æ ·ï¼Œå½“å‡½æ•°è¿”å›æ—¶ï¼Œåœ¨æ ˆä¸Šå°±ä¼šè¢«å›æ”¶ï¼Œæ ˆä¸­çš„å¯¹è±¡éƒ½ä¼šè¢«å›æ”¶ï¼Œä»è€Œ æ— éœ€ GC çš„æ ‡è®°ï¼›è€Œå †åˆ™éº»çƒ¦ä¸€äº›ï¼Œç”±äº Go æ”¯æŒåƒåœ¾å›æ”¶ï¼Œåªè¦å¯¹è±¡ç”Ÿå­˜åœ¨å †ä¸Šï¼ŒGo çš„è¿è¡Œæ—¶ GC å°±ä¼šåœ¨ åå°å°†å¯¹åº”çš„å†…å­˜è¿›è¡Œæ ‡è®°ä»è€Œèƒ½å¤Ÿåœ¨åƒåœ¾å›æ”¶çš„æ—¶å€™å°†å¯¹åº”çš„å†…å­˜å›æ”¶ï¼Œè¿›è€Œå¢åŠ äº†å¼€é”€ã€‚\nä»¥ä¸‹å®šä¹‰äº†4ç§æƒ…å†µï¼Œä½¿ç”¨ -gcflags \u0026quot;-N -l -m\u0026quot;\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package main type smallobj struct { arr [1 \u0026lt;\u0026lt; 10]byte } type largeobj struct { arr [1 \u0026lt;\u0026lt; 26]byte } func f1() int { x := 1 return x // ç›´æ¥è¿”å›ï¼Œæ²¡æœ‰é€ƒé€¸ } func f2() *int { y := 2 return \u0026amp;y // å‘ç”Ÿé€ƒé€¸ } func f3() { large := largeobj{} // large æ— æ³•è¢«ä¸€ä¸ªæ‰§è¡Œæ ˆè£…ä¸‹ï¼Œä¹Ÿä¼šé€ƒé€¸ println(\u0026amp;large) } func f4() { small := smallobj{} // small å¯¹è±¡èƒ½å¤Ÿè¢«ä¸€ä¸ªæ‰§è¡Œæ ˆè£…ä¸‹ï¼Œå˜é‡æ²¡æœ‰è¿”å›åˆ°æ ˆå¤–ï¼Œè¿›è€Œæ²¡æœ‰å‘ç”Ÿé€ƒé€¸ã€‚ print(\u0026amp;small) } func main() { x := f1() y := f2() f3() f4() println(x, y) } Goè¯­è¨€ä¸­çš„å¼•ç”¨ç±»å‹æœ‰funcï¼ˆå‡½æ•°ç±»å‹ï¼‰ï¼Œinterfaceï¼ˆæ¥å£ç±»å‹ï¼‰ï¼Œsliceï¼ˆåˆ‡ç‰‡ç±»å‹ï¼‰ï¼Œmapï¼ˆå­—å…¸ç±»å‹ï¼‰ï¼Œchannelï¼ˆç®¡é“ç±»å‹ï¼‰ï¼Œ*ï¼ˆæŒ‡é’ˆç±»å‹ï¼‰ã€‚\nåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå¯ä»¥ä½¿ç”¨go tool compileå‘½ä»¤ï¼ŒæŸ¥çœ‹ï¼Œå¦‚æœæœ‰runtime.newobjectï¼Œåˆ™è¯´æ˜åœ¨å †ä¸Šï¼Œåä¹‹åˆ™åœ¨æ ˆä¸Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 // åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ func newobject(typ *_type) unsafe.Pointer { return mallocgc(typ.size, typ, true) // true å†…å­˜æ¸…é›¶ } func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer { // åˆ›å»ºå¤§å°ä¸ºé›¶çš„å¯¹è±¡ï¼Œä¾‹å¦‚ç©ºç»“æ„ä½“ if size == 0 { return unsafe.Pointer(\u0026amp;zerobase) } mp := acquirem() mp.mallocing = 1 ... // è·å–å½“å‰ g æ‰€åœ¨ M æ‰€ç»‘å®š P çš„ mcache c := gomcache() var x unsafe.Pointer noscan := typ == nil || typ.kind\u0026amp;kindNoPointers != 0 if size \u0026lt;= maxSmallSize { if noscan \u0026amp;\u0026amp; size \u0026lt; maxTinySize { // å¾®å¯¹è±¡åˆ†é… ... } else { // å°å¯¹è±¡åˆ†é… ... } } else { // å¤§å¯¹è±¡åˆ†é… ... } ... mp.mallocing = 0 releasem(mp) ... return x } å°å¯¹è±¡åˆ†é… å½“å¯¹ä¸€ä¸ªå°å¯¹è±¡ï¼ˆ\u0026lt;32KBï¼‰åˆ†é…å†…å­˜æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡æ‰€éœ€çš„å†…å­˜å¤§å°è°ƒæ•´åˆ°æŸä¸ªèƒ½å¤Ÿå®¹çº³è¯¥å¯¹è±¡çš„å¤§å°ç­‰çº§ï¼ˆsize classï¼‰ï¼Œ å¹¶æŸ¥çœ‹ mcache ä¸­å¯¹åº”ç­‰çº§çš„ mspanï¼Œé€šè¿‡æ‰«æ mspan çš„ freeindex æ¥ç¡®å®šæ˜¯å¦èƒ½å¤Ÿè¿›è¡Œåˆ†é…ã€‚\nå½“æ²¡æœ‰å¯åˆ†é…çš„ mspan æ—¶ï¼Œä¼šä» mcentral ä¸­è·å–ä¸€ä¸ªæ‰€éœ€å¤§å°ç©ºé—´çš„æ–°çš„ mspanï¼Œä» mcentral ä¸­åˆ†é…ä¼šå¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œ ä½†ä¸€æ¬¡æ€§è·å–æ•´ä¸ª span çš„è¿‡ç¨‹å‡æ‘Šäº†å¯¹ mcentral åŠ é”çš„æˆæœ¬ã€‚\nå¦‚æœ mcentral çš„ mspan ä¹Ÿä¸ºç©ºæ—¶ï¼Œåˆ™å®ƒä¹Ÿä¼šå‘ç”Ÿå¢é•¿ï¼Œä»è€Œä» mheap ä¸­è·å–ä¸€è¿ä¸²çš„é¡µï¼Œä½œä¸ºä¸€ä¸ªæ–°çš„ mspan è¿›è¡Œæä¾›ã€‚ è€Œå¦‚æœ mheap ä»ç„¶ä¸ºç©ºï¼Œæˆ–è€…æ²¡æœ‰è¶³å¤Ÿå¤§çš„å¯¹è±¡æ¥è¿›è¡Œåˆ†é…æ—¶ï¼Œåˆ™ä¼šä»æ“ä½œç³»ç»Ÿä¸­åˆ†é…ä¸€ç»„æ–°çš„é¡µï¼ˆè‡³å°‘ 1MBï¼‰ï¼Œ ä»è€Œå‡æ‘Šä¸æ“ä½œç³»ç»Ÿæ²Ÿé€šçš„æˆæœ¬ã€‚\nå¾®å¯¹è±¡åˆ†é… å¯¹äºè¿‡å°çš„å¾®å¯¹è±¡ï¼ˆ\u0026lt;16Bï¼‰ï¼Œå®ƒä»¬çš„åˆ†é…è¿‡ç¨‹ä¸å°å¯¹è±¡çš„åˆ†é…è¿‡ç¨‹åŸºæœ¬ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯ç›´æ¥å­˜å‚¨åœ¨ mcache ä¸Šï¼Œå¹¶ç”±å…¶ä»¥ 16B çš„å—å¤§å°ç›´æ¥è¿›è¡Œç®¡ç†å’Œé‡Šæ”¾ã€‚\nå¤§å¯¹è±¡åˆ†é… å¤§å¯¹è±¡åˆ†é…éå¸¸ç²—æš´ï¼Œä¸ä¸ mcache å’Œ mcentral æ²Ÿé€šï¼Œç›´æ¥ç»•è¿‡å¹¶é€šè¿‡ mheap è¿›è¡Œåˆ†é…ã€‚\n4. Garbage Collection æ¸…ç†ç»ˆæ­¢é˜¶æ®µï¼› æš‚åœç¨‹åºï¼Œæ‰€æœ‰çš„å¤„ç†å™¨åœ¨è¿™æ—¶ä¼šè¿›å…¥å®‰å…¨ç‚¹ï¼ˆSafe pointï¼‰ï¼› å¦‚æœå½“å‰åƒåœ¾æ”¶é›†å¾ªç¯æ˜¯å¼ºåˆ¶è§¦å‘çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å¤„ç†è¿˜æœªè¢«æ¸…ç†çš„å†…å­˜ç®¡ç†å•å…ƒï¼› æ ‡è®°é˜¶æ®µï¼› å°†çŠ¶æ€åˆ‡æ¢è‡³ _GCmarkã€å¼€å¯å†™å±éšœã€ç”¨æˆ·ç¨‹åºååŠ©ï¼ˆMutator Assistsï¼‰å¹¶å°†æ ¹å¯¹è±¡å…¥é˜Ÿï¼› æ¢å¤æ‰§è¡Œç¨‹åºï¼Œæ ‡è®°è¿›ç¨‹å’Œç”¨äºååŠ©çš„ç”¨æˆ·ç¨‹åºä¼šå¼€å§‹å¹¶å‘æ ‡è®°å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œå†™å±éšœä¼šå°†è¢«è¦†ç›–çš„æŒ‡é’ˆå’Œæ–°æŒ‡é’ˆéƒ½æ ‡è®°æˆç°è‰²ï¼Œè€Œæ‰€æœ‰æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šè¢«ç›´æ¥æ ‡è®°æˆé»‘è‰²ï¼› å¼€å§‹æ‰«ææ ¹å¯¹è±¡ï¼ŒåŒ…æ‹¬æ‰€æœ‰ Goroutine çš„æ ˆã€å…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­çš„è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼Œæ‰«æ Goroutine æ ˆæœŸé—´ä¼šæš‚åœå½“å‰å¤„ç†å™¨ï¼› ä¾æ¬¡å¤„ç†ç°è‰²é˜Ÿåˆ—ä¸­çš„å¯¹è±¡ï¼Œå°†å¯¹è±¡æ ‡è®°æˆé»‘è‰²å¹¶å°†å®ƒä»¬æŒ‡å‘çš„å¯¹è±¡æ ‡è®°æˆç°è‰²ï¼› ä½¿ç”¨åˆ†å¸ƒå¼çš„ç»ˆæ­¢ç®—æ³•æ£€æŸ¥å‰©ä½™çš„å·¥ä½œï¼Œå‘ç°æ ‡è®°é˜¶æ®µå®Œæˆåè¿›å…¥æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼› æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼› æš‚åœç¨‹åºã€å°†çŠ¶æ€åˆ‡æ¢è‡³ _GCmarktermination ï¼Œç¡®è®¤æ ‡è®°å·¥ä½œå·²ç»å®Œæˆï¼Œå¹¶å…³é—­è¾…åŠ©æ ‡è®°çš„ç”¨æˆ·ç¨‹åºï¼› æ¸…ç†å¤„ç†å™¨ä¸Šçš„çº¿ç¨‹ç¼“å­˜ï¼› æ¸…ç†é˜¶æ®µï¼› å°†çŠ¶æ€åˆ‡æ¢è‡³ _GCoff å¼€å§‹æ¸…ç†é˜¶æ®µï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œæ–°å»ºçš„å¯¹è±¡æ˜¯é»‘è‰²ï¼Œåˆ‡æ¢åçš„å¯¹è±¡æ˜¯ç™½è‰²ï¼Œåˆå§‹åŒ–æ¸…ç†çŠ¶æ€å¹¶å…³é—­å†™å±éšœï¼› åå°å¹¶å‘æ¸…ç†æ‰€æœ‰çš„å†…å­˜ç®¡ç†å•å…ƒï¼Œå½“ Goroutine ç”³è¯·æ–°çš„å†…å­˜ç®¡ç†å•å…ƒæ—¶å°±ä¼šè§¦å‘æ¸…ç†ï¼› ","date":"2021-09-28T19:31:04+08:00","image":"https://chasing1020.github.io/post/go4-runtime/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go4-runtime/","title":"Go(4) Runtime"},{"content":"Part3. Common Keyword 1. For And Range å¯¹äºæ‰€æœ‰çš„ range å¾ªç¯ï¼ŒGo è¯­è¨€éƒ½ä¼šåœ¨ç¼–è¯‘æœŸå°†åŸåˆ‡ç‰‡æˆ–è€…æ•°ç»„èµ‹å€¼ç»™ä¸€ä¸ªæ–°å˜é‡ haï¼Œåœ¨èµ‹å€¼çš„è¿‡ç¨‹ä¸­å°±å‘ç”Ÿäº†æ‹·è´ï¼Œè€Œæˆ‘ä»¬åˆé€šè¿‡ len å…³é”®å­—é¢„å…ˆè·å–äº†åˆ‡ç‰‡çš„é•¿åº¦ï¼Œæ‰€ä»¥åœ¨å¾ªç¯ä¸­è¿½åŠ æ–°çš„å…ƒç´ ä¹Ÿä¸ä¼šæ”¹å˜å¾ªç¯æ‰§è¡Œçš„æ¬¡æ•°ï¼Œè¿™ä¹Ÿå°±è§£é‡Šäº†å¾ªç¯æ°¸åŠ¨æœºä¸€èŠ‚æåˆ°çš„ç°è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 func main() { arr := []int{1, 2, 3} newArr := []*int{} for i, _ := range arr { newArr = append(newArr, \u0026amp;arr[i]) } for _, v := range newArr { fmt.Println(*v) } } è€Œé‡åˆ°è¿™ç§åŒæ—¶éå†ç´¢å¼•å’Œå…ƒç´ çš„ range å¾ªç¯æ—¶ï¼ŒGo è¯­è¨€ä¼šé¢å¤–åˆ›å»ºä¸€ä¸ªæ–°çš„ v2 å˜é‡å­˜å‚¨åˆ‡ç‰‡ä¸­çš„å…ƒç´ ï¼Œå¾ªç¯ä¸­ä½¿ç”¨çš„è¿™ä¸ªå˜é‡ v2 ä¼šåœ¨æ¯ä¸€æ¬¡è¿­ä»£è¢«é‡æ–°èµ‹å€¼è€Œè¦†ç›–ï¼Œèµ‹å€¼æ—¶ä¹Ÿä¼šè§¦å‘æ‹·è´ã€‚\nåœ¨éå†å“ˆå¸Œè¡¨æ—¶ï¼Œä¼šå‘ç”Ÿå¦‚ä¸‹æ“ä½œï¼š\n1 2 3 4 5 6 7 8 ha := a hit := hiter(n.Type) th := hit.Type mapiterinit(typename(t), ha, \u0026amp;hit) for ; hit.key != nil; mapiternext(\u0026amp;hit) { key := *hit.key val := *hit.val } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 func mapiternext(it *hiter) { h := it.h t := it.t bucket := it.bucket b := it.bptr i := it.i alg := t.key.alg next: if b == nil { if bucket == it.startBucket \u0026amp;\u0026amp; it.wrapped { it.key = nil it.value = nil return } b = (*bmap)(add(it.buckets, bucket*uintptr(t.bucketsize))) bucket++ if bucket == bucketShift(it.B) { bucket = 0 it.wrapped = true } i = 0 } å­—ç¬¦ä¸²éå†ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºRuneç±»å‹\n1 2 3 4 5 6 7 8 9 10 11 ha := s for hv1 := 0; hv1 \u0026lt; len(ha); { hv1t := hv1 hv2 := rune(ha[hv1]) if hv2 \u0026lt; utf8.RuneSelf { hv1++ } else { hv2, hv1 = decoderune(ha, hv1) } v1, v2 = hv1t, hv2 } 2. Defer 2.1. Implement 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 // A _defer holds an entry on the list of deferred calls. // If you add a field here, add code to clear it in freedefer and deferProcStack // This struct must match the code in cmd/compile/internal/gc/reflect.go:deferstruct // and cmd/compile/internal/gc/ssa.go:(*state).call. // Some defers will be allocated on the stack and some on the heap. // All defers are logically part of the stack, so write barriers to // initialize them are not required. All defers must be manually scanned, // and for heap defers, marked. type _defer struct { siz int32 // includes both arguments and results å‚æ•°å’Œè¿”å›å€¼å…±å å¤šå°‘ç©ºé—´ started bool heap bool // openDefer indicates that this _defer is for a frame with open-coded // defers. We have only one defer record for the entire frame (which may // currently have 0, 1, or more defers active). openDefer bool // è¡¨ç¤ºå½“å‰ defer æ˜¯å¦ç»è¿‡å¼€æ”¾ç¼–ç çš„ä¼˜åŒ–ï¼› sp uintptr // sp at time of defer æ ˆæŒ‡é’ˆ pc uintptr // pc at time of defer è°ƒç”¨æ–¹çš„ç¨‹åºè®¡æ•°å™¨ï¼› fn *funcval // can be nil for open-coded defers å…³é”®å­—ä¸­ä¼ å…¥çš„å‡½æ•° _panic *_panic // panic that is running defer æ˜¯è§¦å‘å»¶è¿Ÿè°ƒç”¨çš„ç»“æ„ä½“ï¼Œå¯èƒ½ä¸ºç©ºï¼› link *_defer // If openDefer is true, the fields below record values about the stack // frame and associated function that has the open-coded defer(s). sp // above will be the sp for the frame, and pc will be address of the // deferreturn call in the function. fd unsafe.Pointer // funcdata for the function associated with the frame varp uintptr // value of varp for the stack frame // framepc is the current pc associated with the stack frame. Together, // with sp above (which is the sp associated with the stack frame), // framepc/sp can be used as pc/sp pair to continue a stack trace via // gentraceback(). framepc uintptr } A deferred functionâ€™s arguments are evaluated when the defer statement is evaluated. Deferred function calls are executed in Last In First Out order after the surrounding function returns. Deferred functions may read and assign to the returning functionâ€™s named return values. Go è¯­è¨€åœ¨ 1.13 ä¸­å¼•å…¥æ ˆä¸Šåˆ†é…çš„ç»“æ„ä½“ï¼Œå‡å°‘äº† 30% çš„é¢å¤–å¼€é”€1ï¼Œå¹¶åœ¨ 1.14 ä¸­å¼•å…¥äº†åŸºäºå¼€æ”¾ç¼–ç çš„ deferï¼Œä½¿å¾—è¯¥å…³é”®å­—çš„é¢å¤–å¼€é”€å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚\n2.2. Execve 2.2.1. In Heap 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func (s *state) stmt(n *Node) { ... switch n.Op { case ODEFER: if s.hasOpenDefers { s.openDeferRecord(n.Left) // å¼€æ”¾ç¼–ç  } else { d := callDefer // å †åˆ†é… if n.Esc == EscNever { d = callDeferStack // æ ˆåˆ†é… } s.callResult(n.Left, d) } } } 1.12ç‰ˆæœ¬å‰çš„deferè°ƒç”¨å‡½æ•°ï¼Œå‡½æ•°éœ€è¦ï¼š\nè·å–éœ€è¦æ‰§è¡Œçš„å‡½æ•°åã€é—­åŒ…æŒ‡é’ˆã€ä»£ç æŒ‡é’ˆå’Œå‡½æ•°è°ƒç”¨çš„æ¥æ”¶æ–¹ï¼› è·å–æ ˆåœ°å€å¹¶å°†å‡½æ•°æˆ–è€…æ–¹æ³•çš„å‚æ•°å†™å…¥æ ˆä¸­ï¼› ä½¿ç”¨ cmd/compile/internal/gc.state.newValue1A ä»¥åŠç›¸å…³å‡½æ•°ç”Ÿæˆå‡½æ•°è°ƒç”¨çš„ä¸­é—´ä»£ç ï¼› å¦‚æœå½“å‰è°ƒç”¨çš„å‡½æ•°æ˜¯ deferï¼Œé‚£ä¹ˆä¼šå•ç‹¬ç”Ÿæˆç›¸å…³çš„ç»“æŸä»£ç å—ï¼› è·å–å‡½æ•°çš„è¿”å›å€¼åœ°å€å¹¶ç»“æŸå½“å‰è°ƒç”¨ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func (s *state) call(n *Node, k callKind, returnResultAddr bool) *ssa.Value { ... var call *ssa.Value if k == callDeferStack { // åœ¨æ ˆä¸Šåˆå§‹åŒ– defer ç»“æ„ä½“ ... } else { ... switch { case k == callDefer: aux := ssa.StaticAuxCall(deferproc, ACArgs, ACResults) call = s.newValue1A(ssa.OpStaticCall, types.TypeMem, aux, s.mem()) ... } call.AuxInt = stksize } s.vars[\u0026amp;memVar] = call ... } åˆ›å»ºå»¶è¿Ÿè°ƒç”¨ï¼Œå°†defer A() è½¬æ¢æˆ defproc(8, A)ï¼Œæ•´å½¢å‚æ•°åœ¨64ä½ä¸‹å ç”¨8å­—èŠ‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 func deferproc(siz int32, fn *funcval) { sp := getcallersp() argp := uintptr(unsafe.Pointer(\u0026amp;fn)) + unsafe.Sizeof(fn) callerpc := getcallerpc() d := newdefer(siz) if d._panic != nil { throw(\u0026#34;deferproc: d.panic != nil after newdefer\u0026#34;) } d.fn = fn d.pc = callerpc d.sp = sp switch siz { case 0: case sys.PtrSize: *(*uintptr)(deferArgs(d)) = *(*uintptr)(unsafe.Pointer(argp)) default: memmove(deferArgs(d), unsafe.Pointer(argp), uintptr(siz)) } return0() } ä»è°ƒåº¦å™¨çš„å»¶è¿Ÿè°ƒç”¨ç¼“å­˜æ±  sched.deferpool ä¸­å–å‡ºç»“æ„ä½“å¹¶å°†è¯¥ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine çš„ç¼“å­˜æ± ä¸­ï¼› ä» Goroutine çš„å»¶è¿Ÿè°ƒç”¨ç¼“å­˜æ±  pp.deferpool ä¸­å–å‡ºç»“æ„ä½“ï¼› é€šè¿‡ runtime.mallocgc åœ¨å †ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ç»“æ„ä½“ï¼›\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 func newdefer(siz int32) *_defer { var d *_defer sc := deferclass(uintptr(siz)) gp := getg() if sc \u0026lt; uintptr(len(p{}.deferpool)) { pp := gp.m.p.ptr() if len(pp.deferpool[sc]) == 0 \u0026amp;\u0026amp; sched.deferpool[sc] != nil { for len(pp.deferpool[sc]) \u0026lt; cap(pp.deferpool[sc])/2 \u0026amp;\u0026amp; sched.deferpool[sc] != nil { d := sched.deferpool[sc] sched.deferpool[sc] = d.link pp.deferpool[sc] = append(pp.deferpool[sc], d) } } if n := len(pp.deferpool[sc]); n \u0026gt; 0 { d = pp.deferpool[sc][n-1] pp.deferpool[sc][n-1] = nil pp.deferpool[sc] = pp.deferpool[sc][:n-1] } } if d == nil { total := roundupsize(totaldefersize(uintptr(siz))) d = (*_defer)(mallocgc(total, deferType, true)) } d.siz = siz d.link = gp._defer gp._defer = d return d } åœ¨å‡½æ•°ç»“æŸå‰ï¼Œè½¬ä¸ºruntime.deferreturn()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func deferreturn(arg0 uintptr) { gp := getg() d := gp._defer if d == nil { return } sp := getcallersp() ... switch d.siz { case 0: case sys.PtrSize: *(*uintptr)(unsafe.Pointer(\u0026amp;arg0)) = *(*uintptr)(deferArgs(d)) default: memmove(unsafe.Pointer(\u0026amp;arg0), deferArgs(d), uintptr(d.siz)) } fn := d.fn gp._defer = d.link freedefer(d) jmpdefer(fn, uintptr(unsafe.Pointer(\u0026amp;arg0))) } 2.2.2. Stack 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 func deferprocStack(d *_defer) { gp := getg() d.started = false d.heap = false // æ ˆä¸Šåˆ†é…çš„ _defer d.openDefer = false d.sp = getcallersp() d.pc = getcallerpc() d.framepc = 0 d.varp = 0 *(*uintptr)(unsafe.Pointer(\u0026amp;d._panic)) = 0 *(*uintptr)(unsafe.Pointer(\u0026amp;d.fd)) = 0 *(*uintptr)(unsafe.Pointer(\u0026amp;d.link)) = uintptr(unsafe.Pointer(gp._defer)) *(*uintptr)(unsafe.Pointer(\u0026amp;gp._defer)) = uintptr(unsafe.Pointer(d)) return0() } ä¸å †åŒºç±»ä¼¼ï¼Œè¯¥æ–¹æ³•æ²¡æœ‰æœ¬è´¨ä¸Šçš„ä¸åŒï¼Œå¯ä»¥é€‚ç”¨äºæ›´å¤šåœºæ™¯ã€‚\nä½†æ˜¯åœ¨å¾ªç¯ä¸­æ³¨å†Œçš„deferï¼Œè¿˜æ˜¯éœ€è¦1.12çš„æ–¹å¼ï¼Œåœ¨å †ä¸­åˆ†é…ï¼Œæ‰€ä»¥åœ¨deferç»“æ„ä½“ä¸­æ–°å¢äº†å­—æ®µ\n1 heap bool 2.2.3. Open Coded Go è¯­è¨€åœ¨ 1.14 ä¸­é€šè¿‡å¼€æ”¾ç¼–ç ï¼ˆOpen Codedï¼‰å®ç° defer å…³é”®å­—ï¼Œè¯¥è®¾è®¡ä½¿ç”¨ä»£ç å†…è”ä¼˜åŒ– defer å…³é”®çš„é¢å¤–å¼€é”€å¹¶å¼•å…¥å‡½æ•°æ•°æ® funcdata ç®¡ç† panic çš„è°ƒç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 const maxOpenDefers = 8 func walkstmt(n *Node) *Node { switch n.Op { case ODEFER: Curfn.Func.SetHasDefer(true) Curfn.Func.numDefers++ if Curfn.Func.numDefers \u0026gt; maxOpenDefers { Curfn.Func.SetOpenCodedDeferDisallowed(true) } if n.Esc != EscNever { Curfn.Func.SetOpenCodedDeferDisallowed(true) } fallthrough ... } } å‡½æ•°çš„ defer æ•°é‡å°‘äºæˆ–è€…ç­‰äº 8 ä¸ªï¼› å‡½æ•°çš„ defer å…³é”®å­—ä¸èƒ½åœ¨å¾ªç¯ä¸­æ‰§è¡Œï¼› å‡½æ•°çš„ return è¯­å¥ä¸ defer è¯­å¥çš„ä¹˜ç§¯å°äºæˆ–è€…ç­‰äº 15 ä¸ªï¼› 1.14ä¸­ï¼Œä½¿ç”¨dfæ¥æ ‡è®°æ¯ä¸€ä¸ªdeferæ˜¯å¦éœ€è¦æ‰§è¡Œï¼Œå°†æ¯ä¸€ä¸ªdeferæ”¾åœ¨å‡½æ•°è¿”å›å¤„ï¼Œé€šè¿‡ç¼–è¯‘é˜¶æ®µæ’å…¥ä»£ç ï¼ŒæŠŠdeferå‡½æ•°çš„é€»è¾‘å±•å¼€åœ¨æ‰€å±çš„å‡½æ•°å†…ï¼Œä»è€Œçœç•¥äº†deferç»“æ„ä½“å’Œé“¾è¡¨ã€‚\nä½†æ˜¯ï¼Œåœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æœè°ƒç”¨äº†panicï¼Œæˆ–è€…æ˜¯runtime.Goexit()å‡½æ•°ï¼Œéœ€è¦é¢å¤–ä½¿ç”¨æ ˆæ‰«ææ–¹æ³•æ¥å®ç°ã€‚\næ‰€ä»¥åœ¨1.14ç‰ˆæœ¬ä¸­ï¼Œæ–°å¢äº†å¦‚ä¸‹å‚æ•°ï¼Œä¿è¯æ ˆæ‰«æèƒ½å¤Ÿæ­£ç¡®æ‰§è¡Œã€‚åœ¨å‘ç”Ÿpanicçš„æƒ…å†µä¸‹ï¼Œæ•ˆç‡è¦ä½äº1.13ç‰ˆæœ¬\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // openDefer indicates that this _defer is for a frame with open-coded // defers. We have only one defer record for the entire frame (which may // currently have 0, 1, or more defers active). openDefer bool // è¡¨ç¤ºå½“å‰ defer æ˜¯å¦ç»è¿‡å¼€æ”¾ç¼–ç çš„ä¼˜åŒ–ï¼› // If openDefer is true, the fields below record values about the stack // frame and associated function that has the open-coded defer(s). sp // above will be the sp for the frame, and pc will be address of the // deferreturn call in the function. fd unsafe.Pointer // funcdata for the function associated with the frame varp uintptr // value of varp for the stack frame // framepc is the current pc associated with the stack frame. Together, // with sp above (which is the sp associated with the stack frame), // framepc/sp can be used as pc/sp pair to continue a stack trace via // gentraceback(). framepc uintptr 2.3. Version Difference å †ä¸Šåˆ†é… Â· 1.1 ~ 1.12 ç¼–è¯‘æœŸå°† defer å…³é”®å­—è½¬æ¢æˆ runtime.deferproc å¹¶åœ¨è°ƒç”¨ defer å…³é”®å­—çš„å‡½æ•°è¿”å›ä¹‹å‰æ’å…¥ runtime.deferreturnï¼› è¿è¡Œæ—¶è°ƒç”¨ runtime.deferproc ä¼šå°†ä¸€ä¸ªæ–°çš„ runtime._defer ç»“æ„ä½“è¿½åŠ åˆ°å½“å‰ Goroutine çš„é“¾è¡¨å¤´ï¼› è¿è¡Œæ—¶è°ƒç”¨ runtime.deferreturn ä¼šä» Goroutine çš„é“¾è¡¨ä¸­å–å‡º runtime._defer ç»“æ„å¹¶ä¾æ¬¡æ‰§è¡Œï¼› æ ˆä¸Šåˆ†é… Â· 1.13 å½“è¯¥å…³é”®å­—åœ¨å‡½æ•°ä½“ä¸­æœ€å¤šæ‰§è¡Œä¸€æ¬¡æ—¶ï¼Œç¼–è¯‘æœŸé—´çš„ cmd/compile/internal/gc.state.call ä¼šå°†ç»“æ„ä½“åˆ†é…åˆ°æ ˆä¸Šå¹¶è°ƒç”¨ runtime.deferprocStackï¼› å¼€æ”¾ç¼–ç  Â· 1.14 ~ ç°åœ¨ ç¼–è¯‘æœŸé—´åˆ¤æ–­ defer å…³é”®å­—ã€return è¯­å¥çš„ä¸ªæ•°ç¡®å®šæ˜¯å¦å¼€å¯å¼€æ”¾ç¼–ç ä¼˜åŒ–ï¼› é€šè¿‡ deferBits å’Œ cmd/compile/internal/gc.openDeferInfo å­˜å‚¨ defer å…³é”®å­—çš„ç›¸å…³ä¿¡æ¯ï¼› å¦‚æœ defer å…³é”®å­—çš„æ‰§è¡Œå¯ä»¥åœ¨ç¼–è¯‘æœŸé—´ç¡®å®šï¼Œä¼šåœ¨å‡½æ•°è¿”å›å‰ç›´æ¥æ’å…¥ç›¸åº”çš„ä»£ç ï¼Œå¦åˆ™ä¼šç”±è¿è¡Œæ—¶çš„ runtime.deferreturn å¤„ç†ï¼› 3. Panic And Recover 3.1. Panic Implement 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // A _panic holds information about an active panic. // // A _panic value must only ever live on the stack. // // The argp and link fields are stack pointers, but don\u0026#39;t need special // handling during stack growth: because they are pointer-typed and // _panic values only live on the stack, regular stack pointer // adjustment takes care of them. type _panic struct { argp unsafe.Pointer // pointer to arguments of deferred call run during panic; cannot move - known to liblink deferçš„å‚æ•°ç©ºé—´åœ°å€ arg interface{} // argument to panic link *_panic // link to earlier panic pc uintptr // where to return to in runtime if this panic is bypassed sp unsafe.Pointer // where to return to in runtime if this panic is bypassed recovered bool // whether this panic is over æ˜¯å¦è¢«æ¢å¤ aborted bool // the panic was aborted æ˜¯å¦ç»ˆæ­¢ goexit bool } åœ¨panicæ‰§è¡Œæ—¶ï¼Œä¼šæŠŠ_deferçš„panicç½®ä½trueï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸ç»“æŸï¼Œ\nç„¶åæ‰§è¡Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func gopanic(e interface{}) { gp := getg() ... var p _panic p.arg = e p.link = gp._panic gp._panic = (*_panic)(noescape(unsafe.Pointer(\u0026amp;p))) for { d := gp._defer if d == nil { break } d._panic = (*_panic)(noescape(unsafe.Pointer(\u0026amp;p))) reflectcall(nil, unsafe.Pointer(d.fn), deferArgs(d), uint32(d.siz), uint32(d.siz)) d._panic = nil d.fn = nil gp._defer = d.link freedefer(d) if p.recovered { ... } } fatalpanic(gp._panic) *(*int)(nil) = 0 } å¯¹äºæ— æ³•ä¿®å¤çš„å´©æºƒï¼Œä¼šè°ƒç”¨å¦‚ä¸‹ä»£ç æ‰“å°æ‰€æœ‰panicä¿¡æ¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func fatalpanic(msgs *_panic) { pc := getcallerpc() sp := getcallersp() gp := getg() if startpanic_m() \u0026amp;\u0026amp; msgs != nil { atomic.Xadd(\u0026amp;runningPanicDefers, -1) printpanics(msgs) } if dopanic_m(gp, pc, sp) { crash() } exit(2) } 3.2. Recover Implement 1 2 3 4 5 6 7 8 9 func gorecover(argp uintptr) interface{} { gp := getg() p := gp._panic if p != nil \u0026amp;\u0026amp; !p.recovered \u0026amp;\u0026amp; argp == uintptr(p.argp) { p.recovered = true return p.arg } return nil } recoverå°†å½“å‰panicçš„recoveredç­‰äºtrueï¼Œç„¶åç§»é™¤å¹¶ä¸”è·³å‡ºå½“å‰çš„panic\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func gopanic(e interface{}) { ... for { // æ‰§è¡Œå»¶è¿Ÿè°ƒç”¨å‡½æ•°ï¼Œå¯èƒ½ä¼šè®¾ç½® p.recovered = true ... pc := d.pc sp := unsafe.Pointer(d.sp) ... if p.recovered { // å½“æ ‡è®°ä¸ºä¸ºtrueæ—¶ï¼Œ gp._panic = p.link for gp._panic != nil \u0026amp;\u0026amp; gp._panic.aborted { gp._panic = gp._panic.link } if gp._panic == nil { gp.sig = 0 } gp.sigcode0 = uintptr(sp) gp.sigcode1 = pc mcall(recovery) throw(\u0026#34;recovery failed\u0026#34;) } } ... } ç¼–è¯‘å™¨ä¼šè´Ÿè´£åšè½¬æ¢å…³é”®å­—çš„å·¥ä½œï¼› 1.1. å°† panic å’Œ recover åˆ†åˆ«è½¬æ¢æˆ runtime.gopanic å’Œ runtime.gorecoverï¼› 1.2. å°† defer è½¬æ¢æˆ runtime.deferproc å‡½æ•°ï¼› 1.3. åœ¨è°ƒç”¨ defer çš„å‡½æ•°æœ«å°¾è°ƒç”¨ runtime.deferreturn å‡½æ•°ï¼› åœ¨è¿è¡Œè¿‡ç¨‹ä¸­é‡åˆ° runtime.gopanic æ–¹æ³•æ—¶ï¼Œä¼šä» Goroutine çš„é“¾è¡¨ä¾æ¬¡å–å‡º runtime._defer ç»“æ„ä½“å¹¶æ‰§è¡Œï¼› å¦‚æœè°ƒç”¨å»¶è¿Ÿæ‰§è¡Œå‡½æ•°æ—¶é‡åˆ°äº† runtime.gorecover å°±ä¼šå°† _panic.recovered æ ‡è®°æˆ true å¹¶è¿”å› panic çš„å‚æ•°ï¼› 3.1. åœ¨è¿™æ¬¡è°ƒç”¨ç»“æŸä¹‹åï¼Œruntime.gopanic ä¼šä» runtime._defer ç»“æ„ä½“ä¸­å–å‡ºç¨‹åºè®¡æ•°å™¨ pc å’Œæ ˆæŒ‡é’ˆ sp å¹¶è°ƒç”¨ runtime.recovery å‡½æ•°è¿›è¡Œæ¢å¤ç¨‹åºï¼› 3.2. runtime.recovery ä¼šæ ¹æ®ä¼ å…¥çš„ pc å’Œ sp è·³è½¬å› runtime.deferprocï¼› 3.3. ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç ä¼šå‘ç° runtime.deferproc çš„è¿”å›å€¼ä¸ä¸º 0ï¼Œè¿™æ—¶ä¼šè·³å› runtime.deferreturn å¹¶æ¢å¤åˆ°æ­£å¸¸çš„æ‰§è¡Œæµç¨‹ï¼› å¦‚æœæ²¡æœ‰é‡åˆ° runtime.gorecover å°±ä¼šä¾æ¬¡éå†æ‰€æœ‰çš„ runtime._deferï¼Œå¹¶åœ¨æœ€åè°ƒç”¨ runtime.fatalpanic ä¸­æ­¢ç¨‹åºã€æ‰“å° panic çš„å‚æ•°å¹¶è¿”å›é”™è¯¯ç  2ï¼ˆéœ€è¦ç¼–è¯‘ï¼‰ï¼› å¦‚åœ¨Goçš„compile.Mainæ‰§è¡ŒæœŸé—´ï¼ŒåŠ å…¥äº†defer hidePanic()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func hidePanic() { if base.Debug.Panic == 0 \u0026amp;\u0026amp; base.Errors() \u0026gt; 0 { // If we\u0026#39;ve already complained about things // in the program, don\u0026#39;t bother complaining // about a panic too; let the user clean up // the code and try again. if err := recover(); err != nil { if err == \u0026#34;-h\u0026#34; { panic(err) } base.ErrorExit() } } } 4. Make And New make çš„ä½œç”¨æ˜¯åˆå§‹åŒ–å†…ç½®çš„æ•°æ®ç»“æ„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å‰é¢æåˆ°çš„åˆ‡ç‰‡ã€å“ˆå¸Œè¡¨å’Œ Channelï¼› new çš„ä½œç”¨æ˜¯æ ¹æ®ä¼ å…¥çš„ç±»å‹åˆ†é…ä¸€ç‰‡å†…å­˜ç©ºé—´å¹¶è¿”å›æŒ‡å‘è¿™ç‰‡å†…å­˜ç©ºé—´çš„æŒ‡é’ˆï¼› Go è¯­è¨€ä¼šå°†ä»£è¡¨ make å…³é”®å­—çš„ OMAKE èŠ‚ç‚¹æ ¹æ®å‚æ•°ç±»å‹çš„ä¸åŒè½¬æ¢æˆäº† OMAKESLICEã€OMAKEMAP å’Œ OMAKECHAN ä¸‰ç§ä¸åŒç±»å‹çš„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¼šè°ƒç”¨ä¸åŒçš„è¿è¡Œæ—¶å‡½æ•°æ¥åˆå§‹åŒ–ç›¸åº”çš„æ•°æ®ç»“æ„ã€‚\nåˆ†åˆ«å¯¹åº”å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 type SliceHeader struct { Data uintptr Len int Cap int } type hmap struct { // Note: the format of the hmap is also encoded in cmd/compile/internal/gc/reflect.go. // Make sure this stays in sync with the compiler\u0026#39;s definition. count int // # live cells == size of map. Must be first (used by len() builtin) flags uint8 B uint8 // log_2 of # of buckets (can hold up to loadFactor * 2^B items) noverflow uint16 // approximate number of overflow buckets; see incrnoverflow for details hash0 uint32 // hash seed buckets unsafe.Pointer // array of 2^B Buckets. may be nil if count==0. oldbuckets unsafe.Pointer // previous bucket array of half the size, non-nil only when growing nevacuate uintptr // progress counter for evacuation (buckets less than this have been evacuated) extra *mapextra // optional fields } type hchan struct { qcount uint // total data in the queue dataqsiz uint // size of the circular queue buf unsafe.Pointer // points to an array of dataqsiz elements elemsize uint16 closed uint32 elemtype *_type // element type sendx uint // send index recvx uint // receive index recvq waitq // list of recv waiters sendq waitq // list of send waiters // lock protects all fields in hchan, as well as several // fields in sudogs blocked on this channel. // // Do not change another G\u0026#39;s status while holding this lock // (in particular, do not ready a G), as this can deadlock // with stack shrinking. lock mutex } åœ¨è°ƒç”¨newæ—¶ï¼Œåˆ™ä¼šåˆ†ä¸ºä»¥ä¸‹æ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func callnew(t *types.Type) *Node { ... n := nod(ONEWOBJ, typename(t), nil) ... return n } func (s *state) expr(n *Node) *ssa.Value { switch n.Op { case ONEWOBJ: if n.Type.Elem().Size() == 0 { return s.newValue1A(ssa.OpAddr, n.Type, zerobaseSym, s.sb) } typ := s.expr(n.Left) vv := s.rtcall(newobject, true, []*types.Type{n.Type}, typ) return vv[0] } } éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ˜¯ç›´æ¥ä½¿ç”¨ newï¼Œè¿˜æ˜¯ä½¿ç”¨ var åˆå§‹åŒ–å˜é‡ï¼Œå®ƒä»¬åœ¨ç¼–è¯‘å™¨çœ‹æ¥éƒ½æ˜¯ ONEW å’Œ ODCL èŠ‚ç‚¹ã€‚å¦‚æœå˜é‡ä¼šé€ƒé€¸åˆ°å †ä¸Šï¼Œè¿™äº›èŠ‚ç‚¹åœ¨è¿™ä¸€é˜¶æ®µéƒ½ä¼šè¢« cmd/compile/internal/gc.walkstmt è½¬æ¢æˆé€šè¿‡ runtime.newobject å‡½æ•°å¹¶åœ¨å †ä¸Šç”³è¯·å†…å­˜\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func walkstmt(n *Node) *Node { switch n.Op { case ODCL: v := n.Left if v.Class() == PAUTOHEAP { if prealloc[v] == nil { prealloc[v] = callnew(v.Type) } nn := nod(OAS, v.Name.Param.Heapaddr, prealloc[v]) nn.SetColas(true) nn = typecheck(nn, ctxStmt) return walkstmt(nn) } case ONEW: if n.Esc == EscNone { r := temp(n.Type.Elem()) r = nod(OAS, r, nil) r = typecheck(r, ctxStmt) init.Append(r) r = nod(OADDR, r.Left, nil) r = typecheck(r, ctxExpr) n = r } else { n = callnew(n.Type.Elem()) } } } ä¸è¿‡è¿™ä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå¦‚æœé€šè¿‡ var æˆ–è€… new åˆ›å»ºçš„å˜é‡ä¸éœ€è¦åœ¨å½“å‰ä½œç”¨åŸŸå¤–ç”Ÿå­˜ï¼Œä¾‹å¦‚ä¸ç”¨ä½œä¸ºè¿”å›å€¼è¿”å›ç»™è°ƒç”¨æ–¹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦åˆå§‹åŒ–åœ¨å †ä¸Šã€‚\n","date":"2021-09-20T12:27:33+08:00","image":"https://chasing1020.github.io/post/go3-common-keywords/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go3-common-keywords/","title":"Go(3) Common Keywords"},{"content":"Part2. Language Basic 1. Function 1 2 3 4 type funcval struct { fn uintptr // variable-size, fn-specific data here } funcvalä½¿ç”¨äºŒçº§æŒ‡é’ˆï¼Œå¯ä»¥å¤„ç†é—­åŒ…ï¼ˆ1.å¤–éƒ¨å®šä¹‰ï¼Œå†…éƒ¨å¼•ç”¨çš„è‡ªç”±å˜é‡ 2.è„±ç¦»é—­åŒ…ä¸Šä¸‹æ–‡ä¹Ÿèƒ½ä¿ç•™è¿™äº›å˜é‡ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 func create() (fs [2]func()) { for i := 0; i \u0026lt; 2; i++ { fs[i] = func() { fmt.Println(i) } } return } // i åœ¨å †åŒºå‘ç”Ÿå˜é‡é€ƒé€¸ func main() { fs := create() for i := 0 ; i\u0026lt;2; i++{ fs[i]() // 2 2 } } å‡½æ•°è°ƒç”¨ä¸€èˆ¬åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š\nä¼ å€¼ï¼šå‡½æ•°è°ƒç”¨æ—¶ä¼šå¯¹å‚æ•°è¿›è¡Œæ‹·è´ï¼Œè¢«è°ƒç”¨æ–¹å’Œè°ƒç”¨æ–¹ä¸¤è€…æŒæœ‰ä¸ç›¸å…³çš„ä¸¤ä»½æ•°æ®ï¼› ä¼ å¼•ç”¨ï¼šå‡½æ•°è°ƒç”¨æ—¶ä¼šä¼ é€’å‚æ•°çš„æŒ‡é’ˆï¼Œè¢«è°ƒç”¨æ–¹å’Œè°ƒç”¨æ–¹ä¸¤è€…æŒæœ‰ç›¸åŒçš„æ•°æ®ï¼Œä»»æ„ä¸€æ–¹åšå‡ºçš„ä¿®æ”¹éƒ½ä¼šå½±å“å¦ä¸€æ–¹ã€‚ ä¸åŒè¯­è¨€ä¼šé€‰æ‹©ä¸åŒçš„æ–¹å¼ä¼ é€’å‚æ•°ï¼ŒGo è¯­è¨€é€‰æ‹©äº†ä¼ å€¼çš„æ–¹å¼ï¼Œæ— è®ºæ˜¯ä¼ é€’åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“è¿˜æ˜¯æŒ‡é’ˆï¼Œéƒ½ä¼šå¯¹ä¼ é€’çš„å‚æ•°è¿›è¡Œæ‹·è´ã€‚\næ•´å‹å’Œæ•°ç»„ç±»å‹éƒ½æ˜¯å€¼ä¼ é€’çš„ ä¼ é€’ç»“æ„ä½“æ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“ä¸­çš„å…¨éƒ¨å†…å®¹ï¼› ä¼ é€’ç»“æ„ä½“æŒ‡é’ˆæ—¶ï¼šä¼šæ‹·è´ç»“æ„ä½“æŒ‡é’ˆï¼› ç»¼ä¸Šæ‰€è¿°ï¼šåº”è¯¥å°½é‡ä½¿ç”¨æŒ‡é’ˆä½œä¸ºå‚æ•°ç±»å‹æ¥é¿å…å‘ç”Ÿæ•°æ®æ‹·è´è¿›è€Œå½±å“æ€§èƒ½ã€‚\n2. Interface æ¥å£ä¸€èˆ¬æœ‰ä¸¤ç±»ï¼Œefaceä¸ºä¸å¸¦æ–¹æ³•çš„æ¥å£ï¼Œifaceè¡¨ç¤ºå¸¦æ–¹æ³•çš„æ¥å£ã€‚\n2.1. Empty Interface 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 type eface struct { _type *_type data unsafe.Pointer } // Needs to be in sync with ../cmd/link/internal/ld/decodesym.go:/^func.commonsize, // ../cmd/compile/internal/gc/reflect.go:/^func.dcommontype and // ../reflect/type.go:/^type.rtype. // ../internal/reflectlite/type.go:/^type.rtype. // æ‰€æœ‰ç±»çš„ç±»å‹å…ƒä¿¡æ¯ type _type struct { size uintptr ptrdata uintptr // size of memory prefix holding all pointers hash uint32 // hash æ˜¯å¯¹ _type.hash çš„æ‹·è´ï¼Œå½“æˆ‘ä»¬æƒ³å°† interface ç±»å‹è½¬æ¢æˆå…·ä½“ç±»å‹æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¯¥å­—æ®µå¿«é€Ÿåˆ¤æ–­ç›®æ ‡ç±»å‹å’Œå…·ä½“ç±»å‹æ˜¯å¦ä¸€è‡´ tflag tflag align uint8 fieldAlign uint8 kind uint8 // function for comparing objects of this type // (ptr to object A, ptr to object B) -\u0026gt; ==? equal func(unsafe.Pointer, unsafe.Pointer) bool // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte str nameOff ptrToThis typeOff } func efaceOf(ep *interface{}) *eface { return (*eface)(unsafe.Pointer(ep)) } 1 2 3 4 5 6 7 8 9 10 11 12 13 type _interface struct { dynamicTypeInfo *_implementation dynamicValue unsafe.Pointer // unsafe.Pointer means // *ArbitraryType in Go. } type _implementation struct { itype *_type // the interface type. dtype *_type // the dynamic type, which must implement itype. methods []*_func // the methods which are defined on dtype // and each of them implements a // corresponding method declared in itype. } å…¶ä¸­ï¼ŒGoè¯­è¨€æ¯ä¸€ä¸ªæ–°å®šä¹‰çš„æ•°æ®ç±»å‹éƒ½ä¼šæœ‰ä¸€ä¸ªç±»å‹å…ƒæ•°æ®è®°ä¸º_typeï¼Œå¹¶è®°å½•è¯¥ç±»å‹çš„å¤§å°ï¼Œè¾¹ç•Œï¼Œåç§°ï¼Œæ˜¯å¦å¯æ¯”è¾ƒç­‰ç­‰\nåŒæ—¶å¯ä»¥ä½¿ç”¨typeæ–¹æ³•æ¥è‡ªå®šä¹‰æ–°çš„ç±»å‹å…ƒæ•°æ®\n1 2 type mytype1 = int32 type mytype2 int32 å‰è€…ä¸ºèµ·åˆ«åï¼Œéƒ½æ˜¯åŒæ ·çš„æ•°æ®ç±»å‹ï¼ˆruneå’Œint32çš„å®ç°ï¼‰ï¼Œåè€…åˆ™ä¼šå®Œå…¨åˆ†é…æ–°çš„ç±»å‹ä¿¡æ¯ã€‚\n2.2. Non-empty interface 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 type iface struct { tab *itab data unsafe.Pointer } type itab struct { inter *interfacetype _type *_type hash uint32 _ [4]byte fun [1]uintptr // variable sized. fun[0]==0 means _type does not implement inter. } type interfacetype struct { typ _type pkgpath name mhdr []imethod } Goåœ¨è¿è¡Œæ—¶ï¼Œitabä¼šæ‹·è´åŠ¨æ€ç±»å‹æ–¹æ³•çš„åœ°å€ï¼Œä»¥ä¾¿å¿«é€Ÿå®šä½åˆ°æ–¹æ³•ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½å»ç±»å‹å…ƒæ•°æ®é‚£é‡Œå»æ‰¾ã€‚\nåŒæ—¶ï¼Œè¿è¡Œæ—¶ï¼Œå¯¹äºæ¯ä¸€ä¸ªitabç»“æ„ä½“ï¼ŒGoä¼šç”Ÿæˆä¸€ä¸ª512ä¸ªå¤§å°çš„hashmapï¼Œä»¥æ¥å£ç±»å‹ä¸ºkeyï¼ŒåŠ¨æ€ç±»å‹ä¸ºvalueç±»å‹æ¥ç¼“å­˜itabçš„ä¿¡æ¯ï¼Œä¸å“ˆå¸Œè¡¨çš„tableè¿›è¡Œå¼‚æˆ–è¿ç®—ï¼Œå¾—åˆ°ç±»å‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 const itabInitSize = 512 // Note: change the formula in the mallocgc call in itabAdd if you change these fields. type itabTableType struct { size uintptr // length of entries array. Always a power of 2. count uintptr // current number of filled entries. entries [itabInitSize]*itab // really [size] large } func itabHashFunc(inter *interfacetype, typ *_type) uintptr { // compiler has provided some good hash codes for us. return uintptr(inter.typ.hash ^ typ.hash) } éšå¼ç±»å‹è½¬æ¢\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package main import \u0026#34;fmt\u0026#34; type GrpcError struct{} func (e GrpcError) Error() string { return \u0026#34;GrpcError\u0026#34; } func main() { err := cal() fmt.Println(err) // æ‰“å°ï¼š\u0026lt;nil\u0026gt; fmt.Println(err == nil) // æ‰“å°ï¼šfalse } func cal() error { var err *GrpcError = nil return err } åœ¨ main ä¸­åˆ¤æ–­ err æ˜¯å¦ä¸º nilï¼Œç­”æ¡ˆæ˜¯ falseã€‚error æ˜¯ä¸€ä¸ªéç©º interfaceï¼Œåº•å±‚æ•°æ®ç»“æ„æ˜¯ ifaceï¼Œå°½ç®¡ data æ˜¯ nilï¼Œä½†æ˜¯ *itab å¹¶ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ err == nil ç­”æ¡ˆä¸º falseã€‚\n2.3. Type Assert ç±»å‹æ–­è¨€ä¸€å…±æœ‰å››ç§ç»„åˆ\nç©ºæ¥å£.(å…·ä½“ç±»å‹) å› ä¸ºæ¯ç§æ•°æ®ç±»å‹çš„å…ƒç±»å‹éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œæ‰€ä»¥åªéœ€è¦æ¯”è¾ƒ_typeæŒ‡å‘çš„æ˜¯ä¸æ˜¯æ–­è¨€çš„å…·ä½“ç±»å‹æŒ‡é’ˆå³å¯ éç©ºæ¥å£.(å…·ä½“ç±»å‹) æ¯”è¾ƒ\u0026amp;itabæ˜¯ä¸æ˜¯æ–­è¨€ç±»å‹çš„æŒ‡é’ˆå³å¯ï¼Œè¿™é‡Œçš„æ¯”è¾ƒé€šè¿‡itabHashFuncå‡½æ•°å®ç°ï¼Œåªéœ€è®¡ç®—ä¸€æ¬¡å¼‚æˆ–å³å¯ ç©ºæ¥å£.(éç©ºæ¥å£) æ¯”è¾ƒç±»å‹å…ƒæ•°æ®æ˜¯ä¸æ˜¯æ–­è¨€ç±»å‹çš„æŒ‡é’ˆï¼ŒæˆåŠŸåˆ™ä¼šè¿”å›æŒ‡å‘æ–­è¨€ç±»å‹çš„itabç»“æ„ä½“æŒ‡é’ˆ éç©ºæ¥å£.(ç©ºæ¥å£) æ¯”è¾ƒitabæ˜¯ä¸æ—¶æ–­è¨€ç±»å‹çš„æŒ‡é’ˆï¼Œä¸”è¦æ±‚fun[0]!=0ï¼Œè¡¨ç¤ºæ–¹æ³•éƒ½å·²ç»å…¨éƒ¨å®ç° æ­¤å¤–å®ç°æ¥å£çš„ç±»å‹å’Œåˆå§‹åŒ–è¿”å›çš„ç±»å‹ä¸¤ä¸ªç»´åº¦å…±ç»„æˆäº†å››ç§æƒ…å†µï¼š\nç»“æ„ä½“å®ç°æ¥å£ ç»“æ„ä½“æŒ‡é’ˆå®ç°æ¥å£ ç»“æ„ä½“åˆå§‹åŒ–å˜é‡ é€šè¿‡ ä¸é€šè¿‡ ç»“æ„ä½“æŒ‡é’ˆåˆå§‹åŒ–å˜é‡ é€šè¿‡ é€šè¿‡ 3.Reflection 3.1. Implement 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 package runtime // Needs to be in sync with ../cmd/link/internal/ld/decodesym.go:/^func.commonsize, // ../cmd/compile/internal/gc/reflect.go:/^func.dcommontype and // ../reflect/type.go:/^type.rtype. // ../internal/reflectlite/type.go:/^type.rtype. type _type struct { size uintptr ptrdata uintptr // size of memory prefix holding all pointers hash uint32 tflag tflag align uint8 fieldAlign uint8 kind uint8 // function for comparing objects of this type // (ptr to object A, ptr to object B) -\u0026gt; ==? equal func(unsafe.Pointer, unsafe.Pointer) bool // gcdata stores the GC type data for the garbage collector. // If the KindGCProg bit is set in kind, gcdata is a GC program. // Otherwise it is a ptrmask bitmap. See mbitmap.go for details. gcdata *byte str nameOff ptrToThis typeOff } runtimeçš„åŒ…çš„_typeç±»å‹æ˜¯éå¯¼å‡ºçš„ï¼Œæ‰€ä»¥åœ¨reflectåŒ…ä¸‹é‡å†™äº†ä¸€éï¼Œç§°ä¸ºrtypeï¼Œå¹¶å®ç°äº†Typeæ¥å£\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package reflect // rtype is the common implementation of most values. // It is embedded in other struct types. // // rtype must be kept in sync with ../runtime/type.go:/^type._type. type rtype struct { size uintptr ptrdata uintptr // number of bytes in the type that can contain pointers hash uint32 // hash of type; avoids computation in hash tables tflag tflag // extra type information flags align uint8 // alignment of variable with this type fieldAlign uint8 // alignment of struct field with this type kind uint8 // enumeration for C // function for comparing objects of this type // (ptr to object A, ptr to object B) -\u0026gt; ==? equal func(unsafe.Pointer, unsafe.Pointer) bool gcdata *byte // garbage collection data str nameOff // string form ptrToThis typeOff // type for pointer to this type, may be zero } 3.2. The Lows Of Reflection Reference : https://go.dev/blog/laws-of-reflection\n1 2 3 4 5 6 7 8 9 10 type Type interface { Align() int FieldAlign() int Method(int) Method MethodByName(string) (Method, bool) // MethodByName å¯ä»¥è·å–å½“å‰ç±»å‹å¯¹åº”æ–¹æ³•çš„å¼•ç”¨ NumMethod() int ... Implements(u Type) bool // Implements å¯ä»¥åˆ¤æ–­å½“å‰ç±»å‹æ˜¯å¦å®ç°äº†æŸä¸ªæ¥å£ ... } åå°„ä¸‰å¤§åŸåˆ™ï¼š\nä» interface{} å˜é‡å¯ä»¥åå°„å‡ºåå°„å¯¹è±¡ï¼› ä»åå°„å¯¹è±¡å¯ä»¥è·å– interface{} å˜é‡ï¼› è¦ä¿®æ”¹åå°„å¯¹è±¡ï¼Œå…¶å€¼å¿…é¡»å¯è®¾ç½®ï¼› reflect.ValueOf(1) æ—¶ï¼Œè™½ç„¶çœ‹èµ·æ¥æ˜¯è·å–äº†åŸºæœ¬ç±»å‹ int å¯¹åº”çš„åå°„ç±»å‹ï¼Œå…¶å®æ˜¯ç”±ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•åå°„è·å–æ•°æ®åŸå˜é‡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // ValueOf returns a new Value initialized to the concrete value // stored in the interface i. ValueOf(nil) returns the zero Value. func ValueOf(i interface{}) Value { if i == nil { return Value{} } // TODO: Maybe allow contents of a Value to live on the stack. // For now we make the contents always escape to the heap. It // makes life easier in a few places (see chanrecv/mapassign // comment below). escapes(i) return unpackEface(i) } // unpackEface converts the empty interface i to a Value. func unpackEface(i interface{}) Value { e := (*emptyInterface)(unsafe.Pointer(\u0026amp;i)) // NOTE: don\u0026#39;t read e.word until we know whether it is really a pointer or not. t := e.typ if t == nil { return Value{} } f := flag(t.Kind()) if ifaceIndir(t) { f |= flagIndir } return Value{t, e.word, f} } åå°„æ–¹æ³•ä¸­ï¼Œ*emptyInterfaceå…¶å®å°±æ˜¯efaceçš„é‡å†™\n1 2 3 4 5 6 7 8 9 10 11 12 // TypeOf returns the reflection Type that represents the dynamic type of i. // If i is a nil interface value, TypeOf returns nil. func TypeOf(i interface{}) Type { eface := *(*emptyInterface)(unsafe.Pointer(\u0026amp;i)) return toType(eface.typ) } func toType(t *rtype) Type { if t == nil { return nil } return t } é€šè¿‡åå°„è·å–interfaceå˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 type flag uintptr // To compare two Values, compare the results of the Interface method. // Using == on two Values does not compare the underlying values // they represent. type Value struct { // typ holds the type of the value represented by a Value. typ *rtype // Pointer-valued data or, if flagIndir is set, pointer to data. // Valid when either flagIndir is set or typ.pointers() is true. ptr unsafe.Pointer // flag holds metadata about the value. flag } // Interface returns v\u0026#39;s current value as an interface{}. // It is equivalent to: // var i interface{} = (v\u0026#39;s underlying value) // It panics if the Value was obtained by accessing // unexported struct fields. func (v Value) Interface() (i interface{}) { return valueInterface(v, true) } 1 2 v := reflect.ValueOf(1) v.Interface().(int) ä»æ¥å£å€¼åˆ°åå°„å¯¹è±¡ï¼š ä»åŸºæœ¬ç±»å‹åˆ°æ¥å£ç±»å‹çš„ç±»å‹è½¬æ¢ï¼› ä»æ¥å£ç±»å‹åˆ°åå°„å¯¹è±¡çš„è½¬æ¢ï¼› ä»åå°„å¯¹è±¡åˆ°æ¥å£å€¼ï¼š åå°„å¯¹è±¡è½¬æ¢æˆæ¥å£ç±»å‹ï¼› é€šè¿‡æ˜¾å¼ç±»å‹è½¬æ¢å˜æˆåŸå§‹ç±»å‹ï¼› å¯ä»¥é€šè¿‡ä»¥ä¸‹è¿™å¼ å›¾å±•ç¤ºæ•°æ®ç±»å‹ä¹‹é—´çš„å…³ç³» Goè¯­è¨€ä¿®æ”¹åå°„åå˜é‡åªèƒ½é€šè¿‡å¦‚ä¸‹æ–¹æ³•æ¥å®ç°ï¼š\n1 2 3 4 5 6 func main() { i := 1 v := reflect.ValueOf(\u0026amp;i) v.Elem().SetInt(10) fmt.Println(i) } è°ƒç”¨ reflect.ValueOf è·å–å˜é‡æŒ‡é’ˆï¼› è°ƒç”¨ reflect.Value.Elem è·å–æŒ‡é’ˆæŒ‡å‘çš„å˜é‡ï¼› è°ƒç”¨ reflect.Value.SetInt æ›´æ–°å˜é‡çš„å€¼ï¼š\n3.3. Type And Value Go è¯­è¨€çš„ interface{}ç±»å‹åœ¨è¯­è¨€å†…éƒ¨æ˜¯é€šè¿‡ reflect.emptyInterfaceç»“ä½“è¡¨ç¤ºçš„ï¼Œå…¶ä¸­çš„ rtype å­—æ®µç”¨äºè¡¨ç¤ºå˜é‡çš„ç±»å‹ï¼Œå¦ä¸€ä¸ª word å­—æ®µæŒ‡å‘å†…éƒ¨å°è£…çš„æ•°æ®ï¼š\n1 2 3 4 type emptyInterface struct { typ *rtype word unsafe.Pointer } ç”¨äºè·å–å˜é‡ç±»å‹çš„ reflect.TypeOfå‡½æ•°å°†ä¼ å…¥çš„å˜é‡éšå¼è½¬æ¢æˆ reflect.emptyInterfaceç±»å‹å¹¶è·å–å…¶ä¸­å­˜å‚¨çš„ç±»å‹ä¿¡æ¯ reflect.rtypeï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 func TypeOf(i interface{}) Type { eface := *(*emptyInterface)(unsafe.Pointer(\u0026amp;i)) return toType(eface.typ) } func toType(t *rtype) Type { if t == nil { return nil } return t } func (t *rtype) String() string { s := t.nameOff(t.str).name() if t.tflag\u0026amp;tflagExtraStar != 0 { return s[1:] } return s } reflect.rtype æ˜¯ä¸€ä¸ªå®ç°äº† reflect.Type æ¥å£çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å®ç°çš„ reflect.rtype.Stringæ–¹æ³•å¯ä»¥å¸®åŠ©æˆ‘ä»¬è·å–å½“å‰ç±»å‹çš„åç§°ï¼š\n1 2 3 4 5 6 7 func (t *rtype) String() string { s := t.nameOff(t.str).name() if t.tflag\u0026amp;tflagExtraStar != 0 { return s[1:] } return s } reflect.TypeOfçš„å®ç°åŸç†å…¶å®å¹¶ä¸å¤æ‚ï¼Œå®ƒåªæ˜¯å°†ä¸€ä¸ª interface{} å˜é‡è½¬æ¢æˆäº†å†…éƒ¨çš„ reflect.emptyInterface è¡¨ç¤ºï¼Œç„¶åä»ä¸­è·å–ç›¸åº”çš„ç±»å‹ä¿¡æ¯ã€‚\nä½¿ç”¨reflect.ValueOf()è·å–reflect.Valueç±»å‹ï¼Œè¿™é‡Œå…ˆä½¿ç”¨äº†escapeså°†å˜é‡é€ƒé€¸åˆ°å †ä¸Šï¼Œå†è·å–ç»“æ„ä½“\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 func ValueOf(i interface{}) Value { if i == nil { return Value{} } escapes(i) return unpackEface(i) } // Dummy annotation marking that the value x escapes, // for use in cases where the reflect code is so clever that // the compiler cannot follow. func escapes(x interface{}) { if dummy.b { dummy.x = x } } //dummy å˜é‡å°±æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ ‡æ³¨ï¼Œæ ‡è®°å…¥å‚ x é€ƒé€¸äº†ã€‚è¿™æ ·æ ‡è®°æ˜¯ä¸ºäº†é˜²æ­¢åå°„ä»£ç å†™çš„è¿‡äºé«˜çº§ï¼Œä»¥è‡³äºç¼–è¯‘å™¨è·Ÿä¸ä¸Šäº†ã€‚ var dummy struct { b bool x interface{} } func unpackEface(i interface{}) Value { e := (*emptyInterface)(unsafe.Pointer(\u0026amp;i)) t := e.typ if t == nil { return Value{} } f := flag(t.Kind()) if ifaceIndir(t) { f |= flagIndir } return Value{t, e.word, f} } type Value struct { // typ holds the type of the value represented by a Value. typ *rtype // ç±»å‹å…ƒæ•°æ®æŒ‡é’ˆ ptr unsafe.Pointer // æ•°æ®åœ°å€ flag // ä½æ ‡è¯†ç¬¦ä¿¡æ¯ } ä½¿ç”¨åå°„è¿è¡Œæ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func Add(a, b int) int { return a + b } func main() { v := reflect.ValueOf(Add) if v.Kind() != reflect.Func { return } t := v.Type() argv := make([]reflect.Value, t.NumIn()) for i := range argv { if t.In(i).Kind() != reflect.Int { return } argv[i] = reflect.ValueOf(i) } result := v.Call(argv) if len(result) != 1 || result[0].Kind() != reflect.Int { return } fmt.Println(result[0].Int()) // #=\u0026gt; 1 } ","date":"2021-09-14T19:26:33+08:00","image":"https://chasing1020.github.io/post/go2-language-basic/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go2-language-basic/","title":"Go(2) Language Basic"},{"content":"Part1. Builtin Data Structure 0. Type 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 package builtin type bool bool const ( true = 0 == 0 // Untyped bool. false = 0 != 0 // Untyped bool. ) type uint8 uint8 type uint16 uint16 type uint32 uint32 type uint64 uint64 type int8 int8 type int16 int16 type int32 int32 type int64 int64 type float32 float32 type float64 float64 type complex64 complex64 type complex128 complex128 type string string type int int type uint uint type uintptr uintptr // byte is an alias for uint8 and is equivalent to uint8 in all ways. type byte = uint8 // rune is an alias for int32 and is equivalent to int32 in all ways. type rune = int32 const iota = 0 // Untyped int. // nil is a predeclared identifier representing the zero value for a // pointer, channel, func, interface, map, or slice type. var nil Type // Type must be a pointer, channel, func, interface, map, or slice type type Type int type Type1 int type IntegerType int type FloatType float32 type ComplexType complex64 func append(slice []Type, elems ...Type) []Type func copy(dst, src []Type) int func delete(m map[Type]Type1, key Type) func len(v Type) int func cap(v Type) int func make(t Type, size ...IntegerType) Type func new(Type) *Type func complex(r, i FloatType) ComplexType func real(c ComplexType) FloatType func imag(c ComplexType) FloatType func close(c chan\u0026lt;- Type) func panic(v interface{}) func recover() interface{} func print(args ...Type) func println(args ...Type) type error interface { Error() string } å¯¹äºç±»å‹çš„å®šä¹‰ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package types // A Type represents a Go type. type Type struct { Extra interface{} Width int64 // valid if Align \u0026gt; methods Fields allMethods Fields Nod *Node // canonical OTYPE node Orig *Type // original type (type literal or predefined type) // Cache of composite types, with this type being the element type. Cache struct { ptr *Type // *T, or nil slice *Type // []T, or nil } Sym *Sym // symbol containing name, for named types Vargen int32 // unique name for OTYPE/ONAME Etype EType // kind of type Align uint8 // the required alignment of this type, in bytes (0 means Width and Align have not yet been computed) flags bitset8 } ç‰¹åˆ«çš„ï¼Œåœ¨IEEE-754ä¸­ï¼Œå¯¹äºNaNçš„å®šä¹‰åˆ†ä¸ºsNaNå’ŒqNaNã€‚\nsNaNä»£è¡¨æ— æ•ˆçš„æ“ä½œï¼ŒæŒ‡æ•°ä½å…¨æ˜¯1ï¼Œå°æ•°ä½ç¬¬ä¸€ä½æ˜¯0\nqNaNä»£è¡¨æ— æ•ˆæˆ–è€…å¼‚å¸¸çš„ç»“æœï¼ŒæŒ‡æ•°ä½å…¨æ˜¯1ï¼Œå°æ•°ä½ç¬¬ä¸€ä½æ˜¯1\n1. Array 1.1. New Array 1 2 3 4 5 // Array contains Type fields specific to array types. type Array struct { Elem *Type // element type Bound int64 // number of elements; \u0026lt;0 if unknown yet } æ•°ç»„åˆ›å»ºæ—¶ä¼šå®šä¹‰å¥½ä¸¤ä¸ªéƒ¨åˆ†ï¼šåˆ†åˆ«æ˜¯å…ƒç´ ç±»å‹ Elem å’Œæ•°ç»„çš„å¤§å° Boundï¼Œä½¿ç”¨[\u0026hellip;]åˆå§‹åŒ–æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå¯¹æ•°ç»„å¤§å°è‡ªè¡Œæ¨å¯¼ï¼Œä¸ä½¿ç”¨å›ºå®šæ•°ç»„ä½œç”¨ç›¸åŒï¼Œåªæ˜¯ä½œä¸ºä¸€ç§è¯­æ³•ç³–ä½¿ç”¨ã€‚\n1 2 3 4 5 6 7 8 9 10 // NewArray returns a new fixed-length array Type. func NewArray(elem *Type, bound int64) *Type { if bound \u0026lt; 0 { Fatalf(\u0026#34;NewArray: invalid bound %v\u0026#34;, bound) } t := New(TARRAY) // retrun types.Type t.Extra = \u0026amp;Array{Elem: elem, Bound: bound} t.SetNotInHeap(elem.NotInHeap()) return t } åœ¨æ–°å»ºæ•°ç»„æ—¶ï¼Œç¼–è¯‘å™¨ä¼šåšå‡ºä¼˜åŒ–\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 if var_.isSimpleName() \u0026amp;\u0026amp; n.List.Len() \u0026gt; 4 { // lay out static data vstat := readonlystaticname(t) ctxt := inInitFunction if n.Op == OARRAYLIT { ctxt = inNonInitFunction } fixedlit(ctxt, initKindStatic, n, vstat, init) // copy static to var a := nod(OAS, var_, vstat) a = typecheck(a, ctxStmt) a = walkexpr(a, init) init.Append(a) // add expressions to automatic fixedlit(inInitFunction, initKindDynamic, n, var_, init) break } å½“å…ƒç´ æ•°é‡å°äºæˆ–è€…ç­‰äº 4 ä¸ªæ—¶ï¼Œä¼šç›´æ¥å°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åœ¨æ ˆä¸Šï¼Œä¼˜åŒ–ä¸º1-4ä¸ªç®€å•çš„èµ‹å€¼è¯­å¥ï¼› å½“å…ƒç´ æ•°é‡å¤§äº 4 ä¸ªæ—¶ï¼Œä¼šå°†æ•°ç»„ä¸­çš„å…ƒç´ æ”¾ç½®åˆ°é™æ€åŒºå¹¶åœ¨è¿è¡Œæ—¶å–å‡ºåˆ°æ ˆï¼› 1.2. Array Access åœ¨è¿è¡Œæ—¶ï¼Œä¼šé€šè¿‡cmd/compile/internal/gc.typecheck1å®æ—¶æ£€æŸ¥æ•°ç»„çš„å¯ç”¨èŒƒå›´\nè®¿é—®æ•°ç»„çš„ç´¢å¼•æ˜¯éæ•´æ•°æ—¶ï¼ŒæŠ¥é”™ â€œnon-integer array index %vâ€ï¼› è®¿é—®æ•°ç»„çš„ç´¢å¼•æ˜¯è´Ÿæ•°æ—¶ï¼ŒæŠ¥é”™ â€œinvalid array index %v (index must be non-negative)\u0026quot;ï¼› è®¿é—®æ•°ç»„çš„ç´¢å¼•è¶Šç•Œæ—¶ï¼ŒæŠ¥é”™ â€œinvalid array index %v (out of bounds for %d-element array)\u0026quot;ï¼› 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 if n.Right.Type != nil \u0026amp;\u0026amp; !n.Right.Type.IsInteger() { yyerror(\u0026#34;non-integer %s index %v\u0026#34;, why, n.Right) break } if !n.Bounded() \u0026amp;\u0026amp; Isconst(n.Right, CTINT) { x := n.Right.Int64Val() if x \u0026lt; 0 { yyerror(\u0026#34;invalid %s index %v (index must be non-negative)\u0026#34;, why, n.Right) } else if t.IsArray() \u0026amp;\u0026amp; x \u0026gt;= t.NumElem() { yyerror(\u0026#34;invalid array index %v (out of bounds for %d-element array)\u0026#34;, n.Right, t.NumElem()) } else if Isconst(n.Left, CTSTR) \u0026amp;\u0026amp; x \u0026gt;= int64(len(n.Left.StringVal())) { yyerror(\u0026#34;invalid string index %v (out of bounds for %d-byte string)\u0026#34;, n.Right, len(n.Left.StringVal())) } else if n.Right.Val().U.(*Mpint).Cmp(maxintval[TINT]) \u0026gt; 0 { yyerror(\u0026#34;invalid %s index %v (index too large)\u0026#34;, why, n.Right) } } ä¸€æ—¦å‘ç”Ÿéæ³•è®¿é—®ï¼Œç«‹å³ä¼šæŠ¥å‡ºpanicè§¦å‘è¿è¡Œæ—¶é”™è¯¯å¹¶é€€å‡ºç¨‹åº\n1 2 3 4 func goPanicIndex(x int, y int) { panicCheck1(getcallerpc(), \u0026#34;index out of range\u0026#34;) panic(boundsError{x: int64(x), signed: true, y: y, code: boundsIndex}) } 2. Slice 2.1. New Slice 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // Fields is a pointer to a slice of *Field. // This saves space in Types that do not have fields or methods // compared to a simple slice of *Field. type Fields struct { s *[]*Field } // A Field represents a field in a struct or a method in an interface or // associated with a named type. type Field struct { flags bitset8 Embedded uint8 // embedded field Pos src.XPos Sym *Sym Type *Type // field type Note string // literal string annotation // For fields that represent function parameters, Nname points // to the associated ONAME Node. Nname *Node // Offset in bytes of this field or method within its enclosing struct // or interface Type. Offset int64 } // Slice returns the entries in f as a slice. // Changes to the slice entries will be reflected in f. func (f *Fields) Slice() []*Field { if f.s == nil { return nil } return *f.s } ç¼–è¯‘æœŸé—´çš„åˆ‡ç‰‡ç±»å‹å¦‚ä¸Šæ‰€ç¤ºï¼Œåˆ›å»ºæ–°åˆ‡ç‰‡çš„æ–¹æ³•å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // NewSlice returns the slice Type with element type elem. func NewSlice(elem *Type) *Type { if t := elem.Cache.slice; t != nil { if t.Elem() != elem { Fatalf(\u0026#34;elem mismatch\u0026#34;) } return t } t := New(TSLICE) t.Extra = Slice{Elem: elem} elem.Cache.slice = t return t } ä½†æ˜¯åœ¨è¿è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå¦‚ä¸‹çš„æ•°æ®ç»“æ„ï¼š\n1 2 3 4 5 6 7 8 9 10 11 // SliceHeader is the runtime representation of a slice. // It cannot be used safely or portably and its representation may // change in a later release. // Moreover, the Data field is not sufficient to guarantee the data // it references will not be garbage collected, so programs must keep // a separate, correctly typed pointer to the underlying data. type SliceHeader struct { Data uintptr Len int Cap int } å…¶ä¸­Dataæ˜¯ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œè¿™ç‰‡å†…å­˜ç©ºé—´å¯ä»¥ç”¨äºå­˜å‚¨åˆ‡ç‰‡ä¸­çš„å…¨éƒ¨å…ƒç´ ï¼Œä¸”Dataä¸å¿…æ˜¯è¿ç»­ç©ºé—´çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚\né€šè¿‡ä¸‹æ ‡çš„æ–¹å¼è·å¾—æ•°ç»„æˆ–è€…åˆ‡ç‰‡çš„ä¸€éƒ¨åˆ†ï¼šarr[0:3] or slice[0:3]\nä¼šä½¿ç”¨SliceMake æ“ä½œä¼šï¼Œæ¥å—å››ä¸ªå‚æ•°åˆ›å»ºæ–°çš„åˆ‡ç‰‡ï¼Œå…ƒç´ ç±»å‹ã€æ•°ç»„æŒ‡é’ˆã€åˆ‡ç‰‡å¤§å°å’Œå®¹é‡\n1 2 3 nums := [...]int{0, 1, 2, 3, 4, 5, 5, 6, 7, 8, 9} slice := nums[3:5] fmt.Println(len(slice), cap(slice)) // 2 8 â€‹ åˆ›å»ºåï¼Œé•¿åº¦é»˜è®¤æ˜¯åˆ‡ç‰‡èŒƒå›´ï¼Œä½†æ˜¯å®¹é‡ä¼šä¸€ç›´ä»åˆ‡ç‰‡èµ·å§‹å€¼å»¶ç»­åˆ°æ•°ç»„çš„æœ€åä¸€ä½ 2. ä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–æ–°çš„åˆ‡ç‰‡ï¼šslice := []int{1, 2, 3}\nåˆ›å»ºä¸€ä¸ªæ•°ç»„å¹¶åˆå§‹åŒ–ï¼Œå°†é™æ€å­˜å‚¨åŒºçš„æ•°ç»„ï¼Œå†ç”¨[:]è·å¾—ä¸€ä¸ªåˆ‡ç‰‡ ä½¿ç”¨å…³é”®å­— make åˆ›å»ºåˆ‡ç‰‡ï¼šslice := make([]int, 2, 5)ï¼Œè¿™æ ·Len=2ï¼Œæ•°ç»„é‡Œå‰ä¸¤ä¸ªå…ƒç´ æ˜¯é»˜è®¤é›¶å€¼çš„ï¼Œå‰©ä½™ä¸‰ä¸ªå…ƒç´ ä¿ç•™ä¸º0ï¼Œå¹¶éçœŸæ­£å¯è®¿é—®çš„å€¼ï¼ŒåŒæ—¶åœ¨åˆ›å»ºæ—¶ä¼šå‘ç”Ÿä»¥ä¸‹æ ¡éªŒï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 if i \u0026gt;= len(args) { yyerror(\u0026#34;missing len argument to make(%v)\u0026#34;, t) return n } l = args[i] i++ var r *Node if i \u0026lt; len(args) { r = args[i] } ... if Isconst(l, CTINT) \u0026amp;\u0026amp; r != nil \u0026amp;\u0026amp; Isconst(r, CTINT) \u0026amp;\u0026amp; l.Val().U.(*Mpint).Cmp(r.Val().U.(*Mpint)) \u0026gt; 0 { yyerror(\u0026#34;len larger than cap in make(%v)\u0026#34;, t) return n } n.Left = l n.Right = r n.Op = OMAKESLICE æ£€æŸ¥åˆ‡ç‰‡çš„å¤§å°å’Œå®¹é‡æ˜¯å¦è¶³å¤Ÿå°ï¼Œåˆ‡ç‰‡æ˜¯å¦å‘ç”Ÿäº†é€ƒé€¸ç­‰ï¼Œæœ€ç»ˆåœ¨å †ä¸Šåˆå§‹åŒ–ã€‚\nä½¿ç”¨newå…³é”®å­—åˆ›å»ºåˆ‡ç‰‡ï¼šslice := new([]string)ï¼Œè¿™æ ·sliceä¸ä¼šä¸ºDataåˆ†é…åº•å±‚çš„æ•°ç»„ï¼Œæ ‡è®°ä¸ºnilï¼Œåœ¨åç»­é€šè¿‡appendä¼šåˆ†é…æ•°ç»„ 1 2 slice := new([]string) // Can\u0026#39;t (*slice)[0] = \u0026#34;abc\u0026#34; å¦‚æœä½¿ç”¨[]int{1, 2, 3}è¿™æ ·çš„å­—é¢é‡åˆå§‹åŒ–ï¼Œä¼šåˆ›å»ºä¸€ä¸ªarrayå­˜å‚¨åˆ°é™æ€åŒºï¼Œç¨‹åºå¯åŠ¨æ—¶ï¼Œå°†é™æ€åŒºçš„æ•°æ®æ‹·è´åˆ°å †åŒºã€‚\n2.2. Slice Grow ä½¿ç”¨appendæ‰©å®¹ï¼Œå¦‚æœæ²¡æœ‰è¦†ç›–åŸå§‹å˜é‡ï¼Œåˆ™ç›´æ¥è¿”å›\n1 2 3 4 5 6 7 8 9 10 11 // append(slice, 1, 2, 3) ptr, len, cap := slice newlen := len + 3 if newlen \u0026gt; cap { ptr, len, cap = growslice(slice, newlen) newlen = len + 3 } *(ptr+len) = 1 *(ptr+len+1) = 2 *(ptr+len+2) = 3 return makeslice(ptr, newlen, cap) ä½†æ˜¯å¦‚æœéœ€è¦æ‰©å®¹åçš„ç»“æœè¿›è¡Œèµ‹å€¼ï¼Œåˆ™ä¼šå˜æˆå¦‚ä¸‹çŠ¶æ€\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // slice = append(slice, 1, 2, 3) a := \u0026amp;slice ptr, len, cap := slice newlen := len + 3 if uint(newlen) \u0026gt; uint(cap) { newptr, len, newcap = growslice(slice, newlen) vardef(a) *a.cap = newcap *a.ptr = newptr } newlen = len + 3 *a.len = newlen *(ptr+len) = 1 *(ptr+len+1) = 2 *(ptr+len+2) = 3 åœ¨capä¸å¤Ÿæ—¶ï¼Œå‘ç”Ÿæ‰©å®¹çš„è§„åˆ™å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 func growslice(et *_type, old slice, cap int) slice { newcap := old.cap doublecap := newcap + newcap if cap \u0026gt; doublecap { newcap = cap } else { if old.len \u0026lt; 1024 { newcap = doublecap } else { for 0 \u0026lt; newcap \u0026amp;\u0026amp; newcap \u0026lt; cap { newcap += newcap / 4 } if newcap \u0026lt;= 0 { newcap = cap } } } } å¦‚æœæœŸæœ›å®¹é‡å¤§äºå½“å‰å®¹é‡çš„ä¸¤å€å°±ä¼šä½¿ç”¨æœŸæœ›å®¹é‡ï¼› å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å°äº 1024 å°±ä¼šå°†å®¹é‡ç¿»å€ï¼› å¦‚æœå½“å‰åˆ‡ç‰‡çš„é•¿åº¦å¤§äº 1024 å°±ä¼šæ¯æ¬¡å¢åŠ  25% çš„å®¹é‡ï¼Œç›´åˆ°æ–°å®¹é‡å¤§äºæœŸæœ›å®¹é‡ï¼› å¦‚æœæœ€ç»ˆå®¹é‡è¿‡å¤§å¯¼è‡´æº¢å‡ºï¼Œåˆ™ç›´æ¥å°†æœ€ç»ˆå®¹é‡è®¾ç½®ä¸ºæ–°ç”³è¯·å®¹é‡ã€‚ æ­¤å¤–ï¼Œåˆ†é…ç©ºé—´æ—¶ï¼Œä¼šè€ƒè™‘åˆ°å†…å­˜å¯¹é½é—®é¢˜ã€‚ä¼šé€‰æ‹©å‘ä¸Šå–æ•´çš„å†…å­˜æ®µä¸ºåˆ‡ç‰‡åˆ†é…ï¼Œæé«˜å†…å­˜åˆ†é…æ•ˆç‡ä»¥å‡å°‘å¤–éƒ¨ç¢ç‰‡ã€‚\næ¯”å¦‚å½“è¿è¡Œå¦‚ä¸‹ä»£ç ï¼š\n1 2 var arr []int64 arr = append(arr, 1, 2, 3, 4, 5) åˆ†é…çš„æœŸæœ›capæ˜¯5ï¼Œéœ€è¦40ä¸ªå­—èŠ‚ï¼Œä¼šè°ƒç”¨roundupsizeï¼Œè°ƒæ•´åˆ°åˆé€‚çš„å­—èŠ‚å¤§å°48ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // Returns size of the memory block that mallocgc will allocate if you ask for the size. func roundupsize(size uintptr) uintptr { if size \u0026lt; _MaxSmallSize { if size \u0026lt;= smallSizeMax-8 { return uintptr(class_to_size[size_to_class8[divRoundUp(size, smallSizeDiv)]]) } else { return uintptr(class_to_size[size_to_class128[divRoundUp(size-smallSizeMax, largeSizeDiv)]]) } } if size+_PageSize \u0026lt; size { return size } return alignUp(size, _PageSize) } ä»¥ä¸‹ä¸ºåˆ¤æ–­æ˜¯å¦éœ€è¦å‘ç”Ÿæ‰©å®¹çš„ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 var overflow bool var lenmem, newlenmem, capmem uintptr switch { case et.size == 1: lenmem = uintptr(old.len) newlenmem = uintptr(cap) capmem = roundupsize(uintptr(newcap)) overflow = uintptr(newcap) \u0026gt; maxAlloc newcap = int(capmem) case et.size == sys.PtrSize: lenmem = uintptr(old.len) * sys.PtrSize newlenmem = uintptr(cap) * sys.PtrSize capmem = roundupsize(uintptr(newcap) * sys.PtrSize) overflow = uintptr(newcap) \u0026gt; maxAlloc/sys.PtrSize newcap = int(capmem / sys.PtrSize) case isPowerOfTwo(et.size): ... default: ... } const _MaxSmallSize = 32768 var class_to_size = [_NumSizeClasses]uint16{0, 8, 16, 32, 48, 64, 80, ...,} 2.3. Slice Copy éœ€è¦å‘ç”Ÿåˆ‡ç‰‡æ‹·è´æ—¶ï¼Œéè¿è¡Œæ—¶æ‹·è´ä¼šè°ƒç”¨ä»¥ä¸‹ä»£ç ï¼š\n1 2 3 4 5 6 7 n := len(a) if n \u0026gt; len(b) { n = len(b) } if a.ptr != b.ptr { memmove(a.ptr, b.ptr, n*sizeof(elem(a))) } ä½†æ˜¯åœ¨è¿è¡Œæ—¶è°ƒç”¨copy(a, b)æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä¼˜åŒ–ä¸ºä»¥ä¸‹å‡½æ•°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func slicecopy(to, fm slice, width uintptr) int { if fm.len == 0 || to.len == 0 { return 0 } n := fm.len if to.len \u0026lt; n { n = to.len } if width == 0 { return n } // ... size := uintptr(n) * width if size == 1 { *(*byte)(to.array) = *(*byte)(fm.array) } else { memmove(to.array, fm.array, size) } return n } ä¸¤ç§æ‹·è´éƒ½ä¼šè°ƒç”¨memmoveå‡½æ•°ï¼Œå°†æ•´å—å†…å­˜çš„å†…å®¹æ‹·è´åˆ°ç›®æ ‡çš„å†…å­˜åŒºåŸŸä¸­ï¼ˆå¦‚æœç›®æ ‡å†…å­˜ä¸è¶³å°±ä¸ä¼šå®Œå…¨æ‹·è´ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°ä»¥æ±‡ç¼–æ–¹å¼å®ç°ã€‚åœ¨å¤§åˆ‡ç‰‡ä¸Šæ‰§è¡Œæ‹·è´è¦æ³¨æ„å¯¹æ€§èƒ½çš„å½±å“ã€‚\n3. Map 3.1. New Map 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 type hmap struct { count int // count è¡¨ç¤ºå½“å‰å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡ï¼› flags uint8 B uint8 // B è¡¨ç¤ºå½“å‰å“ˆå¸Œè¡¨æŒæœ‰çš„ buckets æ•°é‡ï¼Œä½†æ˜¯å› ä¸ºå“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡éƒ½ 2 çš„å€æ•°ï¼Œæ‰€ä»¥è¯¥å­—æ®µä¼šå­˜å‚¨å¯¹æ•°ï¼Œä¹Ÿå°±æ˜¯ len(buckets) == 2^Bï¼› noverflow uint16 hash0 uint32 // hash0 æ˜¯å“ˆå¸Œçš„ç§å­ï¼Œå®ƒèƒ½ä¸ºå“ˆå¸Œå‡½æ•°çš„ç»“æœå¼•å…¥éšæœºæ€§ï¼Œè¿™ä¸ªå€¼åœ¨åˆ›å»ºå“ˆå¸Œè¡¨æ—¶ç¡®å®šï¼Œå¹¶åœ¨è°ƒç”¨å“ˆå¸Œå‡½æ•°æ—¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼› buckets unsafe.Pointer oldbuckets unsafe.Pointer // oldbuckets æ˜¯å“ˆå¸Œåœ¨æ‰©å®¹æ—¶ç”¨äºä¿å­˜ä¹‹å‰ buckets çš„å­—æ®µï¼Œå®ƒçš„å¤§å°æ˜¯å½“å‰ buckets çš„ä¸€åŠï¼› nevacuate uintptr extra *mapextra // æŒ‡å‘ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€ } type mapextra struct { overflow *[]*bmap // å·²ç»ä½¿ç”¨çš„æº¢å‡ºæ¡¶ oldoverflow *[]*bmap nextOverflow *bmap // ä¸‹ä¸€ä¸ªç©ºé—²çš„æº¢å‡ºæ¡¶ } hashmapçš„æ¡¶é‡‡ç”¨å¦‚ä¸‹æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªæ¡¶å¯ä»¥å­˜å‚¨8ä¸ªé”®å€¼å¯¹ï¼Œæ¡¶çš„æ•°é‡ä¸€å®šæ˜¯2^Bï¼Œ\nå¹¶é‡‡ç”¨\u0026amp;è¿ç®—ç¬¦æ¥é€‰æ‹©æ¡¶\n1 2 3 4 5 6 7 8 9 10 11 12 // A bucket for a Go map. type bmap struct { // tophash generally contains the top byte of the hash value // for each key in this bucket. If tophash[0] \u0026lt; minTopHash, // tophash[0] is a bucket evacuation state instead. tophash [bucketCnt]uint8 // Followed by bucketCnt keys and then bucketCnt elems. // NOTE: packing all the keys together and then all the elems together makes the // code a bit more complicated than alternating key/elem/key/elem/... but it allows // us to eliminate padding which would be needed for, e.g., map[int64]int8. // Followed by an overflow pointer. } åœ¨è¿è¡Œæ—¶ï¼Œbmapä¸­çš„å…¶ä»–å­—æ®µåœ¨è¿è¡Œæ—¶ä¹Ÿéƒ½æ˜¯é€šè¿‡è®¡ç®—å†…å­˜åœ°å€çš„æ–¹å¼è®¿é—®çš„ï¼Œå› ä¸ºkvçš„å…³ç³»\nè‡ªåŠ¨è½¬åŒ–æˆå¦‚ä¸‹æ•°æ®ç»“æ„ï¼Œä¸ºè¾¾åˆ°å†…å­˜å¯¹é½ï¼Œtopbitsï¼Œkeysï¼Œvaluesçš„æ•°ç»„åˆ†åˆ«æŒ‰å¦‚ä¸‹æ–¹å¼å­˜æ”¾\n1 2 3 4 5 6 7 type bmap struct { topbits [8]uint8 keys [8]keytype values [8]valuetype pad uintptr overflow uintptr // æŒ‡å‘ä¸‹ä¸€ä¸ªéœ€è¦æ‰©å®¹çš„æ¡¶ } ä½¿ç”¨å­—é¢é‡åˆå§‹åŒ–çš„æ–¹å¼æœ€ç»ˆéƒ½ä¼šé€šè¿‡maplitè¿›è¡Œåˆå§‹åŒ–ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func maplit(n *Node, m *Node, init *Nodes) { a := nod(OMAKE, nil, nil) a.Esc = n.Esc a.List.Set2(typenod(n.Type), nodintconst(int64(n.List.Len()))) litas(m, a, init) entries := n.List.Slice() if len(entries) \u0026gt; 25 { // For a large number of entries, put them in an array and loop. // build types [count]Tindex and [count]Tvalue tk := types.NewArray(n.Type.Key(), int64(len(entries))) te := types.NewArray(n.Type.Elem(), int64(len(entries))) ... return } // Build list of var[c] = expr. // Use temporaries so that mapassign1 can have addressable key, elem. ... } å½“å“ˆå¸Œè¡¨ä¸­çš„å…ƒç´ æ•°é‡å°‘äºæˆ–è€…ç­‰äº 25 ä¸ªæ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†å­—é¢é‡åˆå§‹åŒ–çš„ç»“æ„ä½“ä¼˜åŒ–ã€‚å°†æ‰€æœ‰çš„é”®å€¼å¯¹ä¸€æ¬¡åŠ å…¥åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚ä¸€æ—¦å“ˆå¸Œè¡¨ä¸­å…ƒç´ çš„æ•°é‡è¶…è¿‡äº† 25 ä¸ªï¼Œç¼–è¯‘å™¨ä¼šåˆ›å»ºä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨é”®å’Œå€¼ï¼Œè¿™äº›é”®å€¼å¯¹åˆ™ä¼šé€šè¿‡ for å¾ªç¯çš„æ–¹å¼åŠ å…¥å“ˆå¸Œã€‚\nè¿è¡Œæ—¶ï¼Œè°ƒç”¨makemapå‡½æ•°å®Œæˆmapåˆå§‹åŒ–ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func makemap(t *maptype, hint int, h *hmap) *hmap { mem, overflow := math.MulUintptr(uintptr(hint), t.bucket.size) if overflow || mem \u0026gt; maxAlloc { hint = 0 } if h == nil { h = new(hmap) } h.hash0 = fastrand() B := uint8(0) for overLoadFactor(hint, B) { B++ } h.B = B if h.B != 0 { var nextOverflow *bmap h.buckets, nextOverflow = makeBucketArray(t, h.B, nil) if nextOverflow != nil { h.extra = new(mapextra) h.extra.nextOverflow = nextOverflow } } return h } è®¡ç®—å“ˆå¸Œå ç”¨çš„å†…å­˜æ˜¯å¦æº¢å‡ºæˆ–è€…è¶…å‡ºèƒ½åˆ†é…çš„æœ€å¤§å€¼ï¼› è°ƒç”¨ runtime.fastrand è·å–ä¸€ä¸ªéšæœºçš„å“ˆå¸Œç§å­ï¼› æ ¹æ®ä¼ å…¥çš„ hint è®¡ç®—å‡ºéœ€è¦çš„æœ€å°éœ€è¦çš„æ¡¶çš„æ•°é‡ï¼› ä½¿ç”¨ runtime.makeBucketArray åˆ›å»ºç”¨äºä¿å­˜æ¡¶çš„æ•°ç»„ï¼› å…¶ä¸­makeBucketArrayä¼šä½¿ç”¨å¦‚ä¸‹æ–¹æ³•åˆ†é…è¿ç»­ç©ºé—´åˆå§‹åŒ–æ•°æ®\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func makeBucketArray(t *maptype, b uint8, dirtyalloc unsafe.Pointer) (buckets unsafe.Pointer, nextOverflow *bmap) { base := bucketShift(b) nbuckets := base if b \u0026gt;= 4 { // å¤§äº4ä¸ªï¼Œå¤§æ¦‚ç‡ä¼šå‘ç”Ÿæ‰©å®¹ï¼Œå…ˆåˆ†é…2^(b-4)ä¸ªç©ºæ¡¶ä»¥ä¾›å¤‡ç”¨ nbuckets += bucketShift(b - 4) sz := t.bucket.size * nbuckets up := roundupsize(sz) if up != sz { nbuckets = up / t.bucket.size } } buckets = newarray(t.bucket, int(nbuckets)) if base != nbuckets { nextOverflow = (*bmap)(add(buckets, base*uintptr(t.bucketsize))) last := (*bmap)(add(buckets, (nbuckets-1)*uintptr(t.bucketsize))) last.setoverflow(t, (*bmap)(buckets)) } return buckets, nextOverflow } 3.2. Map Access å½“å·¦ä¾§ä½¿ç”¨ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ¥æ”¶å€¼æ—¶ï¼Œåˆ†åˆ«ä¼šå¯¹åº”åˆ°ä¸¤ä¸ªæ–¹æ³•ï¼š\n1 2 v := hash[key] // =\u0026gt; v := *mapaccess1(maptype, hash, \u0026amp;key) v, ok := hash[key] // =\u0026gt; v, ok := mapaccess2(maptype, hash, \u0026amp;key) å…¶ä¸­ä¸¤ä¸ªå‡½æ•°å¦‚ä¸‹ï¼Œmapaccess2åœ¨æ³¨é‡Šä¸­åŠ å…¥ä¸¤ä¸ªæƒ…å†µçš„è¿”å›å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 func mapaccess1(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { alg := t.key.alg hash := alg.hash(key, uintptr(h.hash0)) m := bucketMask(h.B) b := (*bmap)(add(h.buckets, (hash\u0026amp;m)*uintptr(t.bucketsize))) top := tophash(hash) bucketloop: for ; b != nil; b = b.overflow(t) { for i := uintptr(0); i \u0026lt; bucketCnt; i++ { if b.tophash[i] != top { if b.tophash[i] == emptyRest { break bucketloop } continue } k := add(unsafe.Pointer(b), dataOffset+i*uintptr(t.keysize)) if alg.equal(key, k) { v := add(unsafe.Pointer(b), dataOffset+bucketCnt*uintptr(t.keysize)+i*uintptr(t.valuesize)) return v //, true } } } return unsafe.Pointer(\u0026amp;zeroVal[0]) //, false } 3.3. Map Grow å½“å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶å¼€å§‹å‘ç”ŸMapæ‰©å®¹ï¼Œæ¯æ¬¡æ‰©å®¹éƒ½ä¸ºåŸå…ˆçš„ä¸¤å€ï¼ŒåŸæ¥çš„æ¡¶ä¼šåˆ†æµåˆ°ä¸¤ä¸ªæ–°æ¡¶ä¸­\nè£…è½½å› å­å·²ç»è¶…è¿‡ 6.5ï¼›å…¶ä¸­è´Ÿè½½å› å­çš„å®šä¹‰å¦‚ä¸‹ï¼šLoadFactor = count / m å“ˆå¸Œä½¿ç”¨äº†å¤ªå¤šæº¢å‡ºæ¡¶ï¼› 1 2 3 4 5 6 7 8 func mapassign(t *maptype, h *hmap, key unsafe.Pointer) unsafe.Pointer { ... if !h.growing() \u0026amp;\u0026amp; (overLoadFactor(h.count+1, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) { hashGrow(t, h) goto again } ... } B \u0026lt;= 15ï¼Œè§¦å‘ç¿»å€æ‰©å®¹ï¼ŒB \u0026gt; 15ï¼Œè§¦å‘ç­‰é‡æ‰©å®¹ï¼ˆæœ‰è¾ƒå¤šé”®å€¼è¢«åˆ é™¤ï¼‰\n3.4. Map Delete Mapçš„åˆ é™¤é€»è¾‘ä¸å†™å…¥é€»è¾‘å¾ˆç›¸ä¼¼ï¼Œåªæ˜¯è§¦å‘å“ˆå¸Œçš„åˆ é™¤éœ€è¦ä½¿ç”¨å…³é”®å­—ï¼Œå¦‚æœåœ¨åˆ é™¤æœŸé—´é‡åˆ°äº†å“ˆå¸Œè¡¨çš„æ‰©å®¹ï¼Œå°±ä¼šåˆ†æµæ¡¶ä¸­çš„å…ƒç´ ï¼Œåˆ†æµç»“æŸä¹‹åä¼šæ‰¾åˆ°æ¡¶ä¸­çš„ç›®æ ‡å…ƒç´ å®Œæˆé”®å€¼å¯¹çš„åˆ é™¤å·¥ä½œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func walkexpr(n *Node, init *Nodes) *Node { switch n.Op { case ODELETE: init.AppendNodes(\u0026amp;n.Ninit) map_ := n.List.First() key := n.List.Second() map_ = walkexpr(map_, init) key = walkexpr(key, init) t := map_.Type fast := mapfast(t) if fast == mapslow { key = nod(OADDR, key, nil) } n = mkcall1(mapfndel(mapdelete[fast], t), nil, init, typename(t), map_, key) } } 4. String 4.1. New String 1 2 3 4 5 6 7 8 9 10 // StringHeader is the runtime representation of a string. // It cannot be used safely or portably and its representation may // change in a later release. // Moreover, the Data field is not sufficient to guarantee the data // it references will not be garbage collected, so programs must keep // a separate, correctly typed pointer to the underlying data. type StringHeader struct { Data uintptr Len int } // åˆ‡ç‰‡åœ¨ Go è¯­è¨€çš„è¿è¡Œæ—¶è¡¨ç¤ºä¸å­—ç¬¦ä¸²é«˜åº¦ç›¸ä¼¼ï¼Œç»å¸¸è®¤ä¸ºå­—ç¬¦ä¸²æ˜¯ä¸€ä¸ªåªè¯»çš„åˆ‡ç‰‡ç±»å‹ Go è¯­è¨€ä¸æ”¯æŒç›´æ¥ä¿®æ”¹ string ç±»å‹å˜é‡çš„å†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬ä»ç„¶å¯ä»¥é€šè¿‡åœ¨ string å’Œ []byte ç±»å‹ä¹‹é—´åå¤è½¬æ¢å®ç°ä¿®æ”¹è¿™ä¸€ç›®çš„ï¼š\nå…ˆå°†è¿™æ®µå†…å­˜æ‹·è´åˆ°å †æˆ–è€…æ ˆä¸Šï¼› å°†å˜é‡çš„ç±»å‹è½¬æ¢æˆ []byte åå¹¶ä¿®æ”¹å­—èŠ‚æ•°æ®ï¼› å°†ä¿®æ”¹åçš„å­—èŠ‚æ•°ç»„è½¬æ¢å› stringï¼› ä½¿ç”¨åå¼•å·åˆ›å»ºçš„å­—ç¬¦ä¸²ä¼šåœ¨ç¼–è¯‘æ—¶è¿›è¡Œè§£æ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func (s *scanner) stdString() { s.startLit() for { r := s.getr() if r == \u0026#39;\u0026#34;\u0026#39; { break } if r == \u0026#39;\\\\\u0026#39; { s.escape(\u0026#39;\u0026#34;\u0026#39;) continue } if r == \u0026#39;\\n\u0026#39; { s.ungetr() s.error(\u0026#34;newline in string\u0026#34;) break } if r \u0026lt; 0 { s.errh(s.line, s.col, \u0026#34;string not terminated\u0026#34;) break } } s.nlsemi = true s.lit = string(s.stopLit()) s.kind = StringLit s.tok = _Literal } æ ‡å‡†å­—ç¬¦ä¸²ä½¿ç”¨åŒå¼•å·è¡¨ç¤ºå¼€å¤´å’Œç»“å°¾ï¼› æ ‡å‡†å­—ç¬¦ä¸²éœ€è¦ä½¿ç”¨åæ–œæ  \\ æ¥é€ƒé€¸åŒå¼•å·ï¼› æ ‡å‡†å­—ç¬¦ä¸²ä¸èƒ½å‡ºç°å¦‚ä¸‹æ‰€ç¤ºçš„éšå¼æ¢è¡Œ \\nï¼› æ— è®ºæ˜¯æ ‡å‡†å­—ç¬¦ä¸²è¿˜æ˜¯åŸå§‹å­—ç¬¦ä¸²éƒ½ä¼šè¢«æ ‡è®°æˆ StringLit å¹¶ä¼ é€’åˆ°è¯­æ³•åˆ†æé˜¶æ®µã€‚åœ¨è¯­æ³•åˆ†æé˜¶æ®µï¼Œä¸å­—ç¬¦ä¸²ç›¸å…³çš„è¡¨è¾¾å¼éƒ½ä¼šç”±ä»¥ä¸‹å‡½æ•°å¤„ç†ã€‚\n1 2 3 4 5 6 7 8 9 10 func (p *noder) basicLit(lit *syntax.BasicLit) Val { switch s := lit.Value; lit.Kind { case syntax.StringLit: if len(s) \u0026gt; 0 \u0026amp;\u0026amp; s[0] == \u0026#39;`\u0026#39; { s = strings.Replace(s, \u0026#34;\\r\u0026#34;, \u0026#34;\u0026#34;, -1) } u, _ := strconv.Unquote(s) return Val{U: u} } } 4.2. Concat String åœ¨ç¼–è¯‘çš„ASTé˜¶æ®µï¼Œè°ƒç”¨strings.Joinå‡½æ•°æ¥å®Œæˆå­—ç¬¦ä¸²å¸¸é‡æ•°ç»„çš„æ‹¼æ¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func concatstrings(buf *tmpBuf, a []string) string { idx := 0 l := 0 count := 0 for i, x := range a { n := len(x) if n == 0 { continue } l += n count++ idx = i } if count == 0 { return \u0026#34;\u0026#34; } if count == 1 \u0026amp;\u0026amp; (buf != nil || !stringDataOnStack(a[idx])) { return a[idx] } s, b := rawstringtmp(buf, l) for _, x := range a { copy(b, x) b = b[len(x):] } return s } ä½†æ˜¯åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ copy å°†è¾“å…¥çš„å¤šä¸ªå­—ç¬¦ä¸²æ‹·è´åˆ°ç›®æ ‡å­—ç¬¦ä¸²æ‰€åœ¨çš„å†…å­˜ç©ºé—´ã€‚æ–°çš„å­—ç¬¦ä¸²æ˜¯ä¸€ç‰‡æ–°çš„å†…å­˜ç©ºé—´ï¼Œä¸åŸæ¥çš„å­—ç¬¦ä¸²ä¹Ÿæ²¡æœ‰ä»»ä½•å…³è”ï¼Œä¸€æ—¦éœ€è¦æ‹¼æ¥çš„å­—ç¬¦ä¸²éå¸¸å¤§ï¼Œæ‹·è´å¸¦æ¥çš„æ€§èƒ½æŸå¤±æ˜¯æ— æ³•å¿½ç•¥çš„ã€‚\n4.3. Type Cast 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func slicebytetostring(buf *tmpBuf, b []byte) (str string) { l := len(b) if l == 0 { return \u0026#34;\u0026#34; } if l == 1 { stringStructOf(\u0026amp;str).str = unsafe.Pointer(\u0026amp;staticbytes[b[0]]) stringStructOf(\u0026amp;str).len = 1 return } var p unsafe.Pointer if buf != nil \u0026amp;\u0026amp; len(b) \u0026lt;= len(buf) { p = unsafe.Pointer(buf) } else { p = mallocgc(uintptr(len(b)), nil, false) } stringStructOf(\u0026amp;str).str = p stringStructOf(\u0026amp;str).len = len(b) memmove(p, (*(*slice)(unsafe.Pointer(\u0026amp;b))).array, uintptr(len(b))) return } å¤„ç†è¿‡åä¼šæ ¹æ®ä¼ å…¥çš„ç¼“å†²åŒºå¤§å°å†³å®šæ˜¯å¦éœ€è¦ä¸ºæ–°å­—ç¬¦ä¸²åˆ†é…ä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œruntime.stringStructOf ä¼šå°†ä¼ å…¥çš„å­—ç¬¦ä¸²æŒ‡é’ˆè½¬æ¢æˆ runtime.stringStruct ç»“æ„ä½“æŒ‡é’ˆï¼Œç„¶åè®¾ç½®ç»“æ„ä½“æŒæœ‰çš„å­—ç¬¦ä¸²æŒ‡é’ˆ str å’Œé•¿åº¦ lenï¼Œæœ€åé€šè¿‡ runtime.memmove å°†åŸ []byte ä¸­çš„å­—èŠ‚å…¨éƒ¨å¤åˆ¶åˆ°æ–°çš„å†…å­˜ç©ºé—´ä¸­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 func stringtoslicebyte(buf *tmpBuf, s string) []byte { var b []byte if buf != nil \u0026amp;\u0026amp; len(s) \u0026lt;= len(buf) { *buf = tmpBuf{} b = buf[:len(s)] } else { b = rawbyteslice(len(s)) } copy(b, s) return b } å½“ä¼ å…¥ç¼“å†²åŒºæ—¶ï¼Œå®ƒä¼šä½¿ç”¨ä¼ å…¥çš„ç¼“å†²åŒºå­˜å‚¨ []byteï¼› å½“æ²¡æœ‰ä¼ å…¥ç¼“å†²åŒºæ—¶ï¼Œè¿è¡Œæ—¶ä¼šè°ƒç”¨ runtime.rawbyteslice åˆ›å»ºæ–°çš„å­—èŠ‚åˆ‡ç‰‡å¹¶å°†å­—ç¬¦ä¸²ä¸­çš„å†…å®¹æ‹·è´è¿‡å»ï¼›\n","date":"2021-09-02T19:22:24+08:00","image":"https://chasing1020.github.io/post/go1-builtin-data-structure/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go1-builtin-data-structure/","title":"Go(1) Builtin Data Structure"},{"content":"Part0. Compilers Principles 1. Stage ç¼–è¯‘å™¨æŠ€æœ¯å½±å“äº†è®¡ç®—æœºçš„ä½“ç³»ç»“æ„ï¼ŒåŒæ—¶ä¹Ÿå—åˆ°ä½“ç³»ç»“æ„å‘å±•çš„å½±å“ã€‚\nä½“ç³»ç»“æ„çš„å¾ˆå¤šç°ä»£åˆ›æ–°éƒ½ä¾èµ–äºç¼–è¯‘å™¨èƒ½ä»æºç¨‹åºä¸­æŠ½å–å‡ºæœ‰æ•ˆåˆ©ç”¨ç¡¬ä»¶èƒ½åŠ›çš„æœºä¼šã€‚\nGoè¯­è¨€çš„ç¼–è¯‘æ‰§è¡Œæµç¨‹é˜¶æ®µï¼šè¯æ³•è§£æã€è¯­æ³•åˆ†æã€ASTæ„å»ºã€ç±»å‹æ£€æŸ¥ã€å˜é‡æ•è·ã€å‡½æ•°å†…è”ã€é€ƒé€¸åˆ†æã€é—­åŒ…é‡å†™ã€éå†å‡½æ•°ã€SSAç”Ÿæˆã€æœºå™¨ç ç”Ÿæˆã€‚\n2. Lexical Analysis Lex æ˜¯ç”¨äºç”Ÿæˆè¯æ³•åˆ†æå™¨çš„å·¥å…·ï¼ŒLex ç”Ÿæˆçš„ä»£ç èƒ½å¤Ÿå°†ä¸€ä¸ªæ–‡ä»¶ä¸­çš„å­—ç¬¦åˆ†è§£æˆ Token åºåˆ—ï¼Œå¾ˆå¤šè¯­è¨€åœ¨è®¾è®¡æ—©æœŸéƒ½ä¼šä½¿ç”¨å®ƒå¿«é€Ÿè®¾è®¡å‡ºåŸå‹ã€‚è¯æ³•åˆ†æä½œä¸ºå…·æœ‰å›ºå®šæ¨¡å¼çš„ä»»åŠ¡ï¼Œå‡ºç°è¿™ç§æ›´æŠ½è±¡çš„å·¥å…·å¿…ç„¶çš„ï¼ŒLex ä½œä¸ºä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œä½¿ç”¨äº†ç±»ä¼¼ C è¯­è¨€çš„è¯­æ³•ï¼Œå¯ä»¥å°† Lex ç†è§£ä¸ºæ­£åˆ™åŒ¹é…çš„ç”Ÿæˆå™¨ï¼Œå®ƒä¼šä½¿ç”¨æ­£åˆ™åŒ¹é…æ‰«æè¾“å…¥çš„å­—ç¬¦æµã€‚è¿™é‡Œä»¥æœ€ç®€å•çš„helloworldç¨‹åºä¸ºä¾‹ï¼š\n1 2 3 4 5 6 7 8 9 package main import ( \u0026#34;fmt\u0026#34; ) func main() { fmt.Println(\u0026#34;Hello, world!\u0026#34;) } ä½¿ç”¨lexå‘½ä»¤è½¬åŒ–ä¸ºCè¯­è¨€ä»£ç ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 int yylex (void) { ... while ( 1 ) { ... yy_match: do { register YY_CHAR yy_c = yy_ec[YY_SC_TO_UI(*yy_cp)]; if ( yy_accept[yy_current_state] ) { (yy_last_accepting_state) = yy_current_state; (yy_last_accepting_cpos) = yy_cp; } while ( yy_chk[yy_base[yy_current_state] + yy_c] != yy_current_state ) { yy_current_state = (int) yy_def[yy_current_state]; if ( yy_current_state \u0026gt;= 30 ) yy_c = yy_meta[(unsigned int) yy_c]; } yy_current_state = yy_nxt[yy_base[yy_current_state] + (unsigned int) yy_c]; ++yy_cp; } while ( yy_base[yy_current_state] != 37 ); ... do_action: switch ( yy_act ) case 0: ... case 1: YY_RULE_SETUP printf(\u0026#34;PACKAGE \u0026#34;); YY_BREAK ... } é™¤äº†åŸºæœ¬çš„å®å®šä¹‰ä»¥å¤–ï¼Œå…¨éƒ¨å‡½æ•°éƒ½ä½¿ç”¨æœ‰é™è‡ªåŠ¨æœºæ¨¡å‹æ¥è§£æè¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œå°†ä¸Šè¿°Goä»£ç ä½œä¸ºlexè¾“å…¥å¯å¾—ï¼š\n1 2 3 4 5 6 7 8 9 PACKAGE IDENT IMPORT LPAREN QUOTE IDENT QUOTE RPAREN IDENT IDENT LPAREN RPAREN LBRACE IDENT DOT IDENT LPAREN QUOTE IDENT QUOTE RPAREN RBRACE Goè¯­è¨€çš„è¯æ³•è§£æé€šè¿‡scannerç»“æ„ä½“å®ç°\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 type scanner struct { source mode uint nlsemi bool // current token, valid after calling next() line, col uint blank bool // line is blank up to col tok token lit string // valid if tok is _Name, _Literal, or _Semi (\u0026#34;semicolon\u0026#34;, \u0026#34;newline\u0026#34;, or \u0026#34;EOF\u0026#34;); may be malformed if bad is true bad bool // valid if tok is _Literal, true if a syntax error occurred, lit may be malformed kind LitKind // valid if tok is _Literal op Operator // valid if tok is _Operator, _AssignOp, or _IncOp prec int // valid if tok is _Operator, _AssignOp, or _IncOp } å…¶å®šä¹‰çš„nextè·å–æœªè§£æçš„ä¸‹ä¸€ä¸ªå­—ç¬¦ï¼Œæ ¹æ®å­—ç¬¦ç±»å‹å†³å®šä¸‹ä¸€ä¸ªcaseã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 func (s *scanner) next() { ... s.stop() startLine, startCol := s.pos() for s.ch == \u0026#39; \u0026#39; || s.ch == \u0026#39;\\t\u0026#39; || s.ch == \u0026#39;\\n\u0026#39; \u0026amp;\u0026amp; !nlsemi || s.ch == \u0026#39;\\r\u0026#39; { s.nextch() } s.line, s.col = s.pos() s.blank = s.line \u0026gt; startLine || startCol == colbase s.start() if isLetter(s.ch) || s.ch \u0026gt;= utf8.RuneSelf \u0026amp;\u0026amp; s.atIdentChar(true) { s.nextch() s.ident() return } switch s.ch { case -1: s.tok = _EOF case \u0026#39;0\u0026#39;, \u0026#39;1\u0026#39;, \u0026#39;2\u0026#39;, \u0026#39;3\u0026#39;, \u0026#39;4\u0026#39;, \u0026#39;5\u0026#39;, \u0026#39;6\u0026#39;, \u0026#39;7\u0026#39;, \u0026#39;8\u0026#39;, \u0026#39;9\u0026#39;: s.number(false) ... } } æ­¤å¤–ï¼Œåœ¨go/scannerå’Œgo/tokenä¹Ÿæä¾›äº†ä¸€äº›æ¥å£ç”¨ä»¥æ‰«ææºä»£ç ï¼Œç¤ºä¾‹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func main() { src := []byte(\u0026#34;cos(x)+2i*sin(x)\u0026#34;) //So God exists var s scanner.Scanner fset := token.NewFileSet() file := fset.AddFile(\u0026#34;\u0026#34;, fset.Base(), len(src)) s.Init(file, src, nil, scanner.ScanComments) for { pos, tok, lit := s.Scan() if tok == token.EOF { break } fmt.Printf(\u0026#34;%s\\t%s\\t%q\\n\u0026#34;, fset.Position(pos), tok, lit) } } 3. Syntax Analysis 3.1. Definition ä¸€èˆ¬ä½¿ç”¨ä¸€ä¸ªå››å…ƒç»„(N, Î£, P, S)æ¥å®šä¹‰ä¸€ä¸ªæ–‡æ³•ï¼Œå…¶ä½œä¸ºå½¢å¼åŒ–æè¿°è¯­è¨€çš„æœ‰æ•ˆå·¥å…·ã€‚\nN æœ‰é™ä¸ªéç»ˆç»“ç¬¦çš„é›†åˆï¼› Î£ æœ‰é™ä¸ªç»ˆç»“ç¬¦çš„é›†åˆï¼› P æœ‰é™ä¸ªç”Ÿäº§è§„åˆ™çš„é›†åˆï¼› S éç»ˆç»“ç¬¦é›†åˆä¸­å”¯ä¸€çš„å¼€å§‹ç¬¦å·ï¼› æ¯ä¸€ä¸ªGoè¯­è¨€æºç è¢«ç¼–è¯‘ä¸ºASTæ—¶ï¼Œå…¶æœ€é¡¶å±‚çš„ç»“æ„éƒ½æ˜¯SourceFile\n1 SourceFile = PackageClause \u0026#34;;\u0026#34; { ImportDecl \u0026#34;;\u0026#34; } { TopLevelDecl \u0026#34;;\u0026#34; } . æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½åŒ…å«ä¸€ä¸ª package çš„å®šä¹‰ä»¥åŠå¯é€‰çš„ import å£°æ˜å’Œå…¶ä»–çš„é¡¶å±‚å£°æ˜ï¼Œå…¶è¿˜åŒ…æ‹¬syntaxç»“æ„ä½“ã€‚\næœ€é¡¶å±‚çš„å£°ååŒ…æ‹¬äº†äº”å¤§åŸºæœ¬ç±»å‹ï¼šå¸¸é‡ã€ç±»å‹ã€å˜é‡ã€å‡½æ•°ã€æ–¹æ³•\n1 2 3 4 5 6 7 8 9 10 ConstDecl = \u0026#34;const\u0026#34; ( ConstSpec | \u0026#34;(\u0026#34; { ConstSpec \u0026#34;;\u0026#34; } \u0026#34;)\u0026#34; ) . ConstSpec = IdentifierList [ [ Type ] \u0026#34;=\u0026#34; ExpressionList ] . TypeDecl = \u0026#34;type\u0026#34; ( TypeSpec | \u0026#34;(\u0026#34; { TypeSpec \u0026#34;;\u0026#34; } \u0026#34;)\u0026#34; ) . TypeSpec = AliasDecl | TypeDef . AliasDecl = identifier \u0026#34;=\u0026#34; Type . TypeDef = identifier Type . VarDecl = \u0026#34;var\u0026#34; ( VarSpec | \u0026#34;(\u0026#34; { VarSpec \u0026#34;;\u0026#34; } \u0026#34;)\u0026#34; ) . VarSpec = IdentifierList ( Type [ \u0026#34;=\u0026#34; ExpressionList ] | \u0026#34;=\u0026#34; ExpressionList ) . æ­¤å³å¯¹åº”ç€constã€type å’Œ varï¼Œè€Œå‡½æ•°å’Œå‡½æ•°å’Œæ–¹æ³•çš„å®šä¹‰å°±æ›´åŠ å¤æ‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 FunctionDecl = \u0026#34;func\u0026#34; FunctionName Signature [ FunctionBody ] . FunctionName = identifier . FunctionBody = Block . MethodDecl = \u0026#34;func\u0026#34; Receiver MethodName Signature [ FunctionBody ] . Receiver = Parameters . Block = \u0026#34;{\u0026#34; StatementList \u0026#34;}\u0026#34; . StatementList = { Statement \u0026#34;;\u0026#34; } . Statement = Declaration | LabeledStmt | SimpleStmt | GoStmt | ReturnStmt | BreakStmt | ContinueStmt | GotoStmt | FallthroughStmt | Block | IfStmt | SwitchStmt | SelectStmt | ForStmt | DeferStmt . SimpleStmt = EmptyStmt | ExpressionStmt | SendStmt | IncDecStmt | Assignment | ShortVarDecl . è¿™é‡Œçš„è¯­æ³•ç»“æ„å°±å¯¹åº”äº†å¸¸è§çš„ switch/caseã€if/elseã€for å¾ªç¯ä»¥åŠ select ç­‰è¯­å¥ã€‚\nè¿™é‡Œå†æ¬¡ä»¥åŸºç¡€çš„ç¨‹åºä¸ºç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 package main // PkgName import \u0026#34;fmt\u0026#34; // ImportDecl const word = \u0026#34;world!\u0026#34; // ConstDecl type mystr string // TypeDecl var hello mystr = \u0026#34;Hello, \u0026#34; + world // VarDecl func main() { fmt.Println(hello) // FuncDecl -\u0026gt; CallExpr //-\u0026gt; SelectorExpr(Name:fmt, Name:Println), Name = hello } åœ¨æ‰§è¡Œè¯­æ³•åˆ†æçš„è¿‡ç¨‹ä¸­ï¼Œå¸¸è§ä¸¤ç§æ–¹æ³•ï¼š\nè‡ªé¡¶å‘ä¸‹ï¼šå¯ä»¥è¢«çœ‹ä½œæ‰¾åˆ°å½“å‰è¾“å…¥æµæœ€å·¦æ¨å¯¼çš„è¿‡ç¨‹ï¼Œå¯¹äºä»»æ„ä¸€ä¸ªè¾“å…¥æµï¼Œæ ¹æ®å½“å‰çš„è¾“å…¥ç¬¦å·ï¼Œç¡®å®šä¸€ä¸ªç”Ÿäº§è§„åˆ™ï¼Œä½¿ç”¨ç”Ÿäº§è§„åˆ™å³ä¾§çš„ç¬¦å·æ›¿ä»£ç›¸åº”çš„éç»ˆç»“ç¬¦å‘ä¸‹æ¨å¯¼\nè‡ªåº•å‘ä¸Šï¼šè¯­æ³•åˆ†æå™¨ä»è¾“å…¥æµå¼€å§‹ï¼Œæ¯æ¬¡éƒ½å°è¯•é‡å†™æœ€å³ä¾§çš„å¤šä¸ªç¬¦å·ï¼Œè¿™å…¶å®æ˜¯è¯´è§£æå™¨ä¼šä»æœ€ç®€å•çš„ç¬¦å·è¿›è¡Œæ¨å¯¼ï¼Œåœ¨è§£æçš„æœ€ååˆå¹¶æˆå¼€å§‹ç¬¦å·\nå’Œå¤§å¤šæ•°è¯­è¨€ä¸€æ ·ï¼ŒGoè¯­è¨€çš„è§£æå™¨ä½¿ç”¨äº† LALR(1) çš„æ–‡æ³•æ¥è§£æè¯æ³•åˆ†æè¿‡ç¨‹ä¸­è¾“å‡ºçš„ Token åºåˆ—ã€‚\n3.2. AST å¯¹äºGoæºæ–‡ä»¶çš„æ¯ä¸€ä¸ªimportï¼Œtypeï¼Œconstï¼Œfuncéƒ½æ˜¯ä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€‚åœ¨æ­¤ä¹‹ä¸‹åŒ…å«å½“å‰å£°æ˜çš„å­èŠ‚ç‚¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 // noder transforms package syntax\u0026#39;s AST into a Node tree. type noder struct { posMap file *syntax.File linknames []linkname pragcgobuf [][]string err chan syntax.Error importedUnsafe bool importedEmbed bool trackScopes bool funcState *funcState } åˆ©ç”¨declså°†æºæ–‡ä»¶çš„æ‰€æœ‰å£°æ˜è¯­å¥è½¬æ¢ä¸ºNodeæ•°ç»„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 func (p *noder) decls(decls []syntax.Decl) (l []ir.Node) { var cs constState for _, decl := range decls { p.setlineno(decl) switch decl := decl.(type) { case *syntax.ImportDecl: p.importDecl(decl) case *syntax.VarDecl: l = append(l, p.varDecl(decl)...) case *syntax.ConstDecl: l = append(l, p.constDecl(decl, \u0026amp;cs)...) case *syntax.TypeDecl: l = append(l, p.typeDecl(decl)) case *syntax.FuncDecl: l = append(l, p.funcDecl(decl)) default: panic(\u0026#34;unhandled Decl\u0026#34;) } } return } stringer å……åˆ†åˆ©ç”¨äº† Go è¯­è¨€æ ‡å‡†åº“å¯¹ç¼–è¯‘å™¨å„ç§èƒ½åŠ›çš„æ”¯æŒï¼Œå…¶ä¸­åŒ…æ‹¬ç”¨äºè§£ææŠ½è±¡è¯­æ³•æ ‘çš„ go/astã€ç”¨äºæ ¼å¼åŒ–ä»£ç çš„ go/fmtç­‰ï¼ŒGo é€šè¿‡æ ‡å‡†åº“ä¸­çš„è¿™äº›åŒ…å¯¹å¤–ç›´æ¥æä¾›äº†ç¼–è¯‘å™¨çš„ç›¸å…³èƒ½åŠ›ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ç›´æ¥åœ¨å®ƒä»¬ä¸Šé¢æ„å»ºå¤æ‚çš„ä»£ç ç”Ÿæˆæœºåˆ¶å¹¶å®æ–½å…ƒç¼–ç¨‹æŠ€æœ¯ã€‚\nä½œä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œstringer å‘½ä»¤çš„å…¥å£å°±æ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„ golang/tools/main.mainå‡½æ•°ï¼Œåœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆå§‹åŒ–äº†ä¸€ä¸ªç”¨äºè§£ææºæ–‡ä»¶å’Œç”Ÿæˆä»£ç çš„ golang/tools/main.Generatorï¼Œç„¶åå¼€å§‹æ‹¼æ¥ç”Ÿæˆçš„æ–‡ä»¶ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 func main() { types := strings.Split(*typeNames, \u0026#34;,\u0026#34;) ... g := Generator{ trimPrefix: *trimprefix, lineComment: *linecomment, } ... g.Printf(\u0026#34;// Code generated by \\\u0026#34;stringer %s\\\u0026#34;; DO NOT EDIT.\\n\u0026#34;, strings.Join(os.Args[1:], \u0026#34; \u0026#34;)) g.Printf(\u0026#34;\\n\u0026#34;) g.Printf(\u0026#34;package %s\u0026#34;, g.pkg.name) g.Printf(\u0026#34;\\n\u0026#34;) g.Printf(\u0026#34;import \\\u0026#34;strconv\\\u0026#34;\\n\u0026#34;) for _, typeName := range types { g.generate(typeName) } src := g.format() baseName := fmt.Sprintf(\u0026#34;%s_string.go\u0026#34;, types[0]) outputName = filepath.Join(dir, strings.ToLower(baseName)) if err := ioutil.WriteFile(outputName, src, 0644); err != nil { log.Fatalf(\u0026#34;writing output: %s\u0026#34;, err) } } ä»è¿™æ®µä»£ç ä¸­æˆ‘ä»¬èƒ½çœ‹åˆ°æœ€ç»ˆç”Ÿæˆæ–‡ä»¶çš„è½®å»“ï¼Œæœ€ä¸Šé¢çš„è°ƒç”¨çš„å‡ æ¬¡ golang/tools/main.Generator.Printf ä¼šåœ¨å†…å­˜ä¸­å†™å…¥æ–‡ä»¶å¤´çš„æ³¨é‡Šã€å½“å‰åŒ…åä»¥åŠå¼•å…¥çš„åŒ…ç­‰ï¼Œéšåä¼šä¸ºå¾…å¤„ç†çš„ç±»å‹ä¾æ¬¡è°ƒç”¨ golang/tools/main.Generator.generateï¼Œè¿™é‡Œä¼šç”Ÿæˆä¸€ä¸ªç­¾åä¸º _ çš„å‡½æ•°ï¼Œé€šè¿‡ç¼–è¯‘å™¨ä¿è¯æšä¸¾ç±»å‹çš„å€¼ä¸ä¼šæ”¹å˜ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 func (g *Generator) generate(typeName string) { values := make([]Value, 0, 100) for _, file := range g.pkg.files { file.typeName = typeName file.values = nil if file.file != nil { ast.Inspect(file.file, file.genDecl) values = append(values, file.values...) } } g.Printf(\u0026#34;func _() {\\n\u0026#34;) g.Printf(\u0026#34;\\t// An \\\u0026#34;invalid array index\\\u0026#34; compiler error signifies that the constant values have changed.\\n\u0026#34;) g.Printf(\u0026#34;\\t// Re-run the stringer command to generate them again.\\n\u0026#34;) g.Printf(\u0026#34;\\tvar x [1]struct{}\\n\u0026#34;) for _, v := range values { g.Printf(\u0026#34;\\t_ = x[%s - %s]\\n\u0026#34;, v.originalName, v.str) } g.Printf(\u0026#34;}\\n\u0026#34;) runs := splitIntoRuns(values) switch { case len(runs) == 1: g.buildOneRun(runs, typeName) ... } } éšåè°ƒç”¨çš„ golang/tools/main.Generator.buildOneRun ä¼šç”Ÿæˆä¸¤ä¸ªå¸¸é‡çš„å£°æ˜è¯­å¥å¹¶ä¸ºç±»å‹å®šä¹‰ String æ–¹æ³•ï¼Œå…¶ä¸­å¼•ç”¨çš„ stringOneRun å¸¸é‡æ˜¯æ–¹æ³•çš„æ¨¡æ¿ï¼Œä¸ Web æœåŠ¡çš„å‰ç«¯ HTML æ¨¡æ¿æ¯”è¾ƒç›¸ä¼¼ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 func (g *Generator) buildOneRun(runs [][]Value, typeName string) { values := runs[0] g.Printf(\u0026#34;\\n\u0026#34;) g.declareIndexAndNameVar(values, typeName) g.Printf(stringOneRun, typeName, usize(len(values)), \u0026#34;\u0026#34;) } const stringOneRun = func (i %[1]s) String() string { if %[3]si \u0026gt;= %[1]s(len(_%[1]s_index)-1) { return \u0026#34;%[1]s(\u0026#34; + strconv.FormatInt(int64(i), 10) + \u0026#34;)\u0026#34; } return _%[1]s_name[_%[1]s_index[i]:_%[1]s_index[i+1]] } æ•´ä¸ªç”Ÿæˆä»£ç çš„è¿‡ç¨‹å°±æ˜¯ä½¿ç”¨ç¼–è¯‘å™¨æä¾›çš„åº“è§£ææºæ–‡ä»¶å¹¶æŒ‰ç…§å·²æœ‰çš„æ¨¡æ¿ç”Ÿæˆæ–°çš„ä»£ç ï¼Œè¿™ä¸ Web æœåŠ¡ä¸­åˆ©ç”¨æ¨¡æ¿ç”Ÿæˆ HTML æ–‡ä»¶æ²¡æœ‰å¤ªå¤šçš„åŒºåˆ«ï¼Œåªæ˜¯ç”Ÿæˆæ–‡ä»¶çš„ç”¨é€”ç¨å¾®æœ‰ä¸€äº›ä¸åŒã€‚\n4. After AST 4.1. Type Checker åœ¨å®ŒæˆASTçš„æ„å»ºåï¼Œä¼šå¯¹ä¸€äº›ç±»å‹åšç‰¹åˆ«çš„è¯­æ³•å’Œè¯­ä¹‰æ£€æŸ¥ï¼Œå…¶ä¸ä»…ä½¿ç”¨é™æ€ç±»å‹æ£€æŸ¥æ¥ä¿è¯ç¨‹åºè¿è¡Œçš„ç±»å‹å®‰å…¨ï¼Œè¿˜ä¼šåœ¨ç¼–ç¨‹æœŸé—´å¼•å…¥ç±»å‹ä¿¡æ¯ï¼Œè®©å·¥ç¨‹å¸ˆèƒ½å¤Ÿä½¿ç”¨åå°„æ¥åˆ¤æ–­å‚æ•°å’Œå˜é‡çš„ç±»å‹ã€‚å½“æˆ‘ä»¬æƒ³è¦å°† interface{} è½¬æ¢æˆå…·ä½“ç±»å‹æ—¶ä¼šè¿›è¡ŒåŠ¨æ€ç±»å‹æ£€æŸ¥ï¼Œå¦‚æœæ— æ³•å‘ç”Ÿè½¬æ¢å°±ä¼šå‘ç”Ÿç¨‹åºå´©æºƒã€‚\næ­¤å¤–ï¼Œè¿™ä¸ªé˜¶æ®µè¿˜ä¼šè¿›è¡Œç¼–è¯‘æ—¶å¸¸é‡ï¼Œæ ‡è¯†ç¬¦å£°æ˜ç»‘å®šç­‰ã€‚\n4.2. Variable Capturing å®Œæˆç±»å‹æ£€æŸ¥åï¼Œç¼–è¯‘å™¨ä¼šå¯¹ASTåˆ†æé‡æ„ï¼Œå®Œæˆä¸€äº›åˆ—ä¼˜åŒ–ï¼Œè¿™éƒ¨åˆ†ä¸»è¦é’ˆå¯¹Closureså®ç°ï¼Œä¼šä¸“é—¨æ£€æŸ¥é—­åŒ…å˜é‡æ•è·çš„æƒ…å†µã€‚\n4.3. Function Inline å‡½æ•°è°ƒç”¨çš„ä¸»è¦æˆæœ¬åœ¨äºå‚æ•°ä¸è¿”å›å€¼çš„æ ˆå¤åˆ¶ï¼Œè¾ƒå°çš„æ ˆå¯„å­˜å™¨å¼€é”€ä»¥åŠå‡½æ•°åºè¨€éƒ¨åˆ†æ£€æŸ¥æ ˆæ‰©å®¹ç­‰ã€‚\nGoç¼–è¯‘å™¨ä¼šå¯¹å‡½æ•°å†…è”æˆæœ¬åšä¼°è®¡ï¼Œå½“å‡½æ•°æœ‰forï¼Œrangeï¼Œgoï¼Œselectï¼Œé€’å½’è°ƒç”¨ï¼Œå­˜åœ¨//go:noinlineè¿™ç§ç¼–è¯‘å™¨æŒ‡ç¤ºæ—¶ï¼Œç¼–è¯‘å™¨ä¸ä¼šè¿›è¡Œä¼˜åŒ–ã€‚è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæ·»åŠ -gcflags=\u0026quot;-l\u0026quot;ä¹Ÿä¸ä¼šå‘ç”Ÿå†…è”ã€‚åœ¨ç¼–è¯‘æ—¶ï¼Œæ·»åŠ -m=2å¯ä»¥æŸ¥çœ‹ä¸ä¼šè¢«å†…è”çš„åŸå› \n1 2 3 4 5 6 func fib(index int) int { if index \u0026lt; 2 { return index } return fib(index-1) + fib(index-2) //cannot inline fib: recursive } é™„å…¶ä½™ç¼–è¯‘å™¨æŒ‡ç¤ºï¼š\n//go:noescape æŒ‡ä»¤åé¢å¿…é¡»è·Ÿä¸€ä¸ªæ²¡æœ‰ä¸»ä½“çš„å‡½æ•°å£°æ˜ï¼ˆæ„å‘³ç€è¯¥å‡½æ•°çš„å®ç°ä¸æ˜¯ç”¨ Go ç¼–å†™çš„ï¼‰\n//go:uintptrescapes æŒ‡ä»¤åé¢å¿…é¡»è·Ÿä¸€ä¸ªå‡½æ•°å£°æ˜ã€‚å®ƒæŒ‡å®šå‡½æ•°çš„ uintptr å‚æ•°å¯èƒ½æ˜¯å·²è½¬æ¢ä¸º uintptr çš„æŒ‡é’ˆå€¼ï¼Œå¹¶ä¸”å¿…é¡»ç”±åƒåœ¾æ”¶é›†å™¨è¿›è¡Œå¤„ç†ã€‚\n//go:noinline æŒ‡ä»¤åé¢å¿…é¡»è·Ÿä¸€ä¸ªå‡½æ•°å£°æ˜ã€‚å®ƒæŒ‡å®šä¸åº”å†…è”å¯¹å‡½æ•°çš„è°ƒç”¨ï¼Œä»è€Œè¦†ç›–ç¼–è¯‘å™¨çš„é€šå¸¸ä¼˜åŒ–è§„åˆ™ã€‚è¿™é€šå¸¸ä»…åœ¨ç‰¹æ®Šè¿è¡Œæ—¶å‡½æ•°æˆ–è°ƒè¯•ç¼–è¯‘å™¨æ—¶éœ€è¦ã€‚\n//go:norace æŒ‡ä»¤åé¢å¿…é¡»è·Ÿä¸€ä¸ªå‡½æ•°å£°æ˜ã€‚å®ƒæŒ‡å®šç«äº‰æ£€æµ‹å™¨å¿…é¡»å¿½ç•¥å‡½æ•°çš„å†…å­˜è®¿é—®ã€‚è¿™æœ€å¸¸ç”¨äºåœ¨è°ƒç”¨ç«äº‰æ£€æµ‹å™¨è¿è¡Œæ—¶ä¸å®‰å…¨æ—¶è°ƒç”¨çš„ä½çº§ä»£ç ã€‚\n//go:nosplit æŒ‡ä»¤åé¢å¿…é¡»è·Ÿä¸€ä¸ªå‡½æ•°å£°æ˜ã€‚å®ƒæŒ‡å®šå‡½æ•°å¿…é¡»çœç•¥å…¶é€šå¸¸çš„å †æ ˆæº¢å‡ºæ£€æŸ¥ã€‚è¿™æœ€å¸¸ç”¨äºåœ¨è°ƒç”¨ goroutine è¢«æŠ¢å æ˜¯ä¸å®‰å…¨çš„æ—¶å€™è°ƒç”¨çš„ä½çº§è¿è¡Œæ—¶ä»£ç ã€‚\n4.4. Escape Analysis Goçš„å†…å­˜æ¨¡å‹ä¸¥æ ¼è¦æ±‚æ ˆçš„å¯¹è±¡æŒ‡é’ˆä¸èƒ½å­˜æ”¾åˆ°å †ä¸­ï¼Œæ ˆä¸Šå¯¹è±¡çš„æŒ‡é’ˆä¸èƒ½è¶…è¿‡è¯¥æ ˆå¯¹è±¡çš„å£°æ˜å‘¨æœŸã€‚\né€šè¿‡å¯¹ASTçš„é™æ€æ•°æ®æµåˆ†æï¼ˆstatic data-flow analysisï¼‰ï¼Œå¯ä»¥å®ç°å¸¦æƒé‡æœ‰å‘å›¾çš„åˆ†ææ¥åšé€ƒé€¸åˆ¤æ–­ã€‚è¢«å¼•ç”¨çš„å¯¹è±¡æƒé‡-1ï¼ˆå³\u0026amp;ï¼‰ï¼Œè€Œæƒé‡å¤§äº0åˆ™è¡¨ç¤ºå­˜åœ¨è§£å¼•ç”¨æ“ä½œï¼ˆå³*ï¼‰ï¼Œå¯¹äºå°äº0ä¸”è¶…è¿‡äº†å½“å‰ç”Ÿå‘½å‘¨æœŸçš„å˜é‡ï¼Œè¿›è¡Œé€ƒé€¸å¤„ç†ã€‚\n4.5. Closure Rewriting é—­åŒ…é‡å†™åˆ†ä¸ºå®šä¹‰åç«‹å³è°ƒç”¨å’Œä¸è¢«ç«‹å³è°ƒç”¨ä¸¤ç§æƒ…å†µï¼Œåœ¨ç«‹å³è°ƒç”¨çš„æƒ…å†µä¸‹ï¼Œä¼šè½¬æ¢æˆæ™®é€šçš„å‡½æ•°è°ƒç”¨çš„å½¢å¼ï¼Œè€Œä¸è¢«ç«‹å³è°ƒç”¨ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªé—­åŒ…å¯¹è±¡ã€‚\nå¦‚æœå¯¹è±¡æ˜¯æŒ‰å€¼åº”ç”¨çš„ï¼Œä¸”ç©ºé—´å°äº2*sizeof(int)ï¼Œé‚£ä¹ˆé€šè¿‡åœ¨å‡½æ•°ä½“å†…åˆ›å»ºå±€éƒ¨å˜é‡çš„å½¢å¼æ¥äº§ç”Ÿè¯¥å˜é‡ã€‚å¦‚æœå­˜åœ¨æŒ‡é’ˆæˆ–è€…å¼•ç”¨ï¼Œé‚£ä¹ˆæ•è·çš„å˜é‡è½¬æ¢æˆæŒ‡é’ˆç±»å‹çš„\u0026amp;varï¼Œä¼šåˆå§‹åŒ–ä¸ºæ•è·å˜é‡çš„å€¼ã€‚\n4.6. Function Traversal éå†å‡½æ•°ï¼Œåœ¨gc/walk.goä¸­ï¼Œä¼šè¯†åˆ«å‡ºç”Ÿå‘½ä½†æ˜¯æœªè¢«ä½¿ç”¨çš„å˜é‡ï¼Œå¸¦èŠ‚ç‚¹çš„æ“ä½œè½¬æ¢ä¸ºå…·ä½“å‡½æ•°æ‰§è¡Œï¼Œå¦‚mapè·å–å€¼ä¼šè½¬æ¢ä¸ºmapaccess_fast64å‡½æ•°ï¼Œå­—ç¬¦ä¸²æ‹¼æ¥è½¬æ¢ä¸ºconcatstringsï¼Œforrangeæ‹†å¼€ç­‰ï¼ŒåŒæ—¶ä¼šæ ¹æ®éœ€è¦å¼•å…¥ä¸´æ—¶å˜é‡ä»¥åŠè¯­å¥é‡æ’åºï¼Œå¦‚x/=yæ‹†æˆx=x/y\n5. SSA SSAç”Ÿæˆé˜¶æ®µæ˜¯ç¼–è¯‘å™¨è¿›è¡Œåç»­ä¼˜åŒ–çš„ä¿è¯ï¼Œå¦‚å¸¸é‡ä¼ æ’­ï¼Œæ— æ•ˆä»£ç æ¶ˆé™¤ï¼Œå†—ä½™æ¶ˆé™¤ï¼Œå¼ºåº¦é™ä½ç­‰ã€‚\nGoåœ¨1.7ç‰ˆæœ¬å¼•å…¥å¹¶æˆä¸ºç°ä»£çš„ç¼–è¯‘å™¨åç«¯ï¼Œæ­¤æ—¶ä¼šç”¨äºå¤„ç† defer å…³é”®å­—çš„ runtime.deferprocã€ç”¨äºåˆ›å»º Goroutine çš„ runtime.newproc å’Œæ‰©å®¹åˆ‡ç‰‡çš„ runtime.growslice ç­‰ï¼Œ\nè¿™é‡Œä¼šå¯¹å…³é”®å­—æˆ–è€…å†…å»ºå‡½æ•°åˆ°è¿è¡Œæ—¶å‡½æ•°çš„æ˜ å°„å…¶ä¸­æ¶‰åŠ Channelã€å“ˆå¸Œã€makeã€new å…³é”®å­—ä»¥åŠæ§åˆ¶æµä¸­çš„å…³é”®å­— select ç­‰ï¼Œç»è¿‡walkå‡½æ•°éå†ä¹‹åï¼ŒSAAä¾¿ä¸ä¼šå†æ”¹å˜ã€‚\n1 2 3 4 5 6 7 func compileSSA(fn *Node, worker int) { f := buildssa(fn, worker) pp := newProgs(fn, worker) genssa(f, pp) pp.Flush() } å¯ä»¥é€šè¿‡GOSSAFUNC=hello go build hello.goæ¥æŸ¥çœ‹SSAç”Ÿæˆçš„è¿‡ç¨‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 func (s *state) stmt(n *Node) { ... switch n.Op { case OCALLMETH, OCALLINTER: s.call(n, callNormal) if n.Op == OCALLFUNC \u0026amp;\u0026amp; n.Left.Op == ONAME \u0026amp;\u0026amp; n.Left.Class() == PFUNC { if fn := n.Left.Sym.Name; compiling_runtime \u0026amp;\u0026amp; fn == \u0026#34;throw\u0026#34; || n.Left.Sym.Pkg == Runtimepkg \u0026amp;\u0026amp; (fn == \u0026#34;throwinit\u0026#34; || fn == \u0026#34;gopanic\u0026#34; || fn == \u0026#34;panicwrap\u0026#34; || fn == \u0026#34;block\u0026#34; || fn == \u0026#34;panicmakeslicelen\u0026#34; || fn == \u0026#34;panicmakeslicecap\u0026#34;) { m := s.mem() b := s.endBlock() b.Kind = ssa.BlockExit b.SetControl(m) } } s.call(n.Left, callDefer) case OGO: s.call(n.Left, callGo) ... } } ä»ASTåˆ°SAAçš„è½¬æ¢å¯ä»¥å‘ç°ï¼Œåœ¨é‡åˆ°å‡½æ•°è°ƒç”¨ã€æ–¹æ³•è°ƒç”¨ã€ä½¿ç”¨ defer æˆ–è€… go å…³é”®å­—æ—¶éƒ½ä¼šæ‰§è¡Œ cmd/compile/internal/gc.state.callResult å’Œ cmd/compile/internal/gc.state.callç”Ÿæˆè°ƒç”¨å‡½æ•°çš„ SSA èŠ‚ç‚¹ï¼Œè¿™äº›åœ¨å¼€å‘è€…çœ‹æ¥ä¸åŒçš„æ¦‚å¿µåœ¨ç¼–è¯‘å™¨ä¸­éƒ½ä¼šè¢«å®ç°æˆé™æ€çš„å‡½æ•°è°ƒç”¨ï¼Œä¸Šå±‚çš„å…³é”®å­—å’Œæ–¹æ³•åªæ˜¯è¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„è¯­æ³•ç³–ã€‚\næŸäº›ä¸­é—´ä»£ç ä»ç„¶éœ€è¦ç¼–è¯‘å™¨ä¼˜åŒ–ä»¥å»æ‰æ— ç”¨ä»£ç å¹¶ç²¾ç®€æ“ä½œæ•°ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 func Compile(f *Func) { if f.Log() { f.Logf(\u0026#34;compiling %s\\n\u0026#34;, f.Name) } phaseName := \u0026#34;init\u0026#34; for _, p := range passes { f.pass = \u0026amp;p p.fn(f) } phaseName = \u0026#34;\u0026#34; } 6. Machine Code Generation SSA é™çº§æ˜¯åœ¨ä¸­é—´ä»£ç ç”Ÿæˆçš„è¿‡ç¨‹ä¸­å®Œæˆçš„ï¼Œå…¶ä¸­å°†è¿‘ 50 è½®å¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œlower ä»¥åŠåé¢çš„é˜¶æ®µéƒ½å±äº SSA é™çº§è¿™ä¸€è¿‡ç¨‹ï¼Œè¿™ä¹ˆå¤šè½®çš„å¤„ç†ä¼šå°† SSA è½¬æ¢æˆæœºå™¨ç‰¹å®šçš„æ“ä½œï¼š\n1 2 3 4 5 6 7 8 var passes = [...]pass{ ... {name: \u0026#34;lower\u0026#34;, fn: lower, required: true}, {name: \u0026#34;lowered deadcode for cse\u0026#34;, fn: deadcode}, // deadcode immediately before CSE avoids CSE making dead values live again {name: \u0026#34;lowered cse\u0026#34;, fn: cse}, ... {name: \u0026#34;trim\u0026#34;, fn: trim}, // remove empty blocks } è½¬æ¢è¿‡ç¨‹ä¼šå¯¹åº”CPUçš„æ¶æ„åšåˆ†æ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 func rewriteValue386(v *Value) bool { switch v.Op { case Op386ADCL: return rewriteValue386_Op386ADCL_0(v) case Op386ADDL: return rewriteValue386_Op386ADDL_0(v) || rewriteValue386_Op386ADDL_10(v) || rewriteValue386_Op386ADDL_20(v) ... } } func rewriteValue386_Op386ADCL_0(v *Value) bool { // match: (ADCL x (MOVLconst [c]) f) // cond: // result: (ADCLconst [c] x f) for { _ = v.Args[2] x := v.Args[0] v_1 := v.Args[1] if v_1.Op != Op386MOVLconst { break } c := v_1.AuxInt f := v.Args[2] v.reset(Op386ADCLconst) v.AuxInt = c v.AddArg(x) v.AddArg(f) return true } ... } Go è¯­è¨€çš„æ±‡ç¼–å™¨æ˜¯åŸºäº Plan 9 æ±‡ç¼–å™¨çš„è¾“å…¥ç±»å‹è®¾è®¡çš„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package hello func hello(a int) int { c := a + 2 return c } $ GOOS=linux GOARCH=amd64 go tool compile -S hello.go \u0026#34;\u0026#34;.hello STEXT nosplit size=15 args=0x10 locals=0x0 0x0000 00000 (main.go:3) TEXT \u0026#34;\u0026#34;.hello(SB), NOSPLIT, $0-16 0x0000 00000 (main.go:3) FUNCDATA $0, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 0x0000 00000 (main.go:3) FUNCDATA $1, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 0x0000 00000 (main.go:3) FUNCDATA $3, gclocalsÂ·33cdeccccebe80329f1fdbee7f5874cb(SB) 0x0000 00000 (main.go:4) PCDATA $2, $0 0x0000 00000 (main.go:4) PCDATA $0, $0 0x0000 00000 (main.go:4) MOVQ \u0026#34;\u0026#34;.a+8(SP), AX 0x0005 00005 (main.go:4) ADDQ $2, AX 0x0009 00009 (main.go:5) MOVQ AX, \u0026#34;\u0026#34;.~r1+16(SP) 0x000e 00014 (main.go:5) RET 0x0000 48 8b 44 24 08 48 83 c0 02 48 89 44 24 10 c3 H.D$.H...H.D$.. ... ä¸Šè¿°æ±‡ç¼–ä»£ç éƒ½æ˜¯ç”± cmd/internal/obj.Flushplist è¿™ä¸ªå‡½æ•°ç”Ÿæˆçš„ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨æ¶æ„ç‰¹å®šçš„ Preprocess å’Œ Assemble æ–¹æ³•ã€‚è‡ªæ­¤å®Œæˆæœ€ç»ˆçš„æœºå™¨ç ç”Ÿæˆã€‚\n","date":"2021-08-26T15:00:13+08:00","image":"https://chasing1020.github.io/post/go0-compilers-principles/go-model-sheet_hu639b7f51186e99c0b2036c3dd41de527_43318_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/go0-compilers-principles/","title":"Go(0) Compilers Principles"},{"content":"Design Pattern 1. Creational Patterns 1.1.Factory Method å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ å…¶åœ¨çˆ¶ç±»ä¸­æä¾›ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ–¹æ³•ï¼Œ å…è®¸å­ç±»å†³å®šå®ä¾‹åŒ–å¯¹è±¡çš„ç±»å‹ã€‚\nUsage æ— æ³•é¢„çŸ¥å¯¹è±¡ç¡®åˆ‡ç±»åˆ«åŠå…¶ä¾èµ–å…³ç³»ã€‚ï¼ˆåªéœ€è¦å¼€å‘æ–°çš„åˆ›å»ºè€…å­ç±»ï¼Œ ç„¶åé‡å†™å…¶å·¥å‚æ–¹æ³•ï¼‰ å¸Œæœ›ç”¨æˆ·èƒ½æ‰©å±•è½¯ä»¶åº“æˆ–æ¡†æ¶çš„å†…éƒ¨ç»„ä»¶ã€‚ å¦‚æœå¸Œæœ›å¤ç”¨ç°æœ‰å¯¹è±¡æ¥èŠ‚çœç³»ç»Ÿèµ„æºï¼Œ è€Œä¸æ˜¯æ¯æ¬¡éƒ½é‡æ–°åˆ›å»ºå¯¹è±¡ã€‚ Advantages é¿å…åˆ›å»ºè€…å’Œå…·ä½“äº§å“ä¹‹é—´çš„ç´§å¯†è€¦åˆã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å°†äº§å“åˆ›å»ºä»£ç æ”¾åœ¨ç¨‹åºçš„å•ä¸€ä½ç½®ï¼Œ ä»è€Œä½¿å¾—ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€‚ å¼€é—­åŸåˆ™ã€‚ æ— éœ€æ›´æ”¹ç°æœ‰å®¢æˆ·ç«¯ä»£ç ï¼Œ å¯ä»¥åœ¨ç¨‹åºä¸­å¼•å…¥æ–°çš„äº§å“ç±»å‹ã€‚ Disadvantages åº”ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼éœ€è¦å¼•å…¥è®¸å¤šæ–°çš„å­ç±»ï¼Œ ä»£ç å¯èƒ½ä¼šå› æ­¤å˜å¾—æ›´å¤æ‚ã€‚ æœ€å¥½çš„æƒ…å†µæ˜¯å°†è¯¥æ¨¡å¼å¼•å…¥åˆ›å»ºè€…ç±»çš„ç°æœ‰å±‚æ¬¡ç»“æ„ä¸­ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 public abstract class NumberFormat extends Format { private static NumberFormat getInstance(Locale desiredLocale, int choice) { LocaleProviderAdapter adapter; adapter = LocaleProviderAdapter.getAdapter(NumberFormatProvider.class, desiredLocale); NumberFormat numberFormat = getInstance(adapter, desiredLocale, choice); if (numberFormat == null) { numberFormat = getInstance(LocaleProviderAdapter.forJRE(), desiredLocale, choice); } return numberFormat; } private static NumberFormat getInstance(LocaleProviderAdapter adapter, Locale locale, int choice) { NumberFormatProvider provider = adapter.getNumberFormatProvider(); NumberFormat numberFormat = null; switch (choice) { case NUMBERSTYLE: numberFormat = provider.getNumberInstance(locale); break; case PERCENTSTYLE: numberFormat = provider.getPercentInstance(locale); break; case CURRENCYSTYLE: numberFormat = provider.getCurrencyInstance(locale); break; case INTEGERSTYLE: numberFormat = provider.getIntegerInstance(locale); break; } return numberFormat; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 // Calendar ä¸‰ä¸ªå­ç±»ï¼Œéƒ½å¯ä»¥è°ƒç”¨getInstance() -\u0026gt; createClendar // BuddhistCalendar // GregorianCalendar // JapaneseImperialCalendar private static Calendar createCalendar(TimeZone zone, Locale aLocale) { CalendarProvider provider = LocaleProviderAdapter.getAdapter(CalendarProvider.class, aLocale) .getCalendarProvider(); if (provider != null) { try { return provider.getInstance(zone, aLocale); } catch (IllegalArgumentException iae) { // fall back to the default instantiation } } Calendar cal = null; if (aLocale.hasExtensions()) { String caltype = aLocale.getUnicodeLocaleType(\u0026#34;ca\u0026#34;); if (caltype != null) { switch (caltype) { case \u0026#34;buddhist\u0026#34;: cal = new BuddhistCalendar(zone, aLocale); break; case \u0026#34;japanese\u0026#34;: cal = new JapaneseImperialCalendar(zone, aLocale); break; case \u0026#34;gregory\u0026#34;: cal = new GregorianCalendar(zone, aLocale); break; } } } if (cal == null) { // If no known calendar type is explicitly specified, // perform the traditional way to create a Calendar: // create a BuddhistCalendar for th_TH locale, // a JapaneseImperialCalendar for ja_JP_JP locale, or // a GregorianCalendar for any other locales. // NOTE: The language, country and variant strings are interned. if (aLocale.getLanguage() == \u0026#34;th\u0026#34; \u0026amp;\u0026amp; aLocale.getCountry() == \u0026#34;TH\u0026#34;) { cal = new BuddhistCalendar(zone, aLocale); } else if (aLocale.getVariant() == \u0026#34;JP\u0026#34; \u0026amp;\u0026amp; aLocale.getLanguage() == \u0026#34;ja\u0026#34; \u0026amp;\u0026amp; aLocale.getCountry() == \u0026#34;JP\u0026#34;) { cal = new JapaneseImperialCalendar(zone, aLocale); } else { cal = new GregorianCalendar(zone, aLocale); } } return cal; } 1.2.Abstract Factory æŠ½è±¡å·¥å‚æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½åˆ›å»ºä¸€ç³»åˆ—ç›¸å…³çš„å¯¹è±¡ï¼Œ è€Œæ— éœ€æŒ‡å®šå…¶å…·ä½“ç±»ã€‚\nUsage å¦‚æœä»£ç éœ€è¦ä¸å¤šä¸ªä¸åŒç³»åˆ—çš„ç›¸å…³äº§å“äº¤äº’ï¼Œ ä½†æ˜¯ç”±äºæ— æ³•æå‰è·å–ç›¸å…³ä¿¡æ¯ï¼Œ æˆ–è€…å‡ºäºå¯¹æœªæ¥æ‰©å±•æ€§çš„è€ƒè™‘ï¼Œ ä¸å¸Œæœ›ä»£ç åŸºäºäº§å“çš„å…·ä½“ç±»è¿›è¡Œæ„å»ºï¼Œ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ å¯ä»¥ä½¿ç”¨æŠ½è±¡å·¥å‚ã€‚ å¦‚æœæœ‰ä¸€ä¸ªåŸºäºä¸€ç»„æŠ½è±¡æ–¹æ³•çš„ç±»ï¼Œ ä¸”å…¶ä¸»è¦åŠŸèƒ½å› æ­¤å˜å¾—ä¸æ˜ç¡®ï¼Œ é‚£ä¹ˆåœ¨è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼ã€‚ Advantages å¯ä»¥ç¡®ä¿åŒä¸€å·¥å‚ç”Ÿæˆçš„äº§å“ç›¸äº’åŒ¹é…ã€‚ å¯ä»¥é¿å…å®¢æˆ·ç«¯å’Œå…·ä½“äº§å“ä»£ç çš„è€¦åˆã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯ä»¥å°†äº§å“ç”Ÿæˆä»£ç æŠ½å–åˆ°åŒä¸€ä½ç½®ï¼Œ ä½¿å¾—ä»£ç æ˜“äºç»´æŠ¤ã€‚ å¼€é—­åŸåˆ™ã€‚ å‘åº”ç”¨ç¨‹åºä¸­å¼•å…¥æ–°äº§å“å˜ä½“æ—¶ï¼Œ æ— éœ€ä¿®æ”¹å®¢æˆ·ç«¯ä»£ç ã€‚ Disadvantages ç”±äºé‡‡ç”¨è¯¥æ¨¡å¼éœ€è¦å‘åº”ç”¨ä¸­å¼•å…¥ä¼—å¤šæ¥å£å’Œç±»ï¼Œ ä»£ç å¯èƒ½ä¼šæ¯”ä¹‹å‰æ›´åŠ å¤æ‚ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 // ä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡XMLæ–‡ä»¶ï¼Œè·å¾—ä¸€ä¸ªèƒ½ç”ŸæˆDOMå¯¹è±¡çš„è§£æå™¨ã€‚ public abstract class DocumentBuilderFactory { //... public static DocumentBuilderFactory newInstance() { return FactoryFinder.find( /* The default property name according to the JAXP spec */ DocumentBuilderFactory.class, // \u0026#34;javax.xml.parsers.DocumentBuilderFactory\u0026#34; /* The fallback implementation class name */ \u0026#34;com.sun.org.apache.xerces.internal.jaxp.DocumentBuilderFactoryImpl\u0026#34;); } } public class DocumentBuilderFactoryImpl extends DocumentBuilderFactory { public DocumentBuilder newDocumentBuilder() throws ParserConfigurationException { /** Check that if a Schema has been specified that neither of the schema properties have been set. */ if (grammar != null \u0026amp;\u0026amp; attributes != null) { if (attributes.containsKey(JAXPConstants.JAXP_SCHEMA_LANGUAGE)) { throw new ParserConfigurationException( SAXMessageFormatter.formatMessage(null, \u0026#34;schema-already-specified\u0026#34;, new Object[] {JAXPConstants.JAXP_SCHEMA_LANGUAGE})); } else if (attributes.containsKey(JAXPConstants.JAXP_SCHEMA_SOURCE)) { throw new ParserConfigurationException( SAXMessageFormatter.formatMessage(null, \u0026#34;schema-already-specified\u0026#34;, new Object[] {JAXPConstants.JAXP_SCHEMA_SOURCE})); } } try { return new DocumentBuilderImpl(this, attributes, features, fSecureProcess); } catch (SAXException se) { // Handles both SAXNotSupportedException, SAXNotRecognizedException throw new ParserConfigurationException(se.getMessage()); } } } 1.3.Builder æ„å»ºå™¨æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ ä½¿èƒ½å¤Ÿåˆ†æ­¥éª¤åˆ›å»ºå¤æ‚å¯¹è±¡ã€‚ è¯¥æ¨¡å¼å…è®¸ä½¿ç”¨ç›¸åŒçš„åˆ›å»ºä»£ç ç”Ÿæˆä¸åŒç±»å‹å’Œå½¢å¼çš„å¯¹è±¡ã€‚\nUsage ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡å¼å¯é¿å… â€œé‡å æ„é€ å‡½æ•° ï¼ˆtelescopic constructorï¼‰â€ çš„å‡ºç°ã€‚ å½“å¸Œæœ›ä½¿ç”¨ä»£ç åˆ›å»ºä¸åŒå½¢å¼çš„äº§å“ ï¼ˆä¾‹å¦‚çŸ³å¤´æˆ–æœ¨å¤´æˆ¿å±‹ï¼‰ æ—¶ï¼Œ å¯ä½¿ç”¨ç”Ÿæˆå™¨æ¨¡å¼ã€‚ ä½¿ç”¨ç”Ÿæˆå™¨æ„é€ ç»„åˆæ ‘æˆ–å…¶ä»–å¤æ‚å¯¹è±¡ã€‚ Advantages å¯ä»¥åˆ†æ­¥åˆ›å»ºå¯¹è±¡ï¼Œ æš‚ç¼“åˆ›å»ºæ­¥éª¤æˆ–é€’å½’è¿è¡Œåˆ›å»ºæ­¥éª¤ã€‚ ç”Ÿæˆä¸åŒå½¢å¼çš„äº§å“æ—¶ï¼Œ å¯ä»¥å¤ç”¨ç›¸åŒçš„åˆ¶é€ ä»£ç ã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯ä»¥å°†å¤æ‚æ„é€ ä»£ç ä»äº§å“çš„ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚ Disadvantages ç”±äºè¯¥æ¨¡å¼éœ€è¦æ–°å¢å¤šä¸ªç±»ï¼Œ å› æ­¤ä»£ç æ•´ä½“å¤æ‚ç¨‹åº¦ä¼šæœ‰æ‰€å¢åŠ ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 public final class StringBuilder extends AbstractStringBuilder implements java.io.Serializable, CharSequence { @Override public StringBuilder append(Object obj) { return append(String.valueOf(obj)); } @Override public StringBuilder append(String str) { super.append(str); return this; } } 1.4.Prototype åŸå‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ ä½¿èƒ½å¤Ÿå¤åˆ¶å·²æœ‰å¯¹è±¡ï¼Œ è€Œåˆæ— éœ€ä½¿ä»£ç ä¾èµ–å®ƒä»¬æ‰€å±çš„ç±»ã€‚\nUsage å¦‚æœéœ€è¦å¤åˆ¶ä¸€äº›å¯¹è±¡ï¼Œ åŒæ—¶åˆå¸Œæœ›ä»£ç ç‹¬ç«‹äºè¿™äº›å¯¹è±¡æ‰€å±çš„å…·ä½“ç±»ï¼Œ å¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼ã€‚ å¦‚æœå­ç±»çš„åŒºåˆ«ä»…åœ¨äºå…¶å¯¹è±¡çš„åˆå§‹åŒ–æ–¹å¼ï¼Œ é‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼æ¥å‡å°‘å­ç±»çš„æ•°é‡ã€‚ åˆ«äººåˆ›å»ºè¿™äº›å­ç±»çš„ç›®çš„å¯èƒ½æ˜¯ä¸ºäº†åˆ›å»ºç‰¹å®šç±»å‹çš„å¯¹è±¡ã€‚ Advantages å¯ä»¥å…‹éš†å¯¹è±¡ï¼Œ è€Œæ— éœ€ä¸å®ƒä»¬æ‰€å±çš„å…·ä½“ç±»ç›¸è€¦åˆã€‚ å¯ä»¥å…‹éš†é¢„ç”ŸæˆåŸå‹ï¼Œ é¿å…åå¤è¿è¡Œåˆå§‹åŒ–ä»£ç ã€‚ å¯ä»¥æ›´æ–¹ä¾¿åœ°ç”Ÿæˆå¤æ‚å¯¹è±¡ï¼Œåœ¨å†…å­˜ä¸­åˆ›å»ºæ€§èƒ½æ›´å¥½ã€‚ å¯ä»¥ç”¨ç»§æ‰¿ä»¥å¤–çš„æ–¹å¼æ¥å¤„ç†å¤æ‚å¯¹è±¡çš„ä¸åŒé…ç½®ã€‚ Disadvantages å…‹éš†åŒ…å«å¾ªç¯å¼•ç”¨çš„å¤æ‚å¯¹è±¡å¯èƒ½ä¼šéå¸¸éº»çƒ¦ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 public interface Cloneable { } public class Object { protected native Object clone() throws CloneNotSupportedException; } class Prototype implements Cloneable { public Prototype clone() { Prototype prototype = null; try{ prototype = (Prototype)super.clone(); }catch(CloneNotSupportedException e) { e.printStackTrace(); } return prototype; } } class ConcretePrototype extends Prototype { public void show() { System.out.println(\u0026#34;åŸå‹æ¨¡å¼å®ç°ç±»\u0026#34;); } } public class Client { public static void main(String[] args) { ConcretePrototype cp = new ConcretePrototype(); for(int i=0; i\u0026lt; 10; i++) { // è¿”å›æµ…æ‹·è´å¯¹è±¡ ConcretePrototype clonecp = (ConcretePrototype)cp.clone(); clonecp.show(); } } } 1.5.Singleton å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºå‹è®¾è®¡æ¨¡å¼ï¼Œ è®©èƒ½å¤Ÿä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œ å¹¶æä¾›ä¸€ä¸ªè®¿é—®è¯¥å®ä¾‹çš„å…¨å±€èŠ‚ç‚¹ã€‚\nUsage å¦‚æœç¨‹åºä¸­çš„æŸä¸ªç±»å¯¹äºæ‰€æœ‰å®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªå¯ç”¨çš„å®ä¾‹ï¼Œ å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚ å¦‚æœéœ€è¦æ›´åŠ ä¸¥æ ¼åœ°æ§åˆ¶å…¨å±€å˜é‡ï¼Œ å¯ä»¥ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚ Advantages å¯ä»¥ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ã€‚ è·å¾—äº†ä¸€ä¸ªæŒ‡å‘è¯¥å®ä¾‹çš„å…¨å±€è®¿é—®èŠ‚ç‚¹ã€‚ ä»…åœ¨é¦–æ¬¡è¯·æ±‚å•ä¾‹å¯¹è±¡æ—¶å¯¹å…¶è¿›è¡Œåˆå§‹åŒ–ã€‚ Disadvantages è¿åäº†_å•ä¸€èŒè´£åŸåˆ™_ã€‚ è¯¥æ¨¡å¼åŒæ—¶è§£å†³äº†ä¸¤ä¸ªé—®é¢˜ã€‚ å•ä¾‹æ¨¡å¼å¯èƒ½æ©ç›–ä¸è‰¯è®¾è®¡ï¼Œ æ¯”å¦‚ç¨‹åºå„ç»„ä»¶ä¹‹é—´ç›¸äº’äº†è§£è¿‡å¤šç­‰ã€‚ è¯¥æ¨¡å¼åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éœ€è¦è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œ é¿å…å¤šä¸ªçº¿ç¨‹å¤šæ¬¡åˆ›å»ºå•ä¾‹å¯¹è±¡ã€‚ å•ä¾‹çš„å®¢æˆ·ç«¯ä»£ç å•å…ƒæµ‹è¯•å¯èƒ½ä¼šæ¯”è¾ƒå›°éš¾ï¼Œ å› ä¸ºè®¸å¤šæµ‹è¯•æ¡†æ¶ä»¥åŸºäºç»§æ‰¿çš„æ–¹å¼åˆ›å»ºæ¨¡æ‹Ÿå¯¹è±¡ã€‚ ç”±äºå•ä¾‹ç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œ è€Œä¸”ç»å¤§éƒ¨åˆ†è¯­è¨€æ— æ³•é‡å†™é™æ€æ–¹æ³•ï¼Œ æ‰€ä»¥éœ€è¦æƒ³å‡ºä»”ç»†è€ƒè™‘æ¨¡æ‹Ÿå•ä¾‹çš„æ–¹æ³•ã€‚ è¦ä¹ˆå¹²è„†ä¸ç¼–å†™æµ‹è¯•ä»£ç ï¼Œ æˆ–è€…ä¸ä½¿ç”¨å•ä¾‹æ¨¡å¼ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public final class Singleton { private static Singleton instance; public String value; private Singleton(String value) { // The following code emulates slow initialization. try { Thread.sleep(1000); } catch (InterruptedException ex) { ex.printStackTrace(); } this.value = value; } public static Singleton getInstance(String value) { if (instance == null) { instance = new Singleton(value); } return instance; } } å¤šçº¿ç¨‹å®‰å…¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 public final class Singleton { private static volatile Singleton instance; public String value; private Singleton(String value) { this.value = value; } public static Singleton getInstance(String value) { Singleton result = instance; if (result != null) { return result; } synchronized(Singleton.class) { if (instance == null) { instance = new Singleton(value); } return instance; } } } é™æ€å†…éƒ¨ç±»å•ä¾‹æ¨¡å¼ï¼ˆæ¨èï¼‰\n1 2 3 4 5 6 7 8 9 10 11 //æ¨èå†™æ³• public class Singleton { private Singleton(){ } public static Singleton getInstance(){ return SingletonHolder.sInstance; //é™æ€å†…éƒ¨ç±»å®ŒæˆåŠ è½½ } private static class SingletonHolder { private static final Singleton sInstance = new Singleton(); } } æ ¸å¿ƒåº“ç¤ºä¾‹\n1 2 3 4 5 6 public class Runtime { private static Runtime currentRuntime = new Runtime(); public static Runtime getRuntime() { return currentRuntime; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 public final class System { private static native void registerNatives(); private static volatile SecurityManager security = null; static { registerNatives(); } /** Don\u0026#39;t let anyone instantiate this class */ private System() { } public static SecurityManager getSecurityManager() { return security; } } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import ( \u0026#34;fmt\u0026#34; \u0026#34;sync\u0026#34; ) var lock = \u0026amp;sync.Mutex{} type single struct { } var singleInstance *single func getInstance() *single { if singleInstance == nil { lock.Lock() defer lock.Unlock() if singleInstance == nil { fmt.Println(\u0026#34;Creting Single Instance Now\u0026#34;) singleInstance = \u0026amp;single{} } else { fmt.Println(\u0026#34;Single Instance already created-1\u0026#34;) } } else { fmt.Println(\u0026#34;Single Instance already created-2\u0026#34;) } return singleInstance } 2. Structural Patterns 2.1.Adapter é€‚é…å™¨æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½ä½¿æ¥å£ä¸å…¼å®¹çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’åˆä½œã€‚\nUsage å½“å¸Œæœ›ä½¿ç”¨æŸä¸ªç±»ï¼Œ ä½†æ˜¯å…¶æ¥å£ä¸å…¶ä»–ä»£ç ä¸å…¼å®¹æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨é€‚é…å™¨ç±»ã€‚ å¦‚æœæ‚¨éœ€è¦å¤ç”¨è¿™æ ·ä¸€äº›ç±»ï¼Œ ä»–ä»¬å¤„äºåŒä¸€ä¸ªç»§æ‰¿ä½“ç³»ï¼Œ å¹¶ä¸”ä»–ä»¬åˆæœ‰äº†é¢å¤–çš„ä¸€äº›å…±åŒçš„æ–¹æ³•ï¼Œ ä½†æ˜¯è¿™äº›å…±åŒçš„æ–¹æ³•ä¸æ˜¯æ‰€æœ‰åœ¨è¿™ä¸€ç»§æ‰¿ä½“ç³»ä¸­çš„å­ç±»æ‰€å…·æœ‰çš„å…±æ€§ã€‚ Advantages å•ä¸€èŒè´£åŸåˆ™ã€‚å¯ä»¥å°†æ¥å£æˆ–æ•°æ®è½¬æ¢ä»£ç ä»ç¨‹åºä¸»è¦ä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»ã€‚ å¼€é—­åŸåˆ™ã€‚ åªè¦å®¢æˆ·ç«¯ä»£ç é€šè¿‡å®¢æˆ·ç«¯æ¥å£ä¸é€‚é…å™¨è¿›è¡Œäº¤äº’ï¼Œ å°±èƒ½åœ¨ä¸ä¿®æ”¹ç°æœ‰å®¢æˆ·ç«¯ä»£ç çš„æƒ…å†µä¸‹åœ¨ç¨‹åºä¸­æ·»åŠ æ–°ç±»å‹çš„é€‚é…å™¨ã€‚ Disadvantages ä»£ç æ•´ä½“å¤æ‚åº¦å¢åŠ ï¼Œ å› ä¸ºéœ€è¦æ–°å¢ä¸€ç³»åˆ—æ¥å£å’Œç±»ã€‚ æœ‰æ—¶ç›´æ¥æ›´æ”¹æœåŠ¡ç±»ä½¿å…¶ä¸å…¶ä»–ä»£ç å…¼å®¹ä¼šæ›´ç®€å•ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 //ArrayList å’Œ T[]æ˜¯ç»„åˆå…³ç³»ï¼Œæƒ³å°†T[]è½¬æ¢æˆlistçš„æ“ä½œï¼Œè¦æœ‰ä¸€ä¸ªé€‚é…å™¨æ¥è¿›è¡Œè½¬æ¢ public class Arrays { private static class ArrayList\u0026lt;E\u0026gt; extends AbstractList\u0026lt;E\u0026gt; implements RandomAccess, java.io.Serializable { @Override @SuppressWarnings(\u0026#34;unchecked\u0026#34;) public \u0026lt;T\u0026gt; T[] toArray(T[] a) { int size = size(); if (a.length \u0026lt; size) return Arrays.copyOf(this.a, size, (Class\u0026lt;? extends T[]\u0026gt;) a.getClass()); System.arraycopy(this.a, 0, a, 0, size); if (a.length \u0026gt; size) a[size] = null; return a; } } @SafeVarargs @SuppressWarnings(\u0026#34;varargs\u0026#34;) public static \u0026lt;T\u0026gt; List\u0026lt;T\u0026gt; asList(T... a) { return new ArrayList\u0026lt;\u0026gt;(a); } } InputStreamReaderä¹Ÿä½œä¸ºé€‚é…å™¨ä½¿ç”¨\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 // ç›®æ ‡ç±» public abstract class Reader implements Readable, Closeable { // å­—ç¬¦æµ abstract public int read(char cbuf[], int off, int len) throws IOException; abstract public void close() throws IOException; } // é€‚é…å™¨ç±» public class InputStreamReader extends Reader { private final StreamDecoder sd; public InputStreamReader(InputStream in) { super(in); try { //é€šè¿‡StreamDecoderç±»é—´æ¥å¼•ç”¨è¢«é€‚é…çš„å¯¹è±¡ sd = StreamDecoder.forInputStreamReader(in, this, (String)null); } catch (UnsupportedEncodingException e) { // The default encoding should always be available throw new Error(e); } } } // è¢«é€‚é…çš„ç±» public abstract class InputStream implements Closeable { // å­—èŠ‚æµ public int read(byte b[]) throws IOException { return read(b, 0, b.length); } } 2.2.Bridge æ¡¥æ¥æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å¯å°†ä¸€ä¸ªå¤§ç±»æˆ–ä¸€ç³»åˆ—ç´§å¯†ç›¸å…³çš„ç±»æ‹†åˆ†ä¸ºæŠ½è±¡å’Œå®ç°ä¸¤ä¸ªç‹¬ç«‹çš„å±‚æ¬¡ç»“æ„ï¼Œ ä»è€Œèƒ½åœ¨å¼€å‘æ—¶åˆ†åˆ«ä½¿ç”¨ã€‚\nUsage å¦‚æœæƒ³è¦æ‹†åˆ†æˆ–é‡ç»„ä¸€ä¸ªå…·æœ‰å¤šé‡åŠŸèƒ½çš„åºæ‚ç±» ï¼ˆä¾‹å¦‚èƒ½ä¸å¤šä¸ªæ•°æ®åº“æœåŠ¡å™¨è¿›è¡Œäº¤äº’çš„ç±»ï¼‰ï¼Œ å¯ä»¥ä½¿ç”¨æ¡¥æ¥æ¨¡å¼ã€‚ å¦‚æœå¸Œæœ›åœ¨å‡ ä¸ªç‹¬ç«‹ç»´åº¦ä¸Šæ‰©å±•ä¸€ä¸ªç±»ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ å¦‚æœéœ€è¦åœ¨è¿è¡Œæ—¶åˆ‡æ¢ä¸åŒå®ç°æ–¹æ³•ï¼Œ å¯ä½¿ç”¨æ¡¥æ¥æ¨¡å¼ã€‚ Advantages å¯ä»¥åˆ›å»ºä¸å¹³å°æ— å…³çš„ç±»å’Œç¨‹åºï¼Œå°†æŠ½è±¡ä¸å®ç°è§£è€¦ã€‚ å®¢æˆ·ç«¯ä»£ç ä»…ä¸é«˜å±‚æŠ½è±¡éƒ¨åˆ†è¿›è¡Œäº’åŠ¨ï¼Œ ä¸ä¼šæ¥è§¦åˆ°å¹³å°çš„è¯¦ç»†ä¿¡æ¯ã€‚ å¼€é—­åŸåˆ™ã€‚ å¯ä»¥æ–°å¢æŠ½è±¡éƒ¨åˆ†å’Œå®ç°éƒ¨åˆ†ï¼Œ ä¸”å®ƒä»¬ä¹‹é—´ä¸ä¼šç›¸äº’å½±å“ã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ æŠ½è±¡éƒ¨åˆ†ä¸“æ³¨äºå¤„ç†é«˜å±‚é€»è¾‘ï¼Œ å®ç°éƒ¨åˆ†å¤„ç†å¹³å°ç»†èŠ‚ã€‚ Disadvantages å¯¹é«˜å†…èšçš„ç±»ä½¿ç”¨è¯¥æ¨¡å¼å¯èƒ½ä¼šè®©ä»£ç æ›´åŠ å¤æ‚ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 // JDBC public interface Driver { Connection connect(String url, java.util.Properties info) throws SQLException; boolean acceptsURL(String url) throws SQLException; DriverPropertyInfo[] getPropertyInfo(String url, java.util.Properties info) throws SQLException; int getMajorVersion(); int getMinorVersion(); boolean jdbcCompliant(); public Logger getParentLogger() throws SQLFeatureNotSupportedException; } public class Driver extends NonRegisteringDriver implements java.sql.Driver { public Driver() throws SQLException { } static { try { DriverManager.registerDriver(new Driver()); } catch (SQLException var1) { throw new RuntimeException(\u0026#34;Can\u0026#39;t register driver!\u0026#34;); } } } // æ¡¥ public class DriverManager{ public static Connection getConnection(String url, String user, String password) throws SQLException { java.util.Properties info = new java.util.Properties(); if (user != null) { info.put(\u0026#34;user\u0026#34;, user); } if (password != null) { info.put(\u0026#34;password\u0026#34;, password); } return (getConnection(url, info, Reflection.getCallerClass())); } } 2.3.Composite ç»„åˆæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å¯ä»¥ä½¿ç”¨å®ƒå°†å¯¹è±¡ç»„åˆæˆæ ‘çŠ¶ç»“æ„ï¼Œ å¹¶ä¸”èƒ½åƒä½¿ç”¨ç‹¬ç«‹å¯¹è±¡ä¸€æ ·ä½¿ç”¨å®ƒä»¬ã€‚\nUsage å¦‚æœéœ€è¦å®ç°æ ‘çŠ¶å¯¹è±¡ç»“æ„ï¼Œ å¯ä»¥ä½¿ç”¨ç»„åˆæ¨¡å¼ã€‚ å¦‚æœå¸Œæœ›å®¢æˆ·ç«¯ä»£ç ä»¥ç›¸åŒæ–¹å¼å¤„ç†ç®€å•å’Œå¤æ‚å…ƒç´ ï¼Œ å¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ Advantages å¯ä»¥åˆ©ç”¨å¤šæ€å’Œé€’å½’æœºåˆ¶æ›´æ–¹ä¾¿åœ°ä½¿ç”¨å¤æ‚æ ‘ç»“æ„ã€‚ å¼€é—­åŸåˆ™ã€‚ æ— éœ€æ›´æ”¹ç°æœ‰ä»£ç ï¼Œ å°±å¯ä»¥åœ¨åº”ç”¨ä¸­æ·»åŠ æ–°å…ƒç´ ï¼Œ ä½¿å…¶æˆä¸ºå¯¹è±¡æ ‘çš„ä¸€éƒ¨åˆ†ã€‚ Disadvantages å¯¹äºåŠŸèƒ½å·®å¼‚è¾ƒå¤§çš„ç±»ï¼Œ æä¾›å…¬å…±æ¥å£æˆ–è®¸ä¼šæœ‰å›°éš¾ã€‚ åœ¨ç‰¹å®šæƒ…å†µä¸‹ï¼Œ éœ€è¦è¿‡åº¦ä¸€èˆ¬åŒ–ç»„ä»¶æ¥å£ï¼Œ ä½¿å…¶å˜å¾—ä»¤äººéš¾ä»¥ç†è§£ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 import java.util.ArrayList; import java.util.List; public class Employee { private String name; private String dept; private int salary; private List\u0026lt;Employee\u0026gt; subordinates; //æ„é€ å‡½æ•° public Employee(String name,String dept, int sal) { this.name = name; this.dept = dept; this.salary = sal; subordinates = new ArrayList\u0026lt;Employee\u0026gt;(); } public void add(Employee e) { subordinates.add(e); } public void remove(Employee e) { subordinates.remove(e); } public List\u0026lt;Employee\u0026gt; getSubordinates(){ return subordinates; } public String toString(){ return (\u0026#34;Employee :[ Name : \u0026#34;+ name +\u0026#34;, dept : \u0026#34;+ dept + \u0026#34;, salary :\u0026#34; + salary+\u0026#34; ]\u0026#34;); } } å¸¸ç”¨äºå‰ç«¯è¡¨ç¤ºä¸å›¾å½¢æ‰“äº¤é“çš„ç”¨æˆ·ç•Œé¢ç»„ä»¶æˆ–ä»£ç çš„å±‚æ¬¡ç»“æ„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 public class Container extends Component { public Component add(Component comp) { addImpl(comp, null, -1); return comp; } protected void addImpl(Component comp, Object constraints, int index) { synchronized (getTreeLock()) { GraphicsConfiguration thisGC = this.getGraphicsConfiguration(); if (index \u0026gt; component.size() || (index \u0026lt; 0 \u0026amp;\u0026amp; index != -1)) { throw new IllegalArgumentException( \u0026#34;illegal component position\u0026#34;); } checkAddToSelf(comp); checkNotAWindow(comp); /* Reparent the component and tidy up the tree\u0026#39;s state. */ if (comp.parent != null) { comp.parent.remove(comp); if (index \u0026gt; component.size()) { throw new IllegalArgumentException(\u0026#34;illegal component position\u0026#34;); } } if (thisGC != null) { comp.checkGD(thisGC.getDevice().getIDstring()); } //index == -1 means add to the end. if (index == -1) { component.add(comp); } else { component.add(index, comp); } comp.parent = this; comp.setGraphicsConfiguration(thisGC); adjustListeningChildren(AWTEvent.HIERARCHY_EVENT_MASK, comp.numListening(AWTEvent.HIERARCHY_EVENT_MASK)); adjustListeningChildren(AWTEvent.HIERARCHY_BOUNDS_EVENT_MASK, comp.numListening(AWTEvent.HIERARCHY_BOUNDS_EVENT_MASK)); adjustDescendants(comp.countHierarchyMembers()); invalidateIfValid(); if (peer != null) { comp.addNotify(); } /* Notify the layout manager of the added component. */ if (layoutMgr != null) { if (layoutMgr instanceof LayoutManager2) { ((LayoutManager2)layoutMgr).addLayoutComponent(comp, constraints); } else if (constraints instanceof String) { layoutMgr.addLayoutComponent((String)constraints, comp); } } if (containerListener != null || (eventMask \u0026amp; AWTEvent.CONTAINER_EVENT_MASK) != 0 || Toolkit.enabledOnToolkit(AWTEvent.CONTAINER_EVENT_MASK)) { ContainerEvent e = new ContainerEvent(this, ContainerEvent.COMPONENT_ADDED, comp); dispatchEvent(e); } comp.createHierarchyEvents(HierarchyEvent.HIERARCHY_CHANGED, comp, this, HierarchyEvent.PARENT_CHANGED, Toolkit.enabledOnToolkit(AWTEvent.HIERARCHY_EVENT_MASK)); if (peer != null \u0026amp;\u0026amp; layoutMgr == null \u0026amp;\u0026amp; isVisible()) { updateCursorImmediately(); } } } } æ··å…¥ (mixin) æä¾›äº†ä¸€ç§éå¸¸çµæ´»çš„æ–¹å¼ï¼Œæ¥åˆ†å‘ Vue ç»„ä»¶ä¸­çš„å¯å¤ç”¨åŠŸèƒ½ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // å®šä¹‰ä¸€ä¸ªæ··å…¥å¯¹è±¡ var myMixin = { created: function () { this.hello() }, methods: { hello: function () { console.log(\u0026#39;hello from mixin!\u0026#39;) } } } // å®šä¹‰ä¸€ä¸ªä½¿ç”¨æ··å…¥å¯¹è±¡çš„ç»„ä»¶ var Component = Vue.extend({ mixins: [myMixin] }) var component = new Component() // =\u0026gt; \u0026#34;hello from mixin!\u0026#34; 2.4.Decorator è£…é¥°æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å…è®¸é€šè¿‡å°†å¯¹è±¡æ”¾å…¥åŒ…å«è¡Œä¸ºçš„ç‰¹æ®Šå°è£…å¯¹è±¡ä¸­æ¥ä¸ºåŸå¯¹è±¡ç»‘å®šæ–°çš„è¡Œä¸ºã€‚\nUsage å¦‚æœå¸Œæœ›åœ¨æ— éœ€ä¿®æ”¹ä»£ç çš„æƒ…å†µä¸‹å³å¯ä½¿ç”¨å¯¹è±¡ï¼Œ ä¸”å¸Œæœ›åœ¨è¿è¡Œæ—¶ä¸ºå¯¹è±¡æ–°å¢é¢å¤–çš„è¡Œä¸ºï¼Œ å¯ä»¥ä½¿ç”¨è£…é¥°æ¨¡å¼ã€‚ å¦‚æœç”¨ç»§æ‰¿æ¥æ‰©å±•å¯¹è±¡è¡Œä¸ºçš„æ–¹æ¡ˆéš¾ä»¥å®ç°æˆ–è€…æ ¹æœ¬ä¸å¯è¡Œï¼Œ å¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ Advantages æ— éœ€åˆ›å»ºæ–°å­ç±»å³å¯æ‰©å±•å¯¹è±¡çš„è¡Œä¸ºã€‚ å¯ä»¥åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤å¯¹è±¡çš„åŠŸèƒ½ã€‚ å¯ä»¥ç”¨å¤šä¸ªè£…é¥°å°è£…å¯¹è±¡æ¥ç»„åˆå‡ ç§è¡Œä¸ºã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯ä»¥å°†å®ç°äº†è®¸å¤šä¸åŒè¡Œä¸ºçš„ä¸€ä¸ªå¤§ç±»æ‹†åˆ†ä¸ºå¤šä¸ªè¾ƒå°çš„ç±»ã€‚ Disadvantages åœ¨å°è£…å™¨æ ˆä¸­åˆ é™¤ç‰¹å®šå°è£…å™¨æ¯”è¾ƒå›°éš¾ã€‚ å®ç°è¡Œä¸ºä¸å—è£…é¥°æ ˆé¡ºåºå½±å“çš„è£…é¥°æ¯”è¾ƒå›°éš¾ã€‚ å„å±‚çš„åˆå§‹åŒ–é…ç½®ä»£ç çœ‹ä¸Šå»å¯èƒ½ä¼šå¾ˆç³Ÿç³•ã€‚ Demo java.io.InputStreamã€ OutputStreamã€ Reader å’Œ Writer çš„æ‰€æœ‰ä»£ç éƒ½æœ‰ä»¥è‡ªèº«ç±»å‹çš„å¯¹è±¡ä½œä¸ºå‚æ•°çš„æ„é€ å‡½æ•°ã€‚ ä¸¤è€…éƒ½ç»§æ‰¿äº†ReaderæŠ½è±¡çˆ¶ç±»ï¼Œéƒ½æœ‰è‡ªå·±çš„readæ–¹æ³•ï¼Œè€Œåœ¨InputStreamReaderä¸­å¼•ç”¨äº†ä¸€ä¸ªStreamDecoderå®ä¾‹å¯¹è±¡ï¼Œè™½ç„¶åœ¨InputStreamReaderä¸­å¹¶æœªå¯¹StreamDecoderçš„readæ–¹æ³•æ·»åŠ é¢å¤–çš„åŠŸèƒ½ï¼Œä½†å®ƒå¼•ç”¨StreamDecoderä½¿ç”¨äº†å…³é”®å­—final ï¼Œè®©StreamDecoderä¸å¯å˜ï¼Œä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´å®ƒæ‰©å±•çš„åŠŸèƒ½å°±æ˜¯è®©InputStreamReaderè¯»å–è¾“å…¥æµæ—¶ï¼Œç¼–ç æ ¼å¼ä¸å˜ï¼ŒInputStreamReaderä½œä¸ºä¸€ä¸ªè£…é¥°å™¨è§’è‰²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 // è£…é¥°å™¨å¯¹è±¡ public class InputStreamReader extends Reader { private final StreamDecoder sd; public int read() throws IOException { return sd.read(); } } public class StreamDecoder extends Reader { private InputStream in; public int read() throws IOException { return this.read0(); } private int read0() throws IOException { Object var1 = this.lock; synchronized(this.lock) { if(this.haveLeftoverChar) { this.haveLeftoverChar = false; return this.leftoverChar; } else { char[] var2 = new char[2]; int var3 = this.read(var2, 0, 2); switch(var3) { case -1: return -1; case 0: default: assert false : var3; return -1; case 2: this.leftoverChar = var2[1]; this.haveLeftoverChar = true; case 1: return var2[0]; } } } } } 2.5.Facade å¤–è§‚æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ èƒ½ä¸ºç¨‹åºåº“ã€ æ¡†æ¶æˆ–å…¶ä»–å¤æ‚ç±»æä¾›ä¸€ä¸ªç®€å•çš„æ¥å£ã€‚\nUsage å¦‚æœéœ€è¦ä¸€ä¸ªæŒ‡å‘å¤æ‚å­ç³»ç»Ÿçš„ç›´æ¥æ¥å£ï¼Œ ä¸”è¯¥æ¥å£çš„åŠŸèƒ½æœ‰é™ï¼Œ åˆ™å¯ä»¥ä½¿ç”¨å¤–è§‚æ¨¡å¼ã€‚ å¦‚æœéœ€è¦å°†å­ç³»ç»Ÿç»„ç»‡ä¸ºå¤šå±‚ç»“æ„ï¼Œ å¯ä»¥ä½¿ç”¨å¤–è§‚ã€‚ Advantages å¯ä»¥è®©è‡ªå·±çš„ä»£ç ç‹¬ç«‹äºå¤æ‚å­ç³»ç»Ÿã€‚ Disadvantages å¤–è§‚å¯èƒ½æˆä¸ºä¸ç¨‹åºä¸­æ‰€æœ‰ç±»éƒ½è€¦åˆçš„ä¸Šå¸å¯¹è±¡ã€‚ Demo javax.faces.context.FacesContext åœ¨åº•å±‚ä½¿ç”¨äº† LifeCycleã€ViewHandler å’Œ NavigationHandler è¿™å‡ ä¸ªç±»ã€‚ï¼ˆä½†ç»å¤§å¤šæ•°å®¢æˆ·ç«¯ä¸çŸ¥é“ï¼‰ javax.faces.context.ExternalContext åœ¨å†…éƒ¨ä½¿ç”¨äº† ServletContextã€HttpSessionã€ HttpServletRequestã€ HttpServletResponse å’Œå…¶ä»–ä¸€äº›ç±»ã€‚\nå¾®æœåŠ¡ä¸­ï¼ŒAPIç½‘å…³çš„è®¾è®¡ä¹Ÿæ˜¯é—¨é¢æ¨¡å¼\n2.6.Flyweight äº«å…ƒæ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ å®ƒæ‘’å¼ƒäº†åœ¨æ¯ä¸ªå¯¹è±¡ä¸­ä¿å­˜æ‰€æœ‰æ•°æ®çš„æ–¹å¼ï¼Œ é€šè¿‡å…±äº«å¤šä¸ªå¯¹è±¡æ‰€å…±æœ‰çš„ç›¸åŒçŠ¶æ€ï¼Œ è®©èƒ½åœ¨æœ‰é™çš„å†…å­˜å®¹é‡ä¸­è½½å…¥æ›´å¤šå¯¹è±¡ã€‚\nUsage ä»…åœ¨ç¨‹åºå¿…é¡»æ”¯æŒå¤§é‡å¯¹è±¡ä¸”æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜å®¹é‡æ—¶ä½¿ç”¨äº«å…ƒæ¨¡å¼ã€‚ Advantages å¦‚æœç¨‹åºä¸­æœ‰å¾ˆå¤šç›¸ä¼¼å¯¹è±¡ï¼Œ é‚£ä¹ˆå°†å¯ä»¥èŠ‚çœå¤§é‡å†…å­˜ã€‚ Disadvantages å¯èƒ½éœ€è¦ç‰ºç‰²æ‰§è¡Œé€Ÿåº¦æ¥æ¢å–å†…å­˜ï¼Œ å› ä¸ºä»–äººæ¯æ¬¡è°ƒç”¨äº«å…ƒæ–¹æ³•æ—¶éƒ½éœ€è¦é‡æ–°è®¡ç®—éƒ¨åˆ†æƒ…æ™¯æ•°æ®ã€‚ ä»£ç ä¼šå˜å¾—æ›´åŠ å¤æ‚ã€‚ å›¢é˜Ÿä¸­çš„æ–°æˆå‘˜æ€»æ˜¯ä¼šé—®ï¼š â€œä¸ºä»€ä¹ˆè¦åƒè¿™æ ·æ‹†åˆ†ä¸€ä¸ªå®ä½“çš„çŠ¶æ€ï¼Ÿâ€ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 import java.awt.*; import java.util.HashMap; import java.util.Map; public class TreeFactory { static Map\u0026lt;String, TreeType\u0026gt; treeTypes = new HashMap\u0026lt;\u0026gt;(); public static TreeType getTreeType(String name, Color color, String otherTreeData) { TreeType result = treeTypes.get(name); if (result == null) { result = new TreeType(name, color, otherTreeData); treeTypes.put(name, result); } return result; } } public class Forest extends JFrame { private List\u0026lt;Tree\u0026gt; trees = new ArrayList\u0026lt;\u0026gt;(); public void plantTree(int x, int y, String name, Color color, String otherTreeData) { TreeType type = TreeFactory.getTreeType(name, color, otherTreeData); Tree tree = new Tree(x, y, type); trees.add(tree); } @Override public void paint(Graphics graphics) { for (Tree tree : trees) { tree.draw(graphics); } } } Integerä¸­ä¹Ÿä½¿ç”¨äº†äº«å…ƒæ¨¡å¼\n1 2 3 4 5 6 7 8 //åœ¨-128ï½127ä½¿ç”¨éå¸¸é¢‘ç¹ï¼Œè®¾ç½®IntegerCacheæ¥åŒ…è£… public final class Integer extends Number implements Comparable\u0026lt;Integer\u0026gt; { public static Integer valueOf(int i) { if (i \u0026gt;= IntegerCache.low \u0026amp;\u0026amp; i \u0026lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i); } } 2.7.Proxy ä»£ç†æ¨¡å¼æ˜¯ä¸€ç§ç»“æ„å‹è®¾è®¡æ¨¡å¼ï¼Œ è®©èƒ½å¤Ÿæä¾›å¯¹è±¡çš„æ›¿ä»£å“æˆ–å…¶å ä½ç¬¦ã€‚ ä»£ç†æ§åˆ¶ç€å¯¹äºåŸå¯¹è±¡çš„è®¿é—®ï¼Œ å¹¶å…è®¸åœ¨å°†è¯·æ±‚æäº¤ç»™å¯¹è±¡å‰åè¿›è¡Œä¸€äº›å¤„ç†ã€‚\nUsage å»¶è¿Ÿåˆå§‹åŒ– ï¼ˆè™šæ‹Ÿä»£ç†ï¼‰ã€‚ å¦‚æœæœ‰ä¸€ä¸ªå¶å°”ä½¿ç”¨çš„é‡é‡çº§æœåŠ¡å¯¹è±¡ï¼Œ ä¸€ç›´ä¿æŒè¯¥å¯¹è±¡è¿è¡Œä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºæ—¶ï¼Œ å¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚ è®¿é—®æ§åˆ¶ ï¼ˆä¿æŠ¤ä»£ç†ï¼‰ã€‚ å¦‚æœåªå¸Œæœ›ç‰¹å®šå®¢æˆ·ç«¯ä½¿ç”¨æœåŠ¡å¯¹è±¡ï¼Œ è¿™é‡Œçš„å¯¹è±¡å¯ä»¥æ˜¯æ“ä½œç³»ç»Ÿä¸­éå¸¸é‡è¦çš„éƒ¨åˆ†ï¼Œ è€Œå®¢æˆ·ç«¯åˆ™æ˜¯å„ç§å·²å¯åŠ¨çš„ç¨‹åº ï¼ˆåŒ…æ‹¬æ¶æ„ç¨‹åºï¼‰ï¼Œ æ­¤æ—¶å¯ä½¿ç”¨ä»£ç†æ¨¡å¼ã€‚ æœ¬åœ°æ‰§è¡Œè¿œç¨‹æœåŠ¡ ï¼ˆè¿œç¨‹ä»£ç†ï¼‰ã€‚ é€‚ç”¨äºæœåŠ¡å¯¹è±¡ä½äºè¿œç¨‹æœåŠ¡å™¨ä¸Šçš„æƒ…å½¢ã€‚ è®°å½•æ—¥å¿—è¯·æ±‚ ï¼ˆæ—¥å¿—è®°å½•ä»£ç†ï¼‰ã€‚ é€‚ç”¨äºå½“éœ€è¦ä¿å­˜å¯¹äºæœåŠ¡å¯¹è±¡çš„è¯·æ±‚å†å²è®°å½•æ—¶ã€‚ ä»£ç†å¯ä»¥åœ¨å‘æœåŠ¡ä¼ é€’è¯·æ±‚å‰è¿›è¡Œè®°å½• æ™ºèƒ½å¼•ç”¨ã€‚ å¯åœ¨æ²¡æœ‰å®¢æˆ·ç«¯ä½¿ç”¨æŸä¸ªé‡é‡çº§å¯¹è±¡æ—¶ç«‹å³é”€æ¯è¯¥å¯¹è±¡ã€‚ Advantages å¯ä»¥åœ¨å®¢æˆ·ç«¯æ¯«æ— å¯Ÿè§‰çš„æƒ…å†µä¸‹æ§åˆ¶æœåŠ¡å¯¹è±¡ã€‚ å¦‚æœå®¢æˆ·ç«¯å¯¹æœåŠ¡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰ç‰¹æ®Šè¦æ±‚ï¼Œ å¯ä»¥å¯¹ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç†ã€‚ å³ä½¿æœåŠ¡å¯¹è±¡è¿˜æœªå‡†å¤‡å¥½æˆ–ä¸å­˜åœ¨ï¼Œ ä»£ç†ä¹Ÿå¯ä»¥æ­£å¸¸å·¥ä½œã€‚ å¼€é—­åŸåˆ™ã€‚ å¯ä»¥åœ¨ä¸å¯¹æœåŠ¡æˆ–å®¢æˆ·ç«¯åšå‡ºä¿®æ”¹çš„æƒ…å†µä¸‹åˆ›å»ºæ–°ä»£ç†ã€‚ Disadvantages ä»£ç å¯èƒ½ä¼šå˜å¾—å¤æ‚ï¼Œ å› ä¸ºéœ€è¦æ–°å»ºè®¸å¤šç±»ã€‚ æœåŠ¡å“åº”å¯èƒ½ä¼šå»¶è¿Ÿã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 //javax.ejb.EJB public class UserServiceProxy extends UserService implements Serializable { public User find(Long id) { UserService instance = getAnAvailableInstanceFromPool(); User result = instance.find(id); releaseInstanceToPool(instance); return result; } public Long save(User user) { UserService instance = getAnAvailableInstanceFromPool(); Long result = instance.save(user); releaseInstanceToPool(instance); return result; } // ... } åœ¨MVCæ¨¡å¼ä¸­ï¼Œä¹Ÿå¤§é‡ä½¿ç”¨ä»£ç†æ¨¡å¼\n1 2 3 4 5 6 7 8 9 @Service public SomeServiceImpl implements SomeService{ @AutoWired private SomeService someService; public void doSome(){ someService.doSome(); } } 3. Behavioral Patterns 3.1.Chain of Responsibility è´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸å°†è¯·æ±‚æ²¿ç€å¤„ç†è€…é“¾è¿›è¡Œå‘é€ã€‚ æ”¶åˆ°è¯·æ±‚åï¼Œ æ¯ä¸ªå¤„ç†è€…å‡å¯å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œ æˆ–å°†å…¶ä¼ é€’ç»™é“¾ä¸Šçš„ä¸‹ä¸ªå¤„ç†è€…ã€‚\nUsage å½“ç¨‹åºéœ€è¦ä½¿ç”¨ä¸åŒæ–¹å¼å¤„ç†ä¸åŒç§ç±»è¯·æ±‚ï¼Œ è€Œä¸”è¯·æ±‚ç±»å‹å’Œé¡ºåºé¢„å…ˆæœªçŸ¥æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ã€‚ å½“å¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œå¤šä¸ªå¤„ç†è€…æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ å¦‚æœæ‰€éœ€å¤„ç†è€…åŠå…¶é¡ºåºå¿…é¡»åœ¨è¿è¡Œæ—¶è¿›è¡Œæ”¹å˜ï¼Œ å¯ä»¥ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ã€‚ Advantages å¯ä»¥æ§åˆ¶è¯·æ±‚å¤„ç†çš„é¡ºåºã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯å¯¹å‘èµ·æ“ä½œå’Œæ‰§è¡Œæ“ä½œçš„ç±»è¿›è¡Œè§£è€¦ã€‚ å¼€é—­åŸåˆ™ã€‚ å¯ä»¥åœ¨ä¸æ›´æ”¹ç°æœ‰ä»£ç çš„æƒ…å†µä¸‹åœ¨ç¨‹åºä¸­æ–°å¢å¤„ç†è€…ã€‚ Disadvantages éƒ¨åˆ†è¯·æ±‚å¯èƒ½æœªè¢«å¤„ç†ã€‚ Demo ä¸ºç³»ç»Ÿorç»„ä»¶è®°å½•æ—¥å¿—æ¶ˆæ¯ã€‚å¦‚ä½•ä½“ç°äº†èŒè´£é“¾æ¨¡å¼ï¼šæ¯ä¸ªè®°å½•å™¨éƒ½è·Ÿè¸ªâ€œçˆ¶â€è®°å½•å™¨ï¼Œæ‰€è°“â€çˆ¶â€è®°å½•å™¨ï¼Œå°±æ˜¯Loggerå‘½åç©ºé—´ä¸­æœ€è¿‘çš„ç°æœ‰ç¥–å…ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 public class Logger { public void log(LogRecord record) { if (!isLoggable(record.getLevel())) { return; } Filter theFilter = filter; if (theFilter != null \u0026amp;\u0026amp; !theFilter.isLoggable(record)) { return; } // Post the LogRecord to all our Handlers, and then to // our parents\u0026#39; handlers, all the way up the tree. Logger logger = this; while (logger != null) { final Handler[] loggerHandlers = isSystemLogger ? logger.accessCheckedHandlers() : logger.getHandlers(); // è´£ä»»é“¾æ¨¡å¼ //æ¯ä¸ªæ—¥å¿—è®°å½•éƒ½ä¼ é€’ç»™åˆ†é…ç»™ç»™å®šè®°å½•å™¨çš„æ¯ä¸ªHandlerï¼Œå¦‚æœuseParentHandlersæ˜¯trueï¼Œåˆ™å°†ç›¸åŒçš„ç®—æ³•ä¸€ç›´åº”ç”¨äºçˆ¶çº§ã€‚ for (Handler handler : loggerHandlers) { handler.publish(record); } final boolean useParentHdls = isSystemLogger ? logger.useParentHandlers : logger.getUseParentHandlers(); if (!useParentHdls) { break; } logger = isSystemLogger ? logger.parent : logger.getParent(); } } } åœ¨ javax.servlet.Filter#doFilter() ä¹Ÿæœ‰ä½¿ç”¨\n3.2.Command å‘½ä»¤æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒå¯å°†è¯·æ±‚è½¬æ¢ä¸ºä¸€ä¸ªåŒ…å«ä¸è¯·æ±‚ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯çš„ç‹¬ç«‹å¯¹è±¡ã€‚ è¯¥è½¬æ¢è®©èƒ½æ ¹æ®ä¸åŒçš„è¯·æ±‚å°†æ–¹æ³•å‚æ•°åŒ–ã€ å»¶è¿Ÿè¯·æ±‚æ‰§è¡Œæˆ–å°†å…¶æ”¾å…¥é˜Ÿåˆ—ä¸­ï¼Œ ä¸”èƒ½å®ç°å¯æ’¤é”€æ“ä½œã€‚\nUsage å¦‚æœéœ€è¦é€šè¿‡æ“ä½œæ¥å‚æ•°åŒ–å¯¹è±¡ï¼Œ å¯ä½¿ç”¨å‘½ä»¤æ¨¡å¼ã€‚ å¦‚æœæƒ³è¦å°†æ“ä½œæ”¾å…¥é˜Ÿåˆ—ä¸­ã€ æ“ä½œçš„æ‰§è¡Œæˆ–è€…è¿œç¨‹æ‰§è¡Œæ“ä½œï¼Œ å¯ä½¿ç”¨å‘½ä»¤æ¨¡å¼ã€‚ å¦‚æœæƒ³è¦å®ç°æ“ä½œå›æ»šåŠŸèƒ½ï¼Œ å¯ä½¿ç”¨å‘½ä»¤æ¨¡å¼ã€‚ Advantages å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯ä»¥è§£è€¦è§¦å‘å’Œæ‰§è¡Œæ“ä½œçš„ç±»ã€‚ å¼€é—­åŸåˆ™ã€‚ å¯ä»¥åœ¨ä¸ä¿®æ”¹å·²æœ‰å®¢æˆ·ç«¯ä»£ç çš„æƒ…å†µä¸‹åœ¨ç¨‹åºä¸­åˆ›å»ºæ–°çš„å‘½ä»¤ã€‚ å¯ä»¥å®ç°æ’¤é”€å’Œæ¢å¤åŠŸèƒ½ã€‚ å¯ä»¥å®ç°æ“ä½œçš„å»¶è¿Ÿæ‰§è¡Œã€‚ å¯ä»¥å°†ä¸€ç»„ç®€å•å‘½ä»¤ç»„åˆæˆä¸€ä¸ªå¤æ‚å‘½ä»¤ã€‚ Disadvantages ä»£ç å¯èƒ½ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œ å› ä¸ºåœ¨å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å¢åŠ äº†ä¸€ä¸ªå…¨æ–°çš„å±‚æ¬¡ã€‚ Demo Runnableæ‹…å½“å‘½ä»¤çš„è§’è‰²ï¼ŒThreadå……å½“çš„æ˜¯è°ƒç”¨è€…ï¼Œstartæ–¹æ³•å°±æ˜¯å…¶æ‰§è¡Œæ–¹æ³•ã€‚\né€šè¿‡å®ç°Runableæ¥å£çš„ç±»ï¼Œå°†è¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è¯·æ±‚æ’é˜Ÿæˆ–è®°å½•è¯·æ±‚æ—¥å¿—ï¼Œä»¥åŠæ”¯æŒå¯æ’¤é”€æ“ä½œã€‚å…è®¸æ¥å—è¯·æ±‚çš„ä¸€æ–¹å†³å®šæ˜¯å¦è¦å¦å†³è¯·æ±‚ï¼Œæœ€é‡è¦ä¸€ç‚¹å°±æ˜¯ï¼šå‘½ä»¤æ¨¡å¼æŠŠè¯·æ±‚ä¸€ä¸ªæ“ä½œçš„å¯¹è±¡å’Œæ€ä¹ˆæ‰§è¡Œä¸€ä¸ªæ“ä½œçš„å¯¹è±¡è§£è€¦ã€‚è¿™å°±æ˜¯Excutoræ¡†æ¶æ‰§è¡Œå®ç°Runableæ¥å£ä»»åŠ¡ç±»çš„ä½“ç°ã€‚\n1 2 3 4 5 6 7 8 package java.lang; /* Thread poolsï¼ˆçº¿ç¨‹æ± ï¼‰ é€šå¸¸ä¸€ä¸ªå…¸å‹çš„çº¿ç¨‹æ± å®ç°ç±»å¯èƒ½æœ‰ä¸€ä¸ªåä¸ºaddTask()çš„publicæ–¹æ³•ï¼Œç”¨æ¥æ·»åŠ ä¸€é¡¹å·¥ä½œä»»åŠ¡åˆ°ä»»åŠ¡ é˜Ÿåˆ—ä¸­ã€‚è¯¥ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡å¯ä»¥ç”¨commandå¯¹è±¡æ¥å°è£…ï¼Œé€šå¸¸è¿™äº›commandå¯¹è±¡ä¼šå®ç°ä¸€ä¸ªé€šç”¨çš„æ¥å£æ¯”å¦‚java.lang.Runnableã€‚ */ @FunctionalInterface public interface Runnable { public abstract void run(); } 3.3.Iterator è¿­ä»£å™¨æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ è®©èƒ½åœ¨ä¸æš´éœ²é›†åˆåº•å±‚è¡¨ç°å½¢å¼ ï¼ˆåˆ—è¡¨ã€ æ ˆå’Œæ ‘ç­‰ï¼‰ çš„æƒ…å†µä¸‹éå†é›†åˆä¸­æ‰€æœ‰çš„å…ƒç´ ã€‚\nUsage å½“é›†åˆèƒŒåä¸ºå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œ ä¸”å¸Œæœ›å¯¹å®¢æˆ·ç«¯éšè—å…¶å¤æ‚æ€§æ—¶ ï¼ˆå‡ºäºä½¿ç”¨ä¾¿åˆ©æ€§æˆ–å®‰å…¨æ€§çš„è€ƒè™‘ï¼‰ï¼Œ å¯ä»¥ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼ã€‚ ä½¿ç”¨è¯¥æ¨¡å¼å¯ä»¥å‡å°‘ç¨‹åºä¸­é‡å¤çš„éå†ä»£ç ã€‚ å¦‚æœå¸Œæœ›ä»£ç èƒ½å¤Ÿéå†ä¸åŒçš„ç”šè‡³æ˜¯æ— æ³•é¢„çŸ¥çš„æ•°æ®ç»“æ„ï¼Œ å¯ä»¥ä½¿ç”¨è¿­ä»£å™¨æ¨¡å¼ã€‚ Advantages å•ä¸€èŒè´£åŸåˆ™ã€‚ é€šè¿‡å°†ä½“ç§¯åºå¤§çš„éå†ç®—æ³•ä»£ç æŠ½å–ä¸ºç‹¬ç«‹çš„ç±»ï¼Œ å¯å¯¹å®¢æˆ·ç«¯ä»£ç å’Œé›†åˆè¿›è¡Œæ•´ç†ã€‚ å¼€é—­åŸåˆ™ã€‚ å¯å®ç°æ–°å‹çš„é›†åˆå’Œè¿­ä»£å™¨å¹¶å°†å…¶ä¼ é€’ç»™ç°æœ‰ä»£ç ï¼Œ æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ã€‚ å¯ä»¥å¹¶è¡Œéå†åŒä¸€é›†åˆï¼Œ å› ä¸ºæ¯ä¸ªè¿­ä»£å™¨å¯¹è±¡éƒ½åŒ…å«å…¶è‡ªèº«çš„éå†çŠ¶æ€ã€‚ ç›¸ä¼¼çš„ï¼Œ å¯ä»¥æš‚åœéå†å¹¶åœ¨éœ€è¦æ—¶ç»§ç»­ã€‚ Disadvantages å¦‚æœçš„ç¨‹åºåªä¸ç®€å•çš„é›†åˆè¿›è¡Œäº¤äº’ï¼Œ åº”ç”¨è¯¥æ¨¡å¼å¯èƒ½ä¼šçŸ«æ‰è¿‡æ­£ã€‚ å¯¹äºæŸäº›ç‰¹æ®Šé›†åˆï¼Œ ä½¿ç”¨è¿­ä»£å™¨å¯èƒ½æ¯”ç›´æ¥éå†çš„æ•ˆç‡ä½ã€‚ Demo è®¸å¤šæ¡†æ¶å’Œç¨‹åºåº“éƒ½ä¼šä½¿ç”¨å®ƒæ¥æä¾›éå†å…¶é›†åˆçš„æ ‡å‡†æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 package java.util; import java.util.function.Consumer; public interface Iterator\u0026lt;E\u0026gt; { boolean hasNext(); E next(); default void remove() { throw new UnsupportedOperationException(\u0026#34;remove\u0026#34;); } default void forEachRemaining(Consumer\u0026lt;? super E\u0026gt; action) { Objects.requireNonNull(action); while (hasNext()) action.accept(next()); } } 1 2 3 4 5 6 7 8 package java.util; public interface Enumeration\u0026lt;E\u0026gt; { boolean hasMoreElements(); E nextElement(); } 3.4.Mediator ä¸­ä»‹è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ èƒ½è®©å‡å°‘å¯¹è±¡ä¹‹é—´æ··ä¹±æ— åºçš„ä¾èµ–å…³ç³»ã€‚ è¯¥æ¨¡å¼ä¼šé™åˆ¶å¯¹è±¡ä¹‹é—´çš„ç›´æ¥äº¤äº’ï¼Œ è¿«ä½¿å®ƒä»¬é€šè¿‡ä¸€ä¸ªä¸­ä»‹è€…å¯¹è±¡è¿›è¡Œåˆä½œã€‚\nUsage å½“ä¸€äº›å¯¹è±¡å’Œå…¶ä»–å¯¹è±¡ç´§å¯†è€¦åˆä»¥è‡´éš¾ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚ å½“ç»„ä»¶å› è¿‡äºä¾èµ–å…¶ä»–ç»„ä»¶è€Œæ— æ³•åœ¨ä¸åŒåº”ç”¨ä¸­å¤ç”¨æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚ å¦‚æœä¸ºäº†èƒ½åœ¨ä¸åŒæƒ…æ™¯ä¸‹å¤ç”¨ä¸€äº›åŸºæœ¬è¡Œä¸ºï¼Œ å¯¼è‡´éœ€è¦è¢«è¿«åˆ›å»ºå¤§é‡ç»„ä»¶å­ç±»æ—¶ï¼Œ å¯ä½¿ç”¨ä¸­ä»‹è€…æ¨¡å¼ã€‚ Advantages å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯ä»¥å°†å¤šä¸ªç»„ä»¶é—´çš„äº¤æµæŠ½å–åˆ°åŒä¸€ä½ç½®ï¼Œ ä½¿å…¶æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚ å¼€é—­åŸåˆ™ã€‚ æ— éœ€ä¿®æ”¹å®é™…ç»„ä»¶å°±èƒ½å¢åŠ æ–°çš„ä¸­ä»‹è€…ã€‚ å¯ä»¥å‡è½»åº”ç”¨ä¸­å¤šä¸ªç»„ä»¶é—´çš„è€¦åˆæƒ…å†µã€‚ å¯ä»¥æ›´æ–¹ä¾¿åœ°å¤ç”¨å„ä¸ªç»„ä»¶ã€‚ Disadvantages ä¸€æ®µæ—¶é—´åï¼Œ ä¸­ä»‹è€…å¯èƒ½ä¼šæ¼”åŒ–æˆä¸ºä¸Šå¸å¯¹è±¡ã€‚ Demo MVCä¸­çš„Controllerå°±æ˜¯ä¸­ä»‹è€…\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 package java.util; import java.util.Date; import java.util.concurrent.atomic.AtomicInteger; public class Timer { public void schedule(TimerTask task, long delay, long period) { if (delay \u0026lt; 0) throw new IllegalArgumentException(\u0026#34;Negative delay.\u0026#34;); if (period \u0026lt;= 0) throw new IllegalArgumentException(\u0026#34;Non-positive period.\u0026#34;); sched(task, System.currentTimeMillis()+delay, -period); } //ä»¥åŠå…¶ä»–scheduleæ–¹æ³• } ä»¥åŠJUCä¸­çš„\n1 2 3 4 5 package java.util.concurrent; public interface Executor { void execute(Runnable command); } ä¸åå°„çš„invoke\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 package java.lang.reflect; import ... public final class Method extends Executable { @CallerSensitive public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException { if (!override) { if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) { Class\u0026lt;?\u0026gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, obj, modifiers); } } MethodAccessor ma = methodAccessor; // read volatile if (ma == null) { ma = acquireMethodAccessor(); } return ma.invoke(obj, args); } } /* package sun.reflect; @Retention(RetentionPolicy.RUNTIME) @Target({METHOD}) public @interface CallerSensitive { } */ 3.5.Snapshot å¤‡å¿˜å½•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸åœ¨ä¸æš´éœ²å¯¹è±¡å®ç°ç»†èŠ‚çš„æƒ…å†µä¸‹ä¿å­˜å’Œæ¢å¤å¯¹è±¡ä¹‹å‰çš„çŠ¶æ€ã€‚\nUsage å½“éœ€è¦åˆ›å»ºå¯¹è±¡çŠ¶æ€å¿«ç…§æ¥æ¢å¤å…¶ä¹‹å‰çš„çŠ¶æ€æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨å¤‡å¿˜å½•æ¨¡å¼ã€‚ å½“ç›´æ¥è®¿é—®å¯¹è±¡çš„æˆå‘˜å˜é‡ã€ è·å–å™¨æˆ–è®¾ç½®å™¨å°†å¯¼è‡´å°è£…è¢«çªç ´æ—¶ï¼Œ å¯ä»¥ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ Advantages å¯ä»¥åœ¨ä¸ç ´åå¯¹è±¡å°è£…æƒ…å†µçš„å‰æä¸‹åˆ›å»ºå¯¹è±¡çŠ¶æ€å¿«ç…§ã€‚ å¯ä»¥é€šè¿‡è®©è´Ÿè´£äººç»´æŠ¤åŸå‘å™¨çŠ¶æ€å†å²è®°å½•æ¥ç®€åŒ–åŸå‘å™¨ä»£ç ã€‚ Disadvantages å¦‚æœå®¢æˆ·ç«¯è¿‡äºé¢‘ç¹åœ°åˆ›å»ºå¤‡å¿˜å½•ï¼Œ ç¨‹åºå°†æ¶ˆè€—å¤§é‡å†…å­˜ã€‚ è´Ÿè´£äººå¿…é¡»å®Œæ•´è·Ÿè¸ªåŸå‘å™¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œ è¿™æ ·æ‰èƒ½é”€æ¯å¼ƒç”¨çš„å¤‡å¿˜å½•ã€‚ ç»å¤§éƒ¨åˆ†åŠ¨æ€ç¼–ç¨‹è¯­è¨€ ï¼ˆä¾‹å¦‚ PHPã€ Python å’Œ JavaScriptï¼‰ ä¸èƒ½ç¡®ä¿å¤‡å¿˜å½•ä¸­çš„çŠ¶æ€ä¸è¢«ä¿®æ”¹ã€‚ Demo 1 2 3 package java.io; public interface Serializable { } 3.6.Observer è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å…è®¸å®šä¹‰ä¸€ç§è®¢é˜…æœºåˆ¶ï¼Œ å¯åœ¨å¯¹è±¡äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥å¤šä¸ª â€œè§‚å¯Ÿâ€ è¯¥å¯¹è±¡çš„å…¶ä»–å¯¹è±¡ã€‚\nUsage å½“ä¸€ä¸ªå¯¹è±¡çŠ¶æ€çš„æ”¹å˜éœ€è¦æ”¹å˜å…¶ä»–å¯¹è±¡ï¼Œ æˆ–å®é™…å¯¹è±¡æ˜¯äº‹å…ˆæœªçŸ¥çš„æˆ–åŠ¨æ€å˜åŒ–çš„æ—¶ï¼Œ å¯ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ã€‚\nå½“åº”ç”¨ä¸­çš„ä¸€äº›å¯¹è±¡å¿…é¡»è§‚å¯Ÿå…¶ä»–å¯¹è±¡æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ ä½†ä»…èƒ½åœ¨æœ‰é™æ—¶é—´å†…æˆ–ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨ã€‚\nAdvantages å¼€é—­åŸåˆ™ã€‚ æ— éœ€ä¿®æ”¹å‘å¸ƒè€…ä»£ç å°±èƒ½å¼•å…¥æ–°çš„è®¢é˜…è€…ç±» ï¼ˆå¦‚æœæ˜¯å‘å¸ƒè€…æ¥å£åˆ™å¯è½»æ¾å¼•å…¥å‘å¸ƒè€…ç±»ï¼‰ã€‚ å¯ä»¥åœ¨è¿è¡Œæ—¶å»ºç«‹å¯¹è±¡ä¹‹é—´çš„è”ç³»ã€‚ Disadvantages è®¢é˜…è€…çš„é€šçŸ¥é¡ºåºæ˜¯éšæœºçš„ã€‚ Demo 1 2 3 4 5 6 package java.util; public interface EventListener { } //å¹¿æ³›åº”ç”¨äºSwingç»„ä»¶ åœ¨servletä¸­javax.servlet.http.HttpSessionBindingListenerå’Œjavax.servlet.http.HttpSessionAttributeListenerå‡ºç°\n1 2 3 4 5 6 7 8 9 10 // å®‰å“å¼€å‘ä¸­çš„buttonè§‚å¯Ÿè€…æ³¨å†Œ Button button = (Button) findViewById(R.id.button); //æ³¨å†Œè§‚å¯Ÿè€… button.setOnClickListener(new View.OnClickListener(){ //è§‚å¯Ÿè€…å®ç° @Override public void onClick(View arg0) { Log.d(\u0026#34;test\u0026#34;, \u0026#34;Click button \u0026#34;); } }); 3.7.State çŠ¶æ€æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ è®©èƒ½åœ¨ä¸€ä¸ªå¯¹è±¡çš„å†…éƒ¨çŠ¶æ€å˜åŒ–æ—¶æ”¹å˜å…¶è¡Œä¸ºï¼Œ ä½¿å…¶çœ‹ä¸Šå»å°±åƒæ”¹å˜äº†è‡ªèº«æ‰€ å±çš„ç±»ä¸€æ ·ã€‚ï¼ˆæœ‰é™çŠ¶æ€æœºï¼‰\nUsage å¦‚æœå¯¹è±¡éœ€è¦æ ¹æ®è‡ªèº«å½“å‰çŠ¶æ€è¿›è¡Œä¸åŒè¡Œä¸ºï¼Œ åŒæ—¶çŠ¶æ€çš„æ•°é‡éå¸¸å¤šä¸”ä¸çŠ¶æ€ç›¸å…³çš„ä»£ç ä¼šé¢‘ç¹å˜æ›´çš„è¯ï¼Œ å¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚ å¦‚æœæŸä¸ªç±»éœ€è¦æ ¹æ®æˆå‘˜å˜é‡çš„å½“å‰å€¼æ”¹å˜è‡ªèº«è¡Œä¸ºï¼Œ ä»è€Œéœ€è¦ä½¿ç”¨å¤§é‡çš„æ¡ä»¶è¯­å¥æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ å½“ç›¸ä¼¼çŠ¶æ€å’ŒåŸºäºæ¡ä»¶çš„çŠ¶æ€æœºè½¬æ¢ä¸­å­˜åœ¨è®¸å¤šé‡å¤ä»£ç æ—¶ï¼Œ å¯ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚ Advantages å•ä¸€èŒè´£åŸåˆ™ã€‚ å°†ä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„ä»£ç æ”¾åœ¨å•ç‹¬çš„ç±»ä¸­ã€‚ å¼€é—­åŸåˆ™ã€‚ æ— éœ€ä¿®æ”¹å·²æœ‰çŠ¶æ€ç±»å’Œä¸Šä¸‹æ–‡å°±èƒ½å¼•å…¥æ–°çŠ¶æ€ã€‚ é€šè¿‡æ¶ˆé™¤è‡ƒè‚¿çš„çŠ¶æ€æœºæ¡ä»¶è¯­å¥ç®€åŒ–ä¸Šä¸‹æ–‡ä»£ç ã€‚ Disadvantages å¦‚æœçŠ¶æ€æœºåªæœ‰å¾ˆå°‘çš„å‡ ä¸ªçŠ¶æ€ï¼Œ æˆ–è€…å¾ˆå°‘å‘ç”Ÿæ”¹å˜ï¼Œ é‚£ä¹ˆåº”ç”¨è¯¥æ¨¡å¼å¯èƒ½ä¼šæ˜¾å¾—å°é¢˜å¤§ä½œã€‚ Demo 1 javax.faces.lifecycle.LifeCycle#execute() è®¡ç®—æœºç½‘ç»œä¸­çš„rdtæ¨¡å‹\nåŒ…æ‹¬github.com/askervin/goresctrl\n3.8.Strategy ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½è®©å®šä¹‰ä¸€ç³»åˆ—ç®—æ³•ï¼Œ å¹¶å°†æ¯ç§ç®—æ³•åˆ†åˆ«æ”¾å…¥ç‹¬ç«‹çš„ç±»ä¸­ï¼Œ ä»¥ä½¿ç®—æ³•çš„å¯¹è±¡èƒ½å¤Ÿç›¸äº’æ›¿æ¢ã€‚\nUsage å½“æƒ³ä½¿ç”¨å¯¹è±¡ä¸­å„ç§ä¸åŒçš„ç®—æ³•å˜ä½“ï¼Œ å¹¶å¸Œæœ›èƒ½åœ¨è¿è¡Œæ—¶åˆ‡æ¢ç®—æ³•æ—¶ï¼Œ å¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚ å½“æœ‰è®¸å¤šä»…åœ¨æ‰§è¡ŒæŸäº›è¡Œä¸ºæ—¶ç•¥æœ‰ä¸åŒçš„ç›¸ä¼¼ç±»æ—¶ï¼Œ å¯ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚ å¦‚æœç®—æ³•åœ¨ä¸Šä¸‹æ–‡çš„é€»è¾‘ä¸­ä¸æ˜¯ç‰¹åˆ«é‡è¦ï¼Œ ä½¿ç”¨è¯¥æ¨¡å¼èƒ½å°†ç±»çš„ä¸šåŠ¡é€»è¾‘ä¸å…¶ç®—æ³•å®ç°ç»†èŠ‚éš”ç¦»å¼€æ¥ã€‚ å½“ç±»ä¸­ä½¿ç”¨äº†å¤æ‚æ¡ä»¶è¿ç®—ç¬¦ä»¥åœ¨åŒä¸€ç®—æ³•çš„ä¸åŒå˜ä½“ä¸­åˆ‡æ¢æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ Advantages å¯ä»¥åœ¨è¿è¡Œæ—¶åˆ‡æ¢å¯¹è±¡å†…çš„ç®—æ³•ã€‚ å¯ä»¥å°†ç®—æ³•çš„å®ç°å’Œä½¿ç”¨ç®—æ³•çš„ä»£ç éš”ç¦»å¼€æ¥ã€‚ å¯ä»¥ä½¿ç”¨ç»„åˆæ¥ä»£æ›¿ç»§æ‰¿ã€‚ å¼€é—­åŸåˆ™ã€‚ æ— éœ€å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œä¿®æ”¹å°±èƒ½å¤Ÿå¼•å…¥æ–°çš„ç­–ç•¥ã€‚ Disadvantages å¦‚æœçš„ç®—æ³•æå°‘å‘ç”Ÿæ”¹å˜ï¼Œ é‚£ä¹ˆæ²¡æœ‰ä»»ä½•ç†ç”±å¼•å…¥æ–°çš„ç±»å’Œæ¥å£ã€‚ ä½¿ç”¨è¯¥æ¨¡å¼åªä¼šè®©ç¨‹åºè¿‡äºå¤æ‚ã€‚ å®¢æˆ·ç«¯å¿…é¡»çŸ¥æ™“ç­–ç•¥é—´çš„ä¸åŒâ€”â€”å®ƒéœ€è¦é€‰æ‹©åˆé€‚çš„ç­–ç•¥ã€‚ è®¸å¤šç°ä»£ç¼–ç¨‹è¯­è¨€æ”¯æŒå‡½æ•°ç±»å‹åŠŸèƒ½ï¼Œ å…è®¸åœ¨ä¸€ç»„åŒ¿åå‡½æ•°ä¸­å®ç°ä¸åŒç‰ˆæœ¬çš„ç®—æ³•ã€‚ è¿™æ ·ï¼Œ ä½¿ç”¨è¿™äº›å‡½æ•°çš„æ–¹å¼å°±å’Œä½¿ç”¨ç­–ç•¥å¯¹è±¡æ—¶å®Œå…¨ç›¸åŒï¼Œ æ— éœ€å€ŸåŠ©é¢å¤–çš„ç±»å’Œæ¥å£æ¥ä¿æŒä»£ç ç®€æ´ã€‚ Demo Lambdaæ–¹æ³•å°±æ˜¯ä»£æ›¿ç­–ç•¥æ¨¡å¼çš„ç®€å•å®ç° javax.servlet.http.HttpServletï¼š service()æ–¹æ³•ï¼Œ è¿˜æœ‰æ‰€æœ‰æ¥å— Http.Servlet.Requestå’Œ Http.Servlet.Responseå¯¹è±¡ä½œä¸ºå‚æ•°çš„ doXXX()æ–¹æ³•ã€‚ ä»¥åŠjavax.servlet.Filter#doFilter()\n1 2 3 4 5 6 7 8 9 10 @FunctionalInterface public interface Comparator\u0026lt;T\u0026gt; { int compare(T o1, T o2); } public class Collections { public static \u0026lt;T\u0026gt; void sort(List\u0026lt;T\u0026gt; list, Comparator\u0026lt;? super T\u0026gt; c) { list.sort(c); } } 3.9.Template Method æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒåœ¨è¶…ç±»ä¸­å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„æ¡†æ¶ï¼Œ å…è®¸å­ç±»åœ¨ä¸ä¿®æ”¹ç»“æ„çš„æƒ…å†µä¸‹é‡å†™ç®—æ³•çš„ç‰¹å®šæ­¥éª¤ã€‚\nUsage å½“åªå¸Œæœ›å®¢æˆ·ç«¯æ‰©å±•æŸä¸ªç‰¹å®šç®—æ³•æ­¥éª¤ï¼Œ è€Œä¸æ˜¯æ•´ä¸ªç®—æ³•æˆ–å…¶ç»“æ„æ—¶ï¼Œ å¯ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚\nå½“å¤šä¸ªç±»çš„ç®—æ³•é™¤ä¸€äº›ç»†å¾®ä¸åŒä¹‹å¤–å‡ ä¹å®Œå…¨ä¸€æ ·æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ ä½†å…¶åæœå°±æ˜¯ï¼Œ åªè¦ç®—æ³•å‘ç”Ÿå˜åŒ–ï¼Œ å°±å¯èƒ½éœ€è¦ä¿®æ”¹æ‰€æœ‰çš„ç±»ã€‚\nAdvantages å¯ä»…å…è®¸å®¢æˆ·ç«¯é‡å†™ä¸€ä¸ªå¤§å‹ç®—æ³•ä¸­çš„ç‰¹å®šéƒ¨åˆ†ï¼Œ ä½¿å¾—ç®—æ³•å…¶ä»–éƒ¨åˆ†ä¿®æ”¹å¯¹å…¶æ‰€é€ æˆçš„å½±å“å‡å°ã€‚ å¯å°†é‡å¤ä»£ç æå–åˆ°ä¸€ä¸ªè¶…ç±»ä¸­ã€‚ Disadvantages éƒ¨åˆ†å®¢æˆ·ç«¯å¯èƒ½ä¼šå—åˆ°ç®—æ³•æ¡†æ¶çš„é™åˆ¶ã€‚ é€šè¿‡å­ç±»æŠ‘åˆ¶é»˜è®¤æ­¥éª¤å®ç°å¯èƒ½ä¼šå¯¼è‡´è¿åé‡Œæ°æ›¿æ¢åŸåˆ™ã€‚ æ¨¡æ¿æ–¹æ³•ä¸­çš„æ­¥éª¤è¶Šå¤šï¼Œ å…¶ç»´æŠ¤å·¥ä½œå°±å¯èƒ½ä¼šè¶Šå›°éš¾ã€‚ Demo java.io.InputStreamã€ java.io.OutputStreamã€ java.io.Reader å’Œ java.io.Writer çš„æ‰€æœ‰éæŠ½è±¡æ–¹æ³•ã€‚ java.util.AbstractListã€ java.util.AbstractSet å’Œ java.util.AbstractMap çš„æ‰€æœ‰éæŠ½è±¡æ–¹æ³•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 public abstract class AbstractList\u0026lt;E\u0026gt; extends AbstractCollection\u0026lt;E\u0026gt; implements List\u0026lt;E\u0026gt; { public boolean add(E e) { add(size(), e); return true; } public boolean addAll(int index, Collection\u0026lt;? extends E\u0026gt; c) { rangeCheckForAdd(index); boolean modified = false; for (E e : c) { add(index++, e); modified = true; } return modified; } public int indexOf(Object o) { ListIterator\u0026lt;E\u0026gt; it = listIterator(); if (o==null) { while (it.hasNext()) if (it.next()==null) return it.previousIndex(); } else { while (it.hasNext()) if (o.equals(it.next())) return it.previousIndex(); } return -1; } // ... } 3.10.Visitor è®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ç§è¡Œä¸ºè®¾è®¡æ¨¡å¼ï¼Œ å®ƒèƒ½å°†ç®—æ³•ä¸å…¶æ‰€ä½œç”¨çš„å¯¹è±¡éš”ç¦»å¼€æ¥ã€‚\nUsage å¦‚æœéœ€è¦å¯¹ä¸€ä¸ªå¤æ‚å¯¹è±¡ç»“æ„ ï¼ˆä¾‹å¦‚å¯¹è±¡æ ‘ï¼‰ ä¸­çš„æ‰€æœ‰å…ƒç´ æ‰§è¡ŒæŸäº›æ“ä½œï¼Œ å¯ä½¿ç”¨è®¿é—®è€…æ¨¡å¼ã€‚ å¯ä½¿ç”¨è®¿é—®è€…æ¨¡å¼æ¥æ¸…ç†è¾…åŠ©è¡Œä¸ºçš„ä¸šåŠ¡é€»è¾‘ã€‚ å½“æŸä¸ªè¡Œä¸ºä»…åœ¨ç±»å±‚æ¬¡ç»“æ„ä¸­çš„ä¸€äº›ç±»ä¸­æœ‰æ„ä¹‰ï¼Œ è€Œåœ¨å…¶ä»–ç±»ä¸­æ²¡æœ‰æ„ä¹‰æ—¶ï¼Œ å¯ä½¿ç”¨è¯¥æ¨¡å¼ã€‚ ä¼˜ç‚¹ å¼€é—­åŸåˆ™ã€‚ å¯ä»¥å¼•å…¥åœ¨ä¸åŒç±»å¯¹è±¡ä¸Šæ‰§è¡Œçš„æ–°è¡Œä¸ºï¼Œ ä¸”æ— éœ€å¯¹è¿™äº›ç±»åšå‡ºä¿®æ”¹ã€‚ å•ä¸€èŒè´£åŸåˆ™ã€‚ å¯å°†åŒä¸€è¡Œä¸ºçš„ä¸åŒç‰ˆæœ¬ç§»åˆ°åŒä¸€ä¸ªç±»ä¸­ã€‚ è®¿é—®è€…å¯¹è±¡å¯ä»¥åœ¨ä¸å„ç§å¯¹è±¡äº¤äº’æ—¶æ”¶é›†ä¸€äº›æœ‰ç”¨çš„ä¿¡æ¯ã€‚ å½“æƒ³è¦éå†ä¸€äº›å¤æ‚çš„å¯¹è±¡ç»“æ„ ï¼ˆä¾‹å¦‚å¯¹è±¡æ ‘ï¼‰ï¼Œ å¹¶åœ¨ç»“æ„ä¸­çš„æ¯ä¸ªå¯¹è±¡ä¸Šåº”ç”¨è®¿é—®è€…æ—¶ï¼Œ è¿™äº›ä¿¡æ¯å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ Disadvantages æ¯æ¬¡åœ¨å…ƒç´ å±‚æ¬¡ç»“æ„ä¸­æ·»åŠ æˆ–ç§»é™¤ä¸€ä¸ªç±»æ—¶ï¼Œ éƒ½è¦æ›´æ–°æ‰€æœ‰çš„è®¿é—®è€…ã€‚ åœ¨è®¿é—®è€…åŒæŸä¸ªå…ƒç´ è¿›è¡Œäº¤äº’æ—¶ï¼Œ å®ƒä»¬å¯èƒ½æ²¡æœ‰è®¿é—®å…ƒç´ ç§æœ‰æˆå‘˜å˜é‡å’Œæ–¹æ³•çš„å¿…è¦æƒé™ã€‚ Demo 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 package java.nio.file; import java.nio.file.attribute.BasicFileAttributes; import java.io.IOException; public interface FileVisitor\u0026lt;T\u0026gt; { FileVisitResult preVisitDirectory(T dir, BasicFileAttributes attrs) throws IOException; FileVisitResult visitFile(T file, BasicFileAttributes attrs) throws IOException; FileVisitResult visitFileFailed(T file, IOException exc) throws IOException; FileVisitResult postVisitDirectory(T dir, IOException exc) throws IOException; } 3.11.Interpreter è§£é‡Šå™¨æ¨¡å¼ç”¨äºå¯¹äºä¸€äº›å›ºå®šæ–‡æ³•æ„å»ºä¸€ä¸ªè§£é‡Šå¥å­çš„è§£é‡Šå™¨ã€‚\nUsage å¦‚æœä¸€ç§ç‰¹å®šç±»å‹çš„é—®é¢˜å‘ç”Ÿçš„é¢‘ç‡è¶³å¤Ÿé«˜ï¼Œé‚£ä¹ˆå¯èƒ½å°±å€¼å¾—å°†è¯¥é—®é¢˜çš„å„ä¸ªå®ä¾‹è¡¨è¿°ä¸ºä¸€ä¸ªç®€å•è¯­è¨€ä¸­çš„å¥å­ã€‚è¿™æ ·å°±å¯ä»¥æ„å»ºä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¯¥è§£é‡Šå™¨é€šè¿‡è§£é‡Šè¿™äº›å¥å­æ¥è§£å†³è¯¥é—®é¢˜ã€‚\nAdvantages å¯æ‰©å±•æ€§æ¯”è¾ƒå¥½ï¼Œçµæ´»ã€‚\nå¢åŠ äº†æ–°çš„è§£é‡Šè¡¨è¾¾å¼çš„æ–¹å¼ã€‚\næ˜“äºå®ç°ç®€å•æ–‡æ³•ã€‚\nDisadvantages å¯åˆ©ç”¨åœºæ™¯æ¯”è¾ƒå°‘ã€‚ å¯¹äºå¤æ‚çš„æ–‡æ³•æ¯”è¾ƒéš¾ç»´æŠ¤ã€‚ è§£é‡Šå™¨æ¨¡å¼ä¼šå¼•èµ·ç±»è†¨èƒ€ã€‚ Demo 1 2 3 4 5 public abstract class Format implements Serializable, Cloneable { public final String format (Object obj) { return format(obj, new StringBuffer(), new FieldPosition(0)).toString(); } } ","date":"2021-06-01T10:18:40+08:00","image":"https://chasing1020.github.io/post/design-pattern-note/design-pattern_hu600d2222db3dc8c760aa00c9a5118f14_148336_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/design-pattern-note/","title":"Design Pattern Note"},{"content":"MySQLåŸºç¡€ç¬”è®° 1. æ•°æ®åº“ç®€ä»‹ 1.1.æ•°æ®åº“çš„ä¼˜åŠ¿ ä½¿ç”¨æ•°æ®åº“çš„ä¼˜ç‚¹\nå®ç°æ•°æ®æŒä¹…åŒ– ä½¿ç”¨å®Œæ•´çš„ç®¡ç†ç³»ç»Ÿï¼Œæ˜“äºæŸ¥è¯¢ æˆæœ¬ä½ï¼Œå¼€æºï¼Œæ€§èƒ½é«˜ï¼Œä½¿ç”¨ç®€å• ç§»æ¤æ€§å¥½ 1.2.æ•°æ®åº“çš„ç›¸å…³æ¦‚å¿µ DBï¼šï¼ˆDatabaseï¼‰å³æ•°æ®åº“æœ¬èº«ï¼Œä¿å­˜æœ‰ç»„ç»‡æ•°æ®çš„å®¹å™¨ DBMSï¼šï¼ˆDatabase Manage Systemï¼‰æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå³åˆ›å»ºã€ä½¿ç”¨æ•°æ®åº“çš„ç³»ç»Ÿ SQLï¼šï¼ˆStructured Quey Languageï¼‰ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ å¸¸ç”¨çš„æ•°æ®åº“ç±»å‹ï¼šMySQLï¼ŒOracleï¼ŒDB2ï¼ŒSqlServerï¼ˆåªé™winï¼‰ æ³¨æ„ï¼šSQLä¸æ˜¯æŸä¸ªç‰¹å®šç‰ˆæœ¬æ‰æœ‰çš„ï¼Œè€Œæ˜¯æ³›æŒ‡ä¸€ç§ç»“æ„åŒ–æŸ¥è¯¢ç”¨çš„è¯­è¨€\n1.3.å­˜æ”¾æ•°æ® å…ˆæ”¾åˆ°è¡¨ä¸­ï¼Œå†æ”¾åˆ°åº“ä¸­ ä¸€ä¸ªæ•°æ®åº“å¯ä»¥æœ‰å¤šä¸ªè¡¨ï¼Œæ¯ä¸ªè¡¨æœ‰å”¯ä¸€æ ‡è¯† è¡¨æœ‰ä¸€å®šç‰¹æ€§ï¼Œç±»ä¼¼äºjavaçš„ç±» è¡¨ä¸­çš„åˆ—ç±»ä¼¼äºjavaçš„å¯¹è±¡çš„å±æ€§ è¡¨ä¸­çš„è¡Œç±»ä¼¼äºjavaçš„å¯¹è±¡æœ¬èº« 1.4.DBMSè¡¥å…… ä¸€èˆ¬æœ‰ä¸¤ç±»æ•°æ®åº“ï¼š\nåŸºäºæ–‡ä»¶å…±äº«ç®¡ç†ç³»ç»Ÿçš„Access åŸºäºC/Sæ¶æ„çš„MySQL 2. æ•°æ®åº“å…¥é—¨ 2.1. åŸºç¡€è¯­æ³• 2.1.1. å¯åŠ¨/å…³é—­æ•°æ®åº“ net start mysql net stop mysql 2.1.2. æ•°æ®åº“çš„ç™»å½•ä¸é€€å‡º åœ¨cmdå‘½ä»¤è¡Œ mysql -h localhost -P 3306 -u root -p123456 hä»£è¡¨hostï¼ŒPä»£è¡¨ç«¯å£å·ï¼Œå¦‚æœè¿æ¥æœ¬æœºå¯ä»¥ç›´æ¥çœç•¥è¿™ä¸ªæ­¥éª¤ é€€å‡ºï¼šä½¿ç”¨è‡ªå¸¦å‘½ä»¤è¡Œï¼Œexitæˆ–è€…ctrl+c 2.1.3. å¸¸è§è¯­å¥ä¸¾ä¾‹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 # 1.æŸ¥çœ‹å½“å‰æ•°æ®åº“ show databases; # 2.æ‰“å¼€æŒ‡å®šçš„æ•°æ®åº“ use test; # 3.æŸ¥çœ‹å½“å‰åº“çš„æ‰€æœ‰è¡¨ show tables; # 4.æŸ¥çœ‹å…¶ä»–åº“çš„æ‰€æœ‰è¡¨ show tables from DB_; # æ˜¾ç¤ºæŸè¡¨ä¸­çš„è¡¨ï¼Œä¸åˆ‡æ¢æ•°æ®åº“ # 5.åˆ›å»ºè¡¨ create table è¡¨å( åˆ—å åˆ—ç±»å‹, åˆ—å åˆ—ç±»å‹ ); # 6.æŸ¥çœ‹è¡¨çš„ç»“æ„ desc è¡¨å; # 7.æŸ¥çœ‹MySQLç‰ˆæœ¬(doså‘½ä»¤) # mysql -Væˆ–è€…mysql --version 2.1.4. è¯­æ³•è§„èŒƒ mysql ä¸åŒºåˆ†å¤§å°å†™ï¼Œä½†å»ºè®®å…³é”®å­—å¤§å°å†™ï¼Œè¡¨åå’Œåˆ—åç”¨å°å†™ æ¯æ¡å‘½ä»¤æœ€å¥½ç”¨åˆ†å·ç»“å°¾ï¼Œä¸ç„¶åŒæ—¶æ‰§è¡Œè¯­å¥ä¼šå‡ºç°è¯­æ³•é”™è¯¯ å¯ä»¥æ ¹æ®éœ€è¦æ¢è¡Œæˆ–è€…ä½¿ç”¨ç¼©è¿› æ³¨é‡Šï¼š 1. ä½¿ç”¨ # æ³¨é‡Šå†…å®¹ 2. ä½¿ç”¨ -- æ³¨é‡Šå†…å®¹ è¿™é‡Œ\u0026ndash; åé¢æœ‰ä¸€ä¸ªç©ºæ ¼ 3. ä½¿ç”¨ /*æ³¨é‡Šå†…å®¹*/\n2.2. DQLè¯­è¨€ Data Query Language\n2.2.1. åŸºç¡€æŸ¥è¯¢ å…³é”®è¯select\n1 select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å; ç±»ä¼¼äºSystem.out.println() æŸ¥è¯¢çš„è¡¨å¯ä»¥æ˜¯è¡¨ä¸­çš„å­—æ®µï¼Œå¸¸é‡å€¼ï¼Œè¡¨è¾¾å¼ï¼Œå‡½æ•° æŸ¥è¯¢ä»¥åçš„ç»“æœæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„è¡¨æ ¼\nä¸¾ä¾‹\n1 2 3 SELECT last_name FROM employees; SELECT `last_name`, `salary`, `email` FROM employees; SELECT * FROM employees; å¦‚æœæ˜¯å…³é”®å­—å­—æ®µé‡åˆï¼Œå¦‚nameï¼Œå¯ä»¥ä½¿ç”¨åæ–œç‚¹æ¥æ ‡è¯†ä¸€ä¸‹å˜é‡åã€‚\nå•å¼•å·å’ŒåŒå¼•å·éƒ½å¯ä»¥è¡¨ç¤ºå­—ç¬¦ä¸²ã€‚\nå­—æ®µåã€è¡¨åé€šå¸¸ä¸éœ€è¦åŠ ä»»ä½•å¼•å·ï¼Œè¦åŠ ä¹Ÿæ˜¯åå¼•å·ã€‚\næŸ¥è¯¢å¸¸é‡å€¼\n1 2 SELECT 123456; SELECT \u0026#39;chasing\u0026#39;; æŸ¥è¯¢è¡¨è¾¾å¼\n1 SELECT 100%99; æŸ¥è¯¢å‡½æ•°\n1 SELECT VERSION(); èµ·åˆ«å\n1 2 3 SELECT 100%99 AS ç»“æœ; SELECT last_name AS å§“, first_name AS å FROM employees; SELECT last_name å§“, first_name å FROM employees; èµ·åˆ«åçš„ASå¯ä»¥çœç•¥ï¼Œå¦‚æœåˆ«åæ˜¯å…³é”®å­—ç±»å‹ï¼Œåˆ™éœ€è¦ä½¿ç”¨åŒå¼•å·æ ‡æ³¨\n1 SELECT salary AS \u0026#34;OUT PUT\u0026#34; FROM employees; å»é‡\n1 SELECT DISTINCT department_id FROM employees; +ä½œç”¨ï¼Œä»…ä»…åªæœ‰è¿ç®—ç¬¦\n1 2 3 4 5 SELECT 1+\u0026#39;2\u0026#39; # å°è¯•è½¬æ¢ä¸ºæ•°å€¼ç±»å‹ï¼Œå³3 SELECT 1+\u0026#39;a\u0026#39; # å¦‚æœæ˜¯éæ•°å€¼ç±»å‹ï¼Œåˆ™å°†æ•°å€¼è½¬æ¢ä¸º0 SELECT null+10 # å¦‚æœæœ‰nullï¼Œåˆ™ç›´æ¥å˜ä¸ºnull -- ä»¥ä¸‹æ–¹æ³•æ˜¯é”™è¯¯çš„ -- SELECT last_name+first_name AS å§“å FROM employee; mysqlé‡Œ1+\u0026ldquo;2\u0026rdquo;ï¼šè½¬ä¸ºæ•°å€¼å³3\njavaé‡Œ1+\u0026ldquo;2\u0026rdquo;ï¼šè½¬ä¸ºå­—ç¬¦å‹å³\u0026quot;12\u0026quot;\npythoné‡Œ1+\u0026ldquo;2\u0026rdquo;ï¼šType Error\nCONCATè¿æ¥\n1 2 SELECT CONCAT(last_name, first_name) AS å§“å FROM employee; # CONCAT æ‹¼æ¥å«æœ‰nullåˆ™æ‹¼æ¥ç»“æœéƒ½æ˜¯null IFNULLåˆ¤æ–­éç©º\n1 2 select IFNULL(commission_pct, 0) from employees; 2.2.2. æ¡ä»¶æŸ¥è¯¢ æŸ¥è¯¢çš„åˆ—è¡¨å¯èƒ½æœ‰å¤šç§æƒ…å†µ åŸºç¡€è¯­æ³•\n1 2 3 select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å where ç­›é€‰æ¡ä»¶; 1.æŒ‰ç…§æ¡ä»¶è¡¨è¾¾å¼ç­›é€‰ï¼š æ¡ä»¶è¿ç®—ç¬¦\u0026gt; \u0026lt; = != \u0026lt;\u0026gt; \u0026lt;= \u0026gt;= \u0026lt;=\u0026gt;\n1 2 3 select * from employees where salary\u0026gt;10000; 2.é€»è¾‘è¡¨è¾¾å¼ \u0026amp;\u0026amp; || ! and or not\nä»¥ä¸Šæ–¹æ³•éƒ½å¯ä»¥ï¼Œä½†æ˜¯æ›´æ¨èä½¿ç”¨ä¸‹é¢çš„\n1 2 3 select salary from employees where salary\u0026gt;=10000 and salary\u0026lt;=20000; 3.æ¨¡ç³ŠæŸ¥è¯¢\nä¸»è¦æœ‰ä»¥ä¸‹å››ç§\nlike between and in is null like ä¸€èˆ¬å’Œé€šé…ç¬¦æ­é…\n% ä»»æ„å¤šä¸ªåŒ¹é…ï¼Œ0æˆ–è€…å¤šä¸ª\n_ å•ä¸ªé€šé…ç¬¦ï¼Œå¿…é¡»å ä½ä¸€ä¸ª\n\\ è½¬ä¹‰å­—ç¬¦\n1 2 3 select * from employees where last_name like \u0026#39;%a%\u0026#39;; ä½¿ç”¨_\n1 2 3 4 select * from employees # æŸ¥è¯¢ç¬¬äºŒä¸ªä¸º_çš„åå­—ï¼Œè¿™é‡Œ\\ è¢«ç”¨ä½œè½¬ä¹‰å­—ç¬¦ where last_name like \u0026#39;_\\_%\u0026#39;; å¯¹äºè½¬ä¹‰å­—ç¬¦ï¼Œé™¤äº†ä½¿ç”¨ \\ ä¹Ÿå¯ä»¥è‡ªå®šä¹‰\n1 2 3 4 select * from employees # æŸ¥è¯¢ç¬¬äºŒä¸ªä¸º_çš„åå­—ï¼Œè¿™é‡Œaè¢«ç”¨ä½œè‡ªå®šä¹‰çš„è½¬ä¹‰å­—ç¬¦ where last_name like \u0026#39;_a_%\u0026#39; escape \u0026#39;a\u0026#39;; between andä½¿ç”¨\n1 2 3 4 select * from employees where employee_id \u0026gt;= 100 and employee_id \u0026lt;= 120; å¯ä»¥æ”¹æˆ\n1 2 3 select * from employees where employee_id between 100 and 120; ä½¿ç”¨between andæ˜¯åŒ…å«ä¸´ç•Œå€¼çš„ï¼Œå³é—­åŒºé—´ï¼Œä¸¤ä¸ªä¸´ç•Œå€¼ä¸èƒ½é¢ å€’\nä½¿ç”¨in\n1 2 3 4 5 6 select first_name, job_id from employees where job_id = \u0026#39;IT_PROG\u0026#39; or job_id = \u0026#39;AD_VP\u0026#39; or job_id = \u0026#39;AD_PRES\u0026#39;; ä»¥ä¸ŠæŸ¥è¯¢å¯ä»¥ç®€å†™æˆinçš„å½¢å¼ ä½¿ç”¨inå¯ä»¥æå‡ç®€æ´åº¦ï¼Œæ•ˆç‡ä¸Šæ²¡æœ‰æå‡ï¼ˆâŒï¼‰ï¼Œin()ä¼šä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œæ•ˆç‡æ˜¯O(logn)æ¯”orè¦å¥½ åœ¨inçš„åˆ—è¡¨ä¸­ä¸æ”¯æŒé€šé…ç¬¦\n1 2 3 4 select first_name, job_id from employees where job_id in (\u0026#39;IT_PROG\u0026#39;, \u0026#39;AD_VP\u0026#39;, \u0026#39;AD_PRES\u0026#39;); is null is åªèƒ½å’Œnullæˆå¯¹å‡ºç°ï¼Œå³åªæœ‰is nullå’Œis not null\n1 2 3 4 select last_name, commission_pct from employees\twhere commission_pct is not null; å®‰å…¨ç­‰äº \u0026lt;=\u0026gt; æ—¢å¯ä»¥åˆ¤æ–­nullå€¼ï¼Œä¹Ÿå¯ä»¥åˆ¤æ–­æ™®é€šçš„æ•°å€¼ ä½†æ˜¯ä½¿ç”¨è¾ƒå°‘ï¼Œä¸ä¾¿äºåŒºåˆ†ï¼Œå¯è¯»æ€§è¾ƒä½\n1 2 3 select last_name,salary from employees where salary \u0026lt;=\u0026gt; 12000; ç®€å•æŸ¥è¯¢æµ‹è¯•\n1 2 3 4 select last_name, department_id, salary*12*(1+ifnull(commission_pct, 0 )) AS å¹´è–ª from employees; 2.2.3. æ’åºæŸ¥è¯¢ åœ¨æŸ¥è¯¢çš„å†…å®¹ä¹‹åæ·»åŠ order by asc å’Œ desc\n1 2 3 select * from employees order by salary asc;# å‡åºï¼Œä»å°åˆ°å¤§ï¼Œä¸ºé»˜è®¤å€¼ ä»¥åŠ\n1 2 3 select * from employees order by salary desc; #é™åºï¼Œä»å¤§åˆ°å° æ’åºæŸ¥è¯¢å¯ä»¥æ·»åŠ è¡¨è¾¾å¼\n1 2 3 4 select first_name, ifnull(1+commission_pct, 0)*12*salary from employees order by ifnull(1+commission_pct, 0)*12*salary desc; ä¹Ÿå¯ä»¥ä½¿ç”¨åˆ«å\n1 2 3 4 select first_name, ifnull(1+commission_pct, 0)*12*salary total from employees order by total desc; æŒ‰ç…§å¤šä¸ªå­—æ®µæ’åºï¼Œåˆ™æ•´ä½“ä»¥ç¬¬ä¸€ä¸ªå­—æ®µä¸ºä¸»è¦ï¼Œåé¢çš„å­—æ®µåœ¨å‰é¢çš„å­—æ®µç›¸åŒæ—¶å†æ’åºã€‚\n2.2.4. å¸¸ç”¨å‡½æ•° éšè—å®ç°ç»†èŠ‚ï¼Œæé«˜ä»£ç é‡ç”¨æ€§\nselect å‡½æ•°å() from è¡¨å\nåˆ†ç±»\nå•è¡Œå‡½æ•° ä¾‹å¦‚concatã€lengthã€ifnull\nåˆ†ç»„å‡½æ•° å¸¸ç”¨ä½œç»Ÿè®¡å¤„ç†\n1ã€å­—ç¬¦å‡½æ•°\nå‡½æ•°å ä½œç”¨ length() è·å–å­—ç¬¦ä¸²é•¿åº¦ concat() æ‹¼æ¥å­—ç¬¦ä¸² upper() å…¨éƒ¨æ”¹å¤§å†™ lower() å°å†™ substr() å­—ç¬¦ä¸²æˆªå– instr() è¿”å›å­—ä¸²çš„åœ¨ä¸»ä¸²çš„ç¬¬ä¸€æ¬¡ä½ç½®ç´¢å¼•ï¼Œæ‰¾ä¸åˆ°è¿”å›0 trim() å»é™¤é¦–å’Œå°¾å­—ç¬¦ä¸²ç©ºæ ¼æˆ–è€…æ˜¯ç‰¹å®šçš„å­—ç¬¦ lpad() ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦å¡«å……å·¦é•¿åº¦ rpad() ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦å¡«å……å³é•¿åº¦ replace() æ›¿æ¢ å¯¹äºä¸­æ–‡å­—èŠ‚é•¿åº¦ï¼Œè¿™é‡Œå–å†³äºç¼–ç ï¼Œgbkæ˜¯2ä¸ªå­—èŠ‚ï¼Œutf-8æ˜¯3ä¸ªå­—èŠ‚ã€‚\nmysqlå­—ç¬¦ä¸²ä»1å¼€å§‹ï¼Œè¿™ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚\näºŒã€æ•°å­¦å‡½æ•° ååŠ å‚æ•°æ•°å­—ï¼Œä¸€èˆ¬éƒ½è¡¨ç¤ºå°æ•°ç‚¹åä½æ•°\nå‡½æ•°å ä½œç”¨ round() å››èˆäº”å…¥ ceil() å‘ä¸Šå–æ•´ floor() å‘ä¸‹å–æ•´ truncate() æˆªæ–­ mod() å–æ¨¡ï¼Œè·Ÿ%ä¸€è‡´ï¼ˆå¯¹äºè´Ÿæ•°å–ä½™ï¼Œè®¡ç®—a-a/b*bï¼‰ rand() è¿”å›0-1ä¹‹é—´çš„éšæœºæ•° ä¸‰ ã€æ—¥æœŸå‡½æ•°\nå‡½æ•°å ä½œç”¨ now() è¿”å›å½“å‰æ—¥æœŸ+æ—¶é—´ curdate() è¿”å›å½“å‰æ—¥æœŸï¼Œä¸åŒ…å«æ—¶é—´ curtime() è¿”å›å½“å‰æ—¶é—´ï¼Œä¸åŒ…å«æ—¥æœŸ str_to_date() å°†å­—ç¬¦è½¬æ¢æˆæ—¥æœŸ date_format() å°†æ—¥æœŸè½¬æ¢æˆå­—ç¬¦ datediff() è¿”å›ä¸¤ä¸ªæ—¥æœŸä¹‹é—´ç›¸å·®çš„å¤©æ•° å››ã€å…¶ä»–å‡½æ•°\nå‡½æ•°å ä½œç”¨ version() è¿”å›ç‰ˆæœ¬å· database() å½“å‰æ‰“å¼€çš„æ•°æ®åº“ user() è¿”å›å½“å‰çš„ç”¨æˆ· password() å¯¹è¾“å…¥çš„å­—ç¬¦åŠ å¯† MD5() é‡‡ç”¨md5åŠ å¯†åçš„ç»“æœ äº”ã€æµç¨‹æ§åˆ¶å‡½æ•°\nif()ä¸‰å…ƒè¿ç®—ç¬¦\ncase æ¡ä»¶è¡¨è¾¾å¼ when å¸¸é‡1 è¯­å¥1 when å¸¸é‡2 è¯­å¥2 else è¯­å¥n end\næˆ–è€… case when æ¡ä»¶ then è¯­å¥ when æ¡ä»¶ then è¯­å¥ else è¯­å¥n\nå…­ã€åˆ†ç»„å‡½æ•°\næ‰€æœ‰åˆ†ç»„å‡½æ•°éƒ½ä¼šå¿½ç•¥nullå€¼ã€‚\nsum()ã€avg()ã€max()ã€count() å¯ä»¥åœ¨å‚æ•°ä¸­æ·»åŠ distinct count(*)åœ¨ä»»ä½•è¡Œåªè¦æœ‰éç©ºå…ƒç´ ï¼Œåœ¨è¿™è¡Œå°±+1 count(1)ç»Ÿè®¡åŸå§‹è¡¨ä¸­æ‰€æœ‰çš„è¡Œæ•°\n2.2.5. åˆ†ç»„æŸ¥è¯¢ select column, group_function(column) from table [where condition] [group by group_by_expression] [having after grouped] [order by column] where ä¸€å®šæ”¾åœ¨fromåé¢\norder by ä¸€å®šæ”¾æœ€å\nåˆ†ç»„åçš„æ¡ä»¶ï¼Œåœ¨æœ€åæŸ¥è¯¢åˆ°çš„ç»“æœååŠ having ä¾‹å¦‚\n1 2 3 4 5 select max(salary), job_id from employees where commission_pct is not null group by job_id having max(salary) \u0026gt; 12000; where having åˆ†ç»„å‰ç­›é€‰ åˆ†ç»„åç­›é€‰ åŸå§‹è¡¨ åˆ†ç»„åçš„ç»“æœ group byå‰é¢ group byåé¢ åˆ†ç»„å‡½æ•°åšæ¡ä»¶ï¼Œé‚£ä¸€å®šæ˜¯ç”¨having èƒ½ç”¨åˆ†ç»„å‰ç­›é€‰çš„å°±ä¼˜å…ˆä½¿ç”¨åˆ†ç»„å‰ç­›é€‰ï¼ˆæé«˜æ€§èƒ½ï¼‰\nå¤šç»„æŸ¥è¯¢\n1 2 3 select avg(salary),department_id,job_id from employees group by job_id, department_id; 2.2.6. è¿æ¥æŸ¥è¯¢ ä¸ºäº†æŸ¥è¯¢çš„é™å®šï¼Œå¯ä»¥é€šè¿‡è¡¨å.é”®åæ¥åŠ ä»¥æ ‡è¯†ã€‚ ä¸sql92æ ‡å‡†ä¸åŒçš„æ˜¯ï¼Œsql99æ ‡å‡†çš„æ•°æ®åº“è¿æ¥çš„æ¡ä»¶æ”¾åœ¨onåé¢ï¼Œwhereå•ç‹¬æ¥æ”¾ç­›é€‰çš„æ¡ä»¶ è€Œsql92çš„æ•°æ®åº“è¿æ¥æ¡ä»¶å’Œç­›é€‰æ¡ä»¶éƒ½æ˜¯æ”¾åœ¨whereåé¢ï¼Œç”¨andè¿æ¥ ä¸ç®¡æ˜¯92è¿˜æ˜¯99ï¼Œä¸¤è€…çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä½¿ç”¨99æ›´åˆ©äºæå‡ä»£ç å¯è¯»æ€§ã€‚\n@ä»¥ä¸‹ä¸ºsql92æ ‡å‡† ä¸€ã€ç­‰å€¼è¿æ¥\n1 2 3 select last_name,department_name from employees,departments where employees.department_id = departments.department_id; #è¿æ¥æ¡ä»¶ å¦‚æœæœ‰nä¸ªè¡¨ï¼Œåˆ™éœ€è¦n-1ä¸ªè¿æ¥æ¡ä»¶ï¼Œä¸­é—´ä½¿ç”¨andè¿æ¥ å¯¹äºå¤šè¡¨çš„é¡ºåºæ²¡æœ‰è¦æ±‚ åœ¨ä»¥ä¸ŠæŸ¥è¯¢è¿‡ç¨‹ç§ï¼Œfromå¤„çš„å†…å®¹ä¸èƒ½é¢ å€’ ä¸ºäº†ç®€åŒ–æŸ¥è¯¢çš„è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨åˆ«åï¼Œå³å¯ä»¥åœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ«åã€‚ ä½†æ˜¯ä½¿ç”¨äº†åˆ«åä»¥åå°±ä¸èƒ½å†å‡ºç°åŸåäº†ã€‚\näºŒã€éç­‰å€¼è¿æ¥\nè·Ÿä»¥ä¸Šéƒ½ä¸€æ ·ï¼Œåªæ˜¯whereåé¢çš„æ¡ä»¶å˜æˆä¸ç­‰å¼\n1 2 3 4 select salary, grade_level from job_grades g, employees e where salary between g.lowest_sal and g.highest_sal; ä¸‰ã€è‡ªè¿æ¥ å³è¡¨ä¸­çš„å­—æ®µä¸è‡ªèº«å­˜åœ¨åŒ¹é…å…³ç³» æ–¹æ³•ï¼šè¿æ¥æ—¶å»ºç«‹ä¸¤ä¸ªåˆ«å\n1 2 3 select e1.last_name,e2.employee_id,e2.last_name from employees e1,employees e2 where e1.manager_id=e2.employee_id; @ä»¥ä¸‹è¯­æ³•ä¸ºsql99æ ‡å‡† è¯­æ³•\nselect æŸ¥è¯¢åˆ—è¡¨ from è¡¨1 åˆ«å [è¿æ¥ç±»å‹][inner] join è¡¨2 åˆ«å on è¿æ¥æ¡ä»¶ where ç­›é€‰æ¡ä»¶ [group by åˆ†ç»„] [having ç­›é€‰æ¡ä»¶] [order by æ’åºåˆ—è¡¨] ä»¥ä¸Šinnerå¯ä»¥çœç•¥ï¼Œä½†æ˜¯ä¸å»ºè®®çœç•¥\nç­‰å€¼æŸ¥è¯¢ @sql99 ä¸€ã€å†…è¿æ¥ï¼ˆé›†åˆçš„äº¤é›†ï¼‰\nnä¸ªé›†åˆå†…è¿æ¥éœ€è¦n-1ä¸ªæ¡ä»¶ã€‚\n1 2 3 4 select last_name, department_name from employees, departments where employees.department_id = departments.department_id; å¤šè¡¨ä¹‹é—´ç­‰å€¼æŸ¥è¯¢å¿…é¡»è¦æœ‰é¡ºåºï¼Œå³join on çš„å†…å®¹æœ‰ç›¸å…³\n1 2 3 4 5 select last_name, department_name,job_title from employees e inner join departments d on e.department_id = d.department_id inner join jobs j on e.job_id = j.job_id order by department_name desc; ä»¥ä¸Šä¸èƒ½å†™ä¸ºè¿™ç§å½¢å¼ï¼šï¼ˆè™½ç„¶æ²¡æœ‰æŠ¥é”™ï¼Œä½†æ˜¯ä¸ç¬¦åˆè§„èŒƒï¼‰\n1 2 3 4 5 select last_name, department_name,job_title from employees e inner join jobs j on e.job_id = j.job_id inner join departments d on e.department_id = d.department_id order by department_name desc; äºŒã€å¤–è¿æ¥ï¼ˆé›†åˆçš„å·®é›†ï¼‰ å¤–è¿æ¥æŸ¥è¯¢åˆ°çš„ç»“æœä¸ºä¸»è¡¨å’Œé™„è¡¨éƒ½æœ‰çš„å­—æ®µï¼Œä»¥åŠä¸»è¡¨ä¸­æœ‰è€Œåœ¨ä»è¡¨ä¸­æ²¡æœ‰çš„å­—æ®µï¼ˆè¿™éƒ¨åˆ†æ˜¾ç¤ºä¸ºnullï¼‰ å³ï¼šä¸»æœ‰ä»æœ‰ï¼Œä¸»æœ‰ä»æ—  ä¸»è¡¨å’Œä»è¡¨åˆ†è¾¨ï¼š\nå·¦å¤–è¿æ¥ï¼šleft outer joinå·¦è¾¹æ˜¯ä¸»è¡¨ å³å¤–è¿æ¥ï¼šright outer joinå³è¾¹æ˜¯ä¸»è¡¨ æˆ–è€…ç†è§£ä¸ºï¼šA left join Bï¼Œå°±æ˜¯Aä¸»è¡¨ï¼Œé›†åˆä¸ºA-B å¯ä»¥é€šè¿‡åˆ‡æ¢å·¦å³çš„é¡ºåºè¾¾åˆ°åŒæ ·çš„æ•ˆæœ\nä¸‰ã€å…¨å¤–è¿æ¥ï¼ˆé›†åˆçš„äº¤é›†ï¼‰ æŸ¥è¯¢åˆ°ä¸¤ä¸ªè¡¨ä¹‹é—´çš„äº¤é›† å…¨å¤–è¿æ¥æŸ¥è¯¢åˆ°çš„ç»“æœä¸ºä¸»è¡¨å’Œé™„è¡¨éƒ½æœ‰çš„å­—æ®µï¼Œä»¥åŠä¸»è¡¨ä¸­æœ‰è€Œåœ¨ä»è¡¨ä¸­æ²¡æœ‰çš„å­—æ®µï¼ˆè¿™éƒ¨åˆ†æ˜¾ç¤ºä¸ºnullï¼‰ï¼Œä»¥åŠä»è¡¨ä¸­æœ‰è€Œåœ¨ä¸»è¡¨ä¸­æ²¡æœ‰çš„å­—æ®µ å³ï¼šä¸»æœ‰ä»æœ‰ï¼Œä¸»æœ‰ä»æ— ï¼Œä»æ— ä¸»æœ‰ full outer join å…¨å¤–è¿æ¥\nå››ã€äº¤å‰è¿æ¥ï¼ˆé›†åˆçš„ç¬›å¡å°”ç§¯ï¼‰ cross join å³ä»£è¡¨ç¬›å¡å°”ä¹˜ç§¯ã€‚è¿™é‡Œè·Ÿsql92ç›¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨è¾ƒå°‘ã€‚\n2.2.7. å­æŸ¥è¯¢ å­æŸ¥è¯¢å¯ä»¥å†™åœ¨å…¶ä»–è¯­å¥ä¸­çš„selectè¯­å¥ï¼Œè¿™é‡Œçš„å…¶ä»–è¯­å¥ä¹Ÿå³è¡¨ç¤ºå¯ä»¥ç”¨äºå¢åˆ æ”¹è¯­å¥ä¸­ã€‚ åœ¨å…¶ä»–è¯­å¥ä¸­çš„æŸ¥è¯¢ç§°ä¸ºå­æŸ¥è¯¢ å¤–éƒ¨çš„æŸ¥è¯¢ç§°ä¹‹ä¸ºä¸»æŸ¥è¯¢ï¼ˆå¤–æŸ¥è¯¢ï¼‰ ä½ç½®å¯èƒ½å‡ºç°çš„æƒ…å†µ å­æŸ¥è¯¢çš„ä½ç½®å¯ä»¥æ”¾åœ¨selectåé¢ï¼Œwhereåé¢ï¼Œhavingåé¢ï¼Œæˆ–è€…æ˜¯existsåé¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰ã€‚ æŒ‰ç»“æœé›†çš„è¡Œåˆ—æ•°ä¸åŒã€‚ æŸ¥è¯¢ç»“æœï¼š\næ ‡é‡å­æŸ¥è¯¢ï¼ˆä¸€è¡Œä¸€åˆ—ï¼Œåœ¨selectåé¢ï¼‰ åˆ—å­æŸ¥è¯¢ï¼ˆä¸€åˆ—å¤šè¡Œï¼Œåœ¨whereæˆ–è€…havingåé¢ï¼‰ è¡Œå­æŸ¥è¯¢ï¼ˆå¤šè¡Œå¤šåˆ—ï¼Œåœ¨whereæˆ–è€…havingåé¢ï¼‰ è¡¨å­æŸ¥è¯¢ï¼ˆä»¥ä¸Šéƒ½æœ‰ï¼Œexistsåé¢ï¼‰ ä¸€ã€whereåŠhavingåé¢ å­æŸ¥è¯¢ä¸€èˆ¬æ”¾åœ¨å°æ‹¬å·å†…ï¼Œæ¡ä»¶çš„å³ä¾§ 1.æ ‡é‡å­æŸ¥è¯¢\n1 2 3 4 5 select * from employees where salary \u0026gt; (select salary from employees where last_name = \u0026#39;Abel\u0026#39;); 2.åˆ—å­æŸ¥è¯¢ï¼ˆå¤šè¡Œå­æŸ¥è¯¢ï¼‰ ä½¿ç”¨å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦ï¼Œä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§\nin | not in any|some all ä½¿ç”¨ç±»æ¯”npåº“\n1 2 3 4 5 6 7 select * from employees where salary \u0026lt; ( select MIN(salary) from employees where job_id = \u0026#39;IT_PROG\u0026#39; ); 3.è¡Œå­æŸ¥è¯¢ ç”±äºå¾ˆå°‘æœ‰æ•°æ®è¡¨æ»¡è¶³è¿™ç§æƒ…å†µï¼Œæ‰€ä»¥ä½¿ç”¨è¾ƒå°‘\n1 2 3 4 5 select * from employees where salary=(select max(salary) from employees) and employee_id=(select min(employee_id) from employees); ä»¥ä¸Šå¯ä»¥æ›¿æ¢ä¸º\n1 2 3 4 select * from employees where (employee_id, salary) = (select min(employee_id), max(salary) from employees); äºŒã€select åé¢\né‡Œé¢ä»…ä»…æ”¯æŒæ ‡é‡å­æŸ¥è¯¢ï¼ˆå³åªæœ‰ä¸€åˆ—ï¼‰\n1 2 3 4 5 6 7 select d.*, ( select count(*) from employees e where e.department_id = d.department_id ) from departments as d; ä¸‰ã€fromåé¢\n1 2 3 4 5 6 7 8 9 select * from ( select avg(salary) ag, department_id from employees group by department_id ) ag_dep inner join job_grades g on ag_dep.ag between lowest_sal and highest_sal; å››ã€exist åé¢ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰\nç”±äºèƒ½ç”¨existçš„æƒ…å†µä¸‹ä¸€å®šèƒ½ç”¨inï¼Œæ‰€ä»¥ä½¿ç”¨è¾ƒå°‘ å…ˆä½¿ç”¨å¤–æŸ¥è¯¢ï¼Œå†æ¶‰åŠå­æŸ¥è¯¢ existsåæ¥å®Œæ•´æŸ¥è¯¢è¯­å¥ï¼Œç»“æœä¸º1æˆ–è€…0 æŸ¥è¯¢æœ‰å‘˜å·¥çš„éƒ¨é—¨å\n1 2 3 4 5 select department_name from departments d where exists(select * from employees e where e.department_id = d.department_id); 2.2.8. åˆ†é¡µæŸ¥è¯¢ å½“è¦æ˜¾ç¤ºçš„æ•°æ®å†ä¸€é¡µæ˜¾ç¤ºä¸å…¨ï¼Œéœ€è¦æäº¤å¤šæ¬¡sqlè¯·æ±‚ 7 select æŸ¥è¯¢åˆ—è¡¨ 1 from è¡¨ 2 [è¿æ¥ç±»å‹] join è¡¨2 3 on è¿æ¥æ¡ä»¶ 4 where ç­›é€‰æ¡ä»¶ 5 group by åˆ†ç»„å­—æ®µ 6 having åˆ†ç»„ä»¥åçš„ç­›é€‰ 8 order by æ’åºçš„å­—æ®µ 9 limit offset, size å‰é¢çš„æ•°å­—ä»£è¡¨è¯­å¥çš„æ‰§è¡Œé¡ºåº è¿™é‡Œoffsetæ˜¯æ¡ç›®çš„èµ·å§‹ç´¢å¼•ï¼Œé»˜è®¤èµ·å§‹ç´¢å¼•ä»1å¼€å§‹ï¼Œå¦‚æœæ˜¯ç¬¬ä¸€æ¡ï¼Œ0å¯ä»¥çœç•¥ sizeæ˜¯ä¸ªæ•°\n1 2 select * from employees limit 10,15; # æŸ¥è¯¢ç¬¬11åˆ°25æ¡ å‡è®¾éœ€è¦æ˜¾ç¤ºçš„é¡µæ•°ä¸ºpage ï¼Œæ¯ä¸€é¡µçš„æ¡ç›®æ•°æ˜¯size limit è¯­å¥éƒ½æ˜¯åœ¨æ‰§è¡Œé¡ºåºçš„æœ€å\nä½¿ç”¨ç‰¹å®šæ•°å­—è¿›è¡ŒæŸ¥è¯¢\n2.2.9. è”åˆæŸ¥è¯¢ union è”åˆæŸ¥è¯¢\nå°†å¤šæ¡æŸ¥è¯¢è¯­å¥åˆå¹¶æˆä¸€ä¸ªç»“æœ æŸ¥è¯¢æŸæŸæ¡ä»¶æˆ–è€…æŸæŸæ¡ä»¶çš„é›†åˆ\n1 2 3 4 select last_name from employees where salary\u0026gt;10000 or employee_id \u0026gt;50; é€šè¿‡è”åˆæŸ¥è¯¢å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“æœ\n1 2 3 4 5 6 7 select last_name from employees where salary \u0026gt; 10000 union select last_name from employees where employee_id \u0026gt; 50 ä½œç”¨ï¼Œå³åŒç±»å‹çš„æ•°æ®å­˜å‚¨åœ¨å¤šä¸ªè¡¨ä¸­ï¼Œå¦‚ä¸­å›½å­¦ç”Ÿè¡¨å’Œå¤–å›½å­¦ç”Ÿè¡¨ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº18çš„ã€‚\né€‚ç”¨äºï¼šæœç´¢ç»“æœè¿”å›å¤šä¸ªç±»å‹çš„è¡¨ï¼Œä½†æ˜¯æŸ¥è¯¢çš„ä¿¡æ¯ç›¸åŒçš„æƒ…å†µï¼Œå³åˆ—æ•°è¦å¯¹åº”ã€‚ å¦‚æœåŒæ ·çš„å­—æ®µå‡ºç°åœ¨å¤šä¸ªè¡¨ä¸­ unionè‡ªå¸¦å»é‡çš„æ•ˆæœï¼Œå¦‚æœéœ€è¦ä¿å­˜æ‰€æœ‰ä¿¡æ¯ï¼Œéœ€è¦å¢åŠ union all\næ€»ç»“\n7 select æŸ¥è¯¢åˆ—è¡¨ 1 from è¡¨ 2 [è¿æ¥ç±»å‹] join è¡¨2 3 on è¿æ¥æ¡ä»¶ 4 where ç­›é€‰æ¡ä»¶ 5 group by åˆ†ç»„å­—æ®µ 6 having åˆ†ç»„ä»¥åçš„ç­›é€‰ 8 order by æ’åºçš„å­—æ®µ 9 limit offset, size\n2.3.DMLè¯­è¨€ Dara Manipulation Language æ•°æ®æ“ä½œè¯­è¨€ åˆ†ä¸ºæ’å…¥ï¼Œä¿®æ”¹ï¼Œåˆ é™¤ä¸‰å¤§ç±»\n2.3.1. æ’å…¥æ“ä½œ æ–¹æ³•ä¸€\ninsert into è¡¨å(åˆ—å1, ...) values(å€¼1, ...) insert into è¡¨å(åˆ—å1, ...) values(å€¼1, ...), (å€¼2, ...), ... åœ¨æ’å…¥çš„è¿‡ç¨‹ä¸­ï¼Œæ’å…¥çš„å€¼çš„ç±»å‹è¦å’Œåˆ—ç±»å‹ç›¸ä¸€è‡´æˆ–è€…å…¼å®¹ï¼ˆèƒ½å¤Ÿéšå¼è½¬æ¢ï¼‰ï¼Œåˆ—æ•°çš„ä¸ªæ•°å’Œå€¼çš„ä¸ªæ•°ä¸€å®šè¦ç›¸åŒ¹é…ã€‚ å¯ä»¥çœç•¥åˆ—åï¼Œé»˜è®¤æ‰€æœ‰çš„åˆ—ï¼Œå¹¶ä¸”å€¼çš„é¡ºåºéœ€è¦å’Œä½ç½®ç›¸ä¸€è‡´\næ–¹æ³•äºŒ\ninsert into è¡¨å set å…ƒç´ 1 = å€¼1, å…ƒç´ 2 = å€¼2, ... æ–¹å¼ä¸€æ”¯æŒæ’å…¥å¤šè¡Œï¼Œæ–¹å¼äºŒä¸æ”¯æŒæ’å…¥å¤šè¡Œï¼ŒåŒæ—¶æ–¹å¼ä¸€æ”¯æŒå­æŸ¥è¯¢ï¼Œæ–¹å¼äºŒä¸æ”¯æŒ\nå³æ–¹æ³•ä¸€æ”¯æŒ\ninsert into è¡¨å select æŸ¥è¯¢åˆ—è¡¨ from è¡¨å\n1 2 insert into boys (boyName, userCP) values (\u0026#39;zxa\u0026#39;,10); æ‰€ä»¥æ–¹æ³•ä¸€ä½¿ç”¨æ•™å¤š\n2.3.2. ä¿®æ”¹æ“ä½œ ä¸€ã€ä¿®æ”¹å•ä¸ªè¡¨\n1 update è¡¨å 3 set åˆ—1 = æ–°å€¼1, åˆ—2 = æ–°å€¼2, \u0026hellip; 2 where ç­›é€‰æ¡ä»¶;\nè¯­å¥çš„é€»è¾‘é¡ºåº132\näºŒã€ ä¿®æ”¹å¤šä¸ªæ¡ä»¶\nåŒæ ·åˆ†ä¸º92è¯­æ³•å’Œ99è¯­æ³•\n@sql92è¯­æ³•ä¸­ update è¡¨1 åˆ«å, è¡¨2 åˆ«å set åˆ— = å€¼ where è¿æ¥æ¡ä»¶ and ç­›é€‰æ¡ä»¶\n@sql99è¯­æ³•ä¸­ update è¡¨1 åˆ«å [inner|left|full] update è¡¨2 åˆ«å set åˆ— = å€¼ where ç­›é€‰æ¡ä»¶\n2.3.3. åˆ é™¤æ“ä½œ æ–¹å¼ä¸€ï¼š\ndelete from è¡¨å where ç­›é€‰æ¡ä»¶ åˆ é™¤çš„åé¢è¿˜å¯ä»¥æ·»åŠ limitä½œä¸ºè¡¥å……ï¼Œä½¿ç”¨æ•ˆæœåŒæŸ¥è¯¢éƒ¨åˆ†\n@sql92 delete è¡¨1çš„åˆ«å, è¡¨2çš„åˆ«å from è¡¨1 åˆ«å, è¡¨2 åˆ«å where ç­›é€‰æ¡ä»¶ and ç­›é€‰æ¡ä»¶;\n@sql99è¯­æ³• delete è¡¨1çš„åˆ«å, è¡¨2çš„åˆ«å from è¡¨1 åˆ«å inner | left |right join è¡¨2 åˆ«å on è¿æ¥æ¡ä»¶ where ç­›é€‰æ¡ä»¶\næ–¹å¼äºŒï¼štruncate table è¡¨å\n[é¢è¯•é¢˜]\ntruncate ä¸€æ­¥å®ç°åˆ é™¤æ•´ä¸ªè¡¨ ä¸èƒ½æ·»åŠ where ä¸èƒ½å®ç°å¤šè¡¨åˆ é™¤ truncate æ•ˆç‡æ¯”deleteæ•ˆç‡é«˜ è¡¨ä¸­å¦‚æœæœ‰è‡ªå¢é•¿åˆ—ï¼Œåœ¨ä½¿ç”¨deleteåˆ é™¤ä»¥åï¼Œè‡ªå¢é•¿çš„å€¼ä¼šä»æ–­ç‚¹å¼€å§‹ å¦‚æœä½¿ç”¨truncateåˆ é™¤ï¼Œåˆ™å†æ’å…¥æ•°æ®ï¼Œè‡ªå¢é•¿åˆ—ä»1å¼€å§‹ truncateæ²¡æœ‰è¿”å›å€¼ï¼Œdeleteæœ‰è¿”å›å€¼ truncateåˆ é™¤ä¸èƒ½å›æ»šï¼Œdeleteå¯ä»¥å›æ»šäº‹åŠ¡ 2.4.DDLè¯­è¨€ Data Define Language æ•°æ®å®šä¹‰è¯­è¨€\ncreateï¼Œalterï¼Œdropç­‰\n2.4.1. åº“çš„ç®¡ç† ä¸€ã€åˆ›å»ºæ•°æ®åº“ create database åº“å; ä¸ºäº†æé«˜å®¹é”™æ€§ï¼Œå¯ä»¥å°†åˆ›å»ºè¯­å¥å†™ä¸º crate database if not exists åº“å;\näºŒã€åº“çš„ä¿®æ”¹ ä¿®æ”¹åç§° rename database åŸå to æ–°å; è¿™ç§æ–¹æ³•ç°åœ¨å·²ç»è¢«åºŸå¼ƒï¼Œå‡ºäºå®‰å…¨åŸå› \nä¸€èˆ¬ä¸ä¼šè½»æ˜“ä¿®æ”¹è¡¨å\nä¿®æ”¹å­—ç¬¦é›† alter database åº“å character set å­—ç¬¦é›†åç§°;\nä¸‰ã€åº“ååˆ é™¤\ndrop database if exists åº“å\n2.4.2. è¡¨çš„ç®¡ç† ä¸€ã€åˆ›å»º create table è¡¨å( åˆ—å1 åˆ—çš„ç±»å‹1 [(é•¿åº¦)çº¦æŸ], åˆ—å2 åˆ—çš„ç±»å‹2 [(é•¿åº¦)çº¦æŸ], åˆ—å3 åˆ—çš„ç±»å‹3 [(é•¿åº¦)çº¦æŸ]ï¼Œ ã€‚ã€‚ã€‚ );\næ·»åŠ ç¨³å®šæ€§ create table if not exists è¡¨å( åˆ—å1 åˆ—çš„ç±»å‹1 [(é•¿åº¦)çº¦æŸ], åˆ—å2 åˆ—çš„ç±»å‹2 [(é•¿åº¦)çº¦æŸ], åˆ—å3 åˆ—çš„ç±»å‹3 [(é•¿åº¦)çº¦æŸ]ï¼Œ ã€‚ã€‚ã€‚ );\næ•°æ®ç±»å‹\næ•´å‹: typeint, 1å­—èŠ‚ smallint, 2å­—èŠ‚ mediumint, 3å­—èŠ‚ int(integer), 4å­—èŠ‚ bigint, 8å­—èŠ‚ æ•´å‹ä¹‹é—´çš„åŒºåˆ«åªåœ¨äºå¯ä»¥è¡¨ç¤ºçš„èŒƒå›´ï¼Œå¦‚æœéœ€è¦è®¾ç½®æ— ç¬¦å·ï¼Œåˆ™éœ€è¦åœ¨åé¢æ·»åŠ unsigned å¦‚æœè¶…è¿‡äº†æ•´å‹å¯ä»¥è¡¨ç¤ºçš„èŒƒå›´ï¼Œä¼šæŠ¥out of range å¼‚å¸¸ï¼Œå¹¶æ·»åŠ ä¸´ç•Œå€¼ å¦‚æœè®¾ç½®é•¿åº¦å¦‚int(7) zreo fillï¼ŒåŒæ—¶è¯¥intç±»å‹ä¼šè‡ªåŠ¨å˜ä¸ºæ— ç¬¦å·ç±»å‹ï¼ŒåŒæ—¶7ä»£è¡¨é•¿åº¦ä¸å¤Ÿ7çš„æƒ…å†µä¸‹ä¼šç”¨0å¡«å…… é•¿åº¦ä»£è¡¨æ˜¾ç¤ºçš„æœ€å¤§å®½åº¦ï¼Œæ— å…¶ä»–å«ä¹‰ã€‚\nå°æ•° æµ®ç‚¹æ•°ç±»å‹ï¼š floatï¼Œ4å­—èŠ‚ double, 8å­—èŠ‚ å®šç‚¹æ•°ç±»å‹ï¼š dec(M, D), M+2å­—èŠ‚ æœ€å¤§èŒƒå›´å’Œdoubleç›¸åŒï¼Œæœ‰æ•ˆä½æœ‰M,Då†³å®š decimal(M, D), å®šä¹‰ float(M, D) double(M, D) dec(M, D)\nMè¡¨ç¤ºæ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†åˆè®¡çš„ä½æ•° åé¢çš„Dè¡¨ç¤ºå°æ•°ç‚¹ä¿ç•™ä½æ•° å¦‚æœæ’å…¥è¶…è¿‡ä¸´ç•Œå€¼ï¼Œåˆ™æ’å…¥999.99ï¼ˆè¿™é‡Œä»¥5,2ä¸ºä¾‹ï¼‰\nä¸€èˆ¬è€Œè¨€M, Déƒ½å¯ä»¥çœç•¥ å¦‚æœå¸ˆfloatå’Œdouble åˆ™ä¼šéšç€æ’å…¥çš„æ•°å€¼è€Œæ”¹å˜ å¦‚æœæ˜¯decï¼Œåˆ™é»˜è®¤Mä¸º10, Dä¸º0\nå¯¹äºå®šç‚¹å‹ï¼Œç²¾åº¦å¾ˆé«˜ï¼Œå¯¹äºæ’å…¥æ•°å€¼çš„ç²¾åº¦è¾ƒé«˜å¦‚è´§å¸è¿ç®—å¯ä»¥è€ƒè™‘ä½¿ç”¨\nå¯¹äºä½¿ç”¨çš„åŸåˆ™ï¼šæ‰€é€‰æ‹©ç±»å‹è¶Šç®€å•è¶Šå¥½ï¼Œèƒ½ä¿å­˜æ•°å€¼çš„ç±»å‹è¶Šå°è¶Šå¥½\nå­—ç¬¦ä¸² è¾ƒçŸ­çš„æ–‡æœ¬ï¼š char(M), æœ€å¤šå­—ç¬¦æ•°æ˜¯Mï¼Œä¸æ˜¯å­—èŠ‚æ•°ï¼Œå¼€è¾Ÿç©ºé—´æ—¶çš„é•¿åº¦å›ºå®šï¼Œæ•ˆç‡è¾ƒé«˜ varchar(M),å¯å˜é•¿åº¦çš„å­—ç¬¦ï¼Œæ•ˆç‡ä½äºchar binary, varbinarty,ä¸ä¸Šç±»ä¼¼ï¼Œå­˜äºŒè¿›åˆ¶ç±»å‹ enum(å­—æ®µ),å¦‚è®¾ç½®enum('ç”·','å¥³')é‚£ä¹ˆåœ¨æ·»åŠ çš„æ—¶å€™åªèƒ½æ·»åŠ è¿™ä¸¤ç§ç±»å‹ set(å¤šä¸ªæˆå‘˜), ä¸enumç±»ä¼¼ï¼Œä¸è¿‡å¯ä»¥ä¸€æ¬¡é€‰å–å¤šä¸ªæˆå‘˜ è¾ƒé•¿çš„æ–‡æœ¬ï¼š text blob å¦‚æœæ˜¯å­˜å‚¨å­£èŠ‚å¦‚æ˜¥å¤ç§‹å†¬ï¼Œåˆ™ä½¿ç”¨charæ•ˆç‡ä¼šé«˜äºvarchar charçš„é•¿åº¦Må¯ä»¥çœç•¥ï¼Œé»˜è®¤ä¸º1ï¼Œè€Œvarcharçš„é•¿åº¦Mä¸å¯ä»¥çœç•¥\næ—¥æœŸç±»å‹ï¼š date,4å­—èŠ‚ï¼ŒèŒƒå›´1000-9999 datetime,8å­—èŠ‚ï¼ŒèŒƒå›´1970-2038 timestamp,4å­—èŠ‚ time,3å­—èŠ‚ year,1å­—èŠ‚ timestampæ’å…¥çš„å†…å®¹å®é™…çš„æ—¶åŒºæœ‰å…³ï¼Œæ›´èƒ½ååº”å½“å‰çš„æ—¶æœŸï¼Œå—mysqlç‰ˆæœ¬å½±å“ datetimeåªèƒ½åæ˜ å‡ºæ’å…¥æ—¶çš„å½“åœ°æ—¶åŒº æŸ¥è¯¢ä¿®æ”¹æ•°æ®åº“çš„æ—¶åŒº show variables like \u0026rsquo;time_zone' set time_zone = \u0026lsquo;+9:00\u0026rsquo;\näºŒã€è¡¨çš„ä¿®æ”¹\nä¿®æ”¹åˆ—å alter table è¡¨å change column åŸè¡¨å æ–°è¡¨å;\nä¿®æ”¹åˆ—çš„ç±»å‹ä»¥åŠçº¦æŸ alter table è¡¨å modify column åˆ—å çº¦æŸç±»å‹;\næ·»åŠ æ–°åˆ— alter table è¡¨å add column åˆ—å çº¦æŸç±»å‹;\nåˆ é™¤åˆ— alter table è¡¨å drop column åˆ—å; alter table è¡¨å drop column if exists åˆ—å;\nä¿®æ”¹è¡¨å alter table è¡¨å rename to æ–°è¡¨å\nä¸‰ã€è¡¨çš„åˆ é™¤\ndrop table è¡¨å; drop table id exists è¡¨å\næŸ¥çœ‹æ‰€æœ‰è¡¨ show tables;\nå››ã€ è¡¨çš„å¤åˆ¶\nä»…ä»…å¤åˆ¶è¡¨çš„ç»“æ„ï¼š create table è¡¨å like åŸè¡¨å;\nå¤åˆ¶è¡¨çš„æ•°æ®+ç»“æ„ï¼š create table è¡¨å select * from åŸè¡¨å\nåªå¤åˆ¶éƒ¨åˆ†åˆ—æˆ–è€…éƒ¨åˆ†è¡Œ create table è¡¨å select æŸ¥è¯¢çš„å†…å®¹\nåªå¤åˆ¶éƒ¨åˆ†çš„å†…å®¹ä½œä¸ºè¡¨çš„ç»“æ„ create table è¡¨å select åˆ—å from åŸè¡¨å where 1=2; # æˆ–è€…ç›´æ¥å†™0\n2.2.3. è¡¨çš„çº¦æŸ çº¦æŸç”¨äºé™åˆ¶è¡¨ä¸­çš„æ•°æ® ä¸ºäº†ä¿è¯æ·»åŠ åˆ°è¡¨ä¸­çš„æ•°æ®å¯é \nä¸€ã€not null è¯¥å­—æ®µçš„å€¼ä¸èƒ½ä¸ºç©º å¸¸ç”¨ä½œå­¦å·ï¼Œå§“å\näºŒã€default ç”¨äºä¿è¯è¯¥å­—æ®µæœ‰é»˜è®¤å€¼æ¯”å¦‚æ€§åˆ«\nä¸‰ã€primary key ä¿è¯è¯¥å­—æ®µå…·æœ‰å”¯ä¸€æ€§ï¼Œå¹¶ä¸”éç©º æ¯”å¦‚å­¦å·\nå››ã€unique ä¿è¯è¯¥å­—æ®µå…·æœ‰å”¯ä¸€æ€§ æ¯”å¦‚åº§ä½å·\näº”ã€check åœ¨MySQLä¸­ä¸æ”¯æŒï¼Œä½†æ˜¯ä¸ä¼šæŠ¥é”™ é™åˆ¶æ€§åˆ«åªæœ‰ç”·å’Œå¥³ å‚æ•°æ ¡éªŒä¸€èˆ¬ç”±åç«¯æ¥åš\nå…­ã€foreign key references ç”¨äºé™åˆ¶ä¸¤ä¸ªè¡¨ä¹‹é—´çš„å…³ç³» ä¿è¯è¯¥ä»è¡¨çš„å­—æ®µå€¼å¿…é¡»æ¥è‡ªä¸»è¡¨å…³è”åˆ—çš„å€¼ ä»è¡¨å¼•ç”¨ä¸»è¡¨çš„å€¼ show index from è¡¨å\nåœ¨åˆ›å»ºè¡¨æ—¶ï¼Œä¿®æ”¹è¡¨æ—¶éƒ½å¯ä»¥æ·»åŠ çº¦æŸ\nçº¦æŸçš„ç±»å‹ï¼š åˆ—çº§çº¦æŸï¼šå…­å¤§çº¦æŸéƒ½æœ‰æ•ˆæœï¼Œä½†æ˜¯å¤–é”®çº¦æŸæ²¡æœ‰æ•ˆæœ è¡¨çº§çº¦æŸï¼šé™¤äº†éç©ºå’Œé»˜è®¤å€¼ï¼Œå…¶ä½™éƒ½æ”¯æŒ ä¸€èˆ¬æ¥è¯´æ·»åŠ è¡¨çº§çº¦æŸç”¨constraint è¯­æ³• [constraint çº¦æŸå] çº¦æŸç±»å‹(å­—æ®µå)\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 create table student ( id int, stuname varchar(20), gender char(1), seat int, age int, majorid int, constraint pk primary key (id), constraint uq unique(seat) constraint ck check(gender = \u0026#39;ç”·\u0026#39; or gender = \u0026#39;å¥³\u0026#39;), constraint fk_sudent_major foreign key(majorid) references major(id) ) é¢è¯•é¢˜ ä¸»é”®å’Œå”¯ä¸€åŒºåˆ«ï¼š ä¸»é”®å¿…å®šå”¯ä¸€ï¼Œä¸å…è®¸ä¸ºç©ºã€‚ å¯ä»¥è®¾ç½®è”åˆä¸»é”®ï¼šå³åªæœ‰å¤šä¸ªåˆ—éƒ½å®Œå…¨ç›¸åŒæ‰ä¼šæŠ¥é”™ï¼Œä½†æ˜¯ä¸æ¨èä½¿ç”¨ã€‚\nå¤–é”®è¦æ±‚ åœ¨ä»è¡¨ä¸Šè®¾ç½®å¤–é”®å…³ç³»ï¼š ä»è¡¨å¤–é”®çš„åˆ—ç±»å‹è¦å’Œä¸»è¡¨ç›¸ä¸€è‡´æˆ–è€…å…¼å®¹ï¼Œå¯¹åç§°æ— è¦æ±‚ è¦æ±‚ä¸»è¡¨çš„å…³è”åˆ—å¿…é¡»æ˜¯ä¸€ä¸ªkeyï¼Œä¸€èˆ¬æ˜¯ä¸»é”®æˆ–è€…å”¯ä¸€ ä¿®æ”¹çº¦æŸç±»å‹ åˆ—çº§çº¦æŸï¼š alter table è¡¨å modify column åˆ—å ç±»å‹å é™å®š è¡¨çº§çº¦æŸï¼š alter table è¡¨å add primary key(åˆ—å) åˆ é™¤çº¦æŸï¼š alter table è¡¨åmodify column åˆ—å ç±»å‹å [null]; ä¸€èˆ¬è¿™ä¸ªnullå¯ä»¥çœç•¥ä¸å†™\næ ‡è¯†åˆ—ï¼šåˆç§°ä¸ºè‡ªå¢é•¿åˆ— ä¸€ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ªè‡ªå¢é•¿åˆ—ï¼Œä¸”å¿…é¡»æ˜¯æ•°å€¼ç±»å‹ show variables like \u0026lsquo;%auto_increment%\u0026rsquo; set auto_increment = 3 #ä¿®æ”¹æ­¥é•¿ åˆå§‹å€¼ç›´æ¥æ’å…¥ä¸€ä¸ªç‰¹æ®Šçš„å€¼å°±è¡Œ\n2.5.TCLè¯­è¨€ Transaction Control Language äº‹åŠ¡æ§åˆ¶è¯­è¨€\n2.5.1. äº‹åŠ¡ ä¸€ä¸ªæˆ–è€…ä¸€ç»„sqlè¯­å¥ç»„æˆä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œè¿™ä¸ªæ‰§è¡Œå•å…ƒè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚\nå­˜å‚¨ç±»å‹\n[é¢è¯•é¢˜] äº‹åŠ¡ACIDçš„ç‰¹æ€§ï¼š\nåŸå­æ€§(Atomicity)ï¼šäº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆéƒ½å‘ç”Ÿï¼Œè¦ä¹ˆéƒ½ä¸å‘ç”Ÿã€‚ ä¸€è‡´æ€§(Consistency)ï¼šäº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚ éš”ç¦»æ€§(Isolation)ï¼šäº‹ç‰©çš„éš”ç¦»æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹å¹¶å‘çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡ä¹‹é—´ä¸èƒ½äº’ç›¸å¹²æ‰°ã€‚ æŒä¹…æ€§(Durability)ï¼šæŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œæ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œå’Œæ•°æ®åº“æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚ ä¸€ã€äº‹åŠ¡çš„åˆ›å»º éšå¼ï¼šäº‹åŠ¡æ²¡æœ‰æ˜æ˜¾çš„å¼€å§‹å’Œç»“æŸè¯­å¥ æ¯”å¦‚update insert insertè¯­å¥\n1 2 3 4 5 6 7 8 9 10 11 #å‰æå¿…é¡»å…ˆè®¾ç½®æ˜æ˜¾çš„å¼€å¯å’Œç»“æŸçš„æ ‡è®° set autocommit = 0 # å¼€å¯äº‹åŠ¡çš„è¯­å¥ start transaction # æäº¤äº‹åŠ¡ commit # å›æ»šäº‹åŠ¡ rollback 2.5.2. æ•°æ®åº“çš„éš”ç¦»çº§åˆ« åŒæ—¶è¿è¡Œå¤šä¸ªäº‹åŠ¡ï¼Œå¯¹äºä¸¤ä¸ªäº‹åŠ¡ï¼Œä¸€ä¸ªäº‹åŠ¡è¯»å–äº†å¦ä¸€ä¸ªäº‹åŠ¡æ›´æ–°ä½†æ˜¯æœªæäº¤çš„å­—æ®µï¼Œå¦‚æœè¿™ä¸ªäº‹åŠ¡å›æ»šï¼Œé‚£ä¹ˆåŸäº‹åŠ¡æ˜¯æ— æ•ˆçš„ã€‚\n[é¢è¯•é¢˜] è„è¯»ï¼šT1è¯»å–äº†T2å·²æ›´æ–°ä½†æ˜¯æœªæäº¤çš„æ—¶æ®µï¼Œå¦‚æœT2å›æ»šï¼Œåˆ™T1çš„æ•°æ®æ— æ•ˆã€‚ ä¸å¯é‡å¤è¯»ï¼šT1è¯»å–äº†ä¸€ä¸ªå­—æ®µï¼Œä½†æ˜¯T2æŠŠè¿™ä¸ªå­—æ®µæ›´æ–°äº†ï¼ŒT1å†è¯»å–è¯¥å­—æ®µæ—¶æ•°æ®å‘ç”Ÿäº†æ”¹å˜ã€‚ å¹»è¯»ï¼šT1ä»è¡¨ä¸­è¯»å–äº†ä¸€ä¸ªå­—æ®µï¼Œç„¶åT2åœ¨è¯¥è¡¨ä¸­æ’å…¥äº†ä¸€äº›æ–°çš„è¡Œï¼ŒT1å†è¯»å–çš„è¡¨å°±ä¼šå¤šå‡ºå‡ è¡Œ\næ•°æ®åº“çš„éš”ç¦»é—®é¢˜ æ•°æ®åº“æœ‰å››ç§éš”ç¦»çº§åˆ«ï¼š\nREAD UNCOMMITED å…è®¸äº‹åŠ¡è¯»å–æœªè¢«å…¶ä»–äº‹åŠ¡æäº¤çš„å˜æ›´ï¼Œä¸‰ç§é—®é¢˜éƒ½ä¼šå‡ºç° READ COMMITED åªå…è®¸è¯»å–å·²ç»è¢«æäº¤çš„å˜æ›´ï¼Œå¯ä»¥é¿å…è„è¯»ï¼Œä½†æ˜¯ä¸å¯é¿å…ä¸å¯é‡å¤è¯»å’Œå¹»è¯» REPEATABLE READï¼ˆé»˜è®¤ï¼‰ ç¡®ä¿äº‹åŠ¡å¯ä»¥å¤šæ¬¡ä»ä¸€ä¸ªå­—æ®µä¸­è¯»å–ç›¸åŒçš„å€¼ï¼Œå¯ä»¥é¿å…è„è¯»å’Œä¸å¯é‡å¤è¯»ï¼Œä½†æ˜¯ä¸å¯é¿å…å¹»è¯» SERIALIZABLE ç¡®ä¿äº‹åŠ¡å¯ä»¥ä»ä¸€ä¸ªè¡¨ä¸­è¯»å–ç›¸åŒçš„è¡Œï¼Œäº‹åŠ¡æŒç»­æ—¶é—´ç¦æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¯¥è¡¨æ‰§è¡Œæ’å…¥ï¼Œé¿å…æ‰€æœ‰æƒ…å†µï¼Œæ•ˆç‡æä½ æŸ¥çœ‹å½“å‰çš„æ•°æ®åº“éš”ç¦»çº§åˆ« select @@tx_isolation;\nsavepoint èŠ‚ç‚¹å; è®¾ç½®äº‹åŠ¡çš„ä¿å­˜ç‚¹\nrollback èŠ‚ç‚¹å; å°†äº‹åŠ¡å›æ»šåˆ°ä¿å­˜ç‚¹å¤„\n2.5.3.è§†å›¾ è™šæ‹Ÿè¡¨å’Œæ™®é€šè¡¨ä¸€æ ·ä½¿ç”¨\nä¸€ç§è™šæ‹Ÿå­˜åœ¨çš„è¡¨ï¼Œè¡Œåˆ—çš„æ•°æ®æ¥è‡ªå®šä¹‰è§†å›¾æŸ¥è¯¢ä¸­æ‰€ä½¿ç”¨çš„è¡¨ï¼Œæ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œåªä¿ç•™sqlé€»è¾‘ï¼Œä¸ä¿ç•™æŸ¥è¯¢çš„ç»“æœ\nè¯­æ³• create view è§†å›¾å as æŸ¥è¯¢è¯­å¥\nå¥½å¤„ï¼š\né‡ç”¨å¤æ‚çš„sqlè¯­å¥ ç®€åŒ–äº†sqlçš„æ“ä½œï¼Œä¸å¿…çŸ¥é“æŸ¥è¯¢çš„ç»†èŠ‚ ä¿æŠ¤æ•°æ®ï¼Œæé«˜å®‰å…¨æ€§ è§†å›¾çš„ä¿®æ”¹ create or replace view è§†å›¾å as æŸ¥è¯¢è¯­å¥\næˆ–è€…ä½¿ç”¨ alter view è§†å›¾å as æŸ¥è¯¢è¯­å¥\nåˆ é™¤è§†å›¾ drop view è§†å›¾åï¼Œè§†å›¾åï¼Œâ€¦â€¦\næŸ¥çœ‹è§†å›¾ desc è§†å›¾å;\n[ç¾å›¢2019ç§‹æ‹›ç¬”è¯•] å…·æœ‰ä»¥ä¸‹å…³é”®å­—çš„è§†å›¾ä¸å…è®¸æ›´æ–°ï¼š èšåˆå‡½æ•°ï¼ˆSUM(), MIN(), MAX(), COUNT()ç­‰ï¼‰ã€‚ DISTINCT GROUP BY HAVING UNIONæˆ–UNION ALL ä½äºé€‰æ‹©åˆ—è¡¨ä¸­çš„å­æŸ¥è¯¢ Join FROMå­å¥ä¸­çš„ä¸å¯æ›´æ–°è§†å›¾ WHEREå­å¥ä¸­çš„å­æŸ¥è¯¢ï¼Œå¼•ç”¨FROMå­å¥ä¸­çš„è¡¨ã€‚ ä»…å¼•ç”¨æ–‡å­—å€¼ï¼ˆåœ¨è¯¥æƒ…å†µä¸‹ï¼Œæ²¡æœ‰è¦æ›´æ–°çš„åŸºæœ¬è¡¨ï¼‰ã€‚ ALGORITHM = TEMPTABLEï¼ˆä½¿ç”¨ä¸´æ—¶è¡¨æ€»ä¼šä½¿è§†å›¾æˆä¸ºä¸å¯æ›´æ–°çš„ï¼‰ã€‚\nè§†å›¾è™½ç„¶å¯ä»¥æ›´æ–°ï¼Œä½†æ˜¯æœ€å¥½ä¸è¦æ›´æ–°ï¼Œå¦‚æœæ²¡æœ‰å…¨é¢è€ƒè™‘åœ¨è§†å›¾ä¸­æ›´æ–°æ•°æ®çš„é™åˆ¶ï¼Œå°±å¯èƒ½ä¼šé€ æˆæ•°æ®æ›´æ–°å¤±è´¥\n2.6. å˜é‡ ç³»ç»Ÿå˜é‡ å…¨å±€å˜é‡ ä¼šè¯å˜é‡ è‡ªå®šä¹‰å˜é‡ ç”¨æˆ·å˜é‡ å±€éƒ¨å˜é‡ ç³»ç»Ÿå˜é‡ï¼šç”±ç³»ç»Ÿæä¾›ï¼Œå±äºæœåŠ¡å™¨å±‚é¢\nshow global|session variables\næŸ¥çœ‹æ»¡è¶³æ¡ä»¶çš„éƒ¨åˆ†ç³»ç»Ÿå˜é‡\nshow global variables like \u0026lsquo;%char%\u0026rsquo;\næŸ¥çœ‹æŒ‡å®šçš„æŸä¸ªç³»ç»Ÿå˜é‡çš„å€¼ select @@global|session.ç³»ç»Ÿå˜é‡å\nä¸ºæŸä¸ªç³»ç»Ÿå˜é‡èµ‹å€¼ set @@global|session.ç³»ç»Ÿå˜é‡å = èµ‹çš„å€¼\näºŒã€ä¼šè¯å˜é‡ ä»…ä»…é’ˆå¯¹å½“å‰ä¼šè¯æœ‰æ•ˆ ä½¿ç”¨æ–¹æ³•ä¸ä¸Šç›¸åŒï¼ŒæŠŠglobalæ¢æˆsession\nä¸‰ã€è‡ªå®šä¹‰å˜é‡ ä½œç”¨åŸŸä¹Ÿä»…ä»…é’ˆå¯¹äºå½“å‰çš„ä¼šè¯ï¼ŒåŒäºä¼šè¯å˜é‡çš„ä½œç”¨åŸŸï¼Œé’ˆå¯¹å½“å‰å˜é‡æœ‰æ•ˆ å£°æ˜æˆ–è€…æ˜¯èµ‹å€¼ï¼š\n1 2 3 set @ç”¨æˆ·å˜é‡å = å€¼; set @ç”¨æˆ·å˜é‡å := å€¼; select @ç”¨æˆ·å˜é‡å := å€¼; ç”¨æˆ·çš„è‡ªå®šä¹‰å˜é‡åä¸ºå¼±ç±»å‹ èµ‹å€¼ä¹Ÿå¯ä»¥ä½¿ç”¨\n1 2 select å­—æ®µ into @å˜é‡å from è¡¨; å››ã€å±€éƒ¨å˜é‡ åªèƒ½æ”¾åœ¨beginï¼Œendä¸­\nå£°æ˜å’Œèµ‹å€¼ declare å˜é‡å æ•°æ®ç±»å‹ [default å€¼];\ndeclare å˜é‡å æ•°æ®ç±»å‹(å€¼);\nç”¨æˆ·å˜é‡ å±€éƒ¨å˜é‡ å½“å‰ä¼šè¯ begin endä¸­é—´ ä¼šè¯ä¸­ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥ç”¨ åªèƒ½åœ¨begin endä¸­ä¸”ä¸ºç¬¬ä¸€å¥ ä¸€èˆ¬åŠ @ï¼Œå¼±ç±»å‹ ä¸éœ€è¦åŠ @ï¼Œå¼ºç±»å‹ 2.7. æµç¨‹æ§åˆ¶å‡½æ•° å­˜å‚¨è¿‡ç¨‹ï¼šä¸€ç»„é¢„å…ˆç¼–è¯‘å¥½çš„sqlè¯­å¥é›†åˆã€‚\næé«˜ä»£ç çš„é‡ç”¨æ€§ï¼Œç®€åŒ–æ“ä½œï¼Œå‡å°‘è¿æ¥æœåŠ¡å™¨çš„æ¬¡æ•°\n1 2 3 4 create procedure pro_name(å‚æ•°åˆ—è¡¨) begin ä¸€ç»„sqlè¯­å¥ end $; åœ¨å‚æ•°åˆ—è¡¨ç§ï¼Œinä½œä¸ºè¾“å…¥ï¼Œoutä½œä¸ºè¾“å‡ºï¼Œinoutæ—¢å¯ä»¥è¾“å…¥ä¹Ÿå¯ä»¥è¾“å‡º å­˜å‚¨è¿‡ç¨‹çš„ç»“å°¾å¯ä»¥ä½¿ç”¨ delimiter ç»“æŸæ ‡è®°\nè°ƒç”¨call pro_name()\nåˆ é™¤ drop procedure pro_name\nå‡½æ•°åˆ›å»º create function å‡½æ•°å(å‚æ•°åˆ—è¡¨) return è¿”å›ç±»å‹ begin\nend\nå‡½æ•°ä½“ç§è‚¯å®šä¼šæœ‰returnè¯­å¥\næµç¨‹æ§åˆ¶ç»“æ„\né¡ºåºç»“æ„ åˆ†æ”¯ç»“æ„ å¾ªç¯ç»“æ„ if(è¡¨è¾¾å¼1ï¼Œè¡¨è¾¾å¼2ï¼Œè¡¨è¾¾å¼3)\ncase å˜é‡|è¡¨è¾¾å¼|å­—æ®µ when åˆ¤æ–­å€¼ then è¿”å›çš„å€¼; when åˆ¤æ–­å€¼ then è¿”å›çš„å€¼; ã€‚ã€‚ã€‚ else end case;\ncase when åˆ¤æ–­æ¡ä»¶ then è¿”å›çš„å€¼; when åˆ¤æ–­æ¡ä»¶ then è¿”å›çš„å€¼; ã€‚ã€‚ã€‚ else end case;\nif æ¡ä»¶1 then è¯­å¥1; elseif æ¡ä»¶2 then è¯­å¥2; ã€‚ã€‚ã€‚ [else è¯­å¥n;] end if;\nå¾ªç¯ç»“æ„ iterate ç±»ä¼¼äº continue\n[æ ‡ç­¾] loop å¾ªç¯ä½“ end loop [æ ‡ç­¾]\n","date":"2021-03-20T10:15:30+08:00","image":"https://chasing1020.github.io/post/mysql-basic-note/mysql_hubf29412fdbd9303c575ba06f7ee7c6af_94146_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/mysql-basic-note/","title":"MySQL Basic Note"},{"content":"SHUç¤¾åŒºå­¦é™¢èµ„æ–™æ•´ç† æœ¬ç€å¼€æºçš„åŸåˆ™ï¼ŒåŠ ä¹‹ç–«æƒ…æœŸé—´åœ¨å®¶å…¨ç¨‹çš„çº¿ä¸Šæ•™å­¦ï¼Œåœ¨æœ¬äººçˆ±å¥½æ”¶é›†æ–‡ä»¶çš„ä¹ æƒ¯ä¹‹ä¸‹ï¼Œç•™ä¸‹äº†ä¸€ç³»åˆ—åœ¨ç¤¾åŒºå­¦é™¢æœŸé—´å­¦ä¹ çš„èµ„æ–™ã€‚\næœ¬æ–‡ä»…åŒ…å«ç›¸å…³ç”µå­ä¹¦ï¼Œå·²å…¬å¼€çš„å†å¹´è¯•å·ç­‰èµ„æºï¼Œæ¶µç›–äº†å¾®ç§¯åˆ†ï¼Œå¤§å­¦ç‰©ç†ï¼Œçº¿æ€§ä»£æ•°ï¼Œå·¥ç¨‹åˆ¶å›¾ï¼Œä¸­å›½è¿‘ç°ä»£å²çº²è¦ï¼Œå†›äº‹ç†è®ºç­‰å­¦ç§‘ã€‚ æœ¬æ–‡ä¸å«ä»»ä½•å†å²ä½œä¸šï¼ŒæŠ¥å‘Šç­‰æ•æ„Ÿå†…å®¹ã€‚ç›¸å…³æ•™å­¦è¯¾ä»¶ã€ç¬”è®°ç­‰å·²æ ‡æ³¨å‡ºå¤„ã€‚ æœ¬æ–‡æ‰€åˆ†äº«çš„æ‰€æœ‰èµ„æ–™ï¼Œä»…ä¾›ä¸Šæµ·å¤§å­¦è®¡ç®—æœºå­¦é™¢å­¦ç”Ÿå­¦ä¹ ä¸äº¤æµä½¿ç”¨ã€‚ æœ¬æ–‡çš„èµ„æ–™ä»…ä¾›å‚è€ƒï¼Œè¯·è‡ªå·±åˆ¤æ–­å…¶é€‚ç”¨æ€§ã€‚ æœ¬æ–‡ä¸€äº›æ–‡ä»¶å¦‚ä¾µçŠ¯äº†æ‚¨çš„æƒç›Šï¼Œè¯·å‘æˆ‘é‚®ä»¶ï¼Œæˆ‘ä¼šåŠæ—¶å½»åº•æ¸…é™¤è¿™äº›æ–‡ä»¶ã€‚ æœ¬æ–‡è®¸å¯ï¼šCC-BY-NC-SAï¼šç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº«\næ–‡ç« ç‰ˆæƒå½’ä¸ªäººæ‰€æœ‰ï¼Œæœªç»ä½œè€…æˆæƒç¦æ­¢è½¬è½½ï¼ˆæˆ–æ³¨æ˜å‡ºå¤„ï¼‰ï¼Œä¸å¾—å°†å…¶ä¸­çš„èµ„æ–™ç”¨ä½œä»»ä½•å•†ä¸šç”¨é€”ã€‚\n1. å¤§ä¸€è¯¾æœ¬ å¤§ä¸€æœŸé—´çš„ç»å¤§å¤šæ•°è¯¾æœ¬pdfç‰ˆ\né“¾æ¥: https://pan.baidu.com/s/1XaGX4IoydftzUxTh_ABlEQ\næå–ç : tkkc\n2. å†å¹´æœŸæœ«è¯•å· éƒ¨åˆ†å­¦ç§‘çš„å†å¹´æœŸæœ«æµ‹è¯•è¯•å·\né“¾æ¥: https://pan.baidu.com/s/13eB0v-wAEBkCBeHpp7NfUg\næå–ç : qmsj\n3. ç†å·¥å¤§ç±»å¾®ç§¯åˆ†è¯•å· ç†å·¥å¤§ç±»çš„å¾®ç§¯åˆ†æµ‹è¯•å·ä»¥åŠç»ƒä¹ é¢˜ç­‰\né“¾æ¥: https://pan.baidu.com/s/1Purl_p4G2LMvmpwHeBqImA\næå–ç : gssj\n4. çº¿æ€§ä»£æ•°èµ„æ–™ å²ä¸Šæœ€å…¨çš„çº¿æ€§ä»£æ•°èµ„æ–™ï¼ŒåŒ…æ‹¬å¤§å¤šæ•°è¯¾ä»¶è¯¾æœ¬pdfï¼Œæµ‹è¯•é¢˜ï¼Œå†å¹´è¯•å·ï¼ŒçŒ´åšå£«æ•™ç¨‹ç­‰ç­‰\né“¾æ¥: https://pan.baidu.com/s/1P95PTcMIWNJUCoK4rQ9s1w\næå–ç : xxds\n5. é«˜ç­‰æ•°å­¦ç”µå­æ•™æ¡ˆ æˆ‘æ ¡é«˜ç­‰æ•°å­¦ç”µå­è¯¾ä»¶ï¼Œè½¬è½½è‡ªå¾®ä¿¡å…¬ä¼—å·â€œä¸Šå¤§æ•°å­¦åœ¨çº¿â€ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œé€‰æ‹©å…³æ³¨\né“¾æ¥: https://pan.baidu.com/s/1gAOJcVsjovshoAyaSzk0qQ\næå–ç : md5c\n6. å¤§å­¦ç‰©ç†ç”µå­æ•™æ¡ˆ å¤§å­¦ç‰©ç†çš„è¯¾ä»¶ï¼Œç”±äºçº¿ä¸Šä¸Šè¯¾è´¨é‡ä¸é½ï¼Œæ•´ç†çš„æ•°ç›®è¾ƒå°‘\né“¾æ¥: https://pan.baidu.com/s/1oigVp21in-MPKVmmPHur4A\næå–ç : dxwl\n7. å·¥ç¨‹åˆ¶å›¾å’Œè®¡ç®—æœºç»˜å›¾åŸºç¡€ å·¥ç¨‹åˆ¶å›¾çš„ä¹ é¢˜é›†ç­”æ¡ˆç­‰\né“¾æ¥: https://pan.baidu.com/s/1SlZDrEkvIYgibgKa8l8x3Q\næå–ç : gczt\n8. å†›äº‹ç†è®ºèµ„æ–™ å†›äº‹ç†è®ºå¤ä¹ æçº²ï¼ŒankièƒŒè¯µè¯å…¸ç­‰ï¼Œä»¥åŠçº¿ä¸Šè€ƒè¯•çš„é¢˜åº“\né“¾æ¥: https://pan.baidu.com/s/1B5ECxo8G-IFMUJO9Xhm2VA\næå–ç : jsll\n9. ä¸­å›½è¿‘ç°ä»£å²çº²è¦ ä¸­è¿‘çº²çš„é¢˜åº“ï¼Œæ•™è¾…ä¹¦ç­‰ç­‰\né“¾æ¥: https://pan.baidu.com/s/1kXq7g2xi44dUmxUo1I44uw\næå–ç : jxds\n10. å¤§å­¦è‹±è¯­ è§†å¬è¯´. è¯»å†™æ•™ç¨‹\né“¾æ¥: https://pan.baidu.com/s/1QwYKqmDXa-L0wUe2173hgw\næå–ç : dxyy\n11. å¤§ç‰©. å¤§åŒ–å®éªŒ å¤§å­¦ç‰©ç†å®éªŒä»¥åŠå¤§å­¦åŒ–å­¦å®éªŒç”¨ä¹¦ï¼Œ å®éªŒè¯¾å…¶å®å¯ä»¥ä¸ç”¨å»æ•™æç§‘ä¹°çº¸è´¨ä¹¦çš„ï¼ˆ\né“¾æ¥: https://pan.baidu.com/s/1zIz8kGJFJ6GXlRsEB4King\næå–ç : sykb\n","date":"2020-11-28T13:11:09+08:00","image":"https://chasing1020.github.io/post/community-college-materials/material_hu4783a9fa510b9a24914cdcd138fe363a_51364_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/community-college-materials/","title":"Community College Materials"},{"content":"Selenium3å®ç°ç½‘é¡µè‡ªåŠ¨åŒ– 1.åˆæ­¥å·¥ä½œ 1.1 ç¯å¢ƒé…ç½® å®‰è£…Selenium\næœ¬æ–‡ä½¿ç”¨çš„æ˜¯python3.8.4 64bit\nä½¿ç”¨pipæŒ‡ä»¤å®‰è£…selenium\npip install selenium\n1.2 è®¾ç½®æµè§ˆå™¨é©±åŠ¨ é¦–å…ˆè®¾ç½®æµè§ˆå™¨çš„åœ°å€ï¼Œæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªå­˜æ”¾æµè§ˆå™¨é©±åŠ¨çš„ç›®å½•ï¼Œå¦‚ï¼š E:\\driver , å°†ä¸‹è½½çš„æµè§ˆå™¨é©±åŠ¨æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼šchromedriverã€geckodriverï¼‰ä¸¢åˆ°è¯¥ç›®å½•ä¸‹ã€‚\næˆ‘çš„ç”µè„‘\u0026ndash;\u0026gt;å±æ€§\u0026ndash;\u0026gt;ç³»ç»Ÿè®¾ç½®\u0026ndash;\u0026gt;é«˜çº§\u0026ndash;\u0026gt;ç¯å¢ƒå˜é‡\u0026ndash;\u0026gt;ç³»ç»Ÿå˜é‡\u0026ndash;\u0026gt;Pathï¼Œå°†â€œE:\\driverâ€ç›®å½•æ·»åŠ åˆ°Pathçš„å€¼ä¸­ã€‚\néªŒè¯ä¸åŒçš„æµè§ˆå™¨é©±åŠ¨æ˜¯å¦æ­£å¸¸ä½¿ç”¨ã€‚\nfrom selenium import webdriver\n1 2 3 4 5 6 7 8 9 10 11 driver = webdriver.Firefox() # Firefoxæµè§ˆå™¨ driver = webdriver.Chrome() # Chromeæµè§ˆå™¨ driver = webdriver.Ie() # Internet Exploreræµè§ˆå™¨ driver = webdriver.Edge() # Edgeæµè§ˆå™¨ driver = webdriver.Opera() # Operaæµè§ˆå™¨ driver = webdriver.PhantomJS() # PhantomJS 2.åŸºæœ¬æ“ä½œ 2.1 å…ƒç´ å®šä½ Seleniumæä¾›äº†8ç§å®šä½æ–¹å¼ã€‚\nid name class name name link text partial link text xpath css selector\nè¿™8ç§å®šä½æ–¹å¼åœ¨Python seleniumä¸­æ‰€å¯¹åº”çš„æ–¹æ³•ä¸ºï¼š\nfind_element_by_id() find_element_by_name() find_element_by_class_name() find_element_by_tag_name() find_element_by_link_text() find_element_by_partial_link_text() find_element_by_xpath() find_element_by_css_selector()\nå®šä½ä½¿ç”¨çš„æ–¹æ³•\nå‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªWebé¡µé¢ï¼Œé€šè¿‡å‰ç«¯å·¥å…·ï¼ˆå¦‚ï¼ŒFirebugï¼‰æŸ¥çœ‹åˆ°ä¸€ä¸ªå…ƒç´ çš„å±æ€§æ˜¯è¿™æ ·çš„ã€‚\n1 2 3 4 5 6 7 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;body link=\u0026#34;#0000cc\u0026#34;\u0026gt; \u0026lt;a id=\u0026#34;result_logo\u0026#34; href=\u0026#34;/\u0026#34; onmousedown=\u0026#34;return c({\u0026#39;fm\u0026#39;:\u0026#39;tab\u0026#39;,\u0026#39;tab\u0026#39;:\u0026#39;logo\u0026#39;})\u0026#34;\u0026gt; \u0026lt;form id=\u0026#34;form\u0026#34; class=\u0026#34;fm\u0026#34; name=\u0026#34;f\u0026#34; action=\u0026#34;/s\u0026#34;\u0026gt; \u0026lt;span class=\u0026#34;soutu-btn\u0026#34;\u0026gt;\u0026lt;/span\u0026gt; \u0026lt;input id=\u0026#34;kw\u0026#34; class=\u0026#34;s_ipt\u0026#34; name=\u0026#34;wd\u0026#34; value=\u0026#34;\u0026#34; maxlength=\u0026#34;255\u0026#34; autocomplete=\u0026#34;off\u0026#34;\u0026gt;è¾“å…¥æ¡† æˆ‘ä»¬çš„ç›®çš„æ˜¯è¦å®šä½inputæ ‡ç­¾çš„è¾“å…¥æ¡†ã€‚\né€šè¿‡idå®šä½: 1 dr.find_element_by_id(\u0026#34;kw\u0026#34;) é€šè¿‡nameå®šä½: 1 dr.find_element_by_name(\u0026#34;wd\u0026#34;) é€šè¿‡class nameå®šä½: 1 dr.find_element_by_class_name(\u0026#34;s_ipt\u0026#34;) é€šè¿‡tag nameå®šä½: 1 dr.find_element_by_tag_name(\u0026#34;input\u0026#34;) **1ã€ é€šè¿‡xpathå®šä½ï¼Œxpathå®šä½æœ‰å¤šç§å†™æ³•ï¼Œè¿™é‡Œåˆ—å‡ ä¸ªå¸¸ç”¨å†™æ³•: ** Xpathæ”¯æŒIDã€Classã€Nameå®šä½åŠŸèƒ½ï¼Œä»¥ä»¥ä¸‹ä¸‰è€…ä¸ºä¾‹ï¼š 1ï¼‰ã€é€šè¿‡IDå®šä½ //[@id=\u0026lsquo;kw\u0026rsquo;] 2ï¼‰ã€é€šè¿‡Classå®šä½ //[@class=\u0026lsquo;class_name\u0026rsquo;] 3ï¼‰ã€ é€šè¿‡Nameå®šä½ //[@name=\u0026lsquo;name\u0026rsquo;] 2ã€å¦‚æœæ ‡ç­¾æ²¡æœ‰IDã€Classã€Nameä¸‰æ€»å±æ€§ï¼ŒXpathè¿˜æ”¯æŒå±æ€§å®šä½åŠŸèƒ½ @ ä»£è¡¨ä»¥å±æ€§å®šä½ï¼Œåé¢å¯ä»¥æ¥æ ‡ç­¾ä¸­ä»»æ„å±æ€§ //[@other=\u0026lsquo;attribute\u0026rsquo;] 3ã€å½“æ ‡ç­¾çš„å±æ€§é‡å¤æ—¶ï¼ŒXpathæä¾›äº†é€šè¿‡æ ‡ç­¾æ¥è¿›è¡Œè¿‡æ»¤ å°† * æ¢ä½ä»»æ„æ ‡ç­¾åï¼Œåˆ™å¯æ ¹æ®æ ‡ç­¾è¿›è¡Œç­›é€‰ //input[@placeholder=\u0026lsquo;ç”¨æˆ·å\u0026rsquo;] 4ã€å½“æ ‡ç­¾é¡µé‡å¤æ—¶ï¼ŒXpathæä¾›äº†å±‚çº§è¿‡æ»¤ ä¾‹å¦‚ï¼šæ‰¾ä¸åˆ°å„¿å­ï¼Œé‚£ä¹ˆå°±å…ˆæ‰¾ä»–çš„çˆ¸çˆ¸ï¼Œå®åœ¨ä¸è¡Œå¯ä»¥å†æ‰¾ä»–çš„çˆ·çˆ· 1ï¼‰ã€æ”¯æŒé€šè¿‡ / è¿›è¡Œå±‚çº§é€’è¿›ï¼Œæ‰¾åˆ°ç¬¦åˆå±‚çº§å…³ç³»çš„æ ‡ç­¾ //form/div/input[@placeholder=\u0026ldquo;ç”¨æˆ·å\u0026rdquo;] 2ï¼‰ã€å½“å±‚çº§éƒ½é‡å¤æ—¶ï¼Œå¯ä»¥é€šè¿‡å•ä¸ªå±‚çº§çš„å±æ€§è¿›è¡Œå®šä½ //form/div[@class=\u0026lsquo;login-user\u0026rsquo;]/input 5ã€ä¸€ä¸ªå…ƒç´ å®ƒçš„å…„å¼Ÿå…ƒç´ è·Ÿå®ƒçš„æ ‡ç­¾ä¸€æ ·ï¼Œè¿™æ—¶å€™æ— æ³•é€šè¿‡å±‚çº§å®šä½åˆ°ã€‚å› ä¸ºéƒ½æ˜¯ä¸€ä¸ªçˆ¶äº²ç”Ÿçš„ï¼Œå¤šèƒèƒå…„å¼Ÿã€‚Xpathæä¾›äº†ç´¢å¼•è¿‡æ»¤ é€šè¿‡ç´¢å¼•ï¼Œåœ¨Listä¸­å®šä½å±æ€§ï¼Œä¸pythonçš„ç´¢å¼•æœ‰äº›å·®åˆ«ï¼ŒXpathä»1å¼€å§‹ //select[@name=\u0026lsquo;city\u0026rsquo;][1]/option[1] 6ã€ä¸Šé¢å‡ ç§å¦‚æœéƒ½ç”¨ä¸Šäº†ä¹‹åè¿˜é‡å¤çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨Xpathæä¾›çš„ç»ˆæç¥å™¨ï¼Œé€»è¾‘è¿ç®—å®šä½ã€‚and æˆ– orã€€1ï¼‰ã€é€šè¿‡andæ¥ç¼©å°è¿‡æ»¤çš„èŒƒå›´ï¼Œåªæœ‰æ¡ä»¶éƒ½ç¬¦åˆæ—¶æ‰èƒ½å®šä½åˆ° //select[@name=\u0026lsquo;city\u0026rsquo; and @size=\u0026lsquo;4\u0026rsquo; and @multiple=\u0026ldquo;multiple\u0026rdquo;] 2ï¼‰ã€orå°±ç›¸åäº†ï¼Œåªè¦è¿™äº›ç­›é€‰ä¸­ï¼Œå…¶ä¸­ä¸€ä¸ªå‡ºç°é‚£ä¹ˆä¹…åŒ¹é…åˆ°äº† //select[@name=\u0026lsquo;city\u0026rsquo; or @size=\u0026lsquo;4\u0026rsquo;]\n1 2 3 4 5 6 7 dr.find_element_by_xpath(\u0026#34;//*[@id=\u0026#39;kw\u0026#39;]\u0026#34;) dr.find_element_by_xpath(\u0026#34;//*[@name=\u0026#39;wd\u0026#39;]\u0026#34;) dr.find_element_by_xpath(\u0026#34;//input[@class=\u0026#39;s_ipt\u0026#39;]\u0026#34;) dr.find_element_by_xpath(\u0026#34;/html/body/form/span/input\u0026#34;) dr.find_element_by_xpath(\u0026#34;//span[@class=\u0026#39;soutu-btn\u0026#39;]/input\u0026#34;) dr.find_element_by_xpath(\u0026#34;//form[@id=\u0026#39;form\u0026#39;]/span/input\u0026#34;) dr.find_element_by_xpath(\u0026#34;//input[@id=\u0026#39;kw\u0026#39; and @name=\u0026#39;wd\u0026#39;]\u0026#34;) é€šè¿‡csså®šä½ï¼Œcsså®šä½æœ‰å¤šç§å†™æ³•ï¼Œè¿™é‡Œåˆ—å‡ ä¸ªå¸¸ç”¨å†™æ³•: 1 2 3 4 5 6 dr.find_element_by_css_selector(\u0026#34;#kw\u0026#34;) dr.find_element_by_css_selector(\u0026#34;[name=wd]\u0026#34;) dr.find_element_by_css_selector(\u0026#34;.s_ipt\u0026#34;) dr.find_element_by_css_selector(\u0026#34;html \u0026gt; body \u0026gt; form \u0026gt; span \u0026gt; input\u0026#34;) dr.find_element_by_css_selector(\u0026#34;span.soutu-btn\u0026gt; input#kw\u0026#34;) dr.find_element_by_css_selector(\u0026#34;form#form \u0026gt; span \u0026gt; input\u0026#34;) æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬çš„é¡µé¢ä¸Šæœ‰ä¸€ç»„æ–‡æœ¬é“¾æ¥ã€‚\n1 2 \u0026lt;a class=\u0026#34;mnav\u0026#34; href=\u0026#34;http://news.baidu.com\u0026#34; name=\u0026#34;tj_trnews\u0026#34;\u0026gt;æ–°é—»\u0026lt;/a\u0026gt; \u0026lt;a class=\u0026#34;mnav\u0026#34; href=\u0026#34;http://www.hao123.com\u0026#34; name=\u0026#34;tj_trhao123\u0026#34;\u0026gt;hao123\u0026lt;/a\u0026gt; é€šè¿‡link textå®šä½: 1 2 dr.find_element_by_link_text(\u0026#34;æ–°é—»\u0026#34;) dr.find_element_by_link_text(\u0026#34;hao123\u0026#34;) é€šè¿‡link textå®šä½: 1 2 3 dr.find_element_by_partial_link_text(\u0026#34;æ–°\u0026#34;) dr.find_element_by_partial_link_text(\u0026#34;hao\u0026#34;) dr.find_element_by_partial_link_text(\u0026#34;123\u0026#34;) 2.2 æµè§ˆå™¨æ§åˆ¶ æ§åˆ¶æµè§ˆå™¨å¤§å° 1 driver.set_window_size(480, 800) å‰è¿›ï¼Œåé€€ 1 2 driver.forward() driver.back() åˆ·æ–°é¡µé¢ 1 driver.refresh() 2.3 æ¨¡æ‹Ÿç‚¹å‡»å’Œè¾“å…¥ ç‚¹å‡»å’Œè¾“å…¥ å‰é¢æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å®šä½å…ƒç´ ï¼Œ å®šä½åªæ˜¯ç¬¬ä¸€æ­¥ï¼Œ å®šä½ä¹‹åéœ€è¦å¯¹è¿™ä¸ªå…ƒç´ è¿›è¡Œæ“ä½œï¼Œ æˆ–å•å‡»ï¼ˆæŒ‰é’®ï¼‰ æˆ–è¾“å…¥ï¼ˆè¾“å…¥æ¡†ï¼‰ ï¼Œ ä¸‹é¢å°±æ¥è®¤è¯† WebDriver ä¸­æœ€å¸¸ç”¨çš„å‡ ä¸ªæ–¹æ³•ï¼š\nclear()ï¼š æ¸…é™¤æ–‡æœ¬ã€‚\nsend_keys (value)ï¼š æ¨¡æ‹ŸæŒ‰é”®è¾“å…¥ã€‚\nclick()ï¼š å•å‡»å…ƒç´ ã€‚\n1 2 3 4 5 6 7 8 9 10 from selenium import webdriver driver = webdriver.Chrome() driver.get(\u0026#34;https://www.baidu.com\u0026#34;) driver.find_element_by_id(\u0026#34;kw\u0026#34;).clear() driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;selenium\u0026#34;) driver.find_element_by_id(\u0026#34;su\u0026#34;).click() driver.quit() æäº¤ submit()ï¼Œ submit()æ–¹æ³•ç”¨äºæäº¤è¡¨å•ã€‚ ä¾‹å¦‚ï¼Œ åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®å­—ä¹‹åçš„â€œå›è½¦â€ æ“ä½œï¼Œ å°±å¯ä»¥é€šè¿‡è¯¥æ–¹æ³•æ¨¡æ‹Ÿã€‚\n1 2 3 4 5 6 7 8 9 10 from selenium import webdriver driver = webdriver.Chrome() driver.get(\u0026#34;https://www.baidu.com\u0026#34;) search_text = driver.find_element_by_id(\u0026#39;kw\u0026#39;) search_text.send_keys(\u0026#39;selenium\u0026#39;) search_text.submit() driver.quit() æœ‰æ—¶å€™ submit()å¯ä»¥ä¸ click()æ–¹æ³•äº’æ¢æ¥ä½¿ç”¨ï¼Œ submit()åŒæ ·å¯ä»¥æäº¤ä¸€ä¸ªæŒ‰é’®ï¼Œ ä½† submit()çš„åº”ç”¨èŒƒå›´è¿œä¸åŠ click()å¹¿æ³›ã€‚\nå…¶ä»–å¸¸ç”¨æ–¹æ³• sizeï¼š è¿”å›å…ƒç´ çš„å°ºå¯¸ã€‚\ntextï¼š è·å–å…ƒç´ çš„æ–‡æœ¬ã€‚\nget_attribute(name)ï¼š è·å¾—å±æ€§å€¼ã€‚\nis_displayed()ï¼š è®¾ç½®è¯¥å…ƒç´ æ˜¯å¦ç”¨æˆ·å¯è§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 from selenium import webdriver driver = webdriver.Chrome() driver.get(\u0026#34;http://www.baidu.com\u0026#34;) # è·å¾—è¾“å…¥æ¡†çš„å°ºå¯¸ size = driver.find_element_by_id(\u0026#39;kw\u0026#39;).size print(size) # è¿”å›ç™¾åº¦é¡µé¢åº•éƒ¨å¤‡æ¡ˆä¿¡æ¯ text = driver.find_element_by_id(\u0026#34;cp\u0026#34;).text print(text) # è¿”å›å…ƒç´ çš„å±æ€§å€¼ï¼Œ å¯ä»¥æ˜¯ idã€ nameã€ type æˆ–å…¶ä»–ä»»æ„å±æ€§ attribute = driver.find_element_by_id(\u0026#34;kw\u0026#34;).get_attribute(\u0026#39;type\u0026#39;) print(attribute) # è¿”å›å…ƒç´ çš„ç»“æœæ˜¯å¦å¯è§ï¼Œ è¿”å›ç»“æœä¸º True æˆ– False result = driver.find_element_by_id(\u0026#34;kw\u0026#34;).is_displayed() print(result) driver.quit() è¾“å‡ºç»“æœï¼š\n{\u0026lsquo;width\u0026rsquo;: 500, \u0026lsquo;height\u0026rsquo;: 22} Â©2015 Baidu ä½¿ç”¨ç™¾åº¦å‰å¿…è¯» æ„è§åé¦ˆ äº¬ ICP è¯ 030173 å· text True æ‰§è¡Œä¸Šé¢çš„ç¨‹åºå¹¶æŸ¥çœ‹ç»“æœï¼š size æ–¹æ³•ç”¨äºè·å–ç™¾åº¦è¾“å…¥æ¡†çš„å®½ã€ é«˜ï¼Œ text æ–¹æ³•ç”¨äºè·å¾—ç™¾åº¦åº•éƒ¨çš„å¤‡æ¡ˆä¿¡æ¯ï¼Œ get_attribute()ç”¨äºè·å¾—ç™¾åº¦è¾“å…¥çš„ type å±æ€§çš„å€¼ï¼Œ is_displayed()ç”¨äºè¿”å›ä¸€ä¸ªå…ƒç´ æ˜¯å¦å¯è§ï¼Œ å¦‚æœå¯è§åˆ™è¿”å› Trueï¼Œ å¦åˆ™è¿”å› Falseã€‚\n2.4 é¼ æ ‡æ“ä½œ åœ¨ WebDriver ä¸­ï¼Œ å°†è¿™äº›å…³äºé¼ æ ‡æ“ä½œçš„æ–¹æ³•å°è£…åœ¨ ActionChains ç±»æä¾›ã€‚\nActionChains ç±»æä¾›äº†é¼ æ ‡æ“ä½œçš„å¸¸ç”¨æ–¹æ³•ï¼š\nperform()ï¼š æ‰§è¡Œæ‰€æœ‰ ActionChains ä¸­å­˜å‚¨çš„è¡Œä¸ºï¼›\ncontext_click()ï¼š å³å‡»ï¼›\ndouble_click()ï¼š åŒå‡»ï¼›\ndrag_and_drop()ï¼š æ‹–åŠ¨ï¼›\nmove_to_element()ï¼š é¼ æ ‡æ‚¬åœã€‚\né¼ æ ‡æ‚¬åœæ“ä½œ\n1 2 3 4 5 6 7 8 9 10 11 from selenium import webdriver # å¼•å…¥ ActionChains ç±» from selenium.webdriver.common.action_chains import ActionChains driver = webdriver.Chrome() driver.get(\u0026#34;https://www.baidu.cn\u0026#34;) # å®šä½åˆ°è¦æ‚¬åœçš„å…ƒç´  above = driver.find_element_by_link_text(\u0026#34;è®¾ç½®\u0026#34;) # å¯¹å®šä½åˆ°çš„å…ƒç´ æ‰§è¡Œé¼ æ ‡æ‚¬åœæ“ä½œ ActionChains(driver).move_to_element(above).perform() â€¦â€¦\nfrom selenium.webdriver import ActionChains å¯¼å…¥æä¾›é¼ æ ‡æ“ä½œçš„ ActionChains ç±»ã€‚\nActionChains(driver) è°ƒç”¨ ActionChains()ç±»ï¼Œ å°†æµè§ˆå™¨é©±åŠ¨ driver ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚\nmove_to_element(above) context_click()æ–¹æ³•ç”¨äºæ¨¡æ‹Ÿé¼ æ ‡å³é”®æ“ä½œï¼Œ åœ¨è°ƒç”¨æ—¶éœ€è¦æŒ‡å®šå…ƒç´ å®šä½ã€‚\nperform() æ‰§è¡Œæ‰€æœ‰ ActionChains ä¸­å­˜å‚¨çš„è¡Œä¸ºï¼Œ å¯ä»¥ç†è§£æˆæ˜¯å¯¹æ•´ä¸ªæ“ä½œçš„æäº¤åŠ¨ä½œã€‚\n2.5 é”®ç›˜æ“ä½œ Keys()ç±»æä¾›äº†é”®ç›˜ä¸Šå‡ ä¹æ‰€æœ‰æŒ‰é”®çš„æ–¹æ³•ã€‚ å‰é¢äº†è§£åˆ°ï¼Œ send_keys()æ–¹æ³•å¯ä»¥ç”¨æ¥æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥ï¼Œ é™¤æ­¤ ä¹‹å¤–ï¼Œ æˆ‘ä»¬è¿˜å¯ä»¥ç”¨å®ƒæ¥è¾“å…¥é”®ç›˜ä¸Šçš„æŒ‰é”®ï¼Œ ç”šè‡³æ˜¯ç»„åˆé”®ï¼Œ å¦‚ Ctrl+Aã€ Ctrl+C ç­‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 from selenium import webdriver # å¼•å…¥ Keys æ¨¡å— from selenium.webdriver.common.keys import Keys driver = webdriver.Chrome() driver.get(\u0026#34;http://www.baidu.com\u0026#34;) # è¾“å…¥æ¡†è¾“å…¥å†…å®¹ driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;seleniumm\u0026#34;) # åˆ é™¤å¤šè¾“å…¥çš„ä¸€ä¸ª m driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(Keys.BACK_SPACE) # è¾“å…¥ç©ºæ ¼é”®+â€œæ•™ç¨‹â€ driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(Keys.SPACE) driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;æ•™ç¨‹\u0026#34;) # ctrl+a å…¨é€‰è¾“å…¥æ¡†å†…å®¹ driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(Keys.CONTROL, \u0026#39;a\u0026#39;) # ctrl+x å‰ªåˆ‡è¾“å…¥æ¡†å†…å®¹ driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(Keys.CONTROL, \u0026#39;x\u0026#39;) # ctrl+v ç²˜è´´å†…å®¹åˆ°è¾“å…¥æ¡† driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(Keys.CONTROL, \u0026#39;v\u0026#39;) # é€šè¿‡å›è½¦é”®æ¥ä»£æ›¿å•å‡»æ“ä½œ driver.find_element_by_id(\u0026#34;su\u0026#34;).send_keys(Keys.ENTER) driver.quit() éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œ ä¸Šé¢çš„è„šæœ¬æ²¡æœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Œ ä»…å‘æˆ‘ä»¬å±•ç¤ºæ¨¡æ‹Ÿé”®ç›˜å„ç§æŒ‰é”®ä¸ç»„åˆé”®çš„ç”¨æ³•ã€‚\nfrom selenium.webdriver.common.keys import Keys åœ¨ä½¿ç”¨é”®ç›˜æŒ‰é”®æ–¹æ³•å‰éœ€è¦å…ˆå¯¼å…¥ keys ç±»ã€‚\nä»¥ä¸‹ä¸ºå¸¸ç”¨çš„é”®ç›˜æ“ä½œï¼š\nsend_keys(Keys.BACK_SPACE) åˆ é™¤é”®ï¼ˆBackSpaceï¼‰ send_keys(Keys.SPACE) ç©ºæ ¼é”®(Space) send_keys(Keys.TAB) åˆ¶è¡¨é”®(Tab) send_keys(Keys.ESCAPE) å›é€€é”®ï¼ˆEscï¼‰ send_keys(Keys.ENTER) å›è½¦é”®ï¼ˆEnterï¼‰ send_keys(Keys.CONTROL,\u0026lsquo;a\u0026rsquo;) å…¨é€‰ï¼ˆCtrl+Aï¼‰ send_keys(Keys.CONTROL,\u0026lsquo;c\u0026rsquo;) å¤åˆ¶ï¼ˆCtrl+Cï¼‰ send_keys(Keys.CONTROL,\u0026lsquo;x\u0026rsquo;) å‰ªåˆ‡ï¼ˆCtrl+Xï¼‰ send_keys(Keys.CONTROL,\u0026lsquo;v\u0026rsquo;) ç²˜è´´ï¼ˆCtrl+Vï¼‰ send_keys(Keys.F1) é”®ç›˜ F1 send_keys(Keys.F12) é”®ç›˜ F12 3. äº‹ä»¶å¤„ç† 3.1 æ–­è¨€åˆ¤æ–­ ä¸ç®¡æ˜¯åœ¨åšåŠŸèƒ½æµ‹è¯•è¿˜æ˜¯è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæœ€åä¸€æ­¥éœ€è¦æ‹¿å®é™…ç»“æœä¸é¢„æœŸè¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªæ¯”è¾ƒçš„ç§°ä¹‹ä¸ºæ–­è¨€ã€‚\næˆ‘ä»¬é€šå¸¸å¯ä»¥é€šè¿‡è·å–title ã€URLå’Œtextç­‰ä¿¡æ¯è¿›è¡Œæ–­è¨€ã€‚textæ–¹æ³•åœ¨å‰é¢å·²ç»è®²è¿‡ï¼Œå®ƒç”¨äºè·å–æ ‡ç­¾å¯¹ä¹‹é—´çš„æ–‡æœ¬ä¿¡æ¯ã€‚ ä¸‹é¢åŒæ ·ä»¥ç™¾åº¦ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•è·å–è¿™äº›ä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 from selenium import webdriver from time import sleep driver = webdriver.Firefox() driver.get(\u0026#34;https://www.baidu.com\u0026#34;) print(\u0026#39;Before search================\u0026#39;) # æ‰“å°å½“å‰é¡µé¢title title = driver.title print(title) # æ‰“å°å½“å‰é¡µé¢URL now_url = driver.current_url print(now_url) driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;selenium\u0026#34;) driver.find_element_by_id(\u0026#34;su\u0026#34;).click() sleep(1) print(\u0026#39;After search================\u0026#39;) # å†æ¬¡æ‰“å°å½“å‰é¡µé¢title title = driver.title print(title) # æ‰“å°å½“å‰é¡µé¢URL now_url = driver.current_url print(now_url) # è·å–ç»“æœæ•°ç›® user = driver.find_element_by_class_name(\u0026#39;nums\u0026#39;).text print(user) driver.quit() è„šæœ¬è¿è¡Œç»“æœå¦‚ä¸‹ï¼š\nBefore search================ ç™¾åº¦ä¸€ä¸‹ï¼Œä½ å°±çŸ¥é“ https://www.baidu.com/ After search================ selenium_ç™¾åº¦æœç´¢ https://www.baidu.com/s?ie=utf-8\u0026f=8\u0026rsv_bp=0\u0026rsv_idx\u0026hellip; æœç´¢å·¥å…· ç™¾åº¦ä¸ºæ‚¨æ‰¾åˆ°ç›¸å…³ç»“æœçº¦61,100,000ä¸ª titleï¼šç”¨äºè·å¾—å½“å‰é¡µé¢çš„æ ‡é¢˜ã€‚\ncurrent_urlï¼šç”¨æˆ·è·å¾—å½“å‰é¡µé¢çš„URLã€‚\ntextï¼šè·å–æœç´¢æ¡ç›®çš„æ–‡æœ¬ä¿¡æ¯ã€‚\n3.2 å…ƒç´ ç­‰å¾… WebDriveræä¾›äº†ä¸¤ç§ç±»å‹çš„ç­‰å¾…ï¼šæ˜¾å¼ç­‰å¾…å’Œéšå¼ç­‰å¾…ã€‚\næ˜¾å¼ç­‰å¾… æ˜¾å¼ç­‰å¾…ä½¿WebdDriverç­‰å¾…æŸä¸ªæ¡ä»¶æˆç«‹æ—¶ç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™åœ¨è¾¾åˆ°æœ€å¤§æ—¶é•¿æ—¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸ï¼ˆTimeoutExceptionï¼‰ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 from selenium import webdriver from selenium.webdriver.common.by import By from selenium.webdriver.support.ui import WebDriverWait from selenium.webdriver.support import expected_conditions as EC driver = webdriver.Firefox() driver.get(\u0026#34;http://www.baidu.com\u0026#34;) element = WebDriverWait(driver, 5, 0.5).until( EC.presence_of_element_located((By.ID, \u0026#34;kw\u0026#34;)) ) element.send_keys(\u0026#39;selenium\u0026#39;) driver.quit() WebDriverWaitç±»æ˜¯ç”±WebDirver æä¾›çš„ç­‰å¾…æ–¹æ³•ã€‚åœ¨è®¾ç½®æ—¶é—´å†…ï¼Œé»˜è®¤æ¯éš”ä¸€æ®µæ—¶é—´æ£€æµ‹ä¸€æ¬¡å½“å‰é¡µé¢å…ƒç´ æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœè¶…è¿‡è®¾ç½®æ—¶é—´æ£€æµ‹ä¸åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š\nWebDriverWait(driver, timeout, poll_frequency=0.5, ignored_exceptions=None) driver ï¼šæµè§ˆå™¨é©±åŠ¨ã€‚\ntimeout ï¼šæœ€é•¿è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä»¥ç§’ä¸ºå•ä½ã€‚\npoll_frequency ï¼šæ£€æµ‹çš„é—´éš”ï¼ˆæ­¥é•¿ï¼‰æ—¶é—´ï¼Œé»˜è®¤ä¸º0.5Sã€‚\nignored_exceptions ï¼šè¶…æ—¶åçš„å¼‚å¸¸ä¿¡æ¯ï¼Œé»˜è®¤æƒ…å†µä¸‹æŠ›NoSuchElementExceptionå¼‚å¸¸ã€‚\nWebDriverWait()ä¸€èˆ¬ç”±until()æˆ–until_not()æ–¹æ³•é…åˆä½¿ç”¨ï¼Œä¸‹é¢æ˜¯until()å’Œuntil_not()æ–¹æ³•çš„è¯´æ˜ã€‚\nuntil(method, message=â€˜â€™) è°ƒç”¨è¯¥æ–¹æ³•æä¾›çš„é©±åŠ¨ç¨‹åºä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œç›´åˆ°è¿”å›å€¼ä¸ºTrueã€‚\nuntil_not(method, message=â€˜â€™) è°ƒç”¨è¯¥æ–¹æ³•æä¾›çš„é©±åŠ¨ç¨‹åºä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œç›´åˆ°è¿”å›å€¼ä¸ºFalseã€‚\nåœ¨æœ¬ä¾‹ä¸­ï¼Œé€šè¿‡aså…³é”®å­—å°†expected_conditions é‡å‘½åä¸ºECï¼Œå¹¶è°ƒç”¨presence_of_element_located()æ–¹æ³•åˆ¤æ–­å…ƒç´ æ˜¯å¦å­˜åœ¨ã€‚\néšå¼ç­‰å¾… WebDriveræä¾›äº†implicitly_wait()æ–¹æ³•æ¥å®ç°éšå¼ç­‰å¾…ï¼Œé»˜è®¤è®¾ç½®ä¸º0ã€‚å®ƒçš„ç”¨æ³•ç›¸å¯¹æ¥è¯´è¦ç®€å•å¾—å¤šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from selenium import webdriver from selenium.common.exceptions import NoSuchElementException from time import ctime driver = webdriver.Firefox() # è®¾ç½®éšå¼ç­‰å¾…ä¸º10ç§’ driver.implicitly_wait(10) driver.get(\u0026#34;http://www.baidu.com\u0026#34;) try: print(ctime()) driver.find_element_by_id(\u0026#34;kw22\u0026#34;).send_keys(\u0026#39;selenium\u0026#39;) except NoSuchElementException as e: print(e) finally: print(ctime()) driver.quit() implicitly_wait() é»˜è®¤å‚æ•°çš„å•ä½ä¸ºç§’ï¼Œæœ¬ä¾‹ä¸­è®¾ç½®ç­‰å¾…æ—¶é•¿ä¸º10ç§’ã€‚é¦–å…ˆè¿™10ç§’å¹¶éä¸€ä¸ªå›ºå®šçš„ç­‰å¾…æ—¶é—´ï¼Œå®ƒå¹¶ä¸å½±å“è„šæœ¬çš„æ‰§è¡Œé€Ÿåº¦ã€‚å…¶æ¬¡ï¼Œå®ƒå¹¶ä¸é’ˆå¯¹é¡µé¢ä¸Šçš„æŸä¸€å…ƒç´ è¿›è¡Œç­‰å¾…ã€‚å½“è„šæœ¬æ‰§è¡Œåˆ°æŸä¸ªå…ƒç´ å®šä½æ—¶ï¼Œå¦‚æœå…ƒç´ å¯ä»¥å®šä½ï¼Œåˆ™ç»§ç»­æ‰§è¡Œï¼›å¦‚æœå…ƒç´ å®šä½ä¸åˆ°ï¼Œåˆ™å®ƒå°†ä»¥è½®è¯¢çš„æ–¹å¼ä¸æ–­åœ°åˆ¤æ–­å…ƒç´ æ˜¯å¦è¢«å®šä½åˆ°ã€‚å‡è®¾åœ¨ç¬¬6ç§’å®šä½åˆ°äº†å…ƒç´ åˆ™ç»§ç»­æ‰§è¡Œï¼Œè‹¥ç›´åˆ°è¶…å‡ºè®¾ç½®æ—¶é•¿ï¼ˆ10ç§’ï¼‰è¿˜æ²¡æœ‰å®šä½åˆ°å…ƒç´ ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n3.3 å…ƒç´ å®šä½ WebDriverè¿˜æä¾›äº†8ç§ç”¨äºå®šä½ä¸€ç»„å…ƒç´ çš„æ–¹æ³•ã€‚\nfind_elements_by_id() find_elements_by_name() find_elements_by_class_name() find_elements_by_tag_name() find_elements_by_link_text() find_elements_by_partial_link_text() find_elements_by_xpath() find_elements_by_css_selector() å®šä½ä¸€ç»„å…ƒç´ çš„æ–¹æ³•ä¸å®šä½å•ä¸ªå…ƒç´ çš„æ–¹æ³•ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯åœ¨å•è¯elementåé¢å¤šäº†ä¸€ä¸ªsè¡¨ç¤ºå¤æ•°ã€‚\næ¥ä¸‹æ¥é€šè¿‡ä¾‹å­æ¼”ç¤ºå®šä½ä¸€ç»„å…ƒç´ çš„ä½¿ç”¨ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 from selenium import webdriver from time import sleep driver = webdriver.Chrome() driver.get(\u0026#34;https://www.baidu.com\u0026#34;) driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;selenium\u0026#34;) driver.find_element_by_id(\u0026#34;su\u0026#34;).click() sleep(1) # å®šä½ä¸€ç»„å…ƒç´  texts = driver.find_elements_by_xpath(\u0026#39;//div/h3/a\u0026#39;) # å¾ªç¯éå†å‡ºæ¯ä¸€æ¡æœç´¢ç»“æœçš„æ ‡é¢˜ for t in texts: print(t.text) driver.quit() ç¨‹åºè¿è¡Œç»“æœï¼š\nSelenium - Web Browser Automation å®˜ç½‘ åŠŸèƒ½è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·â€”â€”Seleniumç¯‡ selenium + pythonè‡ªåŠ¨åŒ–æµ‹è¯•ç¯å¢ƒæ­å»º - è™«å¸ˆ - åšå®¢å›­ seleniumæ˜¯ä»€ä¹ˆ?_ç™¾åº¦çŸ¥é“ æ€æ ·å¼€å§‹ç”¨seleniumè¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•(ä¸ªäººæ€»ç»“)_ç™¾åº¦ç»éªŒ Selenium_ç™¾åº¦ç™¾ç§‘ selenium_ç™¾åº¦ç¿»è¯‘ Seleniumå®˜ç½‘æ•™ç¨‹_seleniumè‡ªåŠ¨åŒ–æµ‹è¯•å®è·µ_Selenium_é¢†æµ‹è½¯ä»¶æµ‹è¯•ç½‘ Selenium(æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶)_ç™¾åº¦ç™¾ç§‘ è‡ªåŠ¨åŒ–åŸºç¡€æ™®åŠä¹‹seleniumæ˜¯å•¥? - è™«å¸ˆ - åšå®¢å›­ pythonåå¤§ä¸»æµå¼€æºæ¡†æ¶ ã€Œèœé¸Ÿå¿…çœ‹ã€\n3.4 å¤šè¡¨å•åˆ‡æ¢ åœ¨Webåº”ç”¨ä¸­ç»å¸¸ä¼šé‡åˆ°frame/iframeè¡¨å•åµŒå¥—é¡µé¢çš„åº”ç”¨ï¼ŒWebDriveråªèƒ½åœ¨ä¸€ä¸ªé¡µé¢ä¸Šå¯¹å…ƒç´ è¯†åˆ«ä¸å®šä½ï¼Œå¯¹äºframe/iframeè¡¨å•å†…åµŒé¡µé¢ä¸Šçš„å…ƒç´ æ— æ³•ç›´æ¥å®šä½ã€‚è¿™æ—¶å°±éœ€è¦é€šè¿‡switch_to.frame()æ–¹æ³•å°†å½“å‰å®šä½çš„ä¸»ä½“åˆ‡æ¢ä¸ºframe/iframeè¡¨å•çš„å†…åµŒé¡µé¢ä¸­ã€‚\n1 2 3 4 5 6 7 8 \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; ... \u0026lt;iframe id=\u0026#34;x-URS-iframe\u0026#34; ...\u0026gt; \u0026lt;html\u0026gt; \u0026lt;body\u0026gt; ... \u0026lt;input name=\u0026#34;email\u0026#34; \u0026gt; 126é‚®ç®±ç™»å½•æ¡†çš„ç»“æ„å¤§æ¦‚æ˜¯è¿™æ ·å­çš„ï¼Œæƒ³è¦æ“ä½œç™»å½•æ¡†å¿…é¡»è¦å…ˆåˆ‡æ¢åˆ°iframeè¡¨å•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 from selenium import webdriver driver = webdriver.Chrome() driver.get(\u0026#34;http://www.126.com\u0026#34;) driver.switch_to.frame(\u0026#39;x-URS-iframe\u0026#39;) driver.find_element_by_name(\u0026#34;email\u0026#34;).clear() driver.find_element_by_name(\u0026#34;email\u0026#34;).send_keys(\u0026#34;username\u0026#34;) driver.find_element_by_name(\u0026#34;password\u0026#34;).clear() driver.find_element_by_name(\u0026#34;password\u0026#34;).send_keys(\u0026#34;password\u0026#34;) driver.find_element_by_id(\u0026#34;dologin\u0026#34;).click() driver.switch_to.default_content() driver.quit() switch_to.frame() é»˜è®¤å¯ä»¥ç›´æ¥å–è¡¨å•çš„id æˆ–nameå±æ€§ã€‚å¦‚æœiframeæ²¡æœ‰å¯ç”¨çš„idå’Œnameå±æ€§ï¼Œåˆ™å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿›è¡Œå®šä½ã€‚ â€¦â€¦ #å…ˆé€šè¿‡xpthå®šä½åˆ°iframe\n1 xf = driver.find_element_by_xpath(\u0026#39;//*[@id=\u0026#34;x-URS-iframe\u0026#34;]\u0026#39;) #å†å°†å®šä½å¯¹è±¡ä¼ ç»™switch_to.frame()æ–¹æ³•\n1 driver.switch_to.frame(xf) â€¦â€¦\n1 driver.switch_to.parent_frame() é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è¿›å…¥å¤šçº§è¡¨å•çš„æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥é€šè¿‡switch_to.default_content()è·³å›æœ€å¤–å±‚çš„é¡µé¢ã€‚\n3.5 å¤šçª—å£åˆ‡æ¢ åœ¨é¡µé¢æ“ä½œè¿‡ç¨‹ä¸­æœ‰æ—¶å€™ç‚¹å‡»æŸä¸ªé“¾æ¥ä¼šå¼¹å‡ºæ–°çš„çª—å£ï¼Œè¿™æ—¶å°±éœ€è¦ä¸»æœºåˆ‡æ¢åˆ°æ–°æ‰“å¼€çš„çª—å£ä¸Šè¿›è¡Œæ“ä½œã€‚WebDriveræä¾›äº†switch_to.window()æ–¹æ³•ï¼Œå¯ä»¥å®ç°åœ¨ä¸åŒçš„çª—å£ä¹‹é—´åˆ‡æ¢ã€‚ ä»¥ç™¾åº¦é¦–é¡µå’Œç™¾åº¦æ³¨å†Œé¡µä¸ºä¾‹ï¼Œåœ¨ä¸¤ä¸ªçª—å£ä¹‹é—´çš„åˆ‡æ¢å¦‚ä¸‹å›¾ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 from selenium import webdriver import time driver = webdriver.Firefox() driver.implicitly_wait(10) driver.get(\u0026#34;http://www.baidu.com\u0026#34;) # è·å¾—ç™¾åº¦æœç´¢çª—å£å¥æŸ„ sreach_windows = driver.current_window_handle driver.find_element_by_link_text(\u0026#39;ç™»å½•\u0026#39;).click() driver.find_element_by_link_text(\u0026#34;ç«‹å³æ³¨å†Œ\u0026#34;).click() # è·å¾—å½“å‰æ‰€æœ‰æ‰“å¼€çš„çª—å£çš„å¥æŸ„ all_handles = driver.window_handles # è¿›å…¥æ³¨å†Œçª—å£ for handle in all_handles: if handle != sreach_windows: driver.switch_to.window(handle) print(\u0026#39;now register window!\u0026#39;) driver.find_element_by_name(\u0026#34;account\u0026#34;).send_keys(\u0026#39;username\u0026#39;) driver.find_element_by_name(\u0026#39;password\u0026#39;).send_keys(\u0026#39;password\u0026#39;) time.sleep(2) # â€¦â€¦ driver.quit() åœ¨æœ¬ä¾‹ä¸­æ‰€æ¶‰åŠçš„æ–°æ–¹æ³•å¦‚ä¸‹ï¼š\ncurrent_window_handleï¼šè·å¾—å½“å‰çª—å£å¥æŸ„ã€‚ window_handlesï¼šè¿”å›æ‰€æœ‰çª—å£çš„å¥æŸ„åˆ°å½“å‰ä¼šè¯ã€‚ switch_to.window()ï¼šç”¨äºåˆ‡æ¢åˆ°ç›¸åº”çš„çª—å£ï¼Œä¸ä¸Šä¸€èŠ‚çš„switch_to.frame()ç±»ä¼¼ï¼Œå‰è€…ç”¨äºä¸åŒçª—å£çš„åˆ‡æ¢ï¼Œåè€…ç”¨äºä¸åŒè¡¨å•ä¹‹é—´çš„åˆ‡æ¢ã€‚ 3.6 è­¦å‘Šæ¡†å¤„ç† åœ¨WebDriverä¸­å¤„ç†JavaScriptæ‰€ç”Ÿæˆçš„alertã€confirmä»¥åŠpromptååˆ†ç®€å•ï¼Œå…·ä½“åšæ³•æ˜¯ä½¿ç”¨ switch_to.alert æ–¹æ³•å®šä½åˆ° alert/confirm/promptï¼Œç„¶åä½¿ç”¨text/accept/dismiss/ send_keysç­‰æ–¹æ³•è¿›è¡Œæ“ä½œã€‚\ntextï¼šè¿”å› alert/confirm/prompt ä¸­çš„æ–‡å­—ä¿¡æ¯ã€‚ accept()ï¼šæ¥å—ç°æœ‰è­¦å‘Šæ¡†ã€‚ dismiss()ï¼šè§£æ•£ç°æœ‰è­¦å‘Šæ¡†ã€‚ send_keys(keysToSend)ï¼šå‘é€æ–‡æœ¬è‡³è­¦å‘Šæ¡†ã€‚keysToSendï¼šå°†æ–‡æœ¬å‘é€è‡³è­¦å‘Šæ¡†ã€‚ å¦‚ä¸‹å›¾ï¼Œç™¾åº¦æœç´¢è®¾ç½®å¼¹å‡ºçš„çª—å£æ˜¯ä¸èƒ½é€šè¿‡å‰ç«¯å·¥å…·å¯¹å…¶è¿›è¡Œå®šä½çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡switch_to_alert()æ–¹æ³•æ¥å—è¿™ä¸ªå¼¹çª—ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 from selenium import webdriver from selenium.webdriver.common.action_chains import ActionChains import time driver = webdriver.Firefox() driver.implicitly_wait(10) driver.get(\u0026#39;http://www.baidu.com\u0026#39;) # é¼ æ ‡æ‚¬åœè‡³â€œè®¾ç½®â€é“¾æ¥ link = driver.find_element_by_link_text(\u0026#39;è®¾ç½®\u0026#39;) ActionChains(driver).move_to_element(link).perform() # æ‰“å¼€æœç´¢è®¾ç½® driver.find_element_by_link_text(\u0026#34;æœç´¢è®¾ç½®\u0026#34;).click() # ä¿å­˜è®¾ç½® driver.find_element_by_class_name(\u0026#34;prefpanelgo\u0026#34;).click() time.sleep(2) # æ¥å—è­¦å‘Šæ¡† driver.switch_to.alert.accept() driver.quit() é€šè¿‡switch_to_alert()æ–¹æ³•è·å–å½“å‰é¡µé¢ä¸Šçš„è­¦å‘Šæ¡†ï¼Œå¹¶ä½¿ç”¨accept()æ–¹æ³•æ¥å—è­¦å‘Šæ¡†ã€‚\n3.7 è­¦å‘Šæ¡†å¤„ç† åœ¨WebDriverä¸­å¤„ç†JavaScriptæ‰€ç”Ÿæˆçš„alertã€confirmä»¥åŠpromptååˆ†ç®€å•ï¼Œå…·ä½“åšæ³•æ˜¯ä½¿ç”¨ switch_to.alert æ–¹æ³•å®šä½åˆ° alert/confirm/promptï¼Œç„¶åä½¿ç”¨text/accept/dismiss/ send_keysç­‰æ–¹æ³•è¿›è¡Œæ“ä½œã€‚\ntextï¼šè¿”å› alert/confirm/prompt ä¸­çš„æ–‡å­—ä¿¡æ¯ã€‚ accept()ï¼šæ¥å—ç°æœ‰è­¦å‘Šæ¡†ã€‚ dismiss()ï¼šè§£æ•£ç°æœ‰è­¦å‘Šæ¡†ã€‚ send_keys(keysToSend)ï¼šå‘é€æ–‡æœ¬è‡³è­¦å‘Šæ¡†ã€‚keysToSendï¼šå°†æ–‡æœ¬å‘é€è‡³è­¦å‘Šæ¡†ã€‚ å¦‚ä¸‹å›¾ï¼Œç™¾åº¦æœç´¢è®¾ç½®å¼¹å‡ºçš„çª—å£æ˜¯ä¸èƒ½é€šè¿‡å‰ç«¯å·¥å…·å¯¹å…¶è¿›è¡Œå®šä½çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥é€šè¿‡switch_to_alert()æ–¹æ³•æ¥å—è¿™ä¸ªå¼¹çª—ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 from selenium import webdriver from selenium.webdriver.common.action_chains import ActionChains import time driver = webdriver.Firefox() driver.implicitly_wait(10) driver.get(\u0026#39;http://www.baidu.com\u0026#39;) # é¼ æ ‡æ‚¬åœè‡³â€œè®¾ç½®â€é“¾æ¥ link = driver.find_element_by_link_text(\u0026#39;è®¾ç½®\u0026#39;) ActionChains(driver).move_to_element(link).perform() # æ‰“å¼€æœç´¢è®¾ç½® driver.find_element_by_link_text(\u0026#34;æœç´¢è®¾ç½®\u0026#34;).click() # ä¿å­˜è®¾ç½® driver.find_element_by_class_name(\u0026#34;prefpanelgo\u0026#34;).click() time.sleep(2) # æ¥å—è­¦å‘Šæ¡† driver.switch_to.alert.accept() driver.quit() é€šè¿‡switch_to_alert()æ–¹æ³•è·å–å½“å‰é¡µé¢ä¸Šçš„è­¦å‘Šæ¡†ï¼Œå¹¶ä½¿ç”¨accept()æ–¹æ³•æ¥å—è­¦å‘Šæ¡†ã€‚\n3.8 ä¸‹æ‹‰æ¡†é€‰æ‹© æœ‰æ—¶æˆ‘ä»¬ä¼šç¢°åˆ°ä¸‹æ‹‰æ¡†ï¼ŒWebDriveræä¾›äº†Selectç±»æ¥å¤„ç†ä¸‹æ‹‰æ¡†ã€‚ å¦‚ç™¾åº¦æœç´¢è®¾ç½®çš„ä¸‹æ‹‰æ¡†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from selenium import webdriver from selenium.webdriver.support.select import Select from time import sleep driver = webdriver.Chrome() driver.implicitly_wait(10) driver.get(\u0026#39;http://www.baidu.com\u0026#39;) # é¼ æ ‡æ‚¬åœè‡³â€œè®¾ç½®â€é“¾æ¥ driver.find_element_by_link_text(\u0026#39;è®¾ç½®\u0026#39;).click() sleep(1) # æ‰“å¼€æœç´¢è®¾ç½® driver.find_element_by_link_text(\u0026#34;æœç´¢è®¾ç½®\u0026#34;).click() sleep(2) # æœç´¢ç»“æœæ˜¾ç¤ºæ¡æ•° sel = driver.find_element_by_xpath(\u0026#34;//select[@id=\u0026#39;nr\u0026#39;]\u0026#34;) Select(sel).select_by_value(\u0026#39;50\u0026#39;) # æ˜¾ç¤º50æ¡ # â€¦â€¦ driver.quit() Selectç±»ç”¨äºå®šä½selectæ ‡ç­¾ã€‚\nselect_by_value() æ–¹æ³•ç”¨äºå®šä½ä¸‹æ¥é€‰é¡¹ä¸­çš„valueå€¼ã€‚\n4. ç‰¹æ®Šå¤„ç† 4.1 æ–‡ä»¶ä¸Šä¼  å¯¹äºé€šè¿‡inputæ ‡ç­¾å®ç°çš„ä¸Šä¼ åŠŸèƒ½ï¼Œå¯ä»¥å°†å…¶çœ‹ä½œæ˜¯ä¸€ä¸ªè¾“å…¥æ¡†ï¼Œå³é€šè¿‡send_keys()æŒ‡å®šæœ¬åœ°æ–‡ä»¶è·¯å¾„çš„æ–¹å¼å®ç°æ–‡ä»¶ä¸Šä¼ ã€‚\nåˆ›å»ºupfile.htmlæ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;meta http-equiv=\u0026#34;content-type\u0026#34; content=\u0026#34;text/html;charset=utf-8\u0026#34; /\u0026gt; \u0026lt;title\u0026gt;upload_file\u0026lt;/title\u0026gt; \u0026lt;link href=\u0026#34;http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.css\u0026#34; rel=\u0026#34;stylesheet\u0026#34; /\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;div class=\u0026#34;row-fluid\u0026#34;\u0026gt; \u0026lt;div class=\u0026#34;span6 well\u0026#34;\u0026gt; \u0026lt;h3\u0026gt;upload_file\u0026lt;/h3\u0026gt; \u0026lt;input type=\u0026#34;file\u0026#34; name=\u0026#34;file\u0026#34; /\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/div\u0026gt; \u0026lt;/body\u0026gt; \u0026lt;script src=\u0026#34;http://cdn.bootcss.com/bootstrap/3.3.0/css/bootstrap.min.js\u0026#34;\u0026gt;\u0026lt;/scrip\u0026gt; \u0026lt;/html\u0026gt; é€šè¿‡æµè§ˆå™¨æ‰“å¼€upfile.htmlæ–‡ä»¶.\næ¥ä¸‹æ¥é€šè¿‡send_keys()æ–¹æ³•æ¥å®ç°æ–‡ä»¶ä¸Šä¼ ã€‚\n1 2 3 4 5 6 7 8 9 10 11 from selenium import webdriver import os driver = webdriver.Firefox() file_path = \u0026#39;file:///\u0026#39; + os.path.abspath(\u0026#39;upfile.html\u0026#39;) driver.get(file_path) # å®šä½ä¸Šä¼ æŒ‰é’®ï¼Œæ·»åŠ æœ¬åœ°æ–‡ä»¶ driver.find_element_by_name(\u0026#34;file\u0026#34;).send_keys(\u0026#39;D:\\\\upload_file.txt\u0026#39;) driver.quit() 4.2 cookieså¤„ç† æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦éªŒè¯æµè§ˆå™¨ä¸­cookieæ˜¯å¦æ­£ç¡®ï¼Œå› ä¸ºåŸºäºçœŸå®cookieçš„æµ‹è¯•æ˜¯æ— æ³•é€šè¿‡ç™½ç›’å’Œé›†æˆæµ‹è¯•è¿›è¡Œçš„ã€‚WebDriveræä¾›äº†æ“ä½œCookieçš„ç›¸å…³æ–¹æ³•ï¼Œå¯ä»¥è¯»å–ã€æ·»åŠ å’Œåˆ é™¤cookieä¿¡æ¯ã€‚\nWebDriveræ“ä½œcookieçš„æ–¹æ³•ï¼š\nget_cookies()ï¼š è·å¾—æ‰€æœ‰cookieä¿¡æ¯ã€‚ get_cookie(name)ï¼š è¿”å›å­—å…¸çš„keyä¸ºâ€œnameâ€çš„cookieä¿¡æ¯ã€‚ add_cookie(cookie_dict) ï¼š æ·»åŠ cookieã€‚â€œcookie_dictâ€æŒ‡å­—å…¸å¯¹è±¡ï¼Œå¿…é¡»æœ‰name å’Œvalue å€¼ã€‚ delete_cookie(name,optionsString)ï¼šåˆ é™¤cookieä¿¡æ¯ã€‚â€œnameâ€æ˜¯è¦åˆ é™¤çš„cookieçš„åç§°ï¼Œâ€œoptionsStringâ€æ˜¯è¯¥cookieçš„é€‰é¡¹ï¼Œç›®å‰æ”¯æŒçš„é€‰é¡¹åŒ…æ‹¬â€œè·¯å¾„â€ï¼Œâ€œåŸŸâ€ã€‚ delete_all_cookies()ï¼š åˆ é™¤æ‰€æœ‰cookieä¿¡æ¯ã€‚ ä¸‹é¢é€šè¿‡get_cookies()æ¥è·å–å½“å‰æµè§ˆå™¨çš„cookieä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 from selenium import webdriver driver = webdriver.Firefox() driver.get(\u0026#34;http://www.youdao.com\u0026#34;) # è·å¾—cookieä¿¡æ¯ cookie= driver.get_cookies() # å°†è·å¾—cookieçš„ä¿¡æ¯æ‰“å° print(cookie) driver.quit() ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œcookieæ•°æ®æ˜¯ä»¥å­—å…¸çš„å½¢å¼è¿›è¡Œå­˜æ”¾çš„ã€‚çŸ¥é“äº†cookieçš„å­˜æ”¾å½¢å¼ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§è¿™ç§å½¢å¼å‘æµè§ˆå™¨ä¸­å†™å…¥cookieä¿¡æ¯ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 from selenium import webdriver driver = webdriver.Firefox() driver.get(\u0026#34;http://www.youdao.com\u0026#34;) # å‘cookieçš„name å’Œvalueä¸­æ·»åŠ ä¼šè¯ä¿¡æ¯ driver.add_cookie({\u0026#39;name\u0026#39;: \u0026#39;key-aaaaaaa\u0026#39;, \u0026#39;value\u0026#39;: \u0026#39;value-bbbbbb\u0026#39;}) # éå†cookiesä¸­çš„name å’Œvalueä¿¡æ¯å¹¶æ‰“å°ï¼Œå½“ç„¶è¿˜æœ‰ä¸Šé¢æ·»åŠ çš„ä¿¡æ¯ for cookie in driver.get_cookies(): print(\u0026#34;%s -\u0026gt; %s\u0026#34; % (cookie[\u0026#39;name\u0026#39;], cookie[\u0026#39;value\u0026#39;])) driver.quit() è¾“å‡ºç»“æœï¼š\n======================== RESTART: =========================\n1 2 3 4 5 YOUDAO_MOBILE_ACCESS_TYPE -\u0026gt; 1 _PREF_ANONYUSER__MYTH -\u0026gt; aGFzbG9nZ2VkPXRydWU= OUTFOX_SEARCH_USER_ID -\u0026gt; -1046383847@218.17.158.115 JSESSIONID -\u0026gt; abc7qSE_SBGsVgnVLBvcu key-aaaaaaa -\u0026gt; value-bbbbbb ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼Œæœ€åä¸€æ¡cookieä¿¡æ¯æ˜¯åœ¨è„šæœ¬æ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡add_cookie()æ–¹æ³•æ·»åŠ çš„ã€‚é€šè¿‡éå†å¾—åˆ°æ‰€æœ‰çš„cookieä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°keyä¸ºâ€œnameâ€å’Œâ€œvalueâ€çš„ç‰¹å®šcookieçš„valueã€‚\n4.3 jså¤„ç† è™½ç„¶WebDriveræä¾›äº†æ“ä½œæµè§ˆå™¨çš„å‰è¿›å’Œåé€€æ–¹æ³•ï¼Œä½†å¯¹äºæµè§ˆå™¨æ»šåŠ¨æ¡å¹¶æ²¡æœ‰æä¾›ç›¸åº”çš„æ“ä½œæ–¹æ³•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥å€ŸåŠ©JavaScriptæ¥æ§åˆ¶æµè§ˆå™¨çš„æ»šåŠ¨æ¡ã€‚WebDriveræä¾›äº†execute_script()æ–¹æ³•æ¥æ‰§è¡ŒJavaScriptä»£ç ã€‚\nç”¨äºè°ƒæ•´æµè§ˆå™¨æ»šåŠ¨æ¡ä½ç½®çš„JavaScriptä»£ç å¦‚ä¸‹ï¼š\n1 2 \u0026lt;!-- window.scrollTo(å·¦è¾¹è·,ä¸Šè¾¹è·); --\u0026gt; window.scrollTo(0,450); window.scrollTo()æ–¹æ³•ç”¨äºè®¾ç½®æµè§ˆå™¨çª—å£æ»šåŠ¨æ¡çš„æ°´å¹³å’Œå‚ç›´ä½ç½®ã€‚æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºæ°´å¹³çš„å·¦é—´è·ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºå‚ç›´çš„ä¸Šè¾¹è·ã€‚å…¶ä»£ç å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 from selenium import webdriver from time import sleep # è®¿é—®ç™¾åº¦ driver=webdriver.Firefox() driver.get(\u0026#34;http://www.baidu.com\u0026#34;) # è®¾ç½®æµè§ˆå™¨çª—å£å¤§å° driver.set_window_size(500, 500) # æœç´¢ driver.find_element_by_id(\u0026#34;kw\u0026#34;).send_keys(\u0026#34;selenium\u0026#34;) driver.find_element_by_id(\u0026#34;su\u0026#34;).click() sleep(2) # é€šè¿‡javascriptè®¾ç½®æµè§ˆå™¨çª—å£çš„æ»šåŠ¨æ¡ä½ç½® js=\u0026#34;window.scrollTo(100,450);\u0026#34; driver.execute_script(js) sleep(3) driver.quit() é€šè¿‡æµè§ˆå™¨æ‰“å¼€ç™¾åº¦è¿›è¡Œæœç´¢ï¼Œå¹¶ä¸”æå‰é€šè¿‡set_window_size()æ–¹æ³•å°†æµè§ˆå™¨çª—å£è®¾ç½®ä¸ºå›ºå®šå®½é«˜æ˜¾ç¤ºï¼Œç›®çš„æ˜¯è®©çª—å£å‡ºç°æ°´å¹³å’Œå‚ç›´æ»šåŠ¨æ¡ã€‚ç„¶åé€šè¿‡execute_script()æ–¹æ³•æ‰§è¡ŒJavaScriptsä»£ç æ¥ç§»åŠ¨æ»šåŠ¨æ¡çš„ä½ç½®ã€‚\n4.4 çª—å£æˆªå›¾ è‡ªåŠ¨åŒ–ç”¨ä¾‹æ˜¯ç”±ç¨‹åºå»æ‰§è¡Œçš„ï¼Œå› æ­¤æœ‰æ—¶å€™æ‰“å°çš„é”™è¯¯ä¿¡æ¯å¹¶ä¸ååˆ†æ˜ç¡®ã€‚å¦‚æœåœ¨è„šæœ¬æ‰§è¡Œå‡ºé”™çš„æ—¶å€™èƒ½å¯¹å½“å‰çª—å£æˆªå›¾ä¿å­˜ï¼Œé‚£ä¹ˆé€šè¿‡å›¾ç‰‡å°±å¯ä»¥éå¸¸ç›´è§‚åœ°çœ‹å‡ºå‡ºé”™çš„åŸå› ã€‚WebDriveræä¾›äº†æˆªå›¾å‡½æ•°get_screenshot_as_file()æ¥æˆªå–å½“å‰çª—å£ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 from selenium import webdriver from time import sleep driver = webdriver.Firefox() driver.get(\u0026#39;http://www.baidu.com\u0026#39;) driver.find_element_by_id(\u0026#39;kw\u0026#39;).send_keys(\u0026#39;selenium\u0026#39;) driver.find_element_by_id(\u0026#39;su\u0026#39;).click() sleep(2) # æˆªå–å½“å‰çª—å£ï¼Œå¹¶æŒ‡å®šæˆªå›¾å›¾ç‰‡çš„ä¿å­˜ä½ç½® driver.get_screenshot_as_file(\u0026#34;E:\\\\baidu_img.jpg\u0026#34;) driver.quit() è„šæœ¬è¿è¡Œå®Œæˆåæ‰“å¼€Eç›˜ï¼Œå°±å¯ä»¥æ‰¾åˆ°baidu_img.jpgå›¾ç‰‡æ–‡ä»¶äº†ã€‚\n4.5 çª—å£å…³é—­ åœ¨å‰é¢çš„ä¾‹å­ä¸­æˆ‘ä»¬ä¸€ç›´ä½¿ç”¨quit()æ–¹æ³•ï¼Œå…¶å«ä¹‰ä¸ºé€€å‡ºç›¸å…³çš„é©±åŠ¨ç¨‹åºå’Œå…³é—­æ‰€æœ‰çª—å£ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒWebDriverè¿˜æä¾›äº†close()æ–¹æ³•ï¼Œç”¨æ¥å…³é—­å½“å‰çª—å£ã€‚ä¾‹å¤šçª—å£çš„å¤„ç†ï¼Œåœ¨ç”¨ä¾‹æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ‰“å¼€äº†å¤šä¸ªçª—å£ï¼Œæˆ‘ä»¬æƒ³è¦å…³é—­å…¶ä¸­çš„æŸä¸ªçª—å£ï¼Œè¿™æ—¶å°±è¦ç”¨åˆ°close()æ–¹æ³•è¿›è¡Œå…³é—­äº†ã€‚\nclose() å…³é—­å•ä¸ªçª—å£ quit() å…³é—­æ‰€æœ‰çª—å£ ","date":"2020-10-28T11:13:09+08:00","image":"https://chasing1020.github.io/post/selenium-automation/Selenium_hu0bfdc6634d5427fcd584fae72cbf6189_11210_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/selenium-automation/","title":"Selenium Automation"},{"content":"SHUæ¯æ—¥ä¸¤æŠ¥è„šæœ¬ 1. å®ç°åŸç† åˆ©ç”¨pythonä¸­çš„Seleniumåº“ï¼Œå¹¶ç»“åˆæµè§ˆå™¨é©±åŠ¨ï¼Œæ¥è‡ªåŠ¨å®Œæˆæ¯æ—¥ä¸¤æŠ¥çš„æ“ä½œï¼Œæœ€åæµ‹è¯•ç»“æœå°†æ¯å¤©çš„ä½“æ¸©è®¾ç½®åŒºé—´ä¸º36åº¦è‡³37åº¦ä¹‹é—´ï¼ˆå«å°æ•°ç‚¹åä¸€ä½ï¼‰ã€‚åŒæ—¶ï¼Œåœ¨ä½¿ç”¨å‰å¯ä»¥è‡ªå·±é€‰æ‹©ç›¸åº”çš„å¡«æŠ¥æ—¥æœŸï¼Œä¹Ÿå¯ä»¥åœ¨ç‰¹å®šæ—¥æœŸä¹‹å†…å®Œæˆç›¸åº”çš„å¡«æŠ¥æ“ä½œã€‚\n2. ä½¿ç”¨æ•™ç¨‹ 2.1. ä½¿ç”¨æ­¥éª¤ 1ã€é¦–å…ˆï¼Œæ­¤ç¨‹åºåŸºäºpython 3.8.5ç‰ˆæœ¬è¿è¡Œï¼Œä½¿ç”¨çš„æµè§ˆå™¨ä¸ºEdgeï¼Œç‰ˆæœ¬å·86.0.622.51 (Official build) (64-bit)ï¼ŒIDEä¸ºPyCharm 2020.1.3 (Professional Edition) 2ã€æ‰“å¼€å‘½ä»¤è¡Œï¼Œä½¿ç”¨pipæŒ‡ä»¤å®‰è£…selenium pip install selenium 3ã€é€šè¿‡æµè§ˆå™¨å®˜ç½‘ä¸‹è½½ç›¸åº”çš„æµè§ˆå™¨å¯åŠ¨æ’ä»¶ï¼Œå°†å…¶è®¾ç½®ä¸ºç³»ç»Ÿç¯å¢ƒå˜é‡(å¯é€‰)ï¼Œä¹Ÿå¯ä»¥åœ¨ç¨‹åºä¸­è‡ªè¡Œè®¾ç½®æµè§ˆå™¨å¯åŠ¨é©±åŠ¨ä½ç½®ï¼Œå¦‚åœ¨Eç›˜çš„E:\\Edgedriverç›®å½•ï¼Œå°±æ›´æ”¹é»˜è®¤çš„åœ°å€ driverUrl = r\u0026quot;E:\\Edgedriver\\msedgedriver.exe\u0026quot; 4ã€è¿è¡Œç¨‹åºæ—¶ï¼Œè¯·å…³é—­å…¶ä»–ä»»ä½•å¯èƒ½å½±å“æµè§ˆå™¨è¿è¡Œçš„æ’ä»¶æˆ–è€…è½¯ä»¶ï¼Œå¦‚æœç½‘ç»œä¿¡å·ä¸ä½³ï¼Œåˆ™éœ€è¦å°†time.sleep(1)ä¸­çš„æ•°å€¼è°ƒå¤§ï¼Œä»¥ç­‰å¾…ç½‘é¡µçš„å…ƒç´ å½»åº•åŠ è½½æˆåŠŸ\n3. ä»£ç å®ç° 3.1. å‡†å¤‡å·¥ä½œ åœ¨æœ¬ç¨‹åºä¸­ï¼Œæˆ‘ä½¿ç”¨äº†ä¸‰ä¸ªåº“ï¼Œåˆ†åˆ«æ˜¯seleniumï¼ˆä¸»è§’ï¼‰ï¼Œtimeä»¥åŠrandomã€‚ å…¶æ¬¡ï¼Œè®¾ç½®å¥½è‡ªå·±çš„æµè§ˆå™¨é©±åŠ¨ä½ç½®ä»¥åŠæ¯æ—¥ä¸€æŠ¥é“¾æ¥ä½ç½®ï¼Œå¹¶å¡«å†™å¥½è‡ªå·±çš„è´¦å·å¯†ç \n1 2 3 4 5 6 7 myUsername=r\u0026#39;\u0026#39; #åœ¨æ­¤è¾“å…¥ä½ çš„å­¦å· myPassword=r\u0026#39;\u0026#39; #åœ¨æ­¤è¾“å…¥ä½ çš„å§“å baseUrl=r\u0026#39;https://selfreport.shu.edu.cn/\u0026#39; #é»˜è®¤çš„æ¯æ—¥ä¸¤æŠ¥åœ°å€ driverUrl = r\u0026#34;E:\\Edgedriver\\msedgedriver.exe\u0026#34; #æµè§ˆå™¨é©±åŠ¨ï¼Œè¿™é‡Œä»¥Edgeç¤ºä¾‹ï¼Œä¸åŒçš„æµè§ˆå™¨å¯ä»¥å»å®˜ç½‘ä¸‹è½½ from selenium #å®Œæˆwebè‡ªåŠ¨åŒ–çš„ä¸€ç³»åˆ—æ“ä½œ import time #è®¾ç½®ç¨‹åºç­‰å¾…æ—¶é—´ï¼Œç­‰å¾…æµè§ˆå™¨åŠ è½½å…ƒç´ å®Œå…¨ import random #è®¾ç½®æ¸©åº¦éšæœºæ•° 3.2. ç™»å½•è´¦å· å‡†å¤‡å¥½ä»¥ä¸Šæ­¥éª¤ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰“å¼€æµè§ˆå™¨å¹¶å¯¹å…¶è¿›è¡Œç›¸åº”çš„æ“ä½œã€‚\nè¾“å…¥ä»£ç \n1 2 3 4 5 6 7 driver = webdriver.Edge(driverUrl)#é€šè¿‡é©±åŠ¨å™¨æ‰“å¼€æµè§ˆå™¨ driver.get(baseUrl)#è®¿é—®å¥åº·ä¹‹è·¯é“¾æ¥ search_username = driver.find_element_by_id(\u0026#39;username\u0026#39;)#æ‰¾åˆ°ç”¨æˆ·åä½ç½® search_username.send_keys(myUsername)#å¡«å†™ç”¨æˆ·å search_password = driver.find_element_by_id(\u0026#39;password\u0026#39;)#æ‰¾åˆ°å¯†ç ä½ç½® search_password.send_keys(myPassword)#å¡«å†™å¯†ç  driver.find_element_by_id(\u0026#39;submit\u0026#39;).click()#æ‰¾åˆ°å…ƒç´ å¹¶ä¸”è‡ªåŠ¨ç‚¹å‡»ç™»å½• ç¨‹åºæ‰§è¡Œæ—¶ï¼Œå°±ä¼šå°†è‡ªå·±çš„è´¦å·å¯†ç è‡ªåŠ¨å¡«å…¥è¿›å…¥ä¸‹ç« é¡µé¢ã€‚\n3.3. è¿›å…¥æŠ¥é€å†å²ç•Œé¢ å¦‚å›¾ï¼Œéœ€è¦ç‚¹è¿›æŠ¥é€å†å²ï¼š é¦–å…ˆè¾“å…¥\n1 driver.find_element_by_id(\u0026#39;lbReportHistory\u0026#39;).click()#æ‰¾åˆ°å¯¹åº”å†å²æŠ¥é€çš„æŒ‰é’®ï¼Œç‚¹å‡» ç„¶åå³å¯è¿›å…¥å†å²ç•Œé¢ï¼Œåœ¨è¿™é‡Œæ¯å¤©çš„æŠ¥é€è®°å½•ç½—åˆ—å¦‚ä¸‹ï¼š\n3.4. å¡«å†™å¯¹åº”çš„ä¿¡æ¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 # ç‚¹å‡»å¯¹åº”çš„å¤©æ•°ï¼š object = str(date) + item driver.find_element_by_partial_link_text(object).click() # å‹¾é€‰æ‰¿è¯ºé¡¹ï¼š driver.find_element_by_id(\u0026#34;p1_ChengNuo-inputEl-icon\u0026#34;).click() # å¡«å†™ä½“æ¸©ï¼Œéšæœºåœ¨36.0-37.0ä¹‹é—´ search_temperature = driver.find_element_by_id(\u0026#34;p1_TiWen-inputEl\u0026#34;) temperature = str(random.randint(360, 370) / 10) search_temperature.send_keys(temperature) # å‹¾é€‰çŠ¶æ€\u0026#34;è‰¯å¥½\u0026#34; element = driver.find_element_by_id(\u0026#34;fineui_0-inputEl\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) # å½“å¤©éšç”³ç é¢œè‰²ï¼š\u0026#34;ç»¿è‰²\u0026#34; driver.find_element_by_id(\u0026#34;fineui_7-inputEl-icon\u0026#34;).click() element = driver.find_element_by_id(\u0026#39;fineui_7-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) # webdriver.ActionChains(driver).move_to_element(element).click(element).perform() # æ˜å¤©æ˜¯å¦åˆ°é£Ÿå ‚å°±é¤ï¼š\u0026#34;æ—©é¤ï¼Œä¸­é¤ï¼Œæ™šé¤\u0026#34; element = driver.find_element_by_id(\u0026#39;fineui_8-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) element = driver.find_element_by_id(\u0026#39;fineui_9-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) element = driver.find_element_by_id(\u0026#39;fineui_10-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) ä»¥ä¸Šä»£ç å‡æ˜¯å¯¹äºå¡«å†™é¡µé¢å…ƒç´ çš„æ•æ‰ï¼Œå¹¶å¯¹å‘ç°çš„ç¬¬ä¸€ä¸ªå…ƒç´ å‘èµ·æäº¤æŒ‰é’®ã€‚ åœ¨è¿™é‡Œï¼Œç¨‹åºä»£ç ä¸èƒ½å†™æˆå¦‚ä¸‹ï¼š\n1 2 3 4 5 # ä»¥ä¸‹æ“ä½œæ— æ³•å®ç°ï¼ŒåŸå› åº”è¯¥æ˜¯å…ƒç´ å®šä½ç›¸äº’è¦†ç›–ã€‚ # driver.find_element_by_id(\u0026#34;fineui_8-inputEl-icon\u0026#34;).click() # driver.find_element_by_id(\u0026#34;fineui_9-inputEl-icon\u0026#34;).click() # driver.find_element_bu_id(\u0026#34;fineui_10-inputEl-icon\u0026#34;).click() # driver.find_element_by_id(\u0026#34;p1_ctl00_btnSubmit\u0026#34;).click() åŸå› æ˜¯ä»£ç ä¸­çš„å…ƒç´ ç›¸äº’è¦†ç›–ï¼Œæ— æ³•å®ç°æ“ä½œ æœ€ç»ˆé€‰æ‹©å¹¶ç‚¹å‡»æ—¶çš„æ•ˆæœå¦‚ä¸‹ï¼š 3.5. ç‚¹å‡»ç¡®è®¤æŒ‰é’® 1 2 3 4 5 6 7 8 9 10 11 12 # ç‚¹å‡»æäº¤ element = driver.find_element_by_id(\u0026#34;p1_ctl00_btnSubmit\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(1) # ç‚¹å‡»ç¡®è®¤ element = driver.find_element_by_id(\u0026#34;fineui_14\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(3) element = driver.find_element_by_id(\u0026#34;fineui_19\u0026#34;) # element = driver.find_element_by_class_name(\u0026#34;f-btn-text\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(1) åœ¨è¿™é‡Œæˆ‘ä½¿ç”¨äº†time.sleep()å‡½æ•°ï¼Œä¸ºäº†è®©ç¨‹åºåœé¡¿ï¼ŒåŸé¡µé¢åŠ è½½çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå‡ºç°æäº¤æ¡†æ™šå‡ºç°çš„æƒ…å†µï¼Œæ‰€ä»¥éœ€è¦è®©ç¨‹åºâ€œç­‰å¾…â€æµè§ˆå™¨åŠ è½½ç»“æŸï¼Œæœ€åå¡«æŠ¥ã€‚\n4. å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 #-*- coding = utf-8 -*- #@Time : 2020-10-25 15:24 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : release.py #@Software: PyCharm myUsername=r\u0026#39;\u0026#39; #åœ¨æ­¤è¾“å…¥ä½ çš„å­¦å· myPassword=r\u0026#39;\u0026#39; #åœ¨æ­¤è¾“å…¥ä½ çš„å§“å baseUrl=r\u0026#39;https://selfreport.shu.edu.cn/\u0026#39; #é»˜è®¤çš„æ¯æ—¥ä¸¤æŠ¥åœ°å€ driverUrl = r\u0026#34;E:\\Edgedriver\\msedgedriver.exe\u0026#34; #æµè§ˆå™¨é©±åŠ¨ï¼Œè¿™é‡Œä»¥Edgeç¤ºä¾‹ï¼Œä¸åŒçš„æµè§ˆå™¨å¯ä»¥å»ä¸ªå®˜ç½‘ä¸‹è½½ from selenium import time import random def main(): print(\u0026#34;Hello,\u0026#34;) driver = webdriver.Edge(driverUrl) driver.get(baseUrl) search_username = driver.find_element_by_id(\u0026#39;username\u0026#39;) search_username.send_keys(myUsername) search_password = driver.find_element_by_id(\u0026#39;password\u0026#39;) search_password.send_keys(myPassword) driver.find_element_by_id(\u0026#39;submit\u0026#39;).click() for date in range(19,26,1):#åœ¨æ­¤ä¿®æ”¹ä½ æƒ³å®ç°çš„æ—¥æœŸï¼Œå·¦é—­å³å¼€ï¼Œå¦‚è¿™é‡Œä¸º[19,26)ï¼Œå³19è‡³25å· for item in [\u0026#39;æ™¨æŠ¥\u0026#39;,\u0026#39;æ™šæŠ¥\u0026#39;]: # print(\u0026#34;Hello, world!\u0026#34;) # driver = webdriver.Edge(driverUrl) # driver.get(baseUrl) # driver.find_element_by_id(\u0026#39;username\u0026#39;) # search_username = driver.find_element_by_id(\u0026#39;username\u0026#39;) # search_username.send_keys(myUsername) # search_password = driver.find_element_by_id(\u0026#39;password\u0026#39;) # search_password.send_keys(myPassword) # driver.find_element_by_id(\u0026#39;submit\u0026#39;).click() # è¿›å…¥æŠ¥é€å†å²ï¼š driver.find_element_by_id(\u0026#39;lbReportHistory\u0026#39;).click() # ç‚¹å‡»å¯¹åº”çš„å¤©æ•°ï¼š object = str(date) + item driver.find_element_by_partial_link_text(object).click() # å‹¾é€‰æ‰¿è¯ºé¡¹ï¼š driver.find_element_by_id(\u0026#34;p1_ChengNuo-inputEl-icon\u0026#34;).click() # å¡«å†™ä½“æ¸©ï¼Œéšæœºåœ¨36.0-37.0ä¹‹é—´ search_temperature = driver.find_element_by_id(\u0026#34;p1_TiWen-inputEl\u0026#34;) temperature = str(random.randint(360, 370) / 10) search_temperature.send_keys(temperature) # å‹¾é€‰çŠ¶æ€\u0026#34;è‰¯å¥½\u0026#34; element = driver.find_element_by_id(\u0026#34;fineui_0-inputEl\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) # å½“å¤©éšç”³ç é¢œè‰²ï¼š\u0026#34;ç»¿è‰²\u0026#34; driver.find_element_by_id(\u0026#34;fineui_7-inputEl-icon\u0026#34;).click() element = driver.find_element_by_id(\u0026#39;fineui_7-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) # webdriver.ActionChains(driver).move_to_element(element).click(element).perform() # æ˜å¤©æ˜¯å¦åˆ°é£Ÿå ‚å°±é¤ï¼š\u0026#34;æ—©é¤ï¼Œä¸­é¤ï¼Œæ™šé¤\u0026#34; element = driver.find_element_by_id(\u0026#39;fineui_8-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) element = driver.find_element_by_id(\u0026#39;fineui_9-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) element = driver.find_element_by_id(\u0026#39;fineui_10-inputEl-icon\u0026#39;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) # ä»¥ä¸‹æ“ä½œæ— æ³•å®ç°ï¼ŒåŸå› åº”è¯¥æ˜¯å…ƒç´ å®šä½ç›¸äº’è¦†ç›–ã€‚ # driver.find_element_by_id(\u0026#34;fineui_8-inputEl-icon\u0026#34;).click() # driver.find_element_by_id(\u0026#34;fineui_9-inputEl-icon\u0026#34;).click() # driver.find_element_bu_id(\u0026#34;fineui_10-inputEl-icon\u0026#34;).click() # driver.find_element_by_id(\u0026#34;p1_ctl00_btnSubmit\u0026#34;).click() # ç‚¹å‡»æäº¤ element = driver.find_element_by_id(\u0026#34;p1_ctl00_btnSubmit\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(1) # ç‚¹å‡»ç¡®è®¤ element = driver.find_element_by_id(\u0026#34;fineui_14\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(3) element = driver.find_element_by_id(\u0026#34;fineui_19\u0026#34;) # element = driver.find_element_by_class_name(\u0026#34;f-btn-text\u0026#34;) driver.execute_script(\u0026#34;arguments[0].click();\u0026#34;, element) time.sleep(1) driver.quit() print(\u0026#34;world!\u0026#34;) # è¾“å‡ºHello,world! å®Œç¾çš„ç»“æŸ if __name__ == \u0026#34;__main__\u0026#34;: #å½“ç¨‹åºæ‰§è¡Œæ—¶ main() #å¼€å§‹ ","date":"2020-10-28T11:13:09+08:00","image":"https://chasing1020.github.io/post/shu-autoselfreport/shu_hudc6175de4ec7661f0f0fe77ea48c96d2_127794_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/shu-autoselfreport/","title":"SHU AutoSelfReport"},{"content":"åˆ›å»ºæ•°ç»„å¯¹è±¡ ä¸€ç»´æ•°ç»„ 1 2 3 name=np.array([\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;]) print(name.ndim)#ç»´æ•° print(name.size)#å¤§å° äºŒç»´æ•°ç»„ åˆ›å»º 1 2 import numpy as np name=np.array([[\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;],[\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;],[\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;],[\u0026#39;1\u0026#39;,\u0026#39;2\u0026#39;,\u0026#39;3\u0026#39;,\u0026#39;4\u0026#39;,\u0026#39;5\u0026#39;,\u0026#39;6\u0026#39;]]) æŸ¥çœ‹å±æ€§ 1 2 3 4 print(name.ndim)#ç»´æ•°ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯çŸ©é˜µçš„ç§© print(name.size)#å¤§å° print(name.shape)#è¡Œæ•°å’Œåˆ—æ•° print(name.dtype)#æŸ¥çœ‹æ•°æ®ç±»å‹ è®¿é—®ä¸‹æ ‡ 1 2 print(name[2])#ç´¢å¼•ä¸º[0,n-1] print(name[-3])#ç´¢å¼•ä¸º[-n,-1]ï¼Œè¡¨ç¤ºå€’æ•° åˆ‡ç‰‡(slicing) 1 2 3 4 for i in name[[1,2],[2,4]]:#è¡¨ç¤ºä¸‹æ ‡1ï¼Œ2å’Œä¸‹æ ‡2ï¼Œ4#å¦‚æœä½¿ç”¨:ï¼Œåˆ™è¡¨ç¤ºæ‰€æœ‰çš„è¡Œå’Œåˆ— print(i) for i in name[1:2,2:4]:#è¡¨ç¤ºä¸‹æ ‡1ï¼Œ2å’Œä¸‹æ ‡2ï¼Œ4#å¦‚æœä½¿ç”¨:ï¼Œåˆ™è¡¨ç¤ºæ‰€æœ‰çš„è¡Œå’Œåˆ— print(i) æ¡ä»¶ç­›é€‰ 1 print(name[(name==1)|(name==2)]) åˆ›å»ºå¤šç»´æ•°ç»„ 1 2 3 4 a=np.arange(1,10,1)#ç”Ÿæˆ1-9ä¹‹é—´çš„è¿ç»­çš„æ•°ç»„ a=np.arange(0,15).reshape(3,5)#å°†ä¸€ç»´æ•°ç»„è½¬ä¸ºäºŒç»´æ•°ç»„ a=np.zeros((3,4))#ç”Ÿæˆ3*4çš„ä¸º0çš„æ•°ç»„ a=np.ones((4,3))#ç”Ÿæˆ4*3çš„ä¸º1çš„æ•°ç»„ å¤šç»´æ•°ç»„è¿ç®— 1 2 3 a=np.ones((4,3)) a=a*5#ç”Ÿæˆå…¨éƒ¨ä¸º5çš„æ•°ç»„ a=a+3#ç”Ÿæˆå…¨éƒ¨ä¸º4çš„æ•°ç»„ å¸¸ç”¨å‡½æ•°ã€å±æ€§ å‡½æ•° å‡½æ•° ä½œç”¨ np.array(åˆ—è¡¨) é€šè¿‡åˆ—è¡¨åˆ›å»ºä¸€ä¸ªæ•°ç»„å¯¹è±¡ np.arange(èµ·å§‹, ç»“æŸ, æ­¥é•¿) åˆ›å»ºä¸€ä¸ªç­‰å·®æ•°ç»„(æ³¨æ„åŒºé—´æ˜¯å·¦é—­å³å¼€çš„) np.zeros( (m, n) ) åˆ›å»ºä¸€ä¸ªmè¡Œnåˆ—çš„å…¨é›¶æ•°ç»„ np.ones( (m, n) ) åˆ›å»ºä¸€ä¸ªmè¡Œnåˆ—çš„å…¨ä¸€æ•°ç»„ np.eye(m) åˆ›å»ºä¸€ä¸ªmé˜¶å•ä½æ–¹é˜µ å¸¸ç”¨å¯¹è±¡å±æ€§ å±æ€§ ä½œç”¨ my_array.ndim ç»´æ•° my_array.size å¤§å° my_array.shape ä»¥å…ƒç»„å½¢å¼è¿”å›my_arrayçš„(è¡Œ, åˆ—) my_array.dtype è¿”å›my_arrayä¸­å…ƒç´ çš„æ•°æ®ç±»å‹ *æ³¨æ„åº“å‡½æ•°å’Œå¯¹è±¡å±æ€§çš„ä¸åŒï¼Œè¡¨ä¸€ä¸­np.æ˜¯å›ºå®šçš„ï¼ŒæŒ‡çš„æ˜¯numpyåº“ï¼›è€Œè¡¨äºŒä¸­my_array.xxx()ä¸­çš„my_arrayè¦æ”¹æˆä½ å¯¹åº”çš„æ•°ç»„çš„åå­—ï¼ˆå³å®ä¾‹åï¼‰ã€‚ ## åˆ‡ç‰‡ åˆ‡ç‰‡ æˆ‘ä»¬å°†é€‰å‡ºä¸€ä¸ªæ•°ç»„çš„æŸä¸€è¡Œã€æŸä¸€åˆ—æˆ–è€…æŸä¸€ä¸ªä½ç½®ä¸Šçš„å…ƒç´ çš„æ“ä½œæˆä¸ºâ€œåˆ‡ç‰‡â€ æˆ‘ä»¬å…ˆæ¥è®¨è®ºäºŒç»´æ•°ç»„çš„åˆ‡ç‰‡: æœ€åŸºæœ¬çš„æ ¼å¼æ˜¯ï¼šmy_array[m, n]ï¼Œå…¶ä¸­må’Œnå¯ä»¥ä¸ºæ•´æ•° åˆ—è¡¨ è¿˜å¯ä»¥æ˜¯å†’å·: å½“må’Œnæ˜¯æ•´æ•°æ—¶ï¼Œè¡¨ç¤ºé€‰å–mè¡Œnåˆ—çš„é‚£ä¸ªæ•°ã€‚ å½“må’Œnå…¶ä¸­ä¸€ä¸ªæ˜¯å†’å·çš„æ—¶å€™ï¼Œè¡¨æ˜é€‰ä¸­å¯¹åº”çš„æ‰€æœ‰è¡Œæˆ–åˆ—ã€‚ä¾‹å¦‚my_array[ :, n]è¡¨ç¤ºé€‰æ‹©æ•´ä¸ªç¬¬nåˆ—\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 arr = np.arange(1,10).reshape(3,3) print(\u0026#39;åˆ‡ç‰‡å‰ï¼š\u0026#39;) print(arr) m = [0,1] n = [1,2] print(\u0026#39;åˆ‡ç‰‡åï¼š\u0026#39;) print(arr[m, n]) \u0026#39;\u0026#39;\u0026#39; åˆ‡ç‰‡å‰ï¼š [[1 2 3] [4 5 6] [7 8 9]] åˆ‡ç‰‡åï¼š [2 6] \u0026#39;\u0026#39;\u0026#39; é€šç”¨å‡½æ•°func å¸¸ç”¨çš„ä¸€å…ƒå‡½æ•° å‡½æ•° æè¿° absã€fabs è®¡ç®—æ•´æ•°ã€æµ®ç‚¹æ•°ã€å¤æ•°çš„ç»å¯¹å€¼ sqrt è®¡ç®—å¹³æ–¹æ ¹ square è®¡ç®—å¹³æ–¹ exp è®¡ç®—æŒ‡æ•° logã€log10 è®¡ç®—è‡ªç„¶å¯¹æ•°ã€åº•æ•°ä¸º10çš„log sign è®¡ç®—æ­£è´Ÿå· ceilã€floor å¤©èŠ±æ¿ã€åœ°æ¿å‡½æ•° sinã€cosã€cosh\u0026hellip; ä¸‰è§’å‡½æ•° å¸¸ç”¨çš„äºŒå…ƒå‡½æ•° å‡½æ•° æè¿° add å°†å¯¹åº”çš„å…ƒç´ ç›¸åŠ  subtract ä»ç¬¬ä¸€ä¸ªæ•°ç»„ä¸­å‡å»ç¬¬äºŒä¸ªæ•°ç»„çš„å…ƒç´  multiply æ•°ç»„å…ƒç´ ç›¸ä¹˜ divide æ•°ç»„å…ƒç´ ç›¸é™¤ power è®¡ç®—å¹‚æ¬¡ mod è®¡ç®—æ¨¡ copysign å°†ç¬¬äºŒä¸ªæ•°ç»„çš„ç¬¦å·èµ‹å€¼ç»™ç¬¬ä¸€ä¸ªæ•°ç»„ equalã€not_equal æ‰§è¡Œå…ƒç´ æ¯”è¾ƒï¼Œè¿”å›å¸ƒå°”ç±»å‹çš„æ•°ç»„ èšé›†å‡½æ•° å‡½æ•° æè¿° sum æ±‚å’Œ mean ç®—æ•°å¹³å‡å€¼ minã€max æœ€å¤§å€¼å’Œæœ€å°å€¼ argminã€argmax æœ€å¤§å€¼å’Œæœ€å°å€¼çš„ç´¢å¼• cumsum ä»0å¼€å§‹ç´¯åŠ  cumprod ä»1å¼€å§‹ç´¯ä¹˜ éšæœºæ•°ç»„ç”Ÿæˆå‡½æ•° å‡½æ•° æè¿° random éšæœºäº§ç”Ÿ[0,1) randint éšæœºç”Ÿæˆç»™å®šèŒƒå›´å†…çš„ä¸€ç»„æ•´æ•° uniform éšæœºç”Ÿæˆç»™å®šèŒƒå›´å†…æœä»å‡åŒ€åˆ†å¸ƒçš„ä¸€ç»„æµ®ç‚¹æ•° choice åœ¨ç»™å®šçš„èŒƒå›´å†…éšæœºé€‰æ‹©å…ƒç´  normal éšæœºç”Ÿæˆä¸€ç»„æœä»ç»™å®šå‡å€¼å’Œæ–¹å·®æ­£æ€åˆ†å¸ƒçš„éšæœºæ•° ## è¯¾åä½œä¸š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 #P21 import numpy as np names = np.array([\u0026#39;ç‹å¾®\u0026#39;,\u0026#39;è‚–è‰¯è‹±\u0026#39;,\u0026#34;æ–¹ç»®é›¯\u0026#34;,\u0026#39;åˆ˜æ—­é˜³\u0026#39;,\u0026#39;é’±æ˜“é“­\u0026#39;]) subjects = np.array([\u0026#39;Math\u0026#39;, \u0026#39;English\u0026#39;, \u0026#39;Python\u0026#39;, \u0026#39;Chinese\u0026#39;, \u0026#39;Art\u0026#39;, \u0026#39;Database\u0026#39;, \u0026#39;Physics\u0026#39;]) scores = np.array([[70,85,77,90,82,84,89],[60,64,80,75,80,92,90],[90,93,88,87,86,90,91],[80,82,91,88,83,86,80],[88,72,78,90,91,73,80]]) #1. #(1) print(subjects[[1,2,4]]) print(names[-3]) #(2) print(names[2:]) print(subjects[2:5]) #(3) print(subjects[(subjects == \u0026#39;English\u0026#39;) | (subjects == \u0026#39;Physics\u0026#39;)]) #2. #(1) print(scores[[1,4],:]) #(2) print(scores[[2,4]][:,(subjects == \u0026#39;Python\u0026#39;)|(subjects == \u0026#39;Math\u0026#39;)]) #(3) print(scores[:,(subjects == \u0026#39;English\u0026#39;) | (subjects == \u0026#39;Art\u0026#39;)]) #(4) print(scores[(names==\u0026#39;ç‹å¾®\u0026#39;)|(names==\u0026#39;åˆ˜æ—­é˜³\u0026#39;),(subjects==\u0026#39;English\u0026#39;)|(subjects==\u0026#39;Math\u0026#39;)]) #3. a=np.arange(10,20).reshape(2,5) print(a) \u0026#39;\u0026#39;\u0026#39; 1. ä¸€ç»´æ•°ç»„è®¿é—®ã€‚ 1) åœ¨ subjects æ•°ç»„ä¸­é€‰æ‹©å¹¶æ˜¾ç¤ºåºå· 1ã€ 2ã€ 4 é—¨è¯¾çš„åç§°ï¼Œä½¿ç”¨å€’åºç´¢å¼•é€‰æ‹©å¹¶æ˜¾ç¤º names æ•°ç»„ä¸­â€œæ–¹ç»®é›¯â€œã€‚ [\u0026#39;English\u0026#39; \u0026#39;Python\u0026#39; \u0026#39;Art\u0026#39;] æ–¹ç»®é›¯ 2) é€‰æ‹©å¹¶æ˜¾ç¤º names æ•°ç»„ä» 2 åˆ°æœ€åçš„æ•°ç»„å…ƒç´ ï¼›é€‰æ‹©å¹¶æ˜¾ç¤º subjects æ•°ç»„æ­£åº 2~4 çš„æ•°ç»„å…ƒç´ ã€‚ [\u0026#39;æ–¹ç»®é›¯\u0026#39; \u0026#39;åˆ˜æ—­é˜³\u0026#39; \u0026#39;é’±æ˜“é“­\u0026#39;] [\u0026#39;Python\u0026#39; \u0026#39;Chinese\u0026#39; \u0026#39;Art\u0026#39;] 3) ä½¿ç”¨å¸ƒå°”æ¡ä»¶é€‰æ‹©å¹¶æ˜¾ç¤º subjects æ•°ç»„ä¸­çš„è‹±è¯­å’Œç‰©ç†ç§‘ç›®åç§°ã€‚ [\u0026#39;English\u0026#39; \u0026#39;Physics\u0026#39;] 2. äºŒç»´æ•°ç»„è®¿é—®ã€‚ l) é€‰æ‹©å¹¶æ˜¾ç¤º scores æ•°ç»„çš„ 1ã€ 4 è¡Œã€‚ [[60 64 80 75 80 92 90] [88 72 78 90 91 73 80]] 2) é€‰æ‹©å¹¶æ˜¾ç¤º scores æ•°ç»„ä¸­è¡Œåº 2ã€ 4 å­¦ç”Ÿçš„æ•°å­¦å’Œ Python æˆç»© [[90 88] [88 78]] 3) é€‰æ‹©å¹¶æ˜¾ç¤º scores æ•°ç»„ä¸­æ‰€æœ‰å­¦ç”Ÿçš„æ•°å­¦å’Œè‰ºæœ¯è¯¾ç¨‹æˆç»©ã€‚ [[85 82] [64 80] [93 86] [82 83] [72 91]] 4) é€‰æ‹©å¹¶æ˜¾ç¤º scores æ•°ç»„ä¸­â€œç‹å¾®â€å’Œâ€œåˆ˜æ—­é˜³â€çš„è‹±è¯­å’Œè‰ºæœ¯è¯¾ç¨‹æˆç»©ã€‚ [[85 82] [82 83]] 3. ç”Ÿæˆç”±æ•´æ•° 10~19 ç»„æˆçš„ 2x5 çš„äºŒç»´æ•°ç»„ã€‚ [[10 11 12 13 14] [15 16 17 18 19]] \u0026#39;\u0026#39;\u0026#39; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 # æ•°æ®å‡†å¤‡ #P26 import numpy as np names = np.array([\u0026#39;ç‹å¾®\u0026#39;,\u0026#39;è‚–è‰¯è‹±\u0026#39;,\u0026#34;æ–¹ç»®é›¯\u0026#34;,\u0026#39;åˆ˜æ—­é˜³\u0026#39;,\u0026#39;é’±æ˜“é“­\u0026#39;]) subjects = np.array([\u0026#39;Math\u0026#39;, \u0026#39;English\u0026#39;, \u0026#39;Python\u0026#39;, \u0026#39;Chinese\u0026#39;, \u0026#39;Art\u0026#39;, \u0026#39;Database\u0026#39;, \u0026#39;Physics\u0026#39;]) scores = np.array([[70,85,77,90,82,84,89],[60,64,80,75,80,92,90],[90,93,88,87,86,90,91],[80,82,91,88,83,86,80],[88,72,78,90,91,73,80]]) # ç¬¬ä¸€é¢˜ print(\u0026#39;1. å°† scores æ•°ç»„ä¸­æ‰€æœ‰å­¦ç”Ÿçš„è‹±è¯­æˆç»©å‡å» 3 åˆ†å¹¶æ˜¾ç¤ºã€‚ \u0026#39;) print(scores[:, subjects == \u0026#39;Art\u0026#39;] -3) # ç¬¬äºŒé¢˜ print(\u0026#39;\\n2. ç»Ÿè®¡ scores æ•°ç»„ä¸­æ¯åå­¦ç”Ÿæ‰€æœ‰ç§‘ç›®çš„å¹³å‡åˆ†å¹¶æ˜¾ç¤ºã€‚ \u0026#39;) for i in range(0,5) : print(scores[i].mean()) # ç¬¬ä¸‰é¢˜ print(\u0026#39;\\n3. ä½¿ç”¨éšæœºå‡½æ•°ç”Ÿæˆ[-1,1]ä¹‹é—´æœä»å‡åŒ€åˆ†å¸ƒçš„ 3x4 äºŒç»´æ•°ç»„ï¼Œå¹¶è®¡ç®—æ‰€æœ‰å…ƒç´ çš„å’Œã€‚\u0026#39;) uni = np.random.uniform(-1,1,(3,4)) print(uni) print(uni.sum()) \u0026#39;\u0026#39;\u0026#39; 1. å°† scores æ•°ç»„ä¸­æ‰€æœ‰å­¦ç”Ÿçš„è‹±è¯­æˆç»©å‡å» 3 åˆ†å¹¶æ˜¾ç¤ºã€‚ [[79] [77] [83] [80] [88]] 2. ç»Ÿè®¡ scores æ•°ç»„ä¸­æ¯åå­¦ç”Ÿæ‰€æœ‰ç§‘ç›®çš„å¹³å‡åˆ†å¹¶æ˜¾ç¤ºã€‚ 82.42857142857143 77.28571428571429 89.28571428571429 84.28571428571429 81.71428571428571 3. ä½¿ç”¨éšæœºå‡½æ•°ç”Ÿæˆ[-1,1]ä¹‹é—´æœä»å‡åŒ€åˆ†å¸ƒçš„ 3x4 äºŒç»´æ•°ç»„ï¼Œå¹¶è®¡ç®—æ‰€æœ‰å…ƒç´ çš„å’Œã€‚ [[-0.5434021 -0.0569449 -0.10984966 -0.90260813] [-0.01882247 -0.46660599 0.52140256 0.42474122] [ 0.3122958 -0.06197657 -0.26717631 -0.08292239]] -1.2518689400759253 \u0026#39;\u0026#39;\u0026#39; 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 #P29 #ä¸€ã€ import numpy as np # 1.åˆ›å»ºä¸¤ä¸ªä¸€ç»´æ•°ç»„åˆ†åˆ«å­˜å‚¨è¶…å¸‚åç§°å’Œæ°´æœåç§°ã€‚ shops = np.array([\u0026#39;DaRunFa\u0026#39;,\u0026#39;Walmart\u0026#39;,\u0026#39;HaoDe\u0026#39;,\u0026#39;NongGongShang\u0026#39;]) fruits = np.array([\u0026#39;apple\u0026#39;,\u0026#39;banana\u0026#39;,\u0026#39;orange\u0026#39;,\u0026#39;mango\u0026#39;]) # 2.åˆ›å»ºä¸€ä¸ª 4x4 çš„äºŒç»´æ•°ç»„å­˜å‚¨ä¸åŒè¶…å¸‚çš„æ°´æœä»·æ ¼ï¼Œå…¶ä¸­ä»·æ ¼ç”± 4~10 èŒƒå›´å†…çš„éšæœºæ•°ç”Ÿæˆã€‚ prices = np.random.randint(4,10,16).reshape(4,4) # 3.é€‰æ‹©â€œå¤§æ¶¦å‘â€çš„è‹¹æœå’Œâ€œå¥½å¾·â€çš„é¦™è•‰ï¼Œå¹¶å°†ä»·æ ¼å¢åŠ  1 å…ƒã€‚ prices[shops == \u0026#39;DaRunFa\u0026#39;,fruits == \u0026#39;apple\u0026#39;] += 1 print(\u0026#39;the price of apple in DaRunFa now: %d\u0026#39; %prices[shops == \u0026#39;DaRunFa\u0026#39;,fruits == \u0026#39;apple\u0026#39;]) prices[shops == \u0026#39;HaoDe\u0026#39;,fruits == \u0026#39;banana\u0026#39;] += 1 print(\u0026#39;the price of banana in HaoDe now: %d\u0026#39; %prices[shops == \u0026#39;HaoDe\u0026#39;,fruits == \u0026#39;banana\u0026#39;]) # 4.â€œå†œå·¥å•†â€æ°´æœå¤§å‡ä»·ï¼Œæ‰€æœ‰æ°´æœä»·æ ¼å‡ 2 å…ƒã€‚ prices[shops == \u0026#39;NongGongShang\u0026#39;] -= 2 print(\u0026#39;the price in NongGongShang now: \u0026#39;,end=\u0026#39;\u0026#39;) print(prices[shops == \u0026#39;NongGongShang\u0026#39;]) # 5.ç»Ÿè®¡å››ä¸ªè¶…å¸‚è‹¹æœå’ŒèŠ’æœçš„é”€å”®å‡ä»·ã€‚ print(\u0026#39;ave of apple is: %f\u0026#39;%prices[: , fruits == \u0026#39;apple\u0026#39;].mean()) print(\u0026#39;ave of mango is: %f\u0026#39;%prices[: , fruits == \u0026#39;mango\u0026#39;].mean()) # 6.æ‰¾å‡ºæ©˜å­ä»·æ ¼æœ€è´µçš„è¶…å¸‚åç§°ï¼ˆä¸æ˜¯ç¼–å·ï¼‰ã€‚ t = 0 for i in range(0,4) : if prices[i, 2] \u0026gt; prices[t, 2] : t = i print(\u0026#39;the most expensive orange is in %s\u0026#39;%shops[t]) \u0026#39;\u0026#39;\u0026#39; the price of apple in DaRunFa now: 7 the price of banana in HaoDe now: 5 the price in NongGongShang now: [[6 7 4 6]] ave of apple is: 6.750000 ave of mango is: 6.750000 the most expensive orange is in Walmart \u0026#39;\u0026#39;\u0026#39; #äºŒã€ import numpy as np steps = 10 rndwlk = np.random.normal(0, 1, size = (3, steps)) print(\u0026#39;1ï¼‰ç§»åŠ¨è·ç¦»æ•°ç»„ï¼š\u0026#39;) print(rndwlk) position = rndwlk.cumsum(axis = 1) x = position[0] y = position[1] z = position[2] print(\u0026#39;\\n2ï¼‰æ¯æ­¥èµ°å®Œååœ¨ä¸‰ç»´çš„ç©ºé—´ä½ç½®ï¼š\u0026#39;) print(position) dists = np.sqrt(position[0]**2 + position[1]**2 + position[2]**2) #ä¸‰ç»´ç›´è§’åæ ‡ç³»çš„è·ç¦»å…¬å¼ np.set_printoptions(precision=2) print(\u0026#39;\\n3ï¼‰æ¯æ­¥èµ°å®Œååˆ°åŸç‚¹çš„è·ç¦»ï¼š\u0026#39;) print(dists) print(\u0026#39;\\n4ï¼‰Zè½´åˆ°è¾¾çš„æœ€è¿œè·ç¦»ï¼š%f\u0026#39;%abs(position[2]).max()) print(\u0026#39;\\n5ï¼‰ç‰©ä½“åœ¨ä¸‰ç»´ç©ºé—´è·ç¦»åŸç‚¹çš„æœ€è¿‘å€¼ï¼š%f\u0026#39;%dists.min()) \u0026#39;\u0026#39;\u0026#39; 1ï¼‰ç§»åŠ¨è·ç¦»æ•°ç»„ï¼š [[ 0.09 0.52 -0.96 -0.96 -1.44 1.27 -0.61 -1.18 2.23 0.45] [-0.66 -2.22 -0.39 -0.25 0.36 -0.29 0.04 0.12 1.43 0.34] [ 0.56 0.56 0.96 0.33 2.15 1.56 -1.09 -2.05 -0.1 -0.48]] 2ï¼‰æ¯æ­¥èµ°å®Œååœ¨ä¸‰ç»´çš„ç©ºé—´ä½ç½®ï¼š [[ 0.09 0.62 -0.34 -1.3 -2.74 -1.47 -2.08 -3.26 -1.03 -0.57] [-0.66 -2.87 -3.26 -3.51 -3.16 -3.44 -3.4 -3.29 -1.86 -1.51] [ 0.56 1.11 2.07 2.4 4.55 6.12 5.02 2.97 2.87 2.39]] 3ï¼‰æ¯æ­¥èµ°å®Œååˆ°åŸç‚¹çš„è·ç¦»ï¼š [0.87 3.14 3.88 4.45 6.18 7.17 6.42 5.5 3.57 2.89] 4ï¼‰Zè½´åˆ°è¾¾çš„æœ€è¿œè·ç¦»ï¼š6.116005 5ï¼‰ç‰©ä½“åœ¨ä¸‰ç»´ç©ºé—´è·ç¦»åŸç‚¹çš„æœ€è¿‘å€¼ï¼š0.867622 \u0026#39;\u0026#39;\u0026#39; æ•°æ®æ±‡æ€»ä¸ç»Ÿè®¡ 1 2 3 import pandas as pd import numpy as np from pandas import Series,DataFrame #ä½¿ç”¨pd. serieså¯¹è±¡ é€šè¿‡ä¸‹æ ‡è®¿é—® 1 2 3 4 5 6 7 8 9 #series([data,index,index,...]) import pandas as pd import numpy as np from pandas import Series,DataFrame height1=Series({\u0026#39;13\u0026#39; :187, \u0026#39;14\u0026#39; :190, \u0026#39;17\u0026#39;:185, \u0026#39;2\u0026#39;:178, \u0026#39;9\u0026#39;:185}) print(height1[\u0026#39;13\u0026#39;])#æ£€ç´¢13å·çš„èº«é«˜ print(height1[1:3])#æ£€ç´¢1ã€2å·çš„èº«é«˜ print(height1.values\u0026gt;=186)#æ£€ç´¢å¤§äº186çš„çƒå‘˜ print(height1)#æ‰“å°æ‰€æœ‰èº«é«˜ é€šè¿‡appendæ·»åŠ æˆå‘˜ 1 2 3 4 5 6 7 import pandas as pd import numpy as np from pandas import Series,DataFrame a=Series([\u0026#39;5\u0026#39;,\u0026#39;10\u0026#39;],index=[180,185]) height1=Series({\u0026#39;13\u0026#39; :187, \u0026#39;14\u0026#39; :190, \u0026#39;17\u0026#39;:185, \u0026#39;2\u0026#39;:178, \u0026#39;9\u0026#39;:185}) height2=height1.append(a) print(height2) åˆ é™¤æˆå‘˜ 1 2 3 4 5 6 import pandas as pd import numpy as np from pandas import Series,DataFrame height1=Series({\u0026#39;13\u0026#39; :187, \u0026#39;14\u0026#39; :190, \u0026#39;17\u0026#39;:185, \u0026#39;2\u0026#39;:178, \u0026#39;9\u0026#39;:185}) height1.dorp(\u0026#39;13\u0026#39;,\u0026#39;9\u0026#39;) print(height1) Data_Frameå¯¹è±¡ 1 2 3 4 5 6 7 data = [[19,170, 68], [20, 165,65], [18,175, 65]] students=DataFrame (data, index= [1,2,3], columns=[\u0026#39;age\u0026#39;, \u0026#39;height\u0026#39;,\u0026#39;weight\u0026#39;]) print(students) # age height weight #1 19 170 68 #2 20 165 65 #3 18 175 65 æ·»åŠ æ•°æ® 1 2 3 4 5 students[\u0026#39;expense\u0026#39;]=[1500,1600,1200] # age height weight expense #1 19 170 68 1500 #2 20 165 65 1600 #3 18 175 65 1200 ä¿®æ”¹æ•°æ® 1 2 3 4 5 6 students[\u0026#39;expense\u0026#39;]=1000 print(stdents) # age height weight expense #1 19 170 68 1000 #2 20 165 65 1000 #3 18 175 65 1000 1 2 3 4 5 students.loc[1, :] = [21,188, 70,20] # age height weight expense #1 21 78 70 20 #2 20 165 65 1000 #3 18 175 65 1000 åˆ é™¤æ•°æ® 1 2 3 4 students.drop(1,axis=0)#axis=0è¡¨ç¤ºè¡Œ # age height weight expense #1 21 78 70 20 #2 20 165 65 1000 1 2 3 4 5 students.drop(\u0026#39;expense\u0026#39;, axis=1) # åˆ é™¤expenseåˆ—ï¼Œaxis=1è¡¨ç¤ºåˆ— # age height weight #1 21 78 70 #2 20 165 65 #3 18 175 65 1 students.drop([1,2],axis=0) # åˆ é™¤å¤šè¡Œ è¯»å†™æ–‡ä»¶ 1 2 3 4 5 csv=pd.read_csv(file,sep=\u0026#39;, \u0026#39;,header= \u0026#39;infer\u0026#39; , index_col=None , names, skiprows, ...) #è¯»å–csvæ–‡ä»¶ exc=pd.read_excel(fileï¼Œsheetname,... ) #è¯»å–excelæ–‡ä»¶ file å­—ç¬¦ä¸²ï¼Œæ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶å sep å­—ç¬¦ä¸²ï¼Œæ¯è¡Œå„æ•°æ®ä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤ä¸ºâ€œ,â€ header header =None,æ–‡ä»¶ä¸­ç¬¬ä¸€è¡Œä¸æ˜¯åˆ—ç´¢å¼• index_col æ•°å­—ï¼Œç”¨ä½œè¡Œç´¢å¼•çš„åˆ—åºå· names åˆ—è¡¨ï¼Œå®šä¹‰åˆ—ç´¢å¼•ï¼Œé»˜è®¤æ–‡ä»¶ä¸­ç¬¬- - è¡Œä¸ºåˆ—ç´¢å¼• skiprows æ•´æ•°æˆ–åˆ—è¡¨ï¼Œéœ€è¦å¿½ç•¥çš„è¡Œæ•°æˆ–éœ€è¦è·³è¿‡çš„è¡Œå·åˆ—è¡¨ï¼Œskiprows=[2,3,5]ï¼Œè·³è¿‡2ï¼Œ3ï¼Œ5è¡Œ ","date":"2020-10-25T19:13:09+08:00","image":"https://chasing1020.github.io/post/data-analyzation-note/numpy_hue3031a62f00ed5687652f7562c1129b7_14028_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/data-analyzation-note/","title":"Data Analyzation Note"},{"content":"åˆ©ç”¨opencvè¿›è¡Œäººè„¸æ£€æµ‹ä¸è¯†åˆ« 1. OpenCVåŸºæœ¬æ“ä½œ 1.1 é…ç½®ç¯å¢ƒ æŒ‰win+Rè¾“å…¥cmdæ‰“å¼€å‘½ä»¤è¡Œï¼Œåœ¨å‘½ä»¤è¡Œä¸‹ï¼Œè¾“å…¥\npip install numpy\npip install opencv-python\n1 2 3 #ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ å…¥æ¨¡å— import cv2 import numpy as np 1.2 å›¾ç‰‡åŠ è½½ã€æ˜¾ç¤ºå’Œä¿å­˜ 1 2 3 4 5 6 7 8 9 10 11 12 13 import cv2 # ç”Ÿæˆå›¾ç‰‡ img = cv2.imread(\u0026#34;1.jpg\u0026#34;) # ç”Ÿæˆç°è‰²å›¾ç‰‡ imgGrey = cv2.imread(\u0026#34;1.jpg\u0026#34;, 0) # å±•ç¤ºåŸå›¾ cv2.imshow(\u0026#34;img\u0026#34;, img) # å±•ç¤ºç°è‰²å›¾ç‰‡ cv2.imshow(\u0026#34;imgGrey\u0026#34;, imgGrey) # ç­‰å¾…å›¾ç‰‡çš„å…³é—­ cv2.waitKey() # ä¿å­˜ç°è‰²å›¾ç‰‡ cv2.imwrite(\u0026#34;Copy.jpg\u0026#34;, imgGrey) 1.3 å›¾åƒæ˜¾ç¤ºçª—å£åˆ›å»ºä¸é”€æ¯ cv2.namedWindow(çª—å£åï¼Œå±æ€§) åˆ›å»ºä¸€ä¸ªçª—å£\nå±æ€§â€”æŒ‡å®šçª—å£å¤§å°æ¨¡å¼ï¼š\ncv2.WINDOW_AUTOSIZEï¼šæ ¹æ®å›¾åƒå¤§å°è‡ªåŠ¨åˆ›å»ºå¤§å° cv2.WINDOW_NORMALï¼šçª—å£å¤§å°å¯è°ƒæ•´ cv2.destoryAllWindows(çª—å£å) åˆ é™¤ä»»ä½•å»ºç«‹çš„çª—å£\n1 2 3 4 5 6 7 8 import cv2 img = cv2.imread(\u0026#34;1.jpg\u0026#34;) cv2.namedWindow(\u0026#34;img\u0026#34;, cv2.WINDOW_NORMAL) cv2.imshow(\u0026#34;img\u0026#34;, img) cv2.waitKey() cv2.destroyAllWindows() 1.4 å›¾ç‰‡å®½ã€é«˜ã€é€šé“æ•°è·å– img.shape è¿”å›å›¾åƒé«˜ï¼ˆå›¾åƒçŸ©é˜µçš„è¡Œæ•°ï¼‰ã€å®½ï¼ˆå›¾åƒçŸ©é˜µçš„åˆ—æ•°ï¼‰å’Œé€šé“æ•°3ä¸ªå±æ€§ç»„æˆçš„å…ƒç»„ï¼Œè‹¥å›¾åƒæ˜¯éå½©è‰²å›¾ï¼Œåˆ™åªè¿”å›é«˜å’Œå®½ç»„æˆçš„å…ƒç»„ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 import cv2 img = cv2.imread(\u0026#34;1.jpg\u0026#34;) imgGrey = cv2.imread(\u0026#34;1.jpg\u0026#34;, 0) sp1 = img.shape sp2 = imgGrey.shape print(sp1) print(sp2) # ======è¾“å‡º======= #(1200, 1920, 3) #(1200, 1920) 1.5 å›¾åƒåƒç´ æ•°ç›®å’Œå›¾åƒæ•°æ®ç±»å‹çš„è·å– å›¾åƒçŸ©é˜µimgçš„sizeå±æ€§å’Œdtypeåˆ†åˆ«å¯¹åº”å›¾åƒçš„åƒç´ æ€»æ•°ç›®å’Œå›¾åƒæ•°æ®ç±»å‹ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå›¾åƒçš„æ•°æ®ç±»å‹æ˜¯uint8\n1 2 3 4 5 6 7 8 9 10 11 12 import cv2 img = cv2.imread(\u0026#34;1.jpg\u0026#34;) imgSize = img.size print(imgSize) ty = img.dtype print(ty) #======è¾“å‡º======== #6912000 #uint8 1. 6 ç”ŸæˆæŒ‡å®šå¤§å°çš„ç©ºå›¾åƒ emptyImage = np.zeros(img.shape, np.uint8)\n1 2 3 4 5 6 7 8 9 10 11 12 13 import cv2 import numpy as np img = cv2.imread(\u0026#34;1.jpg\u0026#34;) imgZero = np.zeros(img.shape, np.uint8) imgFix = np.zeros((300, 500, 3), np.uint8) # imgFix = np.zeros((300,500),np.uint8) cv2.imshow(\u0026#34;img\u0026#34;, img) cv2.imshow(\u0026#34;imgZero\u0026#34;, imgZero) cv2.imshow(\u0026#34;imgFix\u0026#34;, imgFix) cv2.waitKey() 1.7 è®¿é—®å’Œæ“ä½œå›¾åƒåƒç´  OpenCVä¸­å›¾åƒçŸ©é˜µçš„é¡ºåºæ˜¯Bã€Gã€Rã€‚å¯ä»¥ç›´æ¥é€šè¿‡åæ ‡ä½ç½®è®¿é—®å’Œæ“ä½œå›¾åƒåƒç´ ã€‚\n1 2 3 4 5 6 #è·å–å›¾åƒçš„ä¸‰é€šé“ blue,green,red = cv2.split(f) #æˆ–è€… blue = f[:,:,0] green = f[:,:,1] red = f[:,:,2] OpenCVä¸­å›¾åƒçŸ©é˜µçš„é¡ºåºæ˜¯Bã€Gã€Rã€‚å¯ä»¥ç›´æ¥é€šè¿‡åæ ‡ä½ç½®è®¿é—®å’Œæ“ä½œå›¾åƒåƒç´ ã€‚\n1 2 3 4 5 6 7 8 9 10 import cv2 img = cv2.imread(\u0026#34;01.jpg\u0026#34;) numb = img[50,100] print(numb) img[50,100] = (0,0,255)#å°†50ï¼Œ100å¤„çš„åƒç´ ç‚¹æ”¹ä¸ºçº¢è‰² cv2.imshow(\u0026#34;img\u0026#34;,img) cv2.waitKey() åˆ†å¼€è®¿é—®å›¾åƒæŸä¸€é€šé“åƒç´ å€¼\n1 2 3 4 5 6 7 8 9 10 import cv2 img = cv2.imread(\u0026#34;01.jpg\u0026#34;) img[0:100,100:200,0] = 255 img[100:200,200:300,1] = 255 img[200:300,300:400,2] = 255 cv2.imshow(\u0026#34;img\u0026#34;,img) cv2.waitKey() æ›´æ”¹æŸä¸€çŸ©é˜µä¸­çš„åƒç´ å€¼\n1 2 3 4 5 6 7 8 import cv2 img = cv2.imread(\u0026#34;01.jpg\u0026#34;) img[0:50,1:100] = (0,0,255) cv2.imshow(\u0026#34;img\u0026#34;,img) cv2.waitKey() 1.8 å›¾åƒä¸‰é€šé“åˆ†ç¦»å’Œåˆå¹¶ åˆ†ç¦»å›¾åƒé€šé“å¯ä»¥ä½¿ç”¨cv2ä¸­çš„splitå‡½æ•°ï¼Œåˆå¹¶ä½¿ç”¨mergeå‡½æ•°ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 import cv2 img = cv2.imread(\u0026#34;01.jpg\u0026#34;) b , g , r = cv2.split(img) # b = cv2.split(img)[0] # g = cv2.split(img)[1] # r = cv2.split(img)[2] merged = cv2.merge([b,g,r]) cv2.imshow(\u0026#34;Blue\u0026#34;,b) cv2.imshow(\u0026#34;Green\u0026#34;,g) cv2.imshow(\u0026#34;Red\u0026#34;,r) cv2.imshow(\u0026#34;Merged\u0026#34;,merged) cv2.waitKey() 1.9 åœ¨å›¾åƒä¸Šè¾“å‡ºæ–‡å­—åŠå›¾ç‰‡ ä½¿ç”¨putTextå‡½æ•°åœ¨å›¾ç‰‡ä¸Šè¾“å‡ºæ–‡å­—ï¼Œå‡½æ•°åŸå‹ï¼š putText(img, text, org, fontFace, fontScale, color, thickness=None, lineType=None, bottomLeftOrigin=None)\nimg å›¾åƒ text è¦è¾“å‡ºçš„æ–‡æœ¬ org æ–‡å­—çš„èµ·ç‚¹åæ ‡ fontFace å­—ä½“ fontScale å­—ä½“å¤§å° color å­—ä½“é¢œè‰² thickness å­—å›¾åŠ ç²— 1 2 3 4 5 6 7 8 import cv2 img = cv2.imread(\u0026#34;01.jpg\u0026#34;) cv2.putText(img,\u0026#34;Print some text to img\u0026#34;,(100,100),cv2.FONT_HERSHEY_SIMPLEX,1,(0,0,255)) cv2.imshow(\u0026#34;img\u0026#34;,img) cv2.waitKey() ç»˜åˆ¶çŸ©å½¢å’Œåœ†\n1 2 cv2.rectangle(img, (x, y, x + w, y + h), color=(0, 255, 0), thickness=12) cv2.circle(img, center=(x + w // 2, y + h // 2), radius=w // 2, color=(0, 0, 255), thickness=2) 1.10 å›¾åƒç¼©æ”¾ 1 2 3 4 5 6 7 8 9 10 import cv2 img = cv2.imread(\u0026#34;1.jpg\u0026#34;) cv2.imshow(\u0026#34;img\u0026#34;, img) img2 = cv2.resize(img, (200, 100)) cv2.imshow(\u0026#34;img2\u0026#34;, img1) cv2.waitKey() interpolation é€‰é¡¹ æ‰€ç”¨çš„æ’å€¼æ–¹æ³• INTER_NEAREST æœ€è¿‘é‚»æ’å€¼ INTER_LINEAR åŒçº¿æ€§æ’å€¼ï¼ˆé»˜è®¤è®¾ç½®ï¼‰ INTER_AREA ä½¿ç”¨åƒç´ åŒºåŸŸå…³ç³»è¿›è¡Œé‡é‡‡æ ·ã€‚ å®ƒå¯èƒ½æ˜¯å›¾åƒæŠ½å–çš„é¦–é€‰æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¼šäº§ç”Ÿæ— äº‘çº¹ç†çš„ç»“æœã€‚ ä½†æ˜¯å½“å›¾åƒç¼©æ”¾æ—¶ï¼Œå®ƒç±»ä¼¼äºINTER_NEARESTæ–¹æ³•ã€‚ INTER_CUBIC 4x4åƒç´ é‚»åŸŸçš„åŒä¸‰æ¬¡æ’å€¼ INTER_LANCZOS4 8x8åƒç´ é‚»åŸŸçš„Lanczosæ’å€¼ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import cv2 img = cv2.imread(\u0026#39;./res/aero3.jpg\u0026#39;) print(img.shape[:2]) height, width = img.shape[:2] reSize1 = cv2.resize(img, (2*width, 2*height), interpolation=cv2.INTER_CUBIC) reSize2 = cv2.resize(img, (int(width/2), int(height/2)), interpolation=cv2.INTER_CUBIC) cv2.imshow(\u0026#39;reSize1\u0026#39;, reSize1) cv2.imshow(\u0026#39;reSize2\u0026#39;, reSize2) cv2.waitKey() cv2.destroyAllWindows() 1.11 å®ç°æ­£å¸¸é€€å‡º cv2.waitkey(delaytime)\u0026mdash;\u0026mdash;-\u0026gt;returnvalue åœ¨delaytimeæ—¶é—´å†…,æŒ‰é”®ç›˜, è¿”å›æ‰€æŒ‰é”®çš„ASCIIå€¼;è‹¥æœªåœ¨delaytimeæ—¶é—´å†…æŒ‰ä»»ä½•é”®, è¿”å›-1; å…¶ä¸­,dalaytime: å•ä½ms; note:\nå½“delaytimeä¸º0æ—¶,è¡¨ç¤ºforever,æ°¸ä¸é€€å›. å½“æŒ‰ecsé”®æ—¶,å› ä¸ºescé”®ASCIIå€¼ä¸º27,æ‰€æœ‰returnvalueçš„å€¼ä¸º27, ä¸€èˆ¬ç”¨è¿™ä¸ªæœºåˆ¶å®ç°åœ¨delaytimeå†…æ­£å¸¸é€€å‡º. ä¹Ÿä½¿ç”¨ if cv2.waitKey(1) \u0026amp; 0xFF == ord(â€˜qâ€™): break æ¥å®ç°1msä¹‹å†…çš„æ­£å¸¸é€€å‡º. å…¶ä¸­, ord(â€˜qâ€™)ï¼šè¿”å›qå¯¹åº”çš„Unicodeç å¯¹åº”çš„å€¼ï¼Œqå¯¹åº”çš„Unicodeæ•°å€¼ä¸º113ã€‚ 0xFFï¼š0xFFæ˜¯ä¸€ä¸ªä½æ©ç ï¼Œåå…­è¿›åˆ¶å¸¸æ•°ï¼ŒäºŒè¿›åˆ¶å€¼ä¸º11111111, å®ƒå°†å·¦è¾¹çš„24ä½è®¾ç½®ä¸º0,æŠŠè¿”å›å€¼é™åˆ¶åœ¨åœ¨0å’Œ255ä¹‹é—´ã€‚ord(â€™ \u0026lsquo;)è¿”å›æŒ‰é”®å¯¹åº”çš„æ•´æ•°ï¼ˆASCIIç ï¼‰ 1.12 ä¿å­˜å›¾åƒ 1 2 3 4 5 6 7 #cv2.IMWRITE_JPEG_QUALITYçš„å€¼é»˜è®¤æ˜¯longï¼Œéœ€è¦å¼ºåˆ¶è½¬ä¸ºint #å¯¹äºimgæ ¼å¼ï¼Œå…¶è´¨é‡ä¸º0-100çš„èŒƒå›´ï¼Œå…¶ä¸­é»˜è®¤æ˜¯95 cv2.imwrite(\u0026#34;./5.jpg\u0026#34;, img, [int(cv2.IMWRITE_JPEG_QUALITY), 5]) cv2.imwrite(\u0026#34;./100.jpg\u0026#34;, img, [int(cv2.IMWRITE_JPEG_QUALITY), 100]) #å¯¹äºpngæ ¼å¼ï¼Œå…¶è´¨é‡ä¸º0-9èŒƒå›´ï¼Œå…¶ä¸­é»˜è®¤æ˜¯3 cv2.imwrite(\u0026#34;./0.png\u0026#34;, img, [int(cv2.IMWRITE_PNG_COMPRESSION), 0]) cv2.imwrite(\u0026#34;./9.png\u0026#34;, img, [int(cv2.IMWRITE_PNG_COMPRESSION), 9]) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import cv2 # å¾…æ£€æµ‹çš„å›¾ç‰‡è·¯å¾„ imagepath=\u0026#34;1.jpg\u0026#34; image = cv2.imread(imagepath) gray = cv2.cvtColor(image,cv2.COLOR_BGR2GRAY) # è·å–äººè„¸è¯†åˆ«è®­ç»ƒæ•°æ® #å¯¹äºäººè„¸ç‰¹å¾çš„ä¸€äº›æè¿°ï¼Œopencvåœ¨è¯»å–å®Œæ•°æ®åå¾ˆæ®è®­ç»ƒä¸­çš„æ ·å“æ•°æ®ï¼Œ #å°±å¯ä»¥æ„ŸçŸ¥è¯»å–åˆ°çš„å›¾ç‰‡ä¸Šçš„ç‰¹å¾ï¼Œè¿›è€Œå¯¹å›¾ç‰‡è¿›è¡Œäººè„¸è¯†åˆ«ã€‚ #xmlæ•°æ®ä¸‹è½½ï¼šhttps://github.com/opencv/opencv/tree/master/data/haarcascades face_cascade = cv2.CascadeClassifier(r\u0026#39;./haarcascade_frontalface_default.xml\u0026#39;) # æ¢æµ‹äººè„¸ # æ ¹æ®è®­ç»ƒçš„æ•°æ®æ¥å¯¹æ–°å›¾ç‰‡è¿›è¡Œè¯†åˆ«çš„è¿‡ç¨‹ã€‚ faces = face_cascade.detectMultiScale( gray, scaleFactor = 1.15, minNeighbors = 5, minSize = (5,5), #flags = cv2.HAAR_SCALE_IMAGE ) # æˆ‘ä»¬å¯ä»¥éšæ„çš„æŒ‡å®šé‡Œé¢å‚æ•°çš„å€¼ï¼Œæ¥è¾¾åˆ°ä¸åŒç²¾åº¦ä¸‹çš„è¯†åˆ«ã€‚è¿”å›å€¼å°±æ˜¯opencvå¯¹å›¾ç‰‡çš„æ¢æµ‹ç»“æœçš„ä½“ç°ã€‚ # å¤„ç†äººè„¸æ¢æµ‹çš„ç»“æœ print (\u0026#34;å‘ç°{0}ä¸ªäººè„¸!\u0026#34;.format(len(faces))) for(x,y,w,h) in faces: cv2.rectangle(image,(x,y),(x+w,y+w),(0,255,0),2) # cv2.circle(image,((x+x+w)/2,(y+y+h)/2),w/2,(0,255,0),2) cv2.imshow(\u0026#34;image\u0026#34;,image) cv2.waitKey(0) cv2.destroyAllWindows() 2. Haarçº§è”åˆ†ç±»å™¨ 2.1 ç§ç±» é¡¾åæ€ä¹‰â€”â€”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 haarcascade_eye.xml haarcascade_eye_tree_eyeglasses.xml haarcascade_frontalface_alt.xml haarcascade_frontalface_alt_tree.xml haarcascade_frontalface_alt2.xml haarcascade_frontalface_default.xml haarcascade_fullbody.xml haarcascade_lefteye_2splits.xml haarcascade_lowerbody.xml haarcascade_mcs_eyepair_big.xml haarcascade_mcs_eyepair_small.xml haarcascade_mcs_leftear.xml haarcascade_mcs_lefteye.xml haarcascade_mcs_mouth.xml haarcascade_mcs_nose.xml haarcascade_mcs_rightear.xml haarcascade_mcs_righteye.xml haarcascade_mcs_upperbody.xml haarcascade_profileface.xml haarcascade_righteye_2splits.xml haarcascade_smile.xml haarcascade_upperbody.xml 2.2 detectMultiScaleå‡½æ•° å‡½æ•°åŸå‹\n1 objects = cv2.CascadeClassifier.detectMultiScale( image[, scaleFactor[,ï¿¼ minNeighbors[, flags[, minSize[, maxSize]]]]] ) æ£€æµ‹äººè„¸å’Œçœ¼ç›åº”è¯¥å‡ºç°çš„ä½ç½®\nimage å¾…æ£€æµ‹å›¾åƒï¼Œé€šå¸¸è®¾ç½®ä¸ºç°åº¦å›¾åƒ scaleFactor çª—å£ç¼©æ”¾çš„æ¯”ä¾‹ minNeighbors æ£€æµ‹çš„ç›®æ ‡ç›¸é‚»çŸ©å½¢çš„æœ€å°ä¸ªæ•°ï¼Œé»˜è®¤ä¸‰ï¼Œå¦‚æœå¸Œæœ›æ£€æµ‹ä¸¥æ ¼å¯ä»¥è°ƒé«˜ flags è¾¹ç¼˜æ£€æµ‹å™¨ï¼Œæ‹’ç»ä¸€äº›åŒºåŸŸ minSize æœ€å°å°ºå¯¸ï¼Œå°äºè¿™ä¸ªå°ºå¯¸çš„å¯ä»¥å¿½ç•¥ naxSize æœ€å¤§å°ºå¯¸ï¼Œå¤§äºè¿™ä¸ªå°ºå¯¸çš„å¯ä»¥å¿½ç•¥ 2.3 LBPHè¯†åˆ« retval = cv2.face.LBPHFaceRecognizer_create( [, radius[, neighbors[,ï¿¼grid_x[, grid_y[, threshold]]]]])\næ–¹æ³•ï¼šPCA\næš‚æ—¶å¹¶ä¸éœ€è¦å®Œæˆè¯†åˆ«ï¼Œåªéœ€è¦æ£€æµ‹\n3.è¯†åˆ« å¯¼å…¥haarcascade_eye.xmlå’Œhaarcascade_frontalface_default.xml\nåœ¨Githubä¸‹è½½\n1 fileUrl=https://github.com/opencv/opencv 3.1 äººè„¸å¯¼å…¥ä»¥åŠç°åº¦å¤„ç† 1 2 3 4 5 6 7 8 9 import cv2 # è½½å…¥äººè„¸è¯†åˆ«å’Œçœ¼ç›è¯†åˆ«çš„ä¸¤ä¸ªxmlæ–‡ä»¶ face_xml = cv2.CascadeClassifier(\u0026#39;haarcascade_frontalface_default.xml\u0026#39;) eye_xml = cv2.CascadeClassifier(\u0026#39;haarcascade_eye.xml\u0026#39;) # è½½å…¥å›¾ç‰‡ img = cv2.imread(\u0026#39;face.jpg\u0026#39;) cv2.imshow(\u0026#39;src\u0026#39;, img) # ç°åº¦å¤„ç† gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) 3.2 è¯†åˆ«äººè„¸å¹¶ä¸”ç”¨æ–¹æ¡†æ ‡è®° 1 2 3 4 5 6 7 8 # äººè„¸è¯†åˆ« face = face_xml.detectMultiScale(gray, 1.3, 2) # å‚æ•°ï¼š1ã€ç°åº¦å›¾ç‰‡ï¼Œ 2ã€ç¼©æ”¾æ¯”ä¾‹ï¼Œ 3ã€é˜ˆå€¼ print(\u0026#34;è¿™å¼ å›¾ç‰‡ä¸­æœ‰%då¼ äººè„¸\u0026#34; % len(face)) # ç»˜åˆ¶å‡ºè¯†åˆ«åˆ°çš„äººè„¸ for (x, y, w, h) in face: cv2.rectangle(img, (x, y), (x+w, y+h), (0, 255, 0), 2) # ç»˜åˆ¶äººè„¸æ–¹æ¡† cv2.imshow(\u0026#39;dst\u0026#39;, img) cv2.waitkey(0) 3.3 è¯†åˆ«çœ¼ç›å¹¶ç”¨æ–¹æ¡†æ ‡è®° 1 2 3 4 5 6 7 8 9 # åœ¨äººè„¸çš„åŸºç¡€ä¸Šè¯†åˆ«çœ¼ç› face_gray = gray[y:y+h, x:x+w] face_color = img[y:y+h, x:x+w] # çœ¼ç›è¯†åˆ« eyes = eye_xml.detectMultiScale(face_gray) print(\u0026#34;åœ¨è¿™å¼ è„¸ä¸Šæœ‰%dä¸ªçœ¼ç›\u0026#34; % len(eyes)) # ç»˜åˆ¶å‡ºè¯†åˆ«åˆ°çš„çœ¼ç› for (e_x, e_y, e_w, e_h) in eyes: cv2.rectangle(face_color, (e_x, e_y), (e_x+e_w, e_y+e_h), (0, 255, 0), 2) # ç»˜åˆ¶çœ¼ç›æ–¹æ¡† 3.4 å¯¹å›¾ç‰‡è¿›è¡Œå®Œæ•´å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # -*- coding: utf-8 -*- #@Time : 2020-10-17 18:38 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : test01.py #@Software: PyCharm # from PIL import Image __author__ = \u0026#39;WWQ\u0026#39; import cv2 # è½½å…¥äººè„¸è¯†åˆ«å’Œçœ¼ç›è¯†åˆ«çš„ä¸¤ä¸ªxmlæ–‡ä»¶ face_xml = cv2.CascadeClassifier(\u0026#39;haarcascade_frontalface_default.xml\u0026#39;) eye_xml = cv2.CascadeClassifier(\u0026#39;haarcascade_eye.xml\u0026#39;) # è½½å…¥å›¾ç‰‡ img = cv2.imread(\u0026#39;face.jpg\u0026#39;) cv2.imshow(\u0026#39;src\u0026#39;, img) # ç°åº¦å¤„ç† gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY) # äººè„¸è¯†åˆ« face = face_xml.detectMultiScale(gray, 1.3, 2) # å‚æ•°ï¼š1ã€ç°åº¦å›¾ç‰‡ï¼Œ 2ã€ç¼©æ”¾æ¯”ä¾‹ï¼Œ 3ã€é˜ˆå€¼ print(\u0026#34;è¿™å¼ å›¾ç‰‡ä¸­æœ‰%då¼ äººè„¸\u0026#34; % len(face)) # ç»˜åˆ¶å‡ºè¯†åˆ«åˆ°çš„äººè„¸ for (x, y, w, h) in face: cv2.rectangle(img, (x, y), (x+w, y+h), (0, 255, 0), 2) # ç»˜åˆ¶äººè„¸æ–¹æ¡† # cv2.imshow(\u0026#39;dst\u0026#39;, img) # åœ¨äººè„¸çš„åŸºç¡€ä¸Šè¯†åˆ«çœ¼ç› face_gray = gray[y:y+h, x:x+w] face_color = img[y:y+h, x:x+w] # çœ¼ç›è¯†åˆ« eyes = eye_xml.detectMultiScale(face_gray) print(\u0026#34;åœ¨è¿™å¼ è„¸ä¸Šæœ‰%dä¸ªçœ¼ç›\u0026#34; % len(eyes)) # ç»˜åˆ¶å‡ºè¯†åˆ«åˆ°çš„çœ¼ç› for (e_x, e_y, e_w, e_h) in eyes: cv2.rectangle(face_color, (e_x, e_y), (e_x+e_w, e_y+e_h), (0, 255, 0), 2) # ç»˜åˆ¶çœ¼ç›æ–¹æ¡† cv2.imshow(\u0026#39;dst\u0026#39;, img) cv2.waitKey(0) 3.5 æ£€æµ‹ç”»é¢ä¸­äººè„¸çš„ä¸ªæ•° 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 # -*- coding: utf-8 -*- #@Time : 2020-10-17 18:38 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : test01.py #@Software: PyCharm # from PIL import Image import cv2 # å¾…æ£€æµ‹çš„å›¾ç‰‡è·¯å¾„ imagepath=\u0026#34;test01.jpg\u0026#34; image = cv2.imread(imagepath) gray = cv2.cvtColor(image,cv2.COLOR_BGR2GRAY) \u0026#39;\u0026#39;\u0026#39; # è·å–äººè„¸è¯†åˆ«è®­ç»ƒæ•°æ® å¯¹äºäººè„¸ç‰¹å¾çš„ä¸€äº›æè¿°ï¼Œopencvåœ¨è¯»å–å®Œæ•°æ®åå¾ˆæ®è®­ç»ƒä¸­çš„æ ·å“æ•°æ®ï¼Œ å°±å¯ä»¥æ„ŸçŸ¥è¯»å–åˆ°çš„å›¾ç‰‡ä¸Šçš„ç‰¹å¾ï¼Œè¿›è€Œå¯¹å›¾ç‰‡è¿›è¡Œäººè„¸è¯†åˆ«ã€‚ xmlæ•°æ®ä¸‹è½½ï¼Œ å‚è€ƒï¼šhttps://github.com/opencv/opencv/tree/master/data/haarcascades \u0026#39;\u0026#39;\u0026#39; face_cascade = cv2.CascadeClassifier(r\u0026#39;./haarcascade_frontalface_default.xml\u0026#39;) # æ¢æµ‹äººè„¸ # æ ¹æ®è®­ç»ƒçš„æ•°æ®æ¥å¯¹æ–°å›¾ç‰‡è¿›è¡Œè¯†åˆ«çš„è¿‡ç¨‹ã€‚ faces = face_cascade.detectMultiScale( gray, scaleFactor = 1.15, minNeighbors = 5, minSize = (5,5), #flags = cv2.HAAR_SCALE_IMAGE ) # æˆ‘ä»¬å¯ä»¥éšæ„çš„æŒ‡å®šé‡Œé¢å‚æ•°çš„å€¼ï¼Œæ¥è¾¾åˆ°ä¸åŒç²¾åº¦ä¸‹çš„è¯†åˆ«ã€‚è¿”å›å€¼å°±æ˜¯opencvå¯¹å›¾ç‰‡çš„æ¢æµ‹ç»“æœçš„ä½“ç°ã€‚ # å¤„ç†äººè„¸æ¢æµ‹çš„ç»“æœ print (\u0026#34;å‘ç°{0}ä¸ªäººè„¸!\u0026#34;.format(len(faces))) for(x,y,w,h) in faces: cv2.rectangle(image,(x,y),(x+w,y+w),(0,255,0),2) # cv2.circle(image,((x+x+w)/2,(y+y+h)/2),w/2,(0,255,0),2) cv2.imshow(\u0026#34;image\u0026#34;,image) cv2.waitKey(0) cv2.destroyAllWindows() 4.æå–äººçœ¼åŒºåŸŸçš„ç³å­”ä½ç½® 4.1 æå–äººçœ¼çš„ä½ç½®ï¼Œå¹¶ä¸”äºŒå€¼åŒ– 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 # -*- coding: utf-8 -*- #@Time : 2020-10-17 19:27 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : test01.py #@Software: PyCharm # from PIL import Image import cv2 import numpy as np src = cv2.imread(\u0026#34;/home/jon/code/python/img/eye_area.jpg\u0026#34;) gray = cv2.cvtColor(src, cv.COLOR_BGR2GRAY) cv2.imshow(\u0026#34;gray image\u0026#34;, gray) ret,binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV | cv2.THRESH_OTSU) cv2.imshow(\u0026#34;binary image\u0026#34;, binary) 4.2 å¯¹å…¶é™å™ªå¤„ç† è¦æƒ³å¾—åˆ°çœ¼çƒï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€ä¸ªåœ†å½¢çš„ç»“æ„å…ƒç´ ï¼Œå¯¹è¿™å¼ å›¾åƒåšä¸ªå¼€æ“ä½œ(å…ˆè…èš€å†è†¨èƒ€)ï¼Œä½†æ˜¯è¿˜å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä¸­å¿ƒçš„åœ†å½¢åŒºåŸŸè¿˜å­˜åœ¨å™ªå£°ï¼Œéœ€è¦å…ˆæŠŠè¿™ä¸ªå™ªå£°å‰”é™¤\n1 2 3 element1 = cv2.getStructuringElement(cv2.MORPH_RECT,(3,3),(-1,-1)) tmp = cv2.morphologyEx(binary,cv2.MORPH_CLOSE,element1,None,(-1,-1),1) cv2.imshow(\u0026#34;tmp image\u0026#34;, tmp) è¿™æ ·å›¾åƒå°±å¹²å‡€äº†ï¼Œå»é™¤äº†å™ªå£°åï¼Œæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥é€šè¿‡åœ†å½¢çš„ç»“æ„å…ƒç´ æå–çœ¼çƒä½ç½® æ³¨æ„ï¼šè¿™é‡Œçš„çŸ©å½¢ç»“æ„å…ƒç´ ä¸èƒ½å¤ªå¤§äº†ï¼Œä¸ç„¶ä¼šæŠŠé‡Œé¢çš„2ä¸ªå¤§é»‘ç‚¹å½“ä½œå™ªå£°å»é™¤äº†ï¼Œä»è€Œå¯¼è‡´æ‰¾ä¸åˆ°çœ¼çƒ\n1 2 3 element2 = cv.getStructuringElement(cv.MORPH_ELLIPSE,(16,16),(-1,-1)) dst = cv.morphologyEx(tmp,cv.MORPH_OPEN,element2) cv.imshow(\u0026#34;eye image\u0026#34;, dst) å¦‚å›¾å¾—åˆ°çœ¼çƒï¼Œä¸‹é¢åªéœ€è¦æ¥ä¸ªè½®å»“å‘ç°å¹¶å¡«å……é¢œè‰²å³å¯ æ³¨æ„ï¼šè¿™é‡Œçš„åœ†å½¢åŒºåŸŸçš„å¤§å°éœ€è¦é€‚å½“å¤§ç‚¹ï¼Œæˆ–è®¸éœ€è¦æ ¹æ®ä¸åŒçš„å›¾ç‰‡åä¸‹å¾®è°ƒä»¥è¾¾åˆ°ç†æƒ³çš„æ•ˆæœ\n1 2 3 4 5 6 cloneImage, contours, hierarchy = cv2.findContours(dst, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE, None, None, (0, 0)) for i, contour in enumerate(contours): print \u0026#34;find \u0026#34; cv2.drawContours(src, contours, i, (255, 0, 0), -1) cv2.imshow(\u0026#34;dst image\u0026#34;, src) 4.3 å®Œæ•´åˆ¤æ–­çœ¼ç›ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #-*- coding = utf-8 -*- #@Time : 2020-10-17 18:38 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : test01.py #@Software: PyCharm # from PIL import Image import cv2 import numpy as np src = cv2.imread(\u0026#34;/home/jon/code/python/img/tpl.jpg\u0026#34;) gray = cv2.cvtColor(src, cv2.COLOR_BGR2GRAY) cv2.imshow(\u0026#34;gray image\u0026#34;, gray) ret,binary = cv2.threshold(gray, 0, 255, cv2.THRESH_BINARY_INV | cv2.THRESH_OTSU) cv2.imshow(\u0026#34;binary image\u0026#34;, binary) element1 = cv2.getStructuringElement(cv2.MORPH_RECT,(3,3),(-1,-1)) tmp = cv2.morphologyEx(binary,cv2.MORPH_CLOSE,element1,None,(-1,-1),1) cv2.imshow(\u0026#34;tmp image\u0026#34;, tmp) element2 = cv2.getStructuringElement(cv2.MORPH_ELLIPSE,(16,16),(-1,-1)) dst = cv2.morphologyEx(tmp,cv.MORPH_OPEN,element2) cv2.imshow(\u0026#34;eye image\u0026#34;, dst) cloneImage, contours, hierarchy = cv2.findContours(dst, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE, None, None, (0, 0)) for i, contour in enumerate(contours): print \u0026#34;find \u0026#34; cv2.drawContours(src, contours, i, (255, 0, 0), -1) cv2.imshow(\u0026#34;dst image\u0026#34;, src) cv2.waitKey(0) cv2.destroyAllWindows() 5. è§†é¢‘æ“ä½œ 5.1 è¯»å–è§†é¢‘ 1 2 3 4 5 6 7 8 9 10 import cv2 cap = cv2. VideoCapture (0) while True: ret, frame = cap. read() cv2. imshow(\u0026#39; Video\u0026#39;,frame) C = cv2. waitKey(1) if c == 27: break cap.release() cv2.destroyAllWindows() 1ã€cap = cv2.VideoCapture(0)\nVideoCapture()ä¸­å‚æ•°æ˜¯0ï¼Œè¡¨ç¤ºæ‰“å¼€ç¬”è®°æœ¬çš„å†…ç½®æ‘„åƒå¤´ï¼Œå‚æ•°æ˜¯è§†é¢‘æ–‡ä»¶è·¯å¾„åˆ™æ‰“å¼€è§†é¢‘ï¼Œå¦‚cap = cv2.VideoCapture(\u0026quot;../test.avi\u0026quot;)\n2ã€ret,frame = cap.read()\ncap.read()æŒ‰å¸§è¯»å–è§†é¢‘ï¼Œret,frameæ˜¯è·cap.read()æ–¹æ³•çš„ä¸¤ä¸ªè¿”å›å€¼ã€‚å…¶ä¸­retæ˜¯å¸ƒå°”å€¼ï¼Œå¦‚æœè¯»å–å¸§æ˜¯æ­£ç¡®çš„åˆ™è¿”å›Trueï¼Œå¦‚æœæ–‡ä»¶è¯»å–åˆ°ç»“å°¾ï¼Œå®ƒçš„è¿”å›å€¼å°±ä¸ºFalseã€‚frameå°±æ˜¯æ¯ä¸€å¸§çš„å›¾åƒï¼Œæ˜¯ä¸ªä¸‰ç»´çŸ©é˜µã€‚\n3ã€cv2.waitKey(1)ï¼ŒwaitKeyï¼ˆï¼‰æ–¹æ³•æœ¬èº«è¡¨ç¤ºç­‰å¾…é”®ç›˜è¾“å…¥ï¼Œ\nå‚æ•°æ˜¯1ï¼Œè¡¨ç¤ºå»¶æ—¶1msåˆ‡æ¢åˆ°ä¸‹ä¸€å¸§å›¾åƒï¼Œå¯¹äºè§†é¢‘è€Œè¨€ï¼›\nå‚æ•°ä¸º0ï¼Œå¦‚cv2.waitKey(0)åªæ˜¾ç¤ºå½“å‰å¸§å›¾åƒï¼Œç›¸å½“äºè§†é¢‘æš‚åœ,ï¼›\nå‚æ•°è¿‡å¤§å¦‚cv2.waitKey(1000)ï¼Œä¼šå› ä¸ºå»¶æ—¶è¿‡ä¹…è€Œå¡é¡¿æ„Ÿè§‰åˆ°å¡é¡¿ã€‚\ncå¾—åˆ°çš„æ˜¯é”®ç›˜è¾“å…¥çš„ASCIIç ï¼Œescé”®å¯¹åº”çš„ASCIIç æ˜¯27ï¼Œå³å½“æŒ‰escé”®æ˜¯ifæ¡ä»¶å¥æˆç«‹\n4ã€è°ƒç”¨release()é‡Šæ”¾æ‘„åƒå¤´ï¼Œè°ƒç”¨destroyAllWindows()å…³é—­æ‰€æœ‰å›¾åƒçª—å£ã€‚\n5.2 å°†è§†é¢‘çš„æ¯ä¸€å¸§è¯†åˆ«å‡ºäººåƒ å°†ä¸Šè¿°çš„æ–¹æ³•æ•´åˆ å³å¯å®ç°æ¯ä¸€å¸§çš„è§†é¢‘ä¸­çš„å›¾åƒå±•ç¤ºå‡ºæ¥ ç¤ºä¾‹ä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 #-*- coding = utf-8 -*- #@Time : 2020-10-19 16:32 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : videoOpen.py #@Software: PyCharm import cv2 dataFaceUrl = r\u0026#39;E:\\opencv\\opencv-master\\data\\haarcascades\\haarcascade_frontalface_default.xml\u0026#39; dataEyesUrl = r\u0026#39;E:\\opencv\\opencv-master\\data\\haarcascades\\haarcascade_eye.xml\u0026#39; videoUrl=r\u0026#39;D:\\Desktop\\python\\demo\\testOpencv\\video1.mp4\u0026#39; eye_cascade = cv2.CascadeClassifier(dataEyeUrl) face_cascade = cv2.CascadeClassifier(dataFaceUrl) def main(): cap=cv2.VideoCapture(videoUrl) while True: ret,frame=cap.read() # cv2.imshow(\u0026#39;video\u0026#39;,frame) gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY) BBox = face_cascade.detectMultiScale(gray, 1.3, 5) for (x, y, w, h) in BBox: frame = cv2.rectangle(frame, (x, y), (x + w, y + h), (255, 0, 0), 2) height, width = frame.shape[:2] reSize2 = cv2.resize(frame, (int(width / 2), int(height / 2)), interpolation=cv2.INTER_CUBIC) cv2.imshow(\u0026#39;release\u0026#39;, reSize2) c = cv2.waitKey(100//30)#å‡å®šè§†é¢‘æ–‡ä»¶30å¸§ if c==27:#æŒ‰ä¸‹escé€€å‡º break cap.release() cv2.destroyAllWindows() if __name__ == \u0026#34;__main__\u0026#34;: main() 5.3 è¯†åˆ«äººè„¸ä¸­çš„çœ¼ç›æ˜¯å¦å®Œæ•´ 1 2 3 4 5 6 7 8 9 10 def eyesDetect(x, y, w, h,img,gray): face_gray = gray[y:y + h, x:x + w] face_color = img[y:y + h, x:x + w] # çœ¼ç›è¯†åˆ« eyes = eye_cascade.detectMultiScale(face_gray) # ç»˜åˆ¶å‡ºè¯†åˆ«åˆ°çš„çœ¼ç› for (e_x, e_y, e_w, e_h) in eyes: cv2.rectangle(face_color, (e_x, e_y), (e_x + e_w, e_y + e_h), (0, 255, 0), 2) # ç»˜åˆ¶çœ¼ç›æ–¹æ¡† cv2.destroyAllWindows() 5.4 è¯†åˆ«äººè„¸åŠçœ¼ç›ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 #-*- coding = utf-8 -*- #@Time : 2020-10-19 16:32 #@Author : Jiancong Zhu #@Email : 643601464@qq.com #@File : videoOpen.py #@Software: PyCharm import cv2 dataFaceUrl = r\u0026#39;E:\\opencv\\opencv-master\\data\\haarcascades\\haarcascade_frontalface_default.xml\u0026#39; dataEyeUrl = r\u0026#39;E:\\opencv\\opencv-master\\data\\haarcascades\\haarcascade_eye.xml\u0026#39; videoUrl=r\u0026#39;D:\\Desktop\\whx.mp4\u0026#39; eyeCascade = cv2.CascadeClassifier(dataEyeUrl) faceCascade = cv2.CascadeClassifier(dataFaceUrl) def main(): # cap=cv2.VideoCapture(0) cap = cv2.VideoCapture(videoUrl) while True: flag,frame=cap.read() if not flag: break flag1=1#ä»£è¡¨çœ¼ç›æ•°ç›®æ­£å¸¸ flag2=1#ä»£è¡¨è„¸éƒ¨æ•°ç›®æ­£å¸¸ gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)#ç°åŒ–ï¼Œè½¬ä¸ºé»‘ç™½ faces = faceCascade.detectMultiScale(gray, 1.3, 6,minSize=(150,150))#è¿”å›å››ç»´åˆ—è¡¨ï¼Œæœ€å°å¤§å°æš‚æ—¶è®¾ç½®ä¸º150ï¼Œé˜²æ­¢è¯¯è¯†åˆ«ï¼ŒåæœŸå¯ä»¥å†ä¿®æ”¹ if(len(faces)==1): for (x, y, w, h) in faces: frame = cv2.rectangle(frame, (x, y), (x + w, y + h), (255, 0, 0), 2) faceGray = gray[y:y + int(h*2/3), x:x + w]#è¿™é‡Œå–è„¸éƒ¨ä¸Šæ–¹2/3ï¼Œä¸ºäº†é˜²æ­¢è¯¯è¯†åˆ«å˜´å·´ faceFrame = frame[y:y + int(h*2/3), x:x + w] eyes = eyeCascade.detectMultiScale(faceGray,1.3,7) if(len(eyes)==2): for (e_x, e_y, e_w, e_h) in eyes: cv2.rectangle(faceFrame, (e_x, e_y), (e_x + e_w, e_y + e_h), (0, 255, 0), 2) else: flag1=0#ä»£è¡¨çœ¼ç›ä¸ªæ•°ä¸ä¸º2 else: flag2=0#ä»£è¡¨çœ¼ç›ä¸ªæ•°ä¸ä¸º1 if flag1==1 and flag2==1:#åªæœ‰å½“è„¸çš„ä¸ªæ•°ä¸º1ï¼Œçœ¼ç›æ•°ä¸º2ï¼Œè¾“å‡º cv2.putText(frame,\u0026#34;ok\u0026#34;,(30,50),cv2.FONT_HERSHEY_SIMPLEX,3,(0,255,0)) else: cv2.putText(frame,\u0026#34;error\u0026#34;,(30,50),cv2.FONT_HERSHEY_SIMPLEX,3,(0,0,255)) height, width = frame.shape[:2] reSize2 = cv2.resize(frame, (int(width / 1.3), int(height / 1.3)), interpolation=cv2.INTER_CUBIC) cv2.imshow(\u0026#39;release\u0026#39;, reSize2) esc = cv2.waitKey(3) if esc == 27: break cv2.distoryAllWindows() cap.release() if __name__ == \u0026#34;__main__\u0026#34;: main() ","date":"2020-10-18T10:30:09+08:00","image":"https://chasing1020.github.io/post/opencv-human-detection/opencv_hud84d1869b223a77017ffd1ac6363cc2d_8062_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/opencv-human-detection/","title":"OpenCV Human Detection"},{"content":"ç½‘é¡µçˆ¬è™«é¡¹ç›®å®æˆ˜ç»éªŒ æ­¤ç¯‡è®°å½•äº†ç½‘é¡µçˆ¬è™«çš„åŸºæœ¬ä½¿ç”¨åº“ï¼Œä»¥åŠå¸¸ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼æ“ä½œç­‰ã€‚ åŒæ—¶ç»™å‡ºäº†è±†ç“£ç”µå½±top250çš„çˆ¬å–æ–¹å¼ï¼ˆç»å…¸çˆ¬è™«å…¥é—¨é¡¹ç›®ï¼‰ã€‚ ä»¥åŠå¯¹äºCSDNçš„åšä¸»ä¸»é¡µå•ä¸ªä»¥åŠå¤šä¸ªæ–‡ç« çš„çˆ¬å–ï¼Œå¹¶åˆ©ç”¨å·¥å…·å°†å…¶è½¬æ¢ä¸ºpdfæ ¼å¼\n1.Bs4 1 2 3 4 5 6 bs4å°†å¤æ‚htmlæ–‡æ¡£è½¬æ¢æˆä¸€ä¸ªå¤æ‚çš„æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯pythonå¯¹è±¡ï¼Œæ‰€æœ‰å¯¹è±¡å¯ä»¥åˆ†ä¸º4ç§ -Tag -NavigableString -BeautifulSoup -Comment 1.1 analyze 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 #bs4åˆ†ææ–‡æ¡£ from bs4 import BeautifulSoup file = open(\u0026#34;./baidu.html\u0026#34;, \u0026#34;rb\u0026#34;) html = file.read() bs = BeautifulSoup(html, \u0026#34;html.parser\u0026#34;) print(type(bs.head))#\u0026lt;class \u0026#39;bs4.element.Tag\u0026#39;\u0026gt;æ ‡ç­¾åŠå…¶å†…å®¹ #1.tag æ ‡ç­¾åŠå†…å®¹ï¼šæ‹¿åˆ°å®ƒæ‰€æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªå†…å®¹ print(type(bs.title.string))#\u0026lt;class \u0026#39;bs4.element.NavigableString\u0026#39;\u0026gt;æ ‡ç­¾é‡Œçš„å†…å®¹ #2.NavigableStringæ ‡ç­¾é‡Œçš„å†…å®¹ print(type(bs.a.attrs))#\u0026lt;class \u0026#39;dict\u0026#39;\u0026gt;#\u0026lt;class \u0026#39;dict\u0026#39;\u0026gt; #3.æ ‡ç­¾å†…éƒ¨çš„å­—å…¸ä¿¡æ¯ print(type(bs))#\u0026lt;class \u0026#39;bs4.BeautifulSoup\u0026#39;\u0026gt; #4.è¡¨ç¤ºæ•´ä¸ªæ–‡æ¡£ print(type(bs.a.string))#\u0026lt;class \u0026#39;bs4.element.Comment\u0026#39;\u0026gt; #5.ç¬¬ä¸€ä¸ªaä¸­çš„æ³¨é‡Šé‡Œçš„å†…å®¹,ä¸åŒ…å«æ³¨é‡Šç¬¦å· 1.2 Traversal 1 2 3 4 5 6 7 #æ–‡æ¡£çš„éå† from bs4 import BeautifulSoup file = open(\u0026#34;./baidu.html\u0026#34;, \u0026#34;rb\u0026#34;) html = file.read().decode(\u0026#34;utf-8\u0026#34;) bs = BeautifulSoup(html, \u0026#34;html.parser\u0026#34;) print(bs.head.contents)#åˆ—è¡¨ç±»å‹ï¼Œå¯ä»¥ç”¨ä¸‹æ ‡è®¿é—® print(bs.head.contents[1]) 1.3 find 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 #æ–‡æ¡£æœç´¢ import re from bs4 import BeautifulSoup file = open(\u0026#34;./baidu.html\u0026#34;, \u0026#34;rb\u0026#34;) html = file.read().decode(\u0026#34;utf-8\u0026#34;) bs = BeautifulSoup(html, \u0026#34;html.parser\u0026#34;) #1.find_all() #æŸ¥æ‰¾ä¸å­—ç¬¦ä¸²å®Œå…¨åŒ¹é…çš„å†…å®¹ t_list=bs.find_all(\u0026#34;a\u0026#34;) for i in t_list: print(i) #æ‰€æœ‰\u0026lt;a\u0026gt;æ ‡ç­¾ä¸‹é¢çš„å†…å®¹ #2.search() #æ­£åˆ™è¡¨è¾¾å¼æ¥æœç´¢ t_list=bs.find_all(re.compile(\u0026#34;a\u0026#34;))#åŒ¹é…ä¸æ­£åˆ™è¡¨è¾¾å¼aæœ‰å…³çš„å…¨éƒ¨å†…å®¹ for i in t_list: print(i) #3.æ ¹æ®å‡½æ•°çš„è¦æ±‚æ¥æœç´¢ #è‡ªå®šä¹‰å‡½æ•°æŸ¥æ‰¾ def name_is_exists(tag): return tag.has_attr(\u0026#34;name\u0026#34;) t_list=bs.find_all(name_is_exists) for i in t_list: print(i) #4.kwargs å¯»æ‰¾id=\u0026#34;head\u0026#34;å†…çš„å…¨éƒ¨å†…å®¹ t_list=bs.find_all(id=\u0026#34;head\u0026#34;) for i in t_list: print(i) #5.æ–‡æœ¬å‚æ•° å¯»æ‰¾æ–‡æœ¬çš„å†…å®¹ t_list=bs.find_all(text=[\u0026#34;hao123\u0026#34;,\u0026#34;è´´å§\u0026#34;,\u0026#34;åœ°å›¾\u0026#34;]) t_list=bs.find_all(text=re.compile(\u0026#34;\\d\u0026#34;)) #å¯»æ‰¾ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼çš„é¡¹ç›®ï¼Œè¿™é‡Œæ˜¯å¯»æ‰¾æ‰€æœ‰æ•´æ•° for i in t_list: print(i) #6.limitå‚æ•° t_list=bs.find_all(\u0026#34;a\u0026#34;,limit=3) #åªæœç´¢ä¸‰ä¸ª for i in t_list: print(i) #7.cssé€‰æ‹©å™¨ t_list=bs.select(\u0026#39;title\u0026#39;) t_list=bs.select(\u0026#34;.mnav\u0026#34;)#å¯»æ‰¾ç±»å t_list=bs.select(\u0026#39;#u1\u0026#39;)#é€šè¿‡idæ¥æŸ¥æ‰¾ t_list=bs.select(\u0026#34;a[class=\u0026#39;bri\u0026#39;]\u0026#34;)#é€šè¿‡å±æ€§æ¥æŸ¥æ‰¾ t_list=bs.select(\u0026#34;head\u0026gt;title\u0026#34;)#é€šè¿‡å­æ ‡ç­¾æ¥æŸ¥æ‰¾ t_list=bs.select(\u0026#34;.mnav ~ .bri\u0026#34;)#é€šè¿‡å­æ ‡ç­¾æ¥æŸ¥æ‰¾ print(t_list[0].get_text())#è·å–æ–‡æœ¬ for i in t_list: print(i) 2. Re #æ­£åˆ™è¡¨è¾¾å¼ï¼šå­—ç¬¦ä¸²æ¨¡å¼ï¼ˆåˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ç¬¦åˆä¸€å®šæ ‡å‡†ï¼‰ import re #åˆ›å»ºæ¨¡å¼å¯¹è±¡\n2.1 new object 1 2 3 4 5 6 #search pat=re.compile(\u0026#34;AA\u0026#34;)#æ­¤å¤„çš„AAå±äºæ­£åˆ™è¡¨è¾¾å¼ ans=pat.search(\u0026#34;ABC\u0026#34;)#è¿™é‡Œçš„searchå†…éƒ¨å±äºè¢«æœç´¢çš„å†…å®¹ print(ans)#è¾“å‡ºNone ans2=pat.search(\u0026#34;AABCAA\u0026#34;)#ä¼˜å…ˆæ‰¾åˆ°ç¬¬ä¸€ä¸ªç»“æœ print(ans2)#è¾“å‡º\u0026lt;re.Match object; span=(3, 5), match=\u0026#39;AA\u0026#39;\u0026gt; 2.2 findall 1 2 3 #findall ans=re.findall(\u0026#34;a+\u0026#34;,\u0026#34;aaabc\u0026#34;)#å‰é¢æ˜¯æ­£åˆ™è¡¨è¾¾å¼ï¼Œåé¢æ˜¯å¾…æ±‚çš„ç»“æœ print(ans)#è¾“å‡º[\u0026#39;aaa\u0026#39;] 2.3 sub 1 2 3 4 #sub(1,2,3) ans=re.sub(\u0026#34;a\u0026#34;,\u0026#34;A\u0026#34;,\u0026#34;abcdcasd\u0026#34;)#å¯¹äºæœ€åä¸€ä¸ªè¡¨è¾¾å¼ï¼Œç”¨aæ¢æˆA print(ans) #å»ºè®®åœ¨æ­£åˆ™è¡¨è¾¾å¼ç§ï¼Œè¢«æ¯”è¾ƒçš„å­—ç¬¦å‰é¢åŠ ä¸Šrï¼Œä¸ç”¨æ‹…å¿ƒè½¬ä¹‰å­—ç¬¦çš„é—®é¢˜ 2.4 demo 1ã€åŒ¹é…ä¸­æ–‡:[\\u4e00-\\u9fa5]\n2ã€è‹±æ–‡å­—æ¯:[a-zA-Z]\n3ã€æ•°å­—:[0-9]\n4ã€åŒ¹é…ä¸­æ–‡ï¼Œè‹±æ–‡å­—æ¯å’Œæ•°å­—åŠä¸‹åˆ’çº¿ï¼š^[\\u4e00-\\u9fa5_a-zA-Z0-9]+$ åŒæ—¶åˆ¤æ–­è¾“å…¥é•¿åº¦ï¼š [\\u4e00-\\u9fa5_a-zA-Z0-9_]{4,10}\n5ã€ (?!)ã€€ä¸èƒ½ä»¥_å¼€å¤´ (?!.*?$)ã€€ä¸èƒ½ä»¥_ç»“å°¾ [a-zA-Z0-9_\\u4e00-\\u9fa5]+ã€€è‡³å°‘ä¸€ä¸ªæ±‰å­—ã€æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ $ã€€ä¸å­—ç¬¦ä¸²ç»“æŸçš„åœ°æ–¹åŒ¹é…\n6ã€åªå«æœ‰æ±‰å­—ã€æ•°å­—ã€å­—æ¯ã€ä¸‹åˆ’çº¿ï¼Œä¸‹åˆ’çº¿ä½ç½®ä¸é™ï¼š ^[a-zA-Z0-9_\\u4e00-\\u9fa5]+$\n7ã€ç”±æ•°å­—ã€26ä¸ªè‹±æ–‡å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿ç»„æˆçš„å­—ç¬¦ä¸² ^\\w+$\n8ã€2~4ä¸ªæ±‰å­— \u0026ldquo;^[\\u4E00-\\u9FA5]{2,4}$\u0026rdquo;;\n9ã€æœ€é•¿ä¸å¾—è¶…è¿‡7ä¸ªæ±‰å­—ï¼Œæˆ–14ä¸ªå­—èŠ‚(æ•°å­—ï¼Œå­—æ¯å’Œä¸‹åˆ’çº¿)æ­£åˆ™è¡¨è¾¾å¼ ^[\\u4e00-\\u9fa5]{1,7}$|^[\\dA-Za-z_]{1,14}$\n10ã€åŒ¹é…åŒå­—èŠ‚å­—ç¬¦(åŒ…æ‹¬æ±‰å­—åœ¨å†…)ï¼š[^x00-xff] è¯„æ³¨ï¼šå¯ä»¥ç”¨æ¥è®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦ï¼ˆä¸€ä¸ªåŒå­—èŠ‚å­—ç¬¦é•¿åº¦è®¡2ï¼ŒASCIIå­—ç¬¦è®¡1ï¼‰\n11ã€åŒ¹é…ç©ºç™½è¡Œçš„æ­£åˆ™è¡¨è¾¾å¼ï¼šns*r è¯„æ³¨ï¼šå¯ä»¥ç”¨æ¥åˆ é™¤ç©ºç™½è¡Œ\n12ã€åŒ¹é…HTMLæ ‡è®°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š\u0026lt;(S*?)[^\u0026gt;]\u0026gt;.?|\u0026lt;.*? /\u0026gt; è¯„æ³¨ï¼šç½‘ä¸Šæµä¼ çš„ç‰ˆæœ¬å¤ªç³Ÿç³•ï¼Œä¸Šé¢è¿™ä¸ªä¹Ÿä»…ä»…èƒ½åŒ¹é…éƒ¨åˆ†ï¼Œå¯¹äºå¤æ‚çš„åµŒå¥—æ ‡è®°ä¾æ—§æ— èƒ½ä¸ºåŠ›\n13ã€åŒ¹é…é¦–å°¾ç©ºç™½å­—ç¬¦çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š^s*|s*$ è¯„æ³¨ï¼šå¯ä»¥ç”¨æ¥åˆ é™¤è¡Œé¦–è¡Œå°¾çš„ç©ºç™½å­—ç¬¦(åŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦ç­‰ç­‰)ï¼Œéå¸¸æœ‰ç”¨çš„è¡¨è¾¾å¼\n14ã€åŒ¹é…Emailåœ°å€çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š^[a-zA-Z0-9][\\w.-][a-zA-Z0-9]@[a-zA-Z0-9][\\w.-][a-zA-Z0-9].[a-zA-Z][a-zA-Z.]*[a-zA-Z]$\nè¯„æ³¨ï¼šè¡¨å•éªŒè¯æ—¶å¾ˆå®ç”¨\n15ã€æ‰‹æœºå·ï¼š^((13[0-9])|(14[0-9])|(15[0-9])|(17[0-9])|(18[0-9]))\\d{8}$\n16ã€èº«ä»½è¯ï¼š(^\\d{15}$)|(^\\d{17}([0-9]|X|x)$)\n17ã€åŒ¹é…ç½‘å€URLçš„æ­£åˆ™è¡¨è¾¾å¼ï¼š[a-zA-z]+://[^s]* è¯„æ³¨ï¼šç½‘ä¸Šæµä¼ çš„ç‰ˆæœ¬åŠŸèƒ½å¾ˆæœ‰é™ï¼Œä¸Šé¢è¿™ä¸ªåŸºæœ¬å¯ä»¥æ»¡è¶³éœ€æ±‚\n18ã€åŒ¹é…å¸å·æ˜¯å¦åˆæ³•(å­—æ¯å¼€å¤´ï¼Œå…è®¸5-16å­—èŠ‚ï¼Œå…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿)ï¼š^[a-zA-Z][a-zA-Z0-9_]{4,15}$ è¯„æ³¨ï¼šè¡¨å•éªŒè¯æ—¶å¾ˆå®ç”¨\n19ã€åŒ¹é…å›½å†…ç”µè¯å·ç ï¼šd{3}-d{8}|d{4}-d{7} è¯„æ³¨ï¼šåŒ¹é…å½¢å¼å¦‚ 0511-4405222 æˆ– 021-87888822\n20ã€åŒ¹é…è…¾è®¯QQå·ï¼š[1-9][0-9]{4,} è¯„æ³¨ï¼šè…¾è®¯QQå·ä»10000å¼€å§‹\n21ã€åŒ¹é…ä¸­å›½é‚®æ”¿ç¼–ç ï¼š[1-9]d{5}(?!d) è¯„æ³¨ï¼šä¸­å›½é‚®æ”¿ç¼–ç ä¸º6ä½æ•°å­—\n22ã€åŒ¹é…èº«ä»½è¯ï¼šd{15}|d{18} è¯„æ³¨ï¼šä¸­å›½çš„èº«ä»½è¯ä¸º15ä½æˆ–18ä½\n23ã€åŒ¹é…ipåœ°å€ï¼šd+.d+.d+.d+ è¯„æ³¨ï¼šæå–ipåœ°å€æ—¶æœ‰ç”¨\n24ã€åŒ¹é…ç‰¹å®šæ•°å­—ï¼š ^[1-9]d*$ã€€//åŒ¹é…æ­£æ•´æ•° ^-[1-9]d*$ //åŒ¹é…è´Ÿæ•´æ•° ^-?[1-9]d*$ã€€//åŒ¹é…æ•´æ•° ^[1-9]d*|0$ã€€//åŒ¹é…éè´Ÿæ•´æ•°ï¼ˆæ­£æ•´æ•° + 0ï¼‰ ^-[1-9]d*|0$ã€€//åŒ¹é…éæ­£æ•´æ•°ï¼ˆè´Ÿæ•´æ•° + 0ï¼‰ ^[1-9]d*.d*|0.d*[1-9]d*$ã€€//åŒ¹é…æ­£æµ®ç‚¹æ•° ^-([1-9]d*.d*|0.d*[1-9]d*)$ã€€//åŒ¹é…è´Ÿæµ®ç‚¹æ•° ^-?([1-9]d*.d*|0.d*[1-9]d*|0?.0+|0)$ã€€//åŒ¹é…æµ®ç‚¹æ•° ^[1-9]d*.d*|0.d*[1-9]d*|0?.0+|0$ã€€//åŒ¹é…éè´Ÿæµ®ç‚¹æ•°ï¼ˆæ­£æµ®ç‚¹æ•° + 0ï¼‰ ^(-([1-9]d*.d*|0.d*[1-9]d*))|0?.0+|0$ã€€//åŒ¹é…éæ­£æµ®ç‚¹æ•°ï¼ˆè´Ÿæµ®ç‚¹æ•° + 0ï¼‰ è¯„æ³¨ï¼šå¤„ç†å¤§é‡æ•°æ®æ—¶æœ‰ç”¨ï¼Œå…·ä½“åº”ç”¨æ—¶æ³¨æ„ä¿®æ­£\n25ã€åŒ¹é…ç‰¹å®šå­—ç¬¦ä¸²ï¼š ^[A-Za-z]+$ã€€//åŒ¹é…ç”±26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸² ^[A-Z]+$ã€€//åŒ¹é…ç”±26ä¸ªè‹±æ–‡å­—æ¯çš„å¤§å†™ç»„æˆçš„å­—ç¬¦ä¸² ^[a-z]+$ã€€//åŒ¹é…ç”±26ä¸ªè‹±æ–‡å­—æ¯çš„å°å†™ç»„æˆçš„å­—ç¬¦ä¸² ^[A-Za-z0-9]+$ã€€//åŒ¹é…ç”±æ•°å­—å’Œ26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸² ^w+$ã€€//åŒ¹é…ç”±æ•°å­—ã€26ä¸ªè‹±æ–‡å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿ç»„æˆçš„å­—ç¬¦ä¸²\n26ã€ åœ¨ä½¿ç”¨RegularExpressionValidatoréªŒè¯æ§ä»¶æ—¶çš„éªŒè¯åŠŸèƒ½åŠå…¶éªŒè¯è¡¨è¾¾å¼ä»‹ç»å¦‚ä¸‹: åªèƒ½è¾“å…¥æ•°å­—ï¼šâ€œ^[0-9]$â€ åªèƒ½è¾“å…¥nä½çš„æ•°å­—ï¼šâ€œ^d{n}$â€ åªèƒ½è¾“å…¥è‡³å°‘nä½æ•°å­—ï¼šâ€œ^d{n,}$â€ åªèƒ½è¾“å…¥m-nä½çš„æ•°å­—ï¼šâ€œ^d{m,n}$â€ åªèƒ½è¾“å…¥é›¶å’Œéé›¶å¼€å¤´çš„æ•°å­—ï¼šâ€œ^(0|[1-9][0-9])$â€ åªèƒ½è¾“å…¥æœ‰ä¸¤ä½å°æ•°çš„æ­£å®æ•°ï¼šâ€œ^[0-9]+(.[0-9]{2})?$â€ åªèƒ½è¾“å…¥æœ‰1-3ä½å°æ•°çš„æ­£å®æ•°ï¼šâ€œ^[0-9]+(.[0-9]{1,3})?$â€ åªèƒ½è¾“å…¥éé›¶çš„æ­£æ•´æ•°ï¼šâ€œ^+?[1-9][0-9]$â€ åªèƒ½è¾“å…¥éé›¶çš„è´Ÿæ•´æ•°ï¼šâ€œ^-[1-9][0-9]$â€ åªèƒ½è¾“å…¥é•¿åº¦ä¸º3çš„å­—ç¬¦ï¼šâ€œ^.{3}$â€ åªèƒ½è¾“å…¥ç”±26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ï¼šâ€œ^[A-Za-z]+$â€ åªèƒ½è¾“å…¥ç”±26ä¸ªå¤§å†™è‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ï¼šâ€œ^[A-Z]+$â€ åªèƒ½è¾“å…¥ç”±26ä¸ªå°å†™è‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ï¼šâ€œ^[a-z]+$â€ åªèƒ½è¾“å…¥ç”±æ•°å­—å’Œ26ä¸ªè‹±æ–‡å­—æ¯ç»„æˆçš„å­—ç¬¦ä¸²ï¼šâ€œ^[A-Za-z0-9]+$â€ åªèƒ½è¾“å…¥ç”±æ•°å­—ã€26ä¸ªè‹±æ–‡å­—æ¯æˆ–è€…ä¸‹åˆ’çº¿ç»„æˆçš„å­—ç¬¦ä¸²ï¼šâ€œ^w+$â€ éªŒè¯ç”¨æˆ·å¯†ç :â€œ^[a-zA-Z]w{5,17}$â€æ­£ç¡®æ ¼å¼ä¸ºï¼šä»¥å­—æ¯å¼€å¤´ï¼Œé•¿åº¦åœ¨6-18ä¹‹é—´ï¼Œ åªèƒ½åŒ…å«å­—ç¬¦ã€æ•°å­—å’Œä¸‹åˆ’çº¿ã€‚ éªŒè¯æ˜¯å¦å«æœ‰^%\u0026amp;\u0026rsquo;,;=?$\u0026ldquo;ç­‰å­—ç¬¦ï¼šâ€œ[^%\u0026amp;\u0026rsquo;,;=?$x22]+â€ åªèƒ½è¾“å…¥æ±‰å­—ï¼šâ€œ^[u4e00-u9fa5],{0,}$â€ éªŒè¯Emailåœ°å€ï¼šâ€œ^w+[-+.]w+)@w+([-.]w+).w+([-.]w+)$â€ éªŒè¯InternetURLï¼šâ€œ^http://([w-]+.)+[w-]+(/[w-./?%\u0026amp;=])?$â€ éªŒè¯èº«ä»½è¯å·ï¼ˆ15ä½æˆ–18ä½æ•°å­—ï¼‰ï¼šâ€œ^d{15}|d{}18$â€ éªŒè¯ä¸€å¹´çš„12ä¸ªæœˆï¼šâ€œ^(0?[1-9]|1[0-2])$â€æ­£ç¡®æ ¼å¼ä¸ºï¼šâ€œ01â€-â€œ09â€å’Œâ€œ1â€â€œ12â€ éªŒè¯ä¸€ä¸ªæœˆçš„31å¤©ï¼šâ€œ^((0?[1-9])|((1|2)[0-9])|30|31)$â€ æ­£ç¡®æ ¼å¼ä¸ºï¼šâ€œ01â€â€œ09â€å’Œâ€œ1â€â€œ31â€ã€‚ åŒ¹é…ä¸­æ–‡å­—ç¬¦çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š [u4e00-u9fa5] åŒ¹é…åŒå­—èŠ‚å­—ç¬¦(åŒ…æ‹¬æ±‰å­—åœ¨å†…)ï¼š[^x00-xff] åŒ¹é…ç©ºè¡Œçš„æ­£åˆ™è¡¨è¾¾å¼ï¼šn[s| ]r åŒ¹é…HTMLæ ‡è®°çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š/\u0026lt;(.)\u0026gt;.|\u0026lt;(.) /\u0026gt;/ åŒ¹é…é¦–å°¾ç©ºæ ¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼š(^s*)|(s*$) åŒ¹é…Emailåœ°å€çš„æ­£åˆ™è¡¨è¾¾å¼ï¼šw+([-+.]w+)@w+([-.]w+).w+([-.]w+)* åŒ¹é…ç½‘å€URLçš„æ­£åˆ™è¡¨è¾¾å¼ï¼šhttp://([w-]+.)+[w-]+(/[w- ./?%\u0026amp;=]*)?\n3. Urllib 3.1 get 1 2 3 4 5 6 7 import urllib.request #1ã€è·å–ä¸€ä¸ªgetè¯·æ±‚ try: responce = urllib.request.urlopen(\u0026#34;http://httpbin.org/get\u0026#34;,timeout=0.01) print(responce.read().decode(\u0026#39;utf-8\u0026#39;)) #å¯¹è·å–åˆ°çš„ç½‘é¡µæºç è¿›è¡Œutf-8è§£ç  except urllib.error.URLError as e: print(\u0026#34;time out\u0026#34;) #è¶…æ—¶å¤„ç† 3.2 post 1 2 3 4 5 6 7 8 9 10 #2ã€è·å–ä¸€ä¸ªpostè¯·æ±‚ import urllib.parse data = bytes(urllib.parse.urlencode({\u0026#34;hello\u0026#34;: \u0026#34;world\u0026#34;}), encoding=\u0026#34;utf-8\u0026#34;) response = urllib.request.urlopen(\u0026#34;http://httpbin.org/post\u0026#34;,data = data) print(response.read().decode(\u0026#34;utf-8\u0026#34;)) responce = urllib.request.urlopen(\u0026#34;http://www.baidu.com\u0026#34;) print(responce.status) #è·å–çŠ¶æ€ç  print(responce.getheaders()) #è·å–å…¨éƒ¨ä¿¡æ¯ print(responce.getheader(\u0026#34;Server\u0026#34;)) #è·å–å…¨éƒ¨ä¿¡æ¯ 3.3 418 error 1 2 3 4 5 6 7 8 9 #3ã€postè¯·æ±‚ï¼Œå418 url=\u0026#34;http://httpbin.org/post\u0026#34; headers={ \u0026#34;User-Agent\u0026#34; : \u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 Edg/84.0.522.44\u0026#34; } data = bytes(urllib.parse.urlencode({\u0026#34;hello\u0026#34;:\u0026#34;world\u0026#34;}), encoding=\u0026#34;utf-8\u0026#34;) req=urllib.request.Request(url=url, data=data, headers=headers, method=\u0026#34;POST\u0026#34;) response=urllib.request.urlopen(req) print(response.read().decode(\u0026#34;utf-8\u0026#34;)) 3.4 test 1 2 3 4 5 6 7 8 9 #4ã€çˆ¬å–è±†ç“£ url=\u0026#34;https://www.douban.com\u0026#34; headers={ \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 Edg/84.0.522.44\u0026#34; } data = bytes(urllib.parse.urlencode({\u0026#34;hello\u0026#34;:\u0026#34;world\u0026#34;}), encoding=\u0026#34;utf-8\u0026#34;) req=urllib.request.Request(url=url, headers=headers) response=urllib.request.urlopen(req) print(response.read().decode(\u0026#34;utf-8\u0026#34;)) 4. Xwlt 4.1 new 1 2 3 4 5 6 7 8 9 import xlwt workbook = xlwt.Workbook(encoding=\u0026#34;utf-8\u0026#34;)#åˆ›å»ºå¯¹è±¡ worksheet = workbook.add_sheet(\u0026#39;sheet1\u0026#39;)#åˆ›å»ºå·¥ä½œè¡¨ for i in range(1,10): for j in range(1,i+1): worksheet.write(i-1, j-1, \u0026#39;%d*%d=%d\u0026#39;%(i,j,i*j)) # è¡Œ,åˆ—ï¼Œå†…å®¹ workbook.save(\u0026#34;student.xls\u0026#34;) 5. Release 5.1 Top250 çˆ¬å–è±†ç“£ç”µå½±Top250ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨sqlæ•°æ®åº“ä¸­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 #-*- coding = utf-8 -*- #@Time : 2020/10/6 21:00 #@Author : chasing #@File : spyder.py #@Software: PyCharm from bs4 import BeautifulSoup # ç½‘é¡µè§£æï¼Œè·å–æ•°æ® import re # æ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿›è¡Œæ–‡å­—åŒ¹é… import urllib.request import urllib.error # åˆ¶å®šURLï¼Œè·å–ç½‘é¡µæ•°æ® import xlwt # è¿›è¡Œexcelæ“ä½œ import sqlite3 # è¿›è¡ŒSQLiteæ•°æ®åº“æ“ä½œ def main(): baseurl = \u0026#34;https://movie.douban.com/top250?start=\u0026#34; # 1.çˆ¬å–ç½‘é¡µ datalist = getData(baseurl) #savepath = \u0026#34;è±†ç“£ç”µå½±Top250.xls\u0026#34; dbpath = \u0026#34;movie.db\u0026#34; # 3.ä¿å­˜æ•°æ® # saveData(datalist,savepath) saveData2DB(datalist, dbpath) # askURL(\u0026#34;https://movie.douban.com/top250?start=\u0026#34;) # å½±ç‰‡è¯¦æƒ…é“¾æ¥çš„è§„åˆ™ findLink = re.compile(r\u0026#39;\u0026lt;a href=\u0026#34;(.*?)\u0026#34;\u0026gt;\u0026#39;) # åˆ›å»ºæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡ï¼Œè¡¨ç¤ºè§„åˆ™ï¼ˆå­—ç¬¦ä¸²çš„æ¨¡å¼ï¼‰ # å½±ç‰‡å›¾ç‰‡ findImgSrc = re.compile(r\u0026#39;\u0026lt;img.*src=\u0026#34;(.*?)\u0026#34;\u0026#39;, re.S) # re.S è®©æ¢è¡Œç¬¦åŒ…å«åœ¨å­—ç¬¦ä¸­ # å½±ç‰‡ç‰‡å findTitle = re.compile(r\u0026#39;\u0026lt;span class=\u0026#34;title\u0026#34;\u0026gt;(.*)\u0026lt;/span\u0026gt;\u0026#39;) # å½±ç‰‡è¯„åˆ† findRating = re.compile( r\u0026#39;\u0026lt;span class=\u0026#34;rating_num\u0026#34; property=\u0026#34;v:average\u0026#34;\u0026gt;(.*)\u0026lt;/span\u0026gt;\u0026#39;) # æ‰¾åˆ°è¯„ä»·äººæ•° findJudge = re.compile(r\u0026#39;\u0026lt;span\u0026gt;(\\d*)äººè¯„ä»·\u0026lt;/span\u0026gt;\u0026#39;) # æ‰¾åˆ°æ¦‚å†µ findInq = re.compile(r\u0026#39;\u0026lt;span class=\u0026#34;inq\u0026#34;\u0026gt;(.*)\u0026lt;/span\u0026gt;\u0026#39;) # æ‰¾åˆ°å½±ç‰‡çš„ç›¸å…³å†…å®¹ findBd = re.compile(r\u0026#39;\u0026lt;p class=\u0026#34;\u0026#34;\u0026gt;(.*?)\u0026lt;/p\u0026gt;\u0026#39;, re.S) # çˆ¬å–ç½‘é¡µ def getData(baseurl): datalist = [] for i in range(0, 10): # è°ƒç”¨è·å–é¡µé¢ä¿¡æ¯çš„å‡½æ•°ï¼Œ10æ¬¡ url = baseurl + str(i*25) html = askURL(url) # ä¿å­˜è·å–åˆ°çš„ç½‘é¡µæºç  # 2.é€ä¸€è§£ææ•°æ® soup = BeautifulSoup(html, \u0026#34;html.parser\u0026#34;) for item in soup.find_all(\u0026#39;div\u0026#39;, class_=\u0026#34;item\u0026#34;): #æŸ¥æ‰¾ç¬¦åˆè¦æ±‚çš„å­—ç¬¦ä¸²ï¼Œå½¢æˆåˆ—è¡¨ # print(item) #æµ‹è¯•ï¼šæŸ¥çœ‹ç”µå½±itemå…¨éƒ¨ä¿¡æ¯ data = [] # ä¿å­˜ä¸€éƒ¨ç”µå½±çš„æ‰€æœ‰ä¿¡æ¯ item = str(item) # å½±ç‰‡è¯¦æƒ…çš„é“¾æ¥ link = re.findall(findLink, item)[0] # reåº“ç”¨æ¥é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾æŒ‡å®šçš„å­—ç¬¦ä¸² data.append(link) # æ·»åŠ é“¾æ¥ imgSrc = re.findall(findImgSrc, item)[0] data.append(imgSrc) # æ·»åŠ å›¾ç‰‡ titles = re.findall(findTitle, item) # ç‰‡åå¯èƒ½åªæœ‰ä¸€ä¸ªä¸­æ–‡åï¼Œæ²¡æœ‰å¤–å›½å if(len(titles) == 2): ctitle = titles[0] # æ·»åŠ ä¸­æ–‡å data.append(ctitle) otitle = titles[1].replace(\u0026#34;/\u0026#34;, \u0026#34;\u0026#34;) # å»æ‰æ— å…³çš„ç¬¦å· data.append(otitle) # æ·»åŠ å¤–å›½å else: data.append(titles[0]) data.append(\u0026#39; \u0026#39;) # å¤–å›½åå­—ç•™ç©º rating = re.findall(findRating, item)[0] data.append(rating) # æ·»åŠ è¯„åˆ† judgeNum = re.findall(findJudge, item)[0] data.append(judgeNum) # æåŠ è¯„ä»·äººæ•° inq = re.findall(findInq, item) if len(inq) != 0: inq = inq[0].replace(\u0026#34;ã€‚\u0026#34;, \u0026#34;\u0026#34;) # å»æ‰å¥å· data.append(inq) # æ·»åŠ æ¦‚è¿° else: data.append(\u0026#34; \u0026#34;) # ç•™ç©º bd = re.findall(findBd, item)[0] bd = re.sub(\u0026#39;\u0026lt;br(\\s+)?/\u0026gt;(\\s+)?\u0026#39;, \u0026#34; \u0026#34;, bd) # å»æ‰\u0026lt;br/\u0026gt; bd = re.sub(\u0026#39;/\u0026#39;, \u0026#34; \u0026#34;, bd) # æ›¿æ¢/ data.append(bd.strip()) # å»æ‰å‰åçš„ç©ºæ ¼ datalist.append(data) # æŠŠå¤„ç†å¥½çš„ä¸€éƒ¨ç”µå½±ä¿¡æ¯æ”¾å…¥datalist return datalist # å¾—åˆ°æŒ‡å®šä¸€ä¸ªURLçš„ç½‘é¡µå†…å®¹ def askURL(url): head = { # æ¨¡æ‹Ÿæµè§ˆå™¨å¤´éƒ¨ä¿¡æ¯ï¼Œå‘è±†ç“£æœåŠ¡å™¨å‘é€æ¶ˆæ¯ \u0026#34;User-Agent\u0026#34;: \u0026#34;Mozilla / 5.0(Windows NT 10.0; Win64; x64) AppleWebKit / 537.36(KHTML, like Gecko) Chrome / 80.0.3987.122 Safari / 537.36\u0026#34; } # ç”¨æˆ·ä»£ç†ï¼Œè¡¨ç¤ºå‘Šè¯‰è±†ç“£æœåŠ¡å™¨ï¼Œæˆ‘ä»¬æ˜¯ä»€ä¹ˆç±»å‹çš„æœºå™¨ã€æµè§ˆå™¨ï¼ˆæœ¬è´¨ä¸Šæ˜¯å‘Šè¯‰æµè§ˆå™¨ï¼Œæˆ‘ä»¬å¯ä»¥æ¥æ”¶ä»€ä¹ˆæ°´å¹³çš„æ–‡ä»¶å†…å®¹ï¼‰ request = urllib.request.Request(url, headers=head) html = \u0026#34;\u0026#34; try: response = urllib.request.urlopen(request) html = response.read().decode(\u0026#34;utf-8\u0026#34;) # print(html) except urllib.error.URLError as e: if hasattr(e, \u0026#34;code\u0026#34;): print(e.code) if hasattr(e, \u0026#34;reason\u0026#34;): print(e.reason) return html # ä¿å­˜æ•°æ® def saveData(datalist, savepath): print(\u0026#34;save....\u0026#34;) book = xlwt.Workbook(encoding=\u0026#34;utf-8\u0026#34;, style_compression=0) # åˆ›å»ºworkbookå¯¹è±¡ sheet = book.add_sheet(\u0026#39;è±†ç“£ç”µå½±Top250\u0026#39;, cell_overwrite_ok=True) # åˆ›å»ºå·¥ä½œè¡¨ col = (\u0026#34;ç”µå½±è¯¦æƒ…é“¾æ¥\u0026#34;, \u0026#34;å›¾ç‰‡é“¾æ¥\u0026#34;, \u0026#34;å½±ç‰‡ä¸­æ–‡å\u0026#34;, \u0026#34;å½±ç‰‡å¤–å›½å\u0026#34;, \u0026#34;è¯„åˆ†\u0026#34;, \u0026#34;è¯„ä»·æ•°\u0026#34;, \u0026#34;æ¦‚å†µ\u0026#34;, \u0026#34;ç›¸å…³ä¿¡æ¯\u0026#34;) for i in range(0, 8): sheet.write(0, i, col[i]) # åˆ—å for i in range(0, 250): print(\u0026#34;ç¬¬%dæ¡\u0026#34; % (i+1)) data = datalist[i] for j in range(0, 8): sheet.write(i+1, j, data[j]) # æ•°æ® book.save(savepath) # ä¿å­˜ def saveData2DB(datalist, dbpath): init_db(dbpath) conn = sqlite3.connect(dbpath) cur = conn.cursor() for data in datalist: for index in range(len(data)): if index == 4 or index == 5: continue data[index] = \u0026#39;\u0026#34;\u0026#39;+data[index]+\u0026#39;\u0026#34;\u0026#39; sql = \u0026#39;\u0026#39;\u0026#39; insert into movie250 ( info_link,pic_link,cname,ename,score,rated,instroduction,info) values(%s)\u0026#39;\u0026#39;\u0026#39; % \u0026#34;,\u0026#34;.join(data) print(sql) cur.execute(sql) conn.commit() cur.close() conn.close() def init_db(dbpath): sql = \u0026#39;\u0026#39;\u0026#39; create table movie250 ( id integer primary key autoincrement, info_link text, pic_link text, cname varchar, ename varchar, score numeric , rated numeric , instroduction text, info text ) \u0026#39;\u0026#39;\u0026#39; # åˆ›å»ºæ•°æ®è¡¨ conn = sqlite3.connect(dbpath) cursor = conn.cursor() cursor.execute(sql) conn.commit() conn.close() if __name__ == \u0026#34;__main__\u0026#34;: # å½“ç¨‹åºæ‰§è¡Œæ—¶ # è°ƒç”¨å‡½æ•° main() # init_db(\u0026#34;movietest.db\u0026#34;) print(\u0026#34;çˆ¬å–å®Œæ¯•ï¼\u0026#34;) 6. CSDN 6.1 for a certain passage å¯¹äºä¸€ä¸ªåšä¸»çš„ç¡®åˆ‡çš„æ–‡ç« é“¾æ¥ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç çˆ¬å–å…¶ä¸­çš„æ–‡ç« å†…å®¹ï¼Œå¹¶ä¿å­˜ä¸ºpdfæ ¼å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 #-*- coding = utf-8 -*- #@Time : 2020-10-12 18:08 #@Author : chasing #@File : csdn.py #@Software: PyCharm import re import requests import parsel import pdfkit BaseUrl=\u0026#39;https://blog.csdn.net/justidle/article/details/106850487\u0026#39; cmp=re.compile(r\u0026#39;\u0026lt;meta name=\u0026#34;keywords\u0026#34; content=\u0026#34;(.*?)\u0026#34;\u0026gt;\u0026#39;, re.S) headers = {\u0026#39;User-Agent\u0026#39;: \u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38\u0026#39;} response = requests.get(BaseUrl, headers=headers) print(\u0026#34;å“åº”ä½“ï¼š\u0026#34;+response.text) Title=re.findall(cmp,response.text) FileUrl=\u0026#39;D:\\\\desktop\\\\\u0026#39;+\u0026#39; \u0026#39;.join(Title)+\u0026#39;.pdf\u0026#39; print(\u0026#34;æœŸæœ›ä¿å­˜ä½ç½®ï¼š\u0026#34;+FileUrl) Html1=r\u0026#39;\u0026lt;!doctype html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt;\u0026lt;title\u0026gt;\u0026#39; Html2=r\u0026#39;\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;{content}\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#39; html=Html1+\u0026#39; \u0026#39;.join(Title)+Html2 selector = parsel.Selector(response.text) article = selector.css(\u0026#39;article\u0026#39;).get() print(\u0026#34;æ–‡ç« æœ¬ä½“ï¼š\u0026#34;+article) with open(\u0026#39;1.html\u0026#39;, mode=\u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: f.write(html.format(content=article)) config = pdfkit.configuration(wkhtmltopdf=\u0026#39;E:\\\\wkhtmltopdf\\\\bin\\\\wkhtmltopdf.exe\u0026#39;) pdfkit.from_file(\u0026#34;1.html\u0026#34;,FileUrl,configuration=config) print(\u0026#34;æ–‡ä»¶ä¿å­˜æˆåŠŸï¼Œä¿å­˜æ–‡ä»¶çš„è·¯å¾„ä¸ºï¼š\u0026#34;+FileUrl) print(\u0026#34;Hello World!\u0026#34;) 6.2 All passages å¯¹äºåšä¸»çš„å…¨éƒ¨æ–‡ç« ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ï¼Œè·å–å…¶æ‰€æœ‰æ–‡ç« çš„é“¾æ¥\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 #-*- coding = utf-8 -*- #@Time : 2020-10-12 20:09 #@Author : chasing #@File : Release.py #@Software: PyCharm #å¯¼å…¥ç›¸åº”çš„æ¨¡å— import re import requests import parsel import pdfkit def main(): # Pages=askPages(BaseUrl) # print(Pages) i=1 askUrl(baseUrl, i) for i in range(2,100,1): tempUrl = baseUrl+str(i) askUrl(tempUrl, i) Response() findChinese=re.compile(r\u0026#39;[\\u4e00-\\u9fa5]+\u0026#39;,re.S)#pdfkitä¸èƒ½èƒ½ä¿å­˜å«æœ‰ç‰¹æ®Šç¬¦å·åç§°çš„æ–‡ä»¶ findBranch=re.compile(r\u0026#39;\u0026lt;a href=\u0026#34;(.*?)\u0026#34; target=\u0026#34;_blank\u0026#34;\u0026gt;\u0026#39;) findFile=re.compile(r\u0026#39;\u0026lt;meta name=\u0026#34;keywords\u0026#34; content=\u0026#34;(.*?)\u0026#34;\u0026gt;\u0026#39;, re.S) # findPages=re.compile(r\u0026#39;\u0026lt;li data-page=\u0026#34;(\\d+)\u0026#34; class=\u0026#34;ui-pager\u0026#34;\u0026gt;.*?\u0026lt;/li\u0026gt;\u0026#39;,re.S) headers = { \u0026#34;user-agent\u0026#34;:\u0026#34;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.75 Safari/537.36 Edg/86.0.622.38\u0026#34; } baseUrl=\u0026#39;https://blog.csdn.net/qq_27133869\u0026#39; # é¡µé¢æ•°é‡ä¸ºåŠ¨æ€ # def askPages(BaseUrl):#js # response = requests.get(BaseUrl, headers=headers) # print(response.text) # Pages = re.findall(FindPages, response.text) # return Pages def askUrl(baseUrl,i): baseResponse = requests.get(baseUrl, headers=headers) # print(baseResponse.text) branchUrls=re.findall(findBranch,baseResponse.text) assert branchUrls for j in range(7): branchUrls.pop()#åˆ é™¤å¸®åŠ©æ–‡æ¡£ assert branchUrls#ä¸ºç©ºç›´æ¥è·³å‡ºï¼ŒèŠ‚çœèµ„æº # print(branchUrls) times=1 for BranchUrl in branchUrls: branchResponse = requests.get(BranchUrl, headers=headers) #ä¿å­˜çš„æ–‡ä»¶å tempTitle = \u0026#39;\u0026#39;.join(re.findall(findFile, branchResponse.text)) print(tempTitle) print(re.findall(findChinese, tempTitle)) finalTitle = \u0026#34; \u0026#34;.join(re.findall(findChinese, tempTitle)) print(\u0026#34;ç¬¬ %d é¢çš„ %d ç¯‡æ–‡ç« åä¸º:\u0026#34; %(i, times)+str(finalTitle)+\u0026#39;\\n\u0026#39;) #æœ€ç»ˆç½‘é¡µæºä»£ç  finalHtml =r\u0026#39;\u0026lt;!doctype html\u0026gt;\u0026lt;html\u0026gt;\u0026lt;head\u0026gt;\u0026lt;meta charset=\u0026#34;UTF-8\u0026#34;\u0026gt;\u0026lt;title\u0026gt;\u0026#39; + \u0026#39; \u0026#39;.join(finalTitle) + r\u0026#39;\u0026lt;/title\u0026gt;\u0026lt;/head\u0026gt;\u0026lt;body\u0026gt;{content}\u0026lt;/body\u0026gt;\u0026lt;/html\u0026gt;\u0026#39; #pdfæ–‡ä»¶çš„ä¿å­˜ä½ç½® fileUrl = \u0026#39;D:\\\\desktop\\\\CSDN\\\\littlePING\\\\\u0026#39; + \u0026#39;\u0026#39;.join(finalTitle) + \u0026#39;.pdf\u0026#39; print(\u0026#34;ç¬¬ %d é¢çš„ %d ç¯‡æ–‡ç« ä¿å­˜è·¯å¾„ä¸º:\u0026#34; %(i, times) + str(fileUrl) + \u0026#39;\\n\u0026#39;) selector = parsel.Selector(branchResponse.text) article = selector.css(\u0026#39;article\u0026#39;).get() #æ–‡ä»¶ä¿å­˜çš„ä½ç½® with open(\u0026#39;temp.html\u0026#39;, mode=\u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: f.write(finalHtml.format(content=article)) try: config = pdfkit.configuration(wkhtmltopdf=\u0026#39;E:\\\\wkhtmltopdf\\\\bin\\\\wkhtmltopdf.exe\u0026#39;) # config = pdfkit.configuration(wkhtmltopdf=path_wk) with open(\u0026#39;temp.html\u0026#39;, \u0026#39;r\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f: pdfkit.from_file(f, fileUrl, configuration=config) print(\u0026#34;ç¬¬ %d é¢çš„ %d ç¯‡æ–‡ç« pdfæ–‡ä»¶ä¿å­˜æˆåŠŸï¼\u0026#34; % (i, times)+\u0026#39;\\n\u0026#39;) except: print(\u0026#34;ç¬¬ %d é¢çš„ %d ç¯‡æ–‡ç« pdfæ–‡ä»¶ä¿å­˜å¤±è´¥ï¼\u0026#34; % (i, times)+\u0026#39;\\n\u0026#39;) pass # continue times+=1 print(\u0026#34;é¡µé¢ %d ä¸­çš„æ‰€æœ‰æ–‡ä»¶ä¿å­˜æˆåŠŸ\u0026#34;%i+\u0026#39;\\n\u0026#39;) def Response(): print(\u0026#34;Hello World\u0026#34;) if __name__ == \u0026#34;__main__\u0026#34;: # å½“ç¨‹åºæ‰§è¡Œæ—¶ # è°ƒç”¨å‡½æ•° main() ","date":"2020-10-12T20:12:03+08:00","image":"https://chasing1020.github.io/post/crawler-note/crawlers_huf70bc2f5d9712bf049a955dbeedbcb91_33366_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/crawler-note/","title":"Crawler Note"},{"content":"ç¬¬ä¸€ç« â€”â€”åŸºç¡€çŸ¥è¯† 1ã€æ¨¡å—çš„å¼•å…¥ 1 2 3 4 5 6 7 8 9 10 11 12 #demoï¼š # éšæœºæ•° #å¯¼å…¥import æ¨¡å— import random a=random.randint(1,5) #aæœ€ç»ˆè¢«èµ‹å€¼ä¸º1ï¼Œ2ï¼Œ3ï¼Œ4ï¼Œ5ä¹‹é—´çš„éšæœºä¸€ä¸ªæ•°ï¼Œå·¦é—­å³é—­ #è¿™é‡ŒåŒ…æ‹¬1å’Œ5ï¼ 2ã€æ•°æ®ç±»å‹ 1 2 3 4 5 6 7 8 9 10 11 #type() è·å–ä¿¡æ¯ #ä¾‹å¦‚ a=\u0026#39;520.0\u0026#39; b=float(a) type(a)#è¾“å‡º\u0026lt;class \u0026#39;str\u0026#39;\u0026gt; type(b)#è¾“å‡º\u0026lt;class \u0026#39;float\u0026#39;\u0026gt; #å‡½æ•°isinstance(var,class) #å¯¹æ¯”å‰åç±»å‹ isinstance(10,int)#è¾“å‡ºTrue å¼ºåˆ¶ç±»å‹è½¬æ¢\nä¸åŒäºC/C++çš„(int)aå’Œ(double)b\npyä¸­çš„å¼ºåˆ¶ç±»å‹è½¬æ¢çš„æ‹¬å·æ¡†ä½è¡¨è¾¾å¼\næ”¹ä¸º int(a)å’Œfloat(b)\n3ã€ç¬¦å·è¿ç®— + åŠ  - å‡ * ä¹˜ / é™¤ï¼Œä¼šè‡ªåŠ¨è½¬æ¢ä¸ºæµ®ç‚¹ç±»å‹ï¼Œä¸C/C++ä¸åŒ % å–ä½™ ** å¹‚è¿ç®—ï¼Œç­‰åŒäºè®¡ç®—å™¨ä¸­çš„^ï¼Œç»“æœä¸ºæµ®ç‚¹å‹æˆ–æ•´å½¢ï¼Œæ ¹æ®ç»“æœè€Œå®š // å¸¦ä½™é™¤æ³•ï¼Œå°±ç®—æ˜¯æµ®ç‚¹å‹è¿ç®—ä¹Ÿä¼šä¿ç•™æ•´æ•°éƒ¨åˆ†ï¼Œä¾‹å¦‚3.0//2=1.0 4ã€é€»è¾‘è¿ç®— and ä¸ or æˆ– not é ä¸‰ç›®è¿ç®—ç¬¦\na= è¯­å¥1 if æ¡ä»¶ else è¯­å¥2 ä¾‹å¦‚:\n1 2 a=x if x\u0026lt;y else y #aèµ‹å€¼ä¸ºx,yä¸­å°çš„é‚£ä¸ª 5ã€å…¶ä½™å‡½æ•° assert: åŒC/C++çš„asset(æ–­è¨€)\nåŒC/C++ä¸€æ · assert 1\u0026gt;2 ç»“æœä¸ºFalseï¼Œç¨‹åºç›´æ¥ç»ˆæ­¢ ç¬¬äºŒç« â€”â€”å¾ªç¯ 1ã€forå¾ªç¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 #forå¾ªç¯ name = \u0026#34;chasing\u0026#34; a = [\u0026#34;aa\u0026#34;, \u0026#34;bb\u0026#34;, \u0026#34;cc\u0026#34;, \u0026#34;dd\u0026#34;] for i in range(5): #5è¡¨ç¤ºç»“æŸï¼Œ[0,5)ï¼Œå·¦é—­å³å¼€ print(i,end=\u0026#34;\u0026#34;)#end=\u0026#34;\u0026#34;è¡¨ç¤ºä¸æ¢è¡Œï¼Œåœ¨å¾ªç¯ç»“æŸä»¥åä¸æ‰§è¡Œä»»ä½•æ“ä½œ #è¾“å‡º01234 for i in range(1, 10): #ä»1åˆ°10ï¼Œ[1,10)ï¼Œä½†æ˜¯ä¸ä¼šåŒ…æ‹¬10ï¼Œå·¦é—­å³å¼€ print(i,end=\u0026#34;\u0026#34;) #è¾“å‡º123456789 for i in range(0, 100, 10):#for(int i=0;i\u0026lt;100;i+=10) #ä»1åˆ°100ï¼Œæ¯æ¬¡iå¢åŠ 10ï¼Œä½†æ˜¯ä¸ä¼šåŒ…æ‹¬100ï¼Œç›´åˆ°100è·³å‡ºå¾ªç¯ï¼Œå·¦é—­å³å¼€ print(i,end=\u0026#34;ï¼Œ\u0026#34;) #è¾“å‡º0ï¼Œ10ï¼Œ20ï¼Œ30ï¼Œ40ï¼Œ50ï¼Œ60ï¼Œ70ï¼Œ80ï¼Œ90ï¼Œ for i in name: #éå†å­—ç¬¦ä¸² print(i,end=\u0026#34;\u0026#34;) #è¾“å‡ºchasing for i in range(len(a)): #éå†æ¯ä¸€ä¸ªåˆ—è¡¨ print(a[i], end=\u0026#34;,\u0026#34;) #è¾“å‡ºaa,bb,cc,dd, 2ã€whileå¾ªç¯ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 #whileå¾ªç¯ count=0 while count\u0026lt;5: print(count,\u0026#34;å°äº5\u0026#34;) count+=1 if count\u0026gt;3: break else:#åªè¦è¿›å…¥whileå¾ªç¯ï¼Œæ­£å¸¸å‡ºæ¥ï¼Œæˆ–è€…æ²¡æœ‰è¿›å…¥whileå¾ªç¯ï¼Œåˆ™elseå†™ä¸å†™éƒ½ä¸€æ · #è§¦å‘else çš„å”¯ä¸€æƒ…å†µå°±æ˜¯whileé‡Œé¢æœ‰breakä¸”è¢«æ‰§è¡Œï¼ŒforåŒç† print(count,\u0026#34;å¤§äºæˆ–ç­‰äº5\u0026#34;) 3ã€breakå’Œcontinue break è·³å‡ºå¾ªç¯ continue è·³è¿‡å½“å‰å¾ªç¯ pass å ä½è¯­å¥ï¼Œç›¸å½“äºC/C++çš„;ï¼ˆç©ºè¯­å¥ï¼‰ï¼Œ ä¸åšä»»ä½•äº‹æƒ… æ ·ä¾‹1\n1 2 3 4 5 6 7 8 9 10 11 #è¾“å‡º2019åˆ°2100ç¬¬ä¸€ä¸ªé—°å¹´ for i in range(2019,2100): if (i%4==0) and (i%100!=0) or (i%400==0): break print(\u0026#34;2019-2100ç¬¬ä¸€ä¸ªé—°å¹´æ˜¯%d\u0026#34;%i) #2019-2100ç¬¬ä¸€ä¸ªé—°å¹´æ˜¯2020 æ ·ä¾‹2\n1 2 3 4 5 6 7 8 9 10 #æ‰“å°99ä¹˜æ³•è¡¨ for i in range(1,10): for j in range(1,i+1): print(\u0026#34;%d*%d=%d\u0026#34;%(i,j,i*j),end=\u0026#34; \u0026#34;) print(\u0026#34;\\n\u0026#34;) ç¬¬ä¸‰ç« â€”â€”å­—ç¬¦ä¸² æ³¨æ„ï¼Œpython3é»˜è®¤æ˜¯utf-8ç¼–ç ã€‚å­—ç¬¦ä¸²éƒ½æ˜¯unicodeå­—ç¬¦ä¸²ã€‚\nå­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨å•å¼•å·ï¼ŒåŒå¼•å·ï¼Œä¸‰å¼•å·ï¼ˆä¸‰ä¸ªå•å¼•å·ï¼Œä¸‰ä¸ªåŒå¼•å·ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 word=\u0026#39;zifu\u0026#39; sentence =\u0026#34;juzi\u0026#34; paragraph=\u0026#34;\u0026#34;\u0026#34; duan luo \u0026#34;\u0026#34;\u0026#34; #\u0026#34;\u0026#34;\u0026#34; \u0026#34;\u0026#34;\u0026#34;ä¿å­˜åŸå§‹çš„æ‰€æœ‰æ ¼å¼ print(word) print(sentence) print(paragraph) åŒå¼•å·\u0026quot;\u0026ldquo;é‡Œé¢æ²¡æœ‰è½¬ä¹‰å­—ç¬¦ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨ \u0026lsquo;ï¼Œå³str=\u0026ldquo;I\u0026rsquo;m a boy\u0026rdquo;ï¼Œè¿™é‡Œçš„\u0026rsquo;mä¸ä¼šæŠ¥é”™\nè€Œä½¿ç”¨å•å¼•å·ï¼Œåˆ™éœ€è¦str =\u0026lsquo;I\\\u0026rsquo;m a boy\u0026rsquo;\n1ã€æˆªå–ã€åˆ‡ç‰‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 my_str=\u0026#34;shu_chasing\u0026#34; print(my_str) print(my_str[0:3])#è¾“å‡ºshu print(my_str[1:11:2])#è¾“å‡ºh_hsn #[èµ·å§‹ä½ç½®:ç»“æŸä½ç½®:æ­¥è¿›å€¼]ï¼Œè¿™é‡Œä¹Ÿæ˜¯ä¸åŒ…æ‹¬11åœ¨å†… print(my_str[6:])#è¾“å‡ºä»ç¬¬6ä¸ªåˆ°ç»“å°¾ï¼Œå³asingï¼Œè¿™é‡Œä¸åŒ…æ‹¬ç¬¬6ä¸ª print(my_str[:6])#è¾“å‡ºä»ç¬¬ä¸€ä¸ªåˆ°ç¬¬6ä¸ªï¼Œå³shu_ch print(my_str+\u0026#34;,nihao\u0026#34;)#è¾“å‡ºshu_chasing,nihao print(my_str*3)#è¾“å‡ºshu_chasingshu_chasingshu_chasing 2ã€è½¬ä¹‰å­—ç¬¦ 1 2 3 4 5 6 7 8 9 10 #ä½¿ç”¨ã€å®ç°è½¬ä¹‰å­—ç¬¦çš„åŠŸèƒ½ mystring=r\u0026#39;c:\\now\u0026#39; print(mystring) #è¾“å‡ºå°±æ˜¯c:\\nowï¼Œå»æ‰å‰é¢çš„råˆ™ä¼šå‡ºç°æ¢è¡Œ #åœ¨å­—ç¬¦ä¸²å‰é¢åŠ ä¸Šrè¡¨ç¤ºåŸå§‹å­—ç¬¦ä¸²ï¼Œä¸ä¼šç¿»è¯‘è½¬ä¹‰å­—ç¬¦ #å­—ç¬¦ä¸²ä¸èƒ½ä»¥\\ç»“å°¾ 3ã€å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•° 1.å¤§å†™è½¬å°å†™casefold 1 2 3 str=\u0026#39;SHU_chasing\u0026#39; str=str.casefold() print(str)#shu_chasing 2.ç¬¬ä¸€ä¸ªè½¬å¤§å†™capitalize 1 2 3 str=\u0026#39;shu_chasing\u0026#39; str=str.casefold() print(str)#Shu_chasing 3.æŸ¥æ‰¾find å‡½æ•°åŸå‹find(sub[,start[,end]]) å¯ä»¥é€‰æ‹©èŒƒå›´ ä¹Ÿå¯ä»¥ä¸å†™èŒƒå›´æœç´¢å…¨éƒ¨\n1 2 3 str=\u0026#39;shu_chasing\u0026#39; print(str.find(\u0026#39;s\u0026#39;)) #è¾“å‡º0 print(str.find(\u0026#39;s\u0026#39;, 3 ,10)) #7 4.ç»Ÿè®¡æ•°ç›®count å‡½æ•°åŸå‹count(sub[,start[,end]]) å¯ä»¥é€‰æ‹©èŒƒå›´ ä¹Ÿå¯ä»¥ä¸å†™èŒƒå›´æœç´¢å…¨éƒ¨\n1 2 3 str=\u0026#39;shu_chasing\u0026#39; print(str.count(\u0026#39;s\u0026#39;)) #è¾“å‡º2 print(str.count(\u0026#39;s\u0026#39;, 3 ,10)) #è¾“å‡º1 5.æ›¿æ¢replace å‡½æ•°åŸå‹replace(old, new[,count]) å°†oldçš„å­—ç¬¦ä¸²è½¬æ¢ä¸ºæŒ‡å®šçš„å­—ç¬¦ä¸²\n1 2 3 str=\u0026#39;I love math\u0026#39; str=str.replace(\u0026#39;math\u0026#39;,\u0026#39;programming\u0026#39;) print(str) #è¾“å‡ºI love programming 6.æ‹†åˆ†split split(sep=None, maxsplit=-1)\n1 2 3 str=\u0026#39;D:\\software\\python\u0026#39; str=str.split(sep=\u0026#39;\\\\\u0026#39;) #æ³¨æ„è¿™é‡Œæ˜¯ä¸¤ä¸ª\\\\ print(str) #è¾“å‡º[\u0026#39;D:\u0026#39;, \u0026#39;software\u0026#39;, \u0026#39;python\u0026#39;]ï¼Œè½¬ä¸ºåˆ—è¡¨ç±»å‹ 7.æ‹¼æ¥join ä¸èƒ½å†™æˆstr.join(\u0026rsquo;\\\u0026rsquo;) joinè¢«æŒ‡å®šä¸ºå­—ç¬¦ä¸²å…¶ä¸­çš„ä¸€ä¸ªç”¨æ³• joinçš„å‚æ•°æ”¯æŒä¸€åˆ‡å¯ä»¥è¿­ä»£çš„å¯¹è±¡ï¼ˆåˆ—è¡¨ï¼Œå…ƒç»„ï¼Œå­—å…¸ï¼Œæ–‡ä»¶ï¼Œé›†åˆï¼Œç”Ÿæˆå™¨ï¼‰ æ¨èä½¿ç”¨joinæ›¿ä»£åŠ å·æ‹¼æ¥ +ä¼šé¢‘ç¹è¿›è¡Œå†…å­˜å¤åˆ¶å’Œè§¦å‘åƒåœ¾å›æ”¶æœºåˆ¶\n1 2 3 4 5 6 str=[\u0026#39;D:\u0026#39;, \u0026#39;software\u0026#39;, \u0026#39;python\u0026#39;] str=\u0026#39;\\\\\u0026#39;.join(str) #è½¬ä¹‰å­—ç¬¦ print(str) #D:\\software\\python str=[\u0026#39;D:\u0026#39;, \u0026#39;software\u0026#39;, \u0026#39;python\u0026#39;] str=\u0026#39;\u0026#39;.join(str) print(str) #è¾“å‡ºD:softwarepython ç¬¬å››ç« â€”â€”åˆ—è¡¨list[ ] 1.éå¸¸ç±»ä¼¼äºæ•°ç»„ 2.å¯ä»¥åŒæ—¶ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œæ•´å½¢ï¼Œæµ®ç‚¹å‹ç­‰ç­‰ 3.å¯ä»¥ä¸ºè´Ÿæ•°ä¸‹æ ‡ 4.å¯ä»¥åµŒå¥—ï¼Œç±»ä¼¼äºŒç»´æ•°ç»„ 1ã€éå†åˆ—è¡¨ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 #namelist=[] #å®šä¹‰ç©ºåˆ—è¡¨ namelist=[\u0026#34;xiaozhang\u0026#34;,\u0026#34;2.3\u0026#34;,\u0026#34;10\u0026#34;]#å¯ä»¥ä¸ºä¸åŒç±»å‹çš„å˜é‡ï¼Œå‚¨å­˜æ··åˆç±»å‹ print(namelist[0]) print(namelist[1]) print(namelist[2]) for i in range(0,3): print(namelist[i]) for i in range(-2,0):#è¾“å‡ºæœ€åä¸¤ä¸ªå…ƒç´  print(namelist[i]) for i in namelist: print(i) print(len(namelist))#è¾“å‡ºé•¿åº¦ i=0 while i\u0026lt;len(namelist): print(namelist[i]) i+=1#ä¸èƒ½å†™i++ 2ã€æ•°æ®æ“ä½œ 1. appendå¢åŠ  1 2 3 4 5 6 7 8 9 10 11 12 13 14 namelist=[\u0026#34;xiaozhang\u0026#34;,\u0026#34;2.3\u0026#34;,\u0026#34;10\u0026#34;]#å¯ä»¥ä¸ºä¸åŒç±»å‹çš„å˜é‡ï¼Œå‚¨å­˜æ··åˆç±»å‹ for i in namelist: print(i) #å¢åŠ  nametemp=input(\u0026#34;è¯·è¾“å…¥æ·»åŠ çš„æ•°æ®\u0026#34;) namelist.append(nametemp) for i in namelist: print(i) #è¾“å‡ºç»“æœå¤šäº†appendçš„å†…å®¹[\u0026#34;xiaozhang\u0026#34;,\u0026#34;2.3\u0026#34;,\u0026#34;10\u0026#34;, ____] #ç‰¹åˆ«çš„ï¼Œä½¿ç”¨ä¹˜æ³• a=[1] a=a*3 #æœ€åaå°±æ˜¯[1, 1, 1]\n2. appendå’ŒextendåŒºåˆ« 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #appendå’Œextendçš„åŒºåˆ« a=[1,2] b=[3,4] a.append(b) print(a) #ç»“æœä¸º[1,2,[3,4]]ï¼Œå°†ä¸€ä¸ªåˆ—è¡¨ä½œä¸ºæ•´ä¸ªæ•´ä½“ï¼ŒåŠ å…¥åˆ—è¡¨ä¸­ a.extend(b) print(a) #ç»“æœä¸º[1,2,[3,4],3,4]ï¼Œå°†båˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ªï¼Œé€ä¸€åŠ å…¥åˆ—è¡¨ä¸­ 3. insertç”¨æ³• 1 2 3 4 5 6 7 #insertç”¨æ³• a=[0,1,2] a.insert(1,200)#ç¬¬ä¸€ä¸ªè¡¨ç¤ºä¸‹æ ‡ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºå…ƒç´  print(a)#ç»“æœä¸º0,200,1,2 4. delåˆ é™¤ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 #delåˆ é™¤ a=[0,10,20,30,10,40,50]#å¯ä»¥å‡ºç°é‡å¤æ•°æ® print(a) del a[2]#åˆ é™¤æŒ‡å®šä¸‹æ ‡çš„å…ƒç´  print(a)#ç»“æœä¸º[0, 10, 30, 10, 40, 50] a.pop()#å¼¹å‡ºæœ«å°¾æœ€åä¸€ä¸ªå…ƒç´  print(a)#ç»“æœä¸º[0, 10, 30, 10, 40] a.remove(10)#åˆ é™¤ç¬¬ä¸€ä¸ªå€¼ä¸º10çš„å…ƒç´  print(a)#ç»“æœä¸º[0, 30, 10, 40] #[]ä¿®æ”¹ b=[\u0026#34;chasing\u0026#34;] b[0]=\u0026#34;shu_chasing\u0026#34;#ç›´æ¥ä¿®æ”¹å°±å¯ä»¥äº† 5. indexæŸ¥æ‰¾ä¸countè®¡æ•° 1 2 3 4 5 6 7 8 9 10 11 12 a=[0,10,20,30,10,40,50] findname=int(input(\u0026#34;è¯·è¾“å…¥æƒ³æ‰¾çš„å…ƒç´ \u0026#34;))#è®°å¾—ä¿®æ”¹ä¸ºæ•´æ•°å‹ if findname in a: print(\u0026#34;æ‰¾åˆ°äº†ä¸€æ ·çš„å…ƒç´ \u0026#34;) else: print(\u0026#34;æ²¡æœ‰æ‰¾åˆ°ç›¸åŒçš„å…ƒç´ \u0026#34;) #indexæŸ¥æ‰¾ a=[0,10,20,30,10,40,50] print(a.index(10,1,4))#è¿”å›ä¸‹æ ‡1ï¼Œåœ¨1-3èŒƒå›´å†…æŸ¥æ‰¾å…ƒç´ 10ï¼Œè¿™ä¸ªèŒƒå›´å·¦é—­å³å¼€â€”â€”[1,4) print(a.index(10,1,7))#è¿”å›ç¬¬ä¸€ä¸ªå‡ºç°çš„ä¸‹æ ‡1ï¼Œåœ¨1-6èŒƒå›´å†…æŸ¥æ‰¾å…ƒç´ 10ï¼Œè¿™ä¸ªèŒƒå›´å·¦é—­å³å¼€â€”â€”[1,7) #countè®¡æ•° print(a.count(10))#ç»Ÿè®¡æŸ¥æ‰¾çš„å…ƒç´ å‡ºç°äº†å‡ æ¬¡ list.index(item) #ä»å¤´åˆ°å°¾æ‰¾\nlist.index(item, start, end) #åœ¨å¼€å§‹å’Œç»“æŸä¹‹é—´æ‰¾\n6.reverseåè½¬å’Œsortæ’åº 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 #åè½¬å’Œæ’åº a=[1,4,2,3] print(a)#è¾“å‡º[1, 4, 2, 3] a.reverse() print(a)#è¾“å‡º[3, 2, 4, 1] a.sort() print(a)#è¾“å‡º[1, 2, 3, 4] a.sort(reverse=True) print(a)#è¾“å‡º[4, 3, 2, 1] 3ã€åˆ—è¡¨çš„åµŒå¥— ç±»ä¼¼äºäºŒç»´æ•°ç»„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 a=[[10,20],[40,50],[30,60,70]] print(a[0])#è¾“å‡º[10, 20] print(a[1][0])#è¾“å‡º40 #test import random offices=[[],[],[]] names=[1,2,3,4,5] for name in names: index= random.randint(0,2) offices[index].append(name) i=1 for office in offices: print(\u0026#34;åŠå…¬å®¤%dçš„äººæ•°æ˜¯ï¼š%d\u0026#34;%(i,len(office))) i+=1 for name in office: print(\u0026#34;%s\u0026#34;%name,end=\u0026#39;t\u0026#39;) print(\u0026#34;n\u0026#34;) #ä»¥ä¸‹æ˜¯éšæœºç»“æœ #åŠå…¬å®¤1çš„äººæ•°æ˜¯ï¼š0 #åŠå…¬å®¤2çš„äººæ•°æ˜¯ï¼š2 #1 #5 #åŠå…¬å®¤3çš„äººæ•°æ˜¯ï¼š3 #2 #3 #4 sorté»˜è®¤æ˜¯å½’å¹¶æ’åº å®é™…ä¸Š, sortæœ‰ä¸‰ä¸ªå‚æ•° sort(func, key, reverse)\nç¬¬äº”ç« â€”â€”å…ƒç»„tuple( ) 1ã€åˆ›å»º tuple(å…ƒç»„)\nä¸listç±»ä¼¼ï¼Œä¸åŒå¤„åœ¨äºtupleä¸èƒ½ä¿®æ”¹å…ƒç´ ï¼Œ å†™åœ¨å°æ‹¬å·é‡Œï¼Œå…ƒç´ ä¹‹é—´ç”¨é€—å·éš”å¼€ å…ƒç´ ä¸å¯å˜ï¼Œä½†æ˜¯åŒ…å«å¯å˜å¯¹è±¡ 1 2 3 4 5 6 t1=(2.33,\u0026#39;abcd\u0026#39;,786,) t2=(1,) t3=(\u0026#39;a\u0026#39;,\u0026#39;ab\u0026#39;,[\u0026#39;a\u0026#39;,2.3]) print(t1) #(2.33, \u0026#39;abcd\u0026#39;, 786) print(t2) #(1,) print(t3[2][1]) #2.3 å¦‚æœåˆ›å»ºç©ºçš„å…ƒç»„\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 tup1=() #ç©ºçš„å…ƒç»„ tup2=(50) #æ•´å½¢ tup3=(100,) #å«æœ‰ä¸€ä¸ªå…ƒç´ çš„å…ƒç»„ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªï¼Œåˆ™éœ€è¦åŠ é€—å·,åœ¨è¿™é‡Œä¹Ÿå¯ä»¥å†™tup3=100, #å¯ä»¥ä¸éœ€è¦å°æ‹¬å·ï¼Œä½†æ˜¯ä¸€å®šè¦é€—å· tup4=(150,200) #å«æœ‰å¤šä¸ªå…ƒç´ çš„å…ƒç»„ print(type(tup1)) print(tup2) print(type(tup2)) print(tup3) print(type(tup3)) print(tup4) print(type(tup4)) #\u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; #50 #\u0026lt;class \u0026#39;int\u0026#39;\u0026gt;ï¼Œè¿™é‡Œä¸åŠ ï¼Œå°±æ˜¯æ•´å½¢ #(100,) #\u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; #(150, 200) #\u0026lt;class \u0026#39;tuple\u0026#39;\u0026gt; 2ã€éå†ä¸åˆ‡ç‰‡ 1 2 3 4 5 6 7 tup1=(\u0026#34;abc\u0026#34;,10,23.4) print(tup1) #è¾“å‡º(\u0026#39;abc\u0026#39;, 10, 23.4) print(tup1[-1]) #è¾“å‡º23.4 print(tup1[0:2])# è¾“å‡º(\u0026#39;abc\u0026#39;, 10)ï¼Œè¿™é‡Œåªæœ‰[0,2)ï¼Œå³[0,1]ï¼Œå·¦é—­å³å¼€ 3ã€å¢åŠ  1 2 3 tup1=(12,34,56) #tup[1]=100 #æŠ¥é”™ï¼Œä¸èƒ½ä¿®æ”¹tupçš„å€¼ï¼Œ\u0026#39;tuple\u0026#39; object does not support item assignment ä¸èƒ½â€œæ–°å¢â€ åªèƒ½è®¾ç½®æ–°çš„å˜é‡ åˆ†é…æ–°çš„ç©ºé—´ 1 2 3 4 tup1=(12,34,56) tup2=(\u0026#39;a\u0026#39;,\u0026#39;b\u0026#39;,\u0026#39;c\u0026#39;) tup3=tup1+tup2 print(tup3)#(12, 34, 56, \u0026#39;a\u0026#39;, \u0026#39;b\u0026#39;, \u0026#39;c\u0026#39;) 4ã€åˆ é™¤ 1 2 3 4 5 6 7 8 9 tup1=(12,34,56) print(\u0026#34;åˆ é™¤å‰\u0026#34;) print(tup1) del tup1#åˆ é™¤äº†æ•´ä¸ªå…ƒç»„å˜é‡ï¼Œå¯ä»¥å®Œæˆï¼Œä»¥åä¸èƒ½è®¿é—®tup1 #print(\u0026#34;åˆ é™¤å\u0026#34;) #print(tup1) #æŠ¥é”™ï¼Œä¸èƒ½è®¿é—®tup1çš„å†…å®¹ï¼Œname \u0026#39;tup1\u0026#39; is not defined #del tup[1] #æŠ¥é”™ï¼Œä¸èƒ½åˆ é™¤æŸä¸€ä¸ªä¸‹æ ‡ï¼Œ\u0026#39;tuple\u0026#39; object doesn\u0026#39;t support item deletion 5ã€åŸºæœ¬æ“ä½œ æ“ä½œåç§° æ“ä½œæ–¹æ³• ä¸¾ä¾‹ å…ƒç´ æˆå‘˜å…³ç³» in 2 in list1 å¾—åˆ°é‡å¤å…ƒç´ æ•°é‡ count tup1.count(1) æ“ä½œåç§° æ“ä½œæ–¹æ³• ä¸¾ä¾‹ è®¿é—®å…ƒç»„ä¸­çš„å…ƒç´  é€šè¿‡ä¸‹æ ‡ç›´æ¥è®¿é—® print(tup[10]) éå†å…ƒç»„ é€šè¿‡forå¾ªç¯ for i in tup: print(i) å…ƒç»„çš„åˆ‡ç‰‡ ä½¿ç”¨[ : : ] tup[2:10:1]ï¼Œ[::-1]è¡¨ç¤ºå€’åº å…ƒç»„çš„åŠ æ³•æ“ä½œ + tup3=tup1+tup2 6ã€åŸºæœ¬å‡½æ•° å‡½æ•°åç§° æ“ä½œæ–¹æ³• å¤‡æ³¨ è·å–æ•°ç»„é•¿åº¦ len() len(tup)-1å°±æ˜¯æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ è·å–å…ƒç»„å…ƒç´ æœ€å¤§å€¼ max() è·å–å…ƒç»„å…ƒç´ æœ€å°å€¼ min() å¼ºåˆ¶ç±»å‹è½¬æ¢ tuple() è·å–éšæœºå…ƒç´  choice() åŠ ä¸Šimport random æ¨¡å— 7ã€å­—ç¬¦ä¸²æ“ä½œ *åŒå…ƒç»„ä¸€æ ·ï¼Œå­—ç¬¦ä¸²ä¹Ÿæ˜¯ä¸èƒ½è¢«ä¿®æ”¹çš„ å¦‚æœå¿…é¡»ä¿®æ”¹ï¼Œåˆ™éœ€è¦ä½¿ç”¨åˆ‡ç‰‡å’Œæ‹¼æ¥\n1 2 3 4 5 str=\u0026#34;cgasing\u0026#34; str=str[:1]+\u0026#34;h\u0026#34;+str[2:]#ä¿®æ”¹ç¬¬äºŒä¸ª print(str)#è¾“å‡ºchasing ç¬¬å…­ç« â€”â€”åºåˆ— 1ã€æ€»ç»“ åˆ—è¡¨ã€å…ƒç»„ã€å­—ç¬¦ä¸²çš„å…±åŒç‚¹\nå¯ä»¥é€šè¿‡ç´¢å¼•å¾—åˆ°æ¯ä¸€ä¸ªå…ƒç´  é»˜è®¤ç´¢å¼•ä»0å¼€å§‹ å¯ä»¥åˆ‡ç‰‡å¾—åˆ°èŒƒå›´å†…çš„é›†åˆ æœ‰å…±åŒæ“ä½œç¬¦ï¼ˆé‡å¤ã€æ‹¼æ¥ã€æˆå‘˜ï¼‰ ä»¥ä¸Šç»Ÿç§°ä¸ºâ€”â€”åºåˆ—\n2ã€æ“ä½œå‡½æ•° å‡½æ•°å ä½œç”¨ ç¤ºä¾‹ list([iterable]) å¼ºåˆ¶å°†å¯è¿­ä»£å¯¹è±¡è½¬æ¢ä¸ºåˆ—è¡¨ a=list((1,2,3)) tuple([iterable]) å¼ºåˆ¶å°†å¯è¿­ä»£å¯¹è±¡è½¬æ¢ä¸ºå…ƒç»„ a=tuple((1,2,3)) str(obj) å¼ºåˆ¶å°†å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸² a=str(10) len(sub) è¿”å›subå‚æ•°é•¿åº¦ len(str1) max() è¿”å›å‚æ•°é›†åˆæœ€å¤§å€¼ max(list) min() è¿”å›å‚æ•°é›†åˆæœ€å°å€¼ï¼ˆä¿è¯æ•°æ®ç±»å‹ç»Ÿä¸€ï¼‰ min(list) sum(iterable[, start]) è¿”å›æ‰€æœ‰å…ƒç´ å€¼çš„æ€»å’Œ sum(list,5) sorted(iterable,key=None,reverse=False) è¿”å›æ’åºåçš„åˆ—è¡¨ sorted(list) reversed(sequence) è¿”å›é€†å‘è¿­ä»£åºåˆ—çš„ç»“æœ reversed(list) enumerate(iterable) ç”Ÿæˆä¸€ä¸ªäºŒå…ƒç»„æ„æˆçš„ä¸€ä¸ªè¿­ä»£å¯¹è±¡ è§ä¸‹æ–‡ zip(iter1[,iter2[\u0026hellip;]]) è¿”å›å„ä¸ªå¯è¿­ä»£å‚æ•°å…±åŒç»„æˆçš„å…ƒç»„ è§ä¸‹æ–‡ enumerateç”¨æ³•ï¼Œå¯ä»¥å•ç‹¬ç†è§£ä¸ºæšä¸¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 #enumerate str=\u0026#39;chasing\u0026#39; for i in enumerate(str): print(i) for i,j in enumerate(str): print(i,j) #(0, \u0026#39;c\u0026#39;) #(1, \u0026#39;h\u0026#39;) #(2, \u0026#39;a\u0026#39;) #(3, \u0026#39;s\u0026#39;) #(4, \u0026#39;i\u0026#39;) #(5, \u0026#39;n\u0026#39;) #(6, \u0026#39;g\u0026#39;) # 0 c # 1 h # 2 a # 3 s # 4 i # 5 n # 6 g zipç”¨æ³•\n1 2 3 4 5 6 7 8 9 10 list1=[1,7,3,5,6] str1=\u0026#34;chasing\u0026#34; turple1=(2,4,6,8,10) for i in zip(list1, str1, turple1): print(i) #(1, \u0026#39;c\u0026#39;, 2) #(7, \u0026#39;h\u0026#39;, 4) #(3, \u0026#39;a\u0026#39;, 6) #(5, \u0026#39;s\u0026#39;, 8) #(6, \u0026#39;i\u0026#39;, 10) ç¬¬ä¸ƒç« â€”â€”å­—å…¸ { } 1ã€å­—å…¸dictå®šä¹‰ å­—å…¸ï¼Œå³æ•£åˆ—è¡¨\næ˜¯æ— åºå¯¹è±¡çš„é›†åˆï¼Œä½¿ç”¨é”®-å€¼(key-value)å­˜å‚¨ï¼Œå…·æœ‰æå¿«çš„é€Ÿåº¦\næŸ¥æ‰¾ï¼Œæ’å…¥ã€åˆ é™¤éƒ½ä¸ºO(1)å¤æ‚åº¦\né”®(key)å¿…é¡»ä½¿ç”¨ä¸å¯å˜ç±»å‹ åŒä¸€ä¸ªå­—å…¸çš„keyæ˜¯å”¯ä¸€çš„ ç±»ä¼¼äºjsonçš„å¯¹è±¡ï¼ŒC++çš„mapï¼Œæ•°æ®ç»“æ„çš„çº¢é»‘æ ‘ï¼Œå“ˆå¸Œè¡¨\n1 2 3 4 5 6 7 8 9 10 11 12 #å­—å…¸çš„å®šä¹‰ info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;18\u0026#34;} print(info[\u0026#34;name\u0026#34;]) #è¾“å‡ºchasing print(info[\u0026#34;age\u0026#34;]) #è¾“å‡º18 #print(info[\u0026#34;gender\u0026#34;]) #é”™è¯¯ï¼ŒKeyError: \u0026#39;gender\u0026#39; #ç›´æ¥è®¿é—® print(info.get(\u0026#34;gender\u0026#34;)) #è¾“å‡ºNoneï¼Œæ²¡æœ‰æ‰¾åˆ°é»˜è®¤è¿”å›None print(info.get(\u0026#34;gender\u0026#34;,\u0026#34;not found\u0026#34;)) #ä¿®æ”¹é»˜è®¤çš„å€¼ #è¾“å‡ºnot foundï¼Œæ²¡æœ‰æ‰¾åˆ°è¿”å›not found 2ã€æ·»åŠ  1 2 3 4 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;18\u0026#34;} newID=input(\u0026#34;è¯·è¾“å…¥æ–°çš„å­¦å·ï¼š\u0026#34;) info[\u0026#34;ID\u0026#34;]=newID print(info[\u0026#34;ID\u0026#34;]) 3ã€åˆ é™¤ 1 2 3 4 5 6 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;18\u0026#34;} print(\u0026#34;åˆ é™¤å‰ï¼š%s\u0026#34;%info[\u0026#34;name\u0026#34;]) del info[\u0026#34;name\u0026#34;] #ä½¿ç”¨del infoåˆ™åˆ é™¤æ•´ä¸ªå­—å…¸ #print(\u0026#34;åˆ é™¤åï¼š%s\u0026#34;%info[\u0026#34;name\u0026#34;])#åˆ é™¤åé”®å€¼å¯¹åï¼Œå†æ¬¡è®¿é—®å°±ä¼šæŠ¥é”™ #æŠ¥é”™KeyError \u0026#39;name\u0026#39; 4ã€æ¸…é™¤ 1 2 3 4 5 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;19\u0026#34;} print(\u0026#34;åˆ é™¤å‰ï¼š%s\u0026#34;%info) #åˆ é™¤å‰ï¼š{\u0026#39;name\u0026#39;: \u0026#39;chasing\u0026#39;, \u0026#39;age\u0026#39;: \u0026#39;18\u0026#39;} info.clear() #åªæ˜¯æ¸…ç©º print(\u0026#34;åˆ é™¤åï¼š%s\u0026#34;%info) #åˆ é™¤åï¼š{} 5ã€ä¿®æ”¹ 1 2 3 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;19\u0026#34;} info[\u0026#34;age\u0026#34;]=20 print(info[\u0026#34;age\u0026#34;]) #è¾“å‡º20 6ã€æŸ¥æ‰¾ 1 2 3 4 5 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;18\u0026#34;,\u0026#34;id\u0026#34;:19120397} print(info.keys()) #å¾—åˆ°æ‰€æœ‰çš„é”®dict_keys([\u0026#39;name\u0026#39;, \u0026#39;age\u0026#39;, \u0026#39;id\u0026#39;]) print(info.values()) #å¾—åˆ°æ‰€æœ‰çš„å€¼dict_values([\u0026#39;chasing\u0026#39;, \u0026#39;18\u0026#39;, 19120397]) print(info.items()) #å¾—åˆ°æ‰€æœ‰çš„é¡¹dict_items([(\u0026#39;name\u0026#39;, \u0026#39;chasing\u0026#39;), (\u0026#39;age\u0026#39;, \u0026#39;18\u0026#39;), (\u0026#39;id\u0026#39;, 19120397)]) #æ¯ä¸ªé”®å€¼å¯¹éƒ½æ˜¯å…ƒç»„ 7ã€éå†æ‰€æœ‰çš„é”®ã€å€¼ã€é¡¹ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 info = {\u0026#34;name\u0026#34;:\u0026#34;chasing\u0026#34;,\u0026#34;age\u0026#34;:\u0026#34;18\u0026#34;,\u0026#34;id\u0026#34;:19120397} for i in info.keys(): print(i) for i in info.values(): print(i) for i,j in info.iems(): print(\u0026#34;%s\\t%s\u0026#34;%(i,j)) # name # age # id # chasing # 18 # 19120397 # name chasing # age 18 # id 19120397 ç¬¬å…«ç« â€”â€”é›†åˆ { } 1ã€å®šä¹‰ setå’Œdictç±»ä¼¼ï¼Œä¹Ÿæ˜¯keyçš„é›†åˆï¼Œä½†æ˜¯ä¸å‚¨å­˜value åŒC++ä¸€æ ·ï¼Œsetä¸èƒ½å­˜ç›¸åŒçš„å…ƒç´ ï¼Œé‡å¤å…ƒç´ è‡ªåŠ¨è¿‡æ»¤ ä½†æ˜¯ä¸åŒçš„æ˜¯ï¼Œsetæ˜¯æ— åºçš„ æ“ä½œæ–¹æ³•ä¸å…¶ä»–ç›¸åŒ forã€updateã€addã€removeã€popã€clearã€delç­‰ç­‰\n1 2 3 4 s=set([1,2,3]) print(s) #è¾“å‡º{1, 2, 3} s=set([1,2,3,2,2,1,1,1,3,1,3,3]) print(s) #è¾“å‡º{1, 2, 3} 2ã€å°ç»“ æ˜¯å¦æœ‰åº æ˜¯å¦å¯å˜ç±»å‹ åˆ—è¡¨[] æœ‰åº å¯å˜ç±»å‹ å…ƒç»„() æœ‰åº ä¸å¯å˜ç±»å‹ å­—å…¸{} æ— åº keyä¸å¯å˜ï¼Œvalueå¯å˜ é›†åˆ{} æ— åº å¯å˜ç±»å‹ï¼Œä¸é‡å¤ 1 2 3 4 5 6 7 8 9 10 11 12 a = set(\u0026#39;abracadabra\u0026#39;) b = set(\u0026#39;alacazam\u0026#39;) print(a) print(a - b) # a å’Œ b çš„å·®é›† print(a | b) # a å’Œ b çš„å¹¶é›† print(a \u0026amp; b) # a å’Œ b çš„äº¤é›† print(a ^ b) # a å’Œ b ä¸­ä¸åŒæ—¶å­˜åœ¨çš„å…ƒç´  ç¬¬ä¹ç« â€”â€”å‡½æ•° æé«˜ç¼–ç æ•ˆç‡ï¼Œå‡å°‘é‡å¤\n1ã€å®šä¹‰ å®šä¹‰æ–¹å¼ï¼š 1 2 3 def func(): code return val demoï¼š 1 2 3 def printname(): print(\u0026#34;chasing\u0026#34;) printname() #è¾“å‡ºchasing 2ã€å¸¦å‚æ•°å‡½æ•° 1 2 3 4 def add(a,b): c=a+b print(c) add(1, 2) #è¾“å‡º3 3ã€å¸¦è¿”å›å€¼å‡½æ•° è¿”å›å•ä¸ªå€¼ 1 2 3 4 def add(a,b): c=a+b return c print(add(1,2)) #è¾“å‡º3 è¿”å›å¤šä¸ªå€¼ å’Œluaç›¸åŒ 1 2 3 4 5 6 def divid(a,b): shang=a//b yushu=a%b return shang,yushu #å¤šä¸ªè¿”å›å€¼ç”¨é€—å·åˆ†éš” sh,yu=devid(5,2) print(\u0026#34;å•†ï¼š%dï¼Œä½™æ•°ï¼š%d\u0026#34;%(sh,yu)) #è¾“å‡ºå•†ï¼š2ï¼Œä½™æ•°ï¼š1 å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡ \u0026lt;1\u0026gt;åœ¨å‡½æ•°å†…çš„ä½œä¸ºå±€éƒ¨å˜é‡ \u0026lt;2\u0026gt;åœ¨å‡½æ•°å¤–å®šä¹‰çš„ä¸ºå…¨å±€å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 a=5 def test1(): a=10 #ä¼˜å…ˆä½¿ç”¨å…¨å±€å˜é‡ print(a) a=200 print(a) def test2(): print(a) test1() test2() # 10 # 200 # 5 åœ¨å‡½æ•°ä¸­çš„ä½¿ç”¨å…¨å±€å˜é‡ 1 2 3 4 5 6 7 8 9 10 11 12 13 a=5 def test1(): global a=10 #æ·»åŠ global print(a) a=200 print(a) def test2(): print(a) test1() test2() # 5 # 200 # 200 ç¬¬åç« â€”â€”æ‹·è´ 1ã€å…ƒç»„é»˜è®¤æ·±æ‹·è´ ç›´æ¥èµ‹å€¼ï¼šå…¶å®å°±æ˜¯å¯¹è±¡çš„å¼•ç”¨ï¼ˆåˆ«åï¼‰ã€‚ æµ…æ‹·è´(copy)ï¼šæ‹·è´çˆ¶å¯¹è±¡ï¼Œä¸ä¼šæ‹·è´å¯¹è±¡çš„å†…éƒ¨çš„å­å¯¹è±¡ã€‚ æ·±æ‹·è´(deepcopy)ï¼š copy æ¨¡å—çš„ deepcopy æ–¹æ³•ï¼Œå®Œå…¨æ‹·è´äº†çˆ¶å¯¹è±¡åŠå…¶å­å¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 import copy tuple1 = (1, 2, 3) tuple2 = tuple(tuple1) print(tuple2) print(\u0026#34;tuple1==tuple2 ?\u0026#34;,tuple1==tuple2) print(\u0026#34;tuple1 is tuple2 ?\u0026#34;,tuple1 is tuple2) tuple3 = copy.copy(tuple1) print(tuple3) print(\u0026#34;tuple1==tuple3 ?\u0026#34;,tuple1==tuple3) print(\u0026#34;tuple1 is tuple3 ?\u0026#34;,tuple1 is tuple3) tuple4 = tuple1[:] print(tuple4) print(\u0026#34;tuple1==tuple4 ?\u0026#34;,tuple1==tuple4) print(\u0026#34;tuple1 is tuple4 ?\u0026#34;,tuple1 is tuple4) #(1, 2, 3) #tuple1==tuple2 ? True #tuple1 is tuple2 ? True #(1, 2, 3) #tuple1==tuple3 ? True #tuple1 is tuple3 ? True #(1, 2, 3) #tuple1==tuple4 ? True #tuple1 is tuple4 ? True 2ã€åœ°å€ç±»å‹çš„ä¼ é€’ Pythonä¸­å¯¹è±¡çš„èµ‹å€¼éƒ½æ˜¯è¿›è¡Œå¯¹è±¡å¼•ç”¨ï¼ˆå†…å­˜åœ°å€ï¼‰ä¼ é€’ ä½¿ç”¨copy.copy()ï¼Œå¯ä»¥è¿›è¡Œå¯¹è±¡çš„æµ…æ‹·è´ï¼Œå®ƒå¤åˆ¶äº†å¯¹è±¡ï¼Œä½†å¯¹äºå¯¹è±¡ä¸­çš„å…ƒç´ ï¼Œä¾ç„¶ä½¿ç”¨åŸå§‹çš„å¼•ç”¨. å¦‚æœéœ€è¦å¤åˆ¶ä¸€ä¸ªå®¹å™¨å¯¹è±¡ï¼Œä»¥åŠå®ƒé‡Œé¢çš„æ‰€æœ‰å…ƒç´ ï¼ˆåŒ…å«å…ƒç´ çš„å­å…ƒç´ ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨copy.deepcopy()è¿›è¡Œæ·±æ‹·è´ å¯¹äºéå®¹å™¨ç±»å‹ï¼ˆå¦‚æ•°å­—ã€å­—ç¬¦ä¸²ã€å’Œå…¶ä»–\u0026rsquo;åŸå­\u0026rsquo;ç±»å‹çš„å¯¹è±¡ï¼‰æ²¡æœ‰è¢«æ‹·è´ä¸€è¯´\n","date":"2020-10-06T15:53:09+08:00","image":"https://chasing1020.github.io/post/python-note/python_hu6a3b698acd6bf331f610783bdaa93b34_25772_120x120_fill_q75_h2_box_smart1_2.webp","permalink":"https://chasing1020.github.io/post/python-note/","title":"Python Note"}]